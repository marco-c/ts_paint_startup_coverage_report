<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - gfx/cairo/libpixman/src/pixman-bits-image.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">gfx/cairo/libpixman/src</a> - pixman-bits-image.c<span style="font-size: 80%;"> (source / <a href="pixman-bits-image.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">29</td>
            <td class="headerCovTableEntry">710</td>
            <td class="headerCovTableEntryLo">4.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntry">79</td>
            <td class="headerCovTableEntryLo">5.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Copyright © 2000 Keith Packard, member of The XFree86 Project, Inc.
<span class="lineNum">       3 </span>            :  *             2005 Lars Knoll &amp; Zack Rusin, Trolltech
<span class="lineNum">       4 </span>            :  *             2008 Aaron Plattner, NVIDIA Corporation
<span class="lineNum">       5 </span>            :  * Copyright © 2000 SuSE, Inc.
<span class="lineNum">       6 </span>            :  * Copyright © 2007, 2009 Red Hat, Inc.
<span class="lineNum">       7 </span>            :  * Copyright © 2008 André Tupinambá &lt;andrelrt@gmail.com&gt;
<span class="lineNum">       8 </span>            :  *
<span class="lineNum">       9 </span>            :  * Permission to use, copy, modify, distribute, and sell this software and its
<span class="lineNum">      10 </span>            :  * documentation for any purpose is hereby granted without fee, provided that
<span class="lineNum">      11 </span>            :  * the above copyright notice appear in all copies and that both that
<span class="lineNum">      12 </span>            :  * copyright notice and this permission notice appear in supporting
<span class="lineNum">      13 </span>            :  * documentation, and that the name of Keith Packard not be used in
<span class="lineNum">      14 </span>            :  * advertising or publicity pertaining to distribution of the software without
<span class="lineNum">      15 </span>            :  * specific, written prior permission.  Keith Packard makes no
<span class="lineNum">      16 </span>            :  * representations about the suitability of this software for any purpose.  It
<span class="lineNum">      17 </span>            :  * is provided &quot;as is&quot; without express or implied warranty.
<span class="lineNum">      18 </span>            :  *
<span class="lineNum">      19 </span>            :  * THE COPYRIGHT HOLDERS DISCLAIM ALL WARRANTIES WITH REGARD TO THIS
<span class="lineNum">      20 </span>            :  * SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND
<span class="lineNum">      21 </span>            :  * FITNESS, IN NO EVENT SHALL THE COPYRIGHT HOLDERS BE LIABLE FOR ANY
<span class="lineNum">      22 </span>            :  * SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
<span class="lineNum">      23 </span>            :  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN
<span class="lineNum">      24 </span>            :  * AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
<span class="lineNum">      25 </span>            :  * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS
<span class="lineNum">      26 </span>            :  * SOFTWARE.
<span class="lineNum">      27 </span>            :  */
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #ifdef HAVE_CONFIG_H
<span class="lineNum">      30 </span>            : #include &lt;config.h&gt;
<span class="lineNum">      31 </span>            : #endif
<span class="lineNum">      32 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      35 </span>            : #include &quot;pixman-private.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;pixman-combine32.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;pixman-inlines.h&quot;
<a name="38"><span class="lineNum">      38 </span>            : </a>
<span class="lineNum">      39 </span>            : static uint32_t *
<span class="lineNum">      40 </span><span class="lineNoCov">          0 : _pixman_image_get_scanline_generic_float (pixman_iter_t * iter,</span>
<span class="lineNum">      41 </span>            :                                           const uint32_t *mask)
<span class="lineNum">      42 </span>            : {
<span class="lineNum">      43 </span><span class="lineNoCov">          0 :     pixman_iter_get_scanline_t fetch_32 = iter-&gt;data;</span>
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :     uint32_t *buffer = iter-&gt;buffer;</span>
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span><span class="lineNoCov">          0 :     fetch_32 (iter, NULL);</span>
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span><span class="lineNoCov">          0 :     pixman_expand_to_float ((argb_t *)buffer, buffer, PIXMAN_a8r8g8b8, iter-&gt;width);</span>
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :     return iter-&gt;buffer;</span>
<span class="lineNum">      51 </span>            : }
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : /* Fetch functions */
<a name="54"><span class="lineNum">      54 </span>            : </a>
<span class="lineNum">      55 </span>            : static force_inline uint32_t
<span class="lineNum">      56 </span><span class="lineNoCov">          0 : fetch_pixel_no_alpha (bits_image_t *image,</span>
<span class="lineNum">      57 </span>            :                       int x, int y, pixman_bool_t check_bounds)
<span class="lineNum">      58 </span>            : {
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :     if (check_bounds &amp;&amp;</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :         (x &lt; 0 || x &gt;= image-&gt;width || y &lt; 0 || y &gt;= image-&gt;height))</span>
<span class="lineNum">      61 </span>            :     {
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">      63 </span>            :     }
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :     return image-&gt;fetch_pixel_32 (image, x, y);</span>
<span class="lineNum">      66 </span>            : }
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : typedef uint32_t (* get_pixel_t) (bits_image_t *image,
<span class="lineNum">      69 </span>            :                                   int x, int y, pixman_bool_t check_bounds);
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            : static force_inline uint32_t
<span class="lineNum">      72 </span>            : bits_image_fetch_pixel_nearest (bits_image_t   *image,
<span class="lineNum">      73 </span>            :                                 pixman_fixed_t  x,
<span class="lineNum">      74 </span>            :                                 pixman_fixed_t  y,
<span class="lineNum">      75 </span>            :                                 get_pixel_t     get_pixel)
<span class="lineNum">      76 </span>            : {
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :     int x0 = pixman_fixed_to_int (x - pixman_fixed_e);</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :     int y0 = pixman_fixed_to_int (y - pixman_fixed_e);</span>
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :     if (image-&gt;common.repeat != PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">      81 </span>            :     {
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :         repeat (image-&gt;common.repeat, &amp;x0, image-&gt;width);</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :         repeat (image-&gt;common.repeat, &amp;y0, image-&gt;height);</span>
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :         return get_pixel (image, x0, y0, FALSE);</span>
<span class="lineNum">      86 </span>            :     }
<span class="lineNum">      87 </span>            :     else
<span class="lineNum">      88 </span>            :     {
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :         return get_pixel (image, x0, y0, TRUE);</span>
<span class="lineNum">      90 </span>            :     }
<span class="lineNum">      91 </span>            : }
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span>            : static force_inline uint32_t
<span class="lineNum">      94 </span>            : bits_image_fetch_pixel_bilinear (bits_image_t   *image,
<span class="lineNum">      95 </span>            :                                  pixman_fixed_t  x,
<span class="lineNum">      96 </span>            :                                  pixman_fixed_t  y,
<span class="lineNum">      97 </span>            :                                  get_pixel_t     get_pixel)
<span class="lineNum">      98 </span>            : {
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     pixman_repeat_t repeat_mode = image-&gt;common.repeat;</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     int width = image-&gt;width;</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     int height = image-&gt;height;</span>
<span class="lineNum">     102 </span>            :     int x1, y1, x2, y2;
<span class="lineNum">     103 </span>            :     uint32_t tl, tr, bl, br;
<span class="lineNum">     104 </span>            :     int32_t distx, disty;
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :     x1 = x - pixman_fixed_1 / 2;</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     y1 = y - pixman_fixed_1 / 2;</span>
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     distx = pixman_fixed_to_bilinear_weight (x1);</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :     disty = pixman_fixed_to_bilinear_weight (y1);</span>
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     x1 = pixman_fixed_to_int (x1);</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     y1 = pixman_fixed_to_int (y1);</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     x2 = x1 + 1;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     y2 = y1 + 1;</span>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :     if (repeat_mode != PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">     118 </span>            :     {
<span class="lineNum">     119 </span>            :         repeat (repeat_mode, &amp;x1, width);
<span class="lineNum">     120 </span>            :         repeat (repeat_mode, &amp;y1, height);
<span class="lineNum">     121 </span>            :         repeat (repeat_mode, &amp;x2, width);
<span class="lineNum">     122 </span>            :         repeat (repeat_mode, &amp;y2, height);
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :         tl = get_pixel (image, x1, y1, FALSE);</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :         bl = get_pixel (image, x1, y2, FALSE);</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :         tr = get_pixel (image, x2, y1, FALSE);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :         br = get_pixel (image, x2, y2, FALSE);</span>
<span class="lineNum">     128 </span>            :     }
<span class="lineNum">     129 </span>            :     else
<span class="lineNum">     130 </span>            :     {
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :         tl = get_pixel (image, x1, y1, TRUE);</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :         tr = get_pixel (image, x2, y1, TRUE);</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :         bl = get_pixel (image, x1, y2, TRUE);</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :         br = get_pixel (image, x2, y2, TRUE);</span>
<span class="lineNum">     135 </span>            :     }
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :     return bilinear_interpolation (tl, tr, bl, br, distx, disty);</span>
<span class="lineNum">     138 </span>            : }
<a name="139"><span class="lineNum">     139 </span>            : </a>
<span class="lineNum">     140 </span>            : static uint32_t *
<span class="lineNum">     141 </span><span class="lineNoCov">          0 : bits_image_fetch_bilinear_no_repeat_8888 (pixman_iter_t *iter,</span>
<span class="lineNum">     142 </span>            :                                           const uint32_t *mask)
<span class="lineNum">     143 </span>            : {
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :     pixman_image_t * ima = iter-&gt;image;</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     int              offset = iter-&gt;x;</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     int              line = iter-&gt;y++;</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     int              width = iter-&gt;width;</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     uint32_t *       buffer = iter-&gt;buffer;</span>
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :     bits_image_t *bits = &amp;ima-&gt;bits;</span>
<span class="lineNum">     152 </span>            :     pixman_fixed_t x_top, x_bottom, x;
<span class="lineNum">     153 </span>            :     pixman_fixed_t ux_top, ux_bottom, ux;
<span class="lineNum">     154 </span>            :     pixman_vector_t v;
<span class="lineNum">     155 </span>            :     uint32_t top_mask, bottom_mask;
<span class="lineNum">     156 </span>            :     uint32_t *top_row;
<span class="lineNum">     157 </span>            :     uint32_t *bottom_row;
<span class="lineNum">     158 </span>            :     uint32_t *end;
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :     uint32_t zero[2] = { 0, 0 };</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :     uint32_t one = 1;</span>
<span class="lineNum">     161 </span>            :     int y, y1, y2;
<span class="lineNum">     162 </span>            :     int disty;
<span class="lineNum">     163 </span>            :     int mask_inc;
<span class="lineNum">     164 </span>            :     int w;
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            :     /* reference point is the center of the pixel */
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     v.vector[0] = pixman_int_to_fixed (offset) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     v.vector[1] = pixman_int_to_fixed (line) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :     v.vector[2] = pixman_fixed_1;</span>
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :     if (!pixman_transform_point_3d (bits-&gt;common.transform, &amp;v))</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :         return iter-&gt;buffer;</span>
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :     ux = ux_top = ux_bottom = bits-&gt;common.transform-&gt;matrix[0][0];</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     x = x_top = x_bottom = v.vector[0] - pixman_fixed_1/2;</span>
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     y = v.vector[1] - pixman_fixed_1/2;</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :     disty = pixman_fixed_to_bilinear_weight (y);</span>
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span>            :     /* Load the pointers to the first and second lines from the source
<span class="lineNum">     181 </span>            :      * image that bilinear code must read.
<span class="lineNum">     182 </span>            :      *
<span class="lineNum">     183 </span>            :      * The main trick in this code is about the check if any line are
<span class="lineNum">     184 </span>            :      * outside of the image;
<span class="lineNum">     185 </span>            :      *
<span class="lineNum">     186 </span>            :      * When I realize that a line (any one) is outside, I change
<span class="lineNum">     187 </span>            :      * the pointer to a dummy area with zeros. Once I change this, I
<span class="lineNum">     188 </span>            :      * must be sure the pointer will not change, so I set the
<span class="lineNum">     189 </span>            :      * variables to each pointer increments inside the loop.
<span class="lineNum">     190 </span>            :      */
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :     y1 = pixman_fixed_to_int (y);</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :     y2 = y1 + 1;</span>
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :     if (y1 &lt; 0 || y1 &gt;= bits-&gt;height)</span>
<span class="lineNum">     195 </span>            :     {
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :         top_row = zero;</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :         x_top = 0;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :         ux_top = 0;</span>
<span class="lineNum">     199 </span>            :     }
<span class="lineNum">     200 </span>            :     else
<span class="lineNum">     201 </span>            :     {
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :         top_row = bits-&gt;bits + y1 * bits-&gt;rowstride;</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         x_top = x;</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         ux_top = ux;</span>
<span class="lineNum">     205 </span>            :     }
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :     if (y2 &lt; 0 || y2 &gt;= bits-&gt;height)</span>
<span class="lineNum">     208 </span>            :     {
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :         bottom_row = zero;</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :         x_bottom = 0;</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :         ux_bottom = 0;</span>
<span class="lineNum">     212 </span>            :     }
<span class="lineNum">     213 </span>            :     else
<span class="lineNum">     214 </span>            :     {
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :         bottom_row = bits-&gt;bits + y2 * bits-&gt;rowstride;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :         x_bottom = x;</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :         ux_bottom = ux;</span>
<span class="lineNum">     218 </span>            :     }
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span>            :     /* Instead of checking whether the operation uses the mast in
<span class="lineNum">     221 </span>            :      * each loop iteration, verify this only once and prepare the
<span class="lineNum">     222 </span>            :      * variables to make the code smaller inside the loop.
<span class="lineNum">     223 </span>            :      */
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :     if (!mask)</span>
<span class="lineNum">     225 </span>            :     {
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :         mask_inc = 0;</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :         mask = &amp;one;</span>
<span class="lineNum">     228 </span>            :     }
<span class="lineNum">     229 </span>            :     else
<span class="lineNum">     230 </span>            :     {
<span class="lineNum">     231 </span>            :         /* If have a mask, prepare the variables to check it */
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :         mask_inc = 1;</span>
<span class="lineNum">     233 </span>            :     }
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            :     /* If both are zero, then the whole thing is zero */
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     if (top_row == zero &amp;&amp; bottom_row == zero)</span>
<span class="lineNum">     237 </span>            :     {
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         memset (buffer, 0, width * sizeof (uint32_t));</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :         return iter-&gt;buffer;</span>
<span class="lineNum">     240 </span>            :     }
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     else if (bits-&gt;format == PIXMAN_x8r8g8b8)</span>
<span class="lineNum">     242 </span>            :     {
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :         if (top_row == zero)</span>
<span class="lineNum">     244 </span>            :         {
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :             top_mask = 0;</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :             bottom_mask = 0xff000000;</span>
<span class="lineNum">     247 </span>            :         }
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :         else if (bottom_row == zero)</span>
<span class="lineNum">     249 </span>            :         {
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :             top_mask = 0xff000000;</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :             bottom_mask = 0;</span>
<span class="lineNum">     252 </span>            :         }
<span class="lineNum">     253 </span>            :         else
<span class="lineNum">     254 </span>            :         {
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :             top_mask = 0xff000000;</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :             bottom_mask = 0xff000000;</span>
<span class="lineNum">     257 </span>            :         }
<span class="lineNum">     258 </span>            :     }
<span class="lineNum">     259 </span>            :     else
<span class="lineNum">     260 </span>            :     {
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :         top_mask = 0;</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :         bottom_mask = 0;</span>
<span class="lineNum">     263 </span>            :     }
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     end = buffer + width;</span>
<span class="lineNum">     266 </span>            : 
<span class="lineNum">     267 </span>            :     /* Zero fill to the left of the image */
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     while (buffer &lt; end &amp;&amp; x &lt; pixman_fixed_minus_1)</span>
<span class="lineNum">     269 </span>            :     {
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :         *buffer++ = 0;</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         x += ux;</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         x_top += ux_top;</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         x_bottom += ux_bottom;</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :         mask += mask_inc;</span>
<span class="lineNum">     275 </span>            :     }
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span>            :     /* Left edge
<span class="lineNum">     278 </span>            :      */
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     while (buffer &lt; end &amp;&amp; x &lt; 0)</span>
<span class="lineNum">     280 </span>            :     {
<span class="lineNum">     281 </span>            :         uint32_t tr, br;
<span class="lineNum">     282 </span>            :         int32_t distx;
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :         tr = top_row[pixman_fixed_to_int (x_top) + 1] | top_mask;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         br = bottom_row[pixman_fixed_to_int (x_bottom) + 1] | bottom_mask;</span>
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         distx = pixman_fixed_to_bilinear_weight (x);</span>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         *buffer++ = bilinear_interpolation (0, tr, 0, br, distx, disty);</span>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :         x += ux;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :         x_top += ux_top;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :         x_bottom += ux_bottom;</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :         mask += mask_inc;</span>
<span class="lineNum">     295 </span>            :     }
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            :     /* Main part */
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     w = pixman_int_to_fixed (bits-&gt;width - 1);</span>
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :     while (buffer &lt; end  &amp;&amp;  x &lt; w)</span>
<span class="lineNum">     301 </span>            :     {
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         if (*mask)</span>
<span class="lineNum">     303 </span>            :         {
<span class="lineNum">     304 </span>            :             uint32_t tl, tr, bl, br;
<span class="lineNum">     305 </span>            :             int32_t distx;
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :             tl = top_row [pixman_fixed_to_int (x_top)] | top_mask;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :             tr = top_row [pixman_fixed_to_int (x_top) + 1] | top_mask;</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :             bl = bottom_row [pixman_fixed_to_int (x_bottom)] | bottom_mask;</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :             br = bottom_row [pixman_fixed_to_int (x_bottom) + 1] | bottom_mask;</span>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :             distx = pixman_fixed_to_bilinear_weight (x);</span>
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :             *buffer = bilinear_interpolation (tl, tr, bl, br, distx, disty);</span>
<span class="lineNum">     315 </span>            :         }
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :         buffer++;</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         x += ux;</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         x_top += ux_top;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :         x_bottom += ux_bottom;</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :         mask += mask_inc;</span>
<span class="lineNum">     322 </span>            :     }
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span>            :     /* Right Edge */
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     w = pixman_int_to_fixed (bits-&gt;width);</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     while (buffer &lt; end  &amp;&amp;  x &lt; w)</span>
<span class="lineNum">     327 </span>            :     {
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :         if (*mask)</span>
<span class="lineNum">     329 </span>            :         {
<span class="lineNum">     330 </span>            :             uint32_t tl, bl;
<span class="lineNum">     331 </span>            :             int32_t distx;
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :             tl = top_row [pixman_fixed_to_int (x_top)] | top_mask;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :             bl = bottom_row [pixman_fixed_to_int (x_bottom)] | bottom_mask;</span>
<span class="lineNum">     335 </span>            : 
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :             distx = pixman_fixed_to_bilinear_weight (x);</span>
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :             *buffer = bilinear_interpolation (tl, 0, bl, 0, distx, disty);</span>
<span class="lineNum">     339 </span>            :         }
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :         buffer++;</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :         x += ux;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :         x_top += ux_top;</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :         x_bottom += ux_bottom;</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :         mask += mask_inc;</span>
<span class="lineNum">     346 </span>            :     }
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span>            :     /* Zero fill to the left of the image */
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :     while (buffer &lt; end)</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :         *buffer++ = 0;</span>
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :     return iter-&gt;buffer;</span>
<span class="lineNum">     353 </span>            : }
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            : static force_inline uint32_t
<span class="lineNum">     356 </span>            : bits_image_fetch_pixel_convolution (bits_image_t   *image,
<span class="lineNum">     357 </span>            :                                     pixman_fixed_t  x,
<span class="lineNum">     358 </span>            :                                     pixman_fixed_t  y,
<span class="lineNum">     359 </span>            :                                     get_pixel_t     get_pixel)
<span class="lineNum">     360 </span>            : {
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :     pixman_fixed_t *params = image-&gt;common.filter_params;</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :     int x_off = (params[0] - pixman_fixed_1) &gt;&gt; 1;</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :     int y_off = (params[1] - pixman_fixed_1) &gt;&gt; 1;</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :     int32_t cwidth = pixman_fixed_to_int (params[0]);</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     int32_t cheight = pixman_fixed_to_int (params[1]);</span>
<span class="lineNum">     366 </span>            :     int32_t i, j, x1, x2, y1, y2;
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     pixman_repeat_t repeat_mode = image-&gt;common.repeat;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     int width = image-&gt;width;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     int height = image-&gt;height;</span>
<span class="lineNum">     370 </span>            :     int srtot, sgtot, sbtot, satot;
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :     params += 2;</span>
<span class="lineNum">     373 </span>            : 
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     x1 = pixman_fixed_to_int (x - pixman_fixed_e - x_off);</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     y1 = pixman_fixed_to_int (y - pixman_fixed_e - y_off);</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     x2 = x1 + cwidth;</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     y2 = y1 + cheight;</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :     srtot = sgtot = sbtot = satot = 0;</span>
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :     for (i = y1; i &lt; y2; ++i)</span>
<span class="lineNum">     382 </span>            :     {
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         for (j = x1; j &lt; x2; ++j)</span>
<span class="lineNum">     384 </span>            :         {
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :             int rx = j;</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :             int ry = i;</span>
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :             pixman_fixed_t f = *params;</span>
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :             if (f)</span>
<span class="lineNum">     391 </span>            :             {
<span class="lineNum">     392 </span>            :                 uint32_t pixel;
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :                 if (repeat_mode != PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">     395 </span>            :                 {
<span class="lineNum">     396 </span>            :                     repeat (repeat_mode, &amp;rx, width);
<span class="lineNum">     397 </span>            :                     repeat (repeat_mode, &amp;ry, height);
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                     pixel = get_pixel (image, rx, ry, FALSE);</span>
<span class="lineNum">     400 </span>            :                 }
<span class="lineNum">     401 </span>            :                 else
<span class="lineNum">     402 </span>            :                 {
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :                     pixel = get_pixel (image, rx, ry, TRUE);</span>
<span class="lineNum">     404 </span>            :                 }
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :                 srtot += (int)RED_8 (pixel) * f;</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :                 sgtot += (int)GREEN_8 (pixel) * f;</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :                 sbtot += (int)BLUE_8 (pixel) * f;</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :                 satot += (int)ALPHA_8 (pixel) * f;</span>
<span class="lineNum">     410 </span>            :             }
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :             params++;</span>
<span class="lineNum">     413 </span>            :         }
<span class="lineNum">     414 </span>            :     }
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :     satot = (satot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :     srtot = (srtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     sgtot = (sgtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     sbtot = (sbtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     satot = CLIP (satot, 0, 0xff);</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :     srtot = CLIP (srtot, 0, 0xff);</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :     sgtot = CLIP (sgtot, 0, 0xff);</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :     sbtot = CLIP (sbtot, 0, 0xff);</span>
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :     return ((satot &lt;&lt; 24) | (srtot &lt;&lt; 16) | (sgtot &lt;&lt;  8) | (sbtot));</span>
<span class="lineNum">     427 </span>            : }
<a name="428"><span class="lineNum">     428 </span>            : </a>
<span class="lineNum">     429 </span>            : static uint32_t
<span class="lineNum">     430 </span><span class="lineNoCov">          0 : bits_image_fetch_pixel_separable_convolution (bits_image_t *image,</span>
<span class="lineNum">     431 </span>            :                                               pixman_fixed_t x,
<span class="lineNum">     432 </span>            :                                               pixman_fixed_t y,
<span class="lineNum">     433 </span>            :                                               get_pixel_t    get_pixel)
<span class="lineNum">     434 </span>            : {
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     pixman_fixed_t *params = image-&gt;common.filter_params;</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :     pixman_repeat_t repeat_mode = image-&gt;common.repeat;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :     int width = image-&gt;width;</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     int height = image-&gt;height;</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :     int cwidth = pixman_fixed_to_int (params[0]);</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     int cheight = pixman_fixed_to_int (params[1]);</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :     int x_phase_bits = pixman_fixed_to_int (params[2]);</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :     int y_phase_bits = pixman_fixed_to_int (params[3]);</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     int x_phase_shift = 16 - x_phase_bits;</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :     int y_phase_shift = 16 - y_phase_bits;</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :     int x_off = ((cwidth &lt;&lt; 16) - pixman_fixed_1) &gt;&gt; 1;</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :     int y_off = ((cheight &lt;&lt; 16) - pixman_fixed_1) &gt;&gt; 1;</span>
<span class="lineNum">     447 </span>            :     pixman_fixed_t *y_params;
<span class="lineNum">     448 </span>            :     int srtot, sgtot, sbtot, satot;
<span class="lineNum">     449 </span>            :     int32_t x1, x2, y1, y2;
<span class="lineNum">     450 </span>            :     int32_t px, py;
<span class="lineNum">     451 </span>            :     int i, j;
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            :     /* Round x and y to the middle of the closest phase before continuing. This
<span class="lineNum">     454 </span>            :      * ensures that the convolution matrix is aligned right, since it was
<span class="lineNum">     455 </span>            :      * positioned relative to a particular phase (and not relative to whatever
<span class="lineNum">     456 </span>            :      * exact fraction we happen to get here).
<span class="lineNum">     457 </span>            :      */
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :     x = ((x &gt;&gt; x_phase_shift) &lt;&lt; x_phase_shift) + ((1 &lt;&lt; x_phase_shift) &gt;&gt; 1);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :     y = ((y &gt;&gt; y_phase_shift) &lt;&lt; y_phase_shift) + ((1 &lt;&lt; y_phase_shift) &gt;&gt; 1);</span>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :     px = (x &amp; 0xffff) &gt;&gt; x_phase_shift;</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :     py = (y &amp; 0xffff) &gt;&gt; y_phase_shift;</span>
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :     y_params = params + 4 + (1 &lt;&lt; x_phase_bits) * cwidth + py * cheight;</span>
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     x1 = pixman_fixed_to_int (x - pixman_fixed_e - x_off);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     y1 = pixman_fixed_to_int (y - pixman_fixed_e - y_off);</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     x2 = x1 + cwidth;</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :     y2 = y1 + cheight;</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :     srtot = sgtot = sbtot = satot = 0;</span>
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     for (i = y1; i &lt; y2; ++i)</span>
<span class="lineNum">     474 </span>            :     {
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :         pixman_fixed_48_16_t fy = *y_params++;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         pixman_fixed_t *x_params = params + 4 + px * cwidth;</span>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         if (fy)</span>
<span class="lineNum">     479 </span>            :         {
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :             for (j = x1; j &lt; x2; ++j)</span>
<span class="lineNum">     481 </span>            :             {
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                 pixman_fixed_t fx = *x_params++;</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :                 int rx = j;</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :                 int ry = i;</span>
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :                 if (fx)</span>
<span class="lineNum">     487 </span>            :                 {
<span class="lineNum">     488 </span>            :                     pixman_fixed_t f;
<span class="lineNum">     489 </span>            :                     uint32_t pixel;
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :                     if (repeat_mode != PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">     492 </span>            :                     {
<span class="lineNum">     493 </span>            :                         repeat (repeat_mode, &amp;rx, width);
<span class="lineNum">     494 </span>            :                         repeat (repeat_mode, &amp;ry, height);
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                         pixel = get_pixel (image, rx, ry, FALSE);</span>
<span class="lineNum">     497 </span>            :                     }
<span class="lineNum">     498 </span>            :                     else
<span class="lineNum">     499 </span>            :                     {
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :                         pixel = get_pixel (image, rx, ry, TRUE);</span>
<span class="lineNum">     501 </span>            :                     }
<span class="lineNum">     502 </span>            : 
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                     f = (fy * fx + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                     srtot += (int)RED_8 (pixel) * f;</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                     sgtot += (int)GREEN_8 (pixel) * f;</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                     sbtot += (int)BLUE_8 (pixel) * f;</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                     satot += (int)ALPHA_8 (pixel) * f;</span>
<span class="lineNum">     509 </span>            :                 }
<span class="lineNum">     510 </span>            :             }
<span class="lineNum">     511 </span>            :         }
<span class="lineNum">     512 </span>            :     }
<span class="lineNum">     513 </span>            : 
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     satot = (satot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     srtot = (srtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :     sgtot = (sgtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     sbtot = (sbtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     satot = CLIP (satot, 0, 0xff);</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     srtot = CLIP (srtot, 0, 0xff);</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     sgtot = CLIP (sgtot, 0, 0xff);</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     sbtot = CLIP (sbtot, 0, 0xff);</span>
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :     return ((satot &lt;&lt; 24) | (srtot &lt;&lt; 16) | (sgtot &lt;&lt;  8) | (sbtot));</span>
<span class="lineNum">     525 </span>            : }
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            : static force_inline uint32_t
<span class="lineNum">     528 </span>            : bits_image_fetch_pixel_filtered (bits_image_t *image,
<span class="lineNum">     529 </span>            :                                  pixman_fixed_t x,
<span class="lineNum">     530 </span>            :                                  pixman_fixed_t y,
<span class="lineNum">     531 </span>            :                                  get_pixel_t    get_pixel)
<span class="lineNum">     532 </span>            : {
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :     switch (image-&gt;common.filter)</span>
<span class="lineNum">     534 </span>            :     {
<span class="lineNum">     535 </span>            :     case PIXMAN_FILTER_NEAREST:
<span class="lineNum">     536 </span>            :     case PIXMAN_FILTER_FAST:
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :         return bits_image_fetch_pixel_nearest (image, x, y, get_pixel);</span>
<span class="lineNum">     538 </span>            :         break;
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span>            :     case PIXMAN_FILTER_BILINEAR:
<span class="lineNum">     541 </span>            :     case PIXMAN_FILTER_GOOD:
<span class="lineNum">     542 </span>            :     case PIXMAN_FILTER_BEST:
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :         return bits_image_fetch_pixel_bilinear (image, x, y, get_pixel);</span>
<span class="lineNum">     544 </span>            :         break;
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span>            :     case PIXMAN_FILTER_CONVOLUTION:
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :         return bits_image_fetch_pixel_convolution (image, x, y, get_pixel);</span>
<span class="lineNum">     548 </span>            :         break;
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span>            :     case PIXMAN_FILTER_SEPARABLE_CONVOLUTION:
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :         return bits_image_fetch_pixel_separable_convolution (image, x, y, get_pixel);</span>
<span class="lineNum">     552 </span>            :         break;
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span>            :     default:
<span class="lineNum">     555 </span>            :         break;
<span class="lineNum">     556 </span>            :     }
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     559 </span>            : }
<a name="560"><span class="lineNum">     560 </span>            : </a>
<span class="lineNum">     561 </span>            : static uint32_t *
<span class="lineNum">     562 </span><span class="lineNoCov">          0 : bits_image_fetch_affine_no_alpha (pixman_iter_t *  iter,</span>
<span class="lineNum">     563 </span>            :                                   const uint32_t * mask)
<span class="lineNum">     564 </span>            : {
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :     pixman_image_t *image  = iter-&gt;image;</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :     int             offset = iter-&gt;x;</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     int             line   = iter-&gt;y++;</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :     uint32_t *      buffer = iter-&gt;buffer;</span>
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span>            :     pixman_fixed_t x, y;
<span class="lineNum">     572 </span>            :     pixman_fixed_t ux, uy;
<span class="lineNum">     573 </span>            :     pixman_vector_t v;
<span class="lineNum">     574 </span>            :     int i;
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span>            :     /* reference point is the center of the pixel */
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     v.vector[0] = pixman_int_to_fixed (offset) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :     v.vector[1] = pixman_int_to_fixed (line) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :     v.vector[2] = pixman_fixed_1;</span>
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :     if (image-&gt;common.transform)</span>
<span class="lineNum">     582 </span>            :     {
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :         if (!pixman_transform_point_3d (image-&gt;common.transform, &amp;v))</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :             return iter-&gt;buffer;</span>
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :         ux = image-&gt;common.transform-&gt;matrix[0][0];</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :         uy = image-&gt;common.transform-&gt;matrix[1][0];</span>
<span class="lineNum">     588 </span>            :     }
<span class="lineNum">     589 </span>            :     else
<span class="lineNum">     590 </span>            :     {
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :         ux = pixman_fixed_1;</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         uy = 0;</span>
<span class="lineNum">     593 </span>            :     }
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :     x = v.vector[0];</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :     y = v.vector[1];</span>
<span class="lineNum">     597 </span>            : 
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; width; ++i)</span>
<span class="lineNum">     599 </span>            :     {
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :         if (!mask || mask[i])</span>
<span class="lineNum">     601 </span>            :         {
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :             buffer[i] = bits_image_fetch_pixel_filtered (</span>
<span class="lineNum">     603 </span>            :                 &amp;image-&gt;bits, x, y, fetch_pixel_no_alpha);
<span class="lineNum">     604 </span>            :         }
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :         x += ux;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :         y += uy;</span>
<span class="lineNum">     608 </span>            :     }
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     return buffer;</span>
<span class="lineNum">     611 </span>            : }
<span class="lineNum">     612 </span>            : 
<a name="613"><span class="lineNum">     613 </span>            : /* General fetcher */</a>
<span class="lineNum">     614 </span>            : static force_inline uint32_t
<span class="lineNum">     615 </span><span class="lineNoCov">          0 : fetch_pixel_general (bits_image_t *image, int x, int y, pixman_bool_t check_bounds)</span>
<span class="lineNum">     616 </span>            : {
<span class="lineNum">     617 </span>            :     uint32_t pixel;
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     if (check_bounds &amp;&amp;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         (x &lt; 0 || x &gt;= image-&gt;width || y &lt; 0 || y &gt;= image-&gt;height))</span>
<span class="lineNum">     621 </span>            :     {
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     623 </span>            :     }
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :     pixel = image-&gt;fetch_pixel_32 (image, x, y);</span>
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :     if (image-&gt;common.alpha_map)</span>
<span class="lineNum">     628 </span>            :     {
<span class="lineNum">     629 </span>            :         uint32_t pixel_a;
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :         x -= image-&gt;common.alpha_origin_x;</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :         y -= image-&gt;common.alpha_origin_y;</span>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         if (x &lt; 0 || x &gt;= image-&gt;common.alpha_map-&gt;width ||</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :             y &lt; 0 || y &gt;= image-&gt;common.alpha_map-&gt;height)</span>
<span class="lineNum">     636 </span>            :         {
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :             pixel_a = 0;</span>
<span class="lineNum">     638 </span>            :         }
<span class="lineNum">     639 </span>            :         else
<span class="lineNum">     640 </span>            :         {
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :             pixel_a = image-&gt;common.alpha_map-&gt;fetch_pixel_32 (</span>
<span class="lineNum">     642 </span>            :                 image-&gt;common.alpha_map, x, y);
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :             pixel_a = ALPHA_8 (pixel_a);</span>
<span class="lineNum">     645 </span>            :         }
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :         pixel &amp;= 0x00ffffff;</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :         pixel |= (pixel_a &lt;&lt; 24);</span>
<span class="lineNum">     649 </span>            :     }
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :     return pixel;</span>
<span class="lineNum">     652 </span>            : }
<a name="653"><span class="lineNum">     653 </span>            : </a>
<span class="lineNum">     654 </span>            : static uint32_t *
<span class="lineNum">     655 </span><span class="lineNoCov">          0 : bits_image_fetch_general (pixman_iter_t  *iter,</span>
<span class="lineNum">     656 </span>            :                           const uint32_t *mask)
<span class="lineNum">     657 </span>            : {
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :     pixman_image_t *image  = iter-&gt;image;</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :     int             offset = iter-&gt;x;</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :     int             line   = iter-&gt;y++;</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :     uint32_t *      buffer = iter-&gt;buffer;</span>
<span class="lineNum">     663 </span>            : 
<span class="lineNum">     664 </span>            :     pixman_fixed_t x, y, w;
<span class="lineNum">     665 </span>            :     pixman_fixed_t ux, uy, uw;
<span class="lineNum">     666 </span>            :     pixman_vector_t v;
<span class="lineNum">     667 </span>            :     int i;
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span>            :     /* reference point is the center of the pixel */
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :     v.vector[0] = pixman_int_to_fixed (offset) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :     v.vector[1] = pixman_int_to_fixed (line) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :     v.vector[2] = pixman_fixed_1;</span>
<span class="lineNum">     673 </span>            : 
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :     if (image-&gt;common.transform)</span>
<span class="lineNum">     675 </span>            :     {
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :         if (!pixman_transform_point_3d (image-&gt;common.transform, &amp;v))</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :             return buffer;</span>
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :         ux = image-&gt;common.transform-&gt;matrix[0][0];</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :         uy = image-&gt;common.transform-&gt;matrix[1][0];</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :         uw = image-&gt;common.transform-&gt;matrix[2][0];</span>
<span class="lineNum">     682 </span>            :     }
<span class="lineNum">     683 </span>            :     else
<span class="lineNum">     684 </span>            :     {
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :         ux = pixman_fixed_1;</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :         uy = 0;</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :         uw = 0;</span>
<span class="lineNum">     688 </span>            :     }
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :     x = v.vector[0];</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :     y = v.vector[1];</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :     w = v.vector[2];</span>
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; width; ++i)</span>
<span class="lineNum">     695 </span>            :     {
<span class="lineNum">     696 </span>            :         pixman_fixed_t x0, y0;
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :         if (!mask || mask[i])</span>
<span class="lineNum">     699 </span>            :         {
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :             if (w != 0)</span>
<span class="lineNum">     701 </span>            :             {
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :                 x0 = ((pixman_fixed_48_16_t)x &lt;&lt; 16) / w;</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :                 y0 = ((pixman_fixed_48_16_t)y &lt;&lt; 16) / w;</span>
<span class="lineNum">     704 </span>            :             }
<span class="lineNum">     705 </span>            :             else
<span class="lineNum">     706 </span>            :             {
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :                 x0 = 0;</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :                 y0 = 0;</span>
<span class="lineNum">     709 </span>            :             }
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :             buffer[i] = bits_image_fetch_pixel_filtered (</span>
<span class="lineNum">     712 </span>            :                 &amp;image-&gt;bits, x0, y0, fetch_pixel_general);
<span class="lineNum">     713 </span>            :         }
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :         x += ux;</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :         y += uy;</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :         w += uw;</span>
<span class="lineNum">     718 </span>            :     }
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :     return buffer;</span>
<span class="lineNum">     721 </span>            : }
<span class="lineNum">     722 </span>            : 
<span class="lineNum">     723 </span>            : typedef uint32_t (* convert_pixel_t) (const uint8_t *row, int x);
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span>            : static force_inline void
<span class="lineNum">     726 </span>            : bits_image_fetch_separable_convolution_affine (pixman_image_t * image,
<span class="lineNum">     727 </span>            :                                                int              offset,
<span class="lineNum">     728 </span>            :                                                int              line,
<span class="lineNum">     729 </span>            :                                                int              width,
<span class="lineNum">     730 </span>            :                                                uint32_t *       buffer,
<span class="lineNum">     731 </span>            :                                                const uint32_t * mask,
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span>            :                                                convert_pixel_t  convert_pixel,
<span class="lineNum">     734 </span>            :                                                pixman_format_code_t     format,
<span class="lineNum">     735 </span>            :                                                pixman_repeat_t  repeat_mode)
<span class="lineNum">     736 </span>            : {
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :     bits_image_t *bits = &amp;image-&gt;bits;</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :     pixman_fixed_t *params = image-&gt;common.filter_params;</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :     int cwidth = pixman_fixed_to_int (params[0]);</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :     int cheight = pixman_fixed_to_int (params[1]);</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     int x_off = ((cwidth &lt;&lt; 16) - pixman_fixed_1) &gt;&gt; 1;</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :     int y_off = ((cheight &lt;&lt; 16) - pixman_fixed_1) &gt;&gt; 1;</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :     int x_phase_bits = pixman_fixed_to_int (params[2]);</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :     int y_phase_bits = pixman_fixed_to_int (params[3]);</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :     int x_phase_shift = 16 - x_phase_bits;</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     int y_phase_shift = 16 - y_phase_bits;</span>
<span class="lineNum">     747 </span>            :     pixman_fixed_t vx, vy;
<span class="lineNum">     748 </span>            :     pixman_fixed_t ux, uy;
<span class="lineNum">     749 </span>            :     pixman_vector_t v;
<span class="lineNum">     750 </span>            :     int k;
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span>            :     /* reference point is the center of the pixel */
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :     v.vector[0] = pixman_int_to_fixed (offset) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :     v.vector[1] = pixman_int_to_fixed (line) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     v.vector[2] = pixman_fixed_1;</span>
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     if (!pixman_transform_point_3d (image-&gt;common.transform, &amp;v))</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     ux = image-&gt;common.transform-&gt;matrix[0][0];</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     uy = image-&gt;common.transform-&gt;matrix[1][0];</span>
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :     vx = v.vector[0];</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :     vy = v.vector[1];</span>
<span class="lineNum">     765 </span>            : 
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :     for (k = 0; k &lt; width; ++k)</span>
<span class="lineNum">     767 </span>            :     {
<span class="lineNum">     768 </span>            :         pixman_fixed_t *y_params;
<span class="lineNum">     769 </span>            :         int satot, srtot, sgtot, sbtot;
<span class="lineNum">     770 </span>            :         pixman_fixed_t x, y;
<span class="lineNum">     771 </span>            :         int32_t x1, x2, y1, y2;
<span class="lineNum">     772 </span>            :         int32_t px, py;
<span class="lineNum">     773 </span>            :         int i, j;
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :         if (mask &amp;&amp; !mask[k])</span>
<span class="lineNum">     776 </span>            :             goto next;
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span>            :         /* Round x and y to the middle of the closest phase before continuing. This
<span class="lineNum">     779 </span>            :          * ensures that the convolution matrix is aligned right, since it was
<span class="lineNum">     780 </span>            :          * positioned relative to a particular phase (and not relative to whatever
<span class="lineNum">     781 </span>            :          * exact fraction we happen to get here).
<span class="lineNum">     782 </span>            :          */
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :         x = ((vx &gt;&gt; x_phase_shift) &lt;&lt; x_phase_shift) + ((1 &lt;&lt; x_phase_shift) &gt;&gt; 1);</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :         y = ((vy &gt;&gt; y_phase_shift) &lt;&lt; y_phase_shift) + ((1 &lt;&lt; y_phase_shift) &gt;&gt; 1);</span>
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :         px = (x &amp; 0xffff) &gt;&gt; x_phase_shift;</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :         py = (y &amp; 0xffff) &gt;&gt; y_phase_shift;</span>
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :         x1 = pixman_fixed_to_int (x - pixman_fixed_e - x_off);</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :         y1 = pixman_fixed_to_int (y - pixman_fixed_e - y_off);</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :         x2 = x1 + cwidth;</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :         y2 = y1 + cheight;</span>
<span class="lineNum">     793 </span>            : 
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :         satot = srtot = sgtot = sbtot = 0;</span>
<span class="lineNum">     795 </span>            : 
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :         y_params = params + 4 + (1 &lt;&lt; x_phase_bits) * cwidth + py * cheight;</span>
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :         for (i = y1; i &lt; y2; ++i)</span>
<span class="lineNum">     799 </span>            :         {
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :             pixman_fixed_t fy = *y_params++;</span>
<span class="lineNum">     801 </span>            : 
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :             if (fy)</span>
<span class="lineNum">     803 </span>            :             {
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                 pixman_fixed_t *x_params = params + 4 + px * cwidth;</span>
<span class="lineNum">     805 </span>            : 
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :                 for (j = x1; j &lt; x2; ++j)</span>
<span class="lineNum">     807 </span>            :                 {
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :                     pixman_fixed_t fx = *x_params++;</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :                     int rx = j;</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :                     int ry = i;</span>
<span class="lineNum">     811 </span>            :                     
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :                     if (fx)</span>
<span class="lineNum">     813 </span>            :                     {
<span class="lineNum">     814 </span>            :                         pixman_fixed_t f;
<span class="lineNum">     815 </span>            :                         uint32_t pixel, mask;
<span class="lineNum">     816 </span>            :                         uint8_t *row;
<span class="lineNum">     817 </span>            : 
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :                         mask = PIXMAN_FORMAT_A (format)? 0 : 0xff000000;</span>
<span class="lineNum">     819 </span>            : 
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                         if (repeat_mode != PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">     821 </span>            :                         {
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :                             repeat (repeat_mode, &amp;rx, bits-&gt;width);</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :                             repeat (repeat_mode, &amp;ry, bits-&gt;height);</span>
<span class="lineNum">     824 </span>            : 
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :                             row = (uint8_t *)bits-&gt;bits + bits-&gt;rowstride * 4 * ry;</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :                             pixel = convert_pixel (row, rx) | mask;</span>
<span class="lineNum">     827 </span>            :                         }
<span class="lineNum">     828 </span>            :                         else
<span class="lineNum">     829 </span>            :                         {
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :                             if (rx &lt; 0 || ry &lt; 0 || rx &gt;= bits-&gt;width || ry &gt;= bits-&gt;height)</span>
<span class="lineNum">     831 </span>            :                             {
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :                                 pixel = 0;</span>
<span class="lineNum">     833 </span>            :                             }
<span class="lineNum">     834 </span>            :                             else
<span class="lineNum">     835 </span>            :                             {
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :                                 row = (uint8_t *)bits-&gt;bits + bits-&gt;rowstride * 4 * ry;</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :                                 pixel = convert_pixel (row, rx) | mask;</span>
<span class="lineNum">     838 </span>            :                             }
<span class="lineNum">     839 </span>            :                         }
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :                         f = ((pixman_fixed_32_32_t)fx * fy + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :                         srtot += (int)RED_8 (pixel) * f;</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :                         sgtot += (int)GREEN_8 (pixel) * f;</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :                         sbtot += (int)BLUE_8 (pixel) * f;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :                         satot += (int)ALPHA_8 (pixel) * f;</span>
<span class="lineNum">     846 </span>            :                     }
<span class="lineNum">     847 </span>            :                 }
<span class="lineNum">     848 </span>            :             }
<span class="lineNum">     849 </span>            :         }
<span class="lineNum">     850 </span>            : 
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :         satot = (satot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :         srtot = (srtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :         sgtot = (sgtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :         sbtot = (sbtot + 0x8000) &gt;&gt; 16;</span>
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :         satot = CLIP (satot, 0, 0xff);</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :         srtot = CLIP (srtot, 0, 0xff);</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :         sgtot = CLIP (sgtot, 0, 0xff);</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :         sbtot = CLIP (sbtot, 0, 0xff);</span>
<span class="lineNum">     860 </span>            : 
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :         buffer[k] = (satot &lt;&lt; 24) | (srtot &lt;&lt; 16) | (sgtot &lt;&lt; 8) | (sbtot &lt;&lt; 0);</span>
<span class="lineNum">     862 </span>            : 
<span class="lineNum">     863 </span>            :     next:
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :         vx += ux;</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :         vy += uy;</span>
<span class="lineNum">     866 </span>            :     }
<span class="lineNum">     867 </span>            : }
<span class="lineNum">     868 </span>            : 
<span class="lineNum">     869 </span>            : static const uint8_t zero[8] = { 0, 0, 0, 0, 0, 0, 0, 0 };
<span class="lineNum">     870 </span>            : 
<span class="lineNum">     871 </span>            : static force_inline void
<span class="lineNum">     872 </span>            : bits_image_fetch_bilinear_affine (pixman_image_t * image,
<span class="lineNum">     873 </span>            :                                   int              offset,
<span class="lineNum">     874 </span>            :                                   int              line,
<span class="lineNum">     875 </span>            :                                   int              width,
<span class="lineNum">     876 </span>            :                                   uint32_t *       buffer,
<span class="lineNum">     877 </span>            :                                   const uint32_t * mask,
<span class="lineNum">     878 </span>            : 
<span class="lineNum">     879 </span>            :                                   convert_pixel_t       convert_pixel,
<span class="lineNum">     880 </span>            :                                   pixman_format_code_t  format,
<span class="lineNum">     881 </span>            :                                   pixman_repeat_t       repeat_mode)
<span class="lineNum">     882 </span>            : {
<span class="lineNum">     883 </span>            :     pixman_fixed_t x, y;
<span class="lineNum">     884 </span>            :     pixman_fixed_t ux, uy;
<span class="lineNum">     885 </span>            :     pixman_vector_t v;
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :     bits_image_t *bits = &amp;image-&gt;bits;</span>
<span class="lineNum">     887 </span>            :     int i;
<span class="lineNum">     888 </span>            : 
<span class="lineNum">     889 </span>            :     /* reference point is the center of the pixel */
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :     v.vector[0] = pixman_int_to_fixed (offset) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :     v.vector[1] = pixman_int_to_fixed (line) + pixman_fixed_1 / 2;</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :     v.vector[2] = pixman_fixed_1;</span>
<span class="lineNum">     893 </span>            : 
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :     if (!pixman_transform_point_3d (image-&gt;common.transform, &amp;v))</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :     ux = image-&gt;common.transform-&gt;matrix[0][0];</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :     uy = image-&gt;common.transform-&gt;matrix[1][0];</span>
<span class="lineNum">     899 </span>            : 
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :     x = v.vector[0];</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :     y = v.vector[1];</span>
<span class="lineNum">     902 </span>            : 
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; width; ++i)</span>
<span class="lineNum">     904 </span>            :     {
<span class="lineNum">     905 </span>            :         int x1, y1, x2, y2;
<span class="lineNum">     906 </span>            :         uint32_t tl, tr, bl, br;
<span class="lineNum">     907 </span>            :         int32_t distx, disty;
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :         int width = image-&gt;bits.width;</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :         int height = image-&gt;bits.height;</span>
<span class="lineNum">     910 </span>            :         const uint8_t *row1;
<span class="lineNum">     911 </span>            :         const uint8_t *row2;
<span class="lineNum">     912 </span>            : 
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :         if (mask &amp;&amp; !mask[i])</span>
<span class="lineNum">     914 </span>            :             goto next;
<span class="lineNum">     915 </span>            : 
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :         x1 = x - pixman_fixed_1 / 2;</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :         y1 = y - pixman_fixed_1 / 2;</span>
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :         distx = pixman_fixed_to_bilinear_weight (x1);</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :         disty = pixman_fixed_to_bilinear_weight (y1);</span>
<span class="lineNum">     921 </span>            : 
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :         y1 = pixman_fixed_to_int (y1);</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :         y2 = y1 + 1;</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :         x1 = pixman_fixed_to_int (x1);</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :         x2 = x1 + 1;</span>
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :         if (repeat_mode != PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">     928 </span>            :         {
<span class="lineNum">     929 </span>            :             uint32_t mask;
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :             mask = PIXMAN_FORMAT_A (format)? 0 : 0xff000000;</span>
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span>            :             repeat (repeat_mode, &amp;x1, width);
<span class="lineNum">     934 </span>            :             repeat (repeat_mode, &amp;y1, height);
<span class="lineNum">     935 </span>            :             repeat (repeat_mode, &amp;x2, width);
<span class="lineNum">     936 </span>            :             repeat (repeat_mode, &amp;y2, height);
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :             row1 = (uint8_t *)bits-&gt;bits + bits-&gt;rowstride * 4 * y1;</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :             row2 = (uint8_t *)bits-&gt;bits + bits-&gt;rowstride * 4 * y2;</span>
<span class="lineNum">     940 </span>            : 
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :             tl = convert_pixel (row1, x1) | mask;</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :             tr = convert_pixel (row1, x2) | mask;</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :             bl = convert_pixel (row2, x1) | mask;</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :             br = convert_pixel (row2, x2) | mask;</span>
<span class="lineNum">     945 </span>            :         }
<span class="lineNum">     946 </span>            :         else
<span class="lineNum">     947 </span>            :         {
<span class="lineNum">     948 </span>            :             uint32_t mask1, mask2;
<span class="lineNum">     949 </span>            :             int bpp;
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span>            :             /* Note: PIXMAN_FORMAT_BPP() returns an unsigned value,
<span class="lineNum">     952 </span>            :              * which means if you use it in expressions, those
<span class="lineNum">     953 </span>            :              * expressions become unsigned themselves. Since
<span class="lineNum">     954 </span>            :              * the variables below can be negative in some cases,
<span class="lineNum">     955 </span>            :              * that will lead to crashes on 64 bit architectures.
<span class="lineNum">     956 </span>            :              *
<span class="lineNum">     957 </span>            :              * So this line makes sure bpp is signed
<span class="lineNum">     958 </span>            :              */
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :             bpp = PIXMAN_FORMAT_BPP (format);</span>
<span class="lineNum">     960 </span>            : 
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :             if (x1 &gt;= width || x2 &lt; 0 || y1 &gt;= height || y2 &lt; 0)</span>
<span class="lineNum">     962 </span>            :             {
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :                 buffer[i] = 0;</span>
<span class="lineNum">     964 </span>            :                 goto next;
<span class="lineNum">     965 </span>            :             }
<span class="lineNum">     966 </span>            : 
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :             if (y2 == 0)</span>
<span class="lineNum">     968 </span>            :             {
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :                 row1 = zero;</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :                 mask1 = 0;</span>
<span class="lineNum">     971 </span>            :             }
<span class="lineNum">     972 </span>            :             else
<span class="lineNum">     973 </span>            :             {
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :                 row1 = (uint8_t *)bits-&gt;bits + bits-&gt;rowstride * 4 * y1;</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :                 row1 += bpp / 8 * x1;</span>
<span class="lineNum">     976 </span>            : 
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :                 mask1 = PIXMAN_FORMAT_A (format)? 0 : 0xff000000;</span>
<span class="lineNum">     978 </span>            :             }
<span class="lineNum">     979 </span>            : 
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :             if (y1 == height - 1)</span>
<span class="lineNum">     981 </span>            :             {
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :                 row2 = zero;</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :                 mask2 = 0;</span>
<span class="lineNum">     984 </span>            :             }
<span class="lineNum">     985 </span>            :             else
<span class="lineNum">     986 </span>            :             {
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :                 row2 = (uint8_t *)bits-&gt;bits + bits-&gt;rowstride * 4 * y2;</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :                 row2 += bpp / 8 * x1;</span>
<span class="lineNum">     989 </span>            : 
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                 mask2 = PIXMAN_FORMAT_A (format)? 0 : 0xff000000;</span>
<span class="lineNum">     991 </span>            :             }
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :             if (x2 == 0)</span>
<span class="lineNum">     994 </span>            :             {
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :                 tl = 0;</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :                 bl = 0;</span>
<span class="lineNum">     997 </span>            :             }
<span class="lineNum">     998 </span>            :             else
<span class="lineNum">     999 </span>            :             {
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :                 tl = convert_pixel (row1, 0) | mask1;</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :                 bl = convert_pixel (row2, 0) | mask2;</span>
<span class="lineNum">    1002 </span>            :             }
<span class="lineNum">    1003 </span>            : 
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :             if (x1 == width - 1)</span>
<span class="lineNum">    1005 </span>            :             {
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :                 tr = 0;</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :                 br = 0;</span>
<span class="lineNum">    1008 </span>            :             }
<span class="lineNum">    1009 </span>            :             else
<span class="lineNum">    1010 </span>            :             {
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :                 tr = convert_pixel (row1, 1) | mask1;</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                 br = convert_pixel (row2, 1) | mask2;</span>
<span class="lineNum">    1013 </span>            :             }
<span class="lineNum">    1014 </span>            :         }
<span class="lineNum">    1015 </span>            : 
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :         buffer[i] = bilinear_interpolation (</span>
<span class="lineNum">    1017 </span>            :             tl, tr, bl, br, distx, disty);
<span class="lineNum">    1018 </span>            : 
<span class="lineNum">    1019 </span>            :     next:
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :         x += ux;</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :         y += uy;</span>
<span class="lineNum">    1022 </span>            :     }
<span class="lineNum">    1023 </span>            : }
<span class="lineNum">    1024 </span>            : 
<span class="lineNum">    1025 </span>            : static force_inline void
<span class="lineNum">    1026 </span>            : bits_image_fetch_nearest_affine (pixman_image_t * image,
<span class="lineNum">    1027 </span>            :                                  int              offset,
<span class="lineNum">    1028 </span>            :                                  int              line,
<span class="lineNum">    1029 </span>            :                                  int              width,
<span class="lineNum">    1030 </span>            :                                  uint32_t *       buffer,
<span class="lineNum">    1031 </span>            :                                  const uint32_t * mask,
<span class="lineNum">    1032 </span>            :                                  
<span class="lineNum">    1033 </span>            :                                  convert_pixel_t        convert_pixel,
<span class="lineNum">    1034 </span>            :                                  pixman_format_code_t   format,
<span class="lineNum">    1035 </span>            :                                  pixman_repeat_t        repeat_mode)
<span class="lineNum">    1036 </span>            : {
<span class="lineNum">    1037 </span>            :     pixman_fixed_t x, y;
<span class="lineNum">    1038 </span>            :     pixman_fixed_t ux, uy;
<span class="lineNum">    1039 </span>            :     pixman_vector_t v;
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     bits_image_t *bits = &amp;image-&gt;bits;</span>
<span class="lineNum">    1041 </span>            :     int i;
<span class="lineNum">    1042 </span>            : 
<span class="lineNum">    1043 </span>            :     /* reference point is the center of the pixel */
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :     v.vector[0] = pixman_int_to_fixed (offset) + pixman_fixed_1 / 2;</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :     v.vector[1] = pixman_int_to_fixed (line) + pixman_fixed_1 / 2;</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :     v.vector[2] = pixman_fixed_1;</span>
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :     if (!pixman_transform_point_3d (image-&gt;common.transform, &amp;v))</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :     ux = image-&gt;common.transform-&gt;matrix[0][0];</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :     uy = image-&gt;common.transform-&gt;matrix[1][0];</span>
<span class="lineNum">    1053 </span>            : 
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :     x = v.vector[0];</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :     y = v.vector[1];</span>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; width; ++i)</span>
<span class="lineNum">    1058 </span>            :     {
<span class="lineNum">    1059 </span>            :         int width, height, x0, y0;
<span class="lineNum">    1060 </span>            :         const uint8_t *row;
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :         if (mask &amp;&amp; !mask[i])</span>
<span class="lineNum">    1063 </span>            :             goto next;
<span class="lineNum">    1064 </span>            :         
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :         width = image-&gt;bits.width;</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :         height = image-&gt;bits.height;</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :         x0 = pixman_fixed_to_int (x - pixman_fixed_e);</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :         y0 = pixman_fixed_to_int (y - pixman_fixed_e);</span>
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :         if (repeat_mode == PIXMAN_REPEAT_NONE &amp;&amp;</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :             (y0 &lt; 0 || y0 &gt;= height || x0 &lt; 0 || x0 &gt;= width))</span>
<span class="lineNum">    1072 </span>            :         {
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :             buffer[i] = 0;</span>
<span class="lineNum">    1074 </span>            :         }
<span class="lineNum">    1075 </span>            :         else
<span class="lineNum">    1076 </span>            :         {
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :             uint32_t mask = PIXMAN_FORMAT_A (format)? 0 : 0xff000000;</span>
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :             if (repeat_mode != PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">    1080 </span>            :             {
<span class="lineNum">    1081 </span>            :                 repeat (repeat_mode, &amp;x0, width);
<span class="lineNum">    1082 </span>            :                 repeat (repeat_mode, &amp;y0, height);
<span class="lineNum">    1083 </span>            :             }
<span class="lineNum">    1084 </span>            : 
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :             row = (uint8_t *)bits-&gt;bits + bits-&gt;rowstride * 4 * y0;</span>
<span class="lineNum">    1086 </span>            : 
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :             buffer[i] = convert_pixel (row, x0) | mask;</span>
<span class="lineNum">    1088 </span>            :         }
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span>            :     next:
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :         x += ux;</span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :         y += uy;</span>
<span class="lineNum">    1093 </span>            :     }
<span class="lineNum">    1094 </span>            : }
<a name="1095"><span class="lineNum">    1095 </span>            : </a>
<span class="lineNum">    1096 </span>            : static force_inline uint32_t
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 : convert_a8r8g8b8 (const uint8_t *row, int x)</span>
<span class="lineNum">    1098 </span>            : {
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :     return *(((uint32_t *)row) + x);</span>
<span class="lineNum">    1100 </span>            : }
<a name="1101"><span class="lineNum">    1101 </span>            : </a>
<span class="lineNum">    1102 </span>            : static force_inline uint32_t
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 : convert_x8r8g8b8 (const uint8_t *row, int x)</span>
<span class="lineNum">    1104 </span>            : {
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :     return *(((uint32_t *)row) + x);</span>
<span class="lineNum">    1106 </span>            : }
<a name="1107"><span class="lineNum">    1107 </span>            : </a>
<span class="lineNum">    1108 </span>            : static force_inline uint32_t
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 : convert_a8 (const uint8_t *row, int x)</span>
<span class="lineNum">    1110 </span>            : {
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :     return *(row + x) &lt;&lt; 24;</span>
<span class="lineNum">    1112 </span>            : }
<a name="1113"><span class="lineNum">    1113 </span>            : </a>
<span class="lineNum">    1114 </span>            : static force_inline uint32_t
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 : convert_r5g6b5 (const uint8_t *row, int x)</span>
<span class="lineNum">    1116 </span>            : {
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :     return convert_0565_to_0888 (*((uint16_t *)row + x));</span>
<span class="lineNum">    1118 </span>            : }
<span class="lineNum">    1119 </span>            : 
<span class="lineNum">    1120 </span>            : #define MAKE_SEPARABLE_CONVOLUTION_FETCHER(name, format, repeat_mode)  \
<span class="lineNum">    1121 </span>            :     static uint32_t *                                                   \
<span class="lineNum">    1122 </span>            :     bits_image_fetch_separable_convolution_affine_ ## name (pixman_iter_t   *iter, \
<span class="lineNum">    1123 </span>            :                                                             const uint32_t * mask) \
<span class="lineNum">    1124 </span>            :     {                                                                   \
<span class="lineNum">    1125 </span>            :         bits_image_fetch_separable_convolution_affine (                 \
<span class="lineNum">    1126 </span>            :             iter-&gt;image,                                                \
<span class="lineNum">    1127 </span>            :             iter-&gt;x, iter-&gt;y++,                                         \
<span class="lineNum">    1128 </span>            :             iter-&gt;width,                                                \
<span class="lineNum">    1129 </span>            :             iter-&gt;buffer, mask,                                         \
<span class="lineNum">    1130 </span>            :             convert_ ## format,                                         \
<span class="lineNum">    1131 </span>            :             PIXMAN_ ## format,                                          \
<span class="lineNum">    1132 </span>            :             repeat_mode);                                               \
<span class="lineNum">    1133 </span>            :                                                                         \
<span class="lineNum">    1134 </span>            :         return iter-&gt;buffer;                                            \
<span class="lineNum">    1135 </span>            :     }
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span>            : #define MAKE_BILINEAR_FETCHER(name, format, repeat_mode)                \
<span class="lineNum">    1138 </span>            :     static uint32_t *                                                   \
<span class="lineNum">    1139 </span>            :     bits_image_fetch_bilinear_affine_ ## name (pixman_iter_t   *iter,   \
<span class="lineNum">    1140 </span>            :                                                const uint32_t * mask)   \
<span class="lineNum">    1141 </span>            :     {                                                                   \
<span class="lineNum">    1142 </span>            :         bits_image_fetch_bilinear_affine (iter-&gt;image,                       \
<span class="lineNum">    1143 </span>            :                                           iter-&gt;x, iter-&gt;y++,             \
<span class="lineNum">    1144 </span>            :                                           iter-&gt;width,                       \
<span class="lineNum">    1145 </span>            :                                           iter-&gt;buffer, mask,                \
<span class="lineNum">    1146 </span>            :                                           convert_ ## format,           \
<span class="lineNum">    1147 </span>            :                                           PIXMAN_ ## format,            \
<span class="lineNum">    1148 </span>            :                                           repeat_mode);                 \
<span class="lineNum">    1149 </span>            :         return iter-&gt;buffer;                                         \
<span class="lineNum">    1150 </span>            :     }
<span class="lineNum">    1151 </span>            : 
<span class="lineNum">    1152 </span>            : #define MAKE_NEAREST_FETCHER(name, format, repeat_mode)                 \
<span class="lineNum">    1153 </span>            :     static uint32_t *                                                   \
<span class="lineNum">    1154 </span>            :     bits_image_fetch_nearest_affine_ ## name (pixman_iter_t   *iter,    \
<span class="lineNum">    1155 </span>            :                                               const uint32_t * mask)    \
<span class="lineNum">    1156 </span>            :     {                                                                   \
<span class="lineNum">    1157 </span>            :         bits_image_fetch_nearest_affine (iter-&gt;image,                        \
<span class="lineNum">    1158 </span>            :                                          iter-&gt;x, iter-&gt;y++,              \
<span class="lineNum">    1159 </span>            :                                          iter-&gt;width,                        \
<span class="lineNum">    1160 </span>            :                                          iter-&gt;buffer, mask,         \
<span class="lineNum">    1161 </span>            :                                          convert_ ## format,            \
<span class="lineNum">    1162 </span>            :                                          PIXMAN_ ## format,             \
<span class="lineNum">    1163 </span>            :                                          repeat_mode);                  \
<span class="lineNum">    1164 </span>            :         return iter-&gt;buffer;                                         \
<span class="lineNum">    1165 </span>            :     }
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span>            : #define MAKE_FETCHERS(name, format, repeat_mode)                        \
<span class="lineNum">    1168 </span>            :     MAKE_NEAREST_FETCHER (name, format, repeat_mode)                    \
<span class="lineNum">    1169 </span>            :     MAKE_BILINEAR_FETCHER (name, format, repeat_mode)                   \
<a name="1170"><span class="lineNum">    1170 </span>            :     MAKE_SEPARABLE_CONVOLUTION_FETCHER (name, format, repeat_mode)</a>
<a name="1171"><span class="lineNum">    1171 </span>            : </a>
<a name="1172"><span class="lineNum">    1172 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (pad_a8r8g8b8,     a8r8g8b8, PIXMAN_REPEAT_PAD)</span></a>
<a name="1173"><span class="lineNum">    1173 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (none_a8r8g8b8,    a8r8g8b8, PIXMAN_REPEAT_NONE)</span></a>
<a name="1174"><span class="lineNum">    1174 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (reflect_a8r8g8b8, a8r8g8b8, PIXMAN_REPEAT_REFLECT)</span></a>
<a name="1175"><span class="lineNum">    1175 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (normal_a8r8g8b8,  a8r8g8b8, PIXMAN_REPEAT_NORMAL)</span></a>
<a name="1176"><span class="lineNum">    1176 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (pad_x8r8g8b8,     x8r8g8b8, PIXMAN_REPEAT_PAD)</span></a>
<a name="1177"><span class="lineNum">    1177 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (none_x8r8g8b8,    x8r8g8b8, PIXMAN_REPEAT_NONE)</span></a>
<a name="1178"><span class="lineNum">    1178 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (reflect_x8r8g8b8, x8r8g8b8, PIXMAN_REPEAT_REFLECT)</span></a>
<a name="1179"><span class="lineNum">    1179 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (normal_x8r8g8b8,  x8r8g8b8, PIXMAN_REPEAT_NORMAL)</span></a>
<a name="1180"><span class="lineNum">    1180 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (pad_a8,           a8,       PIXMAN_REPEAT_PAD)</span></a>
<a name="1181"><span class="lineNum">    1181 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (none_a8,          a8,       PIXMAN_REPEAT_NONE)</span></a>
<a name="1182"><span class="lineNum">    1182 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (reflect_a8,       a8,       PIXMAN_REPEAT_REFLECT)</span></a>
<a name="1183"><span class="lineNum">    1183 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (normal_a8,        a8,       PIXMAN_REPEAT_NORMAL)</span></a>
<a name="1184"><span class="lineNum">    1184 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (pad_r5g6b5,       r5g6b5,   PIXMAN_REPEAT_PAD)</span></a>
<a name="1185"><span class="lineNum">    1185 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (none_r5g6b5,      r5g6b5,   PIXMAN_REPEAT_NONE)</span></a>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (reflect_r5g6b5,   r5g6b5,   PIXMAN_REPEAT_REFLECT)</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 : MAKE_FETCHERS (normal_r5g6b5,    r5g6b5,   PIXMAN_REPEAT_NORMAL)</span>
<a name="1188"><span class="lineNum">    1188 </span>            : </a>
<span class="lineNum">    1189 </span>            : static void
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 : replicate_pixel_32 (bits_image_t *   bits,</span>
<span class="lineNum">    1191 </span>            :                     int              x,
<span class="lineNum">    1192 </span>            :                     int              y,
<span class="lineNum">    1193 </span>            :                     int              width,
<span class="lineNum">    1194 </span>            :                     uint32_t *       buffer)
<span class="lineNum">    1195 </span>            : {
<span class="lineNum">    1196 </span>            :     uint32_t color;
<span class="lineNum">    1197 </span>            :     uint32_t *end;
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :     color = bits-&gt;fetch_pixel_32 (bits, x, y);</span>
<span class="lineNum">    1200 </span>            : 
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :     end = buffer + width;</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :     while (buffer &lt; end)</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :         *(buffer++) = color;</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 : }</span>
<a name="1205"><span class="lineNum">    1205 </span>            : </a>
<span class="lineNum">    1206 </span>            : static void
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 : replicate_pixel_float (bits_image_t *   bits,</span>
<span class="lineNum">    1208 </span>            :                        int              x,
<span class="lineNum">    1209 </span>            :                        int              y,
<span class="lineNum">    1210 </span>            :                        int              width,
<span class="lineNum">    1211 </span>            :                        uint32_t *       b)
<span class="lineNum">    1212 </span>            : {
<span class="lineNum">    1213 </span>            :     argb_t color;
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :     argb_t *buffer = (argb_t *)b;</span>
<span class="lineNum">    1215 </span>            :     argb_t *end;
<span class="lineNum">    1216 </span>            : 
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :     color = bits-&gt;fetch_pixel_float (bits, x, y);</span>
<span class="lineNum">    1218 </span>            : 
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :     end = buffer + width;</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :     while (buffer &lt; end)</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :         *(buffer++) = color;</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 : }</span>
<a name="1223"><span class="lineNum">    1223 </span>            : </a>
<span class="lineNum">    1224 </span>            : static void
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 : bits_image_fetch_untransformed_repeat_none (bits_image_t *image,</span>
<span class="lineNum">    1226 </span>            :                                             pixman_bool_t wide,
<span class="lineNum">    1227 </span>            :                                             int           x,
<span class="lineNum">    1228 </span>            :                                             int           y,
<span class="lineNum">    1229 </span>            :                                             int           width,
<span class="lineNum">    1230 </span>            :                                             uint32_t *    buffer)
<span class="lineNum">    1231 </span>            : {
<span class="lineNum">    1232 </span>            :     uint32_t w;
<span class="lineNum">    1233 </span>            : 
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :     if (y &lt; 0 || y &gt;= image-&gt;height)</span>
<span class="lineNum">    1235 </span>            :     {
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :         memset (buffer, 0, width * (wide? sizeof (argb_t) : 4));</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1238 </span>            :     }
<span class="lineNum">    1239 </span>            : 
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :     if (x &lt; 0)</span>
<span class="lineNum">    1241 </span>            :     {
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :         w = MIN (width, -x);</span>
<span class="lineNum">    1243 </span>            : 
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :         memset (buffer, 0, w * (wide ? sizeof (argb_t) : 4));</span>
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :         width -= w;</span>
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :         buffer += w * (wide? 4 : 1);</span>
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 :         x += w;</span>
<span class="lineNum">    1249 </span>            :     }
<span class="lineNum">    1250 </span>            : 
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :     if (x &lt; image-&gt;width)</span>
<span class="lineNum">    1252 </span>            :     {
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :         w = MIN (width, image-&gt;width - x);</span>
<span class="lineNum">    1254 </span>            : 
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :         if (wide)</span>
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :             image-&gt;fetch_scanline_float ((pixman_image_t *)image, x, y, w, buffer, NULL);</span>
<span class="lineNum">    1257 </span>            :         else
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :             image-&gt;fetch_scanline_32 ((pixman_image_t *)image, x, y, w, buffer, NULL);</span>
<span class="lineNum">    1259 </span>            : 
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :         width -= w;</span>
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :         buffer += w * (wide? 4 : 1);</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :         x += w;</span>
<span class="lineNum">    1263 </span>            :     }
<span class="lineNum">    1264 </span>            : 
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :     memset (buffer, 0, width * (wide ? sizeof (argb_t) : 4));</span>
<span class="lineNum">    1266 </span>            : }
<a name="1267"><span class="lineNum">    1267 </span>            : </a>
<span class="lineNum">    1268 </span>            : static void
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 : bits_image_fetch_untransformed_repeat_normal (bits_image_t *image,</span>
<span class="lineNum">    1270 </span>            :                                               pixman_bool_t wide,
<span class="lineNum">    1271 </span>            :                                               int           x,
<span class="lineNum">    1272 </span>            :                                               int           y,
<span class="lineNum">    1273 </span>            :                                               int           width,
<span class="lineNum">    1274 </span>            :                                               uint32_t *    buffer)
<span class="lineNum">    1275 </span>            : {
<span class="lineNum">    1276 </span>            :     uint32_t w;
<span class="lineNum">    1277 </span>            : 
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :     while (y &lt; 0)</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :         y += image-&gt;height;</span>
<span class="lineNum">    1280 </span>            : 
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :     while (y &gt;= image-&gt;height)</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :         y -= image-&gt;height;</span>
<span class="lineNum">    1283 </span>            : 
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :     if (image-&gt;width == 1)</span>
<span class="lineNum">    1285 </span>            :     {
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :         if (wide)</span>
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :             replicate_pixel_float (image, 0, y, width, buffer);</span>
<span class="lineNum">    1288 </span>            :         else
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :             replicate_pixel_32 (image, 0, y, width, buffer);</span>
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1292 </span>            :     }
<span class="lineNum">    1293 </span>            : 
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :     while (width)</span>
<span class="lineNum">    1295 </span>            :     {
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :         while (x &lt; 0)</span>
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :             x += image-&gt;width;</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :         while (x &gt;= image-&gt;width)</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :             x -= image-&gt;width;</span>
<span class="lineNum">    1300 </span>            : 
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :         w = MIN (width, image-&gt;width - x);</span>
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :         if (wide)</span>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :             image-&gt;fetch_scanline_float ((pixman_image_t *)image, x, y, w, buffer, NULL);</span>
<span class="lineNum">    1305 </span>            :         else
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :             image-&gt;fetch_scanline_32 ((pixman_image_t *)image, x, y, w, buffer, NULL);</span>
<span class="lineNum">    1307 </span>            : 
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :         buffer += w * (wide? 4 : 1);</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :         x += w;</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :         width -= w;</span>
<span class="lineNum">    1311 </span>            :     }
<span class="lineNum">    1312 </span>            : }
<a name="1313"><span class="lineNum">    1313 </span>            : </a>
<span class="lineNum">    1314 </span>            : static uint32_t *
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 : bits_image_fetch_untransformed_32 (pixman_iter_t * iter,</span>
<span class="lineNum">    1316 </span>            :                                    const uint32_t *mask)
<span class="lineNum">    1317 </span>            : {
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :     pixman_image_t *image  = iter-&gt;image;</span>
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :     int             x      = iter-&gt;x;</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :     int             y      = iter-&gt;y;</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :     uint32_t *      buffer = iter-&gt;buffer;</span>
<span class="lineNum">    1323 </span>            : 
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :     if (image-&gt;common.repeat == PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">    1325 </span>            :     {
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :         bits_image_fetch_untransformed_repeat_none (</span>
<span class="lineNum">    1327 </span>            :             &amp;image-&gt;bits, FALSE, x, y, width, buffer);
<span class="lineNum">    1328 </span>            :     }
<span class="lineNum">    1329 </span>            :     else
<span class="lineNum">    1330 </span>            :     {
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :         bits_image_fetch_untransformed_repeat_normal (</span>
<span class="lineNum">    1332 </span>            :             &amp;image-&gt;bits, FALSE, x, y, width, buffer);
<span class="lineNum">    1333 </span>            :     }
<span class="lineNum">    1334 </span>            : 
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :     iter-&gt;y++;</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :     return buffer;</span>
<span class="lineNum">    1337 </span>            : }
<a name="1338"><span class="lineNum">    1338 </span>            : </a>
<span class="lineNum">    1339 </span>            : static uint32_t *
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 : bits_image_fetch_untransformed_float (pixman_iter_t * iter,</span>
<span class="lineNum">    1341 </span>            :                                       const uint32_t *mask)
<span class="lineNum">    1342 </span>            : {
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :     pixman_image_t *image  = iter-&gt;image;</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :     int             x      = iter-&gt;x;</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :     int             y      = iter-&gt;y;</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :     uint32_t *      buffer = iter-&gt;buffer;</span>
<span class="lineNum">    1348 </span>            : 
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :     if (image-&gt;common.repeat == PIXMAN_REPEAT_NONE)</span>
<span class="lineNum">    1350 </span>            :     {
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :         bits_image_fetch_untransformed_repeat_none (</span>
<span class="lineNum">    1352 </span>            :             &amp;image-&gt;bits, TRUE, x, y, width, buffer);
<span class="lineNum">    1353 </span>            :     }
<span class="lineNum">    1354 </span>            :     else
<span class="lineNum">    1355 </span>            :     {
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :         bits_image_fetch_untransformed_repeat_normal (</span>
<span class="lineNum">    1357 </span>            :             &amp;image-&gt;bits, TRUE, x, y, width, buffer);
<span class="lineNum">    1358 </span>            :     }
<span class="lineNum">    1359 </span>            : 
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :     iter-&gt;y++;</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :     return buffer;</span>
<span class="lineNum">    1362 </span>            : }
<span class="lineNum">    1363 </span>            : 
<span class="lineNum">    1364 </span>            : typedef struct
<span class="lineNum">    1365 </span>            : {
<span class="lineNum">    1366 </span>            :     pixman_format_code_t        format;
<span class="lineNum">    1367 </span>            :     uint32_t                    flags;
<span class="lineNum">    1368 </span>            :     pixman_iter_get_scanline_t  get_scanline_32;
<span class="lineNum">    1369 </span>            :     pixman_iter_get_scanline_t  get_scanline_float;
<span class="lineNum">    1370 </span>            : } fetcher_info_t;
<span class="lineNum">    1371 </span>            : 
<span class="lineNum">    1372 </span>            : static const fetcher_info_t fetcher_info[] =
<span class="lineNum">    1373 </span>            : {
<span class="lineNum">    1374 </span>            :     { PIXMAN_any,
<span class="lineNum">    1375 </span>            :       (FAST_PATH_NO_ALPHA_MAP                   |
<span class="lineNum">    1376 </span>            :        FAST_PATH_ID_TRANSFORM                   |
<span class="lineNum">    1377 </span>            :        FAST_PATH_NO_CONVOLUTION_FILTER          |
<span class="lineNum">    1378 </span>            :        FAST_PATH_NO_PAD_REPEAT                  |
<span class="lineNum">    1379 </span>            :        FAST_PATH_NO_REFLECT_REPEAT),
<span class="lineNum">    1380 </span>            :       bits_image_fetch_untransformed_32,
<span class="lineNum">    1381 </span>            :       bits_image_fetch_untransformed_float
<span class="lineNum">    1382 </span>            :     },
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span>            : #define FAST_BILINEAR_FLAGS                                             \
<span class="lineNum">    1385 </span>            :     (FAST_PATH_NO_ALPHA_MAP             |                               \
<span class="lineNum">    1386 </span>            :      FAST_PATH_NO_ACCESSORS             |                               \
<span class="lineNum">    1387 </span>            :      FAST_PATH_HAS_TRANSFORM            |                               \
<span class="lineNum">    1388 </span>            :      FAST_PATH_AFFINE_TRANSFORM         |                               \
<span class="lineNum">    1389 </span>            :      FAST_PATH_X_UNIT_POSITIVE          |                               \
<span class="lineNum">    1390 </span>            :      FAST_PATH_Y_UNIT_ZERO              |                               \
<span class="lineNum">    1391 </span>            :      FAST_PATH_NONE_REPEAT              |                               \
<span class="lineNum">    1392 </span>            :      FAST_PATH_BILINEAR_FILTER)
<span class="lineNum">    1393 </span>            : 
<span class="lineNum">    1394 </span>            :     { PIXMAN_a8r8g8b8,
<span class="lineNum">    1395 </span>            :       FAST_BILINEAR_FLAGS,
<span class="lineNum">    1396 </span>            :       bits_image_fetch_bilinear_no_repeat_8888,
<span class="lineNum">    1397 </span>            :       _pixman_image_get_scanline_generic_float
<span class="lineNum">    1398 </span>            :     },
<span class="lineNum">    1399 </span>            : 
<span class="lineNum">    1400 </span>            :     { PIXMAN_x8r8g8b8,
<span class="lineNum">    1401 </span>            :       FAST_BILINEAR_FLAGS,
<span class="lineNum">    1402 </span>            :       bits_image_fetch_bilinear_no_repeat_8888,
<span class="lineNum">    1403 </span>            :       _pixman_image_get_scanline_generic_float
<span class="lineNum">    1404 </span>            :     },
<span class="lineNum">    1405 </span>            : 
<span class="lineNum">    1406 </span>            : #define GENERAL_BILINEAR_FLAGS                                          \
<span class="lineNum">    1407 </span>            :     (FAST_PATH_NO_ALPHA_MAP             |                               \
<span class="lineNum">    1408 </span>            :      FAST_PATH_NO_ACCESSORS             |                               \
<span class="lineNum">    1409 </span>            :      FAST_PATH_HAS_TRANSFORM            |                               \
<span class="lineNum">    1410 </span>            :      FAST_PATH_AFFINE_TRANSFORM         |                               \
<span class="lineNum">    1411 </span>            :      FAST_PATH_BILINEAR_FILTER)
<span class="lineNum">    1412 </span>            : 
<span class="lineNum">    1413 </span>            : #define GENERAL_NEAREST_FLAGS                                           \
<span class="lineNum">    1414 </span>            :     (FAST_PATH_NO_ALPHA_MAP             |                               \
<span class="lineNum">    1415 </span>            :      FAST_PATH_NO_ACCESSORS             |                               \
<span class="lineNum">    1416 </span>            :      FAST_PATH_HAS_TRANSFORM            |                               \
<span class="lineNum">    1417 </span>            :      FAST_PATH_AFFINE_TRANSFORM         |                               \
<span class="lineNum">    1418 </span>            :      FAST_PATH_NEAREST_FILTER)
<span class="lineNum">    1419 </span>            : 
<span class="lineNum">    1420 </span>            : #define GENERAL_SEPARABLE_CONVOLUTION_FLAGS                             \
<span class="lineNum">    1421 </span>            :     (FAST_PATH_NO_ALPHA_MAP            |                                \
<span class="lineNum">    1422 </span>            :      FAST_PATH_NO_ACCESSORS            |                                \
<span class="lineNum">    1423 </span>            :      FAST_PATH_HAS_TRANSFORM           |                                \
<span class="lineNum">    1424 </span>            :      FAST_PATH_AFFINE_TRANSFORM        |                                \
<span class="lineNum">    1425 </span>            :      FAST_PATH_SEPARABLE_CONVOLUTION_FILTER)
<span class="lineNum">    1426 </span>            :     
<span class="lineNum">    1427 </span>            : #define SEPARABLE_CONVOLUTION_AFFINE_FAST_PATH(name, format, repeat)   \
<span class="lineNum">    1428 </span>            :     { PIXMAN_ ## format,                                               \
<span class="lineNum">    1429 </span>            :       GENERAL_SEPARABLE_CONVOLUTION_FLAGS | FAST_PATH_ ## repeat ## _REPEAT, \
<span class="lineNum">    1430 </span>            :       bits_image_fetch_separable_convolution_affine_ ## name,          \
<span class="lineNum">    1431 </span>            :       _pixman_image_get_scanline_generic_float                         \
<span class="lineNum">    1432 </span>            :     },
<span class="lineNum">    1433 </span>            : 
<span class="lineNum">    1434 </span>            : #define BILINEAR_AFFINE_FAST_PATH(name, format, repeat)                 \
<span class="lineNum">    1435 </span>            :     { PIXMAN_ ## format,                                                \
<span class="lineNum">    1436 </span>            :       GENERAL_BILINEAR_FLAGS | FAST_PATH_ ## repeat ## _REPEAT,         \
<span class="lineNum">    1437 </span>            :       bits_image_fetch_bilinear_affine_ ## name,                        \
<span class="lineNum">    1438 </span>            :       _pixman_image_get_scanline_generic_float                          \
<span class="lineNum">    1439 </span>            :     },
<span class="lineNum">    1440 </span>            : 
<span class="lineNum">    1441 </span>            : #define NEAREST_AFFINE_FAST_PATH(name, format, repeat)                  \
<span class="lineNum">    1442 </span>            :     { PIXMAN_ ## format,                                                \
<span class="lineNum">    1443 </span>            :       GENERAL_NEAREST_FLAGS | FAST_PATH_ ## repeat ## _REPEAT,          \
<span class="lineNum">    1444 </span>            :       bits_image_fetch_nearest_affine_ ## name,                         \
<span class="lineNum">    1445 </span>            :       _pixman_image_get_scanline_generic_float                          \
<span class="lineNum">    1446 </span>            :     },
<span class="lineNum">    1447 </span>            : 
<span class="lineNum">    1448 </span>            : #define AFFINE_FAST_PATHS(name, format, repeat)                         \
<span class="lineNum">    1449 </span>            :     SEPARABLE_CONVOLUTION_AFFINE_FAST_PATH(name, format, repeat)        \
<span class="lineNum">    1450 </span>            :     BILINEAR_AFFINE_FAST_PATH(name, format, repeat)                     \
<span class="lineNum">    1451 </span>            :     NEAREST_AFFINE_FAST_PATH(name, format, repeat)
<span class="lineNum">    1452 </span>            :     
<span class="lineNum">    1453 </span>            :     AFFINE_FAST_PATHS (pad_a8r8g8b8, a8r8g8b8, PAD)
<span class="lineNum">    1454 </span>            :     AFFINE_FAST_PATHS (none_a8r8g8b8, a8r8g8b8, NONE)
<span class="lineNum">    1455 </span>            :     AFFINE_FAST_PATHS (reflect_a8r8g8b8, a8r8g8b8, REFLECT)
<span class="lineNum">    1456 </span>            :     AFFINE_FAST_PATHS (normal_a8r8g8b8, a8r8g8b8, NORMAL)
<span class="lineNum">    1457 </span>            :     AFFINE_FAST_PATHS (pad_x8r8g8b8, x8r8g8b8, PAD)
<span class="lineNum">    1458 </span>            :     AFFINE_FAST_PATHS (none_x8r8g8b8, x8r8g8b8, NONE)
<span class="lineNum">    1459 </span>            :     AFFINE_FAST_PATHS (reflect_x8r8g8b8, x8r8g8b8, REFLECT)
<span class="lineNum">    1460 </span>            :     AFFINE_FAST_PATHS (normal_x8r8g8b8, x8r8g8b8, NORMAL)
<span class="lineNum">    1461 </span>            :     AFFINE_FAST_PATHS (pad_a8, a8, PAD)
<span class="lineNum">    1462 </span>            :     AFFINE_FAST_PATHS (none_a8, a8, NONE)
<span class="lineNum">    1463 </span>            :     AFFINE_FAST_PATHS (reflect_a8, a8, REFLECT)
<span class="lineNum">    1464 </span>            :     AFFINE_FAST_PATHS (normal_a8, a8, NORMAL)
<span class="lineNum">    1465 </span>            :     AFFINE_FAST_PATHS (pad_r5g6b5, r5g6b5, PAD)
<span class="lineNum">    1466 </span>            :     AFFINE_FAST_PATHS (none_r5g6b5, r5g6b5, NONE)
<span class="lineNum">    1467 </span>            :     AFFINE_FAST_PATHS (reflect_r5g6b5, r5g6b5, REFLECT)
<span class="lineNum">    1468 </span>            :     AFFINE_FAST_PATHS (normal_r5g6b5, r5g6b5, NORMAL)
<span class="lineNum">    1469 </span>            : 
<span class="lineNum">    1470 </span>            :     /* Affine, no alpha */
<span class="lineNum">    1471 </span>            :     { PIXMAN_any,
<span class="lineNum">    1472 </span>            :       (FAST_PATH_NO_ALPHA_MAP | FAST_PATH_HAS_TRANSFORM | FAST_PATH_AFFINE_TRANSFORM),
<span class="lineNum">    1473 </span>            :       bits_image_fetch_affine_no_alpha,
<span class="lineNum">    1474 </span>            :       _pixman_image_get_scanline_generic_float
<span class="lineNum">    1475 </span>            :     },
<span class="lineNum">    1476 </span>            : 
<span class="lineNum">    1477 </span>            :     /* General */
<span class="lineNum">    1478 </span>            :     { PIXMAN_any,
<span class="lineNum">    1479 </span>            :       0,
<span class="lineNum">    1480 </span>            :       bits_image_fetch_general,
<span class="lineNum">    1481 </span>            :       _pixman_image_get_scanline_generic_float
<span class="lineNum">    1482 </span>            :     },
<span class="lineNum">    1483 </span>            : 
<span class="lineNum">    1484 </span>            :     { PIXMAN_null },
<span class="lineNum">    1485 </span>            : };
<a name="1486"><span class="lineNum">    1486 </span>            : </a>
<span class="lineNum">    1487 </span>            : static void
<span class="lineNum">    1488 </span><span class="lineCov">         44 : bits_image_property_changed (pixman_image_t *image)</span>
<span class="lineNum">    1489 </span>            : {
<span class="lineNum">    1490 </span><span class="lineCov">         44 :     _pixman_bits_image_setup_accessors (&amp;image-&gt;bits);</span>
<span class="lineNum">    1491 </span><span class="lineCov">         44 : }</span>
<a name="1492"><span class="lineNum">    1492 </span>            : </a>
<span class="lineNum">    1493 </span>            : void
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 : _pixman_bits_image_src_iter_init (pixman_image_t *image, pixman_iter_t *iter)</span>
<span class="lineNum">    1495 </span>            : {
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :     pixman_format_code_t format = image-&gt;common.extended_format_code;</span>
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :     uint32_t flags = image-&gt;common.flags;</span>
<span class="lineNum">    1498 </span>            :     const fetcher_info_t *info;
<span class="lineNum">    1499 </span>            : 
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :     for (info = fetcher_info; info-&gt;format != PIXMAN_null; ++info)</span>
<span class="lineNum">    1501 </span>            :     {
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :         if ((info-&gt;format == format || info-&gt;format == PIXMAN_any)        &amp;&amp;</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :             (info-&gt;flags &amp; flags) == info-&gt;flags)</span>
<span class="lineNum">    1504 </span>            :         {
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :             if (iter-&gt;iter_flags &amp; ITER_NARROW)</span>
<span class="lineNum">    1506 </span>            :             {
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :                 iter-&gt;get_scanline = info-&gt;get_scanline_32;</span>
<span class="lineNum">    1508 </span>            :             }
<span class="lineNum">    1509 </span>            :             else
<span class="lineNum">    1510 </span>            :             {
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :                 iter-&gt;data = info-&gt;get_scanline_32;</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :                 iter-&gt;get_scanline = info-&gt;get_scanline_float;</span>
<span class="lineNum">    1513 </span>            :             }
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1515 </span>            :         }
<span class="lineNum">    1516 </span>            :     }
<span class="lineNum">    1517 </span>            : 
<span class="lineNum">    1518 </span>            :     /* Just in case we somehow didn't find a scanline function */
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :     iter-&gt;get_scanline = _pixman_iter_get_scanline_noop;</span>
<span class="lineNum">    1520 </span>            : }
<a name="1521"><span class="lineNum">    1521 </span>            : </a>
<span class="lineNum">    1522 </span>            : static uint32_t *
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 : dest_get_scanline_16 (pixman_iter_t *iter, const uint32_t *mask)</span>
<span class="lineNum">    1524 </span>            : {
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :     pixman_image_t *image  = iter-&gt;image;</span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :     int             x      = iter-&gt;x;</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :     int             y      = iter-&gt;y;</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :     uint32_t *      buffer = iter-&gt;buffer;</span>
<span class="lineNum">    1530 </span>            : 
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :     image-&gt;bits.fetch_scanline_16 (image, x, y, width, buffer, mask);</span>
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :     return iter-&gt;buffer;</span>
<span class="lineNum">    1534 </span>            : }
<a name="1535"><span class="lineNum">    1535 </span>            : </a>
<span class="lineNum">    1536 </span>            : static uint32_t *
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 : dest_get_scanline_narrow (pixman_iter_t *iter, const uint32_t *mask)</span>
<span class="lineNum">    1538 </span>            : {
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :     pixman_image_t *image  = iter-&gt;image;</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :     int             x      = iter-&gt;x;</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :     int             y      = iter-&gt;y;</span>
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :     uint32_t *      buffer = iter-&gt;buffer;</span>
<span class="lineNum">    1544 </span>            : 
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :     image-&gt;bits.fetch_scanline_32 (image, x, y, width, buffer, mask);</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :     if (image-&gt;common.alpha_map)</span>
<span class="lineNum">    1547 </span>            :     {
<span class="lineNum">    1548 </span>            :         uint32_t *alpha;
<span class="lineNum">    1549 </span>            : 
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :         if ((alpha = malloc (width * sizeof (uint32_t))))</span>
<span class="lineNum">    1551 </span>            :         {
<span class="lineNum">    1552 </span>            :             int i;
<span class="lineNum">    1553 </span>            : 
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :             x -= image-&gt;common.alpha_origin_x;</span>
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :             y -= image-&gt;common.alpha_origin_y;</span>
<span class="lineNum">    1556 </span>            : 
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :             image-&gt;common.alpha_map-&gt;fetch_scanline_32 (</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :                 (pixman_image_t *)image-&gt;common.alpha_map,</span>
<span class="lineNum">    1559 </span>            :                 x, y, width, alpha, mask);
<span class="lineNum">    1560 </span>            : 
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :             for (i = 0; i &lt; width; ++i)</span>
<span class="lineNum">    1562 </span>            :             {
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :                 buffer[i] &amp;= ~0xff000000;</span>
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :                 buffer[i] |= (alpha[i] &amp; 0xff000000);</span>
<span class="lineNum">    1565 </span>            :             }
<span class="lineNum">    1566 </span>            : 
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :             free (alpha);</span>
<span class="lineNum">    1568 </span>            :         }
<span class="lineNum">    1569 </span>            :     }
<span class="lineNum">    1570 </span>            : 
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :     return iter-&gt;buffer;</span>
<span class="lineNum">    1572 </span>            : }
<a name="1573"><span class="lineNum">    1573 </span>            : </a>
<span class="lineNum">    1574 </span>            : static uint32_t *
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 : dest_get_scanline_wide (pixman_iter_t *iter, const uint32_t *mask)</span>
<span class="lineNum">    1576 </span>            : {
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :     bits_image_t *  image  = &amp;iter-&gt;image-&gt;bits;</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :     int             x      = iter-&gt;x;</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :     int             y      = iter-&gt;y;</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :     argb_t *        buffer = (argb_t *)iter-&gt;buffer;</span>
<span class="lineNum">    1582 </span>            : 
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :     image-&gt;fetch_scanline_float (</span>
<span class="lineNum">    1584 </span>            :         (pixman_image_t *)image, x, y, width, (uint32_t *)buffer, mask);
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :     if (image-&gt;common.alpha_map)</span>
<span class="lineNum">    1586 </span>            :     {
<span class="lineNum">    1587 </span>            :         argb_t *alpha;
<span class="lineNum">    1588 </span>            : 
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :         if ((alpha = malloc (width * sizeof (argb_t))))</span>
<span class="lineNum">    1590 </span>            :         {
<span class="lineNum">    1591 </span>            :             int i;
<span class="lineNum">    1592 </span>            : 
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :             x -= image-&gt;common.alpha_origin_x;</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :             y -= image-&gt;common.alpha_origin_y;</span>
<span class="lineNum">    1595 </span>            : 
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :             image-&gt;common.alpha_map-&gt;fetch_scanline_float (</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :                 (pixman_image_t *)image-&gt;common.alpha_map,</span>
<span class="lineNum">    1598 </span>            :                 x, y, width, (uint32_t *)alpha, mask);
<span class="lineNum">    1599 </span>            : 
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :             for (i = 0; i &lt; width; ++i)</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :                 buffer[i].a = alpha[i].a;</span>
<span class="lineNum">    1602 </span>            : 
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :             free (alpha);</span>
<span class="lineNum">    1604 </span>            :         }
<span class="lineNum">    1605 </span>            :     }
<span class="lineNum">    1606 </span>            : 
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :     return iter-&gt;buffer;</span>
<span class="lineNum">    1608 </span>            : }
<a name="1609"><span class="lineNum">    1609 </span>            : </a>
<span class="lineNum">    1610 </span>            : static void
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 : dest_write_back_16 (pixman_iter_t *iter)</span>
<span class="lineNum">    1612 </span>            : {
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :     bits_image_t *  image  = &amp;iter-&gt;image-&gt;bits;</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :     int             x      = iter-&gt;x;</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :     int             y      = iter-&gt;y;</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :     const uint32_t *buffer = iter-&gt;buffer;</span>
<span class="lineNum">    1618 </span>            : 
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :     image-&gt;store_scanline_16 (image, x, y, width, buffer);</span>
<span class="lineNum">    1620 </span>            : 
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :     iter-&gt;y++;</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 : }</span>
<a name="1623"><span class="lineNum">    1623 </span>            : </a>
<span class="lineNum">    1624 </span>            : static void
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 : dest_write_back_narrow (pixman_iter_t *iter)</span>
<span class="lineNum">    1626 </span>            : {
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :     bits_image_t *  image  = &amp;iter-&gt;image-&gt;bits;</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :     int             x      = iter-&gt;x;</span>
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :     int             y      = iter-&gt;y;</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :     const uint32_t *buffer = iter-&gt;buffer;</span>
<span class="lineNum">    1632 </span>            : 
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :     image-&gt;store_scanline_32 (image, x, y, width, buffer);</span>
<span class="lineNum">    1634 </span>            : 
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :     if (image-&gt;common.alpha_map)</span>
<span class="lineNum">    1636 </span>            :     {
<span class="lineNum">    1637 </span><span class="lineNoCov">          0 :         x -= image-&gt;common.alpha_origin_x;</span>
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :         y -= image-&gt;common.alpha_origin_y;</span>
<span class="lineNum">    1639 </span>            : 
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :         image-&gt;common.alpha_map-&gt;store_scanline_32 (</span>
<span class="lineNum">    1641 </span>            :             image-&gt;common.alpha_map, x, y, width, buffer);
<span class="lineNum">    1642 </span>            :     }
<span class="lineNum">    1643 </span>            : 
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :     iter-&gt;y++;</span>
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 : }</span>
<a name="1646"><span class="lineNum">    1646 </span>            : </a>
<span class="lineNum">    1647 </span>            : static void
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 : dest_write_back_wide (pixman_iter_t *iter)</span>
<span class="lineNum">    1649 </span>            : {
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :     bits_image_t *  image  = &amp;iter-&gt;image-&gt;bits;</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :     int             x      = iter-&gt;x;</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :     int             y      = iter-&gt;y;</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :     int             width  = iter-&gt;width;</span>
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :     const uint32_t *buffer = iter-&gt;buffer;</span>
<span class="lineNum">    1655 </span>            : 
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :     image-&gt;store_scanline_float (image, x, y, width, buffer);</span>
<span class="lineNum">    1657 </span>            : 
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :     if (image-&gt;common.alpha_map)</span>
<span class="lineNum">    1659 </span>            :     {
<span class="lineNum">    1660 </span><span class="lineNoCov">          0 :         x -= image-&gt;common.alpha_origin_x;</span>
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :         y -= image-&gt;common.alpha_origin_y;</span>
<span class="lineNum">    1662 </span>            : 
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :         image-&gt;common.alpha_map-&gt;store_scanline_float (</span>
<span class="lineNum">    1664 </span>            :             image-&gt;common.alpha_map, x, y, width, buffer);
<span class="lineNum">    1665 </span>            :     }
<span class="lineNum">    1666 </span>            : 
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :     iter-&gt;y++;</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 : }</span>
<a name="1669"><span class="lineNum">    1669 </span>            : </a>
<span class="lineNum">    1670 </span>            : void
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 : _pixman_bits_image_dest_iter_init (pixman_image_t *image, pixman_iter_t *iter)</span>
<span class="lineNum">    1672 </span>            : {
<span class="lineNum">    1673 </span><span class="lineNoCov">          0 :     if (iter-&gt;iter_flags &amp; ITER_16)</span>
<span class="lineNum">    1674 </span>            :     {
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :         if ((iter-&gt;iter_flags &amp; (ITER_IGNORE_RGB | ITER_IGNORE_ALPHA)) ==</span>
<span class="lineNum">    1676 </span>            :             (ITER_IGNORE_RGB | ITER_IGNORE_ALPHA))
<span class="lineNum">    1677 </span>            :         {
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 :             iter-&gt;get_scanline = _pixman_iter_get_scanline_noop;</span>
<span class="lineNum">    1679 </span>            :         }
<span class="lineNum">    1680 </span>            :         else
<span class="lineNum">    1681 </span>            :         {
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :             iter-&gt;get_scanline = dest_get_scanline_16;</span>
<span class="lineNum">    1683 </span>            :         }
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 :         iter-&gt;write_back = dest_write_back_16;</span>
<span class="lineNum">    1685 </span>            :     }
<span class="lineNum">    1686 </span><span class="lineNoCov">          0 :     else if (iter-&gt;iter_flags &amp; ITER_NARROW)</span>
<span class="lineNum">    1687 </span>            :     {
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 :         if ((iter-&gt;iter_flags &amp; (ITER_IGNORE_RGB | ITER_IGNORE_ALPHA)) ==</span>
<span class="lineNum">    1689 </span>            :             (ITER_IGNORE_RGB | ITER_IGNORE_ALPHA))
<span class="lineNum">    1690 </span>            :         {
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :             iter-&gt;get_scanline = _pixman_iter_get_scanline_noop;</span>
<span class="lineNum">    1692 </span>            :         }
<span class="lineNum">    1693 </span>            :         else
<span class="lineNum">    1694 </span>            :         {
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :             iter-&gt;get_scanline = dest_get_scanline_narrow;</span>
<span class="lineNum">    1696 </span>            :         }
<span class="lineNum">    1697 </span>            : 
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :         iter-&gt;write_back = dest_write_back_narrow;</span>
<span class="lineNum">    1699 </span>            :     }
<span class="lineNum">    1700 </span>            :     else
<span class="lineNum">    1701 </span>            :     {
<span class="lineNum">    1702 </span><span class="lineNoCov">          0 :         iter-&gt;get_scanline = dest_get_scanline_wide;</span>
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :         iter-&gt;write_back = dest_write_back_wide;</span>
<span class="lineNum">    1704 </span>            :     }
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 : }</span>
<a name="1706"><span class="lineNum">    1706 </span>            : </a>
<span class="lineNum">    1707 </span>            : static uint32_t *
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 : create_bits (pixman_format_code_t format,</span>
<span class="lineNum">    1709 </span>            :              int                  width,
<span class="lineNum">    1710 </span>            :              int                  height,
<span class="lineNum">    1711 </span>            :              int *                rowstride_bytes,
<span class="lineNum">    1712 </span>            :              pixman_bool_t        clear)
<span class="lineNum">    1713 </span>            : {
<span class="lineNum">    1714 </span>            :     int stride;
<span class="lineNum">    1715 </span>            :     size_t buf_size;
<span class="lineNum">    1716 </span>            :     int bpp;
<span class="lineNum">    1717 </span>            : 
<span class="lineNum">    1718 </span>            :     /* what follows is a long-winded way, avoiding any possibility of integer
<span class="lineNum">    1719 </span>            :      * overflows, of saying:
<span class="lineNum">    1720 </span>            :      * stride = ((width * bpp + 0x1f) &gt;&gt; 5) * sizeof (uint32_t);
<span class="lineNum">    1721 </span>            :      */
<span class="lineNum">    1722 </span>            : 
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :     bpp = PIXMAN_FORMAT_BPP (format);</span>
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :     if (_pixman_multiply_overflows_int (width, bpp))</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1726 </span>            : 
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 :     stride = width * bpp;</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :     if (_pixman_addition_overflows_int (stride, 0x1f))</span>
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1730 </span>            : 
<span class="lineNum">    1731 </span><span class="lineNoCov">          0 :     stride += 0x1f;</span>
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :     stride &gt;&gt;= 5;</span>
<span class="lineNum">    1733 </span>            : 
<span class="lineNum">    1734 </span><span class="lineNoCov">          0 :     stride *= sizeof (uint32_t);</span>
<span class="lineNum">    1735 </span>            : 
<span class="lineNum">    1736 </span><span class="lineNoCov">          0 :     if (_pixman_multiply_overflows_size (height, stride))</span>
<span class="lineNum">    1737 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1738 </span>            : 
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 :     buf_size = (size_t)height * stride;</span>
<span class="lineNum">    1740 </span>            : 
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :     if (rowstride_bytes)</span>
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :         *rowstride_bytes = stride;</span>
<span class="lineNum">    1743 </span>            : 
<span class="lineNum">    1744 </span><span class="lineNoCov">          0 :     if (clear)</span>
<span class="lineNum">    1745 </span><span class="lineNoCov">          0 :         return calloc (buf_size, 1);</span>
<span class="lineNum">    1746 </span>            :     else
<span class="lineNum">    1747 </span><span class="lineNoCov">          0 :         return malloc (buf_size);</span>
<span class="lineNum">    1748 </span>            : }
<a name="1749"><span class="lineNum">    1749 </span>            : </a>
<span class="lineNum">    1750 </span>            : pixman_bool_t
<span class="lineNum">    1751 </span><span class="lineCov">         47 : _pixman_bits_image_init (pixman_image_t *     image,</span>
<span class="lineNum">    1752 </span>            :                          pixman_format_code_t format,
<span class="lineNum">    1753 </span>            :                          int                  width,
<span class="lineNum">    1754 </span>            :                          int                  height,
<span class="lineNum">    1755 </span>            :                          uint32_t *           bits,
<span class="lineNum">    1756 </span>            :                          int                  rowstride,
<span class="lineNum">    1757 </span>            :                          pixman_bool_t        clear)
<span class="lineNum">    1758 </span>            : {
<span class="lineNum">    1759 </span><span class="lineCov">         47 :     uint32_t *free_me = NULL;</span>
<span class="lineNum">    1760 </span>            : 
<span class="lineNum">    1761 </span><span class="lineCov">         47 :     if (!bits &amp;&amp; width &amp;&amp; height)</span>
<span class="lineNum">    1762 </span>            :     {
<span class="lineNum">    1763 </span>            :         int rowstride_bytes;
<span class="lineNum">    1764 </span>            : 
<span class="lineNum">    1765 </span><span class="lineNoCov">          0 :         free_me = bits = create_bits (format, width, height, &amp;rowstride_bytes, clear);</span>
<span class="lineNum">    1766 </span>            : 
<span class="lineNum">    1767 </span><span class="lineNoCov">          0 :         if (!bits)</span>
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :             return FALSE;</span>
<span class="lineNum">    1769 </span>            : 
<span class="lineNum">    1770 </span><span class="lineNoCov">          0 :         rowstride = rowstride_bytes / (int) sizeof (uint32_t);</span>
<span class="lineNum">    1771 </span>            :     }
<span class="lineNum">    1772 </span>            : 
<span class="lineNum">    1773 </span><span class="lineCov">         47 :     _pixman_image_init (image);</span>
<span class="lineNum">    1774 </span>            : 
<span class="lineNum">    1775 </span><span class="lineCov">         47 :     image-&gt;type = BITS;</span>
<span class="lineNum">    1776 </span><span class="lineCov">         47 :     image-&gt;bits.format = format;</span>
<span class="lineNum">    1777 </span><span class="lineCov">         47 :     image-&gt;bits.width = width;</span>
<span class="lineNum">    1778 </span><span class="lineCov">         47 :     image-&gt;bits.height = height;</span>
<span class="lineNum">    1779 </span><span class="lineCov">         47 :     image-&gt;bits.bits = bits;</span>
<span class="lineNum">    1780 </span><span class="lineCov">         47 :     image-&gt;bits.free_me = free_me;</span>
<span class="lineNum">    1781 </span><span class="lineCov">         47 :     image-&gt;bits.read_func = NULL;</span>
<span class="lineNum">    1782 </span><span class="lineCov">         47 :     image-&gt;bits.write_func = NULL;</span>
<span class="lineNum">    1783 </span><span class="lineCov">         47 :     image-&gt;bits.rowstride = rowstride;</span>
<span class="lineNum">    1784 </span><span class="lineCov">         47 :     image-&gt;bits.indexed = NULL;</span>
<span class="lineNum">    1785 </span>            : 
<span class="lineNum">    1786 </span><span class="lineCov">         47 :     image-&gt;common.property_changed = bits_image_property_changed;</span>
<span class="lineNum">    1787 </span>            : 
<span class="lineNum">    1788 </span><span class="lineCov">         47 :     _pixman_image_reset_clip_region (image);</span>
<span class="lineNum">    1789 </span>            : 
<span class="lineNum">    1790 </span><span class="lineCov">         47 :     return TRUE;</span>
<span class="lineNum">    1791 </span>            : }
<a name="1792"><span class="lineNum">    1792 </span>            : </a>
<span class="lineNum">    1793 </span>            : static pixman_image_t *
<span class="lineNum">    1794 </span><span class="lineCov">         47 : create_bits_image_internal (pixman_format_code_t format,</span>
<span class="lineNum">    1795 </span>            :                             int                  width,
<span class="lineNum">    1796 </span>            :                             int                  height,
<span class="lineNum">    1797 </span>            :                             uint32_t *           bits,
<span class="lineNum">    1798 </span>            :                             int                  rowstride_bytes,
<span class="lineNum">    1799 </span>            :                             pixman_bool_t        clear)
<span class="lineNum">    1800 </span>            : {
<span class="lineNum">    1801 </span>            :     pixman_image_t *image;
<span class="lineNum">    1802 </span>            : 
<span class="lineNum">    1803 </span>            :     /* must be a whole number of uint32_t's
<span class="lineNum">    1804 </span>            :      */
<span class="lineNum">    1805 </span><span class="lineCov">         47 :     return_val_if_fail (</span>
<span class="lineNum">    1806 </span>            :         bits == NULL || (rowstride_bytes % sizeof (uint32_t)) == 0, NULL);
<span class="lineNum">    1807 </span>            : 
<span class="lineNum">    1808 </span><span class="lineCov">         47 :     return_val_if_fail (PIXMAN_FORMAT_BPP (format) &gt;= PIXMAN_FORMAT_DEPTH (format), NULL);</span>
<span class="lineNum">    1809 </span>            : 
<span class="lineNum">    1810 </span><span class="lineCov">         47 :     image = _pixman_image_allocate ();</span>
<span class="lineNum">    1811 </span>            : 
<span class="lineNum">    1812 </span><span class="lineCov">         47 :     if (!image)</span>
<span class="lineNum">    1813 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1814 </span>            : 
<span class="lineNum">    1815 </span><span class="lineCov">         47 :     if (!_pixman_bits_image_init (image, format, width, height, bits,</span>
<span class="lineNum">    1816 </span>            :                                   rowstride_bytes / (int) sizeof (uint32_t),
<span class="lineNum">    1817 </span>            :                                   clear))
<span class="lineNum">    1818 </span>            :     {
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :         free (image);</span>
<span class="lineNum">    1820 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1821 </span>            :     }
<span class="lineNum">    1822 </span>            : 
<span class="lineNum">    1823 </span><span class="lineCov">         47 :     return image;</span>
<span class="lineNum">    1824 </span>            : }
<span class="lineNum">    1825 </span>            : 
<a name="1826"><span class="lineNum">    1826 </span>            : /* If bits is NULL, a buffer will be allocated and initialized to 0 */</a>
<span class="lineNum">    1827 </span>            : PIXMAN_EXPORT pixman_image_t *
<span class="lineNum">    1828 </span><span class="lineCov">         47 : pixman_image_create_bits (pixman_format_code_t format,</span>
<span class="lineNum">    1829 </span>            :                           int                  width,
<span class="lineNum">    1830 </span>            :                           int                  height,
<span class="lineNum">    1831 </span>            :                           uint32_t *           bits,
<span class="lineNum">    1832 </span>            :                           int                  rowstride_bytes)
<span class="lineNum">    1833 </span>            : {
<span class="lineNum">    1834 </span><span class="lineCov">         47 :     return create_bits_image_internal (</span>
<span class="lineNum">    1835 </span>            :         format, width, height, bits, rowstride_bytes, TRUE);
<span class="lineNum">    1836 </span>            : }
<span class="lineNum">    1837 </span>            : 
<span class="lineNum">    1838 </span>            : 
<a name="1839"><span class="lineNum">    1839 </span>            : /* If bits is NULL, a buffer will be allocated and _not_ initialized */</a>
<span class="lineNum">    1840 </span>            : PIXMAN_EXPORT pixman_image_t *
<span class="lineNum">    1841 </span><span class="lineNoCov">          0 : pixman_image_create_bits_no_clear (pixman_format_code_t format,</span>
<span class="lineNum">    1842 </span>            :                                    int                  width,
<span class="lineNum">    1843 </span>            :                                    int                  height,
<span class="lineNum">    1844 </span>            :                                    uint32_t *           bits,
<span class="lineNum">    1845 </span>            :                                    int                  rowstride_bytes)
<span class="lineNum">    1846 </span>            : {
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :     return create_bits_image_internal (</span>
<span class="lineNum">    1848 </span>            :         format, width, height, bits, rowstride_bytes, FALSE);
<span class="lineNum">    1849 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - media/libvorbis/lib/vorbis_floor1.c</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">media/libvorbis/lib</a> - vorbis_floor1.c<span style="font-size: 80%;"> (source / <a href="vorbis_floor1.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">558</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">19</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /********************************************************************</a>
<span class="lineNum">       2 </span>            :  *                                                                  *
<span class="lineNum">       3 </span>            :  * THIS FILE IS PART OF THE OggVorbis SOFTWARE CODEC SOURCE CODE.   *
<span class="lineNum">       4 </span>            :  * USE, DISTRIBUTION AND REPRODUCTION OF THIS LIBRARY SOURCE IS     *
<span class="lineNum">       5 </span>            :  * GOVERNED BY A BSD-STYLE SOURCE LICENSE INCLUDED WITH THIS SOURCE *
<span class="lineNum">       6 </span>            :  * IN 'COPYING'. PLEASE READ THESE TERMS BEFORE DISTRIBUTING.       *
<span class="lineNum">       7 </span>            :  *                                                                  *
<span class="lineNum">       8 </span>            :  * THE OggVorbis SOURCE CODE IS (C) COPYRIGHT 1994-2015             *
<span class="lineNum">       9 </span>            :  * by the Xiph.Org Foundation http://www.xiph.org/                  *
<span class="lineNum">      10 </span>            :  *                                                                  *
<span class="lineNum">      11 </span>            :  ********************************************************************
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            :  function: floor backend 1 implementation
<span class="lineNum">      14 </span>            :  last mod: $Id$
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            :  ********************************************************************/
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      19 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      20 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      21 </span>            : #include &lt;ogg/ogg.h&gt;
<span class="lineNum">      22 </span>            : #include &quot;vorbis/codec.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;codec_internal.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;registry.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;codebook.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;misc.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;scales.h&quot;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #define floor1_rangedB 140 /* floor 1 fixed at -140dB to 0dB range */
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : typedef struct lsfit_acc{
<span class="lineNum">      34 </span>            :   int x0;
<span class="lineNum">      35 </span>            :   int x1;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            :   int xa;
<span class="lineNum">      38 </span>            :   int ya;
<span class="lineNum">      39 </span>            :   int x2a;
<span class="lineNum">      40 </span>            :   int y2a;
<span class="lineNum">      41 </span>            :   int xya;
<span class="lineNum">      42 </span>            :   int an;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            :   int xb;
<span class="lineNum">      45 </span>            :   int yb;
<span class="lineNum">      46 </span>            :   int x2b;
<span class="lineNum">      47 </span>            :   int y2b;
<span class="lineNum">      48 </span>            :   int xyb;
<span class="lineNum">      49 </span>            :   int bn;
<span class="lineNum">      50 </span>            : } lsfit_acc;
<span class="lineNum">      51 </span>            : 
<a name="52"><span class="lineNum">      52 </span>            : /***********************************************/</a>
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span><span class="lineNoCov">          0 : static void floor1_free_info(vorbis_info_floor *i){</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :   vorbis_info_floor1 *info=(vorbis_info_floor1 *)i;</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :   if(info){</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :     memset(info,0,sizeof(*info));</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :     _ogg_free(info);</span>
<span class="lineNum">      59 </span>            :   }
<a name="60"><span class="lineNum">      60 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : static void floor1_free_look(vorbis_look_floor *i){</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :   vorbis_look_floor1 *look=(vorbis_look_floor1 *)i;</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :   if(look){</span>
<span class="lineNum">      65 </span>            :     /*fprintf(stderr,&quot;floor 1 bit usage %f:%f (%f total)\n&quot;,
<span class="lineNum">      66 </span>            :             (float)look-&gt;phrasebits/look-&gt;frames,
<span class="lineNum">      67 </span>            :             (float)look-&gt;postbits/look-&gt;frames,
<span class="lineNum">      68 </span>            :             (float)(look-&gt;postbits+look-&gt;phrasebits)/look-&gt;frames);*/
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :     memset(look,0,sizeof(*look));</span>
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :     _ogg_free(look);</span>
<span class="lineNum">      72 </span>            :   }
<a name="73"><span class="lineNum">      73 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span><span class="lineNoCov">          0 : static void floor1_pack (vorbis_info_floor *i,oggpack_buffer *opb){</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :   vorbis_info_floor1 *info=(vorbis_info_floor1 *)i;</span>
<span class="lineNum">      77 </span>            :   int j,k;
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :   int count=0;</span>
<span class="lineNum">      79 </span>            :   int rangebits;
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :   int maxposit=info-&gt;postlist[1];</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :   int maxclass=-1;</span>
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            :   /* save out partitions */
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :   oggpack_write(opb,info-&gt;partitions,5); /* only 0 to 31 legal */</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :   for(j=0;j&lt;info-&gt;partitions;j++){</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :     oggpack_write(opb,info-&gt;partitionclass[j],4); /* only 0 to 15 legal */</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :     if(maxclass&lt;info-&gt;partitionclass[j])maxclass=info-&gt;partitionclass[j];</span>
<span class="lineNum">      88 </span>            :   }
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            :   /* save out partition classes */
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :   for(j=0;j&lt;maxclass+1;j++){</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :     oggpack_write(opb,info-&gt;class_dim[j]-1,3); /* 1 to 8 */</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :     oggpack_write(opb,info-&gt;class_subs[j],2); /* 0 to 3 */</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :     if(info-&gt;class_subs[j])oggpack_write(opb,info-&gt;class_book[j],8);</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :     for(k=0;k&lt;(1&lt;&lt;info-&gt;class_subs[j]);k++)</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :       oggpack_write(opb,info-&gt;class_subbook[j][k]+1,8);</span>
<span class="lineNum">      97 </span>            :   }
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            :   /* save out the post list */
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   oggpack_write(opb,info-&gt;mult-1,2);     /* only 1,2,3,4 legal now */</span>
<span class="lineNum">     101 </span>            :   /* maxposit cannot legally be less than 1; this is encode-side, we
<span class="lineNum">     102 </span>            :      can assume our setup is OK */
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :   oggpack_write(opb,ov_ilog(maxposit-1),4);</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :   rangebits=ov_ilog(maxposit-1);</span>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :   for(j=0,k=0;j&lt;info-&gt;partitions;j++){</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     count+=info-&gt;class_dim[info-&gt;partitionclass[j]];</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     for(;k&lt;count;k++)</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :       oggpack_write(opb,info-&gt;postlist[k+2],rangebits);</span>
<span class="lineNum">     110 </span>            :   }
<a name="111"><span class="lineNum">     111 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span><span class="lineNoCov">          0 : static int icomp(const void *a,const void *b){</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :   return(**(int **)a-**(int **)b);</span>
<a name="115"><span class="lineNum">     115 </span>            : }</a>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineNoCov">          0 : static vorbis_info_floor *floor1_unpack (vorbis_info *vi,oggpack_buffer *opb){</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :   codec_setup_info     *ci=vi-&gt;codec_setup;</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :   int j,k,count=0,maxclass=-1,rangebits;</span>
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   vorbis_info_floor1 *info=_ogg_calloc(1,sizeof(*info));</span>
<span class="lineNum">     122 </span>            :   /* read partitions */
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   info-&gt;partitions=oggpack_read(opb,5); /* only 0 to 31 legal */</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   for(j=0;j&lt;info-&gt;partitions;j++){</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     info-&gt;partitionclass[j]=oggpack_read(opb,4); /* only 0 to 15 legal */</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     if(info-&gt;partitionclass[j]&lt;0)goto err_out;</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :     if(maxclass&lt;info-&gt;partitionclass[j])maxclass=info-&gt;partitionclass[j];</span>
<span class="lineNum">     128 </span>            :   }
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span>            :   /* read partition classes */
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   for(j=0;j&lt;maxclass+1;j++){</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     info-&gt;class_dim[j]=oggpack_read(opb,3)+1; /* 1 to 8 */</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     info-&gt;class_subs[j]=oggpack_read(opb,2); /* 0,1,2,3 bits */</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :     if(info-&gt;class_subs[j]&lt;0)</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :       goto err_out;</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :     if(info-&gt;class_subs[j])info-&gt;class_book[j]=oggpack_read(opb,8);</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :     if(info-&gt;class_book[j]&lt;0 || info-&gt;class_book[j]&gt;=ci-&gt;books)</span>
<span class="lineNum">     138 </span>            :       goto err_out;
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     for(k=0;k&lt;(1&lt;&lt;info-&gt;class_subs[j]);k++){</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :       info-&gt;class_subbook[j][k]=oggpack_read(opb,8)-1;</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :       if(info-&gt;class_subbook[j][k]&lt;-1 || info-&gt;class_subbook[j][k]&gt;=ci-&gt;books)</span>
<span class="lineNum">     142 </span>            :         goto err_out;
<span class="lineNum">     143 </span>            :     }
<span class="lineNum">     144 </span>            :   }
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            :   /* read the post list */
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :   info-&gt;mult=oggpack_read(opb,2)+1;     /* only 1,2,3,4 legal now */</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :   rangebits=oggpack_read(opb,4);</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :   if(rangebits&lt;0)goto err_out;</span>
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   for(j=0,k=0;j&lt;info-&gt;partitions;j++){</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :     count+=info-&gt;class_dim[info-&gt;partitionclass[j]];</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :     if(count&gt;VIF_POSIT) goto err_out;</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :     for(;k&lt;count;k++){</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :       int t=info-&gt;postlist[k+2]=oggpack_read(opb,rangebits);</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :       if(t&lt;0 || t&gt;=(1&lt;&lt;rangebits))</span>
<span class="lineNum">     157 </span>            :         goto err_out;
<span class="lineNum">     158 </span>            :     }
<span class="lineNum">     159 </span>            :   }
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   info-&gt;postlist[0]=0;</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   info-&gt;postlist[1]=1&lt;&lt;rangebits;</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :   /* don't allow repeated values in post list as they'd result in
<span class="lineNum">     164 </span>            :      zero-length segments */
<span class="lineNum">     165 </span>            :   {
<span class="lineNum">     166 </span>            :     int *sortpointer[VIF_POSIT+2];
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     for(j=0;j&lt;count+2;j++)sortpointer[j]=info-&gt;postlist+j;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     qsort(sortpointer,count+2,sizeof(*sortpointer),icomp);</span>
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     for(j=1;j&lt;count+2;j++)</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :       if(*sortpointer[j-1]==*sortpointer[j])goto err_out;</span>
<span class="lineNum">     172 </span>            :   }
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   return(info);</span>
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span>            :  err_out:
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :   floor1_free_info(info);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   return(NULL);</span>
<a name="179"><span class="lineNum">     179 </span>            : }</a>
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span><span class="lineNoCov">          0 : static vorbis_look_floor *floor1_look(vorbis_dsp_state *vd,</span>
<span class="lineNum">     182 </span>            :                                       vorbis_info_floor *in){
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            :   int *sortpointer[VIF_POSIT+2];
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   vorbis_info_floor1 *info=(vorbis_info_floor1 *)in;</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   vorbis_look_floor1 *look=_ogg_calloc(1,sizeof(*look));</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   int i,j,n=0;</span>
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span>            :   (void)vd;
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :   look-&gt;vi=info;</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :   look-&gt;n=info-&gt;postlist[1];</span>
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            :   /* we drop each position value in-between already decoded values,
<span class="lineNum">     195 </span>            :      and use linear interpolation to predict each new value past the
<span class="lineNum">     196 </span>            :      edges.  The positions are read in the order of the position
<span class="lineNum">     197 </span>            :      list... we precompute the bounding positions in the lookup.  Of
<span class="lineNum">     198 </span>            :      course, the neighbors can change (if a position is declined), but
<span class="lineNum">     199 </span>            :      this is an initial mapping */
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;info-&gt;partitions;i++)n+=info-&gt;class_dim[info-&gt;partitionclass[i]];</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :   n+=2;</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :   look-&gt;posts=n;</span>
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span>            :   /* also store a sorted position index */
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;n;i++)sortpointer[i]=info-&gt;postlist+i;</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   qsort(sortpointer,n,sizeof(*sortpointer),icomp);</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span>            :   /* points from sort order back to range number */
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;n;i++)look-&gt;forward_index[i]=sortpointer[i]-info-&gt;postlist;</span>
<span class="lineNum">     211 </span>            :   /* points from range order to sorted position */
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;n;i++)look-&gt;reverse_index[look-&gt;forward_index[i]]=i;</span>
<span class="lineNum">     213 </span>            :   /* we actually need the post values too */
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;n;i++)look-&gt;sorted_index[i]=info-&gt;postlist[look-&gt;forward_index[i]];</span>
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span>            :   /* quantize values to multiplier spec */
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :   switch(info-&gt;mult){</span>
<span class="lineNum">     218 </span>            :   case 1: /* 1024 -&gt; 256 */
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :     look-&gt;quant_q=256;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     221 </span>            :   case 2: /* 1024 -&gt; 128 */
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :     look-&gt;quant_q=128;</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     224 </span>            :   case 3: /* 1024 -&gt; 86 */
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :     look-&gt;quant_q=86;</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     227 </span>            :   case 4: /* 1024 -&gt; 64 */
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :     look-&gt;quant_q=64;</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     230 </span>            :   }
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span>            :   /* discover our neighbors for decode where we don't use fit flags
<span class="lineNum">     233 </span>            :      (that would push the neighbors outward) */
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;n-2;i++){</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :     int lo=0;</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     int hi=1;</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :     int lx=0;</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :     int hx=look-&gt;n;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :     int currentx=info-&gt;postlist[i+2];</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :     for(j=0;j&lt;i+2;j++){</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :       int x=info-&gt;postlist[j];</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :       if(x&gt;lx &amp;&amp; x&lt;currentx){</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :         lo=j;</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :         lx=x;</span>
<span class="lineNum">     245 </span>            :       }
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :       if(x&lt;hx &amp;&amp; x&gt;currentx){</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :         hi=j;</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :         hx=x;</span>
<span class="lineNum">     249 </span>            :       }
<span class="lineNum">     250 </span>            :     }
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :     look-&gt;loneighbor[i]=lo;</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     look-&gt;hineighbor[i]=hi;</span>
<span class="lineNum">     253 </span>            :   }
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :   return(look);</span>
<a name="256"><span class="lineNum">     256 </span>            : }</a>
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span><span class="lineNoCov">          0 : static int render_point(int x0,int x1,int y0,int y1,int x){</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :   y0&amp;=0x7fff; /* mask off flag */</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :   y1&amp;=0x7fff;</span>
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span>            :   {
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     int dy=y1-y0;</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     int adx=x1-x0;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     int ady=abs(dy);</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     int err=ady*(x-x0);</span>
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     int off=err/adx;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     if(dy&lt;0)return(y0-off);</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     return(y0+off);</span>
<span class="lineNum">     271 </span>            :   }
<a name="272"><span class="lineNum">     272 </span>            : }</a>
<span class="lineNum">     273 </span>            : 
<span class="lineNum">     274 </span><span class="lineNoCov">          0 : static int vorbis_dBquant(const float *x){</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   int i= *x*7.3142857f+1023.5f;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   if(i&gt;1023)return(1023);</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   if(i&lt;0)return(0);</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   return i;</span>
<span class="lineNum">     279 </span>            : }
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            : static const float FLOOR1_fromdB_LOOKUP[256]={
<span class="lineNum">     282 </span>            :   1.0649863e-07F, 1.1341951e-07F, 1.2079015e-07F, 1.2863978e-07F,
<span class="lineNum">     283 </span>            :   1.3699951e-07F, 1.4590251e-07F, 1.5538408e-07F, 1.6548181e-07F,
<span class="lineNum">     284 </span>            :   1.7623575e-07F, 1.8768855e-07F, 1.9988561e-07F, 2.128753e-07F,
<span class="lineNum">     285 </span>            :   2.2670913e-07F, 2.4144197e-07F, 2.5713223e-07F, 2.7384213e-07F,
<span class="lineNum">     286 </span>            :   2.9163793e-07F, 3.1059021e-07F, 3.3077411e-07F, 3.5226968e-07F,
<span class="lineNum">     287 </span>            :   3.7516214e-07F, 3.9954229e-07F, 4.2550680e-07F, 4.5315863e-07F,
<span class="lineNum">     288 </span>            :   4.8260743e-07F, 5.1396998e-07F, 5.4737065e-07F, 5.8294187e-07F,
<span class="lineNum">     289 </span>            :   6.2082472e-07F, 6.6116941e-07F, 7.0413592e-07F, 7.4989464e-07F,
<span class="lineNum">     290 </span>            :   7.9862701e-07F, 8.5052630e-07F, 9.0579828e-07F, 9.6466216e-07F,
<span class="lineNum">     291 </span>            :   1.0273513e-06F, 1.0941144e-06F, 1.1652161e-06F, 1.2409384e-06F,
<span class="lineNum">     292 </span>            :   1.3215816e-06F, 1.4074654e-06F, 1.4989305e-06F, 1.5963394e-06F,
<span class="lineNum">     293 </span>            :   1.7000785e-06F, 1.8105592e-06F, 1.9282195e-06F, 2.0535261e-06F,
<span class="lineNum">     294 </span>            :   2.1869758e-06F, 2.3290978e-06F, 2.4804557e-06F, 2.6416497e-06F,
<span class="lineNum">     295 </span>            :   2.8133190e-06F, 2.9961443e-06F, 3.1908506e-06F, 3.3982101e-06F,
<span class="lineNum">     296 </span>            :   3.6190449e-06F, 3.8542308e-06F, 4.1047004e-06F, 4.3714470e-06F,
<span class="lineNum">     297 </span>            :   4.6555282e-06F, 4.9580707e-06F, 5.2802740e-06F, 5.6234160e-06F,
<span class="lineNum">     298 </span>            :   5.9888572e-06F, 6.3780469e-06F, 6.7925283e-06F, 7.2339451e-06F,
<span class="lineNum">     299 </span>            :   7.7040476e-06F, 8.2047000e-06F, 8.7378876e-06F, 9.3057248e-06F,
<span class="lineNum">     300 </span>            :   9.9104632e-06F, 1.0554501e-05F, 1.1240392e-05F, 1.1970856e-05F,
<span class="lineNum">     301 </span>            :   1.2748789e-05F, 1.3577278e-05F, 1.4459606e-05F, 1.5399272e-05F,
<span class="lineNum">     302 </span>            :   1.6400004e-05F, 1.7465768e-05F, 1.8600792e-05F, 1.9809576e-05F,
<span class="lineNum">     303 </span>            :   2.1096914e-05F, 2.2467911e-05F, 2.3928002e-05F, 2.5482978e-05F,
<span class="lineNum">     304 </span>            :   2.7139006e-05F, 2.8902651e-05F, 3.0780908e-05F, 3.2781225e-05F,
<span class="lineNum">     305 </span>            :   3.4911534e-05F, 3.7180282e-05F, 3.9596466e-05F, 4.2169667e-05F,
<span class="lineNum">     306 </span>            :   4.4910090e-05F, 4.7828601e-05F, 5.0936773e-05F, 5.4246931e-05F,
<span class="lineNum">     307 </span>            :   5.7772202e-05F, 6.1526565e-05F, 6.5524908e-05F, 6.9783085e-05F,
<span class="lineNum">     308 </span>            :   7.4317983e-05F, 7.9147585e-05F, 8.4291040e-05F, 8.9768747e-05F,
<span class="lineNum">     309 </span>            :   9.5602426e-05F, 0.00010181521F, 0.00010843174F, 0.00011547824F,
<span class="lineNum">     310 </span>            :   0.00012298267F, 0.00013097477F, 0.00013948625F, 0.00014855085F,
<span class="lineNum">     311 </span>            :   0.00015820453F, 0.00016848555F, 0.00017943469F, 0.00019109536F,
<span class="lineNum">     312 </span>            :   0.00020351382F, 0.00021673929F, 0.00023082423F, 0.00024582449F,
<span class="lineNum">     313 </span>            :   0.00026179955F, 0.00027881276F, 0.00029693158F, 0.00031622787F,
<span class="lineNum">     314 </span>            :   0.00033677814F, 0.00035866388F, 0.00038197188F, 0.00040679456F,
<span class="lineNum">     315 </span>            :   0.00043323036F, 0.00046138411F, 0.00049136745F, 0.00052329927F,
<span class="lineNum">     316 </span>            :   0.00055730621F, 0.00059352311F, 0.00063209358F, 0.00067317058F,
<span class="lineNum">     317 </span>            :   0.00071691700F, 0.00076350630F, 0.00081312324F, 0.00086596457F,
<span class="lineNum">     318 </span>            :   0.00092223983F, 0.00098217216F, 0.0010459992F, 0.0011139742F,
<span class="lineNum">     319 </span>            :   0.0011863665F, 0.0012634633F, 0.0013455702F, 0.0014330129F,
<span class="lineNum">     320 </span>            :   0.0015261382F, 0.0016253153F, 0.0017309374F, 0.0018434235F,
<span class="lineNum">     321 </span>            :   0.0019632195F, 0.0020908006F, 0.0022266726F, 0.0023713743F,
<span class="lineNum">     322 </span>            :   0.0025254795F, 0.0026895994F, 0.0028643847F, 0.0030505286F,
<span class="lineNum">     323 </span>            :   0.0032487691F, 0.0034598925F, 0.0036847358F, 0.0039241906F,
<span class="lineNum">     324 </span>            :   0.0041792066F, 0.0044507950F, 0.0047400328F, 0.0050480668F,
<span class="lineNum">     325 </span>            :   0.0053761186F, 0.0057254891F, 0.0060975636F, 0.0064938176F,
<span class="lineNum">     326 </span>            :   0.0069158225F, 0.0073652516F, 0.0078438871F, 0.0083536271F,
<span class="lineNum">     327 </span>            :   0.0088964928F, 0.009474637F, 0.010090352F, 0.010746080F,
<span class="lineNum">     328 </span>            :   0.011444421F, 0.012188144F, 0.012980198F, 0.013823725F,
<span class="lineNum">     329 </span>            :   0.014722068F, 0.015678791F, 0.016697687F, 0.017782797F,
<span class="lineNum">     330 </span>            :   0.018938423F, 0.020169149F, 0.021479854F, 0.022875735F,
<span class="lineNum">     331 </span>            :   0.024362330F, 0.025945531F, 0.027631618F, 0.029427276F,
<span class="lineNum">     332 </span>            :   0.031339626F, 0.033376252F, 0.035545228F, 0.037855157F,
<span class="lineNum">     333 </span>            :   0.040315199F, 0.042935108F, 0.045725273F, 0.048696758F,
<span class="lineNum">     334 </span>            :   0.051861348F, 0.055231591F, 0.058820850F, 0.062643361F,
<span class="lineNum">     335 </span>            :   0.066714279F, 0.071049749F, 0.075666962F, 0.080584227F,
<span class="lineNum">     336 </span>            :   0.085821044F, 0.091398179F, 0.097337747F, 0.10366330F,
<span class="lineNum">     337 </span>            :   0.11039993F, 0.11757434F, 0.12521498F, 0.13335215F,
<span class="lineNum">     338 </span>            :   0.14201813F, 0.15124727F, 0.16107617F, 0.17154380F,
<span class="lineNum">     339 </span>            :   0.18269168F, 0.19456402F, 0.20720788F, 0.22067342F,
<span class="lineNum">     340 </span>            :   0.23501402F, 0.25028656F, 0.26655159F, 0.28387361F,
<span class="lineNum">     341 </span>            :   0.30232132F, 0.32196786F, 0.34289114F, 0.36517414F,
<span class="lineNum">     342 </span>            :   0.38890521F, 0.41417847F, 0.44109412F, 0.46975890F,
<span class="lineNum">     343 </span>            :   0.50028648F, 0.53279791F, 0.56742212F, 0.60429640F,
<span class="lineNum">     344 </span>            :   0.64356699F, 0.68538959F, 0.72993007F, 0.77736504F,
<span class="lineNum">     345 </span>            :   0.82788260F, 0.88168307F, 0.9389798F, 1.F,
<a name="346"><span class="lineNum">     346 </span>            : };</a>
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span><span class="lineNoCov">          0 : static void render_line(int n, int x0,int x1,int y0,int y1,float *d){</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :   int dy=y1-y0;</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :   int adx=x1-x0;</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :   int ady=abs(dy);</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :   int base=dy/adx;</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :   int sy=(dy&lt;0?base-1:base+1);</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :   int x=x0;</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :   int y=y0;</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   int err=0;</span>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   ady-=abs(base*adx);</span>
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   if(n&gt;x1)n=x1;</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :   if(x&lt;n)</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :     d[x]*=FLOOR1_fromdB_LOOKUP[y];</span>
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :   while(++x&lt;n){</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :     err=err+ady;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     if(err&gt;=adx){</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :       err-=adx;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :       y+=sy;</span>
<span class="lineNum">     370 </span>            :     }else{
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :       y+=base;</span>
<span class="lineNum">     372 </span>            :     }
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :     d[x]*=FLOOR1_fromdB_LOOKUP[y];</span>
<span class="lineNum">     374 </span>            :   }
<a name="375"><span class="lineNum">     375 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span><span class="lineNoCov">          0 : static void render_line0(int n, int x0,int x1,int y0,int y1,int *d){</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   int dy=y1-y0;</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :   int adx=x1-x0;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :   int ady=abs(dy);</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :   int base=dy/adx;</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :   int sy=(dy&lt;0?base-1:base+1);</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :   int x=x0;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :   int y=y0;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :   int err=0;</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   ady-=abs(base*adx);</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :   if(n&gt;x1)n=x1;</span>
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :   if(x&lt;n)</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     d[x]=y;</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :   while(++x&lt;n){</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     err=err+ady;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :     if(err&gt;=adx){</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :       err-=adx;</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :       y+=sy;</span>
<span class="lineNum">     399 </span>            :     }else{
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :       y+=base;</span>
<span class="lineNum">     401 </span>            :     }
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     d[x]=y;</span>
<span class="lineNum">     403 </span>            :   }
<span class="lineNum">     404 </span><span class="lineNoCov">          0 : }</span>
<a name="405"><span class="lineNum">     405 </span>            : </a>
<span class="lineNum">     406 </span>            : /* the floor has already been filtered to only include relevant sections */
<span class="lineNum">     407 </span><span class="lineNoCov">          0 : static int accumulate_fit(const float *flr,const float *mdct,</span>
<span class="lineNum">     408 </span>            :                           int x0, int x1,lsfit_acc *a,
<span class="lineNum">     409 </span>            :                           int n,vorbis_info_floor1 *info){
<span class="lineNum">     410 </span>            :   long i;
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   int xa=0,ya=0,x2a=0,y2a=0,xya=0,na=0, xb=0,yb=0,x2b=0,y2b=0,xyb=0,nb=0;</span>
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :   memset(a,0,sizeof(*a));</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :   a-&gt;x0=x0;</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :   a-&gt;x1=x1;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :   if(x1&gt;=n)x1=n-1;</span>
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :   for(i=x0;i&lt;=x1;i++){</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     int quantized=vorbis_dBquant(flr+i);</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     if(quantized){</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :       if(mdct[i]+info-&gt;twofitatten&gt;=flr[i]){</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         xa  += i;</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :         ya  += quantized;</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :         x2a += i*i;</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :         y2a += quantized*quantized;</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :         xya += i*quantized;</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :         na++;</span>
<span class="lineNum">     429 </span>            :       }else{
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :         xb  += i;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :         yb  += quantized;</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :         x2b += i*i;</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :         y2b += quantized*quantized;</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :         xyb += i*quantized;</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :         nb++;</span>
<span class="lineNum">     436 </span>            :       }
<span class="lineNum">     437 </span>            :     }
<span class="lineNum">     438 </span>            :   }
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :   a-&gt;xa=xa;</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :   a-&gt;ya=ya;</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :   a-&gt;x2a=x2a;</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :   a-&gt;y2a=y2a;</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :   a-&gt;xya=xya;</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :   a-&gt;an=na;</span>
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :   a-&gt;xb=xb;</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :   a-&gt;yb=yb;</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :   a-&gt;x2b=x2b;</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   a-&gt;y2b=y2b;</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :   a-&gt;xyb=xyb;</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   a-&gt;bn=nb;</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   return(na);</span>
<a name="455"><span class="lineNum">     455 </span>            : }</a>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineNoCov">          0 : static int fit_line(lsfit_acc *a,int fits,int *y0,int *y1,</span>
<span class="lineNum">     458 </span>            :                     vorbis_info_floor1 *info){
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :   double xb=0,yb=0,x2b=0,y2b=0,xyb=0,bn=0;</span>
<span class="lineNum">     460 </span>            :   int i;
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :   int x0=a[0].x0;</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :   int x1=a[fits-1].x1;</span>
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;fits;i++){</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :     double weight = (a[i].bn+a[i].an)*info-&gt;twofitweight/(a[i].an+1)+1.;</span>
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     xb+=a[i].xb + a[i].xa * weight;</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     yb+=a[i].yb + a[i].ya * weight;</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :     x2b+=a[i].x2b + a[i].x2a * weight;</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     y2b+=a[i].y2b + a[i].y2a * weight;</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :     xyb+=a[i].xyb + a[i].xya * weight;</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     bn+=a[i].bn + a[i].an * weight;</span>
<span class="lineNum">     473 </span>            :   }
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :   if(*y0&gt;=0){</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     xb+=   x0;</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     yb+=  *y0;</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     x2b+=  x0 *  x0;</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     y2b+= *y0 * *y0;</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :     xyb+= *y0 *  x0;</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     bn++;</span>
<span class="lineNum">     482 </span>            :   }
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :   if(*y1&gt;=0){</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     xb+=   x1;</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :     yb+=  *y1;</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     x2b+=  x1 *  x1;</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     y2b+= *y1 * *y1;</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :     xyb+= *y1 *  x1;</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :     bn++;</span>
<span class="lineNum">     491 </span>            :   }
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span>            :   {
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :     double denom=(bn*x2b-xb*xb);</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     if(denom&gt;0.){</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :       double a=(yb*x2b-xyb*xb)/denom;</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :       double b=(bn*xyb-xb*yb)/denom;</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :       *y0=rint(a+b*x0);</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :       *y1=rint(a+b*x1);</span>
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            :       /* limit to our range! */
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :       if(*y0&gt;1023)*y0=1023;</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :       if(*y1&gt;1023)*y1=1023;</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :       if(*y0&lt;0)*y0=0;</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :       if(*y1&lt;0)*y1=0;</span>
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">     509 </span>            :     }else{
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :       *y0=0;</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :       *y1=0;</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :       return 1;</span>
<span class="lineNum">     513 </span>            :     }
<span class="lineNum">     514 </span>            :   }
<a name="515"><span class="lineNum">     515 </span>            : }</a>
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span><span class="lineNoCov">          0 : static int inspect_error(int x0,int x1,int y0,int y1,const float *mask,</span>
<span class="lineNum">     518 </span>            :                          const float *mdct,
<span class="lineNum">     519 </span>            :                          vorbis_info_floor1 *info){
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :   int dy=y1-y0;</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :   int adx=x1-x0;</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :   int ady=abs(dy);</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :   int base=dy/adx;</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :   int sy=(dy&lt;0?base-1:base+1);</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :   int x=x0;</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :   int y=y0;</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :   int err=0;</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :   int val=vorbis_dBquant(mask+x);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :   int mse=0;</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :   int n=0;</span>
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :   ady-=abs(base*adx);</span>
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :   mse=(y-val);</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :   mse*=mse;</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :   n++;</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :   if(mdct[x]+info-&gt;twofitatten&gt;=mask[x]){</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :     if(y+info-&gt;maxover&lt;val)return(1);</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :     if(y-info-&gt;maxunder&gt;val)return(1);</span>
<span class="lineNum">     540 </span>            :   }
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :   while(++x&lt;x1){</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     err=err+ady;</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :     if(err&gt;=adx){</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :       err-=adx;</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :       y+=sy;</span>
<span class="lineNum">     547 </span>            :     }else{
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :       y+=base;</span>
<span class="lineNum">     549 </span>            :     }
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     val=vorbis_dBquant(mask+x);</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     mse+=((y-val)*(y-val));</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :     n++;</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :     if(mdct[x]+info-&gt;twofitatten&gt;=mask[x]){</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :       if(val){</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :         if(y+info-&gt;maxover&lt;val)return(1);</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :         if(y-info-&gt;maxunder&gt;val)return(1);</span>
<span class="lineNum">     558 </span>            :       }
<span class="lineNum">     559 </span>            :     }
<span class="lineNum">     560 </span>            :   }
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :   if(info-&gt;maxover*info-&gt;maxover/n&gt;info-&gt;maxerr)return(0);</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :   if(info-&gt;maxunder*info-&gt;maxunder/n&gt;info-&gt;maxerr)return(0);</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :   if(mse/n&gt;info-&gt;maxerr)return(1);</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :   return(0);</span>
<a name="566"><span class="lineNum">     566 </span>            : }</a>
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineNoCov">          0 : static int post_Y(int *A,int *B,int pos){</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :   if(A[pos]&lt;0)</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :     return B[pos];</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :   if(B[pos]&lt;0)</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :     return A[pos];</span>
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :   return (A[pos]+B[pos])&gt;&gt;1;</span>
<a name="575"><span class="lineNum">     575 </span>            : }</a>
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span><span class="lineNoCov">          0 : int *floor1_fit(vorbis_block *vb,vorbis_look_floor1 *look,</span>
<span class="lineNum">     578 </span>            :                           const float *logmdct,   /* in */
<span class="lineNum">     579 </span>            :                           const float *logmask){
<span class="lineNum">     580 </span>            :   long i,j;
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :   vorbis_info_floor1 *info=look-&gt;vi;</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :   long n=look-&gt;n;</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :   long posts=look-&gt;posts;</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :   long nonzero=0;</span>
<span class="lineNum">     585 </span>            :   lsfit_acc fits[VIF_POSIT+1];
<span class="lineNum">     586 </span>            :   int fit_valueA[VIF_POSIT+2]; /* index by range list position */
<span class="lineNum">     587 </span>            :   int fit_valueB[VIF_POSIT+2]; /* index by range list position */
<span class="lineNum">     588 </span>            : 
<span class="lineNum">     589 </span>            :   int loneighbor[VIF_POSIT+2]; /* sorted index of range list position (+2) */
<span class="lineNum">     590 </span>            :   int hineighbor[VIF_POSIT+2];
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :   int *output=NULL;</span>
<span class="lineNum">     592 </span>            :   int memo[VIF_POSIT+2];
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;posts;i++)fit_valueA[i]=-200; /* mark all unused */</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;posts;i++)fit_valueB[i]=-200; /* mark all unused */</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;posts;i++)loneighbor[i]=0; /* 0 for the implicit 0 post */</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;posts;i++)hineighbor[i]=1; /* 1 for the implicit post at n */</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;posts;i++)memo[i]=-1;      /* no neighbor yet */</span>
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span>            :   /* quantize the relevant floor points and collect them into line fit
<span class="lineNum">     601 </span>            :      structures (one per minimal division) at the same time */
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :   if(posts==0){</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :     nonzero+=accumulate_fit(logmask,logmdct,0,n,fits,n,info);</span>
<span class="lineNum">     604 </span>            :   }else{
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;posts-1;i++)</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :       nonzero+=accumulate_fit(logmask,logmdct,look-&gt;sorted_index[i],</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :                               look-&gt;sorted_index[i+1],fits+i,</span>
<span class="lineNum">     608 </span>            :                               n,info);
<span class="lineNum">     609 </span>            :   }
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :   if(nonzero){</span>
<span class="lineNum">     612 </span>            :     /* start by fitting the implicit base case.... */
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :     int y0=-200;</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :     int y1=-200;</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :     fit_line(fits,posts-1,&amp;y0,&amp;y1,info);</span>
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :     fit_valueA[0]=y0;</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     fit_valueB[0]=y0;</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     fit_valueB[1]=y1;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :     fit_valueA[1]=y1;</span>
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span>            :     /* Non degenerate case */
<span class="lineNum">     623 </span>            :     /* start progressive splitting.  This is a greedy, non-optimal
<span class="lineNum">     624 </span>            :        algorithm, but simple and close enough to the best
<span class="lineNum">     625 </span>            :        answer. */
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :     for(i=2;i&lt;posts;i++){</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :       int sortpos=look-&gt;reverse_index[i];</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :       int ln=loneighbor[sortpos];</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :       int hn=hineighbor[sortpos];</span>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span>            :       /* eliminate repeat searches of a particular range with a memo */
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :       if(memo[ln]!=hn){</span>
<span class="lineNum">     633 </span>            :         /* haven't performed this error search yet */
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         int lsortpos=look-&gt;reverse_index[ln];</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :         int hsortpos=look-&gt;reverse_index[hn];</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :         memo[ln]=hn;</span>
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span>            :         {
<span class="lineNum">     639 </span>            :           /* A note: we want to bound/minimize *local*, not global, error */
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :           int lx=info-&gt;postlist[ln];</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :           int hx=info-&gt;postlist[hn];</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :           int ly=post_Y(fit_valueA,fit_valueB,ln);</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :           int hy=post_Y(fit_valueA,fit_valueB,hn);</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :           if(ly==-1 || hy==-1){</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :             exit(1);</span>
<span class="lineNum">     647 </span>            :           }
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :           if(inspect_error(lx,hx,ly,hy,logmask,logmdct,info)){</span>
<span class="lineNum">     650 </span>            :             /* outside error bounds/begin search area.  Split it. */
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :             int ly0=-200;</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :             int ly1=-200;</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :             int hy0=-200;</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :             int hy1=-200;</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :             int ret0=fit_line(fits+lsortpos,sortpos-lsortpos,&amp;ly0,&amp;ly1,info);</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :             int ret1=fit_line(fits+sortpos,hsortpos-sortpos,&amp;hy0,&amp;hy1,info);</span>
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :             if(ret0){</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :               ly0=ly;</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :               ly1=hy0;</span>
<span class="lineNum">     661 </span>            :             }
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :             if(ret1){</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :               hy0=ly1;</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :               hy1=hy;</span>
<span class="lineNum">     665 </span>            :             }
<span class="lineNum">     666 </span>            : 
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :             if(ret0 &amp;&amp; ret1){</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :               fit_valueA[i]=-200;</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :               fit_valueB[i]=-200;</span>
<span class="lineNum">     670 </span>            :             }else{
<span class="lineNum">     671 </span>            :               /* store new edge values */
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :               fit_valueB[ln]=ly0;</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :               if(ln==0)fit_valueA[ln]=ly0;</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :               fit_valueA[i]=ly1;</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :               fit_valueB[i]=hy0;</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :               fit_valueA[hn]=hy1;</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :               if(hn==1)fit_valueB[hn]=hy1;</span>
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :               if(ly1&gt;=0 || hy0&gt;=0){</span>
<span class="lineNum">     680 </span>            :                 /* store new neighbor values */
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :                 for(j=sortpos-1;j&gt;=0;j--)</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :                   if(hineighbor[j]==hn)</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                     hineighbor[j]=i;</span>
<span class="lineNum">     684 </span>            :                   else
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                 for(j=sortpos+1;j&lt;posts;j++)</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                   if(loneighbor[j]==ln)</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :                     loneighbor[j]=i;</span>
<span class="lineNum">     689 </span>            :                   else
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">     691 </span>            :               }
<span class="lineNum">     692 </span>            :             }
<span class="lineNum">     693 </span>            :           }else{
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :             fit_valueA[i]=-200;</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :             fit_valueB[i]=-200;</span>
<span class="lineNum">     696 </span>            :           }
<span class="lineNum">     697 </span>            :         }
<span class="lineNum">     698 </span>            :       }
<span class="lineNum">     699 </span>            :     }
<span class="lineNum">     700 </span>            : 
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :     output=_vorbis_block_alloc(vb,sizeof(*output)*posts);</span>
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :     output[0]=post_Y(fit_valueA,fit_valueB,0);</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     output[1]=post_Y(fit_valueA,fit_valueB,1);</span>
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span>            :     /* fill in posts marked as not using a fit; we will zero
<span class="lineNum">     707 </span>            :        back out to 'unused' when encoding them so long as curve
<span class="lineNum">     708 </span>            :        interpolation doesn't force them into use */
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :     for(i=2;i&lt;posts;i++){</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :       int ln=look-&gt;loneighbor[i-2];</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :       int hn=look-&gt;hineighbor[i-2];</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :       int x0=info-&gt;postlist[ln];</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :       int x1=info-&gt;postlist[hn];</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :       int y0=output[ln];</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :       int y1=output[hn];</span>
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :       int predicted=render_point(x0,x1,y0,y1,info-&gt;postlist[i]);</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :       int vx=post_Y(fit_valueA,fit_valueB,i);</span>
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :       if(vx&gt;=0 &amp;&amp; predicted!=vx){</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         output[i]=vx;</span>
<span class="lineNum">     722 </span>            :       }else{
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :         output[i]= predicted|0x8000;</span>
<span class="lineNum">     724 </span>            :       }
<span class="lineNum">     725 </span>            :     }
<span class="lineNum">     726 </span>            :   }
<span class="lineNum">     727 </span>            : 
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :   return(output);</span>
<span class="lineNum">     729 </span>            : 
<a name="730"><span class="lineNum">     730 </span>            : }</a>
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineNoCov">          0 : int *floor1_interpolate_fit(vorbis_block *vb,vorbis_look_floor1 *look,</span>
<span class="lineNum">     733 </span>            :                           int *A,int *B,
<span class="lineNum">     734 </span>            :                           int del){
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span>            :   long i;
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :   long posts=look-&gt;posts;</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :   int *output=NULL;</span>
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :   if(A &amp;&amp; B){</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     output=_vorbis_block_alloc(vb,sizeof(*output)*posts);</span>
<span class="lineNum">     742 </span>            : 
<span class="lineNum">     743 </span>            :     /* overly simpleminded--- look again post 1.2 */
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;posts;i++){</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :       output[i]=((65536-del)*(A[i]&amp;0x7fff)+del*(B[i]&amp;0x7fff)+32768)&gt;&gt;16;</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :       if(A[i]&amp;0x8000 &amp;&amp; B[i]&amp;0x8000)output[i]|=0x8000;</span>
<span class="lineNum">     747 </span>            :     }
<span class="lineNum">     748 </span>            :   }
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :   return(output);</span>
<span class="lineNum">     751 </span>            : }
<a name="752"><span class="lineNum">     752 </span>            : </a>
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span><span class="lineNoCov">          0 : int floor1_encode(oggpack_buffer *opb,vorbis_block *vb,</span>
<span class="lineNum">     755 </span>            :                   vorbis_look_floor1 *look,
<span class="lineNum">     756 </span>            :                   int *post,int *ilogmask){
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span>            :   long i,j;
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :   vorbis_info_floor1 *info=look-&gt;vi;</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :   long posts=look-&gt;posts;</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :   codec_setup_info *ci=vb-&gt;vd-&gt;vi-&gt;codec_setup;</span>
<span class="lineNum">     762 </span>            :   int out[VIF_POSIT+2];
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :   static_codebook **sbooks=ci-&gt;book_param;</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :   codebook *books=ci-&gt;fullbooks;</span>
<span class="lineNum">     765 </span>            : 
<span class="lineNum">     766 </span>            :   /* quantize values to multiplier spec */
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :   if(post){</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;posts;i++){</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :       int val=post[i]&amp;0x7fff;</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :       switch(info-&gt;mult){</span>
<span class="lineNum">     771 </span>            :       case 1: /* 1024 -&gt; 256 */
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :         val&gt;&gt;=2;</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     774 </span>            :       case 2: /* 1024 -&gt; 128 */
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :         val&gt;&gt;=3;</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     777 </span>            :       case 3: /* 1024 -&gt; 86 */
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :         val/=12;</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     780 </span>            :       case 4: /* 1024 -&gt; 64 */
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :         val&gt;&gt;=4;</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     783 </span>            :       }
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :       post[i]=val | (post[i]&amp;0x8000);</span>
<span class="lineNum">     785 </span>            :     }
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :     out[0]=post[0];</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :     out[1]=post[1];</span>
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span>            :     /* find prediction values for each post and subtract them */
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :     for(i=2;i&lt;posts;i++){</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :       int ln=look-&gt;loneighbor[i-2];</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :       int hn=look-&gt;hineighbor[i-2];</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :       int x0=info-&gt;postlist[ln];</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :       int x1=info-&gt;postlist[hn];</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :       int y0=post[ln];</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :       int y1=post[hn];</span>
<span class="lineNum">     798 </span>            : 
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :       int predicted=render_point(x0,x1,y0,y1,info-&gt;postlist[i]);</span>
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :       if((post[i]&amp;0x8000) || (predicted==post[i])){</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :         post[i]=predicted|0x8000; /* in case there was roundoff jitter</span>
<span class="lineNum">     803 </span>            :                                      in interpolation */
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :         out[i]=0;</span>
<span class="lineNum">     805 </span>            :       }else{
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :         int headroom=(look-&gt;quant_q-predicted&lt;predicted?</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :                       look-&gt;quant_q-predicted:predicted);</span>
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :         int val=post[i]-predicted;</span>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span>            :         /* at this point the 'deviation' value is in the range +/- max
<span class="lineNum">     812 </span>            :            range, but the real, unique range can always be mapped to
<span class="lineNum">     813 </span>            :            only [0-maxrange).  So we want to wrap the deviation into
<span class="lineNum">     814 </span>            :            this limited range, but do it in the way that least screws
<span class="lineNum">     815 </span>            :            an essentially gaussian probability distribution. */
<span class="lineNum">     816 </span>            : 
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :         if(val&lt;0)</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :           if(val&lt;-headroom)</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :             val=headroom-val-1;</span>
<span class="lineNum">     820 </span>            :           else
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :             val=-1-(val&lt;&lt;1);</span>
<span class="lineNum">     822 </span>            :         else
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :           if(val&gt;=headroom)</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :             val= val+headroom;</span>
<span class="lineNum">     825 </span>            :           else
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :             val&lt;&lt;=1;</span>
<span class="lineNum">     827 </span>            : 
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :         out[i]=val;</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :         post[ln]&amp;=0x7fff;</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :         post[hn]&amp;=0x7fff;</span>
<span class="lineNum">     831 </span>            :       }
<span class="lineNum">     832 </span>            :     }
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span>            :     /* we have everything we need. pack it out */
<span class="lineNum">     835 </span>            :     /* mark nontrivial floor */
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :     oggpack_write(opb,1,1);</span>
<span class="lineNum">     837 </span>            : 
<span class="lineNum">     838 </span>            :     /* beginning/end post */
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :     look-&gt;frames++;</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :     look-&gt;postbits+=ov_ilog(look-&gt;quant_q-1)*2;</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :     oggpack_write(opb,out[0],ov_ilog(look-&gt;quant_q-1));</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :     oggpack_write(opb,out[1],ov_ilog(look-&gt;quant_q-1));</span>
<span class="lineNum">     843 </span>            : 
<span class="lineNum">     844 </span>            : 
<span class="lineNum">     845 </span>            :     /* partition by partition */
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :     for(i=0,j=2;i&lt;info-&gt;partitions;i++){</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :       int class=info-&gt;partitionclass[i];</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :       int cdim=info-&gt;class_dim[class];</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :       int csubbits=info-&gt;class_subs[class];</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :       int csub=1&lt;&lt;csubbits;</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :       int bookas[8]={0,0,0,0,0,0,0,0};</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :       int cval=0;</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :       int cshift=0;</span>
<span class="lineNum">     854 </span>            :       int k,l;
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span>            :       /* generate the partition's first stage cascade value */
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :       if(csubbits){</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :         int maxval[8]={0,0,0,0,0,0,0,0}; /* gcc's static analysis</span>
<span class="lineNum">     859 </span>            :                                             issues a warning without
<span class="lineNum">     860 </span>            :                                             initialization */
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :         for(k=0;k&lt;csub;k++){</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :           int booknum=info-&gt;class_subbook[class][k];</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :           if(booknum&lt;0){</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :             maxval[k]=1;</span>
<span class="lineNum">     865 </span>            :           }else{
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :             maxval[k]=sbooks[info-&gt;class_subbook[class][k]]-&gt;entries;</span>
<span class="lineNum">     867 </span>            :           }
<span class="lineNum">     868 </span>            :         }
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :         for(k=0;k&lt;cdim;k++){</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :           for(l=0;l&lt;csub;l++){</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :             int val=out[j+k];</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :             if(val&lt;maxval[l]){</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :               bookas[k]=l;</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :               break;</span>
<span class="lineNum">     875 </span>            :             }
<span class="lineNum">     876 </span>            :           }
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :           cval|= bookas[k]&lt;&lt;cshift;</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :           cshift+=csubbits;</span>
<span class="lineNum">     879 </span>            :         }
<span class="lineNum">     880 </span>            :         /* write it */
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :         look-&gt;phrasebits+=</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :           vorbis_book_encode(books+info-&gt;class_book[class],cval,opb);</span>
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span>            : #ifdef TRAIN_FLOOR1
<span class="lineNum">     885 </span>            :         {
<span class="lineNum">     886 </span>            :           FILE *of;
<span class="lineNum">     887 </span>            :           char buffer[80];
<span class="lineNum">     888 </span>            :           sprintf(buffer,&quot;line_%dx%ld_class%d.vqd&quot;,
<span class="lineNum">     889 </span>            :                   vb-&gt;pcmend/2,posts-2,class);
<span class="lineNum">     890 </span>            :           of=fopen(buffer,&quot;a&quot;);
<span class="lineNum">     891 </span>            :           fprintf(of,&quot;%d\n&quot;,cval);
<span class="lineNum">     892 </span>            :           fclose(of);
<span class="lineNum">     893 </span>            :         }
<span class="lineNum">     894 </span>            : #endif
<span class="lineNum">     895 </span>            :       }
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span>            :       /* write post values */
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :       for(k=0;k&lt;cdim;k++){</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :         int book=info-&gt;class_subbook[class][bookas[k]];</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :         if(book&gt;=0){</span>
<span class="lineNum">     901 </span>            :           /* hack to allow training with 'bad' books */
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :           if(out[j+k]&lt;(books+book)-&gt;entries)</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :             look-&gt;postbits+=vorbis_book_encode(books+book,</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :                                                out[j+k],opb);</span>
<span class="lineNum">     905 </span>            :           /*else
<span class="lineNum">     906 </span>            :             fprintf(stderr,&quot;+!&quot;);*/
<span class="lineNum">     907 </span>            : 
<span class="lineNum">     908 </span>            : #ifdef TRAIN_FLOOR1
<span class="lineNum">     909 </span>            :           {
<span class="lineNum">     910 </span>            :             FILE *of;
<span class="lineNum">     911 </span>            :             char buffer[80];
<span class="lineNum">     912 </span>            :             sprintf(buffer,&quot;line_%dx%ld_%dsub%d.vqd&quot;,
<span class="lineNum">     913 </span>            :                     vb-&gt;pcmend/2,posts-2,class,bookas[k]);
<span class="lineNum">     914 </span>            :             of=fopen(buffer,&quot;a&quot;);
<span class="lineNum">     915 </span>            :             fprintf(of,&quot;%d\n&quot;,out[j+k]);
<span class="lineNum">     916 </span>            :             fclose(of);
<span class="lineNum">     917 </span>            :           }
<span class="lineNum">     918 </span>            : #endif
<span class="lineNum">     919 </span>            :         }
<span class="lineNum">     920 </span>            :       }
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :       j+=cdim;</span>
<span class="lineNum">     922 </span>            :     }
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span>            :     {
<span class="lineNum">     925 </span>            :       /* generate quantized floor equivalent to what we'd unpack in decode */
<span class="lineNum">     926 </span>            :       /* render the lines */
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :       int hx=0;</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :       int lx=0;</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :       int ly=post[0]*info-&gt;mult;</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :       int n=ci-&gt;blocksizes[vb-&gt;W]/2;</span>
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :       for(j=1;j&lt;look-&gt;posts;j++){</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :         int current=look-&gt;forward_index[j];</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :         int hy=post[current]&amp;0x7fff;</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :         if(hy==post[current]){</span>
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :           hy*=info-&gt;mult;</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :           hx=info-&gt;postlist[current];</span>
<span class="lineNum">     939 </span>            : 
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :           render_line0(n,lx,hx,ly,hy,ilogmask);</span>
<span class="lineNum">     941 </span>            : 
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :           lx=hx;</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :           ly=hy;</span>
<span class="lineNum">     944 </span>            :         }
<span class="lineNum">     945 </span>            :       }
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :       for(j=hx;j&lt;vb-&gt;pcmend/2;j++)ilogmask[j]=ly; /* be certain */</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :       return(1);</span>
<span class="lineNum">     948 </span>            :     }
<span class="lineNum">     949 </span>            :   }else{
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :     oggpack_write(opb,0,1);</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :     memset(ilogmask,0,vb-&gt;pcmend/2*sizeof(*ilogmask));</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :     return(0);</span>
<span class="lineNum">     953 </span>            :   }
<a name="954"><span class="lineNum">     954 </span>            : }</a>
<span class="lineNum">     955 </span>            : 
<span class="lineNum">     956 </span><span class="lineNoCov">          0 : static void *floor1_inverse1(vorbis_block *vb,vorbis_look_floor *in){</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   vorbis_look_floor1 *look=(vorbis_look_floor1 *)in;</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   vorbis_info_floor1 *info=look-&gt;vi;</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :   codec_setup_info   *ci=vb-&gt;vd-&gt;vi-&gt;codec_setup;</span>
<span class="lineNum">     960 </span>            : 
<span class="lineNum">     961 </span>            :   int i,j,k;
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :   codebook *books=ci-&gt;fullbooks;</span>
<span class="lineNum">     963 </span>            : 
<span class="lineNum">     964 </span>            :   /* unpack wrapped/predicted values from stream */
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :   if(oggpack_read(&amp;vb-&gt;opb,1)==1){</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :     int *fit_value=_vorbis_block_alloc(vb,(look-&gt;posts)*sizeof(*fit_value));</span>
<span class="lineNum">     967 </span>            : 
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :     fit_value[0]=oggpack_read(&amp;vb-&gt;opb,ov_ilog(look-&gt;quant_q-1));</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :     fit_value[1]=oggpack_read(&amp;vb-&gt;opb,ov_ilog(look-&gt;quant_q-1));</span>
<span class="lineNum">     970 </span>            : 
<span class="lineNum">     971 </span>            :     /* partition by partition */
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :     for(i=0,j=2;i&lt;info-&gt;partitions;i++){</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :       int class=info-&gt;partitionclass[i];</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :       int cdim=info-&gt;class_dim[class];</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :       int csubbits=info-&gt;class_subs[class];</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :       int csub=1&lt;&lt;csubbits;</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :       int cval=0;</span>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span>            :       /* decode the partition's first stage cascade value */
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :       if(csubbits){</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :         cval=vorbis_book_decode(books+info-&gt;class_book[class],&amp;vb-&gt;opb);</span>
<span class="lineNum">     982 </span>            : 
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :         if(cval==-1)goto eop;</span>
<span class="lineNum">     984 </span>            :       }
<span class="lineNum">     985 </span>            : 
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :       for(k=0;k&lt;cdim;k++){</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :         int book=info-&gt;class_subbook[class][cval&amp;(csub-1)];</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :         cval&gt;&gt;=csubbits;</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :         if(book&gt;=0){</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :           if((fit_value[j+k]=vorbis_book_decode(books+book,&amp;vb-&gt;opb))==-1)</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :             goto eop;</span>
<span class="lineNum">     992 </span>            :         }else{
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :           fit_value[j+k]=0;</span>
<span class="lineNum">     994 </span>            :         }
<span class="lineNum">     995 </span>            :       }
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :       j+=cdim;</span>
<span class="lineNum">     997 </span>            :     }
<span class="lineNum">     998 </span>            : 
<span class="lineNum">     999 </span>            :     /* unwrap positive values and reconsitute via linear interpolation */
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :     for(i=2;i&lt;look-&gt;posts;i++){</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :       int predicted=render_point(info-&gt;postlist[look-&gt;loneighbor[i-2]],</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :                                  info-&gt;postlist[look-&gt;hineighbor[i-2]],</span>
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :                                  fit_value[look-&gt;loneighbor[i-2]],</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :                                  fit_value[look-&gt;hineighbor[i-2]],</span>
<span class="lineNum">    1005 </span>            :                                  info-&gt;postlist[i]);
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :       int hiroom=look-&gt;quant_q-predicted;</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :       int loroom=predicted;</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :       int room=(hiroom&lt;loroom?hiroom:loroom)&lt;&lt;1;</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :       int val=fit_value[i];</span>
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :       if(val){</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :         if(val&gt;=room){</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :           if(hiroom&gt;loroom){</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :             val = val-loroom;</span>
<span class="lineNum">    1015 </span>            :           }else{
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :             val = -1-(val-hiroom);</span>
<span class="lineNum">    1017 </span>            :           }
<span class="lineNum">    1018 </span>            :         }else{
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :           if(val&amp;1){</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :             val= -((val+1)&gt;&gt;1);</span>
<span class="lineNum">    1021 </span>            :           }else{
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :             val&gt;&gt;=1;</span>
<span class="lineNum">    1023 </span>            :           }
<span class="lineNum">    1024 </span>            :         }
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :         fit_value[i]=(val+predicted)&amp;0x7fff;</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :         fit_value[look-&gt;loneighbor[i-2]]&amp;=0x7fff;</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :         fit_value[look-&gt;hineighbor[i-2]]&amp;=0x7fff;</span>
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span>            :       }else{
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :         fit_value[i]=predicted|0x8000;</span>
<span class="lineNum">    1032 </span>            :       }
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span>            :     }
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :     return(fit_value);</span>
<span class="lineNum">    1037 </span>            :   }
<span class="lineNum">    1038 </span>            :  eop:
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :   return(NULL);</span>
<a name="1040"><span class="lineNum">    1040 </span>            : }</a>
<span class="lineNum">    1041 </span>            : 
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 : static int floor1_inverse2(vorbis_block *vb,vorbis_look_floor *in,void *memo,</span>
<span class="lineNum">    1043 </span>            :                           float *out){
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :   vorbis_look_floor1 *look=(vorbis_look_floor1 *)in;</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :   vorbis_info_floor1 *info=look-&gt;vi;</span>
<span class="lineNum">    1046 </span>            : 
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :   codec_setup_info   *ci=vb-&gt;vd-&gt;vi-&gt;codec_setup;</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :   int                  n=ci-&gt;blocksizes[vb-&gt;W]/2;</span>
<span class="lineNum">    1049 </span>            :   int j;
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :   if(memo){</span>
<span class="lineNum">    1052 </span>            :     /* render the lines */
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :     int *fit_value=(int *)memo;</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :     int hx=0;</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :     int lx=0;</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :     int ly=fit_value[0]*info-&gt;mult;</span>
<span class="lineNum">    1057 </span>            :     /* guard lookup against out-of-range values */
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :     ly=(ly&lt;0?0:ly&gt;255?255:ly);</span>
<span class="lineNum">    1059 </span>            : 
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :     for(j=1;j&lt;look-&gt;posts;j++){</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :       int current=look-&gt;forward_index[j];</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :       int hy=fit_value[current]&amp;0x7fff;</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :       if(hy==fit_value[current]){</span>
<span class="lineNum">    1064 </span>            : 
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :         hx=info-&gt;postlist[current];</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :         hy*=info-&gt;mult;</span>
<span class="lineNum">    1067 </span>            :         /* guard lookup against out-of-range values */
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :         hy=(hy&lt;0?0:hy&gt;255?255:hy);</span>
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :         render_line(n,lx,hx,ly,hy,out);</span>
<span class="lineNum">    1071 </span>            : 
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :         lx=hx;</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :         ly=hy;</span>
<span class="lineNum">    1074 </span>            :       }
<span class="lineNum">    1075 </span>            :     }
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :     for(j=hx;j&lt;n;j++)out[j]*=FLOOR1_fromdB_LOOKUP[ly]; /* be certain */</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :     return(1);</span>
<span class="lineNum">    1078 </span>            :   }
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :   memset(out,0,sizeof(*out)*n);</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :   return(0);</span>
<span class="lineNum">    1081 </span>            : }
<span class="lineNum">    1082 </span>            : 
<span class="lineNum">    1083 </span>            : /* export hooks */
<span class="lineNum">    1084 </span>            : const vorbis_func_floor floor1_exportbundle={
<span class="lineNum">    1085 </span>            :   &amp;floor1_pack,&amp;floor1_unpack,&amp;floor1_look,&amp;floor1_free_info,
<span class="lineNum">    1086 </span>            :   &amp;floor1_free_look,&amp;floor1_inverse1,&amp;floor1_inverse2
<span class="lineNum">    1087 </span>            : };
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

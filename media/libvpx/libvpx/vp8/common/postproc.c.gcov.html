<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - media/libvpx/libvpx/vp8/common/postproc.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../index.html">top level</a> - <a href="index.html">media/libvpx/libvpx/vp8/common</a> - postproc.c<span style="font-size: 80%;"> (source / <a href="postproc.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">202</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">8</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *  Copyright (c) 2010 The WebM project authors. All Rights Reserved.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *  Use of this source code is governed by a BSD-style license
<span class="lineNum">       5 </span>            :  *  that can be found in the LICENSE file in the root of the source
<span class="lineNum">       6 </span>            :  *  tree. An additional intellectual property rights grant can be found
<span class="lineNum">       7 </span>            :  *  in the file PATENTS.  All contributing project authors may
<span class="lineNum">       8 </span>            :  *  be found in the AUTHORS file in the root of the source tree.
<span class="lineNum">       9 </span>            :  */
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &quot;vpx_config.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;vpx_dsp_rtcd.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;vp8_rtcd.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;vpx_dsp/postproc.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;vpx_ports/system_state.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;vpx_scale_rtcd.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;vpx_scale/yv12config.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;postproc.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;common.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;vpx_scale/vpx_scale.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;systemdependent.h&quot;
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : #include &lt;limits.h&gt;
<span class="lineNum">      24 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      25 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : /* clang-format off */
<span class="lineNum">      29 </span>            : #define RGB_TO_YUV(t)                                     \
<span class="lineNum">      30 </span>            :   (unsigned char)((0.257 * (float)(t &gt;&gt; 16)) +            \
<span class="lineNum">      31 </span>            :                   (0.504 * (float)(t &gt;&gt; 8 &amp; 0xff)) +      \
<span class="lineNum">      32 </span>            :                   (0.098 * (float)(t &amp; 0xff)) + 16),      \
<span class="lineNum">      33 </span>            :   (unsigned char)(-(0.148 * (float)(t &gt;&gt; 16)) -           \
<span class="lineNum">      34 </span>            :                   (0.291 * (float)(t &gt;&gt; 8 &amp; 0xff)) +      \
<span class="lineNum">      35 </span>            :                   (0.439 * (float)(t &amp; 0xff)) + 128),     \
<span class="lineNum">      36 </span>            :   (unsigned char)((0.439 * (float)(t &gt;&gt; 16)) -            \
<span class="lineNum">      37 </span>            :                   (0.368 * (float)(t &gt;&gt; 8 &amp; 0xff)) -      \
<span class="lineNum">      38 </span>            :                   (0.071 * (float)(t &amp; 0xff)) + 128)
<span class="lineNum">      39 </span>            : /* clang-format on */
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : extern void vp8_blit_text(const char *msg, unsigned char *address,
<span class="lineNum">      42 </span>            :                           const int pitch);
<span class="lineNum">      43 </span>            : extern void vp8_blit_line(int x0, int x1, int y0, int y1, unsigned char *image,
<span class="lineNum">      44 </span>            :                           const int pitch);
<span class="lineNum">      45 </span>            : /***********************************************************************************************************
<a name="46"><span class="lineNum">      46 </span>            :  */</a>
<span class="lineNum">      47 </span>            : #if CONFIG_POSTPROC
<span class="lineNum">      48 </span><span class="lineNoCov">          0 : static int q2mbl(int x) {</span>
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :   if (x &lt; 20) x = 20;</span>
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   x = 50 + (x - 50) * 10 / 8;</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   return x * x / 3;</span>
<a name="53"><span class="lineNum">      53 </span>            : }</a>
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span><span class="lineNoCov">          0 : static void vp8_de_mblock(YV12_BUFFER_CONFIG *post, int q) {</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :   vpx_mbpost_proc_across_ip(post-&gt;y_buffer, post-&gt;y_stride, post-&gt;y_height,</span>
<span class="lineNum">      57 </span>            :                             post-&gt;y_width, q2mbl(q));
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :   vpx_mbpost_proc_down(post-&gt;y_buffer, post-&gt;y_stride, post-&gt;y_height,</span>
<span class="lineNum">      59 </span>            :                        post-&gt;y_width, q2mbl(q));
<a name="60"><span class="lineNum">      60 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : void vp8_deblock(VP8_COMMON *cm, YV12_BUFFER_CONFIG *source,</span>
<span class="lineNum">      63 </span>            :                  YV12_BUFFER_CONFIG *post, int q, int low_var_thresh,
<span class="lineNum">      64 </span>            :                  int flag) {
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   double level = 6.0e-05 * q * q * q - .0067 * q * q + .306 * q + .0065;</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :   int ppl = (int)(level + .5);</span>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :   const MODE_INFO *mode_info_context = cm-&gt;show_frame_mi;</span>
<span class="lineNum">      69 </span>            :   int mbr, mbc;
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            :   /* The pixel thresholds are adjusted according to if or not the macroblock
<span class="lineNum">      72 </span>            :    * is a skipped block.  */
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :   unsigned char *ylimits = cm-&gt;pp_limits_buffer;</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   unsigned char *uvlimits = cm-&gt;pp_limits_buffer + 16 * cm-&gt;mb_cols;</span>
<span class="lineNum">      75 </span>            :   (void)low_var_thresh;
<span class="lineNum">      76 </span>            :   (void)flag;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :   if (ppl &gt; 0) {</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :     for (mbr = 0; mbr &lt; cm-&gt;mb_rows; ++mbr) {</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :       unsigned char *ylptr = ylimits;</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :       unsigned char *uvlptr = uvlimits;</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :       for (mbc = 0; mbc &lt; cm-&gt;mb_cols; ++mbc) {</span>
<span class="lineNum">      83 </span>            :         unsigned char mb_ppl;
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :         if (mode_info_context-&gt;mbmi.mb_skip_coeff) {</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :           mb_ppl = (unsigned char)ppl &gt;&gt; 1;</span>
<span class="lineNum">      87 </span>            :         } else {
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :           mb_ppl = (unsigned char)ppl;</span>
<span class="lineNum">      89 </span>            :         }
<span class="lineNum">      90 </span>            : 
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :         memset(ylptr, mb_ppl, 16);</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :         memset(uvlptr, mb_ppl, 8);</span>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :         ylptr += 16;</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :         uvlptr += 8;</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :         mode_info_context++;</span>
<span class="lineNum">      97 </span>            :       }
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :       mode_info_context++;</span>
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :       vpx_post_proc_down_and_across_mb_row(</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :           source-&gt;y_buffer + 16 * mbr * source-&gt;y_stride,</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :           post-&gt;y_buffer + 16 * mbr * post-&gt;y_stride, source-&gt;y_stride,</span>
<span class="lineNum">     103 </span>            :           post-&gt;y_stride, source-&gt;y_width, ylimits, 16);
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :       vpx_post_proc_down_and_across_mb_row(</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :           source-&gt;u_buffer + 8 * mbr * source-&gt;uv_stride,</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :           post-&gt;u_buffer + 8 * mbr * post-&gt;uv_stride, source-&gt;uv_stride,</span>
<span class="lineNum">     108 </span>            :           post-&gt;uv_stride, source-&gt;uv_width, uvlimits, 8);
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :       vpx_post_proc_down_and_across_mb_row(</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :           source-&gt;v_buffer + 8 * mbr * source-&gt;uv_stride,</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :           post-&gt;v_buffer + 8 * mbr * post-&gt;uv_stride, source-&gt;uv_stride,</span>
<span class="lineNum">     112 </span>            :           post-&gt;uv_stride, source-&gt;uv_width, uvlimits, 8);
<span class="lineNum">     113 </span>            :     }
<span class="lineNum">     114 </span>            :   } else {
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     vp8_yv12_copy_frame(source, post);</span>
<span class="lineNum">     116 </span>            :   }
<a name="117"><span class="lineNum">     117 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span><span class="lineNoCov">          0 : void vp8_de_noise(VP8_COMMON *cm, YV12_BUFFER_CONFIG *source,</span>
<span class="lineNum">     120 </span>            :                   YV12_BUFFER_CONFIG *post, int q, int low_var_thresh, int flag,
<span class="lineNum">     121 </span>            :                   int uvfilter) {
<span class="lineNum">     122 </span>            :   int mbr;
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   double level = 6.0e-05 * q * q * q - .0067 * q * q + .306 * q + .0065;</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   int ppl = (int)(level + .5);</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :   int mb_rows = cm-&gt;mb_rows;</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :   int mb_cols = cm-&gt;mb_cols;</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   unsigned char *limits = cm-&gt;pp_limits_buffer;</span>
<span class="lineNum">     128 </span>            :   (void)post;
<span class="lineNum">     129 </span>            :   (void)low_var_thresh;
<span class="lineNum">     130 </span>            :   (void)flag;
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :   memset(limits, (unsigned char)ppl, 16 * mb_cols);</span>
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span>            :   /* TODO: The original code don't filter the 2 outer rows and columns. */
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :   for (mbr = 0; mbr &lt; mb_rows; ++mbr) {</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :     vpx_post_proc_down_and_across_mb_row(</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         source-&gt;y_buffer + 16 * mbr * source-&gt;y_stride,</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :         source-&gt;y_buffer + 16 * mbr * source-&gt;y_stride, source-&gt;y_stride,</span>
<span class="lineNum">     139 </span>            :         source-&gt;y_stride, source-&gt;y_width, limits, 16);
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :     if (uvfilter == 1) {</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :       vpx_post_proc_down_and_across_mb_row(</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :           source-&gt;u_buffer + 8 * mbr * source-&gt;uv_stride,</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :           source-&gt;u_buffer + 8 * mbr * source-&gt;uv_stride, source-&gt;uv_stride,</span>
<span class="lineNum">     144 </span>            :           source-&gt;uv_stride, source-&gt;uv_width, limits, 8);
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :       vpx_post_proc_down_and_across_mb_row(</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :           source-&gt;v_buffer + 8 * mbr * source-&gt;uv_stride,</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :           source-&gt;v_buffer + 8 * mbr * source-&gt;uv_stride, source-&gt;uv_stride,</span>
<span class="lineNum">     148 </span>            :           source-&gt;uv_stride, source-&gt;uv_width, limits, 8);
<span class="lineNum">     149 </span>            :     }
<span class="lineNum">     150 </span>            :   }
<span class="lineNum">     151 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     152 </span>            : #endif  // CONFIG_POSTPROC
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span>            : /* Blend the macro block with a solid colored square.  Leave the
<span class="lineNum">     155 </span>            :  * edges unblended to give distinction to macro blocks in areas
<a name="156"><span class="lineNum">     156 </span>            :  * filled with the same color block.</a>
<span class="lineNum">     157 </span>            :  */
<span class="lineNum">     158 </span><span class="lineNoCov">          0 : void vp8_blend_mb_inner_c(unsigned char *y, unsigned char *u, unsigned char *v,</span>
<span class="lineNum">     159 </span>            :                           int y_1, int u_1, int v_1, int alpha, int stride) {
<span class="lineNum">     160 </span>            :   int i, j;
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   int y1_const = y_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   int u1_const = u_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :   int v1_const = v_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   y += 2 * stride + 2;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; 12; ++i) {</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; 12; ++j) {</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :       y[j] = (y[j] * alpha + y1_const) &gt;&gt; 16;</span>
<span class="lineNum">     169 </span>            :     }
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     y += stride;</span>
<span class="lineNum">     171 </span>            :   }
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :   stride &gt;&gt;= 1;</span>
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :   u += stride + 1;</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :   v += stride + 1;</span>
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; 6; ++i) {</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; 6; ++j) {</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :       u[j] = (u[j] * alpha + u1_const) &gt;&gt; 16;</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :       v[j] = (v[j] * alpha + v1_const) &gt;&gt; 16;</span>
<span class="lineNum">     182 </span>            :     }
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :     u += stride;</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :     v += stride;</span>
<span class="lineNum">     185 </span>            :   }
<span class="lineNum">     186 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span>            : /* Blend only the edge of the macro block.  Leave center
<a name="189"><span class="lineNum">     189 </span>            :  * unblended to allow for other visualizations to be layered.</a>
<span class="lineNum">     190 </span>            :  */
<span class="lineNum">     191 </span><span class="lineNoCov">          0 : void vp8_blend_mb_outer_c(unsigned char *y, unsigned char *u, unsigned char *v,</span>
<span class="lineNum">     192 </span>            :                           int y_1, int u_1, int v_1, int alpha, int stride) {
<span class="lineNum">     193 </span>            :   int i, j;
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :   int y1_const = y_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :   int u1_const = u_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   int v1_const = v_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; 2; ++i) {</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; 16; ++j) {</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :       y[j] = (y[j] * alpha + y1_const) &gt;&gt; 16;</span>
<span class="lineNum">     201 </span>            :     }
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     y += stride;</span>
<span class="lineNum">     203 </span>            :   }
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; 12; ++i) {</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :     y[0] = (y[0] * alpha + y1_const) &gt;&gt; 16;</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :     y[1] = (y[1] * alpha + y1_const) &gt;&gt; 16;</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :     y[14] = (y[14] * alpha + y1_const) &gt;&gt; 16;</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :     y[15] = (y[15] * alpha + y1_const) &gt;&gt; 16;</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     y += stride;</span>
<span class="lineNum">     211 </span>            :   }
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; 2; ++i) {</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; 16; ++j) {</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :       y[j] = (y[j] * alpha + y1_const) &gt;&gt; 16;</span>
<span class="lineNum">     216 </span>            :     }
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :     y += stride;</span>
<span class="lineNum">     218 </span>            :   }
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   stride &gt;&gt;= 1;</span>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :   for (j = 0; j &lt; 8; ++j) {</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :     u[j] = (u[j] * alpha + u1_const) &gt;&gt; 16;</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :     v[j] = (v[j] * alpha + v1_const) &gt;&gt; 16;</span>
<span class="lineNum">     225 </span>            :   }
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   u += stride;</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :   v += stride;</span>
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; 6; ++i) {</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :     u[0] = (u[0] * alpha + u1_const) &gt;&gt; 16;</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :     v[0] = (v[0] * alpha + v1_const) &gt;&gt; 16;</span>
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :     u[7] = (u[7] * alpha + u1_const) &gt;&gt; 16;</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :     v[7] = (v[7] * alpha + v1_const) &gt;&gt; 16;</span>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     u += stride;</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :     v += stride;</span>
<span class="lineNum">     238 </span>            :   }
<span class="lineNum">     239 </span>            : 
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :   for (j = 0; j &lt; 8; ++j) {</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     u[j] = (u[j] * alpha + u1_const) &gt;&gt; 16;</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     v[j] = (v[j] * alpha + v1_const) &gt;&gt; 16;</span>
<span class="lineNum">     243 </span>            :   }
<a name="244"><span class="lineNum">     244 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span><span class="lineNoCov">          0 : void vp8_blend_b_c(unsigned char *y, unsigned char *u, unsigned char *v,</span>
<span class="lineNum">     247 </span>            :                    int y_1, int u_1, int v_1, int alpha, int stride) {
<span class="lineNum">     248 </span>            :   int i, j;
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   int y1_const = y_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   int u1_const = u_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :   int v1_const = v_1 * ((1 &lt;&lt; 16) - alpha);</span>
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; 4; ++i) {</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; 4; ++j) {</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :       y[j] = (y[j] * alpha + y1_const) &gt;&gt; 16;</span>
<span class="lineNum">     256 </span>            :     }
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :     y += stride;</span>
<span class="lineNum">     258 </span>            :   }
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :   stride &gt;&gt;= 1;</span>
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; 2; ++i) {</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; 2; ++j) {</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :       u[j] = (u[j] * alpha + u1_const) &gt;&gt; 16;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :       v[j] = (v[j] * alpha + v1_const) &gt;&gt; 16;</span>
<span class="lineNum">     266 </span>            :     }
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     u += stride;</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     v += stride;</span>
<span class="lineNum">     269 </span>            :   }
<span class="lineNum">     270 </span><span class="lineNoCov">          0 : }</span>
<a name="271"><span class="lineNum">     271 </span>            : </a>
<span class="lineNum">     272 </span>            : #if CONFIG_POSTPROC
<span class="lineNum">     273 </span><span class="lineNoCov">          0 : int vp8_post_proc_frame(VP8_COMMON *oci, YV12_BUFFER_CONFIG *dest,</span>
<span class="lineNum">     274 </span>            :                         vp8_ppflags_t *ppflags) {
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   int q = oci-&gt;filter_level * 10 / 6;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   int flags = ppflags-&gt;post_proc_flag;</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   int deblock_level = ppflags-&gt;deblocking_level;</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   int noise_level = ppflags-&gt;noise_level;</span>
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :   if (!oci-&gt;frame_to_show) return -1;</span>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   if (q &gt; 63) q = 63;</span>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :   if (!flags) {</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     *dest = *oci-&gt;frame_to_show;</span>
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span>            :     /* handle problem with extending borders */
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     dest-&gt;y_width = oci-&gt;Width;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :     dest-&gt;y_height = oci-&gt;Height;</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     dest-&gt;uv_height = dest-&gt;y_height / 2;</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     oci-&gt;postproc_state.last_base_qindex = oci-&gt;base_qindex;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     oci-&gt;postproc_state.last_frame_valid = 1;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     294 </span>            :   }
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :   if (flags &amp; VP8D_ADDNOISE) {</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :     if (!oci-&gt;postproc_state.generated_noise) {</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :       oci-&gt;postproc_state.generated_noise = vpx_calloc(</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :           oci-&gt;Width + 256, sizeof(*oci-&gt;postproc_state.generated_noise));</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :       if (!oci-&gt;postproc_state.generated_noise) return 1;</span>
<span class="lineNum">     300 </span>            :     }
<span class="lineNum">     301 </span>            :   }
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span>            :   /* Allocate post_proc_buffer_int if needed */
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :   if ((flags &amp; VP8D_MFQE) &amp;&amp; !oci-&gt;post_proc_buffer_int_used) {</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     if ((flags &amp; VP8D_DEBLOCK) || (flags &amp; VP8D_DEMACROBLOCK)) {</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :       int width = (oci-&gt;Width + 15) &amp; ~15;</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       int height = (oci-&gt;Height + 15) &amp; ~15;</span>
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :       if (vp8_yv12_alloc_frame_buffer(&amp;oci-&gt;post_proc_buffer_int, width, height,</span>
<span class="lineNum">     310 </span>            :                                       VP8BORDERINPIXELS)) {
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         vpx_internal_error(&amp;oci-&gt;error, VPX_CODEC_MEM_ERROR,</span>
<span class="lineNum">     312 </span>            :                            &quot;Failed to allocate MFQE framebuffer&quot;);
<span class="lineNum">     313 </span>            :       }
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :       oci-&gt;post_proc_buffer_int_used = 1;</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            :       /* insure that postproc is set to all 0's so that post proc
<span class="lineNum">     318 </span>            :        * doesn't pull random data in from edge
<span class="lineNum">     319 </span>            :        */
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :       memset((&amp;oci-&gt;post_proc_buffer_int)-&gt;buffer_alloc, 128,</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :              (&amp;oci-&gt;post_proc_buffer)-&gt;frame_size);</span>
<span class="lineNum">     322 </span>            :     }
<span class="lineNum">     323 </span>            :   }
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :   vpx_clear_system_state();</span>
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :   if ((flags &amp; VP8D_MFQE) &amp;&amp; oci-&gt;postproc_state.last_frame_valid &amp;&amp;</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :       oci-&gt;current_video_frame &gt;= 2 &amp;&amp;</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       oci-&gt;postproc_state.last_base_qindex &lt; 60 &amp;&amp;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :       oci-&gt;base_qindex - oci-&gt;postproc_state.last_base_qindex &gt;= 20) {</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     vp8_multiframe_quality_enhance(oci);</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     if (((flags &amp; VP8D_DEBLOCK) || (flags &amp; VP8D_DEMACROBLOCK)) &amp;&amp;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :         oci-&gt;post_proc_buffer_int_used) {</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :       vp8_yv12_copy_frame(&amp;oci-&gt;post_proc_buffer, &amp;oci-&gt;post_proc_buffer_int);</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       if (flags &amp; VP8D_DEMACROBLOCK) {</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :         vp8_deblock(oci, &amp;oci-&gt;post_proc_buffer_int, &amp;oci-&gt;post_proc_buffer,</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                     q + (deblock_level - 5) * 10, 1, 0);</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :         vp8_de_mblock(&amp;oci-&gt;post_proc_buffer, q + (deblock_level - 5) * 10);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       } else if (flags &amp; VP8D_DEBLOCK) {</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :         vp8_deblock(oci, &amp;oci-&gt;post_proc_buffer_int, &amp;oci-&gt;post_proc_buffer, q,</span>
<span class="lineNum">     341 </span>            :                     1, 0);
<span class="lineNum">     342 </span>            :       }
<span class="lineNum">     343 </span>            :     }
<span class="lineNum">     344 </span>            :     /* Move partially towards the base q of the previous frame */
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     oci-&gt;postproc_state.last_base_qindex =</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :         (3 * oci-&gt;postproc_state.last_base_qindex + oci-&gt;base_qindex) &gt;&gt; 2;</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :   } else if (flags &amp; VP8D_DEMACROBLOCK) {</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     vp8_deblock(oci, oci-&gt;frame_to_show, &amp;oci-&gt;post_proc_buffer,</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :                 q + (deblock_level - 5) * 10, 1, 0);</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     vp8_de_mblock(&amp;oci-&gt;post_proc_buffer, q + (deblock_level - 5) * 10);</span>
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :     oci-&gt;postproc_state.last_base_qindex = oci-&gt;base_qindex;</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :   } else if (flags &amp; VP8D_DEBLOCK) {</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     vp8_deblock(oci, oci-&gt;frame_to_show, &amp;oci-&gt;post_proc_buffer, q, 1, 0);</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     oci-&gt;postproc_state.last_base_qindex = oci-&gt;base_qindex;</span>
<span class="lineNum">     356 </span>            :   } else {
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :     vp8_yv12_copy_frame(oci-&gt;frame_to_show, &amp;oci-&gt;post_proc_buffer);</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :     oci-&gt;postproc_state.last_base_qindex = oci-&gt;base_qindex;</span>
<span class="lineNum">     359 </span>            :   }
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   oci-&gt;postproc_state.last_frame_valid = 1;</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :   if (flags &amp; VP8D_ADDNOISE) {</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :     if (oci-&gt;postproc_state.last_q != q ||</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :         oci-&gt;postproc_state.last_noise != noise_level) {</span>
<span class="lineNum">     365 </span>            :       double sigma;
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :       struct postproc_state *ppstate = &amp;oci-&gt;postproc_state;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :       vpx_clear_system_state();</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :       sigma = noise_level + .5 + .6 * q / 63.0;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :       ppstate-&gt;clamp =</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :           vpx_setup_noise(sigma, ppstate-&gt;generated_noise, oci-&gt;Width + 256);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :       ppstate-&gt;last_q = q;</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :       ppstate-&gt;last_noise = noise_level;</span>
<span class="lineNum">     373 </span>            :     }
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     vpx_plane_add_noise(</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :         oci-&gt;post_proc_buffer.y_buffer, oci-&gt;postproc_state.generated_noise,</span>
<span class="lineNum">     377 </span>            :         oci-&gt;postproc_state.clamp, oci-&gt;postproc_state.clamp,
<span class="lineNum">     378 </span>            :         oci-&gt;post_proc_buffer.y_width, oci-&gt;post_proc_buffer.y_height,
<span class="lineNum">     379 </span>            :         oci-&gt;post_proc_buffer.y_stride);
<span class="lineNum">     380 </span>            :   }
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :   *dest = oci-&gt;post_proc_buffer;</span>
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span>            :   /* handle problem with extending borders */
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :   dest-&gt;y_width = oci-&gt;Width;</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   dest-&gt;y_height = oci-&gt;Height;</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   dest-&gt;uv_height = dest-&gt;y_height / 2;</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     389 </span>            : }
<span class="lineNum">     390 </span>            : #endif
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

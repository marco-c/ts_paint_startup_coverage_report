<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - media/mtransport/third_party/nICEr/src/ice/ice_component.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../index.html">top level</a> - <a href="index.html">media/mtransport/third_party/nICEr/src/ice</a> - ice_component.c<span style="font-size: 80%;"> (source / <a href="ice_component.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">861</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">43</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            : Copyright (c) 2007, Adobe Systems, Incorporated
<span class="lineNum">       3 </span>            : All rights reserved.
<span class="lineNum">       4 </span>            : 
<span class="lineNum">       5 </span>            : Redistribution and use in source and binary forms, with or without
<span class="lineNum">       6 </span>            : modification, are permitted provided that the following conditions are
<span class="lineNum">       7 </span>            : met:
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : * Redistributions of source code must retain the above copyright
<span class="lineNum">      10 </span>            :   notice, this list of conditions and the following disclaimer.
<span class="lineNum">      11 </span>            : 
<span class="lineNum">      12 </span>            : * Redistributions in binary form must reproduce the above copyright
<span class="lineNum">      13 </span>            :   notice, this list of conditions and the following disclaimer in the
<span class="lineNum">      14 </span>            :   documentation and/or other materials provided with the distribution.
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : * Neither the name of Adobe Systems, Network Resonance nor the names of its
<span class="lineNum">      17 </span>            :   contributors may be used to endorse or promote products derived from
<span class="lineNum">      18 </span>            :   this software without specific prior written permission.
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
<span class="lineNum">      21 </span>            : &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
<span class="lineNum">      22 </span>            : LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
<span class="lineNum">      23 </span>            : A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
<span class="lineNum">      24 </span>            : OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<span class="lineNum">      25 </span>            : SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<span class="lineNum">      26 </span>            : LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
<span class="lineNum">      27 </span>            : DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
<span class="lineNum">      28 </span>            : THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
<span class="lineNum">      29 </span>            : (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
<span class="lineNum">      30 </span>            : OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      31 </span>            : */
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : static char *RCSSTRING __UNUSED__=&quot;$Id: ice_component.c,v 1.2 2008/04/28 17:59:01 ekr Exp $&quot;;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      38 </span>            : #include &lt;assert.h&gt;
<span class="lineNum">      39 </span>            : #include &lt;nr_api.h&gt;
<span class="lineNum">      40 </span>            : #include &lt;registry.h&gt;
<span class="lineNum">      41 </span>            : #include &lt;async_timer.h&gt;
<span class="lineNum">      42 </span>            : #include &quot;ice_ctx.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;ice_codeword.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;stun.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;nr_socket_local.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;nr_socket_turn.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;nr_socket_wrapper.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;nr_socket_buffered_stun.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;nr_socket_multi_tcp.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;ice_reg.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;nr_crypto.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;r_time.h&quot;
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            : static int nr_ice_component_stun_server_default_cb(void *cb_arg,nr_stun_server_ctx *stun_ctx,nr_socket *sock, nr_stun_server_request *req, int *dont_free, int *error);
<span class="lineNum">      55 </span>            : static int nr_ice_pre_answer_request_destroy(nr_ice_pre_answer_request **parp);
<span class="lineNum">      56 </span>            : void nr_ice_component_consent_schedule_consent_timer(nr_ice_component *comp);
<span class="lineNum">      57 </span>            : void nr_ice_component_consent_destroy(nr_ice_component *comp);
<a name="58"><span class="lineNum">      58 </span>            : </a>
<span class="lineNum">      59 </span>            : /* This function takes ownership of the contents of req (but not req itself) */
<span class="lineNum">      60 </span><span class="lineNoCov">          0 : static int nr_ice_pre_answer_request_create(nr_transport_addr *dst, nr_stun_server_request *req, nr_ice_pre_answer_request **parp)</span>
<span class="lineNum">      61 </span>            :   {
<span class="lineNum">      62 </span>            :     int r, _status;
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :     nr_ice_pre_answer_request *par = 0;</span>
<span class="lineNum">      64 </span>            :     nr_stun_message_attribute *attr;
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :     if (!(par = RCALLOC(sizeof(nr_ice_pre_answer_request))))</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :       ABORT(R_NO_MEMORY);</span>
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :     par-&gt;req = *req; /* Struct assignment */</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :     memset(req, 0, sizeof(*req)); /* Zero contents to avoid confusion */</span>
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :     if (r=nr_transport_addr_copy(&amp;par-&gt;local_addr, dst))</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :     if (!nr_stun_message_has_attribute(par-&gt;req.request, NR_STUN_ATTR_USERNAME, &amp;attr))</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :       ABORT(R_INTERNAL);</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :     if (!(par-&gt;username = r_strdup(attr-&gt;u.username)))</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :       ABORT(R_NO_MEMORY);</span>
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :     *parp=par;</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">      81 </span>            :  abort:
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :     if (_status) {</span>
<span class="lineNum">      83 </span>            :       /* Erase the request so we don't free it */
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :       memset(&amp;par-&gt;req, 0, sizeof(nr_stun_server_request));</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :       nr_ice_pre_answer_request_destroy(&amp;par);</span>
<span class="lineNum">      86 </span>            :     }
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="89"><span class="lineNum">      89 </span>            :   }</a>
<span class="lineNum">      90 </span>            : 
<span class="lineNum">      91 </span><span class="lineNoCov">          0 : static int nr_ice_pre_answer_request_destroy(nr_ice_pre_answer_request **parp)</span>
<span class="lineNum">      92 </span>            :   {
<span class="lineNum">      93 </span>            :     nr_ice_pre_answer_request *par;
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :     if (!parp || !*parp)</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :     par = *parp;</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     *parp = 0;</span>
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     nr_stun_message_destroy(&amp;par-&gt;req.request);</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :     nr_stun_message_destroy(&amp;par-&gt;req.response);</span>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :     RFREE(par-&gt;username);</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :     RFREE(par);</span>
<span class="lineNum">     106 </span>            : 
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     return(0);</span>
<a name="108"><span class="lineNum">     108 </span>            :   }</a>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineNoCov">          0 : int nr_ice_component_create(nr_ice_media_stream *stream, int component_id, nr_ice_component **componentp)</span>
<span class="lineNum">     111 </span>            :   {
<span class="lineNum">     112 </span>            :     int _status;
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     nr_ice_component *comp=0;</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     if(!(comp=RCALLOC(sizeof(nr_ice_component))))</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :       ABORT(R_NO_MEMORY);</span>
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     comp-&gt;state=NR_ICE_COMPONENT_UNPAIRED;</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :     comp-&gt;component_id=component_id;</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :     comp-&gt;stream=stream;</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :     comp-&gt;ctx=stream-&gt;ctx;</span>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :     STAILQ_INIT(&amp;comp-&gt;sockets);</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     TAILQ_INIT(&amp;comp-&gt;candidates);</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     STAILQ_INIT(&amp;comp-&gt;pre_answer_reqs);</span>
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :     STAILQ_INSERT_TAIL(&amp;stream-&gt;components,comp,entry);</span>
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">     130 </span>            :   abort:
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="132"><span class="lineNum">     132 </span>            :   }</a>
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span><span class="lineNoCov">          0 : int nr_ice_component_destroy(nr_ice_component **componentp)</span>
<span class="lineNum">     135 </span>            :   {
<span class="lineNum">     136 </span>            :     nr_ice_component *component;
<span class="lineNum">     137 </span>            :     nr_ice_socket *s1,*s2;
<span class="lineNum">     138 </span>            :     nr_ice_candidate *c1,*c2;
<span class="lineNum">     139 </span>            :     nr_ice_pre_answer_request *r1,*r2;
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :     if(!componentp || !*componentp)</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :     component=*componentp;</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :     *componentp=0;</span>
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_destroy(component);</span>
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span>            :     /* Detach ourselves from the sockets */
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     if (component-&gt;local_component){</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :       nr_ice_socket *isock=STAILQ_FIRST(&amp;component-&gt;local_component-&gt;sockets);</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :       while(isock){</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :         nr_stun_server_remove_client(isock-&gt;stun_server, component);</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :         isock=STAILQ_NEXT(isock, entry);</span>
<span class="lineNum">     155 </span>            :       }
<span class="lineNum">     156 </span>            :     }
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span>            :     /* candidates MUST be destroyed before the sockets so that
<span class="lineNum">     159 </span>            :        they can deregister */
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :     TAILQ_FOREACH_SAFE(c1, &amp;component-&gt;candidates, entry_comp, c2){</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :       TAILQ_REMOVE(&amp;component-&gt;candidates,c1,entry_comp);</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :       nr_ice_candidate_destroy(&amp;c1);</span>
<span class="lineNum">     163 </span>            :     }
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     STAILQ_FOREACH_SAFE(s1, &amp;component-&gt;sockets, entry, s2){</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :       STAILQ_REMOVE(&amp;component-&gt;sockets,s1,nr_ice_socket_,entry);</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :       nr_ice_socket_destroy(&amp;s1);</span>
<span class="lineNum">     168 </span>            :     }
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     STAILQ_FOREACH_SAFE(r1, &amp;component-&gt;pre_answer_reqs, entry, r2){</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :       STAILQ_REMOVE(&amp;component-&gt;pre_answer_reqs,r1,nr_ice_pre_answer_request_, entry);</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :       nr_ice_pre_answer_request_destroy(&amp;r1);</span>
<span class="lineNum">     173 </span>            :     }
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     RFREE(component);</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     return(0);</span>
<a name="177"><span class="lineNum">     177 </span>            :   }</a>
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineNoCov">          0 : static int nr_ice_component_create_stun_server_ctx(nr_ice_component *component, nr_ice_socket *isock, nr_socket *sock, nr_transport_addr *addr, char *lufrag, Data *pwd)</span>
<span class="lineNum">     180 </span>            :   {
<span class="lineNum">     181 </span>            :     char label[256];
<span class="lineNum">     182 </span>            :     int r,_status;
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            :     /* Create a STUN server context for this socket */
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :     snprintf(label, sizeof(label), &quot;server(%s)&quot;, addr-&gt;as_string);</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :     if(r=nr_stun_server_ctx_create(label,sock,&amp;isock-&gt;stun_server))</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :     if(r=nr_ice_socket_register_stun_server(isock,isock-&gt;stun_server,&amp;isock-&gt;stun_server_handle))</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span>            :    /* Add the default STUN credentials so that we can respond before
<span class="lineNum">     192 </span>            :       we hear about the peer.*/
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     if(r=nr_stun_server_add_default_client(isock-&gt;stun_server, lufrag, pwd, nr_ice_component_stun_server_default_cb, component))</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :     _status = 0;</span>
<span class="lineNum">     197 </span>            :  abort:
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="199"><span class="lineNum">     199 </span>            :   }</a>
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span><span class="lineNoCov">          0 : static int nr_ice_component_initialize_udp(struct nr_ice_ctx_ *ctx,nr_ice_component *component, nr_local_addr *addrs, int addr_ct, char *lufrag, Data *pwd)</span>
<span class="lineNum">     202 </span>            :   {
<span class="lineNum">     203 </span>            :     nr_socket *sock;
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :     nr_ice_socket *isock=0;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :     nr_ice_candidate *cand=0;</span>
<span class="lineNum">     206 </span>            :     int i;
<span class="lineNum">     207 </span>            :     int j;
<span class="lineNum">     208 </span>            :     int r,_status;
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     if(ctx-&gt;flags &amp; NR_ICE_CTX_FLAGS_ONLY_PROXY) {</span>
<span class="lineNum">     211 </span>            :       /* No UDP support if we must use a proxy */
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">     213 </span>            :     }
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span>            :     /* Now one ice_socket for each address */
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;addr_ct;i++){</span>
<span class="lineNum">     217 </span>            :       char suppress;
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :       if(r=NR_reg_get2_char(NR_ICE_REG_SUPPRESS_INTERFACE_PRFX,addrs[i].addr.ifname,&amp;suppress)){</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :         if(r!=R_NOT_FOUND)</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     222 </span>            :       }
<span class="lineNum">     223 </span>            :       else{
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :         if(suppress)</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     226 </span>            :       }
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_DEBUG,&quot;ICE(%s): host address %s&quot;,ctx-&gt;label,addrs[i].addr.as_string);</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :       if((r=nr_socket_factory_create_socket(ctx-&gt;socket_factory,&amp;addrs[i].addr,&amp;sock))){</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_WARNING,&quot;ICE(%s): couldn't create socket for address %s&quot;,ctx-&gt;label,addrs[i].addr.as_string);</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     231 </span>            :       }
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :       if(r=nr_ice_socket_create(ctx,component,sock,NR_ICE_SOCKET_TYPE_DGRAM,&amp;isock))</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :       if (!(ctx-&gt;flags &amp; NR_ICE_CTX_FLAGS_RELAY_ONLY)) {</span>
<span class="lineNum">     237 </span>            :         /* Create one host candidate */
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         if(r=nr_ice_candidate_create(ctx,component,isock,sock,HOST,0,0,</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :           component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :         TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :         component-&gt;candidate_ct++;</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :         cand=0;</span>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span>            :         /* And a srvrflx candidate for each STUN server */
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :         for(j=0;j&lt;ctx-&gt;stun_server_ct;j++){</span>
<span class="lineNum">     248 </span>            :           /* Skip non-UDP */
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :           if(ctx-&gt;stun_servers[j].transport!=IPPROTO_UDP)</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span>            :           /* Ensure id is set (nr_ice_ctx_set_stun_servers does not) */
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :           ctx-&gt;stun_servers[j].id = j;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :           if(r=nr_ice_candidate_create(ctx,component,</span>
<span class="lineNum">     255 </span>            :             isock,sock,SERVER_REFLEXIVE,0,
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :             &amp;ctx-&gt;stun_servers[j],component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :             ABORT(r);</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :           TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :           component-&gt;candidate_ct++;</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :           cand=0;</span>
<span class="lineNum">     261 </span>            :         }
<span class="lineNum">     262 </span>            :       }
<span class="lineNum">     263 </span>            :       else{
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_WARNING,&quot;ICE(%s): relay only option results in no host candidate for %s&quot;,ctx-&gt;label,addrs[i].addr.as_string);</span>
<span class="lineNum">     265 </span>            :       }
<span class="lineNum">     266 </span>            : 
<span class="lineNum">     267 </span>            : #ifdef USE_TURN
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :       if ((ctx-&gt;flags &amp; NR_ICE_CTX_FLAGS_RELAY_ONLY) &amp;&amp;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :           (ctx-&gt;turn_server_ct == 0)) {</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_ERR,&quot;ICE(%s): relay only option is set without any TURN server configured&quot;,ctx-&gt;label);</span>
<span class="lineNum">     271 </span>            :       }
<span class="lineNum">     272 </span>            :       /* And both a srvrflx and relayed candidate for each TURN server (unless
<span class="lineNum">     273 </span>            :          we're in relay-only mode, in which case just the relayed one) */
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :       for(j=0;j&lt;ctx-&gt;turn_server_ct;j++){</span>
<span class="lineNum">     275 </span>            :         nr_socket *turn_sock;
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :         nr_ice_candidate *srvflx_cand=0;</span>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span>            :         /* Skip non-UDP */
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         if (ctx-&gt;turn_servers[j].turn_server.transport != IPPROTO_UDP)</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :         if (!(ctx-&gt;flags &amp; NR_ICE_CTX_FLAGS_RELAY_ONLY)) {</span>
<span class="lineNum">     283 </span>            :           /* Ensure id is set with a unique value */
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :           ctx-&gt;turn_servers[j].turn_server.id = j + ctx-&gt;stun_server_ct;</span>
<span class="lineNum">     285 </span>            :           /* srvrflx */
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :           if(r=nr_ice_candidate_create(ctx,component,</span>
<span class="lineNum">     287 </span>            :             isock,sock,SERVER_REFLEXIVE,0,
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :             &amp;ctx-&gt;turn_servers[j].turn_server,component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :             ABORT(r);</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :           cand-&gt;state=NR_ICE_CAND_STATE_INITIALIZING; /* Don't start */</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :           cand-&gt;done_cb=nr_ice_gather_finished_cb;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :           cand-&gt;cb_arg=cand;</span>
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :           TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :           component-&gt;candidate_ct++;</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :           srvflx_cand=cand;</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :           cand=0;</span>
<span class="lineNum">     298 </span>            :         }
<span class="lineNum">     299 </span>            :         /* relayed*/
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :         if(r=nr_socket_turn_create(sock, &amp;turn_sock))</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         if(r=nr_ice_candidate_create(ctx,component,</span>
<span class="lineNum">     303 </span>            :           isock,turn_sock,RELAYED,0,
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :           &amp;ctx-&gt;turn_servers[j].turn_server,component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :            ABORT(r);</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :         if (srvflx_cand) {</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :           cand-&gt;u.relayed.srvflx_candidate=srvflx_cand;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :           srvflx_cand-&gt;u.srvrflx.relay_candidate=cand;</span>
<span class="lineNum">     309 </span>            :         }
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :         cand-&gt;u.relayed.server=&amp;ctx-&gt;turn_servers[j];</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :         component-&gt;candidate_ct++;</span>
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         cand=0;</span>
<span class="lineNum">     315 </span>            :       }
<span class="lineNum">     316 </span>            : #endif /* USE_TURN */
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span>            :       /* Create a STUN server context for this socket */
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :       if ((r=nr_ice_component_create_stun_server_ctx(component,isock,sock,&amp;addrs[i].addr,lufrag,pwd)))</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :       STAILQ_INSERT_TAIL(&amp;component-&gt;sockets,isock,entry);</span>
<span class="lineNum">     323 </span>            :     }
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     _status = 0;</span>
<span class="lineNum">     326 </span>            :  abort:
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="328"><span class="lineNum">     328 </span>            :   }</a>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span><span class="lineNoCov">          0 : static int nr_ice_component_get_port_from_ephemeral_range(uint16_t *port)</span>
<span class="lineNum">     331 </span>            :   {
<span class="lineNum">     332 </span>            :     int _status, r;
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     void *buf = port;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     if(r=nr_crypto_random_bytes(buf, 2))</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     *port|=49152; /* make it fit into IANA ephemeral port range &gt;= 49152 */</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">     338 </span>            : abort:
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="340"><span class="lineNum">     340 </span>            :   }</a>
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineNoCov">          0 : static int nr_ice_component_create_tcp_host_candidate(struct nr_ice_ctx_ *ctx,</span>
<span class="lineNum">     343 </span>            :   nr_ice_component *component, nr_transport_addr *interface_addr, nr_socket_tcp_type tcp_type,
<span class="lineNum">     344 </span>            :   int backlog, int so_sock_ct, char *lufrag, Data *pwd, nr_ice_socket **isock)
<span class="lineNum">     345 </span>            :   {
<span class="lineNum">     346 </span>            :     int r,_status;
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     nr_ice_candidate *cand=0;</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     int tries=3;</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :     nr_ice_socket *isock_tmp=0;</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     nr_socket *nrsock=0;</span>
<span class="lineNum">     351 </span>            :     nr_transport_addr addr;
<span class="lineNum">     352 </span>            :     uint16_t local_port;
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     if ((r=nr_transport_addr_copy(&amp;addr,interface_addr)))</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :     addr.protocol=IPPROTO_TCP;</span>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            :     do{
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :       if (!tries--)</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :       if((r=nr_ice_component_get_port_from_ephemeral_range(&amp;local_port)))</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :       if ((r=nr_transport_addr_set_port(&amp;addr, local_port)))</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :       if((r=nr_transport_addr_fmt_addr_string(&amp;addr)))</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span>            :       /* It would be better to stop trying if there is error other than
<span class="lineNum">     372 </span>            :          port already used, but it'd require significant work to support this. */
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :       r=nr_socket_multi_tcp_create(ctx,&amp;addr,tcp_type,so_sock_ct,NR_STUN_MAX_MESSAGE_SIZE,&amp;nrsock);</span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     } while(r);</span>
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     if((tcp_type == TCP_TYPE_PASSIVE) &amp;&amp; (r=nr_socket_listen(nrsock,backlog)))</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     if((r=nr_ice_socket_create(ctx,component,nrsock,NR_ICE_SOCKET_TYPE_STREAM_TCP,&amp;isock_tmp)))</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span>            :     /* nr_ice_socket took ownership of nrsock */
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     nrsock=NULL;</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span>            :     /* Create a STUN server context for this socket */
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     if ((r=nr_ice_component_create_stun_server_ctx(component,isock_tmp,isock_tmp-&gt;sock,&amp;addr,lufrag,pwd)))</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :     if((r=nr_ice_candidate_create(ctx,component,isock_tmp,isock_tmp-&gt;sock,HOST,tcp_type,0,</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :       component-&gt;component_id,&amp;cand)))</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     if (isock)</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :       *isock=isock_tmp;</span>
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     component-&gt;candidate_ct++;</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :     STAILQ_INSERT_TAIL(&amp;component-&gt;sockets,isock_tmp,entry);</span>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">     403 </span>            : abort:
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     if (_status) {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :       nr_ice_socket_destroy(&amp;isock_tmp);</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :       nr_socket_destroy(&amp;nrsock);</span>
<span class="lineNum">     407 </span>            :     }
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="409"><span class="lineNum">     409 </span>            :   }</a>
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineNoCov">          0 : static int nr_ice_component_initialize_tcp(struct nr_ice_ctx_ *ctx,nr_ice_component *component, nr_local_addr *addrs, int addr_ct, char *lufrag, Data *pwd)</span>
<span class="lineNum">     412 </span>            :   {
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     nr_ice_candidate *cand=0;</span>
<span class="lineNum">     414 </span>            :     int i;
<span class="lineNum">     415 </span>            :     int j;
<span class="lineNum">     416 </span>            :     int r,_status;
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :     int so_sock_ct=0;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     int backlog=10;</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     char ice_tcp_disabled=1;</span>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;nr_ice_component_initialize_tcp&quot;);</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :     if(r=NR_reg_get_int4(NR_ICE_REG_ICE_TCP_SO_SOCK_COUNT,&amp;so_sock_ct)){</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :       if(r!=R_NOT_FOUND)</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     426 </span>            :     }
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :     if(r=NR_reg_get_int4(NR_ICE_REG_ICE_TCP_LISTEN_BACKLOG,&amp;backlog)){</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :       if(r!=R_NOT_FOUND)</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     431 </span>            :     }
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     if ((r=NR_reg_get_char(NR_ICE_REG_ICE_TCP_DISABLE, &amp;ice_tcp_disabled))) {</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :       if (r != R_NOT_FOUND)</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     436 </span>            :     }
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :     if ((ctx-&gt;flags &amp; NR_ICE_CTX_FLAGS_RELAY_ONLY) ||</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :         (ctx-&gt;flags &amp; NR_ICE_CTX_FLAGS_ONLY_PROXY)) {</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_WARNING,&quot;ICE(%s): relay/proxy only option results in ICE TCP being disabled&quot;,ctx-&gt;label);</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :       ice_tcp_disabled = 1;</span>
<span class="lineNum">     441 </span>            :     }
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;addr_ct;i++){</span>
<span class="lineNum">     444 </span>            :       char suppress;
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :       nr_ice_socket *isock_psv=0;</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :       nr_ice_socket *isock_so=0;</span>
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :       if(r=NR_reg_get2_char(NR_ICE_REG_SUPPRESS_INTERFACE_PRFX,addrs[i].addr.ifname,&amp;suppress)){</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :         if(r!=R_NOT_FOUND)</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     451 </span>            :       }
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :       else if(suppress) {</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     454 </span>            :       }
<span class="lineNum">     455 </span>            : 
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :       if (!ice_tcp_disabled) {</span>
<span class="lineNum">     457 </span>            :         /* passive host candidate */
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :         if ((r=nr_ice_component_create_tcp_host_candidate(ctx, component, &amp;addrs[i].addr,</span>
<span class="lineNum">     459 </span>            :           TCP_TYPE_PASSIVE, backlog, 0, lufrag, pwd, &amp;isock_psv))) {
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :           r_log(LOG_ICE,LOG_WARNING,&quot;ICE(%s): failed to create passive TCP host candidate: %d&quot;,ctx-&gt;label,r);</span>
<span class="lineNum">     461 </span>            :         }
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span>            :         /* active host candidate */
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :         if ((r=nr_ice_component_create_tcp_host_candidate(ctx, component, &amp;addrs[i].addr,</span>
<span class="lineNum">     465 </span>            :           TCP_TYPE_ACTIVE, 0, 0, lufrag, pwd, NULL))) {
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :           r_log(LOG_ICE,LOG_WARNING,&quot;ICE(%s): failed to create active TCP host candidate: %d&quot;,ctx-&gt;label,r);</span>
<span class="lineNum">     467 </span>            :         }
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span>            :         /* simultaneous-open host candidate */
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :         if (so_sock_ct) {</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :           if ((r=nr_ice_component_create_tcp_host_candidate(ctx, component, &amp;addrs[i].addr,</span>
<span class="lineNum">     472 </span>            :             TCP_TYPE_SO, 0, so_sock_ct, lufrag, pwd, &amp;isock_so))) {
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :             r_log(LOG_ICE,LOG_WARNING,&quot;ICE(%s): failed to create simultanous open TCP host candidate: %d&quot;,ctx-&gt;label,r);</span>
<span class="lineNum">     474 </span>            :           }
<span class="lineNum">     475 </span>            :         }
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span>            :         /* And srvrflx candidates for each STUN server */
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         for(j=0;j&lt;ctx-&gt;stun_server_ct;j++){</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :           if (ctx-&gt;stun_servers[j].transport!=IPPROTO_TCP)</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :           if (isock_psv) {</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :             if(r=nr_ice_candidate_create(ctx,component,</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :               isock_psv,isock_psv-&gt;sock,SERVER_REFLEXIVE,TCP_TYPE_PASSIVE,</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :               &amp;ctx-&gt;stun_servers[j],component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :               ABORT(r);</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :             TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :             component-&gt;candidate_ct++;</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :             cand=0;</span>
<span class="lineNum">     490 </span>            :           }
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :           if (isock_so) {</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :             if(r=nr_ice_candidate_create(ctx,component,</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :               isock_so,isock_so-&gt;sock,SERVER_REFLEXIVE,TCP_TYPE_SO,</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :               &amp;ctx-&gt;stun_servers[j],component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :               ABORT(r);</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :             TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :             component-&gt;candidate_ct++;</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :             cand=0;</span>
<span class="lineNum">     500 </span>            :           }
<span class="lineNum">     501 </span>            :         }
<span class="lineNum">     502 </span>            :       }
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span>            : #ifdef USE_TURN
<span class="lineNum">     505 </span>            :       /* Create a new relayed candidate for each addr/TURN server pair */
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :       for(j=0;j&lt;ctx-&gt;turn_server_ct;j++){</span>
<span class="lineNum">     507 </span>            :         nr_transport_addr addr;
<span class="lineNum">     508 </span>            :         nr_socket *local_sock;
<span class="lineNum">     509 </span>            :         nr_socket *buffered_sock;
<span class="lineNum">     510 </span>            :         nr_socket *turn_sock;
<span class="lineNum">     511 </span>            :         nr_ice_socket *turn_isock;
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span>            :         /* Skip non-TCP */
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :         if (ctx-&gt;turn_servers[j].turn_server.transport != IPPROTO_TCP)</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :         if (ctx-&gt;turn_servers[j].turn_server.type == NR_ICE_STUN_SERVER_TYPE_ADDR &amp;&amp;</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :             nr_transport_addr_cmp(&amp;ctx-&gt;turn_servers[j].turn_server.u.addr,</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                                   &amp;addrs[i].addr,</span>
<span class="lineNum">     520 </span>            :                                   NR_TRANSPORT_ADDR_CMP_MODE_VERSION)) {
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :           r_log(LOG_ICE,LOG_INFO,&quot;ICE(%s): Skipping TURN server because of IP version mis-match (%u - %u)&quot;,ctx-&gt;label,addrs[i].addr.ip_version,ctx-&gt;turn_servers[j].turn_server.u.addr.ip_version);</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     523 </span>            :         }
<span class="lineNum">     524 </span>            : 
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :         if (!ice_tcp_disabled) {</span>
<span class="lineNum">     526 </span>            :           /* Use TURN server to get srflx candidates */
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :           if (isock_psv) {</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :             if(r=nr_ice_candidate_create(ctx,component,</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :               isock_psv,isock_psv-&gt;sock,SERVER_REFLEXIVE,TCP_TYPE_PASSIVE,</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :               &amp;ctx-&gt;turn_servers[j].turn_server,component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :               ABORT(r);</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :             TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :             component-&gt;candidate_ct++;</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :             cand=0;</span>
<span class="lineNum">     535 </span>            :           }
<span class="lineNum">     536 </span>            : 
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :           if (isock_so) {</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :             if(r=nr_ice_candidate_create(ctx,component,</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :               isock_so,isock_so-&gt;sock,SERVER_REFLEXIVE,TCP_TYPE_SO,</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :               &amp;ctx-&gt;turn_servers[j].turn_server,component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :               ABORT(r);</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :             TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :             component-&gt;candidate_ct++;</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :             cand=0;</span>
<span class="lineNum">     545 </span>            :           }
<span class="lineNum">     546 </span>            :         }
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span>            :         /* Create relay candidate */
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :         if ((r=nr_transport_addr_copy(&amp;addr, &amp;addrs[i].addr)))</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :         addr.protocol = IPPROTO_TCP;</span>
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span>            :         /* If we're going to use TLS, make sure that's recorded */
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :         if (ctx-&gt;turn_servers[j].turn_server.tls) {</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :           strncpy(addr.tls_host,</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                   ctx-&gt;turn_servers[j].turn_server.u.dnsname.host,</span>
<span class="lineNum">     557 </span>            :                   sizeof(addr.tls_host) - 1);
<span class="lineNum">     558 </span>            :         }
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :         if ((r=nr_transport_addr_fmt_addr_string(&amp;addr)))</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     562 </span>            :         /* Create a local socket */
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :         if((r=nr_socket_factory_create_socket(ctx-&gt;socket_factory,&amp;addr,&amp;local_sock))){</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :           r_log(LOG_ICE,LOG_DEBUG,&quot;ICE(%s): couldn't create socket for address %s&quot;,ctx-&gt;label,addr.as_string);</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     566 </span>            :         }
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_DEBUG,&quot;nr_ice_component_initialize_tcp creating TURN TCP wrappers&quot;);</span>
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :         if (ctx-&gt;turn_tcp_socket_wrapper) {</span>
<span class="lineNum">     571 </span>            :           /* The HTTP proxy socket */
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :           if((r=nr_socket_wrapper_factory_wrap(ctx-&gt;turn_tcp_socket_wrapper, local_sock, &amp;local_sock)))</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :             ABORT(r);</span>
<span class="lineNum">     574 </span>            :         }
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span>            :         /* The TCP buffered socket */
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :         if((r=nr_socket_buffered_stun_create(local_sock, NR_STUN_MAX_MESSAGE_SIZE, TURN_TCP_FRAMING, &amp;buffered_sock)))</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span>            :         /* The TURN socket */
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :         if(r=nr_socket_turn_create(buffered_sock, &amp;turn_sock))</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span>            :         /* Create an ICE socket */
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :         if((r=nr_ice_socket_create(ctx, component, buffered_sock, NR_ICE_SOCKET_TYPE_STREAM_TURN, &amp;turn_isock)))</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span>            :         /* Attach ourselves to it */
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :         if(r=nr_ice_candidate_create(ctx,component,</span>
<span class="lineNum">     590 </span>            :           turn_isock,turn_sock,RELAYED,TCP_TYPE_NONE,
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :           &amp;ctx-&gt;turn_servers[j].turn_server,component-&gt;component_id,&amp;cand))</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :         cand-&gt;u.relayed.srvflx_candidate=NULL;</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :         cand-&gt;u.relayed.server=&amp;ctx-&gt;turn_servers[j];</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         TAILQ_INSERT_TAIL(&amp;component-&gt;candidates,cand,entry_comp);</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         component-&gt;candidate_ct++;</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :         cand=0;</span>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span>            :         /* Create a STUN server context for this socket */
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :         if ((r=nr_ice_component_create_stun_server_ctx(component,turn_isock,local_sock,&amp;addr,lufrag,pwd)))</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :         STAILQ_INSERT_TAIL(&amp;component-&gt;sockets,turn_isock,entry);</span>
<span class="lineNum">     604 </span>            :       }
<span class="lineNum">     605 </span>            : #endif /* USE_TURN */
<span class="lineNum">     606 </span>            :     }
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     _status = 0;</span>
<span class="lineNum">     609 </span>            :  abort:
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     return(_status);</span>
<span class="lineNum">     611 </span>            :   }
<span class="lineNum">     612 </span>            : 
<a name="613"><span class="lineNum">     613 </span>            : </a>
<span class="lineNum">     614 </span>            : /* Make all the candidates we can make at the beginning */
<span class="lineNum">     615 </span><span class="lineNoCov">          0 : int nr_ice_component_initialize(struct nr_ice_ctx_ *ctx,nr_ice_component *component)</span>
<span class="lineNum">     616 </span>            :   {
<span class="lineNum">     617 </span>            :     int r,_status;
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     nr_local_addr *addrs=ctx-&gt;local_addrs;</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     int addr_ct=ctx-&gt;local_addr_ct;</span>
<span class="lineNum">     620 </span>            :     char *lufrag;
<span class="lineNum">     621 </span>            :     char *lpwd;
<span class="lineNum">     622 </span>            :     Data pwd;
<span class="lineNum">     623 </span>            :     nr_ice_candidate *cand;
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :     if (component-&gt;candidate_ct) {</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_DEBUG,&quot;ICE(%s): component with id %d already has candidates, probably restarting gathering because of a new stream&quot;,ctx-&gt;label,component-&gt;component_id);</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">     628 </span>            :     }
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE(%s): initializing component with id %d&quot;,ctx-&gt;label,component-&gt;component_id);</span>
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :     if(addr_ct==0){</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_ERR,&quot;ICE(%s): no local addresses available&quot;,ctx-&gt;label);</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :       ABORT(R_NOT_FOUND);</span>
<span class="lineNum">     635 </span>            :     }
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span>            :     /* Note: we need to recompute these because
<span class="lineNum">     638 </span>            :        we have not yet computed the values in the peer media stream.*/
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :     lufrag=component-&gt;stream-&gt;ufrag ? component-&gt;stream-&gt;ufrag : ctx-&gt;ufrag;</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :     assert(lufrag);</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :     if (!lufrag)</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :       ABORT(R_INTERNAL);</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :     lpwd=component-&gt;stream-&gt;pwd ? component-&gt;stream-&gt;pwd :ctx-&gt;pwd;</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :     assert(lpwd);</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :     if (!lpwd)</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :       ABORT(R_INTERNAL);</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :     INIT_DATA(pwd, (UCHAR *)lpwd, strlen(lpwd));</span>
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span>            :     /* Initialize the UDP candidates */
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :     if (r=nr_ice_component_initialize_udp(ctx, component, addrs, addr_ct, lufrag, &amp;pwd))</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_INFO,&quot;ICE(%s): failed to create UDP candidates with error %d&quot;,ctx-&gt;label,r);</span>
<span class="lineNum">     652 </span>            :     /* And the TCP candidates */
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :     if (r=nr_ice_component_initialize_tcp(ctx, component, addrs, addr_ct, lufrag, &amp;pwd))</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_INFO,&quot;ICE(%s): failed to create TCP candidates with error %d&quot;,ctx-&gt;label,r);</span>
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span>            :     /* count the candidates that will be initialized */
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :     cand=TAILQ_FIRST(&amp;component-&gt;candidates);</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :     if(!cand){</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_ERR,&quot;ICE(%s): couldn't create any valid candidates&quot;,ctx-&gt;label);</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :       ABORT(R_NOT_FOUND);</span>
<span class="lineNum">     661 </span>            :     }
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :     while(cand){</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :       ctx-&gt;uninitialized_candidates++;</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :       cand=TAILQ_NEXT(cand,entry_comp);</span>
<span class="lineNum">     666 </span>            :     }
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span>            :     /* Now initialize all the candidates */
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :     cand=TAILQ_FIRST(&amp;component-&gt;candidates);</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :     while(cand){</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :       if(cand-&gt;state!=NR_ICE_CAND_STATE_INITIALIZING){</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :         nr_ice_candidate_initialize(cand,nr_ice_gather_finished_cb,cand);</span>
<span class="lineNum">     673 </span>            :       }
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :       cand=TAILQ_NEXT(cand,entry_comp);</span>
<span class="lineNum">     675 </span>            :     }
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">     677 </span>            :  abort:
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="679"><span class="lineNum">     679 </span>            :   }</a>
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span><span class="lineNoCov">          0 : static int nr_ice_any_peer_paired(nr_ice_candidate* cand) {</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :   nr_ice_peer_ctx* pctx=STAILQ_FIRST(&amp;cand-&gt;ctx-&gt;peers);</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :   while(pctx &amp;&amp; pctx-&gt;state == NR_ICE_PEER_STATE_UNPAIRED){</span>
<span class="lineNum">     684 </span>            :     /* Is it worth actually looking through the check lists? Probably not. */
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :     pctx=STAILQ_NEXT(pctx,entry);</span>
<span class="lineNum">     686 </span>            :   }
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :   return pctx != NULL;</span>
<span class="lineNum">     688 </span>            : }
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span>            : /*
<span class="lineNum">     691 </span>            :   Compare this newly initialized candidate against the other initialized
<span class="lineNum">     692 </span>            :   candidates and discard the lower-priority one if they are redundant.
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span>            :    This algorithm combined with the other algorithms, favors
<a name="695"><span class="lineNum">     695 </span>            :    host &gt; srflx &gt; relay</a>
<span class="lineNum">     696 </span>            :  */
<span class="lineNum">     697 </span><span class="lineNoCov">          0 : int nr_ice_component_maybe_prune_candidate(nr_ice_ctx *ctx, nr_ice_component *comp, nr_ice_candidate *c1, int *was_pruned)</span>
<span class="lineNum">     698 </span>            :   {
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :     nr_ice_candidate *c2, *tmp = NULL;</span>
<span class="lineNum">     700 </span>            : 
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :     *was_pruned = 0;</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :     c2 = TAILQ_FIRST(&amp;comp-&gt;candidates);</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :     while(c2){</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :       if((c1 != c2) &amp;&amp;</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :          (c2-&gt;state == NR_ICE_CAND_STATE_INITIALIZED) &amp;&amp;</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :          !nr_transport_addr_cmp(&amp;c1-&gt;base,&amp;c2-&gt;base,NR_TRANSPORT_ADDR_CMP_MODE_ALL) &amp;&amp;</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :          !nr_transport_addr_cmp(&amp;c1-&gt;addr,&amp;c2-&gt;addr,NR_TRANSPORT_ADDR_CMP_MODE_ALL)){</span>
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :         if((c1-&gt;type == c2-&gt;type) ||</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :            (!(ctx-&gt;flags &amp; NR_ICE_CTX_FLAGS_HIDE_HOST_CANDIDATES) &amp;&amp;</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :             ((c1-&gt;type==HOST &amp;&amp; c2-&gt;type == SERVER_REFLEXIVE) ||</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :              (c2-&gt;type==HOST &amp;&amp; c1-&gt;type == SERVER_REFLEXIVE)))){</span>
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span>            :           /*
<span class="lineNum">     715 </span>            :              These are redundant. Remove the lower pri one, or if pairing has
<span class="lineNum">     716 </span>            :              already occurred, remove the newest one.
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span>            :              Since this algorithmis run whenever a new candidate
<span class="lineNum">     719 </span>            :              is initialized, there should at most one duplicate.
<span class="lineNum">     720 </span>            :            */
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :           if ((c1-&gt;priority &lt;= c2-&gt;priority) || nr_ice_any_peer_paired(c2)) {</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :             tmp = c1;</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :             *was_pruned = 1;</span>
<span class="lineNum">     724 </span>            :           }
<span class="lineNum">     725 </span>            :           else {
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :             tmp = c2;</span>
<span class="lineNum">     727 </span>            :           }
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">     729 </span>            :         }
<span class="lineNum">     730 </span>            :       }
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :       c2=TAILQ_NEXT(c2,entry_comp);</span>
<span class="lineNum">     733 </span>            :     }
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :     if (tmp) {</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_DEBUG,&quot;ICE(%s)/CAND(%s): Removing redundant candidate&quot;,</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :             ctx-&gt;label,tmp-&gt;label);</span>
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :       TAILQ_REMOVE(&amp;comp-&gt;candidates,tmp,entry_comp);</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :       comp-&gt;candidate_ct--;</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :       TAILQ_REMOVE(&amp;tmp-&gt;isock-&gt;candidates,tmp,entry_sock);</span>
<span class="lineNum">     742 </span>            : 
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :       nr_ice_candidate_destroy(&amp;tmp);</span>
<span class="lineNum">     744 </span>            :     }
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     return 0;</span>
<a name="747"><span class="lineNum">     747 </span>            :   }</a>
<span class="lineNum">     748 </span>            : 
<span class="lineNum">     749 </span><span class="lineNoCov">          0 : static int nr_ice_component_pair_matches_check(nr_ice_component *comp, nr_ice_cand_pair *pair, nr_transport_addr *local_addr, nr_stun_server_request *req)</span>
<span class="lineNum">     750 </span>            :   {
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :     if(pair-&gt;remote-&gt;component-&gt;component_id!=comp-&gt;component_id)</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :     if(nr_transport_addr_cmp(&amp;pair-&gt;local-&gt;base,local_addr,NR_TRANSPORT_ADDR_CMP_MODE_ALL))</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     if(nr_transport_addr_cmp(&amp;pair-&gt;remote-&gt;addr,&amp;req-&gt;src_addr,NR_TRANSPORT_ADDR_CMP_MODE_ALL))</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     return(1);</span>
<a name="761"><span class="lineNum">     761 </span>            :   }</a>
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineNoCov">          0 : static int nr_ice_component_handle_triggered_check(nr_ice_component *comp, nr_ice_cand_pair *pair, nr_stun_server_request *req, int *error)</span>
<span class="lineNum">     764 </span>            :   {
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :     nr_stun_message *sreq=req-&gt;request;</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :     int r=0,_status;</span>
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :     if(nr_stun_message_has_attribute(sreq,NR_STUN_ATTR_USE_CANDIDATE,0)){</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :       if(comp-&gt;stream-&gt;pctx-&gt;controlling){</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_WARNING,&quot;ICE-PEER(%s)/CAND_PAIR(%s): Peer sent USE-CANDIDATE but is controlled&quot;,comp-&gt;stream-&gt;pctx-&gt;label, pair-&gt;codeword);</span>
<span class="lineNum">     771 </span>            :       }
<span class="lineNum">     772 </span>            :       else{
<span class="lineNum">     773 </span>            :         /* If this is the first time we've noticed this is nominated...*/
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :         pair-&gt;peer_nominated=1;</span>
<span class="lineNum">     775 </span>            : 
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :         if(pair-&gt;state==NR_ICE_PAIR_STATE_SUCCEEDED &amp;&amp; !pair-&gt;nominated){</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :           pair-&gt;nominated=1;</span>
<span class="lineNum">     778 </span>            : 
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :           if(r=nr_ice_component_nominated_pair(pair-&gt;remote-&gt;component, pair)) {</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :             *error=(r==R_NO_MEMORY)?500:400;</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :             ABORT(r);</span>
<span class="lineNum">     782 </span>            :           }
<span class="lineNum">     783 </span>            :         }
<span class="lineNum">     784 </span>            :       }
<span class="lineNum">     785 </span>            :     }
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span>            :     /* Note: the RFC says to trigger first and then nominate. But in that case
<span class="lineNum">     788 </span>            :      * the canceled trigger pair would get nominated and the cloned trigger pair
<span class="lineNum">     789 </span>            :      * would not get the nomination status cloned with it.*/
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :     if(r=nr_ice_candidate_pair_do_triggered_check(comp-&gt;stream-&gt;pctx,pair)) {</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :       *error=(r==R_NO_MEMORY)?500:400;</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     793 </span>            :     }
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">     796 </span>            :   abort:
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :     return(r);</span>
<span class="lineNum">     798 </span>            :   }
<a name="799"><span class="lineNum">     799 </span>            : </a>
<span class="lineNum">     800 </span>            : /* Section 7.2.1 */
<span class="lineNum">     801 </span><span class="lineNoCov">          0 : static int nr_ice_component_process_incoming_check(nr_ice_component *comp, nr_transport_addr *local_addr, nr_stun_server_request *req, int *error)</span>
<span class="lineNum">     802 </span>            :   {
<span class="lineNum">     803 </span>            :     nr_ice_cand_pair *pair;
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :     nr_ice_candidate *pcand=0;</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :     nr_stun_message *sreq=req-&gt;request;</span>
<span class="lineNum">     806 </span>            :     nr_stun_message_attribute *attr;
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :     int r=0,_status;</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :     int found_valid=0;</span>
<span class="lineNum">     809 </span>            : 
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d): received request from %s&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id,req-&gt;src_addr.as_string);</span>
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :     if (comp-&gt;state == NR_ICE_COMPONENT_DISABLED)</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :       ABORT(R_REJECTED);</span>
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span>            :     /* Check for role conficts (7.2.1.1) */
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :     if(comp-&gt;stream-&gt;pctx-&gt;controlling){</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :       if(nr_stun_message_has_attribute(sreq,NR_STUN_ATTR_ICE_CONTROLLING,&amp;attr)){</span>
<span class="lineNum">     818 </span>            :         /* OK, there is a conflict. Who's right? */
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s): role conflict, both controlling&quot;,comp-&gt;stream-&gt;pctx-&gt;label);</span>
<span class="lineNum">     820 </span>            : 
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :         if(attr-&gt;u.ice_controlling &gt; comp-&gt;stream-&gt;pctx-&gt;tiebreaker){</span>
<span class="lineNum">     822 </span>            :           /* Update the peer ctx. This will propagate to all candidate pairs
<span class="lineNum">     823 </span>            :              in the context. */
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :           nr_ice_peer_ctx_switch_controlling_role(comp-&gt;stream-&gt;pctx);</span>
<span class="lineNum">     825 </span>            :         }
<span class="lineNum">     826 </span>            :         else {
<span class="lineNum">     827 </span>            :           /* We are: throw an error */
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :           r_log(LOG_ICE,LOG_WARNING,&quot;ICE-PEER(%s): returning 487 role conflict&quot;,comp-&gt;stream-&gt;pctx-&gt;label);</span>
<span class="lineNum">     829 </span>            : 
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :           *error=487;</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :           ABORT(R_REJECTED);</span>
<span class="lineNum">     832 </span>            :         }
<span class="lineNum">     833 </span>            :       }
<span class="lineNum">     834 </span>            :     }
<span class="lineNum">     835 </span>            :     else{
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :       if(nr_stun_message_has_attribute(sreq,NR_STUN_ATTR_ICE_CONTROLLED,&amp;attr)){</span>
<span class="lineNum">     837 </span>            :         /* OK, there is a conflict. Who's right? */
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s): role conflict, both controlled&quot;,comp-&gt;stream-&gt;pctx-&gt;label);</span>
<span class="lineNum">     839 </span>            : 
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :         if(attr-&gt;u.ice_controlled &lt; comp-&gt;stream-&gt;pctx-&gt;tiebreaker){</span>
<span class="lineNum">     841 </span>            :           /* Update the peer ctx. This will propagate to all candidate pairs
<span class="lineNum">     842 </span>            :              in the context. */
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :           nr_ice_peer_ctx_switch_controlling_role(comp-&gt;stream-&gt;pctx);</span>
<span class="lineNum">     844 </span>            :         }
<span class="lineNum">     845 </span>            :         else {
<span class="lineNum">     846 </span>            :           /* We are: throw an error */
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :           r_log(LOG_ICE,LOG_WARNING,&quot;ICE-PEER(%s): returning 487 role conflict&quot;,comp-&gt;stream-&gt;pctx-&gt;label);</span>
<span class="lineNum">     848 </span>            : 
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :           *error=487;</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :           ABORT(R_REJECTED);</span>
<span class="lineNum">     851 </span>            :         }
<span class="lineNum">     852 </span>            :       }
<span class="lineNum">     853 </span>            :     }
<span class="lineNum">     854 </span>            : 
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s): This STUN request appears to map to local addr %s&quot;,comp-&gt;stream-&gt;pctx-&gt;label,local_addr-&gt;as_string);</span>
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :     pair=TAILQ_FIRST(&amp;comp-&gt;stream-&gt;check_list);</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :     while(pair){</span>
<span class="lineNum">     859 </span>            :       /* Since triggered checks create duplicate pairs (in this implementation)
<span class="lineNum">     860 </span>            :        * we are willing to handle multiple matches here. */
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :       if(nr_ice_component_pair_matches_check(comp, pair, local_addr, req)){</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/CAND_PAIR(%s): Found a matching pair for received check: %s&quot;,comp-&gt;stream-&gt;pctx-&gt;label,pair-&gt;codeword,pair-&gt;as_string);</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :         if(r=nr_ice_component_handle_triggered_check(comp, pair, req, error))</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :         ++found_valid;</span>
<span class="lineNum">     866 </span>            :       }
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :       pair=TAILQ_NEXT(pair,check_queue_entry);</span>
<span class="lineNum">     868 </span>            :     }
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     if(!found_valid){</span>
<span class="lineNum">     871 </span>            :       /* There were no matching pairs, so we need to create a new peer
<span class="lineNum">     872 </span>            :        * reflexive candidate pair. */
<span class="lineNum">     873 </span>            : 
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :       if(!nr_stun_message_has_attribute(sreq,NR_STUN_ATTR_PRIORITY,&amp;attr)){</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_WARNING,&quot;ICE-PEER(%s): Rejecting stun request without priority&quot;,comp-&gt;stream-&gt;pctx-&gt;label);</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :         *error=400;</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :         ABORT(R_BAD_DATA);</span>
<span class="lineNum">     878 </span>            :       }
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span>            :       /* Find our local component candidate */
<span class="lineNum">     881 </span>            :       nr_ice_candidate *cand;
<span class="lineNum">     882 </span>            : 
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s): no matching pair&quot;,comp-&gt;stream-&gt;pctx-&gt;label);</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :       cand=TAILQ_FIRST(&amp;comp-&gt;local_component-&gt;candidates);</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :       while(cand){</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :         if(!nr_transport_addr_cmp(&amp;cand-&gt;addr,local_addr,NR_TRANSPORT_ADDR_CMP_MODE_ALL))</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">     888 </span>            : 
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :         cand=TAILQ_NEXT(cand,entry_comp);</span>
<span class="lineNum">     890 </span>            :       }
<span class="lineNum">     891 </span>            : 
<span class="lineNum">     892 </span>            :       /* Well, this really shouldn't happen, but it's an error from the
<span class="lineNum">     893 </span>            :          other side, so we just throw an error and keep going */
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :       if(!cand){</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_WARNING,&quot;ICE-PEER(%s): stun request to unknown local address %s, discarding&quot;,comp-&gt;stream-&gt;pctx-&gt;label,local_addr-&gt;as_string);</span>
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :         *error=400;</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :         ABORT(R_NOT_FOUND);</span>
<span class="lineNum">     899 </span>            :       }
<span class="lineNum">     900 </span>            : 
<span class="lineNum">     901 </span>            :       /* Now make a peer reflexive (remote) candidate */
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :       if(r=nr_ice_peer_peer_rflx_candidate_create(comp-&gt;stream-&gt;pctx-&gt;ctx,&quot;prflx&quot;,comp,&amp;req-&gt;src_addr,&amp;pcand)) {</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :         *error=(r==R_NO_MEMORY)?500:400;</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     905 </span>            :       }
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :       pcand-&gt;priority=attr-&gt;u.priority;</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :       pcand-&gt;state=NR_ICE_CAND_PEER_CANDIDATE_PAIRED;</span>
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span>            :       /* Finally, create the candidate pair, insert into the check list, and
<span class="lineNum">     910 </span>            :        * apply the incoming check to it. */
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :       if(r=nr_ice_candidate_pair_create(comp-&gt;stream-&gt;pctx,cand,pcand,</span>
<span class="lineNum">     912 </span>            :            &amp;pair)) {
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :         *error=(r==R_NO_MEMORY)?500:400;</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     915 </span>            :       }
<span class="lineNum">     916 </span>            : 
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :       nr_ice_candidate_pair_set_state(pair-&gt;pctx,pair,NR_ICE_PAIR_STATE_FROZEN);</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :       if(r=nr_ice_component_insert_pair(comp,pair)) {</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :         *error=(r==R_NO_MEMORY)?500:400;</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :         nr_ice_candidate_pair_destroy(&amp;pair);</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     922 </span>            :       }
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span>            :       /* Do this last, since any call to ABORT will destroy pcand */
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :       TAILQ_INSERT_TAIL(&amp;comp-&gt;candidates,pcand,entry_comp);</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :       pcand=0;</span>
<span class="lineNum">     927 </span>            : 
<span class="lineNum">     928 </span>            :       /* Finally start the trigger check if needed */
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :       if(r=nr_ice_component_handle_triggered_check(comp, pair, req, error))</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">     931 </span>            :     }
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">     934 </span>            :   abort:
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :     if(_status){</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :       nr_ice_candidate_destroy(&amp;pcand);</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :       assert(*error != 0);</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :       if(r!=R_NO_MEMORY) assert(*error != 500);</span>
<span class="lineNum">     939 </span>            :     }
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="941"><span class="lineNum">     941 </span>            :   }</a>
<span class="lineNum">     942 </span>            : 
<span class="lineNum">     943 </span><span class="lineNoCov">          0 : static int nr_ice_component_stun_server_cb(void *cb_arg,nr_stun_server_ctx *stun_ctx,nr_socket *sock, nr_stun_server_request *req, int *dont_free, int *error)</span>
<span class="lineNum">     944 </span>            :   {
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :     nr_ice_component *comp=cb_arg;</span>
<span class="lineNum">     946 </span>            :     nr_transport_addr local_addr;
<span class="lineNum">     947 </span>            :     int r,_status;
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :     if(comp-&gt;state==NR_ICE_COMPONENT_FAILED) {</span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :       *error=400;</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :       ABORT(R_REJECTED);</span>
<span class="lineNum">     952 </span>            :     }
<span class="lineNum">     953 </span>            : 
<span class="lineNum">     954 </span>            :     /* Find the candidate pair that this maps to */
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :     if(r=nr_socket_getaddr(sock,&amp;local_addr)) {</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :       *error=500;</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     958 </span>            :     }
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :     if (r=nr_ice_component_process_incoming_check(comp, &amp;local_addr, req, error))</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">     962 </span>            : 
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">     964 </span>            :  abort:
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="966"><span class="lineNum">     966 </span>            :   }</a>
<span class="lineNum">     967 </span>            : 
<span class="lineNum">     968 </span><span class="lineNoCov">          0 : int nr_ice_component_service_pre_answer_requests(nr_ice_peer_ctx *pctx, nr_ice_component *pcomp, char *username, int *serviced)</span>
<span class="lineNum">     969 </span>            :   {
<span class="lineNum">     970 </span>            :     nr_ice_pre_answer_request *r1,*r2;
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :     nr_ice_component *comp = pcomp-&gt;local_component;</span>
<span class="lineNum">     972 </span>            :     int r,_status;
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :     if (serviced)</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :       *serviced = 0;</span>
<span class="lineNum">     976 </span>            : 
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d): looking for pre-answer requests&quot;,pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id);</span>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :     STAILQ_FOREACH_SAFE(r1, &amp;comp-&gt;pre_answer_reqs, entry, r2) {</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :       if (!strcmp(r1-&gt;username, username)) {</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :         int error = 0;</span>
<span class="lineNum">     982 </span>            : 
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d): found pre-answer request&quot;,pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id);</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :         r = nr_ice_component_process_incoming_check(pcomp, &amp;r1-&gt;local_addr, &amp;r1-&gt;req, &amp;error);</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :         if (r) {</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :           r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d): error processing pre-answer request. Would have returned %d&quot;,pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id, error);</span>
<span class="lineNum">     987 </span>            :         }
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :         (*serviced)++;</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :         STAILQ_REMOVE(&amp;comp-&gt;pre_answer_reqs,r1,nr_ice_pre_answer_request_, entry);</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :         nr_ice_pre_answer_request_destroy(&amp;r1);</span>
<span class="lineNum">     991 </span>            :       }
<span class="lineNum">     992 </span>            :     }
<span class="lineNum">     993 </span>            : 
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :      return(_status);</span>
<a name="996"><span class="lineNum">     996 </span>            :   }</a>
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span><span class="lineNoCov">          0 : int nr_ice_component_can_candidate_tcptype_pair(nr_socket_tcp_type left, nr_socket_tcp_type right)</span>
<span class="lineNum">     999 </span>            :   {
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :     if (left &amp;&amp; !right)</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :     if (!left &amp;&amp; right)</span>
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :     if (left == TCP_TYPE_ACTIVE &amp;&amp; right != TCP_TYPE_PASSIVE)</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :     if (left == TCP_TYPE_SO &amp;&amp; right != TCP_TYPE_SO)</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :     if (left == TCP_TYPE_PASSIVE)</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :     return(1);</span>
<span class="lineNum">    1012 </span>            :   }
<a name="1013"><span class="lineNum">    1013 </span>            : </a>
<span class="lineNum">    1014 </span>            : /* filter out pairings which won't work. */
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 : int nr_ice_component_can_candidate_addr_pair(nr_transport_addr *local, nr_transport_addr *remote)</span>
<span class="lineNum">    1016 </span>            :   {
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :     if(local-&gt;ip_version != remote-&gt;ip_version)</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :     if(nr_transport_addr_is_link_local(local) !=</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :        nr_transport_addr_is_link_local(remote))</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">    1022 </span>            :     /* This prevents our ice_unittest (or broken clients) from pairing a
<span class="lineNum">    1023 </span>            :      * loopback with a host candidate. */
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :     if(nr_transport_addr_is_loopback(local) !=</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :        nr_transport_addr_is_loopback(remote))</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :       return(0);</span>
<span class="lineNum">    1027 </span>            : 
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :     return(1);</span>
<a name="1029"><span class="lineNum">    1029 </span>            :   }</a>
<span class="lineNum">    1030 </span>            : 
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 : int nr_ice_component_pair_candidate(nr_ice_peer_ctx *pctx, nr_ice_component *pcomp, nr_ice_candidate *lcand, int pair_all_remote)</span>
<span class="lineNum">    1032 </span>            :   {
<span class="lineNum">    1033 </span>            :     int r, _status;
<span class="lineNum">    1034 </span>            :     nr_ice_candidate *pcand;
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :     nr_ice_cand_pair *pair=0;</span>
<span class="lineNum">    1036 </span>            :     char codeword[5];
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :     nr_ice_compute_codeword(lcand-&gt;label,strlen(lcand-&gt;label),codeword);</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/CAND(%s): Pairing local candidate %s&quot;,pctx-&gt;label,codeword,lcand-&gt;label);</span>
<span class="lineNum">    1040 </span>            : 
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :     switch(lcand-&gt;type){</span>
<span class="lineNum">    1042 </span>            :       case HOST:
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1044 </span>            :       case SERVER_REFLEXIVE:
<span class="lineNum">    1045 </span>            :       case PEER_REFLEXIVE:
<span class="lineNum">    1046 </span>            :         /* Don't actually pair these candidates */
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :         goto done;</span>
<span class="lineNum">    1048 </span>            :         break;
<span class="lineNum">    1049 </span>            :       case RELAYED:
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1051 </span>            :       default:
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :         assert(0);</span>
<span class="lineNum">    1053 </span>            :         ABORT(R_INTERNAL);
<span class="lineNum">    1054 </span>            :         break;
<span class="lineNum">    1055 </span>            :     }
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :     TAILQ_FOREACH(pcand, &amp;pcomp-&gt;candidates, entry_comp){</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :       if(!nr_ice_component_can_candidate_addr_pair(&amp;lcand-&gt;addr, &amp;pcand-&gt;addr))</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :       if(!nr_ice_component_can_candidate_tcptype_pair(lcand-&gt;tcp_type, pcand-&gt;tcp_type))</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1062 </span>            : 
<span class="lineNum">    1063 </span>            :       /*
<span class="lineNum">    1064 </span>            :         Two modes, depending on |pair_all_remote|
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span>            :         1. Pair remote candidates which have not been paired
<span class="lineNum">    1067 </span>            :            (used in initial pairing or in processing the other side's
<span class="lineNum">    1068 </span>            :            trickle candidates).
<span class="lineNum">    1069 </span>            :         2. Pair any remote candidate (used when processing our own
<span class="lineNum">    1070 </span>            :            trickle candidates).
<span class="lineNum">    1071 </span>            :       */
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :       if (pair_all_remote || (pcand-&gt;state == NR_ICE_CAND_PEER_CANDIDATE_UNPAIRED)) {</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :         if (pair_all_remote) {</span>
<span class="lineNum">    1074 </span>            :           /* When a remote candidate arrives after the start of checking, but
<span class="lineNum">    1075 </span>            :            * before the gathering of local candidates, it can be in UNPAIRED */
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :           pcand-&gt;state = NR_ICE_CAND_PEER_CANDIDATE_PAIRED;</span>
<span class="lineNum">    1077 </span>            :         }
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :         nr_ice_compute_codeword(pcand-&gt;label,strlen(pcand-&gt;label),codeword);</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/CAND(%s): Pairing with peer candidate %s&quot;, pctx-&gt;label, codeword, pcand-&gt;label);</span>
<span class="lineNum">    1081 </span>            : 
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :         if(r=nr_ice_candidate_pair_create(pctx,lcand,pcand,&amp;pair))</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">    1084 </span>            : 
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :         if(r=nr_ice_component_insert_pair(pcomp, pair))</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">    1087 </span>            :       }
<span class="lineNum">    1088 </span>            :     }
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span>            :    done:
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :     _status = 0;</span>
<span class="lineNum">    1092 </span>            :    abort:
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="1094"><span class="lineNum">    1094 </span>            :   }</a>
<span class="lineNum">    1095 </span>            : 
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 : int nr_ice_component_pair_candidates(nr_ice_peer_ctx *pctx, nr_ice_component *lcomp,nr_ice_component *pcomp)</span>
<span class="lineNum">    1097 </span>            :   {
<span class="lineNum">    1098 </span>            :     nr_ice_candidate *lcand, *pcand;
<span class="lineNum">    1099 </span>            :     nr_ice_socket *isock;
<span class="lineNum">    1100 </span>            :     int r,_status;
<span class="lineNum">    1101 </span>            : 
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;Pairing candidates======&quot;);</span>
<span class="lineNum">    1103 </span>            : 
<span class="lineNum">    1104 </span>            :     /* Create the candidate pairs */
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :     lcand=TAILQ_FIRST(&amp;lcomp-&gt;candidates);</span>
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :     if (!lcand) {</span>
<span class="lineNum">    1108 </span>            :       /* No local candidates, initialized or not! */
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :       ABORT(R_FAILED);</span>
<span class="lineNum">    1110 </span>            :     }
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :     while(lcand){</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :       if (lcand-&gt;state == NR_ICE_CAND_STATE_INITIALIZED) {</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :         if ((r = nr_ice_component_pair_candidate(pctx, pcomp, lcand, 0)))</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">    1116 </span>            :       }
<span class="lineNum">    1117 </span>            : 
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :       lcand=TAILQ_NEXT(lcand,entry_comp);</span>
<span class="lineNum">    1119 </span>            :     }
<span class="lineNum">    1120 </span>            : 
<span class="lineNum">    1121 </span>            :     /* Mark all peer candidates as paired */
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :     pcand=TAILQ_FIRST(&amp;pcomp-&gt;candidates);</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :     while(pcand){</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :       pcand-&gt;state = NR_ICE_CAND_PEER_CANDIDATE_PAIRED;</span>
<span class="lineNum">    1125 </span>            : 
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :       pcand=TAILQ_NEXT(pcand,entry_comp);</span>
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span>            :     }
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span>            :     /* Now register the STUN server callback for this component.
<span class="lineNum">    1131 </span>            :        Note that this is a per-component CB so we only need to
<span class="lineNum">    1132 </span>            :        do this once.
<span class="lineNum">    1133 </span>            :     */
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :     if (pcomp-&gt;state != NR_ICE_COMPONENT_RUNNING) {</span>
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :       isock=STAILQ_FIRST(&amp;lcomp-&gt;sockets);</span>
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :       while(isock){</span>
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :         if(r=nr_stun_server_add_client(isock-&gt;stun_server,pctx-&gt;label,</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :           pcomp-&gt;stream-&gt;r2l_user,&amp;pcomp-&gt;stream-&gt;r2l_pass,nr_ice_component_stun_server_cb,pcomp)) {</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :             ABORT(r);</span>
<span class="lineNum">    1140 </span>            :         }
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :         isock=STAILQ_NEXT(isock,entry);</span>
<span class="lineNum">    1142 </span>            :       }
<span class="lineNum">    1143 </span>            :     }
<span class="lineNum">    1144 </span>            : 
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :     pcomp-&gt;state = NR_ICE_COMPONENT_RUNNING;</span>
<span class="lineNum">    1146 </span>            : 
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1148 </span>            :   abort:
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="1150"><span class="lineNum">    1150 </span>            :   }</a>
<span class="lineNum">    1151 </span>            : 
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 : int nr_ice_pre_answer_enqueue(nr_ice_component *comp, nr_socket *sock, nr_stun_server_request *req, int *dont_free)</span>
<span class="lineNum">    1153 </span>            :   {
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :     int r = 0;</span>
<span class="lineNum">    1155 </span>            :     int _status;
<span class="lineNum">    1156 </span>            :     nr_ice_pre_answer_request *r1, *r2;
<span class="lineNum">    1157 </span>            :     nr_transport_addr dst_addr;
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :     nr_ice_pre_answer_request *par = 0;</span>
<span class="lineNum">    1159 </span>            : 
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :     if (r=nr_socket_getaddr(sock, &amp;dst_addr))</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1162 </span>            : 
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :     STAILQ_FOREACH_SAFE(r1, &amp;comp-&gt;pre_answer_reqs, entry, r2) {</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :       if (!nr_transport_addr_cmp(&amp;r1-&gt;local_addr, &amp;dst_addr,</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :                                  NR_TRANSPORT_ADDR_CMP_MODE_ALL) &amp;&amp;</span>
<span class="lineNum">    1166 </span><span class="lineNoCov">          0 :           !nr_transport_addr_cmp(&amp;r1-&gt;req.src_addr, &amp;req-&gt;src_addr,</span>
<span class="lineNum">    1167 </span>            :                                  NR_TRANSPORT_ADDR_CMP_MODE_ALL)) {
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :         return(0);</span>
<span class="lineNum">    1169 </span>            :       }
<span class="lineNum">    1170 </span>            :     }
<span class="lineNum">    1171 </span>            : 
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :     if (r=nr_ice_pre_answer_request_create(&amp;dst_addr, req, &amp;par))</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1174 </span>            : 
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG, &quot;ICE(%s)/STREAM(%s)/COMP(%d): Enqueuing STUN request pre-answer from %s&quot;,</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :           comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id,</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :           req-&gt;src_addr.as_string);</span>
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :     *dont_free = 1;</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :     STAILQ_INSERT_TAIL(&amp;comp-&gt;pre_answer_reqs, par, entry);</span>
<span class="lineNum">    1181 </span>            : 
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1183 </span>            : abort:
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :     return(_status);</span>
<span class="lineNum">    1185 </span>            :   }
<span class="lineNum">    1186 </span>            : 
<span class="lineNum">    1187 </span>            : /* Fires when we have an incoming candidate that doesn't correspond to an existing
<span class="lineNum">    1188 </span>            :    remote peer. This is either pre-answer or just spurious. Store it in the
<span class="lineNum">    1189 </span>            :    component for use when we see the actual answer, at which point we need
<a name="1190"><span class="lineNum">    1190 </span>            :    to do the procedures from S 7.2.1 in nr_ice_component_stun_server_cb.</a>
<span class="lineNum">    1191 </span>            :  */
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 : static int nr_ice_component_stun_server_default_cb(void *cb_arg,nr_stun_server_ctx *stun_ctx,nr_socket *sock, nr_stun_server_request *req, int *dont_free, int *error)</span>
<span class="lineNum">    1193 </span>            :   {
<span class="lineNum">    1194 </span>            :     int r, _status;
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :     nr_ice_component *comp = (nr_ice_component *)cb_arg;</span>
<span class="lineNum">    1196 </span>            : 
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE(%s)/STREAM(%s)/COMP(%d): Received STUN request pre-answer from %s&quot;,</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :           comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id,</span>
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :           req-&gt;src_addr.as_string);</span>
<span class="lineNum">    1200 </span>            : 
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :     if (r=nr_ice_pre_answer_enqueue(comp, sock, req, dont_free)) {</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_ERR,&quot;ICE(%s)/STREAM(%s)/COMP(%d): Failed (%d) to enque pre-answer request from %s&quot;,</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :           comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id, r,</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :           req-&gt;src_addr.as_string);</span>
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1206 </span>            :     }
<span class="lineNum">    1207 </span>            : 
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1209 </span>            :  abort:
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :     return(_status);</span>
<span class="lineNum">    1211 </span>            :   }
<span class="lineNum">    1212 </span>            : 
<span class="lineNum">    1213 </span>            : #define NR_ICE_CONSENT_TIMER_DEFAULT 5000
<a name="1214"><span class="lineNum">    1214 </span>            : #define NR_ICE_CONSENT_TIMEOUT_DEFAULT 30000</a>
<span class="lineNum">    1215 </span>            : 
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 : static void nr_ice_component_consent_failed(nr_ice_component *comp)</span>
<span class="lineNum">    1217 </span>            :   {
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :     if (!comp-&gt;can_send) {</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1220 </span>            :     }
<span class="lineNum">    1221 </span>            : 
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_INFO,&quot;ICE(%s)/STREAM(%s)/COMP(%d): Consent refresh failed&quot;,</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :           comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id);</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :     comp-&gt;can_send = 0;</span>
<span class="lineNum">    1225 </span>            : 
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :     if (comp-&gt;consent_timeout) {</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :       NR_async_timer_cancel(comp-&gt;consent_timeout);</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :       comp-&gt;consent_timeout = 0;</span>
<span class="lineNum">    1229 </span>            :     }
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :     if (comp-&gt;consent_timer) {</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :       NR_async_timer_cancel(comp-&gt;consent_timer);</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :       comp-&gt;consent_timer = 0;</span>
<span class="lineNum">    1233 </span>            :     }
<span class="lineNum">    1234 </span>            :     /* We are turning the consent failure into a ICE component failure to
<span class="lineNum">    1235 </span>            :      * alert the browser via ICE connection state change about this event. */
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :     if (nr_ice_media_stream_component_failed(comp-&gt;stream, comp))</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_ERR,&quot;ICE(%s)/STREAM(%s)/COMP(%d): failed to mark component as failed&quot;,</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :         comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id);</span>
<a name="1239"><span class="lineNum">    1239 </span>            :   }</a>
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 : static void nr_ice_component_consent_timeout_cb(NR_SOCKET s, int how, void *cb_arg)</span>
<span class="lineNum">    1242 </span>            :   {
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :     nr_ice_component *comp=cb_arg;</span>
<span class="lineNum">    1244 </span>            : 
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :     comp-&gt;consent_timeout = 0;</span>
<span class="lineNum">    1246 </span>            : 
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_WARNING,&quot;ICE(%s)/STREAM(%s)/COMP(%d): Consent refresh final time out&quot;,</span>
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 :           comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id);</span>
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_failed(comp);</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :   }</span>
<a name="1251"><span class="lineNum">    1251 </span>            : </a>
<span class="lineNum">    1252 </span>            : 
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 : void nr_ice_component_disconnected(nr_ice_component *comp)</span>
<span class="lineNum">    1254 </span>            :   {
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :     if (!comp-&gt;can_send) {</span>
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1257 </span>            :     }
<span class="lineNum">    1258 </span>            : 
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :     if (comp-&gt;disconnected) {</span>
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1261 </span>            :     }
<span class="lineNum">    1262 </span>            : 
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_WARNING,&quot;ICE(%s)/STREAM(%s)/COMP(%d): component disconnected&quot;,</span>
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :           comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id);</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :     comp-&gt;disconnected = 1;</span>
<span class="lineNum">    1266 </span>            : 
<span class="lineNum">    1267 </span>            :     /* a single disconnected component disconnects the stream */
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :     nr_ice_media_stream_set_disconnected(comp-&gt;stream, NR_ICE_MEDIA_STREAM_DISCONNECTED);</span>
<a name="1269"><span class="lineNum">    1269 </span>            :   }</a>
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 : static void nr_ice_component_consent_refreshed(nr_ice_component *comp)</span>
<span class="lineNum">    1272 </span>            :   {
<span class="lineNum">    1273 </span>            :     uint16_t tval;
<span class="lineNum">    1274 </span>            : 
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :     if (!comp-&gt;can_send) {</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1277 </span>            :     }
<span class="lineNum">    1278 </span>            : 
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :     gettimeofday(&amp;comp-&gt;consent_last_seen, 0);</span>
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE(%s)/STREAM(%s)/COMP(%d): consent_last_seen is now %lu&quot;,</span>
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :         comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id,</span>
<span class="lineNum">    1282 </span>            :         comp-&gt;consent_last_seen.tv_sec);
<span class="lineNum">    1283 </span>            : 
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :     comp-&gt;disconnected = 0;</span>
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :     nr_ice_media_stream_check_if_connected(comp-&gt;stream);</span>
<span class="lineNum">    1287 </span>            : 
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :     if (comp-&gt;consent_timeout)</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :       NR_async_timer_cancel(comp-&gt;consent_timeout);</span>
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :     tval = NR_ICE_CONSENT_TIMEOUT_DEFAULT;</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :     if (comp-&gt;ctx-&gt;test_timer_divider)</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :       tval = tval / comp-&gt;ctx-&gt;test_timer_divider;</span>
<span class="lineNum">    1294 </span>            : 
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :     NR_ASYNC_TIMER_SET(tval, nr_ice_component_consent_timeout_cb, comp,</span>
<span class="lineNum">    1296 </span>            :                        &amp;comp-&gt;consent_timeout);
<a name="1297"><span class="lineNum">    1297 </span>            :   }</a>
<span class="lineNum">    1298 </span>            : 
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 : static void nr_ice_component_refresh_consent_cb(NR_SOCKET s, int how, void *cb_arg)</span>
<span class="lineNum">    1300 </span>            :   {
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :     nr_ice_component *comp=cb_arg;</span>
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :     switch (comp-&gt;consent_ctx-&gt;state) {</span>
<span class="lineNum">    1304 </span>            :       case NR_STUN_CLIENT_STATE_FAILED:
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :         if (comp-&gt;consent_ctx-&gt;error_code == 403) {</span>
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :           r_log(LOG_ICE, LOG_INFO, &quot;ICE(%s)/STREAM(%s)/COMP(%d): Consent revoked by peer&quot;,</span>
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :                 comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id);</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :           nr_ice_component_consent_failed(comp);</span>
<span class="lineNum">    1309 </span>            :         }
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1311 </span>            :       case NR_STUN_CLIENT_STATE_DONE:
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE, LOG_INFO, &quot;ICE(%s)/STREAM(%s)/COMP(%d): Consent refreshed&quot;,</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :               comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id);</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :         nr_ice_component_consent_refreshed(comp);</span>
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1316 </span>            :       case NR_STUN_CLIENT_STATE_TIMED_OUT:
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE, LOG_INFO, &quot;ICE(%s)/STREAM(%s)/COMP(%d): A single consent refresh request timed out&quot;,</span>
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :               comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id);</span>
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :         nr_ice_component_disconnected(comp);</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1321 </span>            :       default:
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1323 </span>            :     }
<a name="1324"><span class="lineNum">    1324 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    1325 </span>            : 
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 : int nr_ice_component_refresh_consent(nr_stun_client_ctx *ctx, NR_async_cb finished_cb, void *cb_arg)</span>
<span class="lineNum">    1327 </span>            :   {
<span class="lineNum">    1328 </span>            :     int r,_status;
<span class="lineNum">    1329 </span>            : 
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :     nr_stun_client_reset(ctx);</span>
<span class="lineNum">    1331 </span>            : 
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :     if (r=nr_stun_client_start(ctx, NR_ICE_CLIENT_MODE_BINDING_REQUEST, finished_cb, cb_arg))</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1334 </span>            : 
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1336 </span>            :   abort:
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="1338"><span class="lineNum">    1338 </span>            :   }</a>
<span class="lineNum">    1339 </span>            : 
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 : void nr_ice_component_consent_calc_consent_timer(nr_ice_component *comp)</span>
<span class="lineNum">    1341 </span>            :   {
<span class="lineNum">    1342 </span>            :     uint16_t trange, trand, tval;
<span class="lineNum">    1343 </span>            : 
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :     trange = NR_ICE_CONSENT_TIMER_DEFAULT * 20 / 100;</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :     tval = NR_ICE_CONSENT_TIMER_DEFAULT - trange;</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :     if (!nr_crypto_random_bytes((UCHAR*)&amp;trand, sizeof(trand)))</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :       tval += (trand % (trange * 2));</span>
<span class="lineNum">    1348 </span>            : 
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :     if (comp-&gt;ctx-&gt;test_timer_divider)</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :       tval = tval / comp-&gt;ctx-&gt;test_timer_divider;</span>
<span class="lineNum">    1351 </span>            : 
<span class="lineNum">    1352 </span>            :     /* The timeout of the transaction is the maximum time until we send the
<span class="lineNum">    1353 </span>            :      * next consent request. */
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :     comp-&gt;consent_ctx-&gt;maximum_transmits_timeout_ms = tval;</span>
<a name="1355"><span class="lineNum">    1355 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    1356 </span>            : 
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 : static void nr_ice_component_consent_timer_cb(NR_SOCKET s, int how, void *cb_arg)</span>
<span class="lineNum">    1358 </span>            :   {
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :     nr_ice_component *comp=cb_arg;</span>
<span class="lineNum">    1360 </span>            :     int r;
<span class="lineNum">    1361 </span>            : 
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :     if (!comp-&gt;consent_ctx) {</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1364 </span>            :     }
<span class="lineNum">    1365 </span>            : 
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :     if (comp-&gt;consent_timer) {</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :       NR_async_timer_cancel(comp-&gt;consent_timer);</span>
<span class="lineNum">    1368 </span>            :     }
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     comp-&gt;consent_timer = 0;</span>
<span class="lineNum">    1370 </span>            : 
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :     comp-&gt;consent_ctx-&gt;params.ice_binding_request.username =</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :       comp-&gt;stream-&gt;l2r_user;</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :     comp-&gt;consent_ctx-&gt;params.ice_binding_request.password =</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :       comp-&gt;stream-&gt;l2r_pass;</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :     comp-&gt;consent_ctx-&gt;params.ice_binding_request.control =</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :       comp-&gt;stream-&gt;pctx-&gt;controlling?</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :       NR_ICE_CONTROLLING:NR_ICE_CONTROLLED;</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :     comp-&gt;consent_ctx-&gt;params.ice_binding_request.tiebreaker =</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :       comp-&gt;stream-&gt;pctx-&gt;tiebreaker;</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :     comp-&gt;consent_ctx-&gt;params.ice_binding_request.priority =</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :       comp-&gt;active-&gt;local-&gt;priority;</span>
<span class="lineNum">    1382 </span>            : 
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_calc_consent_timer(comp);</span>
<span class="lineNum">    1384 </span>            : 
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :     if (r=nr_ice_component_refresh_consent(comp-&gt;consent_ctx,</span>
<span class="lineNum">    1386 </span>            :                                            nr_ice_component_refresh_consent_cb,
<span class="lineNum">    1387 </span>            :                                            comp)) {
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_ERR,&quot;ICE(%s)/STREAM(%s)/COMP(%d): Refresh consent failed with %d&quot;,</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :             comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id, r);</span>
<span class="lineNum">    1390 </span>            :     }
<span class="lineNum">    1391 </span>            : 
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_schedule_consent_timer(comp);</span>
<span class="lineNum">    1393 </span>            : 
<a name="1394"><span class="lineNum">    1394 </span>            :   }</a>
<span class="lineNum">    1395 </span>            : 
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 : void nr_ice_component_consent_schedule_consent_timer(nr_ice_component *comp)</span>
<span class="lineNum">    1397 </span>            :   {
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :     if (!comp-&gt;can_send) {</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1400 </span>            :     }
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :     NR_ASYNC_TIMER_SET(comp-&gt;consent_ctx-&gt;maximum_transmits_timeout_ms,</span>
<span class="lineNum">    1403 </span>            :                        nr_ice_component_consent_timer_cb, comp,
<span class="lineNum">    1404 </span>            :                        &amp;comp-&gt;consent_timer);
<a name="1405"><span class="lineNum">    1405 </span>            :   }</a>
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 : void nr_ice_component_refresh_consent_now(nr_ice_component *comp)</span>
<span class="lineNum">    1408 </span>            :   {
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_timer_cb(0, 0, comp);</span>
<a name="1410"><span class="lineNum">    1410 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    1411 </span>            : 
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 : void nr_ice_component_consent_destroy(nr_ice_component *comp)</span>
<span class="lineNum">    1413 </span>            :   {
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :     if (comp-&gt;consent_timer) {</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :       NR_async_timer_cancel(comp-&gt;consent_timer);</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :       comp-&gt;consent_timer = 0;</span>
<span class="lineNum">    1417 </span>            :     }
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :     if (comp-&gt;consent_timeout) {</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :       NR_async_timer_cancel(comp-&gt;consent_timeout);</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :       comp-&gt;consent_timeout = 0;</span>
<span class="lineNum">    1421 </span>            :     }
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :     if (comp-&gt;consent_handle) {</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :       nr_ice_socket_deregister(comp-&gt;active-&gt;local-&gt;isock,</span>
<span class="lineNum">    1424 </span>            :                                comp-&gt;consent_handle);
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :       comp-&gt;consent_handle = 0;</span>
<span class="lineNum">    1426 </span>            :     }
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :     if (comp-&gt;consent_ctx) {</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :       nr_stun_client_ctx_destroy(&amp;comp-&gt;consent_ctx);</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :       comp-&gt;consent_ctx = 0;</span>
<span class="lineNum">    1430 </span>            :     }
<a name="1431"><span class="lineNum">    1431 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    1432 </span>            : 
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 : int nr_ice_component_setup_consent(nr_ice_component *comp)</span>
<span class="lineNum">    1434 </span>            :   {
<span class="lineNum">    1435 </span>            :     int r,_status;
<span class="lineNum">    1436 </span>            : 
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE(%s)/STREAM(%s)/COMP(%d): Setting up refresh consent&quot;,</span>
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :           comp-&gt;ctx-&gt;label, comp-&gt;stream-&gt;label, comp-&gt;component_id);</span>
<span class="lineNum">    1439 </span>            : 
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_destroy(comp);</span>
<span class="lineNum">    1441 </span>            : 
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :     if (r=nr_stun_client_ctx_create(&quot;consent&quot;, comp-&gt;active-&gt;local-&gt;osock,</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :                                     &amp;comp-&gt;active-&gt;remote-&gt;addr, 0,</span>
<span class="lineNum">    1444 </span>            :                                     &amp;comp-&gt;consent_ctx))
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1446 </span>            :     /* Consent request get send only once. */
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :     comp-&gt;consent_ctx-&gt;maximum_transmits = 1;</span>
<span class="lineNum">    1448 </span>            : 
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :     if (r=nr_ice_socket_register_stun_client(comp-&gt;active-&gt;local-&gt;isock,</span>
<span class="lineNum">    1450 </span>            :             comp-&gt;consent_ctx, &amp;comp-&gt;consent_handle))
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1452 </span>            : 
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :     comp-&gt;can_send = 1;</span>
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :     comp-&gt;disconnected = 0;</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_refreshed(comp);</span>
<span class="lineNum">    1456 </span>            : 
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_calc_consent_timer(comp);</span>
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :     nr_ice_component_consent_schedule_consent_timer(comp);</span>
<span class="lineNum">    1459 </span>            : 
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1461 </span>            :   abort:
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="1463"><span class="lineNum">    1463 </span>            :   }</a>
<span class="lineNum">    1464 </span>            : 
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 : int nr_ice_component_nominated_pair(nr_ice_component *comp, nr_ice_cand_pair *pair)</span>
<span class="lineNum">    1466 </span>            :   {
<span class="lineNum">    1467 </span>            :     int r,_status;
<span class="lineNum">    1468 </span>            :     nr_ice_cand_pair *p2;
<span class="lineNum">    1469 </span>            : 
<span class="lineNum">    1470 </span>            :     /* Are we changing what the nominated pair is? */
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :     if(comp-&gt;nominated){</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :       if(comp-&gt;nominated-&gt;priority &gt;= pair-&gt;priority)</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :         return(0);</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d)/CAND-PAIR(%s): replacing pair %s with CAND-PAIR(%s)&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id,comp-&gt;nominated-&gt;codeword,comp-&gt;nominated-&gt;as_string,pair-&gt;codeword);</span>
<span class="lineNum">    1475 </span>            :       /* As consent doesn't hold a reference to its isock this needs to happen
<span class="lineNum">    1476 </span>            :        * before making the new pair the active one. */
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :       nr_ice_component_consent_destroy(comp);</span>
<span class="lineNum">    1478 </span>            :     }
<span class="lineNum">    1479 </span>            : 
<span class="lineNum">    1480 </span>            :     /* Set the new nominated pair */
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d)/CAND-PAIR(%s): nominated pair is %s&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id,pair-&gt;codeword,pair-&gt;as_string);</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :     comp-&gt;state=NR_ICE_COMPONENT_NOMINATED;</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :     comp-&gt;nominated=pair;</span>
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :     comp-&gt;active=pair;</span>
<span class="lineNum">    1485 </span>            : 
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d)/CAND-PAIR(%s): cancelling all pairs but %s&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id,pair-&gt;codeword,pair-&gt;as_string);</span>
<span class="lineNum">    1487 </span>            : 
<span class="lineNum">    1488 </span>            :     /* Cancel checks in WAITING and FROZEN per ICE S 8.1.2 */
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :     p2=TAILQ_FIRST(&amp;comp-&gt;stream-&gt;trigger_check_queue);</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :     while(p2){</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :       if((p2 != pair) &amp;&amp;</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :          (p2-&gt;remote-&gt;component-&gt;component_id == comp-&gt;component_id)) {</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :         assert(p2-&gt;state == NR_ICE_PAIR_STATE_WAITING ||</span>
<span class="lineNum">    1494 </span>            :                p2-&gt;state == NR_ICE_PAIR_STATE_CANCELLED);
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d)/CAND-PAIR(%s): cancelling FROZEN/WAITING pair %s in trigger check queue because CAND-PAIR(%s) was nominated.&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id,p2-&gt;codeword,p2-&gt;as_string,pair-&gt;codeword);</span>
<span class="lineNum">    1496 </span>            : 
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :         if(r=nr_ice_candidate_pair_cancel(pair-&gt;pctx,p2,0))</span>
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">    1499 </span>            :       }
<span class="lineNum">    1500 </span>            : 
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :       p2=TAILQ_NEXT(p2,triggered_check_queue_entry);</span>
<span class="lineNum">    1502 </span>            :     }
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :     p2=TAILQ_FIRST(&amp;comp-&gt;stream-&gt;check_list);</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :     while(p2){</span>
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :       if((p2 != pair) &amp;&amp;</span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :          (p2-&gt;remote-&gt;component-&gt;component_id == comp-&gt;component_id) &amp;&amp;</span>
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :          ((p2-&gt;state == NR_ICE_PAIR_STATE_FROZEN) ||</span>
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :           (p2-&gt;state == NR_ICE_PAIR_STATE_WAITING))) {</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d)/CAND-PAIR(%s): cancelling FROZEN/WAITING pair %s because CAND-PAIR(%s) was nominated.&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id,p2-&gt;codeword,p2-&gt;as_string,pair-&gt;codeword);</span>
<span class="lineNum">    1510 </span>            : 
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :         if(r=nr_ice_candidate_pair_cancel(pair-&gt;pctx,p2,0))</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :           ABORT(r);</span>
<span class="lineNum">    1513 </span>            :       }
<span class="lineNum">    1514 </span>            : 
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :       p2=TAILQ_NEXT(p2,check_queue_entry);</span>
<span class="lineNum">    1516 </span>            :     }
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d): cancelling done&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id);</span>
<span class="lineNum">    1518 </span>            : 
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :     if(r=nr_ice_component_setup_consent(comp))</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1521 </span>            : 
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :     if(r=nr_ice_media_stream_component_nominated(comp-&gt;stream,comp))</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1524 </span>            : 
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1526 </span>            :   abort:
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="1528"><span class="lineNum">    1528 </span>            :   }</a>
<span class="lineNum">    1529 </span>            : 
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 : static int nr_ice_component_have_all_pairs_failed(nr_ice_component *comp)</span>
<span class="lineNum">    1531 </span>            :   {
<span class="lineNum">    1532 </span>            :     nr_ice_cand_pair *p2;
<span class="lineNum">    1533 </span>            : 
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :     p2=TAILQ_FIRST(&amp;comp-&gt;stream-&gt;check_list);</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :     while(p2){</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :       if(comp-&gt;component_id==p2-&gt;local-&gt;component_id){</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :         switch(p2-&gt;state){</span>
<span class="lineNum">    1538 </span>            :         case NR_ICE_PAIR_STATE_FROZEN:
<span class="lineNum">    1539 </span>            :         case NR_ICE_PAIR_STATE_WAITING:
<span class="lineNum">    1540 </span>            :         case NR_ICE_PAIR_STATE_IN_PROGRESS:
<span class="lineNum">    1541 </span>            :         case NR_ICE_PAIR_STATE_SUCCEEDED:
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 :             return(0);</span>
<span class="lineNum">    1543 </span>            :         case NR_ICE_PAIR_STATE_FAILED:
<span class="lineNum">    1544 </span>            :         case NR_ICE_PAIR_STATE_CANCELLED:
<span class="lineNum">    1545 </span>            :             /* states that will never be recovered from */
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1547 </span>            :         default:
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :             assert(0);</span>
<span class="lineNum">    1549 </span>            :             break;
<span class="lineNum">    1550 </span>            :         }
<span class="lineNum">    1551 </span>            :       }
<span class="lineNum">    1552 </span>            : 
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :       p2=TAILQ_NEXT(p2,check_queue_entry);</span>
<span class="lineNum">    1554 </span>            :     }
<span class="lineNum">    1555 </span>            : 
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :     return(1);</span>
<a name="1557"><span class="lineNum">    1557 </span>            :   }</a>
<span class="lineNum">    1558 </span>            : 
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 : int nr_ice_component_failed_pair(nr_ice_component *comp, nr_ice_cand_pair *pair)</span>
<span class="lineNum">    1560 </span>            :   {
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :     return nr_ice_component_check_if_failed(comp);</span>
<a name="1562"><span class="lineNum">    1562 </span>            :   }</a>
<span class="lineNum">    1563 </span>            : 
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 : int nr_ice_component_check_if_failed(nr_ice_component *comp)</span>
<span class="lineNum">    1565 </span>            :   {
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :     if (comp-&gt;state == NR_ICE_COMPONENT_RUNNING) {</span>
<span class="lineNum">    1567 </span>            :       /* Don't do anything to streams that aren't currently running */
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :       r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d): Checking whether component needs to be marked failed.&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id);</span>
<span class="lineNum">    1569 </span>            : 
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :       if (!comp-&gt;stream-&gt;pctx-&gt;trickle_grace_period_timer &amp;&amp;</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :           nr_ice_component_have_all_pairs_failed(comp)) {</span>
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_INFO,&quot;ICE-PEER(%s)/STREAM(%s)/COMP(%d): All pairs are failed, and grace period has elapsed. Marking component as failed.&quot;,comp-&gt;stream-&gt;pctx-&gt;label,comp-&gt;stream-&gt;label,comp-&gt;component_id);</span>
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :         return nr_ice_media_stream_component_failed(comp-&gt;stream,comp);</span>
<span class="lineNum">    1574 </span>            :       }
<span class="lineNum">    1575 </span>            :     }
<span class="lineNum">    1576 </span>            : 
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :     return(0);</span>
<a name="1578"><span class="lineNum">    1578 </span>            :   }</a>
<span class="lineNum">    1579 </span>            : 
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 : int nr_ice_component_select_pair(nr_ice_peer_ctx *pctx, nr_ice_component *comp)</span>
<span class="lineNum">    1581 </span>            :   {
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :     nr_ice_cand_pair **pairs=0;</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :     int ct=0;</span>
<span class="lineNum">    1584 </span>            :     nr_ice_cand_pair *pair;
<span class="lineNum">    1585 </span>            :     int r,_status;
<span class="lineNum">    1586 </span>            : 
<span class="lineNum">    1587 </span>            :     /* Size the array */
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :     pair=TAILQ_FIRST(&amp;comp-&gt;stream-&gt;check_list);</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :     while(pair){</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :       if (comp-&gt;component_id == pair-&gt;local-&gt;component_id)</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :           ct++;</span>
<span class="lineNum">    1592 </span>            : 
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :       pair=TAILQ_NEXT(pair,check_queue_entry);</span>
<span class="lineNum">    1594 </span>            :     }
<span class="lineNum">    1595 </span>            : 
<span class="lineNum">    1596 </span>            :     /* Make and fill the array */
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :     if(!(pairs=RCALLOC(sizeof(nr_ice_cand_pair *)*ct)))</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :       ABORT(R_NO_MEMORY);</span>
<span class="lineNum">    1599 </span>            : 
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :     ct=0;</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :     pair=TAILQ_FIRST(&amp;comp-&gt;stream-&gt;check_list);</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :     while(pair){</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :       if (comp-&gt;component_id == pair-&gt;local-&gt;component_id)</span>
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :           pairs[ct++]=pair;</span>
<span class="lineNum">    1605 </span>            : 
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :       pair=TAILQ_NEXT(pair,check_queue_entry);</span>
<span class="lineNum">    1607 </span>            :     }
<span class="lineNum">    1608 </span>            : 
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :     if (pctx-&gt;handler) {</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :       if(r=pctx-&gt;handler-&gt;vtbl-&gt;select_pair(pctx-&gt;handler-&gt;obj,</span>
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 :         comp-&gt;stream,comp-&gt;component_id,pairs,ct))</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :         ABORT(r);</span>
<span class="lineNum">    1613 </span>            :     }
<span class="lineNum">    1614 </span>            : 
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1616 </span>            :   abort:
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :     RFREE(pairs);</span>
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :     return(_status);</span>
<span class="lineNum">    1619 </span>            :   }
<span class="lineNum">    1620 </span>            : 
<a name="1621"><span class="lineNum">    1621 </span>            : </a>
<span class="lineNum">    1622 </span>            : /* Close the underlying sockets for everything but the nominated candidate */
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 : int nr_ice_component_finalize(nr_ice_component *lcomp, nr_ice_component *rcomp)</span>
<span class="lineNum">    1624 </span>            :   {
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :     nr_ice_socket *isock=0;</span>
<span class="lineNum">    1626 </span>            :     nr_ice_socket *s1,*s2;
<span class="lineNum">    1627 </span>            : 
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :     if(rcomp-&gt;state==NR_ICE_COMPONENT_NOMINATED){</span>
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :       assert(rcomp-&gt;active == rcomp-&gt;nominated);</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :       isock=rcomp-&gt;nominated-&gt;local-&gt;isock;</span>
<span class="lineNum">    1631 </span>            :     }
<span class="lineNum">    1632 </span>            : 
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :     STAILQ_FOREACH_SAFE(s1, &amp;lcomp-&gt;sockets, entry, s2){</span>
<span class="lineNum">    1634 </span><span class="lineNoCov">          0 :       if(s1!=isock){</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :         STAILQ_REMOVE(&amp;lcomp-&gt;sockets,s1,nr_ice_socket_,entry);</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :         nr_ice_socket_destroy(&amp;s1);</span>
<span class="lineNum">    1637 </span>            :       }
<span class="lineNum">    1638 </span>            :     }
<span class="lineNum">    1639 </span>            : 
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :     return(0);</span>
<span class="lineNum">    1641 </span>            :   }
<a name="1642"><span class="lineNum">    1642 </span>            : </a>
<span class="lineNum">    1643 </span>            : 
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 : int nr_ice_component_insert_pair(nr_ice_component *pcomp, nr_ice_cand_pair *pair)</span>
<span class="lineNum">    1645 </span>            :   {
<span class="lineNum">    1646 </span>            :     int r,_status;
<span class="lineNum">    1647 </span>            : 
<span class="lineNum">    1648 </span>            :     /* Pairs for peer reflexive are marked SUCCEEDED immediately */
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :     if (pair-&gt;state != NR_ICE_PAIR_STATE_FROZEN &amp;&amp;</span>
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :         pair-&gt;state != NR_ICE_PAIR_STATE_SUCCEEDED){</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :       assert(0);</span>
<span class="lineNum">    1652 </span>            :       ABORT(R_BAD_ARGS);
<span class="lineNum">    1653 </span>            :     }
<span class="lineNum">    1654 </span>            : 
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :     if(r=nr_ice_candidate_pair_insert(&amp;pair-&gt;remote-&gt;stream-&gt;check_list,pair))</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :       ABORT(r);</span>
<span class="lineNum">    1657 </span>            : 
<span class="lineNum">    1658 </span>            :     /* Make sure the check timer is running, if the stream was previously
<span class="lineNum">    1659 </span>            :      * started. We will not start streams just because a pair was created,
<span class="lineNum">    1660 </span>            :      * unless it is the first pair to be created across all streams. */
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :     r_log(LOG_ICE,LOG_DEBUG,&quot;ICE-PEER(%s)/CAND-PAIR(%s): Ensure that check timer is running for new pair %s.&quot;,pair-&gt;remote-&gt;stream-&gt;pctx-&gt;label, pair-&gt;codeword, pair-&gt;as_string);</span>
<span class="lineNum">    1662 </span>            : 
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :     if(pair-&gt;remote-&gt;stream-&gt;ice_state == NR_ICE_MEDIA_STREAM_CHECKS_ACTIVE ||</span>
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :        (pair-&gt;remote-&gt;stream-&gt;ice_state == NR_ICE_MEDIA_STREAM_CHECKS_FROZEN &amp;&amp;</span>
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :         !pair-&gt;remote-&gt;stream-&gt;pctx-&gt;checks_started)){</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :       if(nr_ice_media_stream_start_checks(pair-&gt;remote-&gt;stream-&gt;pctx, pair-&gt;remote-&gt;stream)) {</span>
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :         r_log(LOG_ICE,LOG_WARNING,&quot;ICE-PEER(%s)/CAND-PAIR(%s): Could not restart checks for new pair %s.&quot;,pair-&gt;remote-&gt;stream-&gt;pctx-&gt;label, pair-&gt;codeword, pair-&gt;as_string);</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :         ABORT(R_INTERNAL);</span>
<span class="lineNum">    1669 </span>            :       }
<span class="lineNum">    1670 </span>            :     }
<span class="lineNum">    1671 </span>            : 
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1673 </span>            :   abort:
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :     return(_status);</span>
<a name="1675"><span class="lineNum">    1675 </span>            :   }</a>
<span class="lineNum">    1676 </span>            : 
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 : int nr_ice_component_get_default_candidate(nr_ice_component *comp, nr_ice_candidate **candp, int ip_version)</span>
<span class="lineNum">    1678 </span>            :   {
<span class="lineNum">    1679 </span>            :     int _status;
<span class="lineNum">    1680 </span>            :     nr_ice_candidate *cand;
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :     nr_ice_candidate *best_cand = NULL;</span>
<span class="lineNum">    1682 </span>            : 
<span class="lineNum">    1683 </span>            :     /* We have the component. Now find the &quot;best&quot; candidate, making
<span class="lineNum">    1684 </span>            :        use of the fact that more &quot;reliable&quot; candidate types have
<span class="lineNum">    1685 </span>            :        higher numbers. So, we sort by type and then priority within
<span class="lineNum">    1686 </span>            :        type
<span class="lineNum">    1687 </span>            :     */
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 :     cand=TAILQ_FIRST(&amp;comp-&gt;candidates);</span>
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 :     while(cand){</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :       if (!nr_ice_ctx_hide_candidate(comp-&gt;ctx, cand) &amp;&amp;</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :           cand-&gt;addr.ip_version == ip_version) {</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :         if (!best_cand) {</span>
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :           best_cand = cand;</span>
<span class="lineNum">    1694 </span>            :         }
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :         else if (best_cand-&gt;type &lt; cand-&gt;type) {</span>
<span class="lineNum">    1696 </span><span class="lineNoCov">          0 :           best_cand = cand;</span>
<span class="lineNum">    1697 </span><span class="lineNoCov">          0 :         } else if (best_cand-&gt;type == cand-&gt;type &amp;&amp;</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :                    best_cand-&gt;priority &lt; cand-&gt;priority) {</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :           best_cand = cand;</span>
<span class="lineNum">    1700 </span>            :         }
<span class="lineNum">    1701 </span>            :       }
<span class="lineNum">    1702 </span>            : 
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :       cand=TAILQ_NEXT(cand,entry_comp);</span>
<span class="lineNum">    1704 </span>            :     }
<span class="lineNum">    1705 </span>            : 
<span class="lineNum">    1706 </span>            :     /* No candidates */
<span class="lineNum">    1707 </span><span class="lineNoCov">          0 :     if (!best_cand)</span>
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :       ABORT(R_NOT_FOUND);</span>
<span class="lineNum">    1709 </span>            : 
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :     *candp = best_cand;</span>
<span class="lineNum">    1711 </span>            : 
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :     _status=0;</span>
<span class="lineNum">    1713 </span>            :   abort:
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :     return(_status);</span>
<span class="lineNum">    1715 </span>            : 
<span class="lineNum">    1716 </span>            :   }
<span class="lineNum">    1717 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

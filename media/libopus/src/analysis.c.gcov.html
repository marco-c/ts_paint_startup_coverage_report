<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - media/libopus/src/analysis.c</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">media/libopus/src</a> - analysis.c<span style="font-size: 80%;"> (source / <a href="analysis.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">452</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Copyright (c) 2011 Xiph.Org Foundation</a>
<span class="lineNum">       2 </span>            :    Written by Jean-Marc Valin */
<span class="lineNum">       3 </span>            : /*
<span class="lineNum">       4 </span>            :    Redistribution and use in source and binary forms, with or without
<span class="lineNum">       5 </span>            :    modification, are permitted provided that the following conditions
<span class="lineNum">       6 </span>            :    are met:
<span class="lineNum">       7 </span>            : 
<span class="lineNum">       8 </span>            :    - Redistributions of source code must retain the above copyright
<span class="lineNum">       9 </span>            :    notice, this list of conditions and the following disclaimer.
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            :    - Redistributions in binary form must reproduce the above copyright
<span class="lineNum">      12 </span>            :    notice, this list of conditions and the following disclaimer in the
<span class="lineNum">      13 </span>            :    documentation and/or other materials provided with the distribution.
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            :    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
<span class="lineNum">      16 </span>            :    ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
<span class="lineNum">      17 </span>            :    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
<span class="lineNum">      18 </span>            :    A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR
<span class="lineNum">      19 </span>            :    CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
<span class="lineNum">      20 </span>            :    EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<span class="lineNum">      21 </span>            :    PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
<span class="lineNum">      22 </span>            :    PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
<span class="lineNum">      23 </span>            :    LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
<span class="lineNum">      24 </span>            :    NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
<span class="lineNum">      25 </span>            :    SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      26 </span>            : */
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #ifdef HAVE_CONFIG_H
<span class="lineNum">      29 </span>            : #include &quot;config.h&quot;
<span class="lineNum">      30 </span>            : #endif
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #define ANALYSIS_C
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : #include &quot;mathops.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;kiss_fft.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;celt.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;modes.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;arch.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;quant_bands.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;analysis.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;mlp.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;stack_alloc.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;float_cast.h&quot;
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : #ifndef M_PI
<span class="lineNum">      48 </span>            : #define M_PI 3.141592653
<span class="lineNum">      49 </span>            : #endif
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : #ifndef DISABLE_FLOAT_API
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : static const float dct_table[128] = {
<span class="lineNum">      54 </span>            :         0.250000f, 0.250000f, 0.250000f, 0.250000f, 0.250000f, 0.250000f, 0.250000f, 0.250000f,
<span class="lineNum">      55 </span>            :         0.250000f, 0.250000f, 0.250000f, 0.250000f, 0.250000f, 0.250000f, 0.250000f, 0.250000f,
<span class="lineNum">      56 </span>            :         0.351851f, 0.338330f, 0.311806f, 0.273300f, 0.224292f, 0.166664f, 0.102631f, 0.034654f,
<span class="lineNum">      57 </span>            :        -0.034654f,-0.102631f,-0.166664f,-0.224292f,-0.273300f,-0.311806f,-0.338330f,-0.351851f,
<span class="lineNum">      58 </span>            :         0.346760f, 0.293969f, 0.196424f, 0.068975f,-0.068975f,-0.196424f,-0.293969f,-0.346760f,
<span class="lineNum">      59 </span>            :        -0.346760f,-0.293969f,-0.196424f,-0.068975f, 0.068975f, 0.196424f, 0.293969f, 0.346760f,
<span class="lineNum">      60 </span>            :         0.338330f, 0.224292f, 0.034654f,-0.166664f,-0.311806f,-0.351851f,-0.273300f,-0.102631f,
<span class="lineNum">      61 </span>            :         0.102631f, 0.273300f, 0.351851f, 0.311806f, 0.166664f,-0.034654f,-0.224292f,-0.338330f,
<span class="lineNum">      62 </span>            :         0.326641f, 0.135299f,-0.135299f,-0.326641f,-0.326641f,-0.135299f, 0.135299f, 0.326641f,
<span class="lineNum">      63 </span>            :         0.326641f, 0.135299f,-0.135299f,-0.326641f,-0.326641f,-0.135299f, 0.135299f, 0.326641f,
<span class="lineNum">      64 </span>            :         0.311806f, 0.034654f,-0.273300f,-0.338330f,-0.102631f, 0.224292f, 0.351851f, 0.166664f,
<span class="lineNum">      65 </span>            :        -0.166664f,-0.351851f,-0.224292f, 0.102631f, 0.338330f, 0.273300f,-0.034654f,-0.311806f,
<span class="lineNum">      66 </span>            :         0.293969f,-0.068975f,-0.346760f,-0.196424f, 0.196424f, 0.346760f, 0.068975f,-0.293969f,
<span class="lineNum">      67 </span>            :        -0.293969f, 0.068975f, 0.346760f, 0.196424f,-0.196424f,-0.346760f,-0.068975f, 0.293969f,
<span class="lineNum">      68 </span>            :         0.273300f,-0.166664f,-0.338330f, 0.034654f, 0.351851f, 0.102631f,-0.311806f,-0.224292f,
<span class="lineNum">      69 </span>            :         0.224292f, 0.311806f,-0.102631f,-0.351851f,-0.034654f, 0.338330f, 0.166664f,-0.273300f,
<span class="lineNum">      70 </span>            : };
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : static const float analysis_window[240] = {
<span class="lineNum">      73 </span>            :       0.000043f, 0.000171f, 0.000385f, 0.000685f, 0.001071f, 0.001541f, 0.002098f, 0.002739f,
<span class="lineNum">      74 </span>            :       0.003466f, 0.004278f, 0.005174f, 0.006156f, 0.007222f, 0.008373f, 0.009607f, 0.010926f,
<span class="lineNum">      75 </span>            :       0.012329f, 0.013815f, 0.015385f, 0.017037f, 0.018772f, 0.020590f, 0.022490f, 0.024472f,
<span class="lineNum">      76 </span>            :       0.026535f, 0.028679f, 0.030904f, 0.033210f, 0.035595f, 0.038060f, 0.040604f, 0.043227f,
<span class="lineNum">      77 </span>            :       0.045928f, 0.048707f, 0.051564f, 0.054497f, 0.057506f, 0.060591f, 0.063752f, 0.066987f,
<span class="lineNum">      78 </span>            :       0.070297f, 0.073680f, 0.077136f, 0.080665f, 0.084265f, 0.087937f, 0.091679f, 0.095492f,
<span class="lineNum">      79 </span>            :       0.099373f, 0.103323f, 0.107342f, 0.111427f, 0.115579f, 0.119797f, 0.124080f, 0.128428f,
<span class="lineNum">      80 </span>            :       0.132839f, 0.137313f, 0.141849f, 0.146447f, 0.151105f, 0.155823f, 0.160600f, 0.165435f,
<span class="lineNum">      81 </span>            :       0.170327f, 0.175276f, 0.180280f, 0.185340f, 0.190453f, 0.195619f, 0.200838f, 0.206107f,
<span class="lineNum">      82 </span>            :       0.211427f, 0.216797f, 0.222215f, 0.227680f, 0.233193f, 0.238751f, 0.244353f, 0.250000f,
<span class="lineNum">      83 </span>            :       0.255689f, 0.261421f, 0.267193f, 0.273005f, 0.278856f, 0.284744f, 0.290670f, 0.296632f,
<span class="lineNum">      84 </span>            :       0.302628f, 0.308658f, 0.314721f, 0.320816f, 0.326941f, 0.333097f, 0.339280f, 0.345492f,
<span class="lineNum">      85 </span>            :       0.351729f, 0.357992f, 0.364280f, 0.370590f, 0.376923f, 0.383277f, 0.389651f, 0.396044f,
<span class="lineNum">      86 </span>            :       0.402455f, 0.408882f, 0.415325f, 0.421783f, 0.428254f, 0.434737f, 0.441231f, 0.447736f,
<span class="lineNum">      87 </span>            :       0.454249f, 0.460770f, 0.467298f, 0.473832f, 0.480370f, 0.486912f, 0.493455f, 0.500000f,
<span class="lineNum">      88 </span>            :       0.506545f, 0.513088f, 0.519630f, 0.526168f, 0.532702f, 0.539230f, 0.545751f, 0.552264f,
<span class="lineNum">      89 </span>            :       0.558769f, 0.565263f, 0.571746f, 0.578217f, 0.584675f, 0.591118f, 0.597545f, 0.603956f,
<span class="lineNum">      90 </span>            :       0.610349f, 0.616723f, 0.623077f, 0.629410f, 0.635720f, 0.642008f, 0.648271f, 0.654508f,
<span class="lineNum">      91 </span>            :       0.660720f, 0.666903f, 0.673059f, 0.679184f, 0.685279f, 0.691342f, 0.697372f, 0.703368f,
<span class="lineNum">      92 </span>            :       0.709330f, 0.715256f, 0.721144f, 0.726995f, 0.732807f, 0.738579f, 0.744311f, 0.750000f,
<span class="lineNum">      93 </span>            :       0.755647f, 0.761249f, 0.766807f, 0.772320f, 0.777785f, 0.783203f, 0.788573f, 0.793893f,
<span class="lineNum">      94 </span>            :       0.799162f, 0.804381f, 0.809547f, 0.814660f, 0.819720f, 0.824724f, 0.829673f, 0.834565f,
<span class="lineNum">      95 </span>            :       0.839400f, 0.844177f, 0.848895f, 0.853553f, 0.858151f, 0.862687f, 0.867161f, 0.871572f,
<span class="lineNum">      96 </span>            :       0.875920f, 0.880203f, 0.884421f, 0.888573f, 0.892658f, 0.896677f, 0.900627f, 0.904508f,
<span class="lineNum">      97 </span>            :       0.908321f, 0.912063f, 0.915735f, 0.919335f, 0.922864f, 0.926320f, 0.929703f, 0.933013f,
<span class="lineNum">      98 </span>            :       0.936248f, 0.939409f, 0.942494f, 0.945503f, 0.948436f, 0.951293f, 0.954072f, 0.956773f,
<span class="lineNum">      99 </span>            :       0.959396f, 0.961940f, 0.964405f, 0.966790f, 0.969096f, 0.971321f, 0.973465f, 0.975528f,
<span class="lineNum">     100 </span>            :       0.977510f, 0.979410f, 0.981228f, 0.982963f, 0.984615f, 0.986185f, 0.987671f, 0.989074f,
<span class="lineNum">     101 </span>            :       0.990393f, 0.991627f, 0.992778f, 0.993844f, 0.994826f, 0.995722f, 0.996534f, 0.997261f,
<span class="lineNum">     102 </span>            :       0.997902f, 0.998459f, 0.998929f, 0.999315f, 0.999615f, 0.999829f, 0.999957f, 1.000000f,
<span class="lineNum">     103 </span>            : };
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span>            : static const int tbands[NB_TBANDS+1] = {
<span class="lineNum">     106 </span>            :       4, 8, 12, 16, 20, 24, 28, 32, 40, 48, 56, 64, 80, 96, 112, 136, 160, 192, 240
<span class="lineNum">     107 </span>            : };
<span class="lineNum">     108 </span>            : 
<a name="109"><span class="lineNum">     109 </span>            : #define NB_TONAL_SKIP_BANDS 9</a>
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineNoCov">          0 : static opus_val32 silk_resampler_down2_hp(</span>
<span class="lineNum">     112 </span>            :     opus_val32                  *S,                 /* I/O  State vector [ 2 ]                                          */
<span class="lineNum">     113 </span>            :     opus_val32                  *out,               /* O    Output signal [ floor(len/2) ]                              */
<span class="lineNum">     114 </span>            :     const opus_val32            *in,                /* I    Input signal [ len ]                                        */
<span class="lineNum">     115 </span>            :     int                         inLen               /* I    Number of input samples                                     */
<span class="lineNum">     116 </span>            : )
<span class="lineNum">     117 </span>            : {
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     int k, len2 = inLen/2;</span>
<span class="lineNum">     119 </span>            :     opus_val32 in32, out32, out32_hp, Y, X;
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :     opus_val64 hp_ener = 0;</span>
<span class="lineNum">     121 </span>            :     /* Internal variables and state are in Q10 format */
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :     for( k = 0; k &lt; len2; k++ ) {</span>
<span class="lineNum">     123 </span>            :         /* Convert to Q10 */
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :         in32 = in[ 2 * k ];</span>
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span>            :         /* All-pass section for even input sample */
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :         Y      = SUB32( in32, S[ 0 ] );</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :         X      = MULT16_32_Q15(QCONST16(0.6074371f, 15), Y);</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :         out32  = ADD32( S[ 0 ], X );</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         S[ 0 ] = ADD32( in32, X );</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :         out32_hp = out32;</span>
<span class="lineNum">     132 </span>            :         /* Convert to Q10 */
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :         in32 = in[ 2 * k + 1 ];</span>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span>            :         /* All-pass section for odd input sample, and add to output of previous section */
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :         Y      = SUB32( in32, S[ 1 ] );</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         X      = MULT16_32_Q15(QCONST16(0.15063f, 15), Y);</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :         out32  = ADD32( out32, S[ 1 ] );</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :         out32  = ADD32( out32, X );</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :         S[ 1 ] = ADD32( in32, X );</span>
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :         Y      = SUB32( -in32, S[ 2 ] );</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :         X      = MULT16_32_Q15(QCONST16(0.15063f, 15), Y);</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :         out32_hp  = ADD32( out32_hp, S[ 2 ] );</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :         out32_hp  = ADD32( out32_hp, X );</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :         S[ 2 ] = ADD32( -in32, X );</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :         hp_ener += out32_hp*(opus_val64)out32_hp;</span>
<span class="lineNum">     149 </span>            :         /* Add, convert back to int16 and store to output */
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :         out[ k ] = HALF32(out32);</span>
<span class="lineNum">     151 </span>            :     }
<span class="lineNum">     152 </span>            : #ifdef FIXED_POINT
<span class="lineNum">     153 </span>            :     /* len2 can be up to 480, so we shift by 8 more to make it fit. */
<span class="lineNum">     154 </span>            :     hp_ener = hp_ener &gt;&gt; (2*SIG_SHIFT + 8);
<span class="lineNum">     155 </span>            : #endif
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :     return (opus_val32)hp_ener;</span>
<a name="157"><span class="lineNum">     157 </span>            : }</a>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineNoCov">          0 : static opus_val32 downmix_and_resample(downmix_func downmix, const void *_x, opus_val32 *y, opus_val32 S[3], int subframe, int offset, int c1, int c2, int C, int Fs)</span>
<span class="lineNum">     160 </span>            : {
<span class="lineNum">     161 </span>            :    VARDECL(opus_val32, tmp);
<span class="lineNum">     162 </span>            :    opus_val32 scale;
<span class="lineNum">     163 </span>            :    int j;
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :    opus_val32 ret = 0;</span>
<span class="lineNum">     165 </span>            :    SAVE_STACK;
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :    if (subframe==0) return 0;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :    if (Fs == 48000)</span>
<span class="lineNum">     169 </span>            :    {
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :       subframe *= 2;</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :       offset *= 2;</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :    } else if (Fs == 16000) {</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :       subframe = subframe*2/3;</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :       offset = offset*2/3;</span>
<span class="lineNum">     175 </span>            :    }
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :    ALLOC(tmp, subframe, opus_val32);</span>
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :    downmix(_x, tmp, subframe, offset, c1, c2, C);</span>
<span class="lineNum">     179 </span>            : #ifdef FIXED_POINT
<span class="lineNum">     180 </span>            :    scale = (1&lt;&lt;SIG_SHIFT);
<span class="lineNum">     181 </span>            : #else
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :    scale = 1.f/32768;</span>
<span class="lineNum">     183 </span>            : #endif
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :    if (c2==-2)</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :       scale /= C;</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :    else if (c2&gt;-1)</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :       scale /= 2;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :    for (j=0;j&lt;subframe;j++)</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :       tmp[j] *= scale;</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :    if (Fs == 48000)</span>
<span class="lineNum">     191 </span>            :    {
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :       ret = silk_resampler_down2_hp(S, y, tmp, subframe);</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :    } else if (Fs == 24000) {</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :       OPUS_COPY(y, tmp, subframe);</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :    } else if (Fs == 16000) {</span>
<span class="lineNum">     196 </span>            :       VARDECL(opus_val32, tmp3x);
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :       ALLOC(tmp3x, 3*subframe, opus_val32);</span>
<span class="lineNum">     198 </span>            :       /* Don't do this at home! This resampler is horrible and it's only (barely)
<span class="lineNum">     199 </span>            :          usable for the purpose of the analysis because we don't care about all
<span class="lineNum">     200 </span>            :          the aliasing between 8 kHz and 12 kHz. */
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :       for (j=0;j&lt;subframe;j++)</span>
<span class="lineNum">     202 </span>            :       {
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :          tmp3x[3*j] = tmp[j];</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :          tmp3x[3*j+1] = tmp[j];</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :          tmp3x[3*j+2] = tmp[j];</span>
<span class="lineNum">     206 </span>            :       }
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :       silk_resampler_down2_hp(S, y, tmp3x, 3*subframe);</span>
<span class="lineNum">     208 </span>            :    }
<span class="lineNum">     209 </span>            :    RESTORE_STACK;
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :    return ret;</span>
<a name="211"><span class="lineNum">     211 </span>            : }</a>
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span><span class="lineNoCov">          0 : void tonality_analysis_init(TonalityAnalysisState *tonal, opus_int32 Fs)</span>
<span class="lineNum">     214 </span>            : {
<span class="lineNum">     215 </span>            :   /* Initialize reusable fields. */
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :   tonal-&gt;arch = opus_select_arch();</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :   tonal-&gt;Fs = Fs;</span>
<span class="lineNum">     218 </span>            :   /* Clear remaining fields. */
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   tonality_analysis_reset(tonal);</span>
<a name="220"><span class="lineNum">     220 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span><span class="lineNoCov">          0 : void tonality_analysis_reset(TonalityAnalysisState *tonal)</span>
<span class="lineNum">     223 </span>            : {
<span class="lineNum">     224 </span>            :   /* Clear non-reusable fields. */
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :   char *start = (char*)&amp;tonal-&gt;TONALITY_ANALYSIS_RESET_START;</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   OPUS_CLEAR(start, sizeof(TonalityAnalysisState) - (start - (char*)tonal));</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :   tonal-&gt;music_confidence = .9f;</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   tonal-&gt;speech_confidence = .1f;</span>
<a name="229"><span class="lineNum">     229 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span><span class="lineNoCov">          0 : void tonality_get_info(TonalityAnalysisState *tonal, AnalysisInfo *info_out, int len)</span>
<span class="lineNum">     232 </span>            : {
<span class="lineNum">     233 </span>            :    int pos;
<span class="lineNum">     234 </span>            :    int curr_lookahead;
<span class="lineNum">     235 </span>            :    float psum;
<span class="lineNum">     236 </span>            :    float tonality_max;
<span class="lineNum">     237 </span>            :    float tonality_avg;
<span class="lineNum">     238 </span>            :    int tonality_count;
<span class="lineNum">     239 </span>            :    int i;
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :    pos = tonal-&gt;read_pos;</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :    curr_lookahead = tonal-&gt;write_pos-tonal-&gt;read_pos;</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :    if (curr_lookahead&lt;0)</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :       curr_lookahead += DETECT_SIZE;</span>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span>            :    /* On long frames, look at the second analysis window rather than the first. */
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :    if (len &gt; tonal-&gt;Fs/50 &amp;&amp; pos != tonal-&gt;write_pos)</span>
<span class="lineNum">     248 </span>            :    {
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :       pos++;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :       if (pos==DETECT_SIZE)</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :          pos=0;</span>
<span class="lineNum">     252 </span>            :    }
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :    if (pos == tonal-&gt;write_pos)</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :       pos--;</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :    if (pos&lt;0)</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :       pos = DETECT_SIZE-1;</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :    OPUS_COPY(info_out, &amp;tonal-&gt;info[pos], 1);</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :    tonality_max = tonality_avg = info_out-&gt;tonality;</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :    tonality_count = 1;</span>
<span class="lineNum">     260 </span>            :    /* If possible, look ahead for a tone to compensate for the delay in the tone detector. */
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :    for (i=0;i&lt;3;i++)</span>
<span class="lineNum">     262 </span>            :    {
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :       pos++;</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :       if (pos==DETECT_SIZE)</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :          pos = 0;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :       if (pos == tonal-&gt;write_pos)</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :          break;</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :       tonality_max = MAX32(tonality_max, tonal-&gt;info[pos].tonality);</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :       tonality_avg += tonal-&gt;info[pos].tonality;</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :       tonality_count++;</span>
<span class="lineNum">     271 </span>            :    }
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :    info_out-&gt;tonality = MAX32(tonality_avg/tonality_count, tonality_max-.2f);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :    tonal-&gt;read_subframe += len/(tonal-&gt;Fs/400);</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :    while (tonal-&gt;read_subframe&gt;=8)</span>
<span class="lineNum">     275 </span>            :    {
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :       tonal-&gt;read_subframe -= 8;</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :       tonal-&gt;read_pos++;</span>
<span class="lineNum">     278 </span>            :    }
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :    if (tonal-&gt;read_pos&gt;=DETECT_SIZE)</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :       tonal-&gt;read_pos-=DETECT_SIZE;</span>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span>            :    /* The -1 is to compensate for the delay in the features themselves. */
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :    curr_lookahead = IMAX(curr_lookahead-1, 0);</span>
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :    psum=0;</span>
<span class="lineNum">     286 </span>            :    /* Summing the probability of transition patterns that involve music at
<span class="lineNum">     287 </span>            :       time (DETECT_SIZE-curr_lookahead-1) */
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :    for (i=0;i&lt;DETECT_SIZE-curr_lookahead;i++)</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :       psum += tonal-&gt;pmusic[i];</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :    for (;i&lt;DETECT_SIZE;i++)</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :       psum += tonal-&gt;pspeech[i];</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :    psum = psum*tonal-&gt;music_confidence + (1-psum)*tonal-&gt;speech_confidence;</span>
<span class="lineNum">     293 </span>            :    /*printf(&quot;%f %f %f %f %f\n&quot;, psum, info_out-&gt;music_prob, info_out-&gt;vad_prob, info_out-&gt;activity_probability, info_out-&gt;tonality);*/
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :    info_out-&gt;music_prob = psum;</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span>            : static const float std_feature_bias[9] = {
<span class="lineNum">     299 </span>            :       5.684947f, 3.475288f, 1.770634f, 1.599784f, 3.773215f,
<span class="lineNum">     300 </span>            :       2.163313f, 1.260756f, 1.116868f, 1.918795f
<span class="lineNum">     301 </span>            : };
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span>            : #define LEAKAGE_OFFSET 2.5f
<span class="lineNum">     304 </span>            : #define LEAKAGE_SLOPE 2.f
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span>            : #ifdef FIXED_POINT
<span class="lineNum">     307 </span>            : /* For fixed-point, the input is +/-2^15 shifted up by SIG_SHIFT, so we need to
<span class="lineNum">     308 </span>            :    compensate for that in the energy. */
<span class="lineNum">     309 </span>            : #define SCALE_COMPENS (1.f/((opus_int32)1&lt;&lt;(15+SIG_SHIFT)))
<span class="lineNum">     310 </span>            : #define SCALE_ENER(e) ((SCALE_COMPENS*SCALE_COMPENS)*(e))
<span class="lineNum">     311 </span>            : #else
<span class="lineNum">     312 </span>            : #define SCALE_ENER(e) (e)
<a name="313"><span class="lineNum">     313 </span>            : #endif</a>
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineNoCov">          0 : static void tonality_analysis(TonalityAnalysisState *tonal, const CELTMode *celt_mode, const void *x, int len, int offset, int c1, int c2, int C, int lsb_depth, downmix_func downmix)</span>
<span class="lineNum">     316 </span>            : {
<span class="lineNum">     317 </span>            :     int i, b;
<span class="lineNum">     318 </span>            :     const kiss_fft_state *kfft;
<span class="lineNum">     319 </span>            :     VARDECL(kiss_fft_cpx, in);
<span class="lineNum">     320 </span>            :     VARDECL(kiss_fft_cpx, out);
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     int N = 480, N2=240;</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     float * OPUS_RESTRICT A = tonal-&gt;angle;</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :     float * OPUS_RESTRICT dA = tonal-&gt;d_angle;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     float * OPUS_RESTRICT d2A = tonal-&gt;d2_angle;</span>
<span class="lineNum">     325 </span>            :     VARDECL(float, tonality);
<span class="lineNum">     326 </span>            :     VARDECL(float, noisiness);
<span class="lineNum">     327 </span>            :     float band_tonality[NB_TBANDS];
<span class="lineNum">     328 </span>            :     float logE[NB_TBANDS];
<span class="lineNum">     329 </span>            :     float BFCC[8];
<span class="lineNum">     330 </span>            :     float features[25];
<span class="lineNum">     331 </span>            :     float frame_tonality;
<span class="lineNum">     332 </span>            :     float max_frame_tonality;
<span class="lineNum">     333 </span>            :     /*float tw_sum=0;*/
<span class="lineNum">     334 </span>            :     float frame_noisiness;
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     const float pi4 = (float)(M_PI*M_PI*M_PI*M_PI);</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     float slope=0;</span>
<span class="lineNum">     337 </span>            :     float frame_stationarity;
<span class="lineNum">     338 </span>            :     float relativeE;
<span class="lineNum">     339 </span>            :     float frame_probs[2];
<span class="lineNum">     340 </span>            :     float alpha, alphaE, alphaE2;
<span class="lineNum">     341 </span>            :     float frame_loudness;
<span class="lineNum">     342 </span>            :     float bandwidth_mask;
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     int bandwidth=0;</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :     float maxE = 0;</span>
<span class="lineNum">     345 </span>            :     float noise_floor;
<span class="lineNum">     346 </span>            :     int remaining;
<span class="lineNum">     347 </span>            :     AnalysisInfo *info;
<span class="lineNum">     348 </span>            :     float hp_ener;
<span class="lineNum">     349 </span>            :     float tonality2[240];
<span class="lineNum">     350 </span>            :     float midE[8];
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     float spec_variability=0;</span>
<span class="lineNum">     352 </span>            :     float band_log2[NB_TBANDS+1];
<span class="lineNum">     353 </span>            :     float leakage_from[NB_TBANDS+1];
<span class="lineNum">     354 </span>            :     float leakage_to[NB_TBANDS+1];
<span class="lineNum">     355 </span>            :     SAVE_STACK;
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :     alpha = 1.f/IMIN(10, 1+tonal-&gt;count);</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :     alphaE = 1.f/IMIN(25, 1+tonal-&gt;count);</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :     alphaE2 = 1.f/IMIN(500, 1+tonal-&gt;count);</span>
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :     if (tonal-&gt;Fs == 48000)</span>
<span class="lineNum">     362 </span>            :     {
<span class="lineNum">     363 </span>            :        /* len and offset are now at 24 kHz. */
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :        len/= 2;</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :        offset /= 2;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :     } else if (tonal-&gt;Fs == 16000) {</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :        len = 3*len/2;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :        offset = 3*offset/2;</span>
<span class="lineNum">     369 </span>            :     }
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     if (tonal-&gt;count&lt;4) {</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :        if (tonal-&gt;application == OPUS_APPLICATION_VOIP)</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :           tonal-&gt;music_prob = .1f;</span>
<span class="lineNum">     374 </span>            :        else
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :           tonal-&gt;music_prob = .625f;</span>
<span class="lineNum">     376 </span>            :     }
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     kfft = celt_mode-&gt;mdct.kfft[0];</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :     if (tonal-&gt;count==0)</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :        tonal-&gt;mem_fill = 240;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     tonal-&gt;hp_ener_accum += (float)downmix_and_resample(downmix, x,</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :           &amp;tonal-&gt;inmem[tonal-&gt;mem_fill], tonal-&gt;downmix_state,</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :           IMIN(len, ANALYSIS_BUF_SIZE-tonal-&gt;mem_fill), offset, c1, c2, C, tonal-&gt;Fs);</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :     if (tonal-&gt;mem_fill+len &lt; ANALYSIS_BUF_SIZE)</span>
<span class="lineNum">     384 </span>            :     {
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :        tonal-&gt;mem_fill += len;</span>
<span class="lineNum">     386 </span>            :        /* Don't have enough to update the analysis */
<span class="lineNum">     387 </span>            :        RESTORE_STACK;
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :        return;</span>
<span class="lineNum">     389 </span>            :     }
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :     hp_ener = tonal-&gt;hp_ener_accum;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     info = &amp;tonal-&gt;info[tonal-&gt;write_pos++];</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     if (tonal-&gt;write_pos&gt;=DETECT_SIZE)</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :        tonal-&gt;write_pos-=DETECT_SIZE;</span>
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     ALLOC(in, 480, kiss_fft_cpx);</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :     ALLOC(out, 480, kiss_fft_cpx);</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     ALLOC(tonality, 240, float);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     ALLOC(noisiness, 240, float);</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;N2;i++)</span>
<span class="lineNum">     400 </span>            :     {
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :        float w = analysis_window[i];</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :        in[i].r = (kiss_fft_scalar)(w*tonal-&gt;inmem[i]);</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :        in[i].i = (kiss_fft_scalar)(w*tonal-&gt;inmem[N2+i]);</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :        in[N-i-1].r = (kiss_fft_scalar)(w*tonal-&gt;inmem[N-i-1]);</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :        in[N-i-1].i = (kiss_fft_scalar)(w*tonal-&gt;inmem[N+N2-i-1]);</span>
<span class="lineNum">     406 </span>            :     }
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     OPUS_MOVE(tonal-&gt;inmem, tonal-&gt;inmem+ANALYSIS_BUF_SIZE-240, 240);</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :     remaining = len - (ANALYSIS_BUF_SIZE-tonal-&gt;mem_fill);</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     tonal-&gt;hp_ener_accum = (float)downmix_and_resample(downmix, x,</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :           &amp;tonal-&gt;inmem[240], tonal-&gt;downmix_state, remaining,</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :           offset+ANALYSIS_BUF_SIZE-tonal-&gt;mem_fill, c1, c2, C, tonal-&gt;Fs);</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     tonal-&gt;mem_fill = 240 + remaining;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     opus_fft(kfft, in, out, tonal-&gt;arch);</span>
<span class="lineNum">     414 </span>            : #ifndef FIXED_POINT
<span class="lineNum">     415 </span>            :     /* If there's any NaN on the input, the entire output will be NaN, so we only need to check one value. */
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :     if (celt_isnan(out[0].r))</span>
<span class="lineNum">     417 </span>            :     {
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :        info-&gt;valid = 0;</span>
<span class="lineNum">     419 </span>            :        RESTORE_STACK;
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :        return;</span>
<span class="lineNum">     421 </span>            :     }
<span class="lineNum">     422 </span>            : #endif
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :     for (i=1;i&lt;N2;i++)</span>
<span class="lineNum">     425 </span>            :     {
<span class="lineNum">     426 </span>            :        float X1r, X2r, X1i, X2i;
<span class="lineNum">     427 </span>            :        float angle, d_angle, d2_angle;
<span class="lineNum">     428 </span>            :        float angle2, d_angle2, d2_angle2;
<span class="lineNum">     429 </span>            :        float mod1, mod2, avg_mod;
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :        X1r = (float)out[i].r+out[N-i].r;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :        X1i = (float)out[i].i-out[N-i].i;</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :        X2r = (float)out[i].i+out[N-i].i;</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :        X2i = (float)out[N-i].r-out[i].r;</span>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :        angle = (float)(.5f/M_PI)*fast_atan2f(X1i, X1r);</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :        d_angle = angle - A[i];</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :        d2_angle = d_angle - dA[i];</span>
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :        angle2 = (float)(.5f/M_PI)*fast_atan2f(X2i, X2r);</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :        d_angle2 = angle2 - angle;</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :        d2_angle2 = d_angle2 - d_angle;</span>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :        mod1 = d2_angle - (float)float2int(d2_angle);</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :        noisiness[i] = ABS16(mod1);</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :        mod1 *= mod1;</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :        mod1 *= mod1;</span>
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :        mod2 = d2_angle2 - (float)float2int(d2_angle2);</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :        noisiness[i] += ABS16(mod2);</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :        mod2 *= mod2;</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :        mod2 *= mod2;</span>
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :        avg_mod = .25f*(d2A[i]+mod1+2*mod2);</span>
<span class="lineNum">     454 </span>            :        /* This introduces an extra delay of 2 frames in the detection. */
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :        tonality[i] = 1.f/(1.f+40.f*16.f*pi4*avg_mod)-.015f;</span>
<span class="lineNum">     456 </span>            :        /* No delay on this detection, but it's less reliable. */
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :        tonality2[i] = 1.f/(1.f+40.f*16.f*pi4*mod2)-.015f;</span>
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :        A[i] = angle2;</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :        dA[i] = d_angle2;</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :        d2A[i] = mod2;</span>
<span class="lineNum">     462 </span>            :     }
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :     for (i=2;i&lt;N2-1;i++)</span>
<span class="lineNum">     464 </span>            :     {
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :        float tt = MIN32(tonality2[i], MAX32(tonality2[i-1], tonality2[i+1]));</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :        tonality[i] = .9f*MAX32(tonality[i], tt-.1f);</span>
<span class="lineNum">     467 </span>            :     }
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     frame_tonality = 0;</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :     max_frame_tonality = 0;</span>
<span class="lineNum">     470 </span>            :     /*tw_sum = 0;*/
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :     info-&gt;activity = 0;</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     frame_noisiness = 0;</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     frame_stationarity = 0;</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     if (!tonal-&gt;count)</span>
<span class="lineNum">     475 </span>            :     {
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :        for (b=0;b&lt;NB_TBANDS;b++)</span>
<span class="lineNum">     477 </span>            :        {
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :           tonal-&gt;lowE[b] = 1e10;</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :           tonal-&gt;highE[b] = -1e10;</span>
<span class="lineNum">     480 </span>            :        }
<span class="lineNum">     481 </span>            :     }
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :     relativeE = 0;</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     frame_loudness = 0;</span>
<span class="lineNum">     484 </span>            :     /* The energy of the very first band is special because of DC. */
<span class="lineNum">     485 </span>            :     {
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :        float E = 0;</span>
<span class="lineNum">     487 </span>            :        float X1r, X2r;
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :        X1r = 2*(float)out[0].r;</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :        X2r = 2*(float)out[0].i;</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :        E = X1r*X1r + X2r*X2r;</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :        for (i=1;i&lt;4;i++)</span>
<span class="lineNum">     492 </span>            :        {
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :           float binE = out[i].r*(float)out[i].r + out[N-i].r*(float)out[N-i].r</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :                      + out[i].i*(float)out[i].i + out[N-i].i*(float)out[N-i].i;</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :           E += binE;</span>
<span class="lineNum">     496 </span>            :        }
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :        E = SCALE_ENER(E);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :        band_log2[0] = .5f*1.442695f*(float)log(E+1e-10f);</span>
<span class="lineNum">     499 </span>            :     }
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :     for (b=0;b&lt;NB_TBANDS;b++)</span>
<span class="lineNum">     501 </span>            :     {
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :        float E=0, tE=0, nE=0;</span>
<span class="lineNum">     503 </span>            :        float L1, L2;
<span class="lineNum">     504 </span>            :        float stationarity;
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :        for (i=tbands[b];i&lt;tbands[b+1];i++)</span>
<span class="lineNum">     506 </span>            :        {
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :           float binE = out[i].r*(float)out[i].r + out[N-i].r*(float)out[N-i].r</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                      + out[i].i*(float)out[i].i + out[N-i].i*(float)out[N-i].i;</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :           binE = SCALE_ENER(binE);</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :           E += binE;</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :           tE += binE*MAX32(0, tonality[i]);</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :           nE += binE*2.f*(.5f-noisiness[i]);</span>
<span class="lineNum">     513 </span>            :        }
<span class="lineNum">     514 </span>            : #ifndef FIXED_POINT
<span class="lineNum">     515 </span>            :        /* Check for extreme band energies that could cause NaNs later. */
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :        if (!(E&lt;1e9f) || celt_isnan(E))</span>
<span class="lineNum">     517 </span>            :        {
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :           info-&gt;valid = 0;</span>
<span class="lineNum">     519 </span>            :           RESTORE_STACK;
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :           return;</span>
<span class="lineNum">     521 </span>            :        }
<span class="lineNum">     522 </span>            : #endif
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :        tonal-&gt;E[tonal-&gt;E_count][b] = E;</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :        frame_noisiness += nE/(1e-15f+E);</span>
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :        frame_loudness += (float)sqrt(E+1e-10f);</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :        logE[b] = (float)log(E+1e-10f);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :        band_log2[b+1] = .5f*1.442695f*(float)log(E+1e-10f);</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :        tonal-&gt;logE[tonal-&gt;E_count][b] = logE[b];</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :        if (tonal-&gt;count==0)</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :           tonal-&gt;highE[b] = tonal-&gt;lowE[b] = logE[b];</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :        if (tonal-&gt;highE[b] &gt; tonal-&gt;lowE[b] + 7.5)</span>
<span class="lineNum">     534 </span>            :        {
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :           if (tonal-&gt;highE[b] - logE[b] &gt; logE[b] - tonal-&gt;lowE[b])</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :              tonal-&gt;highE[b] -= .01f;</span>
<span class="lineNum">     537 </span>            :           else
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :              tonal-&gt;lowE[b] += .01f;</span>
<span class="lineNum">     539 </span>            :        }
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :        if (logE[b] &gt; tonal-&gt;highE[b])</span>
<span class="lineNum">     541 </span>            :        {
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :           tonal-&gt;highE[b] = logE[b];</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :           tonal-&gt;lowE[b] = MAX32(tonal-&gt;highE[b]-15, tonal-&gt;lowE[b]);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :        } else if (logE[b] &lt; tonal-&gt;lowE[b])</span>
<span class="lineNum">     545 </span>            :        {
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :           tonal-&gt;lowE[b] = logE[b];</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :           tonal-&gt;highE[b] = MIN32(tonal-&gt;lowE[b]+15, tonal-&gt;highE[b]);</span>
<span class="lineNum">     548 </span>            :        }
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :        relativeE += (logE[b]-tonal-&gt;lowE[b])/(1e-15f + (tonal-&gt;highE[b]-tonal-&gt;lowE[b]));</span>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :        L1=L2=0;</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :        for (i=0;i&lt;NB_FRAMES;i++)</span>
<span class="lineNum">     553 </span>            :        {
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :           L1 += (float)sqrt(tonal-&gt;E[i][b]);</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :           L2 += tonal-&gt;E[i][b];</span>
<span class="lineNum">     556 </span>            :        }
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :        stationarity = MIN16(0.99f,L1/(float)sqrt(1e-15+NB_FRAMES*L2));</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :        stationarity *= stationarity;</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :        stationarity *= stationarity;</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :        frame_stationarity += stationarity;</span>
<span class="lineNum">     562 </span>            :        /*band_tonality[b] = tE/(1e-15+E)*/;
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :        band_tonality[b] = MAX16(tE/(1e-15f+E), stationarity*tonal-&gt;prev_band_tonality[b]);</span>
<span class="lineNum">     564 </span>            : #if 0
<span class="lineNum">     565 </span>            :        if (b&gt;=NB_TONAL_SKIP_BANDS)
<span class="lineNum">     566 </span>            :        {
<span class="lineNum">     567 </span>            :           frame_tonality += tweight[b]*band_tonality[b];
<span class="lineNum">     568 </span>            :           tw_sum += tweight[b];
<span class="lineNum">     569 </span>            :        }
<span class="lineNum">     570 </span>            : #else
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :        frame_tonality += band_tonality[b];</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :        if (b&gt;=NB_TBANDS-NB_TONAL_SKIP_BANDS)</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :           frame_tonality -= band_tonality[b-NB_TBANDS+NB_TONAL_SKIP_BANDS];</span>
<span class="lineNum">     574 </span>            : #endif
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :        max_frame_tonality = MAX16(max_frame_tonality, (1.f+.03f*(b-NB_TBANDS))*frame_tonality);</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :        slope += band_tonality[b]*(b-8);</span>
<span class="lineNum">     577 </span>            :        /*printf(&quot;%f %f &quot;, band_tonality[b], stationarity);*/
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :        tonal-&gt;prev_band_tonality[b] = band_tonality[b];</span>
<span class="lineNum">     579 </span>            :     }
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :     leakage_from[0] = band_log2[0];</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :     leakage_to[0] = band_log2[0] - LEAKAGE_OFFSET;</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :     for (b=1;b&lt;NB_TBANDS+1;b++)</span>
<span class="lineNum">     584 </span>            :     {
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :        float leak_slope = LEAKAGE_SLOPE*(tbands[b]-tbands[b-1])/4;</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :        leakage_from[b] = MIN16(leakage_from[b-1]+leak_slope, band_log2[b]);</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :        leakage_to[b] = MAX16(leakage_to[b-1]-leak_slope, band_log2[b]-LEAKAGE_OFFSET);</span>
<span class="lineNum">     588 </span>            :     }
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :     for (b=NB_TBANDS-2;b&gt;=0;b--)</span>
<span class="lineNum">     590 </span>            :     {
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :        float leak_slope = LEAKAGE_SLOPE*(tbands[b+1]-tbands[b])/4;</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :        leakage_from[b] = MIN16(leakage_from[b+1]+leak_slope, leakage_from[b]);</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :        leakage_to[b] = MAX16(leakage_to[b+1]-leak_slope, leakage_to[b]);</span>
<span class="lineNum">     594 </span>            :     }
<span class="lineNum">     595 </span>            :     celt_assert(NB_TBANDS+1 &lt;= LEAK_BANDS);
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :     for (b=0;b&lt;NB_TBANDS+1;b++)</span>
<span class="lineNum">     597 </span>            :     {
<span class="lineNum">     598 </span>            :        /* leak_boost[] is made up of two terms. The first, based on leakage_to[],
<span class="lineNum">     599 </span>            :           represents the boost needed to overcome the amount of analysis leakage
<span class="lineNum">     600 </span>            :           cause in a weaker band b by louder neighbouring bands.
<span class="lineNum">     601 </span>            :           The second, based on leakage_from[], applies to a loud band b for
<span class="lineNum">     602 </span>            :           which the quantization noise causes synthesis leakage to the weaker
<span class="lineNum">     603 </span>            :           neighbouring bands. */
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :        float boost = MAX16(0, leakage_to[b] - band_log2[b]) +</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :              MAX16(0, band_log2[b] - (leakage_from[b]+LEAKAGE_OFFSET));</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :        info-&gt;leak_boost[b] = IMIN(255, (int)floor(.5 + 64.f*boost));</span>
<span class="lineNum">     607 </span>            :     }
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     for (;b&lt;LEAK_BANDS;b++) info-&gt;leak_boost[b] = 0;</span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;NB_FRAMES;i++)</span>
<span class="lineNum">     611 </span>            :     {
<span class="lineNum">     612 </span>            :        int j;
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :        float mindist = 1e15f;</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :        for (j=0;j&lt;NB_FRAMES;j++)</span>
<span class="lineNum">     615 </span>            :        {
<span class="lineNum">     616 </span>            :           int k;
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :           float dist=0;</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :           for (k=0;k&lt;NB_TBANDS;k++)</span>
<span class="lineNum">     619 </span>            :           {
<span class="lineNum">     620 </span>            :              float tmp;
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :              tmp = tonal-&gt;logE[i][k] - tonal-&gt;logE[j][k];</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :              dist += tmp*tmp;</span>
<span class="lineNum">     623 </span>            :           }
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :           if (j!=i)</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :              mindist = MIN32(mindist, dist);</span>
<span class="lineNum">     626 </span>            :        }
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :        spec_variability += mindist;</span>
<span class="lineNum">     628 </span>            :     }
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :     spec_variability = (float)sqrt(spec_variability/NB_FRAMES/NB_TBANDS);</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :     bandwidth_mask = 0;</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :     bandwidth = 0;</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :     maxE = 0;</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :     noise_floor = 5.7e-4f/(1&lt;&lt;(IMAX(0,lsb_depth-8)));</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :     noise_floor *= noise_floor;</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :     for (b=0;b&lt;NB_TBANDS;b++)</span>
<span class="lineNum">     636 </span>            :     {
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :        float E=0;</span>
<span class="lineNum">     638 </span>            :        int band_start, band_end;
<span class="lineNum">     639 </span>            :        /* Keep a margin of 300 Hz for aliasing */
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :        band_start = tbands[b];</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :        band_end = tbands[b+1];</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :        for (i=band_start;i&lt;band_end;i++)</span>
<span class="lineNum">     643 </span>            :        {
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :           float binE = out[i].r*(float)out[i].r + out[N-i].r*(float)out[N-i].r</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :                      + out[i].i*(float)out[i].i + out[N-i].i*(float)out[N-i].i;</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :           E += binE;</span>
<span class="lineNum">     647 </span>            :        }
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :        E = SCALE_ENER(E);</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :        maxE = MAX32(maxE, E);</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :        tonal-&gt;meanE[b] = MAX32((1-alphaE2)*tonal-&gt;meanE[b], E);</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :        E = MAX32(E, tonal-&gt;meanE[b]);</span>
<span class="lineNum">     652 </span>            :        /* Use a simple follower with 13 dB/Bark slope for spreading function */
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :        bandwidth_mask = MAX32(.05f*bandwidth_mask, E);</span>
<span class="lineNum">     654 </span>            :        /* Consider the band &quot;active&quot; only if all these conditions are met:
<span class="lineNum">     655 </span>            :           1) less than 10 dB below the simple follower
<span class="lineNum">     656 </span>            :           2) less than 90 dB below the peak band (maximal masking possible considering
<span class="lineNum">     657 </span>            :              both the ATH and the loudness-dependent slope of the spreading function)
<span class="lineNum">     658 </span>            :           3) above the PCM quantization noise floor
<span class="lineNum">     659 </span>            :           We use b+1 because the first CELT band isn't included in tbands[]
<span class="lineNum">     660 </span>            :        */
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :        if (E&gt;.1*bandwidth_mask &amp;&amp; E*1e9f &gt; maxE &amp;&amp; E &gt; noise_floor*(band_end-band_start))</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :           bandwidth = b+1;</span>
<span class="lineNum">     663 </span>            :     }
<span class="lineNum">     664 </span>            :     /* Special case for the last two bands, for which we don't have spectrum but only
<span class="lineNum">     665 </span>            :        the energy above 12 kHz. */
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :     if (tonal-&gt;Fs == 48000) {</span>
<span class="lineNum">     667 </span>            :        float ratio;
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :        float E = hp_ener*(1.f/(240*240));</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :        ratio = tonal-&gt;prev_bandwidth==20 ? 0.03f : 0.07f;</span>
<span class="lineNum">     670 </span>            : #ifdef FIXED_POINT
<span class="lineNum">     671 </span>            :        /* silk_resampler_down2_hp() shifted right by an extra 8 bits. */
<span class="lineNum">     672 </span>            :        E *= 256.f*(1.f/Q15ONE)*(1.f/Q15ONE);
<span class="lineNum">     673 </span>            : #endif
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :        maxE = MAX32(maxE, E);</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :        tonal-&gt;meanE[b] = MAX32((1-alphaE2)*tonal-&gt;meanE[b], E);</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :        E = MAX32(E, tonal-&gt;meanE[b]);</span>
<span class="lineNum">     677 </span>            :        /* Use a simple follower with 13 dB/Bark slope for spreading function */
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :        bandwidth_mask = MAX32(.05f*bandwidth_mask, E);</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :        if (E&gt;ratio*bandwidth_mask &amp;&amp; E*1e9f &gt; maxE &amp;&amp; E &gt; noise_floor*160)</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :           bandwidth = 20;</span>
<span class="lineNum">     681 </span>            :        /* This detector is unreliable, so if the bandwidth is close to SWB, assume it's FB. */
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :        if (bandwidth &gt;= 17)</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :           bandwidth = 20;</span>
<span class="lineNum">     684 </span>            :     }
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :     if (tonal-&gt;count&lt;=2)</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :        bandwidth = 20;</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :     frame_loudness = 20*(float)log10(frame_loudness);</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :     tonal-&gt;Etracker = MAX32(tonal-&gt;Etracker-.003f, frame_loudness);</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :     tonal-&gt;lowECount *= (1-alphaE);</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :     if (frame_loudness &lt; tonal-&gt;Etracker-30)</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :        tonal-&gt;lowECount += alphaE;</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;8;i++)</span>
<span class="lineNum">     694 </span>            :     {
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :        float sum=0;</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :        for (b=0;b&lt;16;b++)</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :           sum += dct_table[i*16+b]*logE[b];</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :        BFCC[i] = sum;</span>
<span class="lineNum">     699 </span>            :     }
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;8;i++)</span>
<span class="lineNum">     701 </span>            :     {
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :        float sum=0;</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :        for (b=0;b&lt;16;b++)</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :           sum += dct_table[i*16+b]*.5f*(tonal-&gt;highE[b]+tonal-&gt;lowE[b]);</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :        midE[i] = sum;</span>
<span class="lineNum">     706 </span>            :     }
<span class="lineNum">     707 </span>            : 
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :     frame_stationarity /= NB_TBANDS;</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :     relativeE /= NB_TBANDS;</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :     if (tonal-&gt;count&lt;10)</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :        relativeE = .5f;</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :     frame_noisiness /= NB_TBANDS;</span>
<span class="lineNum">     713 </span>            : #if 1
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :     info-&gt;activity = frame_noisiness + (1-frame_noisiness)*relativeE;</span>
<span class="lineNum">     715 </span>            : #else
<span class="lineNum">     716 </span>            :     info-&gt;activity = .5*(1+frame_noisiness-frame_stationarity);
<span class="lineNum">     717 </span>            : #endif
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :     frame_tonality = (max_frame_tonality/(NB_TBANDS-NB_TONAL_SKIP_BANDS));</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :     frame_tonality = MAX16(frame_tonality, tonal-&gt;prev_tonality*.8f);</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :     tonal-&gt;prev_tonality = frame_tonality;</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :     slope /= 8*8;</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :     info-&gt;tonality_slope = slope;</span>
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :     tonal-&gt;E_count = (tonal-&gt;E_count+1)%NB_FRAMES;</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :     tonal-&gt;count = IMIN(tonal-&gt;count+1, ANALYSIS_COUNT_MAX);</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :     info-&gt;tonality = frame_tonality;</span>
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;4;i++)</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :        features[i] = -0.12299f*(BFCC[i]+tonal-&gt;mem[i+24]) + 0.49195f*(tonal-&gt;mem[i]+tonal-&gt;mem[i+16]) + 0.69693f*tonal-&gt;mem[i+8] - 1.4349f*tonal-&gt;cmean[i];</span>
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;4;i++)</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :        tonal-&gt;cmean[i] = (1-alpha)*tonal-&gt;cmean[i] + alpha*BFCC[i];</span>
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;4;i++)</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :         features[4+i] = 0.63246f*(BFCC[i]-tonal-&gt;mem[i+24]) + 0.31623f*(tonal-&gt;mem[i]-tonal-&gt;mem[i+16]);</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;3;i++)</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :         features[8+i] = 0.53452f*(BFCC[i]+tonal-&gt;mem[i+24]) - 0.26726f*(tonal-&gt;mem[i]+tonal-&gt;mem[i+16]) -0.53452f*tonal-&gt;mem[i+8];</span>
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :     if (tonal-&gt;count &gt; 5)</span>
<span class="lineNum">     741 </span>            :     {
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :        for (i=0;i&lt;9;i++)</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :           tonal-&gt;std[i] = (1-alpha)*tonal-&gt;std[i] + alpha*features[i]*features[i];</span>
<span class="lineNum">     744 </span>            :     }
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;4;i++)</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :        features[i] = BFCC[i]-midE[i];</span>
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;8;i++)</span>
<span class="lineNum">     749 </span>            :     {
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :        tonal-&gt;mem[i+24] = tonal-&gt;mem[i+16];</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :        tonal-&gt;mem[i+16] = tonal-&gt;mem[i+8];</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :        tonal-&gt;mem[i+8] = tonal-&gt;mem[i];</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :        tonal-&gt;mem[i] = BFCC[i];</span>
<span class="lineNum">     754 </span>            :     }
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;9;i++)</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :        features[11+i] = (float)sqrt(tonal-&gt;std[i]) - std_feature_bias[i];</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     features[18] = spec_variability - 0.78f;</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :     features[20] = info-&gt;tonality - 0.154723f;</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :     features[21] = info-&gt;activity - 0.724643f;</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     features[22] = frame_stationarity - 0.743717f;</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     features[23] = info-&gt;tonality_slope + 0.069216f;</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :     features[24] = tonal-&gt;lowECount - 0.067930f;</span>
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :     mlp_process(&amp;net, features, frame_probs);</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :     frame_probs[0] = .5f*(frame_probs[0]+1);</span>
<span class="lineNum">     766 </span>            :     /* Curve fitting between the MLP probability and the actual probability */
<span class="lineNum">     767 </span>            :     /*frame_probs[0] = .01f + 1.21f*frame_probs[0]*frame_probs[0] - .23f*(float)pow(frame_probs[0], 10);*/
<span class="lineNum">     768 </span>            :     /* Probability of active audio (as opposed to silence) */
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :     frame_probs[1] = .5f*frame_probs[1]+.5f;</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :     frame_probs[1] *= frame_probs[1];</span>
<span class="lineNum">     771 </span>            : 
<span class="lineNum">     772 </span>            :     /* Probability of speech or music vs noise */
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :     info-&gt;activity_probability = frame_probs[1];</span>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span>            :     /*printf(&quot;%f %f\n&quot;, frame_probs[0], frame_probs[1]);*/
<span class="lineNum">     776 </span>            :     {
<span class="lineNum">     777 </span>            :        /* Probability of state transition */
<span class="lineNum">     778 </span>            :        float tau;
<span class="lineNum">     779 </span>            :        /* Represents independence of the MLP probabilities, where
<span class="lineNum">     780 </span>            :           beta=1 means fully independent. */
<span class="lineNum">     781 </span>            :        float beta;
<span class="lineNum">     782 </span>            :        /* Denormalized probability of speech (p0) and music (p1) after update */
<span class="lineNum">     783 </span>            :        float p0, p1;
<span class="lineNum">     784 </span>            :        /* Probabilities for &quot;all speech&quot; and &quot;all music&quot; */
<span class="lineNum">     785 </span>            :        float s0, m0;
<span class="lineNum">     786 </span>            :        /* Probability sum for renormalisation */
<span class="lineNum">     787 </span>            :        float psum;
<span class="lineNum">     788 </span>            :        /* Instantaneous probability of speech and music, with beta pre-applied. */
<span class="lineNum">     789 </span>            :        float speech0;
<span class="lineNum">     790 </span>            :        float music0;
<span class="lineNum">     791 </span>            :        float p, q;
<span class="lineNum">     792 </span>            : 
<span class="lineNum">     793 </span>            :        /* More silence transitions for speech than for music. */
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :        tau = .001f*tonal-&gt;music_prob + .01f*(1-tonal-&gt;music_prob);</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :        p = MAX16(.05f,MIN16(.95f,frame_probs[1]));</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :        q = MAX16(.05f,MIN16(.95f,tonal-&gt;vad_prob));</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :        beta = .02f+.05f*ABS16(p-q)/(p*(1-q)+q*(1-p));</span>
<span class="lineNum">     798 </span>            :        /* p0 and p1 are the probabilities of speech and music at this frame
<span class="lineNum">     799 </span>            :           using only information from previous frame and applying the
<span class="lineNum">     800 </span>            :           state transition model */
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :        p0 = (1-tonal-&gt;vad_prob)*(1-tau) +    tonal-&gt;vad_prob *tau;</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :        p1 =    tonal-&gt;vad_prob *(1-tau) + (1-tonal-&gt;vad_prob)*tau;</span>
<span class="lineNum">     803 </span>            :        /* We apply the current probability with exponent beta to work around
<span class="lineNum">     804 </span>            :           the fact that the probability estimates aren't independent. */
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :        p0 *= (float)pow(1-frame_probs[1], beta);</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :        p1 *= (float)pow(frame_probs[1], beta);</span>
<span class="lineNum">     807 </span>            :        /* Normalise the probabilities to get the Marokv probability of music. */
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :        tonal-&gt;vad_prob = p1/(p0+p1);</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :        info-&gt;vad_prob = tonal-&gt;vad_prob;</span>
<span class="lineNum">     810 </span>            :        /* Consider that silence has a 50-50 probability of being speech or music. */
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :        frame_probs[0] = tonal-&gt;vad_prob*frame_probs[0] + (1-tonal-&gt;vad_prob)*.5f;</span>
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span>            :        /* One transition every 3 minutes of active audio */
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :        tau = .0001f;</span>
<span class="lineNum">     815 </span>            :        /* Adapt beta based on how &quot;unexpected&quot; the new prob is */
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :        p = MAX16(.05f,MIN16(.95f,frame_probs[0]));</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :        q = MAX16(.05f,MIN16(.95f,tonal-&gt;music_prob));</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :        beta = .02f+.05f*ABS16(p-q)/(p*(1-q)+q*(1-p));</span>
<span class="lineNum">     819 </span>            :        /* p0 and p1 are the probabilities of speech and music at this frame
<span class="lineNum">     820 </span>            :           using only information from previous frame and applying the
<span class="lineNum">     821 </span>            :           state transition model */
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :        p0 = (1-tonal-&gt;music_prob)*(1-tau) +    tonal-&gt;music_prob *tau;</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :        p1 =    tonal-&gt;music_prob *(1-tau) + (1-tonal-&gt;music_prob)*tau;</span>
<span class="lineNum">     824 </span>            :        /* We apply the current probability with exponent beta to work around
<span class="lineNum">     825 </span>            :           the fact that the probability estimates aren't independent. */
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :        p0 *= (float)pow(1-frame_probs[0], beta);</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :        p1 *= (float)pow(frame_probs[0], beta);</span>
<span class="lineNum">     828 </span>            :        /* Normalise the probabilities to get the Marokv probability of music. */
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :        tonal-&gt;music_prob = p1/(p0+p1);</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :        info-&gt;music_prob = tonal-&gt;music_prob;</span>
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span>            :        /*printf(&quot;%f %f %f %f\n&quot;, frame_probs[0], frame_probs[1], tonal-&gt;music_prob, tonal-&gt;vad_prob);*/
<span class="lineNum">     833 </span>            :        /* This chunk of code deals with delayed decision. */
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :        psum=1e-20f;</span>
<span class="lineNum">     835 </span>            :        /* Instantaneous probability of speech and music, with beta pre-applied. */
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :        speech0 = (float)pow(1-frame_probs[0], beta);</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :        music0  = (float)pow(frame_probs[0], beta);</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :        if (tonal-&gt;count==1)</span>
<span class="lineNum">     839 </span>            :        {
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :           if (tonal-&gt;application == OPUS_APPLICATION_VOIP)</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :              tonal-&gt;pmusic[0] = .1f;</span>
<span class="lineNum">     842 </span>            :           else
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :              tonal-&gt;pmusic[0] = .625f;</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :           tonal-&gt;pspeech[0] = 1-tonal-&gt;pmusic[0];</span>
<span class="lineNum">     845 </span>            :        }
<span class="lineNum">     846 </span>            :        /* Updated probability of having only speech (s0) or only music (m0),
<span class="lineNum">     847 </span>            :           before considering the new observation. */
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :        s0 = tonal-&gt;pspeech[0] + tonal-&gt;pspeech[1];</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :        m0 = tonal-&gt;pmusic [0] + tonal-&gt;pmusic [1];</span>
<span class="lineNum">     850 </span>            :        /* Updates s0 and m0 with instantaneous probability. */
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :        tonal-&gt;pspeech[0] = s0*(1-tau)*speech0;</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :        tonal-&gt;pmusic [0] = m0*(1-tau)*music0;</span>
<span class="lineNum">     853 </span>            :        /* Propagate the transition probabilities */
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :        for (i=1;i&lt;DETECT_SIZE-1;i++)</span>
<span class="lineNum">     855 </span>            :        {
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :           tonal-&gt;pspeech[i] = tonal-&gt;pspeech[i+1]*speech0;</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :           tonal-&gt;pmusic [i] = tonal-&gt;pmusic [i+1]*music0;</span>
<span class="lineNum">     858 </span>            :        }
<span class="lineNum">     859 </span>            :        /* Probability that the latest frame is speech, when all the previous ones were music. */
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :        tonal-&gt;pspeech[DETECT_SIZE-1] = m0*tau*speech0;</span>
<span class="lineNum">     861 </span>            :        /* Probability that the latest frame is music, when all the previous ones were speech. */
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :        tonal-&gt;pmusic [DETECT_SIZE-1] = s0*tau*music0;</span>
<span class="lineNum">     863 </span>            : 
<span class="lineNum">     864 </span>            :        /* Renormalise probabilities to 1 */
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :        for (i=0;i&lt;DETECT_SIZE;i++)</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :           psum += tonal-&gt;pspeech[i] + tonal-&gt;pmusic[i];</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :        psum = 1.f/psum;</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :        for (i=0;i&lt;DETECT_SIZE;i++)</span>
<span class="lineNum">     869 </span>            :        {
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :           tonal-&gt;pspeech[i] *= psum;</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :           tonal-&gt;pmusic [i] *= psum;</span>
<span class="lineNum">     872 </span>            :        }
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :        psum = tonal-&gt;pmusic[0];</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :        for (i=1;i&lt;DETECT_SIZE;i++)</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :           psum += tonal-&gt;pspeech[i];</span>
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span>            :        /* Estimate our confidence in the speech/music decisions */
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :        if (frame_probs[1]&gt;.75)</span>
<span class="lineNum">     879 </span>            :        {
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :           if (tonal-&gt;music_prob&gt;.9)</span>
<span class="lineNum">     881 </span>            :           {
<span class="lineNum">     882 </span>            :              float adapt;
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :              adapt = 1.f/(++tonal-&gt;music_confidence_count);</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :              tonal-&gt;music_confidence_count = IMIN(tonal-&gt;music_confidence_count, 500);</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :              tonal-&gt;music_confidence += adapt*MAX16(-.2f,frame_probs[0]-tonal-&gt;music_confidence);</span>
<span class="lineNum">     886 </span>            :           }
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :           if (tonal-&gt;music_prob&lt;.1)</span>
<span class="lineNum">     888 </span>            :           {
<span class="lineNum">     889 </span>            :              float adapt;
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :              adapt = 1.f/(++tonal-&gt;speech_confidence_count);</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :              tonal-&gt;speech_confidence_count = IMIN(tonal-&gt;speech_confidence_count, 500);</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :              tonal-&gt;speech_confidence += adapt*MIN16(.2f,frame_probs[0]-tonal-&gt;speech_confidence);</span>
<span class="lineNum">     893 </span>            :           }
<span class="lineNum">     894 </span>            :        }
<span class="lineNum">     895 </span>            :     }
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :     tonal-&gt;last_music = tonal-&gt;music_prob&gt;.5f;</span>
<span class="lineNum">     897 </span>            : #ifdef MLP_TRAINING
<span class="lineNum">     898 </span>            :     for (i=0;i&lt;25;i++)
<span class="lineNum">     899 </span>            :        printf(&quot;%f &quot;, features[i]);
<span class="lineNum">     900 </span>            :     printf(&quot;\n&quot;);
<span class="lineNum">     901 </span>            : #endif
<span class="lineNum">     902 </span>            : 
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :     info-&gt;bandwidth = bandwidth;</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :     tonal-&gt;prev_bandwidth = bandwidth;</span>
<span class="lineNum">     905 </span>            :     /*printf(&quot;%d %d\n&quot;, info-&gt;bandwidth, info-&gt;opus_bandwidth);*/
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     info-&gt;noisiness = frame_noisiness;</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :     info-&gt;valid = 1;</span>
<span class="lineNum">     908 </span>            :     RESTORE_STACK;
<a name="909"><span class="lineNum">     909 </span>            : }</a>
<span class="lineNum">     910 </span>            : 
<span class="lineNum">     911 </span><span class="lineNoCov">          0 : void run_analysis(TonalityAnalysisState *analysis, const CELTMode *celt_mode, const void *analysis_pcm,</span>
<span class="lineNum">     912 </span>            :                  int analysis_frame_size, int frame_size, int c1, int c2, int C, opus_int32 Fs,
<span class="lineNum">     913 </span>            :                  int lsb_depth, downmix_func downmix, AnalysisInfo *analysis_info)
<span class="lineNum">     914 </span>            : {
<span class="lineNum">     915 </span>            :    int offset;
<span class="lineNum">     916 </span>            :    int pcm_len;
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :    analysis_frame_size -= analysis_frame_size&amp;1;</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :    if (analysis_pcm != NULL)</span>
<span class="lineNum">     920 </span>            :    {
<span class="lineNum">     921 </span>            :       /* Avoid overflow/wrap-around of the analysis buffer */
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :       analysis_frame_size = IMIN((DETECT_SIZE-5)*Fs/50, analysis_frame_size);</span>
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :       pcm_len = analysis_frame_size - analysis-&gt;analysis_offset;</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :       offset = analysis-&gt;analysis_offset;</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :       while (pcm_len&gt;0) {</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :          tonality_analysis(analysis, celt_mode, analysis_pcm, IMIN(Fs/50, pcm_len), offset, c1, c2, C, lsb_depth, downmix);</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :          offset += Fs/50;</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :          pcm_len -= Fs/50;</span>
<span class="lineNum">     930 </span>            :       }
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :       analysis-&gt;analysis_offset = analysis_frame_size;</span>
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :       analysis-&gt;analysis_offset -= frame_size;</span>
<span class="lineNum">     934 </span>            :    }
<span class="lineNum">     935 </span>            : 
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :    analysis_info-&gt;valid = 0;</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :    tonality_get_info(analysis, analysis_info, frame_size);</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     939 </span>            : 
<span class="lineNum">     940 </span>            : #endif /* DISABLE_FLOAT_API */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

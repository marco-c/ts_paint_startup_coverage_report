<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - media/webrtc/trunk/webrtc/modules/audio_coding/codecs/isac/fix/source/decode_plc.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../../../../../index.html">top level</a> - <a href="index.html">media/webrtc/trunk/webrtc/modules/audio_coding/codecs/isac/fix/source</a> - decode_plc.c<span style="font-size: 80%;"> (source / <a href="decode_plc.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">295</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">6</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *  Copyright (c) 2011 The WebRTC project authors. All Rights Reserved.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *  Use of this source code is governed by a BSD-style license
<span class="lineNum">       5 </span>            :  *  that can be found in the LICENSE file in the root of the source
<span class="lineNum">       6 </span>            :  *  tree. An additional intellectual property rights grant can be found
<span class="lineNum">       7 </span>            :  *  in the file PATENTS.  All contributing project authors may
<span class="lineNum">       8 </span>            :  *  be found in the AUTHORS file in the root of the source tree.
<span class="lineNum">       9 </span>            :  */
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : /*
<span class="lineNum">      12 </span>            :  * decode_plc.c
<span class="lineNum">      13 </span>            :  *
<span class="lineNum">      14 </span>            :  * Packet Loss Concealment.
<span class="lineNum">      15 </span>            :  *
<span class="lineNum">      16 </span>            :  */
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #include &quot;settings.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;entropy_coding.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;pitch_estimator.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;bandwidth_estimator.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;structs.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;codec.h&quot;
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #define NO_OF_PRIMES 8
<span class="lineNum">      29 </span>            : #define NOISE_FILTER_LEN 30
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : /*
<span class="lineNum">      32 </span>            :  * function to decode the bitstream
<span class="lineNum">      33 </span>            :  * returns the total number of bytes in the stream
<a name="34"><span class="lineNum">      34 </span>            :  */</a>
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span><span class="lineNoCov">          0 : static int16_t plc_filterma_Fast(</span>
<span class="lineNum">      37 </span>            :     int16_t *In,  /* (i)   Vector to be filtered. InOut[-orderCoef+1]
<span class="lineNum">      38 </span>            :                            to InOut[-1] contains state */
<span class="lineNum">      39 </span>            :     int16_t *Out,  /* (o)   Filtered vector */
<span class="lineNum">      40 </span>            :     int16_t *B,   /* (i)   The filter coefficients (in Q0) */
<span class="lineNum">      41 </span>            :     int16_t Blen,  /* (i)   Number of B coefficients */
<span class="lineNum">      42 </span>            :     int16_t len,   /* (i)  Number of samples to be filtered */
<span class="lineNum">      43 </span>            :     int16_t reduceDecay,
<span class="lineNum">      44 </span>            :     int16_t decay,
<span class="lineNum">      45 </span>            :     int16_t rshift )
<span class="lineNum">      46 </span>            : {
<span class="lineNum">      47 </span>            :   int i, j;
<span class="lineNum">      48 </span>            :   int32_t o;
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :   int32_t lim = (1 &lt;&lt; (15 + rshift)) - 1;</span>
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; len; i++)</span>
<span class="lineNum">      52 </span>            :   {
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :     const int16_t *b_ptr = &amp;B[0];</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :     const int16_t *x_ptr = &amp;In[i];</span>
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :     o = (int32_t)0;</span>
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :     for (j = 0;j &lt; Blen; j++)</span>
<span class="lineNum">      59 </span>            :     {
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :       o = WebRtcSpl_AddSatW32(o, *b_ptr * *x_ptr);</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :       b_ptr++;</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :       x_ptr--;</span>
<span class="lineNum">      63 </span>            :     }
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            :     /* to round off correctly */
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :     o = WebRtcSpl_AddSatW32(o, 1 &lt;&lt; (rshift - 1));</span>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            :     /* saturate according to the domain of the filter coefficients */
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :     o = WEBRTC_SPL_SAT((int32_t)lim, o, (int32_t)-lim);</span>
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            :     /* o should be in the range of int16_t */
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :     o &gt;&gt;= rshift;</span>
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            :     /* decay the output signal; this is specific to plc */
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :     *Out++ = (int16_t)((int16_t)o * decay &gt;&gt; 15);</span>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            :     /* change the decay */
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :     decay -= reduceDecay;</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :     if( decay &lt; 0 )</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :       decay = 0;</span>
<span class="lineNum">      81 </span>            :   }
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :   return( decay );</span>
<span class="lineNum">      83 </span>            : }
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span>            : 
<a name="90"><span class="lineNum">      90 </span>            : </a>
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span><span class="lineNoCov">          0 : static __inline int32_t log2_Q8_T( uint32_t x ) {</span>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            :   int32_t zeros;
<span class="lineNum">      95 </span>            :   int16_t frac;
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :   zeros=WebRtcSpl_NormU32(x);</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   frac = (int16_t)(((x &lt;&lt; zeros) &amp; 0x7FFFFFFF) &gt;&gt; 23);</span>
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            :   /* log2(magn(i)) */
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :   return ((31 - zeros) &lt;&lt; 8) + frac;</span>
<a name="102"><span class="lineNum">     102 </span>            : }</a>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span><span class="lineNoCov">          0 : static __inline int16_t  exp2_Q10_T(int16_t x) { // Both in and out in Q10</span>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :   int16_t tmp16_1, tmp16_2;
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   tmp16_2=(int16_t)(0x0400|(x&amp;0x03FF));</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :   tmp16_1 = -(x &gt;&gt; 10);</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :   if(tmp16_1&gt;0)</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :     return tmp16_2 &gt;&gt; tmp16_1;</span>
<span class="lineNum">     112 </span>            :   else
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     return tmp16_2 &lt;&lt; -tmp16_1;</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span>            : }
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span>            : /*
<span class="lineNum">     119 </span>            :   This is a fixed-point version of the above code with limLow = 700 and limHigh = 5000,
<span class="lineNum">     120 </span>            :   hard-coded. The values 700 and 5000 were experimentally obtained.
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            :   The function implements membership values for two sets. The mebership functions are
<a name="123"><span class="lineNum">     123 </span>            :   of second orders corresponding to half-bell-shapped pulses.</a>
<span class="lineNum">     124 </span>            : */
<span class="lineNum">     125 </span><span class="lineNoCov">          0 : static void MemshipValQ15( int16_t in, int16_t *A, int16_t *B )</span>
<span class="lineNum">     126 </span>            : {
<span class="lineNum">     127 </span>            :   int16_t x;
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :   in -= 700;    /* translate the lowLim to 0, limHigh = 5000 - 700, M = 2150 */</span>
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   if( in &lt;= 2150 )</span>
<span class="lineNum">     132 </span>            :   {
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     if( in &gt; 0 )</span>
<span class="lineNum">     134 </span>            :     {
<span class="lineNum">     135 </span>            :       /* b = in^2 / (2 * M^2), a = 1 - b in Q0.
<span class="lineNum">     136 </span>            :          We have to compute in Q15 */
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            :       /* x = in / 2150 {in Q15} = x * 15.2409 {in Q15} =
<span class="lineNum">     139 </span>            :          x*15 + (x*983)/(2^12); note that 983/2^12 = 0.23999     */
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            :       /* we are sure that x is in the range of int16_t            */
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :       x = (int16_t)(in * 15 + (in * 983 &gt;&gt; 12));</span>
<span class="lineNum">     143 </span>            :       /* b = x^2 / 2 {in Q15} so a shift of 16 is required to
<span class="lineNum">     144 </span>            :          be in correct domain and one more for the division by 2 */
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :       *B = (int16_t)((x * x + 0x00010000) &gt;&gt; 17);</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :       *A = WEBRTC_SPL_WORD16_MAX - *B;</span>
<span class="lineNum">     147 </span>            :     }
<span class="lineNum">     148 </span>            :     else
<span class="lineNum">     149 </span>            :     {
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :       *B = 0;</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :       *A = WEBRTC_SPL_WORD16_MAX;</span>
<span class="lineNum">     152 </span>            :     }
<span class="lineNum">     153 </span>            :   }
<span class="lineNum">     154 </span>            :   else
<span class="lineNum">     155 </span>            :   {
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :     if( in &lt; 4300 )</span>
<span class="lineNum">     157 </span>            :     {
<span class="lineNum">     158 </span>            :       /* This is a mirror case of the above */
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :       in = 4300 - in;</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :       x = (int16_t)(in * 15 + (in * 983 &gt;&gt; 12));</span>
<span class="lineNum">     161 </span>            :       /* b = x^2 / 2 {in Q15} so a shift of 16 is required to
<span class="lineNum">     162 </span>            :          be in correct domain and one more for the division by 2 */
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :       *A = (int16_t)((x * x + 0x00010000) &gt;&gt; 17);</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :       *B = WEBRTC_SPL_WORD16_MAX - *A;</span>
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            :     }
<span class="lineNum">     167 </span>            :     else
<span class="lineNum">     168 </span>            :     {
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :       *A = 0;</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :       *B = WEBRTC_SPL_WORD16_MAX;</span>
<span class="lineNum">     171 </span>            :     }
<span class="lineNum">     172 </span>            :   }
<span class="lineNum">     173 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span>            : 
<a name="176"><span class="lineNum">     176 </span>            : </a>
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span><span class="lineNoCov">          0 : static void LinearResampler(int16_t* in,</span>
<span class="lineNum">     179 </span>            :                             int16_t* out,
<span class="lineNum">     180 </span>            :                             size_t lenIn,
<span class="lineNum">     181 </span>            :                             size_t lenOut)
<span class="lineNum">     182 </span>            : {
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   size_t n = (lenIn - 1) * RESAMP_RES;</span>
<span class="lineNum">     184 </span>            :   int16_t resOut, relativePos, diff; /* */
<span class="lineNum">     185 </span>            :   size_t i, j;
<span class="lineNum">     186 </span>            :   uint16_t udiff;
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   if( lenIn == lenOut )</span>
<span class="lineNum">     189 </span>            :   {
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     WEBRTC_SPL_MEMCPY_W16( out, in, lenIn );</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     192 </span>            :   }
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :   resOut = WebRtcSpl_DivW32W16ResW16( (int32_t)n, (int16_t)(lenOut-1) );</span>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   out[0] = in[0];</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   for( i = 1, j = 0, relativePos = 0; i &lt; lenOut; i++ )</span>
<span class="lineNum">     198 </span>            :   {
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     relativePos += resOut;</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     while( relativePos &gt; RESAMP_RES )</span>
<span class="lineNum">     202 </span>            :     {
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :       j++;</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :       relativePos -= RESAMP_RES;</span>
<span class="lineNum">     205 </span>            :     }
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span>            :     /* an overflow may happen and the differce in sample values may
<span class="lineNum">     209 </span>            :      * require more than 16 bits. We like to avoid 32 bit arithmatic
<span class="lineNum">     210 </span>            :      * as much as possible */
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     if( (in[ j ] &gt; 0) &amp;&amp; (in[j + 1] &lt; 0) )</span>
<span class="lineNum">     213 </span>            :     {
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :       udiff = (uint16_t)(in[ j ] - in[j + 1]);</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :       out[ i ] = in[ j ] - (uint16_t)( ((int32_t)( udiff * relativePos )) &gt;&gt; RESAMP_RES_BIT);</span>
<span class="lineNum">     216 </span>            :     }
<span class="lineNum">     217 </span>            :     else
<span class="lineNum">     218 </span>            :     {
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :       if( (in[j] &lt; 0) &amp;&amp; (in[j+1] &gt; 0) )</span>
<span class="lineNum">     220 </span>            :       {
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         udiff = (uint16_t)( in[j + 1] - in[ j ] );</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :         out[ i ] = in[ j ] + (uint16_t)( ((int32_t)( udiff * relativePos )) &gt;&gt; RESAMP_RES_BIT);</span>
<span class="lineNum">     223 </span>            :       }
<span class="lineNum">     224 </span>            :       else
<span class="lineNum">     225 </span>            :       {
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :         diff = in[ j + 1 ] - in[ j ];</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :         out[i] = in[j] + (int16_t)(diff * relativePos &gt;&gt; RESAMP_RES_BIT);</span>
<span class="lineNum">     228 </span>            :       }
<span class="lineNum">     229 </span>            :     }
<span class="lineNum">     230 </span>            :   }
<span class="lineNum">     231 </span>            : }
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span>            : 
<a name="235"><span class="lineNum">     235 </span>            : </a>
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span><span class="lineNoCov">          0 : void WebRtcIsacfix_DecodePlcImpl(int16_t *signal_out16,</span>
<span class="lineNum">     238 </span>            :                                  IsacFixDecoderInstance *ISACdec_obj,
<span class="lineNum">     239 </span>            :                                  size_t *current_framesamples )
<span class="lineNum">     240 </span>            : {
<span class="lineNum">     241 </span>            :   int subframecnt;
<span class="lineNum">     242 </span>            : 
<span class="lineNum">     243 </span>            :   int16_t* Vector_Word16_1;
<span class="lineNum">     244 </span>            :   int16_t  Vector_Word16_Extended_1[FRAMESAMPLES_HALF + NOISE_FILTER_LEN];
<span class="lineNum">     245 </span>            :   int16_t* Vector_Word16_2;
<span class="lineNum">     246 </span>            :   int16_t  Vector_Word16_Extended_2[FRAMESAMPLES_HALF + NOISE_FILTER_LEN];
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span>            :   int32_t Vector_Word32_1[FRAMESAMPLES_HALF];
<span class="lineNum">     249 </span>            :   int32_t Vector_Word32_2[FRAMESAMPLES_HALF];
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span>            :   int16_t lofilt_coefQ15[ORDERLO*SUBFRAMES]; //refl. coeffs
<span class="lineNum">     252 </span>            :   int16_t hifilt_coefQ15[ORDERHI*SUBFRAMES]; //refl. coeffs
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span>            :   int16_t pitchLags_Q7[PITCH_SUBFRAMES];
<span class="lineNum">     255 </span>            :   int16_t pitchGains_Q12[PITCH_SUBFRAMES];
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span>            :   int16_t tmp_1, tmp_2;
<span class="lineNum">     258 </span>            :   int32_t tmp32a, tmp32b;
<span class="lineNum">     259 </span>            :   int16_t gainQ13;
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span>            :   int16_t myDecayRate;
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span>            :   /* ---------- PLC variables ------------ */
<span class="lineNum">     264 </span>            :   size_t lag0, i, k;
<span class="lineNum">     265 </span>            :   int16_t noiseIndex;
<span class="lineNum">     266 </span>            :   int16_t stretchPitchLP[PITCH_MAX_LAG + 10], stretchPitchLP1[PITCH_MAX_LAG + 10];
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span>            :   int32_t gain_lo_hiQ17[2*SUBFRAMES];
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span>            :   int16_t nLP, pLP, wNoisyLP, wPriodicLP, tmp16;
<span class="lineNum">     271 </span>            :   size_t minIdx;
<span class="lineNum">     272 </span>            :   int32_t nHP, pHP, wNoisyHP, wPriodicHP, corr, minCorr, maxCoeff;
<span class="lineNum">     273 </span>            :   int16_t noise1, rshift;
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span>            :   int16_t ltpGain, pitchGain, myVoiceIndicator, myAbs, maxAbs;
<span class="lineNum">     277 </span>            :   int32_t varIn, varOut, logVarIn, logVarOut, Q, logMaxAbs;
<span class="lineNum">     278 </span>            :   int rightShiftIn, rightShiftOut;
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            :   /* ------------------------------------- */
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :   myDecayRate = (DECAY_RATE);</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :   Vector_Word16_1 = &amp;Vector_Word16_Extended_1[NOISE_FILTER_LEN];</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :   Vector_Word16_2 = &amp;Vector_Word16_Extended_2[NOISE_FILTER_LEN];</span>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span>            :   /* ----- Simply Copy Previous LPC parameters ------ */
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :   for( subframecnt = 0; subframecnt &lt; SUBFRAMES; subframecnt++ )</span>
<span class="lineNum">     291 </span>            :   {
<span class="lineNum">     292 </span>            :     /* lower Band */
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     WEBRTC_SPL_MEMCPY_W16(&amp;lofilt_coefQ15[ subframecnt * ORDERLO ],</span>
<span class="lineNum">     294 </span>            :                           (ISACdec_obj-&gt;plcstr_obj).lofilt_coefQ15, ORDERLO);
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :     gain_lo_hiQ17[2*subframecnt] = (ISACdec_obj-&gt;plcstr_obj).gain_lo_hiQ17[0];</span>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            :     /* Upper Band */
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     WEBRTC_SPL_MEMCPY_W16(&amp;hifilt_coefQ15[ subframecnt * ORDERHI ],</span>
<span class="lineNum">     299 </span>            :                           (ISACdec_obj-&gt;plcstr_obj).hifilt_coefQ15, ORDERHI);
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :     gain_lo_hiQ17[2*subframecnt + 1] = (ISACdec_obj-&gt;plcstr_obj).gain_lo_hiQ17[1];</span>
<span class="lineNum">     301 </span>            :   }
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span>            : 
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :   lag0 = (size_t)(((ISACdec_obj-&gt;plcstr_obj.lastPitchLag_Q7 + 64) &gt;&gt; 7) + 1);</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :   if( (ISACdec_obj-&gt;plcstr_obj).used != PLC_WAS_USED )</span>
<span class="lineNum">     310 </span>            :   {
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :     (ISACdec_obj-&gt;plcstr_obj).pitchCycles = 0;</span>
<span class="lineNum">     312 </span>            : 
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     (ISACdec_obj-&gt;plcstr_obj).lastPitchLP =</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         &amp;((ISACdec_obj-&gt;plcstr_obj).prevPitchInvIn[FRAMESAMPLES_HALF - lag0]);</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     minCorr = WEBRTC_SPL_WORD32_MAX;</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     if ((FRAMESAMPLES_HALF - 10) &gt; 2 * lag0)</span>
<span class="lineNum">     318 </span>            :     {
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :       minIdx = 11;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :       for( i = 0; i &lt; 21; i++ )</span>
<span class="lineNum">     321 </span>            :       {
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :         corr = 0;</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :         for( k = 0; k &lt; lag0; k++ )</span>
<span class="lineNum">     324 </span>            :         {
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :           corr = WebRtcSpl_AddSatW32(corr, WEBRTC_SPL_ABS_W32(</span>
<span class="lineNum">     326 </span>            :               WebRtcSpl_SubSatW16(
<span class="lineNum">     327 </span>            :                   (ISACdec_obj-&gt;plcstr_obj).lastPitchLP[k],
<span class="lineNum">     328 </span>            :                   (ISACdec_obj-&gt;plcstr_obj).prevPitchInvIn[
<span class="lineNum">     329 </span>            :                       FRAMESAMPLES_HALF - 2*lag0 - 10 + i + k ] ) ) );
<span class="lineNum">     330 </span>            :         }
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :         if( corr &lt; minCorr )</span>
<span class="lineNum">     332 </span>            :         {
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :           minCorr = corr;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :           minIdx = i;</span>
<span class="lineNum">     335 </span>            :         }
<span class="lineNum">     336 </span>            :       }
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       (ISACdec_obj-&gt;plcstr_obj).prevPitchLP =</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :           &amp;( (ISACdec_obj-&gt;plcstr_obj).prevPitchInvIn[</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :               FRAMESAMPLES_HALF - lag0*2 - 10 + minIdx] );</span>
<span class="lineNum">     340 </span>            :     }
<span class="lineNum">     341 </span>            :     else
<span class="lineNum">     342 </span>            :     {
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :       (ISACdec_obj-&gt;plcstr_obj).prevPitchLP =</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).lastPitchLP;</span>
<span class="lineNum">     345 </span>            :     }
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     pitchGain = (ISACdec_obj-&gt;plcstr_obj).lastPitchGain_Q12;</span>
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     WebRtcSpl_AutoCorrelation(</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :         &amp;(ISACdec_obj-&gt;plcstr_obj).prevPitchInvIn[FRAMESAMPLES_HALF - lag0],</span>
<span class="lineNum">     350 </span>            :         lag0, 0, &amp;varIn, &amp;rightShiftIn);
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     WebRtcSpl_AutoCorrelation(</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :         &amp;(ISACdec_obj-&gt;plcstr_obj).prevPitchInvOut[PITCH_MAX_LAG + 10 - lag0],</span>
<span class="lineNum">     353 </span>            :         lag0, 0, &amp;varOut, &amp;rightShiftOut);
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     maxAbs = 0;</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :     for( i = 0; i&lt; lag0; i++)</span>
<span class="lineNum">     357 </span>            :     {
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :       myAbs = WEBRTC_SPL_ABS_W16(</span>
<span class="lineNum">     359 </span>            :           (ISACdec_obj-&gt;plcstr_obj).prevPitchInvOut[
<span class="lineNum">     360 </span>            :               PITCH_MAX_LAG + 10 - lag0 + i] );
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :       maxAbs = (myAbs &gt; maxAbs)? myAbs:maxAbs;</span>
<span class="lineNum">     362 </span>            :     }
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :     logVarIn = log2_Q8_T( (uint32_t)( varIn ) ) +</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :         (int32_t)(rightShiftIn &lt;&lt; 8);</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     logVarOut = log2_Q8_T( (uint32_t)( varOut ) ) +</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         (int32_t)(rightShiftOut &lt;&lt; 8);</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     logMaxAbs = log2_Q8_T( (uint32_t)( maxAbs ) );</span>
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     ltpGain = (int16_t)(logVarOut - logVarIn);</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :     Q = 2 * logMaxAbs - ( logVarOut - 1512 );</span>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span>            :     /*
<span class="lineNum">     373 </span>            :      * ---
<span class="lineNum">     374 </span>            :      * We are computing sqrt( (VarIn/lag0) / var( noise ) )
<span class="lineNum">     375 </span>            :      * var( noise ) is almost 256. we have already computed log2( VarIn ) in Q8
<span class="lineNum">     376 </span>            :      * so we actually compute 2^( 0.5*(log2( VarIn ) - log2( lag0 ) - log2( var(noise ) )  ).
<span class="lineNum">     377 </span>            :      * Note that put log function is in Q8 but the exponential function is in Q10.
<span class="lineNum">     378 </span>            :      * --
<span class="lineNum">     379 </span>            :      */
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :     logVarIn -= log2_Q8_T( (uint32_t)( lag0 ) );</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     tmp16 = (int16_t)((logVarIn&lt;&lt;1) - (4&lt;&lt;10) );</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :     rightShiftIn = 0;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     if( tmp16 &gt; 4096 )</span>
<span class="lineNum">     385 </span>            :     {
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :       tmp16 -= 4096;</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :       tmp16 = exp2_Q10_T( tmp16 );</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :       tmp16 &gt;&gt;= 6;</span>
<span class="lineNum">     389 </span>            :     }
<span class="lineNum">     390 </span>            :     else
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :       tmp16 = exp2_Q10_T( tmp16 )&gt;&gt;10;</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     (ISACdec_obj-&gt;plcstr_obj).std = tmp16 - 4;</span>
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     if( (ltpGain &lt; 110) || (ltpGain &gt; 230) )</span>
<span class="lineNum">     396 </span>            :     {
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :       if( ltpGain &lt; 100 &amp;&amp; (pitchGain &lt; 1800) )</span>
<span class="lineNum">     398 </span>            :       {
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).A = WEBRTC_SPL_WORD16_MAX;</span>
<span class="lineNum">     400 </span>            :       }
<span class="lineNum">     401 </span>            :       else
<span class="lineNum">     402 </span>            :       {
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).A = ((ltpGain &lt; 110) &amp;&amp; (Q &lt; 800)</span>
<span class="lineNum">     404 </span>            :                                        )? WEBRTC_SPL_WORD16_MAX:0;
<span class="lineNum">     405 </span>            :       }
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :       (ISACdec_obj-&gt;plcstr_obj).B = WEBRTC_SPL_WORD16_MAX -</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).A;</span>
<span class="lineNum">     408 </span>            :     }
<span class="lineNum">     409 </span>            :     else
<span class="lineNum">     410 </span>            :     {
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :       if( (pitchGain &lt; 450) || (pitchGain &gt; 1600) )</span>
<span class="lineNum">     412 </span>            :       {
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).A = ((pitchGain &lt; 450)</span>
<span class="lineNum">     414 </span>            :                                        )? WEBRTC_SPL_WORD16_MAX:0;
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).B = WEBRTC_SPL_WORD16_MAX -</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :             (ISACdec_obj-&gt;plcstr_obj).A;</span>
<span class="lineNum">     417 </span>            :       }
<span class="lineNum">     418 </span>            :       else
<span class="lineNum">     419 </span>            :       {
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :         myVoiceIndicator = ltpGain * 2 + pitchGain;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         MemshipValQ15( myVoiceIndicator,</span>
<span class="lineNum">     422 </span>            :                        &amp;(ISACdec_obj-&gt;plcstr_obj).A, &amp;(ISACdec_obj-&gt;plcstr_obj).B );
<span class="lineNum">     423 </span>            :       }
<span class="lineNum">     424 </span>            :     }
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :     myVoiceIndicator = ltpGain * 16 + pitchGain * 2 + (pitchGain &gt;&gt; 8);</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :     MemshipValQ15( myVoiceIndicator,</span>
<span class="lineNum">     430 </span>            :                    &amp;(ISACdec_obj-&gt;plcstr_obj).A, &amp;(ISACdec_obj-&gt;plcstr_obj).B );
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :     (ISACdec_obj-&gt;plcstr_obj).stretchLag = lag0;</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     (ISACdec_obj-&gt;plcstr_obj).pitchIndex = 0;</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span>            :   }
<span class="lineNum">     438 </span>            :   else
<span class="lineNum">     439 </span>            :   {
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     myDecayRate = (DECAY_RATE&lt;&lt;2);</span>
<span class="lineNum">     441 </span>            :   }
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :   if( (ISACdec_obj-&gt;plcstr_obj).B &lt; 1000 )</span>
<span class="lineNum">     444 </span>            :   {
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :     myDecayRate += (DECAY_RATE&lt;&lt;3);</span>
<span class="lineNum">     446 </span>            :   }
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span>            :   /* ------------ reconstructing the residual signal ------------------ */
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   LinearResampler( (ISACdec_obj-&gt;plcstr_obj).lastPitchLP,</span>
<span class="lineNum">     451 </span>            :                    stretchPitchLP, lag0, (ISACdec_obj-&gt;plcstr_obj).stretchLag );
<span class="lineNum">     452 </span>            :   /* inverse pitch filter */
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   pitchLags_Q7[0] = pitchLags_Q7[1] = pitchLags_Q7[2] = pitchLags_Q7[3] =</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :       (int16_t)((ISACdec_obj-&gt;plcstr_obj).stretchLag&lt;&lt;7);</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :   pitchGains_Q12[3] = ( (ISACdec_obj-&gt;plcstr_obj).lastPitchGain_Q12);</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :   pitchGains_Q12[2] = (int16_t)(pitchGains_Q12[3] * 1010 &gt;&gt; 10);</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   pitchGains_Q12[1] = (int16_t)(pitchGains_Q12[2] * 1010 &gt;&gt; 10);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :   pitchGains_Q12[0] = (int16_t)(pitchGains_Q12[1] * 1010 &gt;&gt; 10);</span>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span>            :   /* most of the time either B or A are zero so seperating */
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :   if( (ISACdec_obj-&gt;plcstr_obj).B == 0 )</span>
<span class="lineNum">     464 </span>            :   {
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :     for( i = 0; i &lt; FRAMESAMPLES_HALF; i++ )</span>
<span class="lineNum">     466 </span>            :     {
<span class="lineNum">     467 </span>            :       /* --- Low Pass                                             */
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :       (ISACdec_obj-&gt;plcstr_obj).seed = WEBRTC_SPL_RAND(</span>
<span class="lineNum">     469 </span>            :           (ISACdec_obj-&gt;plcstr_obj).seed );
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :       Vector_Word16_1[i] = (ISACdec_obj-&gt;plcstr_obj.seed &gt;&gt; 10) - 16;</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            :       /* --- Highpass                                              */
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :       (ISACdec_obj-&gt;plcstr_obj).seed = WEBRTC_SPL_RAND(</span>
<span class="lineNum">     474 </span>            :           (ISACdec_obj-&gt;plcstr_obj).seed );
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :       Vector_Word16_2[i] = (ISACdec_obj-&gt;plcstr_obj.seed &gt;&gt; 10) - 16;</span>
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span>            :     }
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     for( i = 1; i &lt; NOISE_FILTER_LEN; i++ )</span>
<span class="lineNum">     479 </span>            :     {
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :       (ISACdec_obj-&gt;plcstr_obj).seed = WEBRTC_SPL_RAND(</span>
<span class="lineNum">     481 </span>            :           (ISACdec_obj-&gt;plcstr_obj).seed );
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :       Vector_Word16_Extended_1[i] = (ISACdec_obj-&gt;plcstr_obj.seed &gt;&gt; 10) - 16;</span>
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :       (ISACdec_obj-&gt;plcstr_obj).seed = WEBRTC_SPL_RAND(</span>
<span class="lineNum">     485 </span>            :           (ISACdec_obj-&gt;plcstr_obj).seed );
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :       Vector_Word16_Extended_2[i] = (ISACdec_obj-&gt;plcstr_obj.seed &gt;&gt; 10) - 16;</span>
<span class="lineNum">     487 </span>            :     }
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     plc_filterma_Fast(Vector_Word16_1, Vector_Word16_Extended_1,</span>
<span class="lineNum">     489 </span>            :                       &amp;(ISACdec_obj-&gt;plcstr_obj).prevPitchInvIn[FRAMESAMPLES_HALF -
<span class="lineNum">     490 </span>            :                                                                 NOISE_FILTER_LEN], (int16_t) NOISE_FILTER_LEN,
<span class="lineNum">     491 </span>            :                       (int16_t) FRAMESAMPLES_HALF, (int16_t)(5),
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :                       (ISACdec_obj-&gt;plcstr_obj).decayCoeffNoise, (int16_t)(6));</span>
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :     maxCoeff = WebRtcSpl_MaxAbsValueW32(</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :         &amp;(ISACdec_obj-&gt;plcstr_obj).prevHP[</span>
<span class="lineNum">     496 </span>            :             PITCH_MAX_LAG + 10 - NOISE_FILTER_LEN], NOISE_FILTER_LEN );
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :     rshift = 0;</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :     while( maxCoeff &gt; WEBRTC_SPL_WORD16_MAX )</span>
<span class="lineNum">     500 </span>            :     {
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :       maxCoeff &gt;&gt;= 1;</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :       rshift++;</span>
<span class="lineNum">     503 </span>            :     }
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :     for( i = 0; i &lt; NOISE_FILTER_LEN; i++ ) {</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :       Vector_Word16_1[FRAMESAMPLES_HALF - NOISE_FILTER_LEN + i] =(int16_t)(</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :           ISACdec_obj-&gt;plcstr_obj.prevHP[PITCH_MAX_LAG + 10 - NOISE_FILTER_LEN +</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                                          i] &gt;&gt; rshift);</span>
<span class="lineNum">     508 </span>            :     }
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :     (ISACdec_obj-&gt;plcstr_obj).decayCoeffNoise = plc_filterma_Fast(</span>
<span class="lineNum">     510 </span>            :         Vector_Word16_2,
<span class="lineNum">     511 </span>            :         Vector_Word16_Extended_2,
<span class="lineNum">     512 </span>            :         &amp;Vector_Word16_1[FRAMESAMPLES_HALF - NOISE_FILTER_LEN],
<span class="lineNum">     513 </span>            :         (int16_t) NOISE_FILTER_LEN,
<span class="lineNum">     514 </span>            :         (int16_t) FRAMESAMPLES_HALF,
<span class="lineNum">     515 </span>            :         (int16_t) (5),
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).decayCoeffNoise,</span>
<span class="lineNum">     517 </span>            :         (int16_t) (7) );
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     for( i = 0; i &lt; FRAMESAMPLES_HALF; i++ )</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :       Vector_Word32_2[i] = Vector_Word16_Extended_2[i] &lt;&lt; rshift;</span>
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     Vector_Word16_1 = Vector_Word16_Extended_1;</span>
<span class="lineNum">     523 </span>            :   }
<span class="lineNum">     524 </span>            :   else
<span class="lineNum">     525 </span>            :   {
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :     if( (ISACdec_obj-&gt;plcstr_obj).A == 0 )</span>
<span class="lineNum">     527 </span>            :     {
<span class="lineNum">     528 </span>            :       /* ------ Periodic Vector ---                                */
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :       for( i = 0, noiseIndex = 0; i &lt; FRAMESAMPLES_HALF; i++, noiseIndex++ )</span>
<span class="lineNum">     530 </span>            :       {
<span class="lineNum">     531 </span>            :         /* --- Lowpass                                               */
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :         pLP = (int16_t)(stretchPitchLP[ISACdec_obj-&gt;plcstr_obj.pitchIndex] *</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :             ISACdec_obj-&gt;plcstr_obj.decayCoeffPriodic &gt;&gt; 15);</span>
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span>            :         /* --- Highpass                                              */
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :         pHP = (int32_t)WEBRTC_SPL_MUL_16_32_RSFT15(</span>
<span class="lineNum">     537 </span>            :             (ISACdec_obj-&gt;plcstr_obj).decayCoeffPriodic,
<span class="lineNum">     538 </span>            :             (ISACdec_obj-&gt;plcstr_obj).prevHP[PITCH_MAX_LAG + 10 -
<span class="lineNum">     539 </span>            :                                              (ISACdec_obj-&gt;plcstr_obj).stretchLag +
<span class="lineNum">     540 </span>            :                                              (ISACdec_obj-&gt;plcstr_obj).pitchIndex] );
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span>            :         /* --- lower the muliplier (more decay at next sample) --- */
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).decayCoeffPriodic -= (myDecayRate);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         if( (ISACdec_obj-&gt;plcstr_obj).decayCoeffPriodic &lt; 0 )</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).decayCoeffPriodic = 0;</span>
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).pitchIndex++;</span>
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :         if( (ISACdec_obj-&gt;plcstr_obj).pitchIndex ==</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :             (ISACdec_obj-&gt;plcstr_obj).stretchLag )</span>
<span class="lineNum">     551 </span>            :         {
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).pitchIndex = 0;</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).pitchCycles++;</span>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :           if( (ISACdec_obj-&gt;plcstr_obj).stretchLag != (lag0 + 1) )</span>
<span class="lineNum">     556 </span>            :           {
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :             (ISACdec_obj-&gt;plcstr_obj).stretchLag = lag0 + 1;</span>
<span class="lineNum">     558 </span>            :           }
<span class="lineNum">     559 </span>            :           else
<span class="lineNum">     560 </span>            :           {
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :             (ISACdec_obj-&gt;plcstr_obj).stretchLag = lag0;</span>
<span class="lineNum">     562 </span>            :           }
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).stretchLag = (</span>
<span class="lineNum">     565 </span>            :               (ISACdec_obj-&gt;plcstr_obj).stretchLag &gt; PITCH_MAX_LAG
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                                                   )? (PITCH_MAX_LAG):(ISACdec_obj-&gt;plcstr_obj).stretchLag;</span>
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :           LinearResampler( (ISACdec_obj-&gt;plcstr_obj).lastPitchLP,</span>
<span class="lineNum">     569 </span>            :                            stretchPitchLP, lag0, (ISACdec_obj-&gt;plcstr_obj).stretchLag );
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :           LinearResampler( (ISACdec_obj-&gt;plcstr_obj).prevPitchLP,</span>
<span class="lineNum">     572 </span>            :                            stretchPitchLP1, lag0, (ISACdec_obj-&gt;plcstr_obj).stretchLag );
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :           switch( (ISACdec_obj-&gt;plcstr_obj).pitchCycles )</span>
<span class="lineNum">     575 </span>            :           {
<span class="lineNum">     576 </span>            :             case 1:
<span class="lineNum">     577 </span>            :               {
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :                 for( k=0; k&lt;(ISACdec_obj-&gt;plcstr_obj).stretchLag; k++ )</span>
<span class="lineNum">     579 </span>            :                 {
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :                   stretchPitchLP[k] = (int16_t)((</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :                       (int32_t)stretchPitchLP[k]* 3 +</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :                       (int32_t)stretchPitchLP1[k])&gt;&gt;2);</span>
<span class="lineNum">     583 </span>            :                 }
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     585 </span>            :               }
<span class="lineNum">     586 </span>            :             case 2:
<span class="lineNum">     587 </span>            :               {
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :                 for( k=0; k&lt;(ISACdec_obj-&gt;plcstr_obj).stretchLag; k++ )</span>
<span class="lineNum">     589 </span>            :                 {
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :                   stretchPitchLP[k] = (int16_t)((</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                       (int32_t)stretchPitchLP[k] +</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :                       (int32_t)stretchPitchLP1[k] )&gt;&gt;1);</span>
<span class="lineNum">     593 </span>            :                 }
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     595 </span>            :               }
<span class="lineNum">     596 </span>            :             case 3:
<span class="lineNum">     597 </span>            :               {
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                 for( k=0; k&lt;(ISACdec_obj-&gt;plcstr_obj).stretchLag; k++ )</span>
<span class="lineNum">     599 </span>            :                 {
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                   stretchPitchLP[k] = (int16_t)((stretchPitchLP[k] +</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :                                                        (int32_t)stretchPitchLP1[k]*3 )&gt;&gt;2);</span>
<span class="lineNum">     602 </span>            :                 }
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     604 </span>            :               }
<span class="lineNum">     605 </span>            :           }
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :           if( (ISACdec_obj-&gt;plcstr_obj).pitchCycles == 3 )</span>
<span class="lineNum">     608 </span>            :           {
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :             myDecayRate += 35; //(myDecayRate&gt;&gt;1);</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :             (ISACdec_obj-&gt;plcstr_obj).pitchCycles = 0;</span>
<span class="lineNum">     611 </span>            :           }
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span>            :         }
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span>            :         /* ------ Sum the noisy and periodic signals  ------ */
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :         Vector_Word16_1[i] = pLP;</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :         Vector_Word32_2[i] = pHP;</span>
<span class="lineNum">     618 </span>            :       }
<span class="lineNum">     619 </span>            :     }
<span class="lineNum">     620 </span>            :     else
<span class="lineNum">     621 </span>            :     {
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :       for( i = 0, noiseIndex = 0; i &lt; FRAMESAMPLES_HALF; i++, noiseIndex++ )</span>
<span class="lineNum">     623 </span>            :       {
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).seed = WEBRTC_SPL_RAND(</span>
<span class="lineNum">     626 </span>            :             (ISACdec_obj-&gt;plcstr_obj).seed );
<span class="lineNum">     627 </span>            : 
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :         noise1 = (ISACdec_obj-&gt;plcstr_obj.seed &gt;&gt; 10) - 16;</span>
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :         nLP = (int16_t)((int16_t)(noise1 * ISACdec_obj-&gt;plcstr_obj.std) *</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :             ISACdec_obj-&gt;plcstr_obj.decayCoeffNoise &gt;&gt; 15);</span>
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span>            :         /* --- Highpass                                              */
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).seed = WEBRTC_SPL_RAND(</span>
<span class="lineNum">     635 </span>            :             (ISACdec_obj-&gt;plcstr_obj).seed );
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :         noise1 = (ISACdec_obj-&gt;plcstr_obj.seed &gt;&gt; 11) - 8;</span>
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :         nHP = (int32_t)WEBRTC_SPL_MUL_16_32_RSFT15(</span>
<span class="lineNum">     639 </span>            :             (ISACdec_obj-&gt;plcstr_obj).decayCoeffNoise,
<span class="lineNum">     640 </span>            :             (int32_t)(noise1*(ISACdec_obj-&gt;plcstr_obj).std) );
<span class="lineNum">     641 </span>            : 
<span class="lineNum">     642 </span>            :         /* --- lower the muliplier (more decay at next sample) --- */
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).decayCoeffNoise -= (myDecayRate);</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :         if( (ISACdec_obj-&gt;plcstr_obj).decayCoeffNoise &lt; 0 )</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).decayCoeffNoise = 0;</span>
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span>            :         /* ------ Periodic Vector ---                                */
<span class="lineNum">     648 </span>            :         /* --- Lowpass                                               */
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :         pLP = (int16_t)(stretchPitchLP[ISACdec_obj-&gt;plcstr_obj.pitchIndex] *</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :             ISACdec_obj-&gt;plcstr_obj.decayCoeffPriodic &gt;&gt; 15);</span>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span>            :         /* --- Highpass                                              */
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :         pHP = (int32_t)WEBRTC_SPL_MUL_16_32_RSFT15(</span>
<span class="lineNum">     654 </span>            :             (ISACdec_obj-&gt;plcstr_obj).decayCoeffPriodic,
<span class="lineNum">     655 </span>            :             (ISACdec_obj-&gt;plcstr_obj).prevHP[PITCH_MAX_LAG + 10 -
<span class="lineNum">     656 </span>            :                                              (ISACdec_obj-&gt;plcstr_obj).stretchLag +
<span class="lineNum">     657 </span>            :                                              (ISACdec_obj-&gt;plcstr_obj).pitchIndex] );
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span>            :         /* --- lower the muliplier (more decay at next sample) --- */
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).decayCoeffPriodic -= (myDecayRate);</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :         if( (ISACdec_obj-&gt;plcstr_obj).decayCoeffPriodic &lt; 0 )</span>
<span class="lineNum">     662 </span>            :         {
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).decayCoeffPriodic = 0;</span>
<span class="lineNum">     664 </span>            :         }
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span>            :         /* ------ Weighting the noisy and periodic vectors -------   */
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :         wNoisyLP = (int16_t)(ISACdec_obj-&gt;plcstr_obj.A * nLP &gt;&gt; 15);</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :         wNoisyHP = (int32_t)(WEBRTC_SPL_MUL_16_32_RSFT15(</span>
<span class="lineNum">     669 </span>            :             (ISACdec_obj-&gt;plcstr_obj).A, (nHP) ) );
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :         wPriodicLP = (int16_t)(ISACdec_obj-&gt;plcstr_obj.B * pLP &gt;&gt; 15);</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :         wPriodicHP = (int32_t)(WEBRTC_SPL_MUL_16_32_RSFT15(</span>
<span class="lineNum">     673 </span>            :             (ISACdec_obj-&gt;plcstr_obj).B, pHP));
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :         (ISACdec_obj-&gt;plcstr_obj).pitchIndex++;</span>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :         if((ISACdec_obj-&gt;plcstr_obj).pitchIndex ==</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :            (ISACdec_obj-&gt;plcstr_obj).stretchLag)</span>
<span class="lineNum">     679 </span>            :         {
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).pitchIndex = 0;</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).pitchCycles++;</span>
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :           if( (ISACdec_obj-&gt;plcstr_obj).stretchLag != (lag0 + 1) )</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :             (ISACdec_obj-&gt;plcstr_obj).stretchLag = lag0 + 1;</span>
<span class="lineNum">     685 </span>            :           else
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :             (ISACdec_obj-&gt;plcstr_obj).stretchLag = lag0;</span>
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :           (ISACdec_obj-&gt;plcstr_obj).stretchLag = (</span>
<span class="lineNum">     689 </span>            :               (ISACdec_obj-&gt;plcstr_obj).stretchLag &gt; PITCH_MAX_LAG
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                                                   )? (PITCH_MAX_LAG):(ISACdec_obj-&gt;plcstr_obj).stretchLag;</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :           LinearResampler(</span>
<span class="lineNum">     692 </span>            :               (ISACdec_obj-&gt;plcstr_obj).lastPitchLP,
<span class="lineNum">     693 </span>            :               stretchPitchLP, lag0, (ISACdec_obj-&gt;plcstr_obj).stretchLag );
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :           LinearResampler((ISACdec_obj-&gt;plcstr_obj).prevPitchLP,</span>
<span class="lineNum">     696 </span>            :                           stretchPitchLP1, lag0, (ISACdec_obj-&gt;plcstr_obj).stretchLag );
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :           switch((ISACdec_obj-&gt;plcstr_obj).pitchCycles)</span>
<span class="lineNum">     699 </span>            :           {
<span class="lineNum">     700 </span>            :             case 1:
<span class="lineNum">     701 </span>            :               {
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :                 for( k=0; k&lt;(ISACdec_obj-&gt;plcstr_obj).stretchLag; k++ )</span>
<span class="lineNum">     703 </span>            :                 {
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :                   stretchPitchLP[k] = (int16_t)((</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :                       (int32_t)stretchPitchLP[k]* 3 +</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :                       (int32_t)stretchPitchLP1[k] )&gt;&gt;2);</span>
<span class="lineNum">     707 </span>            :                 }
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     709 </span>            :               }
<span class="lineNum">     710 </span>            :             case 2:
<span class="lineNum">     711 </span>            :               {
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :                 for( k=0; k&lt;(ISACdec_obj-&gt;plcstr_obj).stretchLag; k++ )</span>
<span class="lineNum">     713 </span>            :                 {
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :                   stretchPitchLP[k] = (int16_t)((</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :                       (int32_t)stretchPitchLP[k] +</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :                       (int32_t)stretchPitchLP1[k])&gt;&gt;1);</span>
<span class="lineNum">     717 </span>            :                 }
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     719 </span>            :               }
<span class="lineNum">     720 </span>            :             case 3:
<span class="lineNum">     721 </span>            :               {
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :                 for( k=0; k&lt;(ISACdec_obj-&gt;plcstr_obj).stretchLag; k++ )</span>
<span class="lineNum">     723 </span>            :                 {
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :                   stretchPitchLP[k] = (int16_t)(</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :                       (stretchPitchLP[k] +</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :                        (int32_t)stretchPitchLP1[k]*3 )&gt;&gt;2);</span>
<span class="lineNum">     727 </span>            :                 }
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     729 </span>            :               }
<span class="lineNum">     730 </span>            :           }
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :           if( (ISACdec_obj-&gt;plcstr_obj).pitchCycles == 3 )</span>
<span class="lineNum">     733 </span>            :           {
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :             myDecayRate += 55; //(myDecayRate&gt;&gt;1);</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :             (ISACdec_obj-&gt;plcstr_obj).pitchCycles = 0;</span>
<span class="lineNum">     736 </span>            :           }
<span class="lineNum">     737 </span>            :         }
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span>            :         /* ------ Sum the noisy and periodic signals  ------ */
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :         Vector_Word16_1[i] = WebRtcSpl_AddSatW16(wNoisyLP, wPriodicLP);</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :         Vector_Word32_2[i] = WebRtcSpl_AddSatW32(wNoisyHP, wPriodicHP);</span>
<span class="lineNum">     742 </span>            :       }
<span class="lineNum">     743 </span>            :     }
<span class="lineNum">     744 </span>            :   }
<span class="lineNum">     745 </span>            :   /* ----------------- residual signal is reconstructed ------------------ */
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :   k = (ISACdec_obj-&gt;plcstr_obj).pitchIndex;</span>
<span class="lineNum">     748 </span>            :   /* --- Write one pitch cycle for recovery block --- */
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :   for( i = 0; i &lt; RECOVERY_OVERLAP; i++ )</span>
<span class="lineNum">     751 </span>            :   {
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :     ISACdec_obj-&gt;plcstr_obj.overlapLP[i] = (int16_t)(</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :         stretchPitchLP[k] * ISACdec_obj-&gt;plcstr_obj.decayCoeffPriodic &gt;&gt; 15);</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :     k = ( k &lt; ((ISACdec_obj-&gt;plcstr_obj).stretchLag - 1) )? (k+1):0;</span>
<span class="lineNum">     755 </span>            :   }
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :   (ISACdec_obj-&gt;plcstr_obj).lastPitchLag_Q7 =</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :       (int16_t)((ISACdec_obj-&gt;plcstr_obj).stretchLag &lt;&lt; 7);</span>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span>            : 
<span class="lineNum">     761 </span>            :   /* --- Inverse Pitch Filter --- */
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :   WebRtcIsacfix_PitchFilter(Vector_Word16_1, Vector_Word16_2,</span>
<span class="lineNum">     763 </span>            :                             &amp;ISACdec_obj-&gt;pitchfiltstr_obj, pitchLags_Q7, pitchGains_Q12, 4);
<span class="lineNum">     764 </span>            : 
<span class="lineNum">     765 </span>            :   /* reduce gain to compensate for pitch enhancer */
<span class="lineNum">     766 </span>            :   /* gain = 1.0f - 0.45f * AvgPitchGain; */
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :   tmp32a = ISACdec_obj-&gt;plcstr_obj.AvgPitchGain_Q12 * 29;  // Q18</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :   tmp32b = 262144 - tmp32a;  // Q18</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :   gainQ13 = (int16_t) (tmp32b &gt;&gt; 5); // Q13</span>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span>            :   /* perceptual post-filtering (using normalized lattice filter) */
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :   for (k = 0; k &lt; FRAMESAMPLES_HALF; k++)</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :     Vector_Word32_1[k] = (Vector_Word16_2[k] * gainQ13) &lt;&lt; 3;  // Q25</span>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span>            : 
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :   WebRtcIsacfix_NormLatticeFilterAr(ORDERLO,</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                                     (ISACdec_obj-&gt;maskfiltstr_obj).PostStateLoGQ0,</span>
<span class="lineNum">     778 </span>            :                                     Vector_Word32_1, lofilt_coefQ15, gain_lo_hiQ17, 0, Vector_Word16_1);
<span class="lineNum">     779 </span>            : 
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :   WebRtcIsacfix_NormLatticeFilterAr(ORDERHI,</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :                                     (ISACdec_obj-&gt;maskfiltstr_obj).PostStateHiGQ0,</span>
<span class="lineNum">     782 </span>            :                                     Vector_Word32_2, hifilt_coefQ15, gain_lo_hiQ17, 1, Vector_Word16_2);
<span class="lineNum">     783 </span>            : 
<span class="lineNum">     784 </span>            :   /* recombine the 2 bands */
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span>            :   /* Form the polyphase signals, and compensate for DC offset */
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :   for (k=0;k&lt;FRAMESAMPLES_HALF;k++)</span>
<span class="lineNum">     788 </span>            :   {
<span class="lineNum">     789 </span>            :     /* Construct a new upper channel signal*/
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :     tmp_1 = (int16_t)WebRtcSpl_SatW32ToW16(</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :                                            ((int32_t)Vector_Word16_1[k]+Vector_Word16_2[k] + 1));</span>
<span class="lineNum">     792 </span>            :     /* Construct a new lower channel signal*/
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :     tmp_2 = (int16_t)WebRtcSpl_SatW32ToW16(</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :                                            ((int32_t)Vector_Word16_1[k]-Vector_Word16_2[k]));</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :     Vector_Word16_1[k] = tmp_1;</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :     Vector_Word16_2[k] = tmp_2;</span>
<span class="lineNum">     797 </span>            :   }
<span class="lineNum">     798 </span>            : 
<span class="lineNum">     799 </span>            : 
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :   WebRtcIsacfix_FilterAndCombine1(Vector_Word16_1,</span>
<span class="lineNum">     801 </span>            :                                   Vector_Word16_2, signal_out16, &amp;ISACdec_obj-&gt;postfiltbankstr_obj);
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :   (ISACdec_obj-&gt;plcstr_obj).used = PLC_WAS_USED;</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :   *current_framesamples = 480;</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

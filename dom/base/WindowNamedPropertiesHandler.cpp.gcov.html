<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - dom/base/WindowNamedPropertiesHandler.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">dom/base</a> - WindowNamedPropertiesHandler.cpp<span style="font-size: 80%;"> (source / <a href="WindowNamedPropertiesHandler.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">51</td>
            <td class="headerCovTableEntry">132</td>
            <td class="headerCovTableEntryLo">38.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">5</td>
            <td class="headerCovTableEntry">10</td>
            <td class="headerCovTableEntryLo">50.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=8 sts=2 et sw=2 tw=80: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &quot;WindowNamedPropertiesHandler.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;mozilla/dom/EventTargetBinding.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;mozilla/dom/WindowBinding.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;mozilla/Preferences.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;nsDOMClassInfo.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsDOMWindowList.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsGlobalWindow.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsHTMLDocument.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsJSUtils.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;xpcprivate.h&quot;
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : namespace mozilla {
<span class="lineNum">      20 </span>            : namespace dom {
<a name="21"><span class="lineNum">      21 </span>            : </a>
<span class="lineNum">      22 </span>            : static bool
<span class="lineNum">      23 </span><span class="lineNoCov">          0 : ShouldExposeChildWindow(nsString&amp; aNameBeingResolved, nsPIDOMWindowOuter* aChild)</span>
<span class="lineNum">      24 </span>            : {
<span class="lineNum">      25 </span><span class="lineNoCov">          0 :   Element* e = aChild-&gt;GetFrameElementInternal();</span>
<span class="lineNum">      26 </span><span class="lineNoCov">          0 :   if (e &amp;&amp; e-&gt;IsInShadowTree()) {</span>
<span class="lineNum">      27 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">      28 </span>            :   }
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            :   // If we're same-origin with the child, go ahead and expose it.
<span class="lineNum">      31 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIScriptObjectPrincipal&gt; sop = do_QueryInterface(aChild);</span>
<span class="lineNum">      32 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(sop, false);</span>
<span class="lineNum">      33 </span><span class="lineNoCov">          0 :   if (nsContentUtils::SubjectPrincipal()-&gt;Equals(sop-&gt;GetPrincipal())) {</span>
<span class="lineNum">      34 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">      35 </span>            :   }
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            :   // If we're not same-origin, expose it _only_ if the name of the browsing
<span class="lineNum">      38 </span>            :   // context matches the 'name' attribute of the frame element in the parent.
<span class="lineNum">      39 </span>            :   // The motivations behind this heuristic are worth explaining here.
<span class="lineNum">      40 </span>            :   //
<span class="lineNum">      41 </span>            :   // Historically, all UAs supported global named access to any child browsing
<span class="lineNum">      42 </span>            :   // context (that is to say, window.dolske returns a child frame where either
<span class="lineNum">      43 </span>            :   // the &quot;name&quot; attribute on the frame element was set to &quot;dolske&quot;, or where
<span class="lineNum">      44 </span>            :   // the child explicitly set window.name = &quot;dolske&quot;).
<span class="lineNum">      45 </span>            :   //
<span class="lineNum">      46 </span>            :   // This is problematic because it allows possibly-malicious and unrelated
<span class="lineNum">      47 </span>            :   // cross-origin subframes to pollute the global namespace of their parent in
<span class="lineNum">      48 </span>            :   // unpredictable ways (see bug 860494). This is also problematic for browser
<span class="lineNum">      49 </span>            :   // engines like Servo that want to run cross-origin script on different
<span class="lineNum">      50 </span>            :   // threads.
<span class="lineNum">      51 </span>            :   //
<span class="lineNum">      52 </span>            :   // The naive solution here would be to filter out any cross-origin subframes
<span class="lineNum">      53 </span>            :   // obtained when doing named lookup in global scope. But that is unlikely to
<span class="lineNum">      54 </span>            :   // be web-compatible, since it will break named access for consumers that do
<span class="lineNum">      55 </span>            :   // &lt;iframe name=&quot;dolske&quot; src=&quot;http://cross-origin.com/sadtrombone.html&quot;&gt; and
<span class="lineNum">      56 </span>            :   // expect to be able to access the cross-origin subframe via named lookup on
<span class="lineNum">      57 </span>            :   // the global.
<span class="lineNum">      58 </span>            :   //
<span class="lineNum">      59 </span>            :   // The optimal behavior would be to do the following:
<span class="lineNum">      60 </span>            :   // (a) Look for any child browsing context with name=&quot;dolske&quot;.
<span class="lineNum">      61 </span>            :   // (b) If the result is cross-origin, null it out.
<span class="lineNum">      62 </span>            :   // (c) If we have null, look for a frame element whose 'name' attribute is
<span class="lineNum">      63 </span>            :   //     &quot;dolske&quot;.
<span class="lineNum">      64 </span>            :   //
<span class="lineNum">      65 </span>            :   // Unfortunately, (c) would require some engineering effort to be performant
<span class="lineNum">      66 </span>            :   // in Gecko, and probably in other UAs as well. So we go with a simpler
<span class="lineNum">      67 </span>            :   // approximation of the above. This approximation will only break sites that
<span class="lineNum">      68 </span>            :   // rely on their cross-origin subframes setting window.name to a known value,
<span class="lineNum">      69 </span>            :   // which is unlikely to be very common. And while it does introduce a
<span class="lineNum">      70 </span>            :   // dependency on cross-origin state when doing global lookups, it doesn't
<span class="lineNum">      71 </span>            :   // allow the child to arbitrarily pollute the parent namespace, and requires
<span class="lineNum">      72 </span>            :   // cross-origin communication only in a limited set of cases that can be
<span class="lineNum">      73 </span>            :   // computed independently by the parent.
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   return e &amp;&amp; e-&gt;AttrValueIs(kNameSpaceID_None, nsGkAtoms::name,</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :                              aNameBeingResolved, eCaseMatters);</span>
<span class="lineNum">      76 </span>            : }
<a name="77"><span class="lineNum">      77 </span>            : </a>
<span class="lineNum">      78 </span>            : bool
<span class="lineNum">      79 </span><span class="lineCov">        423 : WindowNamedPropertiesHandler::getOwnPropDescriptor(JSContext* aCx,</span>
<span class="lineNum">      80 </span>            :                                                    JS::Handle&lt;JSObject*&gt; aProxy,
<span class="lineNum">      81 </span>            :                                                    JS::Handle&lt;jsid&gt; aId,
<span class="lineNum">      82 </span>            :                                                    bool /* unused */,
<span class="lineNum">      83 </span>            :                                                    JS::MutableHandle&lt;JS::PropertyDescriptor&gt; aDesc)
<span class="lineNum">      84 </span>            :                                                    const
<span class="lineNum">      85 </span>            : {
<span class="lineNum">      86 </span><span class="lineCov">        423 :   if (!JSID_IS_STRING(aId)) {</span>
<span class="lineNum">      87 </span>            :     // Nothing to do if we're resolving a non-string property.
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">      89 </span>            :   }
<span class="lineNum">      90 </span>            : 
<span class="lineNum">      91 </span>            :   bool hasOnPrototype;
<span class="lineNum">      92 </span><span class="lineCov">        423 :   if (!HasPropertyOnPrototype(aCx, aProxy, aId, &amp;hasOnPrototype)) {</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">      94 </span>            :   }
<span class="lineNum">      95 </span><span class="lineCov">        423 :   if (hasOnPrototype) {</span>
<span class="lineNum">      96 </span><span class="lineCov">         47 :     return true;</span>
<span class="lineNum">      97 </span>            :   }
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineCov">        752 :   nsAutoJSString str;</span>
<span class="lineNum">     100 </span><span class="lineCov">        376 :   if (!str.init(aCx, JSID_TO_STRING(aId))) {</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     102 </span>            :   }
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span><span class="lineCov">        376 :   if(str.IsEmpty()) {</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     106 </span>            :   }
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span>            :   // Grab the DOM window.
<span class="lineNum">     109 </span><span class="lineCov">        752 :   JS::Rooted&lt;JSObject*&gt; global(aCx, JS_GetGlobalForObject(aCx, aProxy));</span>
<span class="lineNum">     110 </span><span class="lineCov">        376 :   nsGlobalWindow* win = xpc::WindowOrNull(global);</span>
<span class="lineNum">     111 </span><span class="lineCov">        376 :   if (win-&gt;Length() &gt; 0) {</span>
<span class="lineNum">     112 </span><span class="lineCov">        160 :     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; childWin = win-&gt;GetChildWindow(str);</span>
<span class="lineNum">     113 </span><span class="lineCov">         80 :     if (childWin &amp;&amp; ShouldExposeChildWindow(str, childWin)) {</span>
<span class="lineNum">     114 </span>            :       // We found a subframe of the right name. Shadowing via |var foo| in
<span class="lineNum">     115 </span>            :       // global scope is still allowed, since |var| only looks up |own|
<span class="lineNum">     116 </span>            :       // properties. But unqualified shadowing will fail, per-spec.
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :       JS::Rooted&lt;JS::Value&gt; v(aCx);</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :       if (!WrapObject(aCx, childWin, &amp;v)) {</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :         return false;</span>
<span class="lineNum">     120 </span>            :       }
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :       FillPropertyDescriptor(aDesc, aProxy, 0, v);</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">     123 </span>            :     }
<span class="lineNum">     124 </span>            :   }
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span>            :   // The rest of this function is for HTML documents only.
<span class="lineNum">     127 </span><span class="lineCov">        752 :   nsCOMPtr&lt;nsIHTMLDocument&gt; htmlDoc = do_QueryInterface(win-&gt;GetExtantDoc());</span>
<span class="lineNum">     128 </span><span class="lineCov">        376 :   if (!htmlDoc) {</span>
<span class="lineNum">     129 </span><span class="lineCov">        357 :     return true;</span>
<span class="lineNum">     130 </span>            :   }
<span class="lineNum">     131 </span><span class="lineCov">         19 :   nsHTMLDocument* document = static_cast&lt;nsHTMLDocument*&gt;(htmlDoc.get());</span>
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span><span class="lineCov">         19 :   Element* element = document-&gt;GetElementById(str);</span>
<span class="lineNum">     134 </span><span class="lineCov">         19 :   if (element) {</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :     JS::Rooted&lt;JS::Value&gt; v(aCx);</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :     if (!WrapObject(aCx, element, &amp;v)) {</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">     138 </span>            :     }
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     FillPropertyDescriptor(aDesc, aProxy, 0, v);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     141 </span>            :   }
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span>            :   nsWrapperCache* cache;
<span class="lineNum">     144 </span><span class="lineCov">         19 :   nsISupports* result = document-&gt;ResolveName(str, &amp;cache);</span>
<span class="lineNum">     145 </span><span class="lineCov">         19 :   if (!result) {</span>
<span class="lineNum">     146 </span><span class="lineCov">         19 :     return true;</span>
<span class="lineNum">     147 </span>            :   }
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :   JS::Rooted&lt;JS::Value&gt; v(aCx);</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   if (!WrapObject(aCx, result, cache, nullptr, &amp;v)) {</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     152 </span>            :   }
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   FillPropertyDescriptor(aDesc, aProxy, 0, v);</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   return true;</span>
<span class="lineNum">     155 </span>            : }
<a name="156"><span class="lineNum">     156 </span>            : </a>
<span class="lineNum">     157 </span>            : bool
<span class="lineNum">     158 </span><span class="lineNoCov">          0 : WindowNamedPropertiesHandler::defineProperty(JSContext* aCx,</span>
<span class="lineNum">     159 </span>            :                                              JS::Handle&lt;JSObject*&gt; aProxy,
<span class="lineNum">     160 </span>            :                                              JS::Handle&lt;jsid&gt; aId,
<span class="lineNum">     161 </span>            :                                              JS::Handle&lt;JS::PropertyDescriptor&gt; aDesc,
<span class="lineNum">     162 </span>            :                                              JS::ObjectOpResult &amp;result) const
<span class="lineNum">     163 </span>            : {
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :   ErrorResult rv;</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   rv.ThrowTypeError&lt;MSG_DEFINEPROPERTY_ON_GSP&gt;();</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :   MOZ_ALWAYS_TRUE(rv.MaybeSetPendingException(aCx));</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">     168 </span>            : }
<a name="169"><span class="lineNum">     169 </span>            : </a>
<span class="lineNum">     170 </span>            : bool
<span class="lineNum">     171 </span><span class="lineNoCov">          0 : WindowNamedPropertiesHandler::ownPropNames(JSContext* aCx,</span>
<span class="lineNum">     172 </span>            :                                            JS::Handle&lt;JSObject*&gt; aProxy,
<span class="lineNum">     173 </span>            :                                            unsigned flags,
<span class="lineNum">     174 </span>            :                                            JS::AutoIdVector&amp; aProps) const
<span class="lineNum">     175 </span>            : {
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :   if (!(flags &amp; JSITER_HIDDEN)) {</span>
<span class="lineNum">     177 </span>            :     // None of our named properties are enumerable.
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     179 </span>            :   }
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span>            :   // Grab the DOM window.
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   nsGlobalWindow* win = xpc::WindowOrNull(JS_GetGlobalForObject(aCx, aProxy));</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   nsTArray&lt;nsString&gt; names;</span>
<span class="lineNum">     184 </span>            :   // The names live on the outer window, which might be null
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   nsGlobalWindow* outer = win-&gt;GetOuterWindowInternal();</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   if (outer) {</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :     nsDOMWindowList* childWindows = outer-&gt;GetWindowList();</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :     if (childWindows) {</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :       uint32_t length = childWindows-&gt;GetLength();</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :       for (uint32_t i = 0; i &lt; length; ++i) {</span>
<span class="lineNum">     191 </span>            :         nsCOMPtr&lt;nsIDocShellTreeItem&gt; item =
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :           childWindows-&gt;GetDocShellTreeItemAt(i);</span>
<span class="lineNum">     193 </span>            :         // This is a bit silly, since we could presumably just do
<span class="lineNum">     194 </span>            :         // item-&gt;GetWindow().  But it's not obvious whether this does the same
<span class="lineNum">     195 </span>            :         // thing as GetChildWindow() with the item's name (due to the complexity
<span class="lineNum">     196 </span>            :         // of FindChildWithName).  Since GetChildWindow is what we use in
<span class="lineNum">     197 </span>            :         // getOwnPropDescriptor, let's try to be consistent.
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :         nsString name;</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :         item-&gt;GetName(name);</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :         if (!names.Contains(name)) {</span>
<span class="lineNum">     201 </span>            :           // Make sure we really would expose it from getOwnPropDescriptor.
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :           nsCOMPtr&lt;nsPIDOMWindowOuter&gt; childWin = win-&gt;GetChildWindow(name);</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :           if (childWin &amp;&amp; ShouldExposeChildWindow(name, childWin)) {</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :             names.AppendElement(name);</span>
<span class="lineNum">     205 </span>            :           }
<span class="lineNum">     206 </span>            :         }
<span class="lineNum">     207 </span>            :       }
<span class="lineNum">     208 </span>            :     }
<span class="lineNum">     209 </span>            :   }
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :   if (!AppendNamedPropertyIds(aCx, aProxy, names, false, aProps)) {</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     212 </span>            :   }
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :   names.Clear();</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIHTMLDocument&gt; htmlDoc = do_QueryInterface(win-&gt;GetExtantDoc());</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :   if (!htmlDoc) {</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     218 </span>            :   }
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   nsHTMLDocument* document = static_cast&lt;nsHTMLDocument*&gt;(htmlDoc.get());</span>
<span class="lineNum">     220 </span>            :   // Document names are enumerable, so we want to get them no matter what flags
<span class="lineNum">     221 </span>            :   // is.
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :   document-&gt;GetSupportedNames(names);</span>
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :   JS::AutoIdVector docProps(aCx);</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :   if (!AppendNamedPropertyIds(aCx, aProxy, names, false, docProps)) {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     227 </span>            :   }
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   return js::AppendUnique(aCx, aProps, docProps);</span>
<span class="lineNum">     230 </span>            : }
<a name="231"><span class="lineNum">     231 </span>            : </a>
<span class="lineNum">     232 </span>            : bool
<span class="lineNum">     233 </span><span class="lineNoCov">          0 : WindowNamedPropertiesHandler::delete_(JSContext* aCx,</span>
<span class="lineNum">     234 </span>            :                                       JS::Handle&lt;JSObject*&gt; aProxy,
<span class="lineNum">     235 </span>            :                                       JS::Handle&lt;jsid&gt; aId,
<span class="lineNum">     236 </span>            :                                       JS::ObjectOpResult &amp;aResult) const
<span class="lineNum">     237 </span>            : {
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :   return aResult.failCantDeleteWindowNamedProperty();</span>
<span class="lineNum">     239 </span>            : }
<a name="240"><span class="lineNum">     240 </span>            : </a>
<span class="lineNum">     241 </span>            : static bool
<span class="lineNum">     242 </span><span class="lineCov">          1 : IsWebExtensionContentScript(JSContext* aCx)</span>
<span class="lineNum">     243 </span>            : {
<span class="lineNum">     244 </span><span class="lineCov">          1 :   auto* priv = xpc::CompartmentPrivate::Get(JS::CurrentGlobalOrNull(aCx));</span>
<span class="lineNum">     245 </span><span class="lineCov">          1 :   return priv-&gt;isWebExtensionContentScript;</span>
<span class="lineNum">     246 </span>            : }
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span>            : static const int32_t kAlwaysAllowNamedPropertiesObject = 0;
<span class="lineNum">     249 </span>            : static const int32_t kDisallowNamedPropertiesObjectForContentScripts = 1;
<span class="lineNum">     250 </span>            : static const int32_t kDisallowNamedPropertiesObjectForXrays = 2;
<a name="251"><span class="lineNum">     251 </span>            : </a>
<span class="lineNum">     252 </span>            : static bool
<span class="lineNum">     253 </span><span class="lineCov">          1 : AllowNamedPropertiesObject(JSContext* aCx)</span>
<span class="lineNum">     254 </span>            : {
<span class="lineNum">     255 </span>            :   static int32_t sAllowed;
<span class="lineNum">     256 </span>            :   static bool sAllowedCached = false;
<span class="lineNum">     257 </span><span class="lineCov">          1 :   if (!sAllowedCached) {</span>
<span class="lineNum">     258 </span>            :     Preferences::AddIntVarCache(&amp;sAllowed,
<span class="lineNum">     259 </span>            :                                 &quot;dom.allow_named_properties_object_for_xrays&quot;,
<span class="lineNum">     260 </span><span class="lineCov">          1 :                                 kDisallowNamedPropertiesObjectForContentScripts);</span>
<span class="lineNum">     261 </span><span class="lineCov">          1 :     sAllowedCached = true;</span>
<span class="lineNum">     262 </span>            :   }
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span><span class="lineCov">          1 :   if (sAllowed == kDisallowNamedPropertiesObjectForXrays) {</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     266 </span>            :   }
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineCov">          1 :   if (sAllowed == kAlwaysAllowNamedPropertiesObject) {</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     270 </span>            :   }
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span><span class="lineCov">          1 :   if (sAllowed == kDisallowNamedPropertiesObjectForContentScripts) {</span>
<span class="lineNum">     273 </span><span class="lineCov">          1 :     return !IsWebExtensionContentScript(aCx);</span>
<span class="lineNum">     274 </span>            :   }
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   NS_WARNING(&quot;Unknown value for dom.allow_named_properties_object_for_xrays&quot;);</span>
<span class="lineNum">     277 </span>            :   // Fail open for now.
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   return true;</span>
<span class="lineNum">     279 </span>            : }
<span class="lineNum">     280 </span>            : 
<a name="281"><span class="lineNum">     281 </span>            : </a>
<span class="lineNum">     282 </span>            : static bool
<span class="lineNum">     283 </span><span class="lineCov">          1 : ResolveWindowNamedProperty(JSContext* aCx, JS::Handle&lt;JSObject*&gt; aWrapper,</span>
<span class="lineNum">     284 </span>            :                            JS::Handle&lt;JSObject*&gt; aObj, JS::Handle&lt;jsid&gt; aId,
<span class="lineNum">     285 </span>            :                            JS::MutableHandle&lt;JS::PropertyDescriptor&gt; aDesc)
<span class="lineNum">     286 </span>            : {
<span class="lineNum">     287 </span><span class="lineCov">          1 :   if (!AllowNamedPropertiesObject(aCx)) {</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     289 </span>            :   }
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :   {
<span class="lineNum">     292 </span><span class="lineCov">          2 :     JSAutoCompartment ac(aCx, aObj);</span>
<span class="lineNum">     293 </span><span class="lineCov">          2 :     if (!js::GetProxyHandler(aObj)-&gt;getOwnPropertyDescriptor(aCx, aObj, aId,</span>
<span class="lineNum">     294 </span><span class="lineCov">          1 :                                                              aDesc)) {</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">     296 </span>            :     }
<span class="lineNum">     297 </span>            :   }
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineCov">          1 :   if (aDesc.object()) {</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :     aDesc.object().set(aWrapper);</span>
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     return JS_WrapPropertyDescriptor(aCx, aDesc);</span>
<span class="lineNum">     303 </span>            :   }
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span><span class="lineCov">          1 :   return true;</span>
<span class="lineNum">     306 </span>            : }
<a name="307"><span class="lineNum">     307 </span>            : </a>
<span class="lineNum">     308 </span>            : static bool
<span class="lineNum">     309 </span><span class="lineNoCov">          0 : EnumerateWindowNamedProperties(JSContext* aCx, JS::Handle&lt;JSObject*&gt; aWrapper,</span>
<span class="lineNum">     310 </span>            :                                JS::Handle&lt;JSObject*&gt; aObj,
<span class="lineNum">     311 </span>            :                                JS::AutoIdVector&amp; aProps)
<span class="lineNum">     312 </span>            : {
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   if (!AllowNamedPropertiesObject(aCx)) {</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     315 </span>            :   }
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :   JSAutoCompartment ac(aCx, aObj);</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :   return js::GetProxyHandler(aObj)-&gt;ownPropertyKeys(aCx, aObj, aProps);</span>
<span class="lineNum">     319 </span>            : }
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span>            : const NativePropertyHooks sWindowNamedPropertiesNativePropertyHooks[] = { {
<span class="lineNum">     322 </span>            :   ResolveWindowNamedProperty,
<span class="lineNum">     323 </span>            :   EnumerateWindowNamedProperties,
<span class="lineNum">     324 </span>            :   nullptr,
<span class="lineNum">     325 </span>            :   { nullptr, nullptr },
<span class="lineNum">     326 </span>            :   prototypes::id::_ID_Count,
<span class="lineNum">     327 </span>            :   constructors::id::_ID_Count,
<span class="lineNum">     328 </span>            :   nullptr
<span class="lineNum">     329 </span>            : } };
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span>            : // Note that this class doesn't need any reserved slots, but SpiderMonkey
<span class="lineNum">     332 </span>            : // asserts all proxy classes have at least one reserved slot.
<span class="lineNum">     333 </span>            : static const DOMIfaceAndProtoJSClass WindowNamedPropertiesClass = {
<span class="lineNum">     334 </span>            :   PROXY_CLASS_DEF(&quot;WindowProperties&quot;,
<span class="lineNum">     335 </span>            :                   JSCLASS_IS_DOMIFACEANDPROTOJSCLASS |
<span class="lineNum">     336 </span>            :                   JSCLASS_HAS_RESERVED_SLOTS(1)),
<span class="lineNum">     337 </span>            :   eNamedPropertiesObject,
<span class="lineNum">     338 </span>            :   false,
<span class="lineNum">     339 </span>            :   prototypes::id::_ID_Count,
<span class="lineNum">     340 </span>            :   0,
<span class="lineNum">     341 </span>            :   sWindowNamedPropertiesNativePropertyHooks,
<span class="lineNum">     342 </span>            :   &quot;[object WindowProperties]&quot;,
<span class="lineNum">     343 </span>            :   EventTargetBinding::GetProtoObject
<span class="lineNum">     344 </span>            : };
<span class="lineNum">     345 </span>            : 
<a name="346"><span class="lineNum">     346 </span>            : // static</a>
<span class="lineNum">     347 </span>            : JSObject*
<span class="lineNum">     348 </span><span class="lineCov">          7 : WindowNamedPropertiesHandler::Create(JSContext* aCx,</span>
<span class="lineNum">     349 </span>            :                                      JS::Handle&lt;JSObject*&gt; aProto)
<span class="lineNum">     350 </span>            : {
<span class="lineNum">     351 </span>            :   // Note: since the scope polluter proxy lives on the window's prototype
<span class="lineNum">     352 </span>            :   // chain, it needs a singleton type to avoid polluting type information
<span class="lineNum">     353 </span>            :   // for properties on the window.
<span class="lineNum">     354 </span><span class="lineCov">          7 :   js::ProxyOptions options;</span>
<span class="lineNum">     355 </span><span class="lineCov">          7 :   options.setSingleton(true);</span>
<span class="lineNum">     356 </span><span class="lineCov">          7 :   options.setClass(&amp;WindowNamedPropertiesClass.mBase);</span>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span><span class="lineCov">         14 :   JS::Rooted&lt;JSObject*&gt; gsp(aCx);</span>
<span class="lineNum">     359 </span><span class="lineCov">         14 :   gsp = js::NewProxyObject(aCx, WindowNamedPropertiesHandler::getInstance(),</span>
<span class="lineNum">     360 </span>            :                            JS::NullHandleValue, aProto,
<span class="lineNum">     361 </span><span class="lineCov">         14 :                            options);</span>
<span class="lineNum">     362 </span><span class="lineCov">          7 :   if (!gsp) {</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     364 </span>            :   }
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span>            :   bool succeeded;
<span class="lineNum">     367 </span><span class="lineCov">          7 :   if (!JS_SetImmutablePrototype(aCx, gsp, &amp;succeeded)) {</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     369 </span>            :   }
<span class="lineNum">     370 </span><span class="lineCov">          7 :   MOZ_ASSERT(succeeded,</span>
<span class="lineNum">     371 </span>            :              &quot;errors making the [[Prototype]] of the named properties object &quot;
<span class="lineNum">     372 </span>            :              &quot;immutable should have been JSAPI failures, not !succeeded&quot;);
<span class="lineNum">     373 </span>            : 
<span class="lineNum">     374 </span><span class="lineCov">          7 :   return gsp;</span>
<span class="lineNum">     375 </span>            : }
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span>            : } // namespace dom
<span class="lineNum">     378 </span>            : } // namespace mozilla
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

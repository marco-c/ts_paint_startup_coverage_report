<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - xpfe/appshell/nsWebShellWindow.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">xpfe/appshell</a> - nsWebShellWindow.cpp<span style="font-size: 80%;"> (source / <a href="nsWebShellWindow.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">146</td>
            <td class="headerCovTableEntry">294</td>
            <td class="headerCovTableEntryLo">49.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">19</td>
            <td class="headerCovTableEntry">35</td>
            <td class="headerCovTableEntryLo">54.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &quot;nsWebShellWindow.h&quot;
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;nsLayoutCID.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;nsContentCID.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsIWeakReference.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;nsIContentViewer.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsIComponentManager.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsIServiceManager.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsIURL.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsIIOService.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsIURL.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsNetCID.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsIStringBundle.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsReadableUtils.h&quot;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;nsEscape.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;nsPIDOMWindow.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsIWebNavigation.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;nsIWindowWatcher.h&quot;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #include &quot;nsIDOMXULElement.h&quot;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &quot;nsWidgetInitData.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;nsWidgetsCID.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;nsIWidget.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;nsIWidgetListener.h&quot;
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : #include &quot;nsIDOMCharacterData.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;nsIDOMNodeList.h&quot;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : #include &quot;nsITimer.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;nsXULPopupManager.h&quot;
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : #include &quot;nsIDOMXULDocument.h&quot;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : #include &quot;nsFocusManager.h&quot;
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span>            : #include &quot;nsIWebProgress.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;nsIWebProgressListener.h&quot;
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : #include &quot;nsIDocument.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;nsIDOMDocument.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;nsIDOMNode.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;nsIDOMElement.h&quot;
<span class="lineNum">      53 </span>            : #include &quot;nsIDocumentLoaderFactory.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;nsIObserverService.h&quot;
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : #include &quot;nsIScreenManager.h&quot;
<span class="lineNum">      57 </span>            : #include &quot;nsIScreen.h&quot;
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : #include &quot;nsIContent.h&quot; // for menus
<span class="lineNum">      60 </span>            : #include &quot;nsIScriptSecurityManager.h&quot;
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            : // For calculating size
<span class="lineNum">      63 </span>            : #include &quot;nsIPresShell.h&quot;
<span class="lineNum">      64 </span>            : #include &quot;nsPresContext.h&quot;
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : #include &quot;nsIBaseWindow.h&quot;
<span class="lineNum">      67 </span>            : #include &quot;nsIDocShellTreeItem.h&quot;
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span>            : #include &quot;mozilla/Attributes.h&quot;
<span class="lineNum">      70 </span>            : #include &quot;mozilla/DebugOnly.h&quot;
<span class="lineNum">      71 </span>            : #include &quot;mozilla/MouseEvents.h&quot;
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            : #include &quot;nsPIWindowRoot.h&quot;
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            : #include &quot;gfxPlatform.h&quot;
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : #ifdef XP_MACOSX
<span class="lineNum">      78 </span>            : #include &quot;nsINativeMenuService.h&quot;
<span class="lineNum">      79 </span>            : #define USE_NATIVE_MENUS
<span class="lineNum">      80 </span>            : #endif
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span>            : using namespace mozilla;
<span class="lineNum">      83 </span>            : using namespace mozilla::dom;
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span>            : /* Define Class IDs */
<span class="lineNum">      86 </span>            : static NS_DEFINE_CID(kWindowCID,           NS_WINDOW_CID);
<span class="lineNum">      87 </span>            : 
<a name="88"><span class="lineNum">      88 </span>            : #define SIZE_PERSISTENCE_TIMEOUT 500 // msec</a>
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span><span class="lineCov">          2 : nsWebShellWindow::nsWebShellWindow(uint32_t aChromeFlags)</span>
<span class="lineNum">      91 </span>            :   : nsXULWindow(aChromeFlags)
<span class="lineNum">      92 </span><span class="lineCov">          2 :   , mSPTimerLock(&quot;nsWebShellWindow.mSPTimerLock&quot;)</span>
<span class="lineNum">      93 </span>            : {
<a name="94"><span class="lineNum">      94 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span><span class="lineNoCov">          0 : nsWebShellWindow::~nsWebShellWindow()</span>
<span class="lineNum">      97 </span>            : {
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   MutexAutoLock lock(mSPTimerLock);</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   if (mSPTimer)</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     mSPTimer-&gt;Cancel();</span>
<a name="101"><span class="lineNum">     101 </span><span class="lineNoCov">          0 : }</span></a>
<a name="102"><span class="lineNum">     102 </span>            : </a>
<span class="lineNum">     103 </span><span class="lineCov">         44 : NS_IMPL_ADDREF_INHERITED(nsWebShellWindow, nsXULWindow)</span>
<a name="104"><span class="lineNum">     104 </span><span class="lineCov">         40 : NS_IMPL_RELEASE_INHERITED(nsWebShellWindow, nsXULWindow)</span></a>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineCov">         37 : NS_INTERFACE_MAP_BEGIN(nsWebShellWindow)</span>
<span class="lineNum">     107 </span><span class="lineCov">         37 :   NS_INTERFACE_MAP_ENTRY(nsIWebProgressListener)</span>
<a name="108"><span class="lineNum">     108 </span><span class="lineCov">         29 : NS_INTERFACE_MAP_END_INHERITING(nsXULWindow)</span></a>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineCov">          2 : nsresult nsWebShellWindow::Initialize(nsIXULWindow* aParent,</span>
<span class="lineNum">     111 </span>            :                                       nsIXULWindow* aOpener,
<span class="lineNum">     112 </span>            :                                       nsIURI* aUrl,
<span class="lineNum">     113 </span>            :                                       int32_t aInitialWidth,
<span class="lineNum">     114 </span>            :                                       int32_t aInitialHeight,
<span class="lineNum">     115 </span>            :                                       bool aIsHiddenWindow,
<span class="lineNum">     116 </span>            :                                       nsITabParent *aOpeningTab,
<span class="lineNum">     117 </span>            :                                       mozIDOMWindowProxy *aOpenerWindow,
<span class="lineNum">     118 </span>            :                                       nsWidgetInitData&amp; widgetInitData)
<span class="lineNum">     119 </span>            : {
<span class="lineNum">     120 </span>            :   nsresult rv;
<span class="lineNum">     121 </span><span class="lineCov">          4 :   nsCOMPtr&lt;nsIWidget&gt; parentWidget;</span>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineCov">          2 :   mIsHiddenWindow = aIsHiddenWindow;</span>
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span><span class="lineCov">          2 :   int32_t initialX = 0, initialY = 0;</span>
<span class="lineNum">     126 </span><span class="lineCov">          4 :   nsCOMPtr&lt;nsIBaseWindow&gt; base(do_QueryInterface(aOpener));</span>
<span class="lineNum">     127 </span><span class="lineCov">          2 :   if (base) {</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     rv = base-&gt;GetPositionAndSize(&amp;mOpenerScreenRect.x,</span>
<span class="lineNum">     129 </span>            :                                   &amp;mOpenerScreenRect.y,
<span class="lineNum">     130 </span>            :                                   &amp;mOpenerScreenRect.width,
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :                                   &amp;mOpenerScreenRect.height);</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :       mOpenerScreenRect.SetEmpty();</span>
<span class="lineNum">     134 </span>            :     } else {
<span class="lineNum">     135 </span>            :       double scale;
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :       if (NS_SUCCEEDED(base-&gt;GetUnscaledDevicePixelsPerCSSPixel(&amp;scale))) {</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         mOpenerScreenRect.x = NSToIntRound(mOpenerScreenRect.x / scale);</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :         mOpenerScreenRect.y = NSToIntRound(mOpenerScreenRect.y / scale);</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :         mOpenerScreenRect.width = NSToIntRound(mOpenerScreenRect.width / scale);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :         mOpenerScreenRect.height = NSToIntRound(mOpenerScreenRect.height / scale);</span>
<span class="lineNum">     141 </span>            :       }
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :       initialX = mOpenerScreenRect.x;</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :       initialY = mOpenerScreenRect.y;</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :       ConstrainToOpenerScreen(&amp;initialX, &amp;initialY);</span>
<span class="lineNum">     145 </span>            :     }
<span class="lineNum">     146 </span>            :   }
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            :   // XXX: need to get the default window size from prefs...
<span class="lineNum">     149 </span>            :   // Doesn't come from prefs... will come from CSS/XUL/RDF
<span class="lineNum">     150 </span><span class="lineCov">          2 :   DesktopIntRect deskRect(initialX, initialY, aInitialWidth, aInitialHeight);</span>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            :   // Create top level window
<span class="lineNum">     153 </span><span class="lineCov">          2 :   if (gfxPlatform::IsHeadless()) {</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :     mWindow = nsIWidget::CreateHeadlessWidget();</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :     if (!mWindow) {</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :       return NS_ERROR_FAILURE;</span>
<span class="lineNum">     157 </span>            :     }
<span class="lineNum">     158 </span>            :   } else {
<span class="lineNum">     159 </span><span class="lineCov">          2 :     mWindow = do_CreateInstance(kWindowCID, &amp;rv);</span>
<span class="lineNum">     160 </span><span class="lineCov">          2 :     if (NS_OK != rv) {</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :       return rv;</span>
<span class="lineNum">     162 </span>            :     }
<span class="lineNum">     163 </span>            :   }
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span>            :   /* This next bit is troublesome. We carry two different versions of a pointer
<span class="lineNum">     166 </span>            :      to our parent window. One is the parent window's widget, which is passed
<span class="lineNum">     167 </span>            :      to our own widget. The other is a weak reference we keep here to our
<span class="lineNum">     168 </span>            :      parent WebShellWindow. The former is useful to the widget, and we can't
<span class="lineNum">     169 </span>            :      trust its treatment of the parent reference because they're platform-
<span class="lineNum">     170 </span>            :      specific. The latter is useful to this class.
<span class="lineNum">     171 </span>            :        A better implementation would be one in which the parent keeps strong
<span class="lineNum">     172 </span>            :      references to its children and closes them before it allows itself
<span class="lineNum">     173 </span>            :      to be closed. This would mimic the behaviour of OSes that support
<span class="lineNum">     174 </span>            :      top-level child windows in OSes that do not. Later.
<span class="lineNum">     175 </span>            :   */
<span class="lineNum">     176 </span><span class="lineCov">          4 :   nsCOMPtr&lt;nsIBaseWindow&gt; parentAsWin(do_QueryInterface(aParent));</span>
<span class="lineNum">     177 </span><span class="lineCov">          2 :   if (parentAsWin) {</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :     parentAsWin-&gt;GetMainWidget(getter_AddRefs(parentWidget));</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     mParentWindow = do_GetWeakReference(aParent);</span>
<span class="lineNum">     180 </span>            :   }
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span><span class="lineCov">          2 :   mWindow-&gt;SetWidgetListener(this);</span>
<span class="lineNum">     183 </span><span class="lineCov">          4 :   rv = mWindow-&gt;Create((nsIWidget *)parentWidget, // Parent nsIWidget</span>
<span class="lineNum">     184 </span>            :                        nullptr,                   // Native parent widget
<span class="lineNum">     185 </span>            :                        deskRect,                  // Widget dimensions
<span class="lineNum">     186 </span><span class="lineCov">          2 :                        &amp;widgetInitData);          // Widget initialization data</span>
<span class="lineNum">     187 </span><span class="lineCov">          2 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineCov">          2 :   LayoutDeviceIntRect r = mWindow-&gt;GetClientBounds();</span>
<span class="lineNum">     190 </span>            :   // Match the default background color of content. Important on windows
<span class="lineNum">     191 </span>            :   // since we no longer use content child widgets.
<span class="lineNum">     192 </span><span class="lineCov">          2 :   mWindow-&gt;SetBackgroundColor(NS_RGB(255,255,255));</span>
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            :   // Create web shell
<span class="lineNum">     195 </span><span class="lineCov">          2 :   mDocShell = do_CreateInstance(&quot;@mozilla.org/docshell;1&quot;);</span>
<span class="lineNum">     196 </span><span class="lineCov">          2 :   NS_ENSURE_TRUE(mDocShell, NS_ERROR_FAILURE);</span>
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span><span class="lineCov">          2 :   mDocShell-&gt;SetOpener(aOpeningTab);</span>
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            :   // Make sure to set the item type on the docshell _before_ calling
<span class="lineNum">     201 </span>            :   // Create() so it knows what type it is.
<span class="lineNum">     202 </span><span class="lineCov">          4 :   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem(do_QueryInterface(mDocShell));</span>
<span class="lineNum">     203 </span><span class="lineCov">          2 :   NS_ENSURE_TRUE(docShellAsItem, NS_ERROR_FAILURE);</span>
<span class="lineNum">     204 </span><span class="lineCov">          2 :   NS_ENSURE_SUCCESS(EnsureChromeTreeOwner(), NS_ERROR_FAILURE);</span>
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span><span class="lineCov">          2 :   docShellAsItem-&gt;SetTreeOwner(mChromeTreeOwner);</span>
<span class="lineNum">     207 </span><span class="lineCov">          2 :   docShellAsItem-&gt;SetItemType(nsIDocShellTreeItem::typeChrome);</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineCov">          2 :   r.x = r.y = 0;</span>
<span class="lineNum">     210 </span><span class="lineCov">          4 :   nsCOMPtr&lt;nsIBaseWindow&gt; docShellAsWin(do_QueryInterface(mDocShell));</span>
<span class="lineNum">     211 </span><span class="lineCov">          2 :   NS_ENSURE_SUCCESS(docShellAsWin-&gt;InitWindow(nullptr, mWindow,</span>
<span class="lineNum">     212 </span>            :    r.x, r.y, r.width, r.height), NS_ERROR_FAILURE);
<span class="lineNum">     213 </span><span class="lineCov">          2 :   NS_ENSURE_SUCCESS(docShellAsWin-&gt;Create(), NS_ERROR_FAILURE);</span>
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span>            :   // Attach a WebProgress listener.during initialization...
<span class="lineNum">     216 </span><span class="lineCov">          4 :   nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_GetInterface(mDocShell, &amp;rv));</span>
<span class="lineNum">     217 </span><span class="lineCov">          2 :   if (webProgress) {</span>
<span class="lineNum">     218 </span><span class="lineCov">          2 :     webProgress-&gt;AddProgressListener(this, nsIWebProgress::NOTIFY_STATE_NETWORK);</span>
<span class="lineNum">     219 </span>            :   }
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span><span class="lineCov">          2 :   if (aOpenerWindow) {</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :     nsPIDOMWindowOuter* window = mDocShell-&gt;GetWindow();</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(window);</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :     window-&gt;SetOpenerWindow(nsPIDOMWindowOuter::From(aOpenerWindow), true);</span>
<span class="lineNum">     225 </span>            :   }
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span>            :   // Eagerly create an about:blank content viewer with the right principal here,
<span class="lineNum">     228 </span>            :   // rather than letting it happening in the upcoming call to
<span class="lineNum">     229 </span>            :   // SetInitialPrincipalToSubject. This avoids creating the about:blank document
<span class="lineNum">     230 </span>            :   // and then blowing it away with a second one, which can cause problems for the
<span class="lineNum">     231 </span>            :   // top-level chrome window case. See bug 789773.
<span class="lineNum">     232 </span>            :   // Note that we don't accept expanded principals here, similar to
<span class="lineNum">     233 </span>            :   // SetInitialPrincipalToSubject.
<span class="lineNum">     234 </span><span class="lineCov">          2 :   if (nsContentUtils::IsInitialized()) { // Sometimes this happens really early  See bug 793370.</span>
<span class="lineNum">     235 </span><span class="lineCov">          2 :     MOZ_ASSERT(mDocShell-&gt;ItemType() == nsIDocShellTreeItem::typeChrome);</span>
<span class="lineNum">     236 </span><span class="lineCov">          4 :     nsCOMPtr&lt;nsIPrincipal&gt; principal = nsContentUtils::SubjectPrincipalOrSystemIfNativeCaller();</span>
<span class="lineNum">     237 </span><span class="lineCov">          2 :     if (nsContentUtils::IsExpandedPrincipal(principal)) {</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :       principal = nullptr;</span>
<span class="lineNum">     239 </span>            :     }
<span class="lineNum">     240 </span><span class="lineCov">          2 :     rv = mDocShell-&gt;CreateAboutBlankContentViewer(principal);</span>
<span class="lineNum">     241 </span><span class="lineCov">          2 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     242 </span><span class="lineCov">          4 :     nsCOMPtr&lt;nsIDocument&gt; doc = mDocShell-&gt;GetDocument();</span>
<span class="lineNum">     243 </span><span class="lineCov">          2 :     NS_ENSURE_TRUE(!!doc, NS_ERROR_FAILURE);</span>
<span class="lineNum">     244 </span><span class="lineCov">          2 :     doc-&gt;SetIsInitialDocument(true);</span>
<span class="lineNum">     245 </span>            :   }
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineCov">          2 :   if (nullptr != aUrl)  {</span>
<span class="lineNum">     248 </span><span class="lineCov">          2 :     nsCString tmpStr;</span>
<span class="lineNum">     249 </span>            : 
<span class="lineNum">     250 </span><span class="lineCov">          1 :     rv = aUrl-&gt;GetSpec(tmpStr);</span>
<span class="lineNum">     251 </span><span class="lineCov">          1 :     if (NS_FAILED(rv)) return rv;</span>
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span><span class="lineCov">          2 :     NS_ConvertUTF8toUTF16 urlString(tmpStr);</span>
<span class="lineNum">     254 </span><span class="lineCov">          2 :     nsCOMPtr&lt;nsIWebNavigation&gt; webNav(do_QueryInterface(mDocShell));</span>
<span class="lineNum">     255 </span><span class="lineCov">          1 :     NS_ENSURE_TRUE(webNav, NS_ERROR_FAILURE);</span>
<span class="lineNum">     256 </span><span class="lineCov">          2 :     rv = webNav-&gt;LoadURI(urlString.get(),</span>
<span class="lineNum">     257 </span>            :                          nsIWebNavigation::LOAD_FLAGS_NONE,
<span class="lineNum">     258 </span>            :                          nullptr,
<span class="lineNum">     259 </span>            :                          nullptr,
<span class="lineNum">     260 </span>            :                          nullptr,
<span class="lineNum">     261 </span><span class="lineCov">          1 :                          nsContentUtils::GetSystemPrincipal());</span>
<span class="lineNum">     262 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     263 </span>            :   }
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span><span class="lineCov">          2 :   return rv;</span>
<span class="lineNum">     266 </span>            : }
<a name="267"><span class="lineNum">     267 </span>            : </a>
<span class="lineNum">     268 </span>            : nsIPresShell*
<span class="lineNum">     269 </span><span class="lineCov">          1 : nsWebShellWindow::GetPresShell()</span>
<span class="lineNum">     270 </span>            : {
<span class="lineNum">     271 </span><span class="lineCov">          1 :   if (!mDocShell)</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     273 </span>            : 
<span class="lineNum">     274 </span><span class="lineCov">          1 :   return mDocShell-&gt;GetPresShell();</span>
<span class="lineNum">     275 </span>            : }
<a name="276"><span class="lineNum">     276 </span>            : </a>
<span class="lineNum">     277 </span>            : bool
<span class="lineNum">     278 </span><span class="lineCov">          5 : nsWebShellWindow::WindowMoved(nsIWidget* aWidget, int32_t x, int32_t y)</span>
<span class="lineNum">     279 </span>            : {
<span class="lineNum">     280 </span><span class="lineCov">          5 :   nsXULPopupManager* pm = nsXULPopupManager::GetInstance();</span>
<span class="lineNum">     281 </span><span class="lineCov">          5 :   if (pm) {</span>
<span class="lineNum">     282 </span>            :     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window =
<span class="lineNum">     283 </span><span class="lineCov">         10 :       mDocShell ? mDocShell-&gt;GetWindow() : nullptr;</span>
<span class="lineNum">     284 </span><span class="lineCov">          5 :     pm-&gt;AdjustPopupsOnWindowChange(window);</span>
<span class="lineNum">     285 </span>            :   }
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span>            :   // Notify all tabs that the widget moved.
<span class="lineNum">     288 </span><span class="lineCov">          5 :   if (mDocShell &amp;&amp; mDocShell-&gt;GetWindow()) {</span>
<span class="lineNum">     289 </span><span class="lineCov">         10 :     nsCOMPtr&lt;EventTarget&gt; eventTarget = mDocShell-&gt;GetWindow()-&gt;GetTopWindowRoot();</span>
<span class="lineNum">     290 </span><span class="lineCov">         10 :     nsContentUtils::DispatchChromeEvent(mDocShell-&gt;GetDocument(),</span>
<span class="lineNum">     291 </span>            :                                         eventTarget,
<span class="lineNum">     292 </span><span class="lineCov">         10 :                                         NS_LITERAL_STRING(&quot;MozUpdateWindowPos&quot;),</span>
<span class="lineNum">     293 </span><span class="lineCov">         15 :                                         false, false, nullptr);</span>
<span class="lineNum">     294 </span>            :   }
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span>            :   // Persist position, but not immediately, in case this OS is firing
<span class="lineNum">     297 </span>            :   // repeated move events as the user drags the window
<span class="lineNum">     298 </span><span class="lineCov">          5 :   SetPersistenceTimer(PAD_POSITION);</span>
<span class="lineNum">     299 </span><span class="lineCov">          5 :   return false;</span>
<span class="lineNum">     300 </span>            : }
<a name="301"><span class="lineNum">     301 </span>            : </a>
<span class="lineNum">     302 </span>            : bool
<span class="lineNum">     303 </span><span class="lineCov">          2 : nsWebShellWindow::WindowResized(nsIWidget* aWidget, int32_t aWidth, int32_t aHeight)</span>
<span class="lineNum">     304 </span>            : {
<span class="lineNum">     305 </span><span class="lineCov">          4 :   nsCOMPtr&lt;nsIBaseWindow&gt; shellAsWin(do_QueryInterface(mDocShell));</span>
<span class="lineNum">     306 </span><span class="lineCov">          2 :   if (shellAsWin) {</span>
<span class="lineNum">     307 </span><span class="lineCov">          2 :     shellAsWin-&gt;SetPositionAndSize(0, 0, aWidth, aHeight, 0);</span>
<span class="lineNum">     308 </span>            :   }
<span class="lineNum">     309 </span>            :   // Persist size, but not immediately, in case this OS is firing
<span class="lineNum">     310 </span>            :   // repeated size events as the user drags the sizing handle
<span class="lineNum">     311 </span><span class="lineCov">          2 :   if (!IsLocked())</span>
<span class="lineNum">     312 </span><span class="lineCov">          2 :     SetPersistenceTimer(PAD_POSITION | PAD_SIZE | PAD_MISC);</span>
<span class="lineNum">     313 </span><span class="lineCov">          4 :   return true;</span>
<span class="lineNum">     314 </span>            : }
<a name="315"><span class="lineNum">     315 </span>            : </a>
<span class="lineNum">     316 </span>            : bool
<span class="lineNum">     317 </span><span class="lineNoCov">          0 : nsWebShellWindow::RequestWindowClose(nsIWidget* aWidget)</span>
<span class="lineNum">     318 </span>            : {
<span class="lineNum">     319 </span>            :   // Maintain a reference to this as it is about to get destroyed.
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIXULWindow&gt; xulWindow(this);</span>
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window(mDocShell ? mDocShell-&gt;GetWindow() : nullptr);</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;EventTarget&gt; eventTarget = do_QueryInterface(window);</span>
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPresShell&gt; presShell = mDocShell-&gt;GetPresShell();</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   if (!presShell) {</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     mozilla::DebugOnly&lt;bool&gt; dying;</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(NS_SUCCEEDED(mDocShell-&gt;IsBeingDestroyed(&amp;dying)) &amp;&amp; dying,</span>
<span class="lineNum">     329 </span>            :                &quot;No presShell, but window is not being destroyed&quot;);
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :   } else if (eventTarget) {</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     RefPtr&lt;nsPresContext&gt; presContext = presShell-&gt;GetPresContext();</span>
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     nsEventStatus status = nsEventStatus_eIgnore;</span>
<span class="lineNum">     334 </span>            :     WidgetMouseEvent event(true, eClose, nullptr,
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :                            WidgetMouseEvent::eReal);</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     if (NS_SUCCEEDED(eventTarget-&gt;DispatchDOMEvent(&amp;event, nullptr, presContext, &amp;status)) &amp;&amp;</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :         status == nsEventStatus_eConsumeNoDefault)</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">     339 </span>            :   }
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :   Destroy();</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">     343 </span>            : }
<a name="344"><span class="lineNum">     344 </span>            : </a>
<span class="lineNum">     345 </span>            : void
<span class="lineNum">     346 </span><span class="lineCov">          1 : nsWebShellWindow::SizeModeChanged(nsSizeMode sizeMode)</span>
<span class="lineNum">     347 </span>            : {
<span class="lineNum">     348 </span>            :   // An alwaysRaised (or higher) window will hide any newly opened normal
<span class="lineNum">     349 </span>            :   // browser windows, so here we just drop a raised window to the normal
<span class="lineNum">     350 </span>            :   // zlevel if it's maximized. We make no provision for automatically
<span class="lineNum">     351 </span>            :   // re-raising it when restored.
<span class="lineNum">     352 </span><span class="lineCov">          1 :   if (sizeMode == nsSizeMode_Maximized || sizeMode == nsSizeMode_Fullscreen) {</span>
<span class="lineNum">     353 </span>            :     uint32_t zLevel;
<span class="lineNum">     354 </span><span class="lineCov">          1 :     GetZLevel(&amp;zLevel);</span>
<span class="lineNum">     355 </span><span class="lineCov">          1 :     if (zLevel &gt; nsIXULWindow::normalZ)</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :       SetZLevel(nsIXULWindow::normalZ);</span>
<span class="lineNum">     357 </span>            :   }
<span class="lineNum">     358 </span><span class="lineCov">          1 :   mWindow-&gt;SetSizeMode(sizeMode);</span>
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span>            :   // Persist mode, but not immediately, because in many (all?)
<span class="lineNum">     361 </span>            :   // cases this will merge with the similar call in NS_SIZE and
<span class="lineNum">     362 </span>            :   // write the attribute values only once.
<span class="lineNum">     363 </span><span class="lineCov">          1 :   SetPersistenceTimer(PAD_MISC);</span>
<span class="lineNum">     364 </span>            :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; ourWindow =
<span class="lineNum">     365 </span><span class="lineCov">          2 :     mDocShell ? mDocShell-&gt;GetWindow() : nullptr;</span>
<span class="lineNum">     366 </span><span class="lineCov">          1 :   if (ourWindow) {</span>
<span class="lineNum">     367 </span><span class="lineCov">          1 :     MOZ_ASSERT(ourWindow-&gt;IsOuterWindow());</span>
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span>            :     // Ensure that the fullscreen state is synchronized between
<span class="lineNum">     370 </span>            :     // the widget and the outer window object.
<span class="lineNum">     371 </span><span class="lineCov">          1 :     if (sizeMode == nsSizeMode_Fullscreen) {</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :       ourWindow-&gt;SetFullScreen(true);</span>
<span class="lineNum">     373 </span>            :     }
<span class="lineNum">     374 </span><span class="lineCov">          1 :     else if (sizeMode != nsSizeMode_Minimized) {</span>
<span class="lineNum">     375 </span><span class="lineCov">          1 :       if (ourWindow-&gt;GetFullScreen()) {</span>
<span class="lineNum">     376 </span>            :         // The first SetFullscreenInternal call below ensures that we do
<span class="lineNum">     377 </span>            :         // not trigger any fullscreen transition even if the window was
<span class="lineNum">     378 </span>            :         // put in fullscreen only for the Fullscreen API. The second
<span class="lineNum">     379 </span>            :         // SetFullScreen call ensures that the window really exit from
<span class="lineNum">     380 </span>            :         // fullscreen even if it entered fullscreen for both Fullscreen
<span class="lineNum">     381 </span>            :         // Mode and Fullscreen API.
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :         ourWindow-&gt;SetFullscreenInternal(FullscreenReason::ForForceExitFullscreen, false);</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         ourWindow-&gt;SetFullScreen(false);</span>
<span class="lineNum">     384 </span>            :       }
<span class="lineNum">     385 </span>            :     }
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span>            :     // And always fire a user-defined sizemodechange event on the window
<span class="lineNum">     388 </span><span class="lineCov">          1 :     ourWindow-&gt;DispatchCustomEvent(NS_LITERAL_STRING(&quot;sizemodechange&quot;));</span>
<span class="lineNum">     389 </span>            :   }
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span>            :   nsIPresShell* presShell;
<span class="lineNum">     392 </span><span class="lineCov">          1 :   if ((presShell = GetPresShell())) {</span>
<span class="lineNum">     393 </span><span class="lineCov">          1 :     presShell-&gt;GetPresContext()-&gt;SizeModeChanged(sizeMode);</span>
<span class="lineNum">     394 </span>            :   }
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span>            :   // Note the current implementation of SetSizeMode just stores
<span class="lineNum">     397 </span>            :   // the new state; it doesn't actually resize. So here we store
<span class="lineNum">     398 </span>            :   // the state and pass the event on to the OS. The day is coming
<span class="lineNum">     399 </span>            :   // when we'll handle the event here, and the return result will
<span class="lineNum">     400 </span>            :   // then need to be different.
<span class="lineNum">     401 </span><span class="lineCov">          1 : }</span>
<a name="402"><span class="lineNum">     402 </span>            : </a>
<span class="lineNum">     403 </span>            : void
<span class="lineNum">     404 </span><span class="lineNoCov">          0 : nsWebShellWindow::UIResolutionChanged()</span>
<span class="lineNum">     405 </span>            : {
<span class="lineNum">     406 </span>            :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; ourWindow =
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     mDocShell ? mDocShell-&gt;GetWindow() : nullptr;</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   if (ourWindow) {</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(ourWindow-&gt;IsOuterWindow());</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :     ourWindow-&gt;DispatchCustomEvent(NS_LITERAL_STRING(&quot;resolutionchange&quot;));</span>
<span class="lineNum">     411 </span>            :   }
<span class="lineNum">     412 </span><span class="lineNoCov">          0 : }</span>
<a name="413"><span class="lineNum">     413 </span>            : </a>
<span class="lineNum">     414 </span>            : void
<span class="lineNum">     415 </span><span class="lineNoCov">          0 : nsWebShellWindow::FullscreenChanged(bool aInFullscreen)</span>
<span class="lineNum">     416 </span>            : {
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :   if (mDocShell) {</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     if (nsCOMPtr&lt;nsPIDOMWindowOuter&gt; ourWindow = mDocShell-&gt;GetWindow()) {</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :       ourWindow-&gt;FinishFullscreenChange(aInFullscreen);</span>
<span class="lineNum">     420 </span>            :     }
<span class="lineNum">     421 </span>            :   }
<span class="lineNum">     422 </span><span class="lineNoCov">          0 : }</span>
<a name="423"><span class="lineNum">     423 </span>            : </a>
<span class="lineNum">     424 </span>            : void
<span class="lineNum">     425 </span><span class="lineNoCov">          0 : nsWebShellWindow::OcclusionStateChanged(bool aIsFullyOccluded)</span>
<span class="lineNum">     426 </span>            : {
<span class="lineNum">     427 </span>            :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; ourWindow =
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :     mDocShell ? mDocShell-&gt;GetWindow() : nullptr;</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :   if (ourWindow) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(ourWindow-&gt;IsOuterWindow());</span>
<span class="lineNum">     431 </span>            :     // And always fire a user-defined occlusionstatechange event on the window
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     ourWindow-&gt;DispatchCustomEvent(NS_LITERAL_STRING(&quot;occlusionstatechange&quot;));</span>
<span class="lineNum">     433 </span>            :   }
<span class="lineNum">     434 </span><span class="lineNoCov">          0 : }</span>
<a name="435"><span class="lineNum">     435 </span>            : </a>
<span class="lineNum">     436 </span>            : void
<span class="lineNum">     437 </span><span class="lineNoCov">          0 : nsWebShellWindow::OSToolbarButtonPressed()</span>
<span class="lineNum">     438 </span>            : {
<span class="lineNum">     439 </span>            :   // Keep a reference as setting the chrome flags can fire events.
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIXULWindow&gt; xulWindow(this);</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span>            :   // rjc: don't use &quot;nsIWebBrowserChrome::CHROME_EXTRA&quot;
<span class="lineNum">     443 </span>            :   //      due to components with multiple sidebar components
<span class="lineNum">     444 </span>            :   //      (such as Mail/News, Addressbook, etc)... and frankly,
<span class="lineNum">     445 </span>            :   //      Mac IE, OmniWeb, and other Mac OS X apps all work this way
<span class="lineNum">     446 </span>            :   uint32_t    chromeMask = (nsIWebBrowserChrome::CHROME_TOOLBAR |
<span class="lineNum">     447 </span>            :                             nsIWebBrowserChrome::CHROME_LOCATIONBAR |
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :                             nsIWebBrowserChrome::CHROME_PERSONAL_TOOLBAR);</span>
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIWebBrowserChrome&gt; wbc(do_GetInterface(xulWindow));</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :   if (!wbc)</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   uint32_t    chromeFlags, newChromeFlags = 0;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :   wbc-&gt;GetChromeFlags(&amp;chromeFlags);</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :   newChromeFlags = chromeFlags &amp; chromeMask;</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :   if (!newChromeFlags)    chromeFlags |= chromeMask;</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   else                    chromeFlags &amp;= (~newChromeFlags);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :   wbc-&gt;SetChromeFlags(chromeFlags);</span>
<span class="lineNum">     460 </span>            : }
<a name="461"><span class="lineNum">     461 </span>            : </a>
<span class="lineNum">     462 </span>            : bool
<span class="lineNum">     463 </span><span class="lineNoCov">          0 : nsWebShellWindow::ZLevelChanged(bool aImmediate, nsWindowZ *aPlacement,</span>
<span class="lineNum">     464 </span>            :                                 nsIWidget* aRequestBelow, nsIWidget** aActualBelow)
<span class="lineNum">     465 </span>            : {
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :   if (aActualBelow)</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     *aActualBelow = nullptr;</span>
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :   return ConstrainToZLevel(aImmediate, aPlacement, aRequestBelow, aActualBelow);</span>
<span class="lineNum">     470 </span>            : }
<a name="471"><span class="lineNum">     471 </span>            : </a>
<span class="lineNum">     472 </span>            : void
<span class="lineNum">     473 </span><span class="lineCov">          1 : nsWebShellWindow::WindowActivated()</span>
<span class="lineNum">     474 </span>            : {
<span class="lineNum">     475 </span><span class="lineCov">          2 :   nsCOMPtr&lt;nsIXULWindow&gt; xulWindow(this);</span>
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span>            :   // focusing the window could cause it to close, so keep a reference to it
<span class="lineNum">     478 </span><span class="lineCov">          2 :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = mDocShell ? mDocShell-&gt;GetWindow() : nullptr;</span>
<span class="lineNum">     479 </span><span class="lineCov">          2 :   nsCOMPtr&lt;nsIFocusManager&gt; fm = do_GetService(FOCUSMANAGER_CONTRACTID);</span>
<span class="lineNum">     480 </span><span class="lineCov">          1 :   if (fm &amp;&amp; window)</span>
<span class="lineNum">     481 </span><span class="lineCov">          1 :     fm-&gt;WindowRaised(window);</span>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span><span class="lineCov">          1 :   if (mChromeLoaded) {</span>
<span class="lineNum">     484 </span><span class="lineCov">          1 :     PersistentAttributesDirty(PAD_POSITION | PAD_SIZE | PAD_MISC);</span>
<span class="lineNum">     485 </span><span class="lineCov">          1 :     SavePersistentAttributes();</span>
<span class="lineNum">     486 </span>            :    }
<span class="lineNum">     487 </span><span class="lineCov">          1 : }</span>
<a name="488"><span class="lineNum">     488 </span>            : </a>
<span class="lineNum">     489 </span>            : void
<span class="lineNum">     490 </span><span class="lineNoCov">          0 : nsWebShellWindow::WindowDeactivated()</span>
<span class="lineNum">     491 </span>            : {
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIXULWindow&gt; xulWindow(this);</span>
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span>            :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window =
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     mDocShell ? mDocShell-&gt;GetWindow() : nullptr;</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIFocusManager&gt; fm = do_GetService(FOCUSMANAGER_CONTRACTID);</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :   if (fm &amp;&amp; window)</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :     fm-&gt;WindowLowered(window);</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span>            : #ifdef USE_NATIVE_MENUS
<span class="lineNum">     502 </span>            : static void LoadNativeMenus(nsIDOMDocument *aDOMDoc, nsIWidget *aParentWindow)
<span class="lineNum">     503 </span>            : {
<span class="lineNum">     504 </span>            :   nsCOMPtr&lt;nsINativeMenuService&gt; nms = do_GetService(&quot;@mozilla.org/widget/nativemenuservice;1&quot;);
<span class="lineNum">     505 </span>            :   if (!nms) {
<span class="lineNum">     506 </span>            :     return;
<span class="lineNum">     507 </span>            :   }
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span>            :   // Find the menubar tag (if there is more than one, we ignore all but
<span class="lineNum">     510 </span>            :   // the first).
<span class="lineNum">     511 </span>            :   nsCOMPtr&lt;nsIDOMNodeList&gt; menubarElements;
<span class="lineNum">     512 </span>            :   aDOMDoc-&gt;GetElementsByTagNameNS(NS_LITERAL_STRING(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;),
<span class="lineNum">     513 </span>            :                                   NS_LITERAL_STRING(&quot;menubar&quot;),
<span class="lineNum">     514 </span>            :                                   getter_AddRefs(menubarElements));
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span>            :   nsCOMPtr&lt;nsIDOMNode&gt; menubarNode;
<span class="lineNum">     517 </span>            :   if (menubarElements)
<span class="lineNum">     518 </span>            :     menubarElements-&gt;Item(0, getter_AddRefs(menubarNode));
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span>            :   if (menubarNode) {
<span class="lineNum">     521 </span>            :     nsCOMPtr&lt;nsIContent&gt; menubarContent(do_QueryInterface(menubarNode));
<span class="lineNum">     522 </span>            :     nms-&gt;CreateNativeMenuBar(aParentWindow, menubarContent);
<span class="lineNum">     523 </span>            :   } else {
<span class="lineNum">     524 </span>            :     nms-&gt;CreateNativeMenuBar(aParentWindow, nullptr);
<span class="lineNum">     525 </span>            :   }
<span class="lineNum">     526 </span>            : }
<span class="lineNum">     527 </span>            : #endif
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span>            : namespace mozilla {
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span>            : class WebShellWindowTimerCallback final : public nsITimerCallback
<a name="532"><span class="lineNum">     532 </span>            : {</a>
<span class="lineNum">     533 </span>            : public:
<span class="lineNum">     534 </span><span class="lineCov">          8 :   explicit WebShellWindowTimerCallback(nsWebShellWindow* aWindow)</span>
<span class="lineNum">     535 </span><span class="lineCov">          8 :     : mWindow(aWindow)</span>
<span class="lineNum">     536 </span><span class="lineCov">          8 :   {}</span>
<span class="lineNum">     537 </span>            : 
<a name="538"><span class="lineNum">     538 </span>            :   NS_DECL_THREADSAFE_ISUPPORTS</a>
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span><span class="lineCov">          1 :   NS_IMETHOD Notify(nsITimer* aTimer) override</span>
<span class="lineNum">     541 </span>            :   {
<span class="lineNum">     542 </span>            :     // Although this object participates in a refcount cycle (this -&gt; mWindow
<span class="lineNum">     543 </span>            :     // -&gt; mSPTimer -&gt; this), mSPTimer is a one-shot timer and releases this
<span class="lineNum">     544 </span>            :     // after it fires.  So we don't need to release mWindow here.
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span><span class="lineCov">          1 :     mWindow-&gt;FirePersistenceTimer();</span>
<span class="lineNum">     547 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">     548 </span>            :   }
<a name="549"><span class="lineNum">     549 </span>            : </a>
<span class="lineNum">     550 </span>            : private:
<span class="lineNum">     551 </span><span class="lineCov">          8 :   ~WebShellWindowTimerCallback() {}</span>
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span>            :   RefPtr&lt;nsWebShellWindow&gt; mWindow;
<a name="554"><span class="lineNum">     554 </span>            : };</a>
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span><span class="lineCov">         42 : NS_IMPL_ISUPPORTS(WebShellWindowTimerCallback, nsITimerCallback)</span>
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span>            : } // namespace mozilla
<a name="559"><span class="lineNum">     559 </span>            : </a>
<span class="lineNum">     560 </span>            : void
<span class="lineNum">     561 </span><span class="lineCov">          8 : nsWebShellWindow::SetPersistenceTimer(uint32_t aDirtyFlags)</span>
<span class="lineNum">     562 </span>            : {
<span class="lineNum">     563 </span><span class="lineCov">         16 :   MutexAutoLock lock(mSPTimerLock);</span>
<span class="lineNum">     564 </span><span class="lineCov">          8 :   if (!mSPTimer) {</span>
<span class="lineNum">     565 </span><span class="lineCov">          1 :     mSPTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<span class="lineNum">     566 </span><span class="lineCov">          1 :     if (!mSPTimer) {</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :       NS_WARNING(&quot;Couldn't create @mozilla.org/timer;1 instance?&quot;);</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     569 </span>            :     }
<span class="lineNum">     570 </span>            :   }
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span>            :   RefPtr&lt;WebShellWindowTimerCallback&gt; callback =
<span class="lineNum">     573 </span><span class="lineCov">         16 :     new WebShellWindowTimerCallback(this);</span>
<span class="lineNum">     574 </span><span class="lineCov">          8 :   mSPTimer-&gt;InitWithCallback(callback, SIZE_PERSISTENCE_TIMEOUT,</span>
<span class="lineNum">     575 </span><span class="lineCov">          8 :                              nsITimer::TYPE_ONE_SHOT);</span>
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span><span class="lineCov">          8 :   PersistentAttributesDirty(aDirtyFlags);</span>
<span class="lineNum">     578 </span>            : }
<a name="579"><span class="lineNum">     579 </span>            : </a>
<span class="lineNum">     580 </span>            : void
<span class="lineNum">     581 </span><span class="lineCov">          1 : nsWebShellWindow::FirePersistenceTimer()</span>
<span class="lineNum">     582 </span>            : {
<span class="lineNum">     583 </span><span class="lineCov">          2 :   MutexAutoLock lock(mSPTimerLock);</span>
<span class="lineNum">     584 </span><span class="lineCov">          1 :   SavePersistentAttributes();</span>
<span class="lineNum">     585 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span>            : //----------------------------------------
<span class="lineNum">     589 </span>            : // nsIWebProgessListener implementation
<a name="590"><span class="lineNum">     590 </span>            : //----------------------------------------</a>
<span class="lineNum">     591 </span>            : NS_IMETHODIMP
<span class="lineNum">     592 </span><span class="lineNoCov">          0 : nsWebShellWindow::OnProgressChange(nsIWebProgress *aProgress,</span>
<span class="lineNum">     593 </span>            :                                    nsIRequest *aRequest,
<span class="lineNum">     594 </span>            :                                    int32_t aCurSelfProgress,
<span class="lineNum">     595 </span>            :                                    int32_t aMaxSelfProgress,
<span class="lineNum">     596 </span>            :                                    int32_t aCurTotalProgress,
<span class="lineNum">     597 </span>            :                                    int32_t aMaxTotalProgress)
<span class="lineNum">     598 </span>            : {
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :   NS_NOTREACHED(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     601 </span>            : }
<a name="602"><span class="lineNum">     602 </span>            : </a>
<span class="lineNum">     603 </span>            : NS_IMETHODIMP
<span class="lineNum">     604 </span><span class="lineCov">          4 : nsWebShellWindow::OnStateChange(nsIWebProgress *aProgress,</span>
<span class="lineNum">     605 </span>            :                                 nsIRequest *aRequest,
<span class="lineNum">     606 </span>            :                                 uint32_t aStateFlags,
<span class="lineNum">     607 </span>            :                                 nsresult aStatus)
<span class="lineNum">     608 </span>            : {
<span class="lineNum">     609 </span>            :   // If the notification is not about a document finishing, then just
<span class="lineNum">     610 </span>            :   // ignore it...
<span class="lineNum">     611 </span><span class="lineCov">          6 :   if (!(aStateFlags &amp; nsIWebProgressListener::STATE_STOP) ||</span>
<span class="lineNum">     612 </span><span class="lineCov">          2 :       !(aStateFlags &amp; nsIWebProgressListener::STATE_IS_NETWORK)) {</span>
<span class="lineNum">     613 </span><span class="lineCov">          2 :     return NS_OK;</span>
<span class="lineNum">     614 </span>            :   }
<span class="lineNum">     615 </span>            : 
<span class="lineNum">     616 </span><span class="lineCov">          2 :   if (mChromeLoaded)</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span>            :   // If this document notification is for a frame then ignore it...
<span class="lineNum">     620 </span><span class="lineCov">          4 :   nsCOMPtr&lt;mozIDOMWindowProxy&gt; eventWin;</span>
<span class="lineNum">     621 </span><span class="lineCov">          2 :   aProgress-&gt;GetDOMWindow(getter_AddRefs(eventWin));</span>
<span class="lineNum">     622 </span><span class="lineCov">          2 :   auto* eventPWin = nsPIDOMWindowOuter::From(eventWin);</span>
<span class="lineNum">     623 </span><span class="lineCov">          2 :   if (eventPWin) {</span>
<span class="lineNum">     624 </span><span class="lineCov">          2 :     nsPIDOMWindowOuter *rootPWin = eventPWin-&gt;GetPrivateRoot();</span>
<span class="lineNum">     625 </span><span class="lineCov">          2 :     if (eventPWin != rootPWin)</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :       return NS_OK;</span>
<span class="lineNum">     627 </span>            :   }
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span><span class="lineCov">          2 :   mChromeLoaded = true;</span>
<span class="lineNum">     630 </span><span class="lineCov">          2 :   mLockedUntilChromeLoad = false;</span>
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span>            : #ifdef USE_NATIVE_MENUS
<span class="lineNum">     633 </span>            :   ///////////////////////////////
<span class="lineNum">     634 </span>            :   // Find the Menubar DOM  and Load the menus, hooking them up to the loaded commands
<span class="lineNum">     635 </span>            :   ///////////////////////////////
<span class="lineNum">     636 </span>            :   nsCOMPtr&lt;nsIContentViewer&gt; cv;
<span class="lineNum">     637 </span>            :   mDocShell-&gt;GetContentViewer(getter_AddRefs(cv));
<span class="lineNum">     638 </span>            :   if (cv) {
<span class="lineNum">     639 </span>            :     nsCOMPtr&lt;nsIDOMDocument&gt; menubarDOMDoc(do_QueryInterface(cv-&gt;GetDocument()));
<span class="lineNum">     640 </span>            :     if (menubarDOMDoc)
<span class="lineNum">     641 </span>            :       LoadNativeMenus(menubarDOMDoc, mWindow);
<span class="lineNum">     642 </span>            :   }
<span class="lineNum">     643 </span>            : #endif // USE_NATIVE_MENUS
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineCov">          2 :   OnChromeLoaded();</span>
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span><span class="lineCov">          2 :   return NS_OK;</span>
<span class="lineNum">     648 </span>            : }
<a name="649"><span class="lineNum">     649 </span>            : </a>
<span class="lineNum">     650 </span>            : NS_IMETHODIMP
<span class="lineNum">     651 </span><span class="lineNoCov">          0 : nsWebShellWindow::OnLocationChange(nsIWebProgress *aProgress,</span>
<span class="lineNum">     652 </span>            :                                    nsIRequest *aRequest,
<span class="lineNum">     653 </span>            :                                    nsIURI *aURI,
<span class="lineNum">     654 </span>            :                                    uint32_t aFlags)
<span class="lineNum">     655 </span>            : {
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :   NS_NOTREACHED(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     658 </span>            : }
<a name="659"><span class="lineNum">     659 </span>            : </a>
<span class="lineNum">     660 </span>            : NS_IMETHODIMP
<span class="lineNum">     661 </span><span class="lineNoCov">          0 : nsWebShellWindow::OnStatusChange(nsIWebProgress* aWebProgress,</span>
<span class="lineNum">     662 </span>            :                                  nsIRequest* aRequest,
<span class="lineNum">     663 </span>            :                                  nsresult aStatus,
<span class="lineNum">     664 </span>            :                                  const char16_t* aMessage)
<span class="lineNum">     665 </span>            : {
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :   NS_NOTREACHED(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     668 </span>            : }
<a name="669"><span class="lineNum">     669 </span>            : </a>
<span class="lineNum">     670 </span>            : NS_IMETHODIMP
<span class="lineNum">     671 </span><span class="lineNoCov">          0 : nsWebShellWindow::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<span class="lineNum">     672 </span>            :                                    nsIRequest *aRequest,
<span class="lineNum">     673 </span>            :                                    uint32_t state)
<span class="lineNum">     674 </span>            : {
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :   NS_NOTREACHED(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     677 </span>            : }
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span>            : /**
<span class="lineNum">     681 </span>            :  * ExecuteCloseHandler - Run the close handler, if any.
<a name="682"><span class="lineNum">     682 </span>            :  * @return true iff we found a close handler to run.</a>
<span class="lineNum">     683 </span>            :  */
<span class="lineNum">     684 </span><span class="lineNoCov">          0 : bool nsWebShellWindow::ExecuteCloseHandler()</span>
<span class="lineNum">     685 </span>            : {
<span class="lineNum">     686 </span>            :   /* If the event handler closes this window -- a likely scenario --
<span class="lineNum">     687 </span>            :      things get deleted out of order without this death grip.
<span class="lineNum">     688 </span>            :      (The problem may be the death grip in nsWindow::windowProc,
<span class="lineNum">     689 </span>            :      which forces this window's widget to remain alive longer
<span class="lineNum">     690 </span>            :      than it otherwise would.) */
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIXULWindow&gt; kungFuDeathGrip(this);</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;EventTarget&gt; eventTarget;</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :   if (mDocShell) {</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :     eventTarget = do_QueryInterface(mDocShell-&gt;GetWindow());</span>
<span class="lineNum">     696 </span>            :   }
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :   if (eventTarget) {</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIContentViewer&gt; contentViewer;</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :     mDocShell-&gt;GetContentViewer(getter_AddRefs(contentViewer));</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :     if (contentViewer) {</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :       RefPtr&lt;nsPresContext&gt; presContext;</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :       contentViewer-&gt;GetPresContext(getter_AddRefs(presContext));</span>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :       nsEventStatus status = nsEventStatus_eIgnore;</span>
<span class="lineNum">     706 </span>            :       WidgetMouseEvent event(true, eClose, nullptr,
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :                              WidgetMouseEvent::eReal);</span>
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span>            :       nsresult rv =
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :         eventTarget-&gt;DispatchDOMEvent(&amp;event, nullptr, presContext, &amp;status);</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :       if (NS_SUCCEEDED(rv) &amp;&amp; status == nsEventStatus_eConsumeNoDefault)</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :         return true;</span>
<span class="lineNum">     713 </span>            :       // else fall through and return false
<span class="lineNum">     714 </span>            :     }
<span class="lineNum">     715 </span>            :   }
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :   return false;</span>
<a name="718"><span class="lineNum">     718 </span>            : } // ExecuteCloseHandler</a>
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span><span class="lineNoCov">          0 : void nsWebShellWindow::ConstrainToOpenerScreen(int32_t* aX, int32_t* aY)</span>
<span class="lineNum">     721 </span>            : {
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :   if (mOpenerScreenRect.IsEmpty()) {</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :     *aX = *aY = 0;</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     725 </span>            :   }
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span>            :   int32_t left, top, width, height;
<span class="lineNum">     728 </span>            :   // Constrain initial positions to the same screen as opener
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIScreenManager&gt; screenmgr = do_GetService(&quot;@mozilla.org/gfx/screenmanager;1&quot;);</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :   if (screenmgr) {</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIScreen&gt; screen;</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     screenmgr-&gt;ScreenForRect(mOpenerScreenRect.x, mOpenerScreenRect.y,</span>
<span class="lineNum">     733 </span>            :                              mOpenerScreenRect.width, mOpenerScreenRect.height,
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :                              getter_AddRefs(screen));</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :     if (screen) {</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :       screen-&gt;GetAvailRectDisplayPix(&amp;left, &amp;top, &amp;width, &amp;height);</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :       if (*aX &lt; left || *aX &gt; left + width) {</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :         *aX = left;</span>
<span class="lineNum">     739 </span>            :       }
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :       if (*aY &lt; top || *aY &gt; top + height) {</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :         *aY = top;</span>
<span class="lineNum">     742 </span>            :       }
<span class="lineNum">     743 </span>            :     }
<span class="lineNum">     744 </span>            :   }
<span class="lineNum">     745 </span>            : }
<a name="746"><span class="lineNum">     746 </span>            : </a>
<span class="lineNum">     747 </span>            : // nsIBaseWindow
<span class="lineNum">     748 </span><span class="lineNoCov">          0 : NS_IMETHODIMP nsWebShellWindow::Destroy()</span>
<span class="lineNum">     749 </span>            : {
<span class="lineNum">     750 </span>            :   nsresult rv;
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_GetInterface(mDocShell, &amp;rv));</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :   if (webProgress) {</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :     webProgress-&gt;RemoveProgressListener(this);</span>
<span class="lineNum">     754 </span>            :   }
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIXULWindow&gt; kungFuDeathGrip(this);</span>
<span class="lineNum">     757 </span>            :   {
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :     MutexAutoLock lock(mSPTimerLock);</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :     if (mSPTimer) {</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :       mSPTimer-&gt;Cancel();</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :       SavePersistentAttributes();</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :       mSPTimer = nullptr;</span>
<span class="lineNum">     763 </span>            :     }
<span class="lineNum">     764 </span>            :   }
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :   return nsXULWindow::Destroy();</span>
<span class="lineNum">     766 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

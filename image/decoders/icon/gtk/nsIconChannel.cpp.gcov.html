<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - image/decoders/icon/gtk/nsIconChannel.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">image/decoders/icon/gtk</a> - nsIconChannel.cpp<span style="font-size: 80%;"> (source / <a href="nsIconChannel.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">194</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">11</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* vim:set ts=2 sw=2 sts=2 cin et: */</a>
<span class="lineNum">       2 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #include &quot;nsIconChannel.h&quot;
<span class="lineNum">       7 </span>            : 
<span class="lineNum">       8 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">       9 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &quot;mozilla/DebugOnly.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;mozilla/EndianUtils.h&quot;
<span class="lineNum">      13 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #include &lt;gio/gio.h&gt;
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : #include &lt;gtk/gtk.h&gt;
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #include &quot;nsMimeTypes.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsIMIMEService.h&quot;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #include &quot;nsServiceManagerUtils.h&quot;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &quot;nsNetUtil.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsComponentManagerUtils.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;nsIStringStream.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;nsServiceManagerUtils.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;NullPrincipal.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;nsIURL.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;prlink.h&quot;
<a name="31"><span class="lineNum">      31 </span>            : #include &quot;gfxPlatform.h&quot;</a>
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span><span class="lineNoCov">          0 : NS_IMPL_ISUPPORTS(nsIconChannel,</span>
<span class="lineNum">      34 </span>            :                   nsIRequest,
<span class="lineNum">      35 </span>            :                   nsIChannel)
<a name="36"><span class="lineNum">      36 </span>            : </a>
<span class="lineNum">      37 </span>            : static nsresult
<span class="lineNum">      38 </span><span class="lineNoCov">          0 : moz_gdk_pixbuf_to_channel(GdkPixbuf* aPixbuf, nsIURI* aURI,</span>
<span class="lineNum">      39 </span>            :                           nsIChannel** aChannel)
<span class="lineNum">      40 </span>            : {
<span class="lineNum">      41 </span><span class="lineNoCov">          0 :   int width = gdk_pixbuf_get_width(aPixbuf);</span>
<span class="lineNum">      42 </span><span class="lineNoCov">          0 :   int height = gdk_pixbuf_get_height(aPixbuf);</span>
<span class="lineNum">      43 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(height &lt; 256 &amp;&amp; width &lt; 256 &amp;&amp; height &gt; 0 &amp;&amp; width &gt; 0 &amp;&amp;</span>
<span class="lineNum">      44 </span>            :                  gdk_pixbuf_get_colorspace(aPixbuf) == GDK_COLORSPACE_RGB &amp;&amp;
<span class="lineNum">      45 </span>            :                  gdk_pixbuf_get_bits_per_sample(aPixbuf) == 8 &amp;&amp;
<span class="lineNum">      46 </span>            :                  gdk_pixbuf_get_has_alpha(aPixbuf) &amp;&amp;
<span class="lineNum">      47 </span>            :                  gdk_pixbuf_get_n_channels(aPixbuf) == 4,
<span class="lineNum">      48 </span>            :                  NS_ERROR_UNEXPECTED);
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :   const int n_channels = 4;</span>
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   gsize buf_size = 2 + n_channels * height * width;</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   uint8_t* const buf = (uint8_t*)moz_xmalloc(buf_size);</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(buf, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :   uint8_t* out = buf;</span>
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :   *(out++) = width;</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :   *(out++) = height;</span>
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :   const guchar* const pixels = gdk_pixbuf_get_pixels(aPixbuf);</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :   int rowextra = gdk_pixbuf_get_rowstride(aPixbuf) - width * n_channels;</span>
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            :   // encode the RGB data and the A data
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :   const guchar* in = pixels;</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :   for (int y = 0; y &lt; height; ++y, in += rowextra) {</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :     for (int x = 0; x &lt; width; ++x) {</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :       uint8_t r = *(in++);</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :       uint8_t g = *(in++);</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :       uint8_t b = *(in++);</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :       uint8_t a = *(in++);</span>
<span class="lineNum">      70 </span>            : #define DO_PREMULTIPLY(c_) uint8_t(uint16_t(c_) * uint16_t(a) / uint16_t(255))
<span class="lineNum">      71 </span>            : #if MOZ_LITTLE_ENDIAN
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :       *(out++) = DO_PREMULTIPLY(b);</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :       *(out++) = DO_PREMULTIPLY(g);</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :       *(out++) = DO_PREMULTIPLY(r);</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :       *(out++) = a;</span>
<span class="lineNum">      76 </span>            : #else
<span class="lineNum">      77 </span>            :       *(out++) = a;
<span class="lineNum">      78 </span>            :       *(out++) = DO_PREMULTIPLY(r);
<span class="lineNum">      79 </span>            :       *(out++) = DO_PREMULTIPLY(g);
<span class="lineNum">      80 </span>            :       *(out++) = DO_PREMULTIPLY(b);
<span class="lineNum">      81 </span>            : #endif
<span class="lineNum">      82 </span>            : #undef DO_PREMULTIPLY
<span class="lineNum">      83 </span>            :     }
<span class="lineNum">      84 </span>            :   }
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :   NS_ASSERTION(out == buf + buf_size, &quot;size miscalculation&quot;);</span>
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            :   nsresult rv;
<span class="lineNum">      89 </span>            :   nsCOMPtr&lt;nsIStringInputStream&gt; stream =
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :     do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv);</span>
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span>            :   // Prevent the leaking of buf
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :     free(buf);</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">      96 </span>            :   }
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            :   // stream takes ownership of buf and will free it on destruction.
<span class="lineNum">      99 </span>            :   // This function cannot fail.
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   rv = stream-&gt;AdoptData((char*)buf, buf_size);</span>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            :   // If this no longer holds then re-examine buf's lifetime.
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(NS_SUCCEEDED(rv));</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :   // nsIconProtocolHandler::NewChannel2 will provide the correct loadInfo for
<span class="lineNum">     107 </span>            :   // this iconChannel. Use the most restrictive security settings for the
<span class="lineNum">     108 </span>            :   // temporary loadInfo to make sure the channel can not be openend.
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal = NullPrincipal::Create();</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :   return NS_NewInputStreamChannel(aChannel,</span>
<span class="lineNum">     111 </span>            :                                   aURI,
<span class="lineNum">     112 </span>            :                                   stream,
<span class="lineNum">     113 </span>            :                                   nullPrincipal,
<span class="lineNum">     114 </span>            :                                   nsILoadInfo::SEC_REQUIRE_SAME_ORIGIN_DATA_IS_BLOCKED,
<span class="lineNum">     115 </span>            :                                   nsIContentPolicy::TYPE_INTERNAL_IMAGE,
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                                   NS_LITERAL_CSTRING(IMAGE_ICON_MS));</span>
<span class="lineNum">     117 </span>            : }
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span>            : static GtkWidget* gProtoWindow = nullptr;
<span class="lineNum">     120 </span>            : static GtkWidget* gStockImageWidget = nullptr;
<a name="121"><span class="lineNum">     121 </span>            : </a>
<span class="lineNum">     122 </span>            : static void
<span class="lineNum">     123 </span><span class="lineNoCov">          0 : ensure_stock_image_widget()</span>
<span class="lineNum">     124 </span>            : {
<span class="lineNum">     125 </span>            :   // Only the style of the GtkImage needs to be used, but the widget is kept
<span class="lineNum">     126 </span>            :   // to track dynamic style changes.
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   if (!gProtoWindow) {</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     gProtoWindow = gtk_window_new(GTK_WINDOW_POPUP);</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     GtkWidget* protoLayout = gtk_fixed_new();</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :     gtk_container_add(GTK_CONTAINER(gProtoWindow), protoLayout);</span>
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     gStockImageWidget = gtk_image_new();</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     gtk_container_add(GTK_CONTAINER(protoLayout), gStockImageWidget);</span>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :     gtk_widget_ensure_style(gStockImageWidget);</span>
<span class="lineNum">     136 </span>            :   }
<span class="lineNum">     137 </span><span class="lineNoCov">          0 : }</span>
<a name="138"><span class="lineNum">     138 </span>            : </a>
<span class="lineNum">     139 </span>            : static GtkIconSize
<span class="lineNum">     140 </span><span class="lineNoCov">          0 : moz_gtk_icon_size(const char* name)</span>
<span class="lineNum">     141 </span>            : {
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :   if (strcmp(name, &quot;button&quot;) == 0) {</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :     return GTK_ICON_SIZE_BUTTON;</span>
<span class="lineNum">     144 </span>            :   }
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   if (strcmp(name, &quot;menu&quot;) == 0) {</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     return GTK_ICON_SIZE_MENU;</span>
<span class="lineNum">     148 </span>            :   }
<span class="lineNum">     149 </span>            : 
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   if (strcmp(name, &quot;toolbar&quot;) == 0) {</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :     return GTK_ICON_SIZE_LARGE_TOOLBAR;</span>
<span class="lineNum">     152 </span>            :   }
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   if (strcmp(name, &quot;toolbarsmall&quot;) == 0) {</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :     return GTK_ICON_SIZE_SMALL_TOOLBAR;</span>
<span class="lineNum">     156 </span>            :   }
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   if (strcmp(name, &quot;dnd&quot;) == 0) {</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :     return GTK_ICON_SIZE_DND;</span>
<span class="lineNum">     160 </span>            :   }
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   if (strcmp(name, &quot;dialog&quot;) == 0) {</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :     return GTK_ICON_SIZE_DIALOG;</span>
<span class="lineNum">     164 </span>            :   }
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :   return GTK_ICON_SIZE_MENU;</span>
<span class="lineNum">     167 </span>            : }
<a name="168"><span class="lineNum">     168 </span>            : </a>
<span class="lineNum">     169 </span>            : static int32_t
<span class="lineNum">     170 </span><span class="lineNoCov">          0 : GetIconSize(nsIMozIconURI* aIconURI)</span>
<span class="lineNum">     171 </span>            : {
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :   nsAutoCString iconSizeString;</span>
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   aIconURI-&gt;GetIconSize(iconSizeString);</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :   if (iconSizeString.IsEmpty()) {</span>
<span class="lineNum">     176 </span>            :     uint32_t size;
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     mozilla::DebugOnly&lt;nsresult&gt; rv = aIconURI-&gt;GetImageSize(&amp;size);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetImageSize failed&quot;);</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     return size;</span>
<span class="lineNum">     180 </span>            :   }
<span class="lineNum">     181 </span>            :   int size;
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   GtkIconSize icon_size = moz_gtk_icon_size(iconSizeString.get());</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   gtk_icon_size_lookup(icon_size, &amp;size, nullptr);</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   return size;</span>
<span class="lineNum">     186 </span>            : }
<span class="lineNum">     187 </span>            : 
<a name="188"><span class="lineNum">     188 </span>            : /* Scale icon buffer to preferred size */</a>
<span class="lineNum">     189 </span>            : static nsresult
<span class="lineNum">     190 </span><span class="lineNoCov">          0 : ScaleIconBuf(GdkPixbuf** aBuf, int32_t iconSize)</span>
<span class="lineNum">     191 </span>            : {
<span class="lineNum">     192 </span>            :   // Scale buffer only if width or height differ from preferred size
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :   if (gdk_pixbuf_get_width(*aBuf)  != iconSize &amp;&amp;</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :       gdk_pixbuf_get_height(*aBuf) != iconSize) {</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :     GdkPixbuf* scaled = gdk_pixbuf_scale_simple(*aBuf, iconSize, iconSize,</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                                                 GDK_INTERP_BILINEAR);</span>
<span class="lineNum">     197 </span>            :     // replace original buffer by scaled
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     g_object_unref(*aBuf);</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     *aBuf = scaled;</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     if (!scaled) {</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :       return NS_ERROR_OUT_OF_MEMORY;</span>
<span class="lineNum">     202 </span>            :     }
<span class="lineNum">     203 </span>            :   }
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     205 </span>            : }
<a name="206"><span class="lineNum">     206 </span>            : </a>
<span class="lineNum">     207 </span>            : nsresult
<span class="lineNum">     208 </span><span class="lineNoCov">          0 : nsIconChannel::InitWithGIO(nsIMozIconURI* aIconURI)</span>
<span class="lineNum">     209 </span>            : {
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :   GIcon *icon = nullptr;</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURL&gt; fileURI;</span>
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span>            :   // Read icon content
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :   aIconURI-&gt;GetIconURL(getter_AddRefs(fileURI));</span>
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span>            :   // Get icon for file specified by URI
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :   if (fileURI) {</span>
<span class="lineNum">     218 </span>            :     bool isFile;
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :     nsAutoCString spec;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :     fileURI-&gt;GetAsciiSpec(spec);</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :     if (NS_SUCCEEDED(fileURI-&gt;SchemeIs(&quot;file&quot;, &amp;isFile)) &amp;&amp; isFile) {</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :       GFile* file = g_file_new_for_uri(spec.get());</span>
<span class="lineNum">     223 </span>            :       GFileInfo* fileInfo = g_file_query_info(file,
<span class="lineNum">     224 </span>            :                                               G_FILE_ATTRIBUTE_STANDARD_ICON,
<span class="lineNum">     225 </span>            :                                               G_FILE_QUERY_INFO_NONE,
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                                               nullptr, nullptr);</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :       g_object_unref(file);</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :       if (fileInfo) {</span>
<span class="lineNum">     229 </span>            :         // icon from g_content_type_get_icon doesn't need unref
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :         icon = g_file_info_get_icon(fileInfo);</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :         if (icon) {</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :           g_object_ref(icon);</span>
<span class="lineNum">     233 </span>            :         }
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :         g_object_unref(fileInfo);</span>
<span class="lineNum">     235 </span>            :       }
<span class="lineNum">     236 </span>            :     }
<span class="lineNum">     237 </span>            :   }
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span>            :   // Try to get icon by using MIME type
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :   if (!icon) {</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     nsAutoCString type;</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     aIconURI-&gt;GetContentType(type);</span>
<span class="lineNum">     243 </span>            :     // Try to get MIME type from file extension by using nsIMIMEService
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :     if (type.IsEmpty()) {</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :       nsCOMPtr&lt;nsIMIMEService&gt; ms(do_GetService(&quot;@mozilla.org/mime;1&quot;));</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :       if (ms) {</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :         nsAutoCString fileExt;</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :         aIconURI-&gt;GetFileExtension(fileExt);</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :         ms-&gt;GetTypeFromExtension(fileExt, type);</span>
<span class="lineNum">     250 </span>            :       }
<span class="lineNum">     251 </span>            :     }
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     char* ctype = nullptr; // character representation of content type</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :     if (!type.IsEmpty()) {</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :       ctype = g_content_type_from_mime_type(type.get());</span>
<span class="lineNum">     255 </span>            :     }
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :     if (ctype) {</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :       icon = g_content_type_get_icon(ctype);</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :       g_free(ctype);</span>
<span class="lineNum">     259 </span>            :     }
<span class="lineNum">     260 </span>            :   }
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span>            :   // Get default icon theme
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :   GtkIconTheme* iconTheme = gtk_icon_theme_get_default();</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   GtkIconInfo* iconInfo = nullptr;</span>
<span class="lineNum">     265 </span>            :   // Get icon size
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :   int32_t iconSize = GetIconSize(aIconURI);</span>
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :   if (icon) {</span>
<span class="lineNum">     269 </span>            :     // Use icon and theme to get GtkIconInfo
<span class="lineNum">     270 </span>            :     iconInfo = gtk_icon_theme_lookup_by_gicon(iconTheme,
<span class="lineNum">     271 </span>            :                                               icon, iconSize,
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :                                               (GtkIconLookupFlags)0);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     g_object_unref(icon);</span>
<span class="lineNum">     274 </span>            :   }
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   if (!iconInfo) {</span>
<span class="lineNum">     277 </span>            :     // Mozilla's mimetype lookup failed. Try the &quot;unknown&quot; icon.
<span class="lineNum">     278 </span>            :     iconInfo = gtk_icon_theme_lookup_icon(iconTheme,
<span class="lineNum">     279 </span>            :                                           &quot;unknown&quot;, iconSize,
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :                                           (GtkIconLookupFlags)0);</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     if (!iconInfo) {</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :       return NS_ERROR_NOT_AVAILABLE;</span>
<span class="lineNum">     283 </span>            :     }
<span class="lineNum">     284 </span>            :   }
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            :   // Create a GdkPixbuf buffer containing icon and scale it
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :   GdkPixbuf* buf = gtk_icon_info_load_icon(iconInfo, nullptr);</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   gtk_icon_info_free(iconInfo);</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   if (!buf) {</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     return NS_ERROR_UNEXPECTED;</span>
<span class="lineNum">     291 </span>            :   }
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :   nsresult rv = ScaleIconBuf(&amp;buf, iconSize);</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :   rv = moz_gdk_pixbuf_to_channel(buf, aIconURI,</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :                                  getter_AddRefs(mRealChannel));</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :   g_object_unref(buf);</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">     300 </span>            : }
<a name="301"><span class="lineNum">     301 </span>            : </a>
<span class="lineNum">     302 </span>            : nsresult
<span class="lineNum">     303 </span><span class="lineNoCov">          0 : nsIconChannel::Init(nsIURI* aURI)</span>
<span class="lineNum">     304 </span>            : {
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIMozIconURI&gt; iconURI = do_QueryInterface(aURI);</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :   NS_ASSERTION(iconURI, &quot;URI is not an nsIMozIconURI&quot;);</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :   if (gfxPlatform::IsHeadless()) {</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :     return NS_ERROR_NOT_AVAILABLE;</span>
<span class="lineNum">     310 </span>            :   }
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :   nsAutoCString stockIcon;</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   iconURI-&gt;GetStockIcon(stockIcon);</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :   if (stockIcon.IsEmpty()) {</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     return InitWithGIO(iconURI);</span>
<span class="lineNum">     316 </span>            :   }
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span>            :   // Search for stockIcon
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :   nsAutoCString iconSizeString;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :   iconURI-&gt;GetIconSize(iconSizeString);</span>
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :   nsAutoCString iconStateString;</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   iconURI-&gt;GetIconState(iconStateString);</span>
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :   GtkIconSize icon_size = moz_gtk_icon_size(iconSizeString.get());</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   GtkStateType state = iconStateString.EqualsLiteral(&quot;disabled&quot;) ?</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     GTK_STATE_INSENSITIVE : GTK_STATE_NORMAL;</span>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            :   // First lookup the icon by stock id and text direction.
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :   GtkTextDirection direction = GTK_TEXT_DIR_NONE;</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   if (StringEndsWith(stockIcon, NS_LITERAL_CSTRING(&quot;-ltr&quot;))) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     direction = GTK_TEXT_DIR_LTR;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   } else if (StringEndsWith(stockIcon, NS_LITERAL_CSTRING(&quot;-rtl&quot;))) {</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     direction = GTK_TEXT_DIR_RTL;</span>
<span class="lineNum">     335 </span>            :   }
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :   bool forceDirection = direction != GTK_TEXT_DIR_NONE;</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :   nsAutoCString stockID;</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :   bool useIconName = false;</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :   if (!forceDirection) {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :     direction = gtk_widget_get_default_direction();</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     stockID = stockIcon;</span>
<span class="lineNum">     343 </span>            :   } else {
<span class="lineNum">     344 </span>            :     // GTK versions &lt; 2.22 use icon names from concatenating stock id with
<span class="lineNum">     345 </span>            :     // -(rtl|ltr), which is how the moz-icon stock name is interpreted here.
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     stockID = Substring(stockIcon, 0, stockIcon.Length() - 4);</span>
<span class="lineNum">     347 </span>            :     // However, if we lookup bidi icons by the stock name, then GTK versions
<span class="lineNum">     348 </span>            :     // &gt;= 2.22 will use a bidi lookup convention that most icon themes do not
<span class="lineNum">     349 </span>            :     // yet follow.  Therefore, we first check to see if the theme supports the
<span class="lineNum">     350 </span>            :     // old icon name as this will have bidi support (if found).
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     GtkIconTheme* icon_theme = gtk_icon_theme_get_default();</span>
<span class="lineNum">     352 </span>            :     // Micking what gtk_icon_set_render_icon does with sizes, though it's not
<span class="lineNum">     353 </span>            :     // critical as icons will be scaled to suit size.  It just means we follow
<span class="lineNum">     354 </span>            :     // the same pathes and so share caches.
<span class="lineNum">     355 </span>            :     gint width, height;
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :     if (gtk_icon_size_lookup(icon_size, &amp;width, &amp;height)) {</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :       gint size = std::min(width, height);</span>
<span class="lineNum">     358 </span>            :       // We use gtk_icon_theme_lookup_icon() without
<span class="lineNum">     359 </span>            :       // GTK_ICON_LOOKUP_USE_BUILTIN instead of gtk_icon_theme_has_icon() so
<span class="lineNum">     360 </span>            :       // we don't pick up fallback icons added by distributions for backward
<span class="lineNum">     361 </span>            :       // compatibility.
<span class="lineNum">     362 </span>            :       GtkIconInfo* icon =
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :         gtk_icon_theme_lookup_icon(icon_theme, stockIcon.get(),</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                                    size, (GtkIconLookupFlags)0);</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :       if (icon) {</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         useIconName = true;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :         gtk_icon_info_free(icon);</span>
<span class="lineNum">     368 </span>            :       }
<span class="lineNum">     369 </span>            :     }
<span class="lineNum">     370 </span>            :   }
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :   ensure_stock_image_widget();</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   GtkStyle* style = gtk_widget_get_style(gStockImageWidget);</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :   GtkIconSet* icon_set = nullptr;</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :   if (!useIconName) {</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     icon_set = gtk_style_lookup_icon_set(style, stockID.get());</span>
<span class="lineNum">     377 </span>            :   }
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :   if (!icon_set) {</span>
<span class="lineNum">     380 </span>            :     // Either we have choosen icon-name lookup for a bidi icon, or stockIcon is
<span class="lineNum">     381 </span>            :     // not a stock id so we assume it is an icon name.
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     useIconName = true;</span>
<span class="lineNum">     383 </span>            :     // Creating a GtkIconSet is a convenient way to allow the style to
<span class="lineNum">     384 </span>            :     // render the icon, possibly with variations suitable for insensitive
<span class="lineNum">     385 </span>            :     // states.
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     icon_set = gtk_icon_set_new();</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     GtkIconSource* icon_source = gtk_icon_source_new();</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     gtk_icon_source_set_icon_name(icon_source, stockIcon.get());</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :     gtk_icon_set_add_source(icon_set, icon_source);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     gtk_icon_source_free(icon_source);</span>
<span class="lineNum">     392 </span>            :   }
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span>            :   GdkPixbuf* icon =
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     gtk_icon_set_render_icon(icon_set, style, direction, state,</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                              icon_size, gStockImageWidget, nullptr);</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :   if (useIconName) {</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     gtk_icon_set_unref(icon_set);</span>
<span class="lineNum">     399 </span>            :   }
<span class="lineNum">     400 </span>            : 
<span class="lineNum">     401 </span>            :   // According to documentation, gtk_icon_set_render_icon() never returns
<span class="lineNum">     402 </span>            :   // nullptr, but it does return nullptr when we have the problem reported
<span class="lineNum">     403 </span>            :   // here: https://bugzilla.gnome.org/show_bug.cgi?id=629878#c13
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :   if (!icon) {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :     return NS_ERROR_NOT_AVAILABLE;</span>
<span class="lineNum">     406 </span>            :   }
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   nsresult rv = moz_gdk_pixbuf_to_channel(icon, iconURI,</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :                                           getter_AddRefs(mRealChannel));</span>
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :   g_object_unref(icon);</span>
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">     414 </span>            : }
<a name="415"><span class="lineNum">     415 </span>            : </a>
<span class="lineNum">     416 </span>            : void
<span class="lineNum">     417 </span><span class="lineNoCov">          0 : nsIconChannel::Shutdown() {</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :   if (gProtoWindow) {</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     gtk_widget_destroy(gProtoWindow);</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     gProtoWindow = nullptr;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     gStockImageWidget = nullptr;</span>
<span class="lineNum">     422 </span>            :   }
<span class="lineNum">     423 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - layout/base/RestyleManager.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">layout/base</a> - RestyleManager.cpp<span style="font-size: 80%;"> (source / <a href="RestyleManager.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">327</td>
            <td class="headerCovTableEntry">827</td>
            <td class="headerCovTableEntryLo">39.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">26</td>
            <td class="headerCovTableEntry">36</td>
            <td class="headerCovTableEntryLo">72.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=8 sts=2 et sw=2 tw=80: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &quot;mozilla/RestyleManager.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;mozilla/RestyleManagerInlines.h&quot;
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : #include &quot;Layers.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;LayerAnimationInfo.h&quot; // For LayerAnimationInfo::sRecords
<span class="lineNum">      12 </span>            : #include &quot;mozilla/StyleSetHandleInlines.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsIFrame.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsIPresShellInlines.h&quot;
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : 
<a name="17"><span class="lineNum">      17 </span>            : namespace mozilla {</a>
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span><span class="lineCov">         28 : RestyleManager::RestyleManager(StyleBackendType aType,</span>
<span class="lineNum">      20 </span><span class="lineCov">         28 :                                nsPresContext* aPresContext)</span>
<span class="lineNum">      21 </span>            :   : mPresContext(aPresContext)
<span class="lineNum">      22 </span>            :   , mRestyleGeneration(1)
<span class="lineNum">      23 </span>            :   , mUndisplayedRestyleGeneration(1)
<span class="lineNum">      24 </span>            :   , mHoverGeneration(0)
<span class="lineNum">      25 </span>            :   , mType(aType)
<span class="lineNum">      26 </span>            :   , mInStyleRefresh(false)
<span class="lineNum">      27 </span><span class="lineCov">         28 :   , mAnimationGeneration(0)</span>
<span class="lineNum">      28 </span>            : {
<span class="lineNum">      29 </span><span class="lineCov">         28 :   MOZ_ASSERT(mPresContext);</span>
<span class="lineNum">      30 </span><span class="lineCov">         28 : }</span>
<a name="31"><span class="lineNum">      31 </span>            : </a>
<span class="lineNum">      32 </span>            : void
<span class="lineNum">      33 </span><span class="lineCov">         19 : RestyleManager::ContentInserted(nsINode* aContainer, nsIContent* aChild)</span>
<span class="lineNum">      34 </span>            : {
<span class="lineNum">      35 </span><span class="lineCov">         19 :   RestyleForInsertOrChange(aContainer, aChild);</span>
<span class="lineNum">      36 </span><span class="lineCov">         19 : }</span>
<a name="37"><span class="lineNum">      37 </span>            : </a>
<span class="lineNum">      38 </span>            : void
<span class="lineNum">      39 </span><span class="lineCov">         56 : RestyleManager::ContentAppended(nsIContent* aContainer, nsIContent* aFirstNewContent)</span>
<span class="lineNum">      40 </span>            : {
<span class="lineNum">      41 </span><span class="lineCov">         56 :   RestyleForAppend(aContainer, aFirstNewContent);</span>
<span class="lineNum">      42 </span><span class="lineCov">         56 : }</span>
<a name="43"><span class="lineNum">      43 </span>            : </a>
<span class="lineNum">      44 </span>            : void
<span class="lineNum">      45 </span><span class="lineNoCov">          0 : RestyleManager::RestyleForEmptyChange(Element* aContainer)</span>
<span class="lineNum">      46 </span>            : {
<span class="lineNum">      47 </span>            :   // In some cases (:empty + E, :empty ~ E), a change in the content of
<span class="lineNum">      48 </span>            :   // an element requires restyling its parent's siblings.
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :   nsRestyleHint hint = eRestyle_Subtree;</span>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :   nsIContent* grandparent = aContainer-&gt;GetParent();</span>
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   if (grandparent &amp;&amp;</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :       (grandparent-&gt;GetFlags() &amp; NODE_HAS_SLOW_SELECTOR_LATER_SIBLINGS)) {</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :     hint = nsRestyleHint(hint | eRestyle_LaterSiblings);</span>
<span class="lineNum">      54 </span>            :   }
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :   PostRestyleEvent(aContainer, hint, nsChangeHint(0));</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 : }</span>
<a name="57"><span class="lineNum">      57 </span>            : </a>
<span class="lineNum">      58 </span>            : void
<span class="lineNum">      59 </span><span class="lineCov">         56 : RestyleManager::RestyleForAppend(nsIContent* aContainer,</span>
<span class="lineNum">      60 </span>            :                                  nsIContent* aFirstNewContent)
<span class="lineNum">      61 </span>            : {
<span class="lineNum">      62 </span>            :   // The container cannot be a document, but might be a ShadowRoot.
<span class="lineNum">      63 </span><span class="lineCov">         56 :   if (!aContainer-&gt;IsElement()) {</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">      65 </span>            :   }
<span class="lineNum">      66 </span><span class="lineCov">         56 :   Element* container = aContainer-&gt;AsElement();</span>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : #ifdef DEBUG
<span class="lineNum">      69 </span>            :   {
<span class="lineNum">      70 </span><span class="lineCov">        213 :     for (nsIContent* cur = aFirstNewContent; cur; cur = cur-&gt;GetNextSibling()) {</span>
<span class="lineNum">      71 </span><span class="lineCov">        157 :       NS_ASSERTION(!cur-&gt;IsRootOfAnonymousSubtree(),</span>
<span class="lineNum">      72 </span>            :                    &quot;anonymous nodes should not be in child lists&quot;);
<span class="lineNum">      73 </span>            :     }
<span class="lineNum">      74 </span>            :   }
<span class="lineNum">      75 </span>            : #endif
<span class="lineNum">      76 </span>            :   uint32_t selectorFlags =
<span class="lineNum">      77 </span><span class="lineCov">         56 :     container-&gt;GetFlags() &amp; (NODE_ALL_SELECTOR_FLAGS &amp;</span>
<span class="lineNum">      78 </span><span class="lineCov">         56 :                              ~NODE_HAS_SLOW_SELECTOR_LATER_SIBLINGS);</span>
<span class="lineNum">      79 </span><span class="lineCov">         56 :   if (selectorFlags == 0)</span>
<span class="lineNum">      80 </span><span class="lineCov">         56 :     return;</span>
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :   if (selectorFlags &amp; NODE_HAS_EMPTY_SELECTOR) {</span>
<span class="lineNum">      83 </span>            :     // see whether we need to restyle the container
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :     bool wasEmpty = true; // :empty or :-moz-only-whitespace</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :     for (nsIContent* cur = container-&gt;GetFirstChild();</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :          cur != aFirstNewContent;</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :          cur = cur-&gt;GetNextSibling()) {</span>
<span class="lineNum">      88 </span>            :       // We don't know whether we're testing :empty or :-moz-only-whitespace,
<span class="lineNum">      89 </span>            :       // so be conservative and assume :-moz-only-whitespace (i.e., make
<span class="lineNum">      90 </span>            :       // IsSignificantChild less likely to be true, and thus make us more
<span class="lineNum">      91 </span>            :       // likely to restyle).
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :       if (nsStyleUtil::IsSignificantChild(cur, true, false)) {</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :         wasEmpty = false;</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">      95 </span>            :       }
<span class="lineNum">      96 </span>            :     }
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :     if (wasEmpty) {</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :       RestyleForEmptyChange(container);</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     100 </span>            :     }
<span class="lineNum">     101 </span>            :   }
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :   if (selectorFlags &amp; NODE_HAS_SLOW_SELECTOR) {</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :     PostRestyleEvent(container, eRestyle_Subtree, nsChangeHint(0));</span>
<span class="lineNum">     105 </span>            :     // Restyling the container is the most we can do here, so we're done.
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     107 </span>            :   }
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :   if (selectorFlags &amp; NODE_HAS_EDGE_CHILD_SELECTOR) {</span>
<span class="lineNum">     110 </span>            :     // restyle the last element child before this node
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :     for (nsIContent* cur = aFirstNewContent-&gt;GetPreviousSibling();</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :          cur;</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :          cur = cur-&gt;GetPreviousSibling()) {</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :       if (cur-&gt;IsElement()) {</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :         PostRestyleEvent(cur-&gt;AsElement(), eRestyle_Subtree, nsChangeHint(0));</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     117 </span>            :       }
<span class="lineNum">     118 </span>            :     }
<span class="lineNum">     119 </span>            :   }
<span class="lineNum">     120 </span>            : }
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            : // Needed since we can't use PostRestyleEvent on non-elements (with
<span class="lineNum">     123 </span>            : // eRestyle_LaterSiblings or nsRestyleHint(eRestyle_Subtree |
<a name="124"><span class="lineNum">     124 </span>            : // eRestyle_LaterSiblings) as appropriate).</a>
<span class="lineNum">     125 </span>            : static void
<span class="lineNum">     126 </span><span class="lineCov">          6 : RestyleSiblingsStartingWith(RestyleManager* aRestyleManager,</span>
<span class="lineNum">     127 </span>            :                             nsIContent* aStartingSibling /* may be null */)
<span class="lineNum">     128 </span>            : {
<span class="lineNum">     129 </span><span class="lineCov">          6 :   for (nsIContent* sibling = aStartingSibling; sibling;</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :        sibling = sibling-&gt;GetNextSibling()) {</span>
<span class="lineNum">     131 </span><span class="lineCov">          5 :     if (sibling-&gt;IsElement()) {</span>
<span class="lineNum">     132 </span>            :       aRestyleManager-&gt;
<span class="lineNum">     133 </span><span class="lineCov">          5 :         PostRestyleEvent(sibling-&gt;AsElement(),</span>
<span class="lineNum">     134 </span>            :                          nsRestyleHint(eRestyle_Subtree | eRestyle_LaterSiblings),
<span class="lineNum">     135 </span><span class="lineCov">          5 :                          nsChangeHint(0));</span>
<span class="lineNum">     136 </span><span class="lineCov">          5 :       break;</span>
<span class="lineNum">     137 </span>            :     }
<span class="lineNum">     138 </span>            :   }
<span class="lineNum">     139 </span><span class="lineCov">          6 : }</span>
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            : // Restyling for a ContentInserted or CharacterDataChanged notification.
<span class="lineNum">     142 </span>            : // This could be used for ContentRemoved as well if we got the
<span class="lineNum">     143 </span>            : // notification before the removal happened (and sometimes
<span class="lineNum">     144 </span>            : // CharacterDataChanged is more like a removal than an addition).
<span class="lineNum">     145 </span>            : // The comments are written and variables are named in terms of it being
<a name="146"><span class="lineNum">     146 </span>            : // a ContentInserted notification.</a>
<span class="lineNum">     147 </span>            : void
<span class="lineNum">     148 </span><span class="lineCov">         19 : RestyleManager::RestyleForInsertOrChange(nsINode* aContainer,</span>
<span class="lineNum">     149 </span>            :                                          nsIContent* aChild)
<span class="lineNum">     150 </span>            : {
<span class="lineNum">     151 </span>            :   // The container might be a document or a ShadowRoot.
<span class="lineNum">     152 </span><span class="lineCov">         19 :   if (!aContainer-&gt;IsElement()) {</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     154 </span>            :   }
<span class="lineNum">     155 </span><span class="lineCov">         19 :   Element* container = aContainer-&gt;AsElement();</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineCov">         19 :   NS_ASSERTION(!aChild-&gt;IsRootOfAnonymousSubtree(),</span>
<span class="lineNum">     158 </span>            :                &quot;anonymous nodes should not be in child lists&quot;);
<span class="lineNum">     159 </span><span class="lineCov">         19 :   uint32_t selectorFlags = container-&gt;GetFlags() &amp; NODE_ALL_SELECTOR_FLAGS;</span>
<span class="lineNum">     160 </span><span class="lineCov">         19 :   if (selectorFlags == 0)</span>
<span class="lineNum">     161 </span><span class="lineCov">         14 :     return;</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineCov">          5 :   if (selectorFlags &amp; NODE_HAS_EMPTY_SELECTOR) {</span>
<span class="lineNum">     164 </span>            :     // see whether we need to restyle the container
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     bool wasEmpty = true; // :empty or :-moz-only-whitespace</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :     for (nsIContent* child = container-&gt;GetFirstChild();</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :          child;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :          child = child-&gt;GetNextSibling()) {</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :       if (child == aChild)</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     171 </span>            :       // We don't know whether we're testing :empty or :-moz-only-whitespace,
<span class="lineNum">     172 </span>            :       // so be conservative and assume :-moz-only-whitespace (i.e., make
<span class="lineNum">     173 </span>            :       // IsSignificantChild less likely to be true, and thus make us more
<span class="lineNum">     174 </span>            :       // likely to restyle).
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :       if (nsStyleUtil::IsSignificantChild(child, true, false)) {</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :         wasEmpty = false;</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     178 </span>            :       }
<span class="lineNum">     179 </span>            :     }
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :     if (wasEmpty) {</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :       RestyleForEmptyChange(container);</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     183 </span>            :     }
<span class="lineNum">     184 </span>            :   }
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span><span class="lineCov">          5 :   if (selectorFlags &amp; NODE_HAS_SLOW_SELECTOR) {</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :     PostRestyleEvent(container, eRestyle_Subtree, nsChangeHint(0));</span>
<span class="lineNum">     188 </span>            :     // Restyling the container is the most we can do here, so we're done.
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     190 </span>            :   }
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span><span class="lineCov">          5 :   if (selectorFlags &amp; NODE_HAS_SLOW_SELECTOR_LATER_SIBLINGS) {</span>
<span class="lineNum">     193 </span>            :     // Restyle all later siblings.
<span class="lineNum">     194 </span><span class="lineCov">          5 :     RestyleSiblingsStartingWith(this, aChild-&gt;GetNextSibling());</span>
<span class="lineNum">     195 </span>            :   }
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineCov">          5 :   if (selectorFlags &amp; NODE_HAS_EDGE_CHILD_SELECTOR) {</span>
<span class="lineNum">     198 </span>            :     // restyle the previously-first element child if it is after this node
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     bool passedChild = false;</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     for (nsIContent* content = container-&gt;GetFirstChild();</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :          content;</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :          content = content-&gt;GetNextSibling()) {</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :       if (content == aChild) {</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         passedChild = true;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     206 </span>            :       }
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :       if (content-&gt;IsElement()) {</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :         if (passedChild) {</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :           PostRestyleEvent(content-&gt;AsElement(), eRestyle_Subtree,</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                            nsChangeHint(0));</span>
<span class="lineNum">     211 </span>            :         }
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     213 </span>            :       }
<span class="lineNum">     214 </span>            :     }
<span class="lineNum">     215 </span>            :     // restyle the previously-last element child if it is before this node
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :     passedChild = false;</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :     for (nsIContent* content = container-&gt;GetLastChild();</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :          content;</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :          content = content-&gt;GetPreviousSibling()) {</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :       if (content == aChild) {</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         passedChild = true;</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     223 </span>            :       }
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :       if (content-&gt;IsElement()) {</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :         if (passedChild) {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :           PostRestyleEvent(content-&gt;AsElement(), eRestyle_Subtree,</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                            nsChangeHint(0));</span>
<span class="lineNum">     228 </span>            :         }
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     230 </span>            :       }
<span class="lineNum">     231 </span>            :     }
<span class="lineNum">     232 </span>            :   }
<span class="lineNum">     233 </span>            : }
<a name="234"><span class="lineNum">     234 </span>            : </a>
<span class="lineNum">     235 </span>            : void
<span class="lineNum">     236 </span><span class="lineCov">         11 : RestyleManager::ContentRemoved(nsINode* aContainer,</span>
<span class="lineNum">     237 </span>            :                                nsIContent* aOldChild,
<span class="lineNum">     238 </span>            :                                nsIContent* aFollowingSibling)
<span class="lineNum">     239 </span>            : {
<span class="lineNum">     240 </span>            :   // The container might be a document or a ShadowRoot.
<span class="lineNum">     241 </span><span class="lineCov">         11 :   if (!aContainer-&gt;IsElement()) {</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     243 </span>            :   }
<span class="lineNum">     244 </span><span class="lineCov">         11 :   Element* container = aContainer-&gt;AsElement();</span>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span><span class="lineCov">         11 :   if (aOldChild-&gt;IsRootOfAnonymousSubtree()) {</span>
<span class="lineNum">     247 </span>            :     // This should be an assert, but this is called incorrectly in
<span class="lineNum">     248 </span>            :     // HTMLEditor::DeleteRefToAnonymousNode and the assertions were clogging
<span class="lineNum">     249 </span>            :     // up the logs.  Make it an assert again when that's fixed.
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(aOldChild-&gt;GetProperty(nsGkAtoms::restylableAnonymousNode),</span>
<span class="lineNum">     251 </span>            :                &quot;anonymous nodes should not be in child lists (bug 439258)&quot;);
<span class="lineNum">     252 </span>            :   }
<span class="lineNum">     253 </span><span class="lineCov">         11 :   uint32_t selectorFlags = container-&gt;GetFlags() &amp; NODE_ALL_SELECTOR_FLAGS;</span>
<span class="lineNum">     254 </span><span class="lineCov">         11 :   if (selectorFlags == 0)</span>
<span class="lineNum">     255 </span><span class="lineCov">         10 :     return;</span>
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span><span class="lineCov">          1 :   if (selectorFlags &amp; NODE_HAS_EMPTY_SELECTOR) {</span>
<span class="lineNum">     258 </span>            :     // see whether we need to restyle the container
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :     bool isEmpty = true; // :empty or :-moz-only-whitespace</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :     for (nsIContent* child = container-&gt;GetFirstChild();</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :          child;</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :          child = child-&gt;GetNextSibling()) {</span>
<span class="lineNum">     263 </span>            :       // We don't know whether we're testing :empty or :-moz-only-whitespace,
<span class="lineNum">     264 </span>            :       // so be conservative and assume :-moz-only-whitespace (i.e., make
<span class="lineNum">     265 </span>            :       // IsSignificantChild less likely to be true, and thus make us more
<span class="lineNum">     266 </span>            :       // likely to restyle).
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :       if (nsStyleUtil::IsSignificantChild(child, true, false)) {</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :         isEmpty = false;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     270 </span>            :       }
<span class="lineNum">     271 </span>            :     }
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     if (isEmpty) {</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :       RestyleForEmptyChange(container);</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     275 </span>            :     }
<span class="lineNum">     276 </span>            :   }
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span><span class="lineCov">          1 :   if (selectorFlags &amp; NODE_HAS_SLOW_SELECTOR) {</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     PostRestyleEvent(container, eRestyle_Subtree, nsChangeHint(0));</span>
<span class="lineNum">     280 </span>            :     // Restyling the container is the most we can do here, so we're done.
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     282 </span>            :   }
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineCov">          1 :   if (selectorFlags &amp; NODE_HAS_SLOW_SELECTOR_LATER_SIBLINGS) {</span>
<span class="lineNum">     285 </span>            :     // Restyle all later siblings.
<span class="lineNum">     286 </span><span class="lineCov">          1 :     RestyleSiblingsStartingWith(this, aFollowingSibling);</span>
<span class="lineNum">     287 </span>            :   }
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineCov">          1 :   if (selectorFlags &amp; NODE_HAS_EDGE_CHILD_SELECTOR) {</span>
<span class="lineNum">     290 </span>            :     // restyle the now-first element child if it was after aOldChild
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     bool reachedFollowingSibling = false;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     for (nsIContent* content = container-&gt;GetFirstChild();</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :          content;</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :          content = content-&gt;GetNextSibling()) {</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :       if (content == aFollowingSibling) {</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         reachedFollowingSibling = true;</span>
<span class="lineNum">     297 </span>            :         // do NOT continue here; we might want to restyle this node
<span class="lineNum">     298 </span>            :       }
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :       if (content-&gt;IsElement()) {</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :         if (reachedFollowingSibling) {</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :           PostRestyleEvent(content-&gt;AsElement(), eRestyle_Subtree,</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :                            nsChangeHint(0));</span>
<span class="lineNum">     303 </span>            :         }
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     305 </span>            :       }
<span class="lineNum">     306 </span>            :     }
<span class="lineNum">     307 </span>            :     // restyle the now-last element child if it was before aOldChild
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :     reachedFollowingSibling = (aFollowingSibling == nullptr);</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :     for (nsIContent* content = container-&gt;GetLastChild();</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :          content;</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :          content = content-&gt;GetPreviousSibling()) {</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :       if (content-&gt;IsElement()) {</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :         if (reachedFollowingSibling) {</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :           PostRestyleEvent(content-&gt;AsElement(), eRestyle_Subtree, nsChangeHint(0));</span>
<span class="lineNum">     315 </span>            :         }
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     317 </span>            :       }
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :       if (content == aFollowingSibling) {</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         reachedFollowingSibling = true;</span>
<span class="lineNum">     320 </span>            :       }
<span class="lineNum">     321 </span>            :     }
<span class="lineNum">     322 </span>            :   }
<span class="lineNum">     323 </span>            : }
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            : /**
<span class="lineNum">     326 </span>            :  * Calculates the change hint and the restyle hint for a given content state
<span class="lineNum">     327 </span>            :  * change.
<span class="lineNum">     328 </span>            :  *
<span class="lineNum">     329 </span>            :  * This is called from both Restyle managers.
<a name="330"><span class="lineNum">     330 </span>            :  */</a>
<span class="lineNum">     331 </span>            : void
<span class="lineNum">     332 </span><span class="lineCov">         51 : RestyleManager::ContentStateChangedInternal(Element* aElement,</span>
<span class="lineNum">     333 </span>            :                                             EventStates aStateMask,
<span class="lineNum">     334 </span>            :                                             nsChangeHint* aOutChangeHint,
<span class="lineNum">     335 </span>            :                                             nsRestyleHint* aOutRestyleHint)
<span class="lineNum">     336 </span>            : {
<span class="lineNum">     337 </span><span class="lineCov">         51 :   MOZ_ASSERT(!mInStyleRefresh);</span>
<span class="lineNum">     338 </span><span class="lineCov">         51 :   MOZ_ASSERT(aOutChangeHint);</span>
<span class="lineNum">     339 </span><span class="lineCov">         51 :   MOZ_ASSERT(aOutRestyleHint);</span>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineCov">         51 :   StyleSetHandle styleSet = PresContext()-&gt;StyleSet();</span>
<span class="lineNum">     342 </span><span class="lineCov">         51 :   NS_ASSERTION(styleSet, &quot;couldn't get style set&quot;);</span>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span><span class="lineCov">         51 :   *aOutChangeHint = nsChangeHint(0);</span>
<span class="lineNum">     345 </span>            :   // Any change to a content state that affects which frames we construct
<span class="lineNum">     346 </span>            :   // must lead to a frame reconstruct here if we already have a frame.
<span class="lineNum">     347 </span>            :   // Note that we never decide through non-CSS means to not create frames
<span class="lineNum">     348 </span>            :   // based on content states, so if we already don't have a frame we don't
<span class="lineNum">     349 </span>            :   // need to force a reframe -- if it's needed, the HasStateDependentStyle
<span class="lineNum">     350 </span>            :   // call will handle things.
<span class="lineNum">     351 </span><span class="lineCov">         51 :   nsIFrame* primaryFrame = aElement-&gt;GetPrimaryFrame();</span>
<span class="lineNum">     352 </span><span class="lineCov">         51 :   CSSPseudoElementType pseudoType = CSSPseudoElementType::NotPseudo;</span>
<span class="lineNum">     353 </span><span class="lineCov">         51 :   if (primaryFrame) {</span>
<span class="lineNum">     354 </span>            :     // If it's generated content, ignore LOADING/etc state changes on it.
<span class="lineNum">     355 </span><span class="lineCov">        225 :     if (!primaryFrame-&gt;IsGeneratedContentFrame() &amp;&amp;</span>
<span class="lineNum">     356 </span><span class="lineCov">        180 :         aStateMask.HasAtLeastOneOfStates(NS_EVENT_STATE_BROKEN |</span>
<span class="lineNum">     357 </span><span class="lineCov">        225 :                                          NS_EVENT_STATE_USERDISABLED |</span>
<span class="lineNum">     358 </span><span class="lineCov">         90 :                                          NS_EVENT_STATE_SUPPRESSED |</span>
<span class="lineNum">     359 </span><span class="lineCov">        135 :                                          NS_EVENT_STATE_LOADING)) {</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :       *aOutChangeHint = nsChangeHint_ReconstructFrame;</span>
<span class="lineNum">     361 </span>            :     } else {
<span class="lineNum">     362 </span><span class="lineCov">         45 :       uint8_t app = primaryFrame-&gt;StyleDisplay()-&gt;mAppearance;</span>
<span class="lineNum">     363 </span><span class="lineCov">         45 :       if (app) {</span>
<span class="lineNum">     364 </span><span class="lineCov">          3 :         nsITheme* theme = PresContext()-&gt;GetTheme();</span>
<span class="lineNum">     365 </span><span class="lineCov">          6 :         if (theme &amp;&amp;</span>
<span class="lineNum">     366 </span><span class="lineCov">          3 :             theme-&gt;ThemeSupportsWidget(PresContext(), primaryFrame, app)) {</span>
<span class="lineNum">     367 </span><span class="lineCov">          3 :           bool repaint = false;</span>
<span class="lineNum">     368 </span><span class="lineCov">          3 :           theme-&gt;WidgetStateChanged(primaryFrame, app, nullptr, &amp;repaint,</span>
<span class="lineNum">     369 </span><span class="lineCov">          6 :                                     nullptr);</span>
<span class="lineNum">     370 </span><span class="lineCov">          3 :           if (repaint) {</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :             *aOutChangeHint |= nsChangeHint_RepaintFrame;</span>
<span class="lineNum">     372 </span>            :           }
<span class="lineNum">     373 </span>            :         }
<span class="lineNum">     374 </span>            :       }
<span class="lineNum">     375 </span>            :     }
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span><span class="lineCov">         45 :     pseudoType = primaryFrame-&gt;StyleContext()-&gt;GetPseudoType();</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineCov">         45 :     primaryFrame-&gt;ContentStatesChanged(aStateMask);</span>
<span class="lineNum">     380 </span>            :   }
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineCov">         51 :   if (pseudoType &gt;= CSSPseudoElementType::Count) {</span>
<span class="lineNum">     383 </span><span class="lineCov">         51 :     *aOutRestyleHint = styleSet-&gt;HasStateDependentStyle(aElement, aStateMask);</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :   } else if (nsCSSPseudoElements::PseudoElementSupportsUserActionState(</span>
<span class="lineNum">     385 </span>            :                pseudoType)) {
<span class="lineNum">     386 </span>            :     // If aElement is a pseudo-element, we want to check to see whether there
<span class="lineNum">     387 </span>            :     // are any state-dependent rules applying to that pseudo.
<span class="lineNum">     388 </span>            :     Element* ancestor =
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :       ElementForStyleContext(nullptr, primaryFrame, pseudoType);</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :     *aOutRestyleHint = styleSet-&gt;HasStateDependentStyle(ancestor, pseudoType,</span>
<span class="lineNum">     391 </span>            :                                                         aElement, aStateMask);
<span class="lineNum">     392 </span>            :   } else {
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     *aOutRestyleHint = nsRestyleHint(0);</span>
<span class="lineNum">     394 </span>            :   }
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span><span class="lineCov">         51 :   if (aStateMask.HasState(NS_EVENT_STATE_HOVER) &amp;&amp; *aOutRestyleHint != 0) {</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     IncrementHoverGeneration();</span>
<span class="lineNum">     398 </span>            :   }
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineCov">         51 :   if (aStateMask.HasState(NS_EVENT_STATE_VISITED)) {</span>
<span class="lineNum">     401 </span>            :     // Exposing information to the page about whether the link is
<span class="lineNum">     402 </span>            :     // visited or not isn't really something we can worry about here.
<span class="lineNum">     403 </span>            :     // FIXME: We could probably do this a bit better.
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     *aOutChangeHint |= nsChangeHint_RepaintFrame;</span>
<span class="lineNum">     405 </span>            :   }
<span class="lineNum">     406 </span><span class="lineCov">         51 : }</span>
<a name="407"><span class="lineNum">     407 </span>            : </a>
<span class="lineNum">     408 </span>            : /* static */ nsCString
<span class="lineNum">     409 </span><span class="lineNoCov">          0 : RestyleManager::RestyleHintToString(nsRestyleHint aHint)</span>
<span class="lineNum">     410 </span>            : {
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :   nsCString result;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   bool any = false;</span>
<span class="lineNum">     413 </span>            :   const char* names[] = {
<span class="lineNum">     414 </span>            :     &quot;Self&quot;, &quot;SomeDescendants&quot;, &quot;Subtree&quot;, &quot;LaterSiblings&quot;, &quot;CSSTransitions&quot;,
<span class="lineNum">     415 </span>            :     &quot;CSSAnimations&quot;, &quot;StyleAttribute&quot;, &quot;StyleAttribute_Animations&quot;,
<span class="lineNum">     416 </span>            :     &quot;Force&quot;, &quot;ForceDescendants&quot;
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :   };</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :   uint32_t hint = aHint &amp; ((1 &lt;&lt; ArrayLength(names)) - 1);</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :   uint32_t rest = aHint &amp; ~((1 &lt;&lt; ArrayLength(names)) - 1);</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :   for (uint32_t i = 0; i &lt; ArrayLength(names); i++) {</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     if (hint &amp; (1 &lt;&lt; i)) {</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :       if (any) {</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         result.AppendLiteral(&quot; | &quot;);</span>
<span class="lineNum">     424 </span>            :       }
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :       result.AppendPrintf(&quot;eRestyle_%s&quot;, names[i]);</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :       any = true;</span>
<span class="lineNum">     427 </span>            :     }
<span class="lineNum">     428 </span>            :   }
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :   if (rest) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :     if (any) {</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :       result.AppendLiteral(&quot; | &quot;);</span>
<span class="lineNum">     432 </span>            :     }
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     result.AppendPrintf(&quot;0x%0x&quot;, rest);</span>
<span class="lineNum">     434 </span>            :   } else {
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     if (!any) {</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :       result.AppendLiteral(&quot;0&quot;);</span>
<span class="lineNum">     437 </span>            :     }
<span class="lineNum">     438 </span>            :   }
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">     440 </span>            : }
<span class="lineNum">     441 </span>            : 
<a name="442"><span class="lineNum">     442 </span>            : #ifdef DEBUG</a>
<span class="lineNum">     443 </span>            : /* static */ nsCString
<span class="lineNum">     444 </span><span class="lineNoCov">          0 : RestyleManager::ChangeHintToString(nsChangeHint aHint)</span>
<span class="lineNum">     445 </span>            : {
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :   nsCString result;</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :   bool any = false;</span>
<span class="lineNum">     448 </span>            :   const char* names[] = {
<span class="lineNum">     449 </span>            :     &quot;RepaintFrame&quot;, &quot;NeedReflow&quot;, &quot;ClearAncestorIntrinsics&quot;,
<span class="lineNum">     450 </span>            :     &quot;ClearDescendantIntrinsics&quot;, &quot;NeedDirtyReflow&quot;, &quot;SyncFrameView&quot;,
<span class="lineNum">     451 </span>            :     &quot;UpdateCursor&quot;, &quot;UpdateEffects&quot;, &quot;UpdateOpacityLayer&quot;,
<span class="lineNum">     452 </span>            :     &quot;UpdateTransformLayer&quot;, &quot;ReconstructFrame&quot;, &quot;UpdateOverflow&quot;,
<span class="lineNum">     453 </span>            :     &quot;UpdateSubtreeOverflow&quot;, &quot;UpdatePostTransformOverflow&quot;,
<span class="lineNum">     454 </span>            :     &quot;UpdateParentOverflow&quot;,
<span class="lineNum">     455 </span>            :     &quot;ChildrenOnlyTransform&quot;, &quot;RecomputePosition&quot;, &quot;UpdateContainingBlock&quot;,
<span class="lineNum">     456 </span>            :     &quot;BorderStyleNoneChange&quot;, &quot;UpdateTextPath&quot;, &quot;SchedulePaint&quot;,
<span class="lineNum">     457 </span>            :     &quot;NeutralChange&quot;, &quot;InvalidateRenderingObservers&quot;,
<span class="lineNum">     458 </span>            :     &quot;ReflowChangesSizeOrPosition&quot;, &quot;UpdateComputedBSize&quot;,
<span class="lineNum">     459 </span>            :     &quot;UpdateUsesOpacity&quot;, &quot;UpdateBackgroundPosition&quot;,
<span class="lineNum">     460 </span>            :     &quot;AddOrRemoveTransform&quot;, &quot;CSSOverflowChange&quot;,
<span class="lineNum">     461 </span>            :     &quot;UpdateWidgetProperties&quot;
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :   };</span>
<span class="lineNum">     463 </span>            :   static_assert(nsChangeHint_AllHints == (1 &lt;&lt; ArrayLength(names)) - 1,
<span class="lineNum">     464 </span>            :                 &quot;Name list doesn't match change hints.&quot;);
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :   uint32_t hint = aHint &amp; ((1 &lt;&lt; ArrayLength(names)) - 1);</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :   uint32_t rest = aHint &amp; ~((1 &lt;&lt; ArrayLength(names)) - 1);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :   if ((hint &amp; NS_STYLE_HINT_REFLOW) == NS_STYLE_HINT_REFLOW) {</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     result.AppendLiteral(&quot;NS_STYLE_HINT_REFLOW&quot;);</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :     hint = hint &amp; ~NS_STYLE_HINT_REFLOW;</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     any = true;</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :   } else if ((hint &amp; nsChangeHint_AllReflowHints) == nsChangeHint_AllReflowHints) {</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     result.AppendLiteral(&quot;nsChangeHint_AllReflowHints&quot;);</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     hint = hint &amp; ~nsChangeHint_AllReflowHints;</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     any = true;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :   } else if ((hint &amp; NS_STYLE_HINT_VISUAL) == NS_STYLE_HINT_VISUAL) {</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     result.AppendLiteral(&quot;NS_STYLE_HINT_VISUAL&quot;);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     hint = hint &amp; ~NS_STYLE_HINT_VISUAL;</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     any = true;</span>
<span class="lineNum">     479 </span>            :   }
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :   for (uint32_t i = 0; i &lt; ArrayLength(names); i++) {</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     if (hint &amp; (1 &lt;&lt; i)) {</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :       if (any) {</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :         result.AppendLiteral(&quot; | &quot;);</span>
<span class="lineNum">     484 </span>            :       }
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :       result.AppendPrintf(&quot;nsChangeHint_%s&quot;, names[i]);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :       any = true;</span>
<span class="lineNum">     487 </span>            :     }
<span class="lineNum">     488 </span>            :   }
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :   if (rest) {</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :     if (any) {</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :       result.AppendLiteral(&quot; | &quot;);</span>
<span class="lineNum">     492 </span>            :     }
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :     result.AppendPrintf(&quot;0x%0x&quot;, rest);</span>
<span class="lineNum">     494 </span>            :   } else {
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     if (!any) {</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :       result.AppendLiteral(&quot;nsChangeHint(0)&quot;);</span>
<span class="lineNum">     497 </span>            :     }
<span class="lineNum">     498 </span>            :   }
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">     500 </span>            : }
<span class="lineNum">     501 </span>            : #endif
<span class="lineNum">     502 </span>            : 
<span class="lineNum">     503 </span>            : /**
<span class="lineNum">     504 </span>            :  * Frame construction helpers follow.
<span class="lineNum">     505 </span>            :  */
<span class="lineNum">     506 </span>            : #ifdef DEBUG
<span class="lineNum">     507 </span>            : static bool gInApplyRenderingChangeToTree = false;
<span class="lineNum">     508 </span>            : #endif
<span class="lineNum">     509 </span>            : 
<a name="510"><span class="lineNum">     510 </span>            : #ifdef DEBUG</a>
<span class="lineNum">     511 </span>            : static void
<span class="lineNum">     512 </span><span class="lineNoCov">          0 : DumpContext(nsIFrame* aFrame, nsStyleContext* aContext)</span>
<span class="lineNum">     513 </span>            : {
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :   if (aFrame) {</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     fputs(&quot;frame: &quot;, stdout);</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :     nsAutoString name;</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     aFrame-&gt;GetFrameName(name);</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     fputs(NS_LossyConvertUTF16toASCII(name).get(), stdout);</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     fprintf(stdout, &quot; (%p)&quot;, static_cast&lt;void*&gt;(aFrame));</span>
<span class="lineNum">     520 </span>            :   }
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :   if (aContext) {</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     fprintf(stdout, &quot; style: %p &quot;, static_cast&lt;void*&gt;(aContext));</span>
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :     nsIAtom* pseudoTag = aContext-&gt;GetPseudo();</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     if (pseudoTag) {</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :       nsAutoString buffer;</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :       pseudoTag-&gt;ToString(buffer);</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :       fputs(NS_LossyConvertUTF16toASCII(buffer).get(), stdout);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :       fputs(&quot; &quot;, stdout);</span>
<span class="lineNum">     530 </span>            :     }
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :     fputs(&quot;{}\n&quot;, stdout);</span>
<span class="lineNum">     532 </span>            :   }
<span class="lineNum">     533 </span><span class="lineNoCov">          0 : }</span>
<a name="534"><span class="lineNum">     534 </span>            : </a>
<span class="lineNum">     535 </span>            : static void
<span class="lineNum">     536 </span><span class="lineNoCov">          0 : VerifySameTree(nsStyleContext* aContext1, nsStyleContext* aContext2)</span>
<span class="lineNum">     537 </span>            : {
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :   nsStyleContext* top1 = aContext1;</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :   nsStyleContext* top2 = aContext2;</span>
<span class="lineNum">     540 </span>            :   nsStyleContext* parent;
<span class="lineNum">     541 </span>            :   for (;;) {
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :     parent = top1-&gt;GetParent();</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     if (!parent)</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :     top1 = parent;</span>
<span class="lineNum">     546 </span>            :   }
<span class="lineNum">     547 </span>            :   for (;;) {
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :     parent = top2-&gt;GetParent();</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :     if (!parent)</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     top2 = parent;</span>
<span class="lineNum">     552 </span>            :   }
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :   NS_ASSERTION(top1 == top2,</span>
<span class="lineNum">     554 </span>            :                &quot;Style contexts are not in the same style context tree&quot;);
<span class="lineNum">     555 </span><span class="lineNoCov">          0 : }</span>
<a name="556"><span class="lineNum">     556 </span>            : </a>
<span class="lineNum">     557 </span>            : static void
<span class="lineNum">     558 </span><span class="lineCov">        427 : VerifyContextParent(nsIFrame* aFrame, nsStyleContext* aContext,</span>
<span class="lineNum">     559 </span>            :                     nsStyleContext* aParentContext)
<span class="lineNum">     560 </span>            : {
<span class="lineNum">     561 </span>            :   // get the contexts not provided
<span class="lineNum">     562 </span><span class="lineCov">        427 :   if (!aContext) {</span>
<span class="lineNum">     563 </span><span class="lineCov">         13 :     aContext = aFrame-&gt;StyleContext();</span>
<span class="lineNum">     564 </span>            :   }
<span class="lineNum">     565 </span>            : 
<span class="lineNum">     566 </span><span class="lineCov">        427 :   if (!aParentContext) {</span>
<span class="lineNum">     567 </span>            :     nsIFrame* providerFrame;
<span class="lineNum">     568 </span><span class="lineCov">        427 :     aParentContext = aFrame-&gt;GetParentStyleContext(&amp;providerFrame);</span>
<span class="lineNum">     569 </span>            :     // aParentContext could still be null
<span class="lineNum">     570 </span>            :   }
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span><span class="lineCov">        427 :   NS_ASSERTION(aContext, &quot;Failure to get required contexts&quot;);</span>
<span class="lineNum">     573 </span><span class="lineCov">        427 :   nsStyleContext* actualParentContext = aContext-&gt;GetParent();</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineCov">        427 :   if (aParentContext) {</span>
<span class="lineNum">     576 </span><span class="lineCov">        414 :     if (aParentContext != actualParentContext) {</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :       DumpContext(aFrame, aContext);</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :       if (aContext == aParentContext) {</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :         NS_ERROR(&quot;Using parent's style context&quot;);</span>
<span class="lineNum">     580 </span>            :       } else {
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :         NS_ERROR(&quot;Wrong parent style context&quot;);</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :         fputs(&quot;Wrong parent style context: &quot;, stdout);</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :         DumpContext(nullptr, actualParentContext);</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :         fputs(&quot;should be using: &quot;, stdout);</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :         DumpContext(nullptr, aParentContext);</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :         VerifySameTree(actualParentContext, aParentContext);</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :         fputs(&quot;\n&quot;, stdout);</span>
<span class="lineNum">     588 </span>            :       }
<span class="lineNum">     589 </span>            :     }
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span>            :   } else {
<span class="lineNum">     592 </span><span class="lineCov">         13 :     if (actualParentContext) {</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :       NS_ERROR(&quot;Have parent context and shouldn't&quot;);</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :       DumpContext(aFrame, aContext);</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :       fputs(&quot;Has parent context: &quot;, stdout);</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :       DumpContext(nullptr, actualParentContext);</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :       fputs(&quot;Should be null\n\n&quot;, stdout);</span>
<span class="lineNum">     598 </span>            :     }
<span class="lineNum">     599 </span>            :   }
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineCov">        427 :   nsStyleContext* childStyleIfVisited = aContext-&gt;GetStyleIfVisited();</span>
<span class="lineNum">     602 </span>            :   // Either childStyleIfVisited has aContext-&gt;GetParent()-&gt;GetStyleIfVisited()
<span class="lineNum">     603 </span>            :   // as the parent or it has a different rulenode from aContext _and_ has
<span class="lineNum">     604 </span>            :   // aContext-&gt;GetParent() as the parent.
<span class="lineNum">     605 </span><span class="lineCov">        427 :   if (childStyleIfVisited &amp;&amp;</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :       !((childStyleIfVisited-&gt;RuleNode() != aContext-&gt;RuleNode() &amp;&amp;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :          childStyleIfVisited-&gt;GetParent() == aContext-&gt;GetParent()) ||</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :         childStyleIfVisited-&gt;GetParent() ==</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :           aContext-&gt;GetParent()-&gt;GetStyleIfVisited())) {</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     NS_ERROR(&quot;Visited style has wrong parent&quot;);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :     DumpContext(aFrame, aContext);</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     fputs(&quot;\n&quot;, stdout);</span>
<span class="lineNum">     613 </span>            :   }
<span class="lineNum">     614 </span><span class="lineCov">        427 : }</span>
<a name="615"><span class="lineNum">     615 </span>            : </a>
<span class="lineNum">     616 </span>            : static void
<span class="lineNum">     617 </span><span class="lineCov">        414 : VerifyStyleTree(nsIFrame* aFrame)</span>
<span class="lineNum">     618 </span>            : {
<span class="lineNum">     619 </span><span class="lineCov">        414 :   nsStyleContext* context = aFrame-&gt;StyleContext();</span>
<span class="lineNum">     620 </span><span class="lineCov">        414 :   VerifyContextParent(aFrame, context, nullptr);</span>
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span><span class="lineCov">        828 :   nsIFrame::ChildListIterator lists(aFrame);</span>
<span class="lineNum">     623 </span><span class="lineCov">        864 :   for (; !lists.IsDone(); lists.Next()) {</span>
<span class="lineNum">     624 </span><span class="lineCov">        547 :     for (nsIFrame* child : lists.CurrentList()) {</span>
<span class="lineNum">     625 </span><span class="lineCov">        322 :       if (!(child-&gt;GetStateBits() &amp; NS_FRAME_OUT_OF_FLOW)) {</span>
<span class="lineNum">     626 </span>            :         // only do frames that are in flow
<span class="lineNum">     627 </span><span class="lineCov">        322 :         if (child-&gt;IsPlaceholderFrame()) {</span>
<span class="lineNum">     628 </span>            :           // placeholder: first recurse and verify the out of flow frame,
<span class="lineNum">     629 </span>            :           // then verify the placeholder's context
<span class="lineNum">     630 </span>            :           nsIFrame* outOfFlowFrame =
<span class="lineNum">     631 </span><span class="lineCov">         13 :             nsPlaceholderFrame::GetRealFrameForPlaceholder(child);</span>
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span>            :           // recurse to out of flow frame, letting the parent context get resolved
<span class="lineNum">     634 </span><span class="lineCov">         13 :           do {</span>
<span class="lineNum">     635 </span><span class="lineCov">         13 :             VerifyStyleTree(outOfFlowFrame);</span>
<span class="lineNum">     636 </span><span class="lineCov">         13 :           } while ((outOfFlowFrame = outOfFlowFrame-&gt;GetNextContinuation()));</span>
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span>            :           // verify placeholder using the parent frame's context as
<span class="lineNum">     639 </span>            :           // parent context
<span class="lineNum">     640 </span><span class="lineCov">         13 :           VerifyContextParent(child, nullptr, nullptr);</span>
<span class="lineNum">     641 </span>            :         } else { // regular frame
<span class="lineNum">     642 </span><span class="lineCov">        309 :           VerifyStyleTree(child);</span>
<span class="lineNum">     643 </span>            :         }
<span class="lineNum">     644 </span>            :       }
<span class="lineNum">     645 </span>            :     }
<span class="lineNum">     646 </span>            :   }
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span>            :   // do additional contexts
<span class="lineNum">     649 </span><span class="lineCov">        414 :   int32_t contextIndex = 0;</span>
<span class="lineNum">     650 </span><span class="lineCov">        414 :   for (nsStyleContext* extraContext;</span>
<span class="lineNum">     651 </span><span class="lineCov">        414 :        (extraContext = aFrame-&gt;GetAdditionalStyleContext(contextIndex));</span>
<span class="lineNum">     652 </span>            :        ++contextIndex) {
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :     VerifyContextParent(aFrame, extraContext, context);</span>
<span class="lineNum">     654 </span>            :   }
<span class="lineNum">     655 </span><span class="lineCov">        414 : }</span>
<a name="656"><span class="lineNum">     656 </span>            : </a>
<span class="lineNum">     657 </span>            : void
<span class="lineNum">     658 </span><span class="lineCov">         92 : RestyleManager::DebugVerifyStyleTree(nsIFrame* aFrame)</span>
<span class="lineNum">     659 </span>            : {
<span class="lineNum">     660 </span><span class="lineCov">         92 :   if (IsServo()) {</span>
<span class="lineNum">     661 </span>            :     // XXXheycam For now, we know that we don't use the same inheritance
<span class="lineNum">     662 </span>            :     // hierarchy for certain cases, so just skip these assertions until
<span class="lineNum">     663 </span>            :     // we work out what we want to assert (bug 1322570).
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     665 </span>            :   }
<span class="lineNum">     666 </span><span class="lineCov">         92 :   if (aFrame) {</span>
<span class="lineNum">     667 </span><span class="lineCov">         92 :     VerifyStyleTree(aFrame);</span>
<span class="lineNum">     668 </span>            :   }
<span class="lineNum">     669 </span>            : }
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span>            : #endif // DEBUG
<span class="lineNum">     672 </span>            : 
<span class="lineNum">     673 </span>            : /**
<span class="lineNum">     674 </span>            :  * Sync views on aFrame and all of aFrame's descendants (following placeholders),
<span class="lineNum">     675 </span>            :  * if aChange has nsChangeHint_SyncFrameView.
<span class="lineNum">     676 </span>            :  * Calls DoApplyRenderingChangeToTree on all aFrame's out-of-flow descendants
<span class="lineNum">     677 </span>            :  * (following placeholders), if aChange has nsChangeHint_RepaintFrame.
<span class="lineNum">     678 </span>            :  * aFrame should be some combination of nsChangeHint_SyncFrameView,
<span class="lineNum">     679 </span>            :  * nsChangeHint_RepaintFrame, nsChangeHint_UpdateOpacityLayer and
<span class="lineNum">     680 </span>            :  * nsChangeHint_SchedulePaint, nothing else.
<span class="lineNum">     681 </span>            : */
<span class="lineNum">     682 </span>            : static void SyncViewsAndInvalidateDescendants(nsIFrame* aFrame,
<span class="lineNum">     683 </span>            :                                               nsChangeHint aChange);
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span>            : static void StyleChangeReflow(nsIFrame* aFrame, nsChangeHint aHint);
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span>            : /**
<span class="lineNum">     688 </span>            :  * To handle nsChangeHint_ChildrenOnlyTransform we must iterate over the child
<span class="lineNum">     689 </span>            :  * frames of the SVG frame concerned. This helper function is used to find that
<span class="lineNum">     690 </span>            :  * SVG frame when we encounter nsChangeHint_ChildrenOnlyTransform to ensure
<span class="lineNum">     691 </span>            :  * that we iterate over the intended children, since sometimes we end up
<span class="lineNum">     692 </span>            :  * handling that hint while processing hints for one of the SVG frame's
<span class="lineNum">     693 </span>            :  * ancestor frames.
<span class="lineNum">     694 </span>            :  *
<span class="lineNum">     695 </span>            :  * The reason that we sometimes end up trying to process the hint for an
<span class="lineNum">     696 </span>            :  * ancestor of the SVG frame that the hint is intended for is due to the way we
<span class="lineNum">     697 </span>            :  * process restyle events. ApplyRenderingChangeToTree adjusts the frame from
<span class="lineNum">     698 </span>            :  * the restyled element's principle frame to one of its ancestor frames based
<span class="lineNum">     699 </span>            :  * on what nsCSSRendering::FindBackground returns, since the background style
<span class="lineNum">     700 </span>            :  * may have been propagated up to an ancestor frame. Processing hints using an
<span class="lineNum">     701 </span>            :  * ancestor frame is fine in general, but nsChangeHint_ChildrenOnlyTransform is
<span class="lineNum">     702 </span>            :  * a special case since it is intended to update the children of a specific
<span class="lineNum">     703 </span>            :  * frame.
<a name="704"><span class="lineNum">     704 </span>            :  */</a>
<span class="lineNum">     705 </span>            : static nsIFrame*
<span class="lineNum">     706 </span><span class="lineNoCov">          0 : GetFrameForChildrenOnlyTransformHint(nsIFrame* aFrame)</span>
<span class="lineNum">     707 </span>            : {
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :   if (aFrame-&gt;IsViewportFrame()) {</span>
<span class="lineNum">     709 </span>            :     // This happens if the root-&lt;svg&gt; is fixed positioned, in which case we
<span class="lineNum">     710 </span>            :     // can't use aFrame-&gt;GetContent() to find the primary frame, since
<span class="lineNum">     711 </span>            :     // GetContent() returns nullptr for ViewportFrame.
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :     aFrame = aFrame-&gt;PrincipalChildList().FirstChild();</span>
<span class="lineNum">     713 </span>            :   }
<span class="lineNum">     714 </span>            :   // For an nsHTMLScrollFrame, this will get the SVG frame that has the
<span class="lineNum">     715 </span>            :   // children-only transforms:
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :   aFrame = aFrame-&gt;GetContent()-&gt;GetPrimaryFrame();</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :   if (aFrame-&gt;IsSVGOuterSVGFrame()) {</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :     aFrame = aFrame-&gt;PrincipalChildList().FirstChild();</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(aFrame-&gt;IsSVGOuterSVGAnonChildFrame(),</span>
<span class="lineNum">     720 </span>            :                &quot;Where is the nsSVGOuterSVGFrame's anon child??&quot;);
<span class="lineNum">     721 </span>            :   }
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(aFrame-&gt;IsFrameOfType(nsIFrame::eSVG | nsIFrame::eSVGContainer),</span>
<span class="lineNum">     723 </span>            :              &quot;Children-only transforms only expected on SVG frames&quot;);
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :   return aFrame;</span>
<span class="lineNum">     725 </span>            : }
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span>            : // Returns true if this function managed to successfully move a frame, and
<span class="lineNum">     728 </span>            : // false if it could not process the position change, and a reflow should
<a name="729"><span class="lineNum">     729 </span>            : // be performed instead.</a>
<span class="lineNum">     730 </span>            : bool
<span class="lineNum">     731 </span><span class="lineNoCov">          0 : RecomputePosition(nsIFrame* aFrame)</span>
<span class="lineNum">     732 </span>            : {
<span class="lineNum">     733 </span>            :   // Don't process position changes on table frames, since we already handle
<span class="lineNum">     734 </span>            :   // the dynamic position change on the table wrapper frame, and the
<span class="lineNum">     735 </span>            :   // reflow-based fallback code path also ignores positions on inner table
<span class="lineNum">     736 </span>            :   // frames.
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :   if (aFrame-&gt;IsTableFrame()) {</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     739 </span>            :   }
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :   const nsStyleDisplay* display = aFrame-&gt;StyleDisplay();</span>
<span class="lineNum">     742 </span>            :   // Changes to the offsets of a non-positioned element can safely be ignored.
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :   if (display-&gt;mPosition == NS_STYLE_POSITION_STATIC) {</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     745 </span>            :   }
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span>            :   // Don't process position changes on frames which have views or the ones which
<span class="lineNum">     748 </span>            :   // have a view somewhere in their descendants, because the corresponding view
<span class="lineNum">     749 </span>            :   // needs to be repositioned properly as well.
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :   if (aFrame-&gt;HasView() ||</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :       (aFrame-&gt;GetStateBits() &amp; NS_FRAME_HAS_CHILD_WITH_VIEW)) {</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :     StyleChangeReflow(aFrame, nsChangeHint_NeedReflow);</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     754 </span>            :   }
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :   aFrame-&gt;SchedulePaint();</span>
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span>            :   // For relative positioning, we can simply update the frame rect
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :   if (display-&gt;IsRelativelyPositionedStyle()) {</span>
<span class="lineNum">     760 </span>            :     // Move the frame
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     if (display-&gt;mPosition == NS_STYLE_POSITION_STICKY) {</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :       if (display-&gt;IsInnerTableStyle()) {</span>
<span class="lineNum">     763 </span>            :         // We don't currently support sticky positioning of inner table
<span class="lineNum">     764 </span>            :         // elements (bug 975644). Bail.
<span class="lineNum">     765 </span>            :         //
<span class="lineNum">     766 </span>            :         // When this is fixed, remove the null-check for the computed
<span class="lineNum">     767 </span>            :         // offsets in nsTableRowFrame::ReflowChildren.
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :         return true;</span>
<span class="lineNum">     769 </span>            :       }
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span>            :       // Update sticky positioning for an entire element at once, starting with
<span class="lineNum">     772 </span>            :       // the first continuation or ib-split sibling.
<span class="lineNum">     773 </span>            :       // It's rare that the frame we already have isn't already the first
<span class="lineNum">     774 </span>            :       // continuation or ib-split sibling, but it can happen when styles differ
<span class="lineNum">     775 </span>            :       // across continuations such as ::first-line or ::first-letter, and in
<span class="lineNum">     776 </span>            :       // those cases we will generally (but maybe not always) do the work twice.
<span class="lineNum">     777 </span>            :       nsIFrame* firstContinuation =
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :         nsLayoutUtils::FirstContinuationOrIBSplitSibling(aFrame);</span>
<span class="lineNum">     779 </span>            : 
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :       StickyScrollContainer::ComputeStickyOffsets(firstContinuation);</span>
<span class="lineNum">     781 </span>            :       StickyScrollContainer* ssc =
<span class="lineNum">     782 </span>            :         StickyScrollContainer::GetStickyScrollContainerForFrame(
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :           firstContinuation);</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :       if (ssc) {</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :         ssc-&gt;PositionContinuations(firstContinuation);</span>
<span class="lineNum">     786 </span>            :       }
<span class="lineNum">     787 </span>            :     } else {
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :       MOZ_ASSERT(NS_STYLE_POSITION_RELATIVE == display-&gt;mPosition,</span>
<span class="lineNum">     789 </span>            :                  &quot;Unexpected type of positioning&quot;);
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :       for (nsIFrame* cont = aFrame; cont;</span>
<span class="lineNum">     791 </span>            :            cont = nsLayoutUtils::GetNextContinuationOrIBSplitSibling(cont)) {
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :         nsIFrame* cb = cont-&gt;GetContainingBlock();</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :         nsMargin newOffsets;</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :         WritingMode wm = cb-&gt;GetWritingMode();</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :         const LogicalSize size(wm, cb-&gt;GetContentRectRelativeToSelf().Size());</span>
<span class="lineNum">     796 </span>            : 
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :         ReflowInput::ComputeRelativeOffsets(wm, cont, size, newOffsets);</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :         NS_ASSERTION(newOffsets.left == -newOffsets.right &amp;&amp;</span>
<span class="lineNum">     799 </span>            :                      newOffsets.top == -newOffsets.bottom,
<span class="lineNum">     800 </span>            :                      &quot;ComputeRelativeOffsets should return valid results&quot;);
<span class="lineNum">     801 </span>            : 
<span class="lineNum">     802 </span>            :         // ReflowInput::ApplyRelativePositioning would work here, but
<span class="lineNum">     803 </span>            :         // since we've already checked mPosition and aren't changing the frame's
<span class="lineNum">     804 </span>            :         // normal position, go ahead and add the offsets directly.
<span class="lineNum">     805 </span>            :         // First, we need to ensure that the normal position is stored though.
<span class="lineNum">     806 </span>            :         bool hasProperty;
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :         nsPoint normalPosition = cont-&gt;GetNormalPosition(&amp;hasProperty);</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :         if (!hasProperty) {</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :           cont-&gt;AddProperty(nsIFrame::NormalPositionProperty(),</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :                             new nsPoint(normalPosition));</span>
<span class="lineNum">     811 </span>            :         }
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :         cont-&gt;SetPosition(normalPosition +</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :                           nsPoint(newOffsets.left, newOffsets.top));</span>
<span class="lineNum">     814 </span>            :       }
<span class="lineNum">     815 </span>            :     }
<span class="lineNum">     816 </span>            : 
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     818 </span>            :   }
<span class="lineNum">     819 </span>            : 
<span class="lineNum">     820 </span>            :   // For the absolute positioning case, set up a fake HTML reflow state for
<span class="lineNum">     821 </span>            :   // the frame, and then get the offsets and size from it. If the frame's size
<span class="lineNum">     822 </span>            :   // doesn't need to change, we can simply update the frame position. Otherwise
<span class="lineNum">     823 </span>            :   // we fall back to a reflow.
<span class="lineNum">     824 </span>            :   RefPtr&lt;gfxContext&gt; rc =
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :     aFrame-&gt;PresContext()-&gt;PresShell()-&gt;CreateReferenceRenderingContext();</span>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span>            :   // Construct a bogus parent reflow state so that there's a usable
<span class="lineNum">     828 </span>            :   // containing block reflow state.
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :   nsIFrame* parentFrame = aFrame-&gt;GetParent();</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :   WritingMode parentWM = parentFrame-&gt;GetWritingMode();</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :   WritingMode frameWM = aFrame-&gt;GetWritingMode();</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :   LogicalSize parentSize = parentFrame-&gt;GetLogicalSize();</span>
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :   nsFrameState savedState = parentFrame-&gt;GetStateBits();</span>
<span class="lineNum">     835 </span>            :   ReflowInput parentReflowInput(aFrame-&gt;PresContext(), parentFrame, rc,
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :                                 parentSize);</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :   parentFrame-&gt;RemoveStateBits(~nsFrameState(0));</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :   parentFrame-&gt;AddStateBits(savedState);</span>
<span class="lineNum">     839 </span>            : 
<span class="lineNum">     840 </span>            :   // The bogus parent state here was created with no parent state of its own,
<span class="lineNum">     841 </span>            :   // and therefore it won't have an mCBReflowInput set up.
<span class="lineNum">     842 </span>            :   // But we may need one (for InitCBReflowInput in a child state), so let's
<span class="lineNum">     843 </span>            :   // try to create one here for the cases where it will be needed.
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :   Maybe&lt;ReflowInput&gt; cbReflowInput;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :   nsIFrame* cbFrame = parentFrame-&gt;GetContainingBlock();</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :   if (cbFrame &amp;&amp; (aFrame-&gt;GetContainingBlock() != parentFrame ||</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :                   parentFrame-&gt;IsTableFrame())) {</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :     LogicalSize cbSize = cbFrame-&gt;GetLogicalSize();</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :     cbReflowInput.emplace(cbFrame-&gt;PresContext(), cbFrame, rc, cbSize);</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :     cbReflowInput-&gt;ComputedPhysicalMargin() = cbFrame-&gt;GetUsedMargin();</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     cbReflowInput-&gt;ComputedPhysicalPadding() = cbFrame-&gt;GetUsedPadding();</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :     cbReflowInput-&gt;ComputedPhysicalBorderPadding() =</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :       cbFrame-&gt;GetUsedBorderAndPadding();</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     parentReflowInput.mCBReflowInput = cbReflowInput.ptr();</span>
<span class="lineNum">     855 </span>            :   }
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :   NS_WARNING_ASSERTION(parentSize.ISize(parentWM) != NS_INTRINSICSIZE &amp;&amp;</span>
<span class="lineNum">     858 </span>            :                        parentSize.BSize(parentWM) != NS_INTRINSICSIZE,
<span class="lineNum">     859 </span>            :                        &quot;parentSize should be valid&quot;);
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :   parentReflowInput.SetComputedISize(std::max(parentSize.ISize(parentWM), 0));</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :   parentReflowInput.SetComputedBSize(std::max(parentSize.BSize(parentWM), 0));</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :   parentReflowInput.ComputedPhysicalMargin().SizeTo(0, 0, 0, 0);</span>
<span class="lineNum">     863 </span>            : 
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :   parentReflowInput.ComputedPhysicalPadding() = parentFrame-&gt;GetUsedPadding();</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :   parentReflowInput.ComputedPhysicalBorderPadding() =</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :     parentFrame-&gt;GetUsedBorderAndPadding();</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :   LogicalSize availSize = parentSize.ConvertTo(frameWM, parentWM);</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :   availSize.BSize(frameWM) = NS_INTRINSICSIZE;</span>
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :   ViewportFrame* viewport = do_QueryFrame(parentFrame);</span>
<span class="lineNum">     871 </span>            :   nsSize cbSize = viewport ?
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :     viewport-&gt;AdjustReflowInputAsContainingBlock(&amp;parentReflowInput).Size()</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :     : aFrame-&gt;GetContainingBlock()-&gt;GetSize();</span>
<span class="lineNum">     874 </span>            :   const nsMargin&amp; parentBorder =
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :     parentReflowInput.mStyleBorder-&gt;GetComputedBorder();</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :   cbSize -= nsSize(parentBorder.LeftRight(), parentBorder.TopBottom());</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :   LogicalSize lcbSize(frameWM, cbSize);</span>
<span class="lineNum">     878 </span>            :   ReflowInput reflowInput(aFrame-&gt;PresContext(), parentReflowInput, aFrame,
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :                           availSize, &amp;lcbSize);</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :   nsSize computedSize(reflowInput.ComputedWidth(),</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                       reflowInput.ComputedHeight());</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :   computedSize.width += reflowInput.ComputedPhysicalBorderPadding().LeftRight();</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :   if (computedSize.height != NS_INTRINSICSIZE) {</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     computedSize.height +=</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :       reflowInput.ComputedPhysicalBorderPadding().TopBottom();</span>
<span class="lineNum">     886 </span>            :   }
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :   nsSize size = aFrame-&gt;GetSize();</span>
<span class="lineNum">     888 </span>            :   // The RecomputePosition hint is not used if any offset changed between auto
<span class="lineNum">     889 </span>            :   // and non-auto. If computedSize.height == NS_INTRINSICSIZE then the new
<span class="lineNum">     890 </span>            :   // element height will be its intrinsic height, and since 'top' and 'bottom''s
<span class="lineNum">     891 </span>            :   // auto-ness hasn't changed, the old height must also be its intrinsic
<span class="lineNum">     892 </span>            :   // height, which we can assume hasn't changed (or reflow would have
<span class="lineNum">     893 </span>            :   // been triggered).
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :   if (computedSize.width == size.width &amp;&amp;</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :       (computedSize.height == NS_INTRINSICSIZE || computedSize.height == size.height)) {</span>
<span class="lineNum">     896 </span>            :     // If we're solving for 'left' or 'top', then compute it here, in order to
<span class="lineNum">     897 </span>            :     // match the reflow code path.
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :     if (NS_AUTOOFFSET == reflowInput.ComputedPhysicalOffsets().left) {</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :       reflowInput.ComputedPhysicalOffsets().left = cbSize.width -</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :                                           reflowInput.ComputedPhysicalOffsets().right -</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :                                           reflowInput.ComputedPhysicalMargin().right -</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :                                           size.width -</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :                                           reflowInput.ComputedPhysicalMargin().left;</span>
<span class="lineNum">     904 </span>            :     }
<span class="lineNum">     905 </span>            : 
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     if (NS_AUTOOFFSET == reflowInput.ComputedPhysicalOffsets().top) {</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :       reflowInput.ComputedPhysicalOffsets().top = cbSize.height -</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :                                          reflowInput.ComputedPhysicalOffsets().bottom -</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :                                          reflowInput.ComputedPhysicalMargin().bottom -</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                                          size.height -</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :                                          reflowInput.ComputedPhysicalMargin().top;</span>
<span class="lineNum">     912 </span>            :     }
<span class="lineNum">     913 </span>            : 
<span class="lineNum">     914 </span>            :     // Move the frame
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :     nsPoint pos(parentBorder.left + reflowInput.ComputedPhysicalOffsets().left +</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :                 reflowInput.ComputedPhysicalMargin().left,</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :                 parentBorder.top + reflowInput.ComputedPhysicalOffsets().top +</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :                 reflowInput.ComputedPhysicalMargin().top);</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :     aFrame-&gt;SetPosition(pos);</span>
<span class="lineNum">     920 </span>            : 
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     922 </span>            :   }
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span>            :   // Fall back to a reflow
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :   StyleChangeReflow(aFrame, nsChangeHint_NeedReflow);</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">     927 </span>            : }
<a name="928"><span class="lineNum">     928 </span>            : </a>
<span class="lineNum">     929 </span>            : static bool
<span class="lineNum">     930 </span><span class="lineNoCov">          0 : HasBoxAncestor(nsIFrame* aFrame)</span>
<span class="lineNum">     931 </span>            : {
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :   for (nsIFrame* f = aFrame; f; f = f-&gt;GetParent()) {</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :     if (f-&gt;IsXULBoxFrame()) {</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">     935 </span>            :     }
<span class="lineNum">     936 </span>            :   }
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">     938 </span>            : }
<span class="lineNum">     939 </span>            : 
<span class="lineNum">     940 </span>            : /**
<span class="lineNum">     941 </span>            :  * Return true if aFrame's subtree has placeholders for out-of-flow content
<span class="lineNum">     942 </span>            :  * whose 'position' style's bit in aPositionMask is set.
<a name="943"><span class="lineNum">     943 </span>            :  */</a>
<span class="lineNum">     944 </span>            : static bool
<span class="lineNum">     945 </span><span class="lineCov">          2 : FrameHasPositionedPlaceholderDescendants(nsIFrame* aFrame,</span>
<span class="lineNum">     946 </span>            :                                          uint32_t aPositionMask)
<span class="lineNum">     947 </span>            : {
<span class="lineNum">     948 </span><span class="lineCov">          2 :   MOZ_ASSERT(aPositionMask &amp; (1 &lt;&lt; NS_STYLE_POSITION_FIXED));</span>
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span><span class="lineCov">          4 :   for (nsIFrame::ChildListIterator lists(aFrame); !lists.IsDone(); lists.Next()) {</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :     for (nsIFrame* f : lists.CurrentList()) {</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :       if (f-&gt;IsPlaceholderFrame()) {</span>
<span class="lineNum">     953 </span>            :         nsIFrame* outOfFlow =
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :           nsPlaceholderFrame::GetRealFrameForPlaceholder(f);</span>
<span class="lineNum">     955 </span>            :         // If SVG text frames could appear here, they could confuse us since
<span class="lineNum">     956 </span>            :         // they ignore their position style ... but they can't.
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :         NS_ASSERTION(!nsSVGUtils::IsInSVGTextSubtree(outOfFlow),</span>
<span class="lineNum">     958 </span>            :                      &quot;SVG text frames can't be out of flow&quot;);
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :         if (aPositionMask &amp; (1 &lt;&lt; outOfFlow-&gt;StyleDisplay()-&gt;mPosition)) {</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :           return true;</span>
<span class="lineNum">     961 </span>            :         }
<span class="lineNum">     962 </span>            :       }
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :       uint32_t positionMask = aPositionMask;</span>
<span class="lineNum">     964 </span>            :       // NOTE:  It's tempting to check f-&gt;IsAbsPosContainingBlock() or
<span class="lineNum">     965 </span>            :       // f-&gt;IsFixedPosContainingBlock() here.  However, that would only
<span class="lineNum">     966 </span>            :       // be testing the *new* style of the frame, which might exclude
<span class="lineNum">     967 </span>            :       // descendants that currently have this frame as an abs-pos
<span class="lineNum">     968 </span>            :       // containing block.  Taking the codepath where we don't reframe
<span class="lineNum">     969 </span>            :       // could lead to an unsafe call to
<span class="lineNum">     970 </span>            :       // cont-&gt;MarkAsNotAbsoluteContainingBlock() before we've reframed
<span class="lineNum">     971 </span>            :       // the descendant and taken it off the absolute list.
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :       if (FrameHasPositionedPlaceholderDescendants(f, positionMask)) {</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :         return true;</span>
<span class="lineNum">     974 </span>            :       }
<span class="lineNum">     975 </span>            :     }
<span class="lineNum">     976 </span>            :   }
<span class="lineNum">     977 </span><span class="lineCov">          2 :   return false;</span>
<span class="lineNum">     978 </span>            : }
<a name="979"><span class="lineNum">     979 </span>            : </a>
<span class="lineNum">     980 </span>            : static bool
<span class="lineNum">     981 </span><span class="lineCov">          2 : NeedToReframeForAddingOrRemovingTransform(nsIFrame* aFrame)</span>
<span class="lineNum">     982 </span>            : {
<span class="lineNum">     983 </span>            :   static_assert(0 &lt;= NS_STYLE_POSITION_ABSOLUTE &amp;&amp;
<span class="lineNum">     984 </span>            :                 NS_STYLE_POSITION_ABSOLUTE &lt; 32, &quot;Style constant out of range&quot;);
<span class="lineNum">     985 </span>            :   static_assert(0 &lt;= NS_STYLE_POSITION_FIXED &amp;&amp;
<span class="lineNum">     986 </span>            :                 NS_STYLE_POSITION_FIXED &lt; 32, &quot;Style constant out of range&quot;);
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span>            :   uint32_t positionMask;
<span class="lineNum">     989 </span>            :   // Don't call aFrame-&gt;IsPositioned here, since that returns true if
<span class="lineNum">     990 </span>            :   // the frame already has a transform, and we want to ignore that here
<span class="lineNum">     991 </span><span class="lineCov">          2 :   if (aFrame-&gt;IsAbsolutelyPositioned() || aFrame-&gt;IsRelativelyPositioned()) {</span>
<span class="lineNum">     992 </span>            :     // This frame is a container for abs-pos descendants whether or not it
<span class="lineNum">     993 </span>            :     // has a transform.
<span class="lineNum">     994 </span>            :     // So abs-pos descendants are no problem; we only need to reframe if
<span class="lineNum">     995 </span>            :     // we have fixed-pos descendants.
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :     positionMask = 1 &lt;&lt; NS_STYLE_POSITION_FIXED;</span>
<span class="lineNum">     997 </span>            :   } else {
<span class="lineNum">     998 </span>            :     // This frame may not be a container for abs-pos descendants already.
<span class="lineNum">     999 </span>            :     // So reframe if we have abs-pos or fixed-pos descendants.
<span class="lineNum">    1000 </span><span class="lineCov">          2 :     positionMask =</span>
<span class="lineNum">    1001 </span>            :       (1 &lt;&lt; NS_STYLE_POSITION_FIXED) | (1 &lt;&lt; NS_STYLE_POSITION_ABSOLUTE);
<span class="lineNum">    1002 </span>            :   }
<span class="lineNum">    1003 </span><span class="lineCov">          4 :   for (nsIFrame* f = aFrame; f;</span>
<span class="lineNum">    1004 </span>            :        f = nsLayoutUtils::GetNextContinuationOrIBSplitSibling(f)) {
<span class="lineNum">    1005 </span><span class="lineCov">          2 :     if (FrameHasPositionedPlaceholderDescendants(f, positionMask)) {</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">    1007 </span>            :     }
<span class="lineNum">    1008 </span>            :   }
<span class="lineNum">    1009 </span><span class="lineCov">          2 :   return false;</span>
<span class="lineNum">    1010 </span>            : }
<a name="1011"><span class="lineNum">    1011 </span>            : </a>
<span class="lineNum">    1012 </span>            : /* static */ nsIFrame*
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 : RestyleManager::GetNearestAncestorFrame(nsIContent* aContent)</span>
<span class="lineNum">    1014 </span>            : {
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :   nsIFrame* ancestorFrame = nullptr;</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :   for (nsIContent* ancestor = aContent-&gt;GetParent();</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :        ancestor &amp;&amp; !ancestorFrame;</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :        ancestor = ancestor-&gt;GetParent()) {</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :     ancestorFrame = ancestor-&gt;GetPrimaryFrame();</span>
<span class="lineNum">    1020 </span>            :   }
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :   return ancestorFrame;</span>
<span class="lineNum">    1022 </span>            : }
<a name="1023"><span class="lineNum">    1023 </span>            : </a>
<span class="lineNum">    1024 </span>            : /* static */ nsIFrame*
<span class="lineNum">    1025 </span><span class="lineCov">         61 : RestyleManager::GetNextBlockInInlineSibling(nsIFrame* aFrame)</span>
<span class="lineNum">    1026 </span>            : {
<span class="lineNum">    1027 </span><span class="lineCov">         61 :   NS_ASSERTION(!aFrame-&gt;GetPrevContinuation(),</span>
<span class="lineNum">    1028 </span>            :                &quot;must start with the first continuation&quot;);
<span class="lineNum">    1029 </span>            :   // Might we have ib-split siblings?
<span class="lineNum">    1030 </span><span class="lineCov">         61 :   if (!(aFrame-&gt;GetStateBits() &amp; NS_FRAME_PART_OF_IBSPLIT)) {</span>
<span class="lineNum">    1031 </span>            :     // nothing more to do here
<span class="lineNum">    1032 </span><span class="lineCov">         61 :     return nullptr;</span>
<span class="lineNum">    1033 </span>            :   }
<span class="lineNum">    1034 </span>            : 
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :   return aFrame-&gt;GetProperty(nsIFrame::IBSplitSibling());</span>
<span class="lineNum">    1036 </span>            : }
<a name="1037"><span class="lineNum">    1037 </span>            : </a>
<span class="lineNum">    1038 </span>            : static void
<span class="lineNum">    1039 </span><span class="lineCov">         60 : DoApplyRenderingChangeToTree(nsIFrame* aFrame,</span>
<span class="lineNum">    1040 </span>            :                              nsChangeHint aChange)
<span class="lineNum">    1041 </span>            : {
<span class="lineNum">    1042 </span><span class="lineCov">         60 :   NS_PRECONDITION(gInApplyRenderingChangeToTree,</span>
<span class="lineNum">    1043 </span>            :                   &quot;should only be called within ApplyRenderingChangeToTree&quot;);
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span><span class="lineCov">        180 :   for ( ; aFrame; aFrame = nsLayoutUtils::GetNextContinuationOrIBSplitSibling(aFrame)) {</span>
<span class="lineNum">    1046 </span>            :     // Invalidate and sync views on all descendant frames, following placeholders.
<span class="lineNum">    1047 </span>            :     // We don't need to update transforms in SyncViewsAndInvalidateDescendants, because
<span class="lineNum">    1048 </span>            :     // there can't be any out-of-flows or popups that need to be transformed;
<span class="lineNum">    1049 </span>            :     // all out-of-flow descendants of the transformed element must also be
<span class="lineNum">    1050 </span>            :     // descendants of the transformed frame.
<span class="lineNum">    1051 </span><span class="lineCov">         60 :     SyncViewsAndInvalidateDescendants(aFrame,</span>
<span class="lineNum">    1052 </span>            :       nsChangeHint(aChange &amp; (nsChangeHint_RepaintFrame |
<span class="lineNum">    1053 </span>            :                               nsChangeHint_SyncFrameView |
<span class="lineNum">    1054 </span>            :                               nsChangeHint_UpdateOpacityLayer |
<span class="lineNum">    1055 </span><span class="lineCov">         60 :                               nsChangeHint_SchedulePaint)));</span>
<span class="lineNum">    1056 </span>            :     // This must be set to true if the rendering change needs to
<span class="lineNum">    1057 </span>            :     // invalidate content.  If it's false, a composite-only paint
<span class="lineNum">    1058 </span>            :     // (empty transaction) will be scheduled.
<span class="lineNum">    1059 </span><span class="lineCov">         60 :     bool needInvalidatingPaint = false;</span>
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span>            :     // if frame has view, will already be invalidated
<span class="lineNum">    1062 </span><span class="lineCov">         60 :     if (aChange &amp; nsChangeHint_RepaintFrame) {</span>
<span class="lineNum">    1063 </span>            :       // Note that this whole block will be skipped when painting is suppressed
<span class="lineNum">    1064 </span>            :       // (due to our caller ApplyRendingChangeToTree() discarding the
<span class="lineNum">    1065 </span>            :       // nsChangeHint_RepaintFrame hint).  If you add handling for any other
<span class="lineNum">    1066 </span>            :       // hints within this block, be sure that they too should be ignored when
<span class="lineNum">    1067 </span>            :       // painting is suppressed.
<span class="lineNum">    1068 </span><span class="lineCov">         27 :       needInvalidatingPaint = true;</span>
<span class="lineNum">    1069 </span><span class="lineCov">         27 :       aFrame-&gt;InvalidateFrameSubtree();</span>
<span class="lineNum">    1070 </span><span class="lineCov">         54 :       if ((aChange &amp; nsChangeHint_UpdateEffects) &amp;&amp;</span>
<span class="lineNum">    1071 </span><span class="lineCov">         27 :           aFrame-&gt;IsFrameOfType(nsIFrame::eSVG) &amp;&amp;</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :           !(aFrame-&gt;GetStateBits() &amp; NS_STATE_IS_OUTER_SVG)) {</span>
<span class="lineNum">    1073 </span>            :         // Need to update our overflow rects:
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :         nsSVGUtils::ScheduleReflowSVG(aFrame);</span>
<span class="lineNum">    1075 </span>            :       }
<span class="lineNum">    1076 </span>            :     }
<span class="lineNum">    1077 </span><span class="lineCov">         60 :     if (aChange &amp; nsChangeHint_UpdateTextPath) {</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :       if (nsSVGUtils::IsInSVGTextSubtree(aFrame)) {</span>
<span class="lineNum">    1079 </span>            :         // Invalidate and reflow the entire SVGTextFrame:
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :         NS_ASSERTION(aFrame-&gt;GetContent()-&gt;IsSVGElement(nsGkAtoms::textPath),</span>
<span class="lineNum">    1081 </span>            :                      &quot;expected frame for a &lt;textPath&gt; element&quot;);
<span class="lineNum">    1082 </span>            :         nsIFrame* text = nsLayoutUtils::GetClosestFrameOfType(
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :           aFrame, LayoutFrameType::SVGText);</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :         NS_ASSERTION(text, &quot;expected to find an ancestor SVGTextFrame&quot;);</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :         static_cast&lt;SVGTextFrame*&gt;(text)-&gt;NotifyGlyphMetricsChange();</span>
<span class="lineNum">    1086 </span>            :       } else {
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :         MOZ_ASSERT(false, &quot;unexpected frame got nsChangeHint_UpdateTextPath&quot;);</span>
<span class="lineNum">    1088 </span>            :       }
<span class="lineNum">    1089 </span>            :     }
<span class="lineNum">    1090 </span><span class="lineCov">         60 :     if (aChange &amp; nsChangeHint_UpdateOpacityLayer) {</span>
<span class="lineNum">    1091 </span>            :       // FIXME/bug 796697: we can get away with empty transactions for
<span class="lineNum">    1092 </span>            :       // opacity updates in many cases.
<span class="lineNum">    1093 </span><span class="lineCov">         21 :       needInvalidatingPaint = true;</span>
<span class="lineNum">    1094 </span>            : 
<span class="lineNum">    1095 </span><span class="lineCov">         21 :       ActiveLayerTracker::NotifyRestyle(aFrame, eCSSProperty_opacity);</span>
<span class="lineNum">    1096 </span><span class="lineCov">         21 :       if (nsSVGIntegrationUtils::UsingEffectsForFrame(aFrame)) {</span>
<span class="lineNum">    1097 </span>            :         // SVG effects paints the opacity without using
<span class="lineNum">    1098 </span>            :         // nsDisplayOpacity. We need to invalidate manually.
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :         aFrame-&gt;InvalidateFrameSubtree();</span>
<span class="lineNum">    1100 </span>            :       }
<span class="lineNum">    1101 </span>            :     }
<span class="lineNum">    1102 </span><span class="lineCov">         60 :     if ((aChange &amp; nsChangeHint_UpdateTransformLayer) &amp;&amp;</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :         aFrame-&gt;IsTransformed()) {</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :       ActiveLayerTracker::NotifyRestyle(aFrame, eCSSProperty_transform);</span>
<span class="lineNum">    1105 </span>            :       // If we're not already going to do an invalidating paint, see
<span class="lineNum">    1106 </span>            :       // if we can get away with only updating the transform on a
<span class="lineNum">    1107 </span>            :       // layer for this frame, and not scheduling an invalidating
<span class="lineNum">    1108 </span>            :       // paint.
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :       if (!needInvalidatingPaint) {</span>
<span class="lineNum">    1110 </span>            :         Layer* layer;
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :         needInvalidatingPaint |= !aFrame-&gt;TryUpdateTransformOnly(&amp;layer);</span>
<span class="lineNum">    1112 </span>            : 
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :         if (!needInvalidatingPaint) {</span>
<span class="lineNum">    1114 </span>            :           // Since we're not going to paint, we need to resend animation
<span class="lineNum">    1115 </span>            :           // data to the layer.
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :           MOZ_ASSERT(layer, &quot;this can't happen if there's no layer&quot;);</span>
<span class="lineNum">    1117 </span>            :           nsDisplayListBuilder::AddAnimationsAndTransitionsToLayer(
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :             layer, nullptr, nullptr, aFrame, eCSSProperty_transform);</span>
<span class="lineNum">    1119 </span>            :         }
<span class="lineNum">    1120 </span>            :       }
<span class="lineNum">    1121 </span>            :     }
<span class="lineNum">    1122 </span><span class="lineCov">         60 :     if (aChange &amp; nsChangeHint_ChildrenOnlyTransform) {</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :       needInvalidatingPaint = true;</span>
<span class="lineNum">    1124 </span>            :       nsIFrame* childFrame =
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :         GetFrameForChildrenOnlyTransformHint(aFrame)-&gt;PrincipalChildList().FirstChild();</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :       for ( ; childFrame; childFrame = childFrame-&gt;GetNextSibling()) {</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :         ActiveLayerTracker::NotifyRestyle(childFrame, eCSSProperty_transform);</span>
<span class="lineNum">    1128 </span>            :       }
<span class="lineNum">    1129 </span>            :     }
<span class="lineNum">    1130 </span><span class="lineCov">         60 :     if (aChange &amp; nsChangeHint_SchedulePaint) {</span>
<span class="lineNum">    1131 </span><span class="lineCov">         30 :       needInvalidatingPaint = true;</span>
<span class="lineNum">    1132 </span>            :     }
<span class="lineNum">    1133 </span><span class="lineCov">         60 :     aFrame-&gt;SchedulePaint(needInvalidatingPaint</span>
<span class="lineNum">    1134 </span>            :                             ? nsIFrame::PAINT_DEFAULT
<span class="lineNum">    1135 </span><span class="lineCov">         60 :                             : nsIFrame::PAINT_COMPOSITE_ONLY);</span>
<span class="lineNum">    1136 </span>            :   }
<span class="lineNum">    1137 </span><span class="lineCov">         60 : }</span>
<a name="1138"><span class="lineNum">    1138 </span>            : </a>
<span class="lineNum">    1139 </span>            : static void
<span class="lineNum">    1140 </span><span class="lineCov">        163 : SyncViewsAndInvalidateDescendants(nsIFrame* aFrame, nsChangeHint aChange)</span>
<span class="lineNum">    1141 </span>            : {
<span class="lineNum">    1142 </span><span class="lineCov">        163 :   NS_PRECONDITION(gInApplyRenderingChangeToTree,</span>
<span class="lineNum">    1143 </span>            :                   &quot;should only be called within ApplyRenderingChangeToTree&quot;);
<span class="lineNum">    1144 </span><span class="lineCov">        163 :   NS_ASSERTION(nsChangeHint_size_t(aChange) ==</span>
<span class="lineNum">    1145 </span>            :                           (aChange &amp; (nsChangeHint_RepaintFrame |
<span class="lineNum">    1146 </span>            :                                       nsChangeHint_SyncFrameView |
<span class="lineNum">    1147 </span>            :                                       nsChangeHint_UpdateOpacityLayer |
<span class="lineNum">    1148 </span>            :                                       nsChangeHint_SchedulePaint)),
<span class="lineNum">    1149 </span>            :                &quot;Invalid change flag&quot;);
<span class="lineNum">    1150 </span>            : 
<span class="lineNum">    1151 </span><span class="lineCov">        163 :   if (aChange &amp; nsChangeHint_SyncFrameView) {</span>
<span class="lineNum">    1152 </span><span class="lineCov">        108 :     aFrame-&gt;SyncFrameViewProperties();</span>
<span class="lineNum">    1153 </span>            :   }
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span><span class="lineCov">        326 :   nsIFrame::ChildListIterator lists(aFrame);</span>
<span class="lineNum">    1156 </span><span class="lineCov">        343 :   for (; !lists.IsDone(); lists.Next()) {</span>
<span class="lineNum">    1157 </span><span class="lineCov">        211 :     for (nsIFrame* child : lists.CurrentList()) {</span>
<span class="lineNum">    1158 </span><span class="lineCov">        121 :       if (!(child-&gt;GetStateBits() &amp; NS_FRAME_OUT_OF_FLOW)) {</span>
<span class="lineNum">    1159 </span>            :         // only do frames that don't have placeholders
<span class="lineNum">    1160 </span><span class="lineCov">        121 :         if (child-&gt;IsPlaceholderFrame()) {</span>
<span class="lineNum">    1161 </span>            :           // do the out-of-flow frame and its continuations
<span class="lineNum">    1162 </span>            :           nsIFrame* outOfFlowFrame =
<span class="lineNum">    1163 </span><span class="lineCov">          5 :             nsPlaceholderFrame::GetRealFrameForPlaceholder(child);</span>
<span class="lineNum">    1164 </span><span class="lineCov">          5 :           DoApplyRenderingChangeToTree(outOfFlowFrame, aChange);</span>
<span class="lineNum">    1165 </span><span class="lineCov">        116 :         } else if (lists.CurrentID() == nsIFrame::kPopupList) {</span>
<span class="lineNum">    1166 </span><span class="lineCov">         13 :           DoApplyRenderingChangeToTree(child, aChange);</span>
<span class="lineNum">    1167 </span>            :         } else { // regular frame
<span class="lineNum">    1168 </span><span class="lineCov">        103 :           SyncViewsAndInvalidateDescendants(child, aChange);</span>
<span class="lineNum">    1169 </span>            :         }
<span class="lineNum">    1170 </span>            :       }
<span class="lineNum">    1171 </span>            :     }
<span class="lineNum">    1172 </span>            :   }
<span class="lineNum">    1173 </span><span class="lineCov">        163 : }</span>
<a name="1174"><span class="lineNum">    1174 </span>            : </a>
<span class="lineNum">    1175 </span>            : static void
<span class="lineNum">    1176 </span><span class="lineCov">         51 : ApplyRenderingChangeToTree(nsIPresShell* aPresShell,</span>
<span class="lineNum">    1177 </span>            :                            nsIFrame* aFrame,
<span class="lineNum">    1178 </span>            :                            nsChangeHint aChange)
<span class="lineNum">    1179 </span>            : {
<span class="lineNum">    1180 </span>            :   // We check StyleDisplay()-&gt;HasTransformStyle() in addition to checking
<span class="lineNum">    1181 </span>            :   // IsTransformed() since we can get here for some frames that don't support
<span class="lineNum">    1182 </span>            :   // CSS transforms.
<span class="lineNum">    1183 </span><span class="lineCov">         51 :   NS_ASSERTION(!(aChange &amp; nsChangeHint_UpdateTransformLayer) ||</span>
<span class="lineNum">    1184 </span>            :                aFrame-&gt;IsTransformed() ||
<span class="lineNum">    1185 </span>            :                aFrame-&gt;StyleDisplay()-&gt;HasTransformStyle(),
<span class="lineNum">    1186 </span>            :                &quot;Unexpected UpdateTransformLayer hint&quot;);
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineCov">         51 :   if (aPresShell-&gt;IsPaintingSuppressed()) {</span>
<span class="lineNum">    1189 </span>            :     // Don't allow synchronous rendering changes when painting is turned off.
<span class="lineNum">    1190 </span><span class="lineCov">         17 :     aChange &amp;= ~nsChangeHint_RepaintFrame;</span>
<span class="lineNum">    1191 </span><span class="lineCov">         17 :     if (!aChange) {</span>
<span class="lineNum">    1192 </span><span class="lineCov">          9 :       return;</span>
<span class="lineNum">    1193 </span>            :     }
<span class="lineNum">    1194 </span>            :   }
<span class="lineNum">    1195 </span>            : 
<span class="lineNum">    1196 </span>            : // Trigger rendering updates by damaging this frame and any
<span class="lineNum">    1197 </span>            : // continuations of this frame.
<span class="lineNum">    1198 </span>            : #ifdef DEBUG
<span class="lineNum">    1199 </span><span class="lineCov">         42 :   gInApplyRenderingChangeToTree = true;</span>
<span class="lineNum">    1200 </span>            : #endif
<span class="lineNum">    1201 </span><span class="lineCov">         42 :   if (aChange &amp; nsChangeHint_RepaintFrame) {</span>
<span class="lineNum">    1202 </span>            :     // If the frame's background is propagated to an ancestor, walk up to
<span class="lineNum">    1203 </span>            :     // that ancestor and apply the RepaintFrame change hint to it.
<span class="lineNum">    1204 </span>            :     nsStyleContext* bgSC;
<span class="lineNum">    1205 </span><span class="lineCov">         16 :     nsIFrame* propagatedFrame = aFrame;</span>
<span class="lineNum">    1206 </span><span class="lineCov">         16 :     while (!nsCSSRendering::FindBackground(propagatedFrame, &amp;bgSC)) {</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :       propagatedFrame = propagatedFrame-&gt;GetParent();</span>
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :       NS_ASSERTION(aFrame, &quot;root frame must paint&quot;);</span>
<span class="lineNum">    1209 </span>            :     }
<span class="lineNum">    1210 </span>            : 
<span class="lineNum">    1211 </span><span class="lineCov">         16 :     if (propagatedFrame != aFrame) {</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :       DoApplyRenderingChangeToTree(propagatedFrame, nsChangeHint_RepaintFrame);</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :       aChange &amp;= ~nsChangeHint_RepaintFrame;</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :       if (!aChange) {</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1216 </span>            :       }
<span class="lineNum">    1217 </span>            :     }
<span class="lineNum">    1218 </span>            :   }
<span class="lineNum">    1219 </span><span class="lineCov">         42 :   DoApplyRenderingChangeToTree(aFrame, aChange);</span>
<span class="lineNum">    1220 </span>            : #ifdef DEBUG
<span class="lineNum">    1221 </span><span class="lineCov">         42 :   gInApplyRenderingChangeToTree = false;</span>
<span class="lineNum">    1222 </span>            : #endif
<span class="lineNum">    1223 </span>            : }
<a name="1224"><span class="lineNum">    1224 </span>            : </a>
<span class="lineNum">    1225 </span>            : static void
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 : AddSubtreeToOverflowTracker(nsIFrame* aFrame,</span>
<span class="lineNum">    1227 </span>            :                             OverflowChangedTracker&amp; aOverflowChangedTracker)
<span class="lineNum">    1228 </span>            : {
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :   if (aFrame-&gt;FrameMaintainsOverflow()) {</span>
<span class="lineNum">    1230 </span>            :     aOverflowChangedTracker.AddFrame(aFrame,
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :                                      OverflowChangedTracker::CHILDREN_CHANGED);</span>
<span class="lineNum">    1232 </span>            :   }
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :   nsIFrame::ChildListIterator lists(aFrame);</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :   for (; !lists.IsDone(); lists.Next()) {</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :     for (nsIFrame* child : lists.CurrentList()) {</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :       AddSubtreeToOverflowTracker(child, aOverflowChangedTracker);</span>
<span class="lineNum">    1237 </span>            :     }
<span class="lineNum">    1238 </span>            :   }
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 : }</span>
<a name="1240"><span class="lineNum">    1240 </span>            : </a>
<span class="lineNum">    1241 </span>            : static void
<span class="lineNum">    1242 </span><span class="lineCov">         28 : StyleChangeReflow(nsIFrame* aFrame, nsChangeHint aHint)</span>
<span class="lineNum">    1243 </span>            : {
<span class="lineNum">    1244 </span>            :   nsIPresShell::IntrinsicDirty dirtyType;
<span class="lineNum">    1245 </span><span class="lineCov">         28 :   if (aHint &amp; nsChangeHint_ClearDescendantIntrinsics) {</span>
<span class="lineNum">    1246 </span><span class="lineCov">         24 :     NS_ASSERTION(aHint &amp; nsChangeHint_ClearAncestorIntrinsics,</span>
<span class="lineNum">    1247 </span>            :                  &quot;Please read the comments in nsChangeHint.h&quot;);
<span class="lineNum">    1248 </span><span class="lineCov">         24 :     NS_ASSERTION(aHint &amp; nsChangeHint_NeedDirtyReflow,</span>
<span class="lineNum">    1249 </span>            :                  &quot;ClearDescendantIntrinsics requires NeedDirtyReflow&quot;);
<span class="lineNum">    1250 </span><span class="lineCov">         24 :     dirtyType = nsIPresShell::eStyleChange;</span>
<span class="lineNum">    1251 </span><span class="lineCov">          4 :   } else if ((aHint &amp; nsChangeHint_UpdateComputedBSize) &amp;&amp;</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :              aFrame-&gt;HasAnyStateBits(</span>
<span class="lineNum">    1253 </span>            :                NS_FRAME_DESCENDANT_INTRINSIC_ISIZE_DEPENDS_ON_BSIZE)) {
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :     dirtyType = nsIPresShell::eStyleChange;</span>
<span class="lineNum">    1255 </span><span class="lineCov">          4 :   } else if (aHint &amp; nsChangeHint_ClearAncestorIntrinsics) {</span>
<span class="lineNum">    1256 </span><span class="lineCov">          2 :     dirtyType = nsIPresShell::eTreeChange;</span>
<span class="lineNum">    1257 </span><span class="lineCov">          2 :   } else if ((aHint &amp; nsChangeHint_UpdateComputedBSize) &amp;&amp;</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :              HasBoxAncestor(aFrame)) {</span>
<span class="lineNum">    1259 </span>            :     // The frame's computed BSize is changing, and we have a box ancestor
<span class="lineNum">    1260 </span>            :     // whose cached intrinsic height may need to be updated.
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :     dirtyType = nsIPresShell::eTreeChange;</span>
<span class="lineNum">    1262 </span>            :   } else {
<span class="lineNum">    1263 </span><span class="lineCov">          2 :     dirtyType = nsIPresShell::eResize;</span>
<span class="lineNum">    1264 </span>            :   }
<span class="lineNum">    1265 </span>            : 
<span class="lineNum">    1266 </span>            :   nsFrameState dirtyBits;
<span class="lineNum">    1267 </span><span class="lineCov">         28 :   if (aFrame-&gt;GetStateBits() &amp; NS_FRAME_FIRST_REFLOW) {</span>
<span class="lineNum">    1268 </span><span class="lineCov">          2 :     dirtyBits = nsFrameState(0);</span>
<span class="lineNum">    1269 </span><span class="lineCov">         26 :   } else if ((aHint &amp; nsChangeHint_NeedDirtyReflow) ||</span>
<span class="lineNum">    1270 </span>            :              dirtyType == nsIPresShell::eStyleChange) {
<span class="lineNum">    1271 </span><span class="lineCov">         24 :     dirtyBits = NS_FRAME_IS_DIRTY;</span>
<span class="lineNum">    1272 </span>            :   } else {
<span class="lineNum">    1273 </span><span class="lineCov">          2 :     dirtyBits = NS_FRAME_HAS_DIRTY_CHILDREN;</span>
<span class="lineNum">    1274 </span>            :   }
<span class="lineNum">    1275 </span>            : 
<span class="lineNum">    1276 </span>            :   // If we're not going to clear any intrinsic sizes on the frames, and
<span class="lineNum">    1277 </span>            :   // there are no dirty bits to set, then there's nothing to do.
<span class="lineNum">    1278 </span><span class="lineCov">         28 :   if (dirtyType == nsIPresShell::eResize &amp;&amp; !dirtyBits)</span>
<span class="lineNum">    1279 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    1280 </span>            : 
<span class="lineNum">    1281 </span>            :   nsIPresShell::ReflowRootHandling rootHandling;
<span class="lineNum">    1282 </span><span class="lineCov">         27 :   if (aHint &amp; nsChangeHint_ReflowChangesSizeOrPosition) {</span>
<span class="lineNum">    1283 </span><span class="lineCov">         26 :     rootHandling = nsIPresShell::ePositionOrSizeChange;</span>
<span class="lineNum">    1284 </span>            :   } else {
<span class="lineNum">    1285 </span><span class="lineCov">          1 :     rootHandling = nsIPresShell::eNoPositionOrSizeChange;</span>
<span class="lineNum">    1286 </span>            :   }
<span class="lineNum">    1287 </span>            : 
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    1289 </span><span class="lineCov">         27 :     aFrame-&gt;PresContext()-&gt;PresShell()-&gt;FrameNeedsReflow(</span>
<span class="lineNum">    1290 </span><span class="lineCov">         27 :       aFrame, dirtyType, dirtyBits, rootHandling);</span>
<span class="lineNum">    1291 </span><span class="lineCov">         27 :     aFrame = nsLayoutUtils::GetNextContinuationOrIBSplitSibling(aFrame);</span>
<span class="lineNum">    1292 </span><span class="lineCov">         27 :   } while (aFrame);</span>
<span class="lineNum">    1293 </span>            : }
<a name="1294"><span class="lineNum">    1294 </span>            : </a>
<span class="lineNum">    1295 </span>            : /* static */ nsIFrame*
<span class="lineNum">    1296 </span><span class="lineCov">       2550 : RestyleManager::GetNextContinuationWithSameStyle(</span>
<span class="lineNum">    1297 </span>            :   nsIFrame* aFrame, nsStyleContext* aOldStyleContext,
<span class="lineNum">    1298 </span>            :   bool* aHaveMoreContinuations)
<span class="lineNum">    1299 </span>            : {
<span class="lineNum">    1300 </span>            :   // See GetPrevContinuationWithSameStyle about {ib} splits.
<span class="lineNum">    1301 </span>            : 
<span class="lineNum">    1302 </span><span class="lineCov">       2550 :   nsIFrame* nextContinuation = aFrame-&gt;GetNextContinuation();</span>
<span class="lineNum">    1303 </span><span class="lineCov">       5100 :   if (!nextContinuation &amp;&amp;</span>
<span class="lineNum">    1304 </span><span class="lineCov">       2550 :       (aFrame-&gt;GetStateBits() &amp; NS_FRAME_PART_OF_IBSPLIT)) {</span>
<span class="lineNum">    1305 </span>            :     // We're the last continuation, so we have to hop back to the first
<span class="lineNum">    1306 </span>            :     // before getting the frame property
<span class="lineNum">    1307 </span>            :     nextContinuation =
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :       aFrame-&gt;FirstContinuation()-&gt;GetProperty(nsIFrame::IBSplitSibling());</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :     if (nextContinuation) {</span>
<span class="lineNum">    1310 </span>            :       nextContinuation =
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :         nextContinuation-&gt;GetProperty(nsIFrame::IBSplitSibling());</span>
<span class="lineNum">    1312 </span>            :     }
<span class="lineNum">    1313 </span>            :   }
<span class="lineNum">    1314 </span>            : 
<span class="lineNum">    1315 </span><span class="lineCov">       2550 :   if (!nextContinuation) {</span>
<span class="lineNum">    1316 </span><span class="lineCov">       2550 :     return nullptr;</span>
<span class="lineNum">    1317 </span>            :   }
<span class="lineNum">    1318 </span>            : 
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :   NS_ASSERTION(nextContinuation-&gt;GetContent() == aFrame-&gt;GetContent(),</span>
<span class="lineNum">    1320 </span>            :                &quot;unexpected content mismatch&quot;);
<span class="lineNum">    1321 </span>            : 
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :   nsStyleContext* nextStyle = nextContinuation-&gt;StyleContext();</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :   if (nextStyle != aOldStyleContext) {</span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :     NS_ASSERTION(aOldStyleContext-&gt;GetPseudo() != nextStyle-&gt;GetPseudo() ||</span>
<span class="lineNum">    1325 </span>            :                  aOldStyleContext-&gt;GetParentAllowServo() !=
<span class="lineNum">    1326 </span>            :                    nextStyle-&gt;GetParentAllowServo(),
<span class="lineNum">    1327 </span>            :                  &quot;continuations should have the same style context&quot;);
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :     nextContinuation = nullptr;</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :     if (aHaveMoreContinuations) {</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :       *aHaveMoreContinuations = true;</span>
<span class="lineNum">    1331 </span>            :     }
<span class="lineNum">    1332 </span>            :   }
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :   return nextContinuation;</span>
<span class="lineNum">    1334 </span>            : }
<a name="1335"><span class="lineNum">    1335 </span>            : </a>
<span class="lineNum">    1336 </span>            : void
<span class="lineNum">    1337 </span><span class="lineCov">         72 : RestyleManager::ProcessRestyledFrames(nsStyleChangeList&amp; aChangeList)</span>
<span class="lineNum">    1338 </span>            : {
<span class="lineNum">    1339 </span><span class="lineCov">         72 :   NS_ASSERTION(!nsContentUtils::IsSafeToRunScript(),</span>
<span class="lineNum">    1340 </span>            :                &quot;Someone forgot a script blocker&quot;);
<span class="lineNum">    1341 </span><span class="lineCov">         72 :   MOZ_ASSERT(!mDestroyedFrames);</span>
<span class="lineNum">    1342 </span>            : 
<span class="lineNum">    1343 </span><span class="lineCov">         72 :   if (aChangeList.IsEmpty()) {</span>
<span class="lineNum">    1344 </span><span class="lineCov">         19 :     return;</span>
<span class="lineNum">    1345 </span>            :   }
<span class="lineNum">    1346 </span>            : 
<span class="lineNum">    1347 </span><span class="lineCov">         53 :   mDestroyedFrames = MakeUnique&lt;nsTHashtable&lt;nsPtrHashKey&lt;const nsIFrame&gt;&gt;&gt;();</span>
<span class="lineNum">    1348 </span>            : 
<span class="lineNum">    1349 </span><span class="lineCov">        106 :   AUTO_PROFILER_LABEL(&quot;RestyleManager::ProcessRestyledFrames&quot;, CSS);</span>
<span class="lineNum">    1350 </span>            : 
<span class="lineNum">    1351 </span><span class="lineCov">         53 :   nsPresContext* presContext = PresContext();</span>
<span class="lineNum">    1352 </span><span class="lineCov">         53 :   nsCSSFrameConstructor* frameConstructor = presContext-&gt;FrameConstructor();</span>
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span>            :   // Handle nsChangeHint_CSSOverflowChange, by either updating the
<span class="lineNum">    1355 </span>            :   // scrollbars on the viewport, or upgrading the change hint to frame-reconstruct.
<span class="lineNum">    1356 </span><span class="lineCov">        149 :   for (nsStyleChangeData&amp; data : aChangeList) {</span>
<span class="lineNum">    1357 </span><span class="lineCov">         96 :     if (data.mHint &amp; nsChangeHint_CSSOverflowChange) {</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :       data.mHint &amp;= ~nsChangeHint_CSSOverflowChange;</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :       bool doReconstruct = true; // assume the worst</span>
<span class="lineNum">    1360 </span>            : 
<span class="lineNum">    1361 </span>            :       // Only bother with this if we're html/body, since:
<span class="lineNum">    1362 </span>            :       //  (a) It'd be *expensive* to reframe these particular nodes.  They're
<span class="lineNum">    1363 </span>            :       //      at the root, so reframing would mean rebuilding the world.
<span class="lineNum">    1364 </span>            :       //  (b) It's often *unnecessary* to reframe for &quot;overflow&quot; changes on
<span class="lineNum">    1365 </span>            :       //      these particular nodes.  In general, the only reason we reframe
<span class="lineNum">    1366 </span>            :       //      for &quot;overflow&quot; changes is so we can construct (or destroy) a
<span class="lineNum">    1367 </span>            :       //      scrollframe &amp; scrollbars -- and the html/body nodes often don't
<span class="lineNum">    1368 </span>            :       //      need their own scrollframe/scrollbars because they coopt the ones
<span class="lineNum">    1369 </span>            :       //      on the viewport (which always exist). So depending on whether
<span class="lineNum">    1370 </span>            :       //      that's happening, we can skip the reframe for these nodes.
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :       if (data.mContent-&gt;IsAnyOfHTMLElements(nsGkAtoms::body,</span>
<span class="lineNum">    1372 </span>            :                                              nsGkAtoms::html)) {
<span class="lineNum">    1373 </span>            :         // If the restyled element provided/provides the scrollbar styles for
<span class="lineNum">    1374 </span>            :         // the viewport before and/or after this restyle, AND it's not coopting
<span class="lineNum">    1375 </span>            :         // that responsibility from some other element (which would need
<span class="lineNum">    1376 </span>            :         // reconstruction to make its own scrollframe now), THEN: we don't need
<span class="lineNum">    1377 </span>            :         // to reconstruct - we can just reflow, because no scrollframe is being
<span class="lineNum">    1378 </span>            :         // added/removed.
<span class="lineNum">    1379 </span>            :         nsIContent* prevOverrideNode =
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :           presContext-&gt;GetViewportScrollbarStylesOverrideNode();</span>
<span class="lineNum">    1381 </span>            :         nsIContent* newOverrideNode =
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :           presContext-&gt;UpdateViewportScrollbarStylesOverride();</span>
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :         if (data.mContent == prevOverrideNode ||</span>
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :             data.mContent == newOverrideNode) {</span>
<span class="lineNum">    1386 </span>            :           // If we get here, the restyled element provided the scrollbar styles
<span class="lineNum">    1387 </span>            :           // for viewport before this restyle, OR it will provide them after.
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :           if (!prevOverrideNode || !newOverrideNode ||</span>
<span class="lineNum">    1389 </span>            :               prevOverrideNode == newOverrideNode) {
<span class="lineNum">    1390 </span>            :             // If we get here, the restyled element is NOT replacing (or being
<span class="lineNum">    1391 </span>            :             // replaced by) some other element as the viewport's
<span class="lineNum">    1392 </span>            :             // scrollbar-styles provider. (If it were, we'd potentially need to
<span class="lineNum">    1393 </span>            :             // reframe to create a dedicated scrollframe for whichever element
<span class="lineNum">    1394 </span>            :             // is being booted from providing viewport scrollbar styles.)
<span class="lineNum">    1395 </span>            :             //
<span class="lineNum">    1396 </span>            :             // Under these conditions, we're OK to assume that this &quot;overflow&quot;
<span class="lineNum">    1397 </span>            :             // change only impacts the root viewport's scrollframe, which
<span class="lineNum">    1398 </span>            :             // already exists, so we can simply reflow instead of reframing.
<span class="lineNum">    1399 </span>            :             // When requesting this reflow, we send the exact same change hints
<span class="lineNum">    1400 </span>            :             // that &quot;width&quot; and &quot;height&quot; would send (since conceptually,
<span class="lineNum">    1401 </span>            :             // adding/removing scrollbars is like changing the available
<span class="lineNum">    1402 </span>            :             // space).
<span class="lineNum">    1403 </span>            :             data.mHint |= (nsChangeHint_ReflowHintsForISizeChange |
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :                            nsChangeHint_ReflowHintsForBSizeChange);</span>
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :             doReconstruct = false;</span>
<span class="lineNum">    1406 </span>            :           }
<span class="lineNum">    1407 </span>            :         }
<span class="lineNum">    1408 </span>            :       }
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :       if (doReconstruct) {</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :         data.mHint |= nsChangeHint_ReconstructFrame;</span>
<span class="lineNum">    1411 </span>            :       }
<span class="lineNum">    1412 </span>            :     }
<span class="lineNum">    1413 </span>            :   }
<span class="lineNum">    1414 </span>            : 
<span class="lineNum">    1415 </span>            :   // Make sure to not rebuild quote or counter lists while we're
<span class="lineNum">    1416 </span>            :   // processing restyles
<span class="lineNum">    1417 </span><span class="lineCov">         53 :   frameConstructor-&gt;BeginUpdate();</span>
<span class="lineNum">    1418 </span>            : 
<span class="lineNum">    1419 </span><span class="lineCov">         53 :   bool didUpdateCursor = false;</span>
<span class="lineNum">    1420 </span>            : 
<span class="lineNum">    1421 </span><span class="lineCov">        149 :   for (size_t i = 0; i &lt; aChangeList.Length(); ++i) {</span>
<span class="lineNum">    1422 </span>            : 
<span class="lineNum">    1423 </span>            :     // Collect and coalesce adjacent siblings for lazy frame construction.
<span class="lineNum">    1424 </span>            :     // Eventually it would be even better to make RecreateFramesForContent
<span class="lineNum">    1425 </span>            :     // accept a range and coalesce all adjacent reconstructs (bug 1344139).
<span class="lineNum">    1426 </span><span class="lineCov">         96 :     size_t lazyRangeStart = i;</span>
<span class="lineNum">    1427 </span><span class="lineCov">        288 :     while (i &lt; aChangeList.Length() &amp;&amp;</span>
<span class="lineNum">    1428 </span><span class="lineCov">        191 :            aChangeList[i].mContent &amp;&amp;</span>
<span class="lineNum">    1429 </span><span class="lineCov">        191 :            aChangeList[i].mContent-&gt;HasFlag(NODE_NEEDS_FRAME) &amp;&amp;</span>
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :            (i == lazyRangeStart ||</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :             aChangeList[i - 1].mContent-&gt;GetNextSibling() == aChangeList[i].mContent))</span>
<span class="lineNum">    1432 </span>            :     {
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :       MOZ_ASSERT(aChangeList[i].mHint &amp; nsChangeHint_ReconstructFrame);</span>
<span class="lineNum">    1434 </span><span class="lineNoCov">          0 :       MOZ_ASSERT(!aChangeList[i].mFrame);</span>
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :       ++i;</span>
<span class="lineNum">    1436 </span>            :     }
<span class="lineNum">    1437 </span><span class="lineCov">         96 :     if (i != lazyRangeStart) {</span>
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :       nsIContent* start = aChangeList[lazyRangeStart].mContent;</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :       nsIContent* end = aChangeList[i-1].mContent-&gt;GetNextSibling();</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :       nsIContent* container = start-&gt;GetParent();</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :       MOZ_ASSERT(container);</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :       if (!end) {</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :         frameConstructor-&gt;ContentAppended(container, start, false);</span>
<span class="lineNum">    1444 </span>            :       } else {
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :         frameConstructor-&gt;ContentRangeInserted(container, start, end, nullptr, false);</span>
<span class="lineNum">    1446 </span>            :       }
<span class="lineNum">    1447 </span>            :     }
<span class="lineNum">    1448 </span><span class="lineCov">         96 :     for (size_t j = lazyRangeStart; j &lt; i; ++j) {</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :       MOZ_ASSERT(!aChangeList[j].mContent-&gt;GetPrimaryFrame() ||</span>
<span class="lineNum">    1450 </span>            :                  !aChangeList[j].mContent-&gt;HasFlag(NODE_NEEDS_FRAME));
<span class="lineNum">    1451 </span>            :     }
<span class="lineNum">    1452 </span><span class="lineCov">         96 :     if (i == aChangeList.Length()) {</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1454 </span>            :     }
<span class="lineNum">    1455 </span>            : 
<span class="lineNum">    1456 </span><span class="lineCov">         96 :     nsStyleChangeData&amp; mutable_data = aChangeList[i];</span>
<span class="lineNum">    1457 </span><span class="lineCov">         96 :     const nsStyleChangeData&amp; data = mutable_data;</span>
<span class="lineNum">    1458 </span><span class="lineCov">         96 :     nsIFrame* frame = data.mFrame;</span>
<span class="lineNum">    1459 </span><span class="lineCov">         96 :     nsIContent* content = data.mContent;</span>
<span class="lineNum">    1460 </span><span class="lineCov">         96 :     nsChangeHint hint = data.mHint;</span>
<span class="lineNum">    1461 </span><span class="lineCov">         96 :     bool didReflowThisFrame = false;</span>
<span class="lineNum">    1462 </span>            : 
<span class="lineNum">    1463 </span><span class="lineCov">         96 :     NS_ASSERTION(!(hint &amp; nsChangeHint_AllReflowHints) ||</span>
<span class="lineNum">    1464 </span>            :                  (hint &amp; nsChangeHint_NeedReflow),
<span class="lineNum">    1465 </span>            :                  &quot;Reflow hint bits set without actually asking for a reflow&quot;);
<span class="lineNum">    1466 </span>            : 
<span class="lineNum">    1467 </span>            :     // skip any frame that has been destroyed due to a ripple effect
<span class="lineNum">    1468 </span><span class="lineCov">         96 :     if (frame &amp;&amp; mDestroyedFrames-&gt;Contains(frame)) {</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    1470 </span>            :     }
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span><span class="lineCov">         96 :     if (frame &amp;&amp; frame-&gt;GetContent() != content) {</span>
<span class="lineNum">    1473 </span>            :       // XXXbz this is due to image maps messing with the primary frame of
<span class="lineNum">    1474 </span>            :       // &lt;area&gt;s.  See bug 135040.  Remove this block once that's fixed.
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :       frame = nullptr;</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :       if (!(hint &amp; nsChangeHint_ReconstructFrame)) {</span>
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1478 </span>            :       }
<span class="lineNum">    1479 </span>            :     }
<span class="lineNum">    1480 </span>            : 
<span class="lineNum">    1481 </span><span class="lineCov">         98 :     if ((hint &amp; nsChangeHint_UpdateContainingBlock) &amp;&amp; frame &amp;&amp;</span>
<span class="lineNum">    1482 </span><span class="lineCov">          2 :         !(hint &amp; nsChangeHint_ReconstructFrame)) {</span>
<span class="lineNum">    1483 </span><span class="lineCov">          6 :       if (NeedToReframeForAddingOrRemovingTransform(frame) ||</span>
<span class="lineNum">    1484 </span><span class="lineCov">          4 :           frame-&gt;IsFieldSetFrame() ||</span>
<span class="lineNum">    1485 </span><span class="lineCov">          2 :           frame-&gt;GetContentInsertionFrame() != frame) {</span>
<span class="lineNum">    1486 </span>            :         // The frame has positioned children that need to be reparented, or
<span class="lineNum">    1487 </span>            :         // it can't easily be converted to/from being an abs-pos container correctly.
<span class="lineNum">    1488 </span><span class="lineCov">          2 :         hint |= nsChangeHint_ReconstructFrame;</span>
<span class="lineNum">    1489 </span>            :       } else {
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :         for (nsIFrame* cont = frame; cont;</span>
<span class="lineNum">    1491 </span>            :              cont = nsLayoutUtils::GetNextContinuationOrIBSplitSibling(cont)) {
<span class="lineNum">    1492 </span>            :           // Normally frame construction would set state bits as needed,
<span class="lineNum">    1493 </span>            :           // but we're not going to reconstruct the frame so we need to set them.
<span class="lineNum">    1494 </span>            :           // It's because we need to set this state on each affected frame
<span class="lineNum">    1495 </span>            :           // that we can't coalesce nsChangeHint_UpdateContainingBlock hints up
<span class="lineNum">    1496 </span>            :           // to ancestors (i.e. it can't be an change hint that is handled for
<span class="lineNum">    1497 </span>            :           // descendants).
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :           if (cont-&gt;IsAbsPosContainingBlock()) {</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :             if (!cont-&gt;IsAbsoluteContainer() &amp;&amp;</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :                 (cont-&gt;GetStateBits() &amp; NS_FRAME_CAN_HAVE_ABSPOS_CHILDREN)) {</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :               cont-&gt;MarkAsAbsoluteContainingBlock();</span>
<span class="lineNum">    1502 </span>            :             }
<span class="lineNum">    1503 </span>            :           } else {
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :             if (cont-&gt;IsAbsoluteContainer()) {</span>
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :               if (cont-&gt;HasAbsolutelyPositionedChildren()) {</span>
<span class="lineNum">    1506 </span>            :                 // If |cont| still has absolutely positioned children,
<span class="lineNum">    1507 </span>            :                 // we can't call MarkAsNotAbsoluteContainingBlock.  This
<span class="lineNum">    1508 </span>            :                 // will remove a frame list that still has children in
<span class="lineNum">    1509 </span>            :                 // it that we need to keep track of.
<span class="lineNum">    1510 </span>            :                 // The optimization of removing it isn't particularly
<span class="lineNum">    1511 </span>            :                 // important, although it does mean we skip some tests.
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :                 NS_WARNING(&quot;skipping removal of absolute containing block&quot;);</span>
<span class="lineNum">    1513 </span>            :               } else {
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :                 cont-&gt;MarkAsNotAbsoluteContainingBlock();</span>
<span class="lineNum">    1515 </span>            :               }
<span class="lineNum">    1516 </span>            :             }
<span class="lineNum">    1517 </span>            :           }
<span class="lineNum">    1518 </span>            :         }
<span class="lineNum">    1519 </span>            :       }
<span class="lineNum">    1520 </span>            :     }
<span class="lineNum">    1521 </span>            : 
<span class="lineNum">    1522 </span><span class="lineCov">         98 :     if ((hint &amp; nsChangeHint_AddOrRemoveTransform) &amp;&amp; frame &amp;&amp;</span>
<span class="lineNum">    1523 </span><span class="lineCov">          2 :         !(hint &amp; nsChangeHint_ReconstructFrame)) {</span>
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :       for (nsIFrame* cont = frame; cont;</span>
<span class="lineNum">    1525 </span>            :            cont = nsLayoutUtils::GetNextContinuationOrIBSplitSibling(cont)) {
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :         if (cont-&gt;StyleDisplay()-&gt;HasTransform(cont)) {</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :           cont-&gt;AddStateBits(NS_FRAME_MAY_BE_TRANSFORMED);</span>
<span class="lineNum">    1528 </span>            :         }
<span class="lineNum">    1529 </span>            :         // Don't remove NS_FRAME_MAY_BE_TRANSFORMED since it may still be
<span class="lineNum">    1530 </span>            :         // transformed by other means. It's OK to have the bit even if it's
<span class="lineNum">    1531 </span>            :         // not needed.
<span class="lineNum">    1532 </span>            :       }
<span class="lineNum">    1533 </span>            :     }
<span class="lineNum">    1534 </span>            : 
<span class="lineNum">    1535 </span><span class="lineCov">         96 :     if (hint &amp; nsChangeHint_ReconstructFrame) {</span>
<span class="lineNum">    1536 </span>            :       // If we ever start passing true here, be careful of restyles
<span class="lineNum">    1537 </span>            :       // that involve a reframe and animations.  In particular, if the
<span class="lineNum">    1538 </span>            :       // restyle we're processing here is an animation restyle, but
<span class="lineNum">    1539 </span>            :       // the style resolution we will do for the frame construction
<span class="lineNum">    1540 </span>            :       // happens async when we're not in an animation restyle already,
<span class="lineNum">    1541 </span>            :       // problems could arise.
<span class="lineNum">    1542 </span>            :       // We could also have problems with triggering of CSS transitions
<span class="lineNum">    1543 </span>            :       // on elements whose frames are reconstructed, since we depend on
<span class="lineNum">    1544 </span>            :       // the reconstruction happening synchronously.
<span class="lineNum">    1545 </span>            :       frameConstructor-&gt;RecreateFramesForContent(content, false,
<span class="lineNum">    1546 </span><span class="lineCov">         15 :         nsCSSFrameConstructor::REMOVE_FOR_RECONSTRUCTION, nullptr);</span>
<span class="lineNum">    1547 </span>            :     } else {
<span class="lineNum">    1548 </span><span class="lineCov">         81 :       NS_ASSERTION(frame, &quot;This shouldn't happen&quot;);</span>
<span class="lineNum">    1549 </span>            : 
<span class="lineNum">    1550 </span><span class="lineCov">         81 :       if (!frame-&gt;FrameMaintainsOverflow()) {</span>
<span class="lineNum">    1551 </span>            :         // frame does not maintain overflow rects, so avoid calling
<span class="lineNum">    1552 </span>            :         // FinishAndStoreOverflow on it:
<span class="lineNum">    1553 </span>            :         hint &amp;= ~(nsChangeHint_UpdateOverflow |
<span class="lineNum">    1554 </span>            :                   nsChangeHint_ChildrenOnlyTransform |
<span class="lineNum">    1555 </span>            :                   nsChangeHint_UpdatePostTransformOverflow |
<span class="lineNum">    1556 </span><span class="lineCov">          6 :                   nsChangeHint_UpdateParentOverflow);</span>
<span class="lineNum">    1557 </span>            :       }
<span class="lineNum">    1558 </span>            : 
<span class="lineNum">    1559 </span><span class="lineCov">         81 :       if (!(frame-&gt;GetStateBits() &amp; NS_FRAME_MAY_BE_TRANSFORMED)) {</span>
<span class="lineNum">    1560 </span>            :         // Frame can not be transformed, and thus a change in transform will
<span class="lineNum">    1561 </span>            :         // have no effect and we should not use the
<span class="lineNum">    1562 </span>            :         // nsChangeHint_UpdatePostTransformOverflow hint.
<span class="lineNum">    1563 </span><span class="lineCov">         50 :         hint &amp;= ~nsChangeHint_UpdatePostTransformOverflow;</span>
<span class="lineNum">    1564 </span>            :       }
<span class="lineNum">    1565 </span>            : 
<span class="lineNum">    1566 </span><span class="lineCov">         81 :       if (hint &amp; nsChangeHint_UpdateEffects) {</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :         for (nsIFrame* cont = frame; cont;</span>
<span class="lineNum">    1568 </span>            :              cont = nsLayoutUtils::GetNextContinuationOrIBSplitSibling(cont)) {
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :           nsSVGEffects::UpdateEffects(cont);</span>
<span class="lineNum">    1570 </span>            :         }
<span class="lineNum">    1571 </span>            :       }
<span class="lineNum">    1572 </span><span class="lineCov">        162 :       if ((hint &amp; nsChangeHint_InvalidateRenderingObservers) ||</span>
<span class="lineNum">    1573 </span><span class="lineCov">         79 :           ((hint &amp; nsChangeHint_UpdateOpacityLayer) &amp;&amp;</span>
<span class="lineNum">    1574 </span><span class="lineCov">         21 :            frame-&gt;IsFrameOfType(nsIFrame::eSVG) &amp;&amp;</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :            !(frame-&gt;GetStateBits() &amp; NS_STATE_IS_OUTER_SVG))) {</span>
<span class="lineNum">    1576 </span><span class="lineCov">         23 :         nsSVGEffects::InvalidateRenderingObservers(frame);</span>
<span class="lineNum">    1577 </span>            :       }
<span class="lineNum">    1578 </span><span class="lineCov">         81 :       if (hint &amp; nsChangeHint_NeedReflow) {</span>
<span class="lineNum">    1579 </span><span class="lineCov">         28 :         StyleChangeReflow(frame, hint);</span>
<span class="lineNum">    1580 </span><span class="lineCov">         28 :         didReflowThisFrame = true;</span>
<span class="lineNum">    1581 </span>            :       }
<span class="lineNum">    1582 </span>            : 
<span class="lineNum">    1583 </span><span class="lineCov">         98 :       if ((hint &amp; nsChangeHint_UpdateUsesOpacity) &amp;&amp;</span>
<span class="lineNum">    1584 </span><span class="lineCov">         17 :           frame-&gt;IsFrameOfType(nsIFrame::eTablePart)) {</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :         NS_ASSERTION(hint &amp; nsChangeHint_UpdateOpacityLayer,</span>
<span class="lineNum">    1586 </span>            :                      &quot;should only return UpdateUsesOpacity hint &quot;
<span class="lineNum">    1587 </span>            :                      &quot;when also returning UpdateOpacityLayer hint&quot;);
<span class="lineNum">    1588 </span>            :         // When an internal table part (including cells) changes between
<span class="lineNum">    1589 </span>            :         // having opacity 1 and non-1, it changes whether its
<span class="lineNum">    1590 </span>            :         // backgrounds (and those of table parts inside of it) are
<span class="lineNum">    1591 </span>            :         // painted as part of the table's nsDisplayTableBorderBackground
<span class="lineNum">    1592 </span>            :         // display item, or part of its own display item.  That requires
<span class="lineNum">    1593 </span>            :         // invalidation, so change UpdateOpacityLayer to RepaintFrame.
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :         hint &amp;= ~nsChangeHint_UpdateOpacityLayer;</span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :         hint |= nsChangeHint_RepaintFrame;</span>
<span class="lineNum">    1596 </span>            :       }
<span class="lineNum">    1597 </span>            : 
<span class="lineNum">    1598 </span>            :       // Opacity disables preserve-3d, so if we toggle it, then we also need
<span class="lineNum">    1599 </span>            :       // to update the overflow areas of all potentially affected frames.
<span class="lineNum">    1600 </span><span class="lineCov">         98 :       if ((hint &amp; nsChangeHint_UpdateUsesOpacity) &amp;&amp;</span>
<span class="lineNum">    1601 </span><span class="lineCov">         17 :           frame-&gt;StyleDisplay()-&gt;mTransformStyle == NS_STYLE_TRANSFORM_STYLE_PRESERVE_3D) {</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :         hint |= nsChangeHint_UpdateSubtreeOverflow;</span>
<span class="lineNum">    1603 </span>            :       }
<span class="lineNum">    1604 </span>            : 
<span class="lineNum">    1605 </span><span class="lineCov">         81 :       if (hint &amp; nsChangeHint_UpdateBackgroundPosition) {</span>
<span class="lineNum">    1606 </span>            :         // For most frame types, DLBI can detect background position changes,
<span class="lineNum">    1607 </span>            :         // so we only need to schedule a paint.
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :         hint |= nsChangeHint_SchedulePaint;</span>
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :         if (frame-&gt;IsFrameOfType(nsIFrame::eTablePart) ||</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :             frame-&gt;IsFrameOfType(nsIFrame::eMathML)) {</span>
<span class="lineNum">    1611 </span>            :           // Table parts and MathML frames don't build display items for their
<span class="lineNum">    1612 </span>            :           // backgrounds, so DLBI can't detect background-position changes for
<span class="lineNum">    1613 </span>            :           // these frames. Repaint the whole frame.
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :           hint |= nsChangeHint_RepaintFrame;</span>
<span class="lineNum">    1615 </span>            :         }
<span class="lineNum">    1616 </span>            :       }
<span class="lineNum">    1617 </span>            : 
<span class="lineNum">    1618 </span><span class="lineCov">         81 :       if (hint &amp; (nsChangeHint_RepaintFrame | nsChangeHint_SyncFrameView |</span>
<span class="lineNum">    1619 </span>            :                   nsChangeHint_UpdateOpacityLayer | nsChangeHint_UpdateTransformLayer |
<span class="lineNum">    1620 </span>            :                   nsChangeHint_ChildrenOnlyTransform | nsChangeHint_SchedulePaint)) {
<span class="lineNum">    1621 </span><span class="lineCov">         51 :         ApplyRenderingChangeToTree(presContext-&gt;PresShell(), frame, hint);</span>
<span class="lineNum">    1622 </span>            :       }
<span class="lineNum">    1623 </span><span class="lineCov">         81 :       if ((hint &amp; nsChangeHint_RecomputePosition) &amp;&amp; !didReflowThisFrame) {</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :         ActiveLayerTracker::NotifyOffsetRestyle(frame);</span>
<span class="lineNum">    1625 </span>            :         // It is possible for this to fall back to a reflow
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :         if (!RecomputePosition(frame)) {</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :           didReflowThisFrame = true;</span>
<span class="lineNum">    1628 </span>            :         }
<span class="lineNum">    1629 </span>            :       }
<span class="lineNum">    1630 </span><span class="lineCov">         81 :       NS_ASSERTION(!(hint &amp; nsChangeHint_ChildrenOnlyTransform) ||</span>
<span class="lineNum">    1631 </span>            :                    (hint &amp; nsChangeHint_UpdateOverflow),
<span class="lineNum">    1632 </span>            :                    &quot;nsChangeHint_UpdateOverflow should be passed too&quot;);
<span class="lineNum">    1633 </span><span class="lineCov">        134 :       if (!didReflowThisFrame &amp;&amp;</span>
<span class="lineNum">    1634 </span><span class="lineCov">         53 :           (hint &amp; (nsChangeHint_UpdateOverflow |</span>
<span class="lineNum">    1635 </span>            :                    nsChangeHint_UpdatePostTransformOverflow |
<span class="lineNum">    1636 </span>            :                    nsChangeHint_UpdateParentOverflow |
<span class="lineNum">    1637 </span>            :                    nsChangeHint_UpdateSubtreeOverflow))) {
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :         if (hint &amp; nsChangeHint_UpdateSubtreeOverflow) {</span>
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :           for (nsIFrame* cont = frame; cont; cont =</span>
<span class="lineNum">    1640 </span>            :                  nsLayoutUtils::GetNextContinuationOrIBSplitSibling(cont)) {
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :             AddSubtreeToOverflowTracker(cont, mOverflowChangedTracker);</span>
<span class="lineNum">    1642 </span>            :           }
<span class="lineNum">    1643 </span>            :           // The work we just did in AddSubtreeToOverflowTracker
<span class="lineNum">    1644 </span>            :           // subsumes some of the other hints:
<span class="lineNum">    1645 </span>            :           hint &amp;= ~(nsChangeHint_UpdateOverflow |
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :                     nsChangeHint_UpdatePostTransformOverflow);</span>
<span class="lineNum">    1647 </span>            :         }
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :         if (hint &amp; nsChangeHint_ChildrenOnlyTransform) {</span>
<span class="lineNum">    1649 </span>            :           // The overflow areas of the child frames need to be updated:
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :           nsIFrame* hintFrame = GetFrameForChildrenOnlyTransformHint(frame);</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :           nsIFrame* childFrame = hintFrame-&gt;PrincipalChildList().FirstChild();</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :           NS_ASSERTION(!nsLayoutUtils::GetNextContinuationOrIBSplitSibling(frame),</span>
<span class="lineNum">    1653 </span>            :                        &quot;SVG frames should not have continuations &quot;
<span class="lineNum">    1654 </span>            :                        &quot;or ib-split siblings&quot;);
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :           NS_ASSERTION(!nsLayoutUtils::GetNextContinuationOrIBSplitSibling(hintFrame),</span>
<span class="lineNum">    1656 </span>            :                        &quot;SVG frames should not have continuations &quot;
<span class="lineNum">    1657 </span>            :                        &quot;or ib-split siblings&quot;);
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :           for ( ; childFrame; childFrame = childFrame-&gt;GetNextSibling()) {</span>
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :             MOZ_ASSERT(childFrame-&gt;IsFrameOfType(nsIFrame::eSVG),</span>
<span class="lineNum">    1660 </span>            :                        &quot;Not expecting non-SVG children&quot;);
<span class="lineNum">    1661 </span>            :             // If |childFrame| is dirty or has dirty children, we don't bother
<span class="lineNum">    1662 </span>            :             // updating overflows since that will happen when it's reflowed.
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :             if (!(childFrame-&gt;GetStateBits() &amp;</span>
<span class="lineNum">    1664 </span>            :                   (NS_FRAME_IS_DIRTY | NS_FRAME_HAS_DIRTY_CHILDREN))) {
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :               mOverflowChangedTracker.AddFrame(childFrame,</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :                                         OverflowChangedTracker::CHILDREN_CHANGED);</span>
<span class="lineNum">    1667 </span>            :             }
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :             NS_ASSERTION(!nsLayoutUtils::GetNextContinuationOrIBSplitSibling(childFrame),</span>
<span class="lineNum">    1669 </span>            :                          &quot;SVG frames should not have continuations &quot;
<span class="lineNum">    1670 </span>            :                          &quot;or ib-split siblings&quot;);
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :             NS_ASSERTION(childFrame-&gt;GetParent() == hintFrame,</span>
<span class="lineNum">    1672 </span>            :                          &quot;SVG child frame not expected to have different parent&quot;);
<span class="lineNum">    1673 </span>            :           }
<span class="lineNum">    1674 </span>            :         }
<span class="lineNum">    1675 </span>            :         // If |frame| is dirty or has dirty children, we don't bother updating
<span class="lineNum">    1676 </span>            :         // overflows since that will happen when it's reflowed.
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :         if (!(frame-&gt;GetStateBits() &amp;</span>
<span class="lineNum">    1678 </span>            :               (NS_FRAME_IS_DIRTY | NS_FRAME_HAS_DIRTY_CHILDREN))) {
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :           if (hint &amp; (nsChangeHint_UpdateOverflow |</span>
<span class="lineNum">    1680 </span>            :                       nsChangeHint_UpdatePostTransformOverflow)) {
<span class="lineNum">    1681 </span>            :             OverflowChangedTracker::ChangeKind changeKind;
<span class="lineNum">    1682 </span>            :             // If we have both nsChangeHint_UpdateOverflow and
<span class="lineNum">    1683 </span>            :             // nsChangeHint_UpdatePostTransformOverflow,
<span class="lineNum">    1684 </span>            :             // CHILDREN_CHANGED is selected as it is
<span class="lineNum">    1685 </span>            :             // strictly stronger.
<span class="lineNum">    1686 </span><span class="lineNoCov">          0 :             if (hint &amp; nsChangeHint_UpdateOverflow) {</span>
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 :               changeKind = OverflowChangedTracker::CHILDREN_CHANGED;</span>
<span class="lineNum">    1688 </span>            :             } else {
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 :               changeKind = OverflowChangedTracker::TRANSFORM_CHANGED;</span>
<span class="lineNum">    1690 </span>            :             }
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :             for (nsIFrame* cont = frame; cont; cont =</span>
<span class="lineNum">    1692 </span>            :                    nsLayoutUtils::GetNextContinuationOrIBSplitSibling(cont)) {
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :               mOverflowChangedTracker.AddFrame(cont, changeKind);</span>
<span class="lineNum">    1694 </span>            :             }
<span class="lineNum">    1695 </span>            :           }
<span class="lineNum">    1696 </span>            :           // UpdateParentOverflow hints need to be processed in addition
<span class="lineNum">    1697 </span>            :           // to the above, since if the processing of the above hints
<span class="lineNum">    1698 </span>            :           // yields no change, the update will not propagate to the
<span class="lineNum">    1699 </span>            :           // parent.
<span class="lineNum">    1700 </span><span class="lineNoCov">          0 :           if (hint &amp; nsChangeHint_UpdateParentOverflow) {</span>
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :             MOZ_ASSERT(frame-&gt;GetParent(),</span>
<span class="lineNum">    1702 </span>            :                        &quot;shouldn't get style hints for the root frame&quot;);
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :             for (nsIFrame* cont = frame; cont; cont =</span>
<span class="lineNum">    1704 </span>            :                    nsLayoutUtils::GetNextContinuationOrIBSplitSibling(cont)) {
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :               mOverflowChangedTracker.AddFrame(cont-&gt;GetParent(),</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :                                    OverflowChangedTracker::CHILDREN_CHANGED);</span>
<span class="lineNum">    1707 </span>            :             }
<span class="lineNum">    1708 </span>            :           }
<span class="lineNum">    1709 </span>            :         }
<span class="lineNum">    1710 </span>            :       }
<span class="lineNum">    1711 </span><span class="lineCov">         81 :       if ((hint &amp; nsChangeHint_UpdateCursor) &amp;&amp; !didUpdateCursor) {</span>
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :         presContext-&gt;PresShell()-&gt;SynthesizeMouseMove(false);</span>
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :         didUpdateCursor = true;</span>
<span class="lineNum">    1714 </span>            :       }
<span class="lineNum">    1715 </span><span class="lineCov">         81 :       if (hint &amp; nsChangeHint_UpdateWidgetProperties) {</span>
<span class="lineNum">    1716 </span><span class="lineNoCov">          0 :         frame-&gt;UpdateWidgetProperties();</span>
<span class="lineNum">    1717 </span>            :       }
<span class="lineNum">    1718 </span>            :     }
<span class="lineNum">    1719 </span>            :   }
<span class="lineNum">    1720 </span>            : 
<span class="lineNum">    1721 </span><span class="lineCov">         53 :   frameConstructor-&gt;EndUpdate();</span>
<span class="lineNum">    1722 </span><span class="lineCov">         53 :   mDestroyedFrames.reset(nullptr);</span>
<span class="lineNum">    1723 </span>            : 
<span class="lineNum">    1724 </span>            : #ifdef DEBUG
<span class="lineNum">    1725 </span>            :   // Verify the style tree.  Note that this needs to happen once we've
<span class="lineNum">    1726 </span>            :   // processed the whole list, since until then the tree is not in fact in a
<span class="lineNum">    1727 </span>            :   // consistent state.
<span class="lineNum">    1728 </span><span class="lineCov">        149 :   for (const nsStyleChangeData&amp; data : aChangeList) {</span>
<span class="lineNum">    1729 </span>            :     // reget frame from content since it may have been regenerated...
<span class="lineNum">    1730 </span><span class="lineCov">         96 :     if (data.mContent) {</span>
<span class="lineNum">    1731 </span><span class="lineCov">         95 :       nsIFrame* frame = data.mContent-&gt;GetPrimaryFrame();</span>
<span class="lineNum">    1732 </span><span class="lineCov">         95 :       if (frame) {</span>
<span class="lineNum">    1733 </span><span class="lineCov">         92 :         DebugVerifyStyleTree(frame);</span>
<span class="lineNum">    1734 </span>            :       }
<span class="lineNum">    1735 </span><span class="lineCov">          1 :     } else if (!data.mFrame || !data.mFrame-&gt;IsViewportFrame()) {</span>
<span class="lineNum">    1736 </span>            :       NS_WARNING(&quot;Unable to test style tree integrity -- no content node &quot;
<span class="lineNum">    1737 </span><span class="lineNoCov">          0 :                  &quot;(and not a viewport frame)&quot;);</span>
<span class="lineNum">    1738 </span>            :     }
<span class="lineNum">    1739 </span>            :   }
<span class="lineNum">    1740 </span>            : #endif
<span class="lineNum">    1741 </span>            : 
<span class="lineNum">    1742 </span><span class="lineCov">         53 :   aChangeList.Clear();</span>
<span class="lineNum">    1743 </span>            : }
<a name="1744"><span class="lineNum">    1744 </span>            : </a>
<span class="lineNum">    1745 </span>            : /* static */ uint64_t
<span class="lineNum">    1746 </span><span class="lineCov">       1200 : RestyleManager::GetAnimationGenerationForFrame(nsIFrame* aFrame)</span>
<span class="lineNum">    1747 </span>            : {
<span class="lineNum">    1748 </span><span class="lineCov">       1200 :   EffectSet* effectSet = EffectSet::GetEffectSet(aFrame);</span>
<span class="lineNum">    1749 </span><span class="lineCov">       1200 :   return effectSet ? effectSet-&gt;GetAnimationGeneration() : 0;</span>
<span class="lineNum">    1750 </span>            : }
<a name="1751"><span class="lineNum">    1751 </span>            : </a>
<span class="lineNum">    1752 </span>            : void
<span class="lineNum">    1753 </span><span class="lineCov">          2 : RestyleManager::IncrementAnimationGeneration()</span>
<span class="lineNum">    1754 </span>            : {
<span class="lineNum">    1755 </span>            :   // We update the animation generation at start of each call to
<span class="lineNum">    1756 </span>            :   // ProcessPendingRestyles so we should ignore any subsequent (redundant)
<span class="lineNum">    1757 </span>            :   // calls that occur while we are still processing restyles.
<span class="lineNum">    1758 </span><span class="lineCov">          4 :   if ((IsGecko() &amp;&amp; !AsGecko()-&gt;IsProcessingRestyles()) ||</span>
<span class="lineNum">    1759 </span><span class="lineNoCov">          0 :       (IsServo() &amp;&amp; !mInStyleRefresh)) {</span>
<span class="lineNum">    1760 </span><span class="lineCov">          2 :     ++mAnimationGeneration;</span>
<span class="lineNum">    1761 </span>            :   }
<span class="lineNum">    1762 </span><span class="lineCov">          2 : }</span>
<a name="1763"><span class="lineNum">    1763 </span>            : </a>
<span class="lineNum">    1764 </span>            : /* static */ void
<span class="lineNum">    1765 </span><span class="lineCov">       1202 : RestyleManager::AddLayerChangesForAnimation(nsIFrame* aFrame,</span>
<span class="lineNum">    1766 </span>            :                                             nsIContent* aContent,
<span class="lineNum">    1767 </span>            :                                             nsStyleChangeList&amp;
<span class="lineNum">    1768 </span>            :                                               aChangeListToProcess)
<span class="lineNum">    1769 </span>            : {
<span class="lineNum">    1770 </span><span class="lineCov">       1202 :   if (!aFrame || !aContent) {</span>
<span class="lineNum">    1771 </span><span class="lineCov">          2 :     return;</span>
<span class="lineNum">    1772 </span>            :   }
<span class="lineNum">    1773 </span>            : 
<span class="lineNum">    1774 </span>            :   uint64_t frameGeneration =
<span class="lineNum">    1775 </span><span class="lineCov">       1200 :     RestyleManager::GetAnimationGenerationForFrame(aFrame);</span>
<span class="lineNum">    1776 </span>            : 
<span class="lineNum">    1777 </span><span class="lineCov">       1200 :   nsChangeHint hint = nsChangeHint(0);</span>
<span class="lineNum">    1778 </span><span class="lineCov">       2400 :   for (const LayerAnimationInfo::Record&amp; layerInfo :</span>
<span class="lineNum">    1779 </span><span class="lineCov">       1200 :          LayerAnimationInfo::sRecords) {</span>
<span class="lineNum">    1780 </span>            :     layers::Layer* layer =
<span class="lineNum">    1781 </span><span class="lineCov">       2400 :       FrameLayerBuilder::GetDedicatedLayer(aFrame, layerInfo.mLayerType);</span>
<span class="lineNum">    1782 </span><span class="lineCov">       2400 :     if (layer &amp;&amp; frameGeneration != layer-&gt;GetAnimationGeneration()) {</span>
<span class="lineNum">    1783 </span>            :       // If we have a transform layer but don't have any transform style, we
<span class="lineNum">    1784 </span>            :       // probably just removed the transform but haven't destroyed the layer
<span class="lineNum">    1785 </span>            :       // yet. In this case we will add the appropriate change hint
<span class="lineNum">    1786 </span>            :       // (nsChangeHint_UpdateContainingBlock) when we compare style contexts
<span class="lineNum">    1787 </span>            :       // so we can skip adding any change hint here. (If we *were* to add
<span class="lineNum">    1788 </span>            :       // nsChangeHint_UpdateTransformLayer, ApplyRenderingChangeToTree would
<span class="lineNum">    1789 </span>            :       // complain that we're updating a transform layer without a transform).
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :       if (layerInfo.mLayerType == nsDisplayItem::TYPE_TRANSFORM &amp;&amp;</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :           !aFrame-&gt;StyleDisplay()-&gt;HasTransformStyle()) {</span>
<span class="lineNum">    1792 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1793 </span>            :       }
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :       hint |= layerInfo.mChangeHint;</span>
<span class="lineNum">    1795 </span>            :     }
<span class="lineNum">    1796 </span>            : 
<span class="lineNum">    1797 </span>            :     // We consider it's the first paint for the frame if we have an animation
<span class="lineNum">    1798 </span>            :     // for the property but have no layer.
<span class="lineNum">    1799 </span>            :     // Note that in case of animations which has properties preventing running
<span class="lineNum">    1800 </span>            :     // on the compositor, e.g., width or height, corresponding layer is not
<span class="lineNum">    1801 </span>            :     // created at all, but even in such cases, we normally set valid change
<span class="lineNum">    1802 </span>            :     // hint for such animations in each tick, i.e. restyles in each tick. As
<span class="lineNum">    1803 </span>            :     // a result, we usually do restyles for such animations in every tick on
<span class="lineNum">    1804 </span>            :     // the main-thread.  The only animations which will be affected by this
<span class="lineNum">    1805 </span>            :     // explicit change hint are animations that have opacity/transform but did
<span class="lineNum">    1806 </span>            :     // not have those properies just before. e.g, setting transform by
<span class="lineNum">    1807 </span>            :     // setKeyframes or changing target element from other target which prevents
<span class="lineNum">    1808 </span>            :     // running on the compositor, etc.
<span class="lineNum">    1809 </span><span class="lineCov">       4800 :     if (!layer &amp;&amp;</span>
<span class="lineNum">    1810 </span><span class="lineCov">       2400 :         nsLayoutUtils::HasEffectiveAnimation(aFrame, layerInfo.mProperty)) {</span>
<span class="lineNum">    1811 </span><span class="lineCov">         14 :       hint |= layerInfo.mChangeHint;</span>
<span class="lineNum">    1812 </span>            :     }
<span class="lineNum">    1813 </span>            :   }
<span class="lineNum">    1814 </span>            : 
<span class="lineNum">    1815 </span><span class="lineCov">       1200 :   if (hint) {</span>
<span class="lineNum">    1816 </span><span class="lineCov">         14 :     aChangeListToProcess.AppendChange(aFrame, aContent, hint);</span>
<span class="lineNum">    1817 </span>            :   }
<a name="1818"><span class="lineNum">    1818 </span>            : }</a>
<span class="lineNum">    1819 </span>            : 
<span class="lineNum">    1820 </span><span class="lineCov">         25 : RestyleManager::AnimationsWithDestroyedFrame::AnimationsWithDestroyedFrame(</span>
<span class="lineNum">    1821 </span><span class="lineCov">         25 :                                                 RestyleManager* aRestyleManager)</span>
<span class="lineNum">    1822 </span>            :   : mRestyleManager(aRestyleManager)
<span class="lineNum">    1823 </span><span class="lineCov">         25 :   , mRestorePointer(mRestyleManager-&gt;mAnimationsWithDestroyedFrame)</span>
<span class="lineNum">    1824 </span>            : {
<span class="lineNum">    1825 </span><span class="lineCov">         25 :   MOZ_ASSERT(!mRestyleManager-&gt;mAnimationsWithDestroyedFrame,</span>
<span class="lineNum">    1826 </span>            :              &quot;shouldn't construct recursively&quot;);
<span class="lineNum">    1827 </span><span class="lineCov">         25 :   mRestyleManager-&gt;mAnimationsWithDestroyedFrame = this;</span>
<span class="lineNum">    1828 </span><span class="lineCov">         25 : }</span>
<a name="1829"><span class="lineNum">    1829 </span>            : </a>
<span class="lineNum">    1830 </span>            : void
<span class="lineNum">    1831 </span><span class="lineCov">         25 : RestyleManager::AnimationsWithDestroyedFrame</span>
<span class="lineNum">    1832 </span>            :               ::StopAnimationsForElementsWithoutFrames()
<span class="lineNum">    1833 </span>            : {
<span class="lineNum">    1834 </span><span class="lineCov">         25 :   StopAnimationsWithoutFrame(mContents, CSSPseudoElementType::NotPseudo);</span>
<span class="lineNum">    1835 </span><span class="lineCov">         25 :   StopAnimationsWithoutFrame(mBeforeContents, CSSPseudoElementType::before);</span>
<span class="lineNum">    1836 </span><span class="lineCov">         25 :   StopAnimationsWithoutFrame(mAfterContents, CSSPseudoElementType::after);</span>
<span class="lineNum">    1837 </span><span class="lineCov">         25 : }</span>
<a name="1838"><span class="lineNum">    1838 </span>            : </a>
<span class="lineNum">    1839 </span>            : void
<span class="lineNum">    1840 </span><span class="lineCov">         75 : RestyleManager::AnimationsWithDestroyedFrame</span>
<span class="lineNum">    1841 </span>            :               ::StopAnimationsWithoutFrame(
<span class="lineNum">    1842 </span>            :                   nsTArray&lt;RefPtr&lt;nsIContent&gt;&gt;&amp; aArray,
<span class="lineNum">    1843 </span>            :                   CSSPseudoElementType aPseudoType)
<span class="lineNum">    1844 </span>            : {
<span class="lineNum">    1845 </span>            :   nsAnimationManager* animationManager =
<span class="lineNum">    1846 </span><span class="lineCov">         75 :     mRestyleManager-&gt;PresContext()-&gt;AnimationManager();</span>
<span class="lineNum">    1847 </span>            :   nsTransitionManager* transitionManager =
<span class="lineNum">    1848 </span><span class="lineCov">         75 :     mRestyleManager-&gt;PresContext()-&gt;TransitionManager();</span>
<span class="lineNum">    1849 </span><span class="lineCov">         77 :   for (nsIContent* content : aArray) {</span>
<span class="lineNum">    1850 </span><span class="lineCov">          2 :     if (content-&gt;GetPrimaryFrame()) {</span>
<span class="lineNum">    1851 </span><span class="lineCov">          2 :       continue;</span>
<span class="lineNum">    1852 </span>            :     }
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :     dom::Element* element = content-&gt;AsElement();</span>
<span class="lineNum">    1854 </span>            : 
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :     animationManager-&gt;StopAnimationsForElement(element, aPseudoType);</span>
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :     transitionManager-&gt;StopAnimationsForElement(element, aPseudoType);</span>
<span class="lineNum">    1857 </span>            : 
<span class="lineNum">    1858 </span>            :     // All other animations should keep running but not running on the
<span class="lineNum">    1859 </span>            :     // *compositor* at this point.
<span class="lineNum">    1860 </span><span class="lineNoCov">          0 :     EffectSet* effectSet = EffectSet::GetEffectSet(element, aPseudoType);</span>
<span class="lineNum">    1861 </span><span class="lineNoCov">          0 :     if (effectSet) {</span>
<span class="lineNum">    1862 </span><span class="lineNoCov">          0 :       for (KeyframeEffectReadOnly* effect : *effectSet) {</span>
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :         effect-&gt;ResetIsRunningOnCompositor();</span>
<span class="lineNum">    1864 </span>            :       }
<span class="lineNum">    1865 </span>            :     }
<span class="lineNum">    1866 </span>            :   }
<span class="lineNum">    1867 </span><span class="lineCov">         75 : }</span>
<span class="lineNum">    1868 </span>            : 
<span class="lineNum">    1869 </span>            : } // namespace mozilla
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

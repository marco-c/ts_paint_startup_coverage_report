<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - layout/base/nsCaret.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">layout/base</a> - nsCaret.cpp<span style="font-size: 80%;"> (source / <a href="nsCaret.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">125</td>
            <td class="headerCovTableEntry">492</td>
            <td class="headerCovTableEntryLo">25.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">23</td>
            <td class="headerCovTableEntry">41</td>
            <td class="headerCovTableEntryLo">56.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=2 sw=2 et tw=78: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : /* the caret is the text cursor used, e.g., when editing */
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;nsCaret.h&quot;
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            : #include &quot;gfxUtils.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;mozilla/gfx/2D.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsCOMPtr.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsFontMetrics.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsITimer.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsFrameSelection.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsIFrame.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsIScrollableFrame.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsIDOMNode.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;nsISelection.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;nsISelectionPrivate.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;nsIContent.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsIPresShell.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;nsLayoutUtils.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;nsPresContext.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;nsBlockFrame.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;nsISelectionController.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;nsTextFrame.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;nsXULPopupManager.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;nsMenuPopupFrame.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;nsTextFragment.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;mozilla/Preferences.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;mozilla/LookAndFeel.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;mozilla/dom/Selection.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;nsIBidiKeyboard.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : using namespace mozilla;
<span class="lineNum">      41 </span>            : using namespace mozilla::dom;
<span class="lineNum">      42 </span>            : using namespace mozilla::gfx;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : // The bidi indicator hangs off the caret to one side, to show which
<span class="lineNum">      45 </span>            : // direction the typing is in. It needs to be at least 2x2 to avoid looking like
<span class="lineNum">      46 </span>            : // an insignificant dot
<span class="lineNum">      47 </span>            : static const int32_t kMinBidiIndicatorPixels = 2;
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : // The default caret blinking rate (in ms of blinking interval)
<span class="lineNum">      50 </span>            : static const uint32_t kDefaultCaretBlinkRate = 500;
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : /**
<span class="lineNum">      53 </span>            :  * Find the first frame in an in-order traversal of the frame subtree rooted
<span class="lineNum">      54 </span>            :  * at aFrame which is either a text frame logically at the end of a line,
<span class="lineNum">      55 </span>            :  * or which is aStopAtFrame. Return null if no such frame is found. We don't
<span class="lineNum">      56 </span>            :  * descend into the children of non-eLineParticipant frames.
<a name="57"><span class="lineNum">      57 </span>            :  */</a>
<span class="lineNum">      58 </span>            : static nsIFrame*
<span class="lineNum">      59 </span><span class="lineCov">          4 : CheckForTrailingTextFrameRecursive(nsIFrame* aFrame, nsIFrame* aStopAtFrame)</span>
<span class="lineNum">      60 </span>            : {
<span class="lineNum">      61 </span><span class="lineCov">          8 :   if (aFrame == aStopAtFrame ||</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :       ((aFrame-&gt;IsTextFrame() &amp;&amp;</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :        (static_cast&lt;nsTextFrame*&gt;(aFrame))-&gt;IsAtEndOfLine())))</span>
<span class="lineNum">      64 </span><span class="lineCov">          4 :     return aFrame;</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   if (!aFrame-&gt;IsFrameOfType(nsIFrame::eLineParticipant))</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :   for (nsIFrame* f : aFrame-&gt;PrincipalChildList())</span>
<span class="lineNum">      69 </span>            :   {
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :     nsIFrame* r = CheckForTrailingTextFrameRecursive(f, aStopAtFrame);</span>
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :     if (r)</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :       return r;</span>
<span class="lineNum">      73 </span>            :   }
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   return nullptr;</span>
<span class="lineNum">      75 </span>            : }
<a name="76"><span class="lineNum">      76 </span>            : </a>
<span class="lineNum">      77 </span>            : static nsLineBox*
<span class="lineNum">      78 </span><span class="lineCov">          4 : FindContainingLine(nsIFrame* aFrame)</span>
<span class="lineNum">      79 </span>            : {
<span class="lineNum">      80 </span><span class="lineCov">          4 :   while (aFrame &amp;&amp; aFrame-&gt;IsFrameOfType(nsIFrame::eLineParticipant))</span>
<span class="lineNum">      81 </span>            :   {
<span class="lineNum">      82 </span><span class="lineCov">          4 :     nsIFrame* parent = aFrame-&gt;GetParent();</span>
<span class="lineNum">      83 </span><span class="lineCov">          4 :     nsBlockFrame* blockParent = nsLayoutUtils::GetAsBlock(parent);</span>
<span class="lineNum">      84 </span><span class="lineCov">          4 :     if (blockParent)</span>
<span class="lineNum">      85 </span>            :     {
<span class="lineNum">      86 </span>            :       bool isValid;
<span class="lineNum">      87 </span><span class="lineCov">          4 :       nsBlockInFlowLineIterator iter(blockParent, aFrame, &amp;isValid);</span>
<span class="lineNum">      88 </span><span class="lineCov">          4 :       return isValid ? iter.GetLine().get() : nullptr;</span>
<span class="lineNum">      89 </span>            :     }
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :     aFrame = parent;</span>
<span class="lineNum">      91 </span>            :   }
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :   return nullptr;</span>
<span class="lineNum">      93 </span>            : }
<a name="94"><span class="lineNum">      94 </span>            : </a>
<span class="lineNum">      95 </span>            : static void
<span class="lineNum">      96 </span><span class="lineCov">          4 : AdjustCaretFrameForLineEnd(nsIFrame** aFrame, int32_t* aOffset)</span>
<span class="lineNum">      97 </span>            : {
<span class="lineNum">      98 </span><span class="lineCov">          4 :   nsLineBox* line = FindContainingLine(*aFrame);</span>
<span class="lineNum">      99 </span><span class="lineCov">          4 :   if (!line)</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     101 </span><span class="lineCov">          4 :   int32_t count = line-&gt;GetChildCount();</span>
<span class="lineNum">     102 </span><span class="lineCov">          4 :   for (nsIFrame* f = line-&gt;mFirstChild; count &gt; 0; --count, f = f-&gt;GetNextSibling())</span>
<span class="lineNum">     103 </span>            :   {
<span class="lineNum">     104 </span><span class="lineCov">          4 :     nsIFrame* r = CheckForTrailingTextFrameRecursive(f, *aFrame);</span>
<span class="lineNum">     105 </span><span class="lineCov">          4 :     if (r == *aFrame)</span>
<span class="lineNum">     106 </span><span class="lineCov">          4 :       return;</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     if (r)</span>
<span class="lineNum">     108 </span>            :     {
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :       *aFrame = r;</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :       NS_ASSERTION(r-&gt;IsTextFrame(), &quot;Expected text frame&quot;);</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :       *aOffset = (static_cast&lt;nsTextFrame*&gt;(r))-&gt;GetContentEnd();</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     113 </span>            :     }
<span class="lineNum">     114 </span>            :   }
<span class="lineNum">     115 </span>            : }
<a name="116"><span class="lineNum">     116 </span>            : </a>
<span class="lineNum">     117 </span>            : static bool
<span class="lineNum">     118 </span><span class="lineNoCov">          0 : IsBidiUI()</span>
<span class="lineNum">     119 </span>            : {
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :   return Preferences::GetBool(&quot;bidi.browser.ui&quot;);</span>
<a name="121"><span class="lineNum">     121 </span>            : }</a>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineCov">         28 : nsCaret::nsCaret()</span>
<span class="lineNum">     124 </span>            : : mOverrideOffset(0)
<span class="lineNum">     125 </span>            : , mBlinkCount(-1)
<span class="lineNum">     126 </span>            : , mBlinkRate(0)
<span class="lineNum">     127 </span>            : , mHideCount(0)
<span class="lineNum">     128 </span>            : , mIsBlinkOn(false)
<span class="lineNum">     129 </span>            : , mVisible(false)
<span class="lineNum">     130 </span>            : , mReadOnly(false)
<span class="lineNum">     131 </span>            : , mShowDuringSelection(false)
<span class="lineNum">     132 </span><span class="lineCov">         28 : , mIgnoreUserModify(true)</span>
<span class="lineNum">     133 </span>            : {
<a name="134"><span class="lineNum">     134 </span><span class="lineCov">         28 : }</span></a>
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span><span class="lineCov">         12 : nsCaret::~nsCaret()</span>
<span class="lineNum">     137 </span>            : {
<span class="lineNum">     138 </span><span class="lineCov">          4 :   StopBlinking();</span>
<a name="139"><span class="lineNum">     139 </span><span class="lineCov">         12 : }</span></a>
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span><span class="lineCov">         28 : nsresult nsCaret::Init(nsIPresShell *inPresShell)</span>
<span class="lineNum">     142 </span>            : {
<span class="lineNum">     143 </span><span class="lineCov">         28 :   NS_ENSURE_ARG(inPresShell);</span>
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineCov">         28 :   mPresShell = do_GetWeakReference(inPresShell);    // the presshell owns us, so no addref</span>
<span class="lineNum">     146 </span><span class="lineCov">         28 :   NS_ASSERTION(mPresShell, &quot;Hey, pres shell should support weak refs&quot;);</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineCov">         28 :   mShowDuringSelection =</span>
<span class="lineNum">     149 </span><span class="lineCov">         28 :     LookAndFeel::GetInt(LookAndFeel::eIntID_ShowCaretDuringSelection,</span>
<span class="lineNum">     150 </span><span class="lineCov">         56 :                         mShowDuringSelection ? 1 : 0) != 0;</span>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            :   // get the selection from the pres shell, and set ourselves up as a selection
<span class="lineNum">     153 </span>            :   // listener
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineCov">         56 :   nsCOMPtr&lt;nsISelectionController&gt; selCon = do_QueryReferent(mPresShell);</span>
<span class="lineNum">     156 </span><span class="lineCov">         28 :   if (!selCon)</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineCov">         56 :   nsCOMPtr&lt;nsISelection&gt; domSelection;</span>
<span class="lineNum">     160 </span><span class="lineCov">         56 :   nsresult rv = selCon-&gt;GetSelection(nsISelectionController::SELECTION_NORMAL,</span>
<span class="lineNum">     161 </span><span class="lineCov">         56 :                                      getter_AddRefs(domSelection));</span>
<span class="lineNum">     162 </span><span class="lineCov">         28 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     164 </span><span class="lineCov">         28 :   if (!domSelection)</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineCov">         56 :   nsCOMPtr&lt;nsISelectionPrivate&gt; privateSelection = do_QueryInterface(domSelection);</span>
<span class="lineNum">     168 </span><span class="lineCov">         28 :   if (privateSelection)</span>
<span class="lineNum">     169 </span><span class="lineCov">         28 :     privateSelection-&gt;AddSelectionListener(this);</span>
<span class="lineNum">     170 </span><span class="lineCov">         28 :   mDomSelectionWeak = do_GetWeakReference(domSelection);</span>
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span><span class="lineCov">         28 :   return NS_OK;</span>
<span class="lineNum">     173 </span>            : }
<a name="174"><span class="lineNum">     174 </span>            : </a>
<span class="lineNum">     175 </span>            : static bool
<span class="lineNum">     176 </span><span class="lineNoCov">          0 : DrawCJKCaret(nsIFrame* aFrame, int32_t aOffset)</span>
<span class="lineNum">     177 </span>            : {
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   nsIContent* content = aFrame-&gt;GetContent();</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   const nsTextFragment* frag = content-&gt;GetText();</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   if (!frag)</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   if (aOffset &lt; 0 || uint32_t(aOffset) &gt;= frag-&gt;GetLength())</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   char16_t ch = frag-&gt;CharAt(aOffset);</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   return 0x2e80 &lt;= ch &amp;&amp; ch &lt;= 0xd7ff;</span>
<span class="lineNum">     186 </span>            : }
<a name="187"><span class="lineNum">     187 </span>            : </a>
<span class="lineNum">     188 </span>            : nsCaret::Metrics
<span class="lineNum">     189 </span><span class="lineNoCov">          0 : nsCaret::ComputeMetrics(nsIFrame* aFrame, int32_t aOffset, nscoord aCaretHeight)</span>
<span class="lineNum">     190 </span>            : {
<span class="lineNum">     191 </span>            :   // Compute nominal sizes in appunits
<span class="lineNum">     192 </span>            :   nscoord caretWidth =
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     (aCaretHeight * LookAndFeel::GetFloat(LookAndFeel::eFloatID_CaretAspectRatio, 0.0f)) +</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :     nsPresContext::CSSPixelsToAppUnits(</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :         LookAndFeel::GetInt(LookAndFeel::eIntID_CaretWidth, 1));</span>
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   if (DrawCJKCaret(aFrame, aOffset)) {</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     caretWidth += nsPresContext::CSSPixelsToAppUnits(1);</span>
<span class="lineNum">     199 </span>            :   }
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :   nscoord bidiIndicatorSize = nsPresContext::CSSPixelsToAppUnits(kMinBidiIndicatorPixels);</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :   bidiIndicatorSize = std::max(caretWidth, bidiIndicatorSize);</span>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            :   // Round them to device pixels. Always round down, except that anything
<span class="lineNum">     204 </span>            :   // between 0 and 1 goes up to 1 so we don't let the caret disappear.
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :   int32_t tpp = aFrame-&gt;PresContext()-&gt;AppUnitsPerDevPixel();</span>
<span class="lineNum">     206 </span>            :   Metrics result;
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   result.mCaretWidth = NS_ROUND_BORDER_TO_PIXELS(caretWidth, tpp);</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :   result.mBidiIndicatorSize = NS_ROUND_BORDER_TO_PIXELS(bidiIndicatorSize, tpp);</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :   return result;</span>
<a name="210"><span class="lineNum">     210 </span>            : }</a>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineCov">          4 : void nsCaret::Terminate()</span>
<span class="lineNum">     213 </span>            : {
<span class="lineNum">     214 </span>            :   // this doesn't erase the caret if it's drawn. Should it? We might not have
<span class="lineNum">     215 </span>            :   // a good drawing environment during teardown.
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineCov">          4 :   StopBlinking();</span>
<span class="lineNum">     218 </span><span class="lineCov">          4 :   mBlinkTimer = nullptr;</span>
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span>            :   // unregiser ourselves as a selection listener
<span class="lineNum">     221 </span><span class="lineCov">          8 :   nsCOMPtr&lt;nsISelection&gt; domSelection = do_QueryReferent(mDomSelectionWeak);</span>
<span class="lineNum">     222 </span><span class="lineCov">          8 :   nsCOMPtr&lt;nsISelectionPrivate&gt; privateSelection(do_QueryInterface(domSelection));</span>
<span class="lineNum">     223 </span><span class="lineCov">          4 :   if (privateSelection)</span>
<span class="lineNum">     224 </span><span class="lineCov">          4 :     privateSelection-&gt;RemoveSelectionListener(this);</span>
<span class="lineNum">     225 </span><span class="lineCov">          4 :   mDomSelectionWeak = nullptr;</span>
<span class="lineNum">     226 </span><span class="lineCov">          4 :   mPresShell = nullptr;</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineCov">          4 :   mOverrideContent = nullptr;</span>
<a name="229"><span class="lineNum">     229 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">     230 </span>            : 
<a name="231"><span class="lineNum">     231 </span><span class="lineCov">        326 : NS_IMPL_ISUPPORTS(nsCaret, nsISelectionListener)</span></a>
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineCov">          2 : nsISelection* nsCaret::GetSelection()</span>
<span class="lineNum">     234 </span>            : {
<span class="lineNum">     235 </span><span class="lineCov">          4 :   nsCOMPtr&lt;nsISelection&gt; sel(do_QueryReferent(mDomSelectionWeak));</span>
<span class="lineNum">     236 </span><span class="lineCov">          4 :   return sel;</span>
<a name="237"><span class="lineNum">     237 </span>            : }</a>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineNoCov">          0 : void nsCaret::SetSelection(nsISelection *aDOMSel)</span>
<span class="lineNum">     240 </span>            : {
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(aDOMSel);</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   mDomSelectionWeak = do_GetWeakReference(aDOMSel);   // weak reference to pres shell</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :   ResetBlinking();</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :   SchedulePaint();</span>
<a name="245"><span class="lineNum">     245 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineNoCov">          0 : void nsCaret::SetVisible(bool inMakeVisible)</span>
<span class="lineNum">     248 </span>            : {
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   mVisible = inMakeVisible;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   mIgnoreUserModify = mVisible;</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :   ResetBlinking();</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :   SchedulePaint();</span>
<a name="253"><span class="lineNum">     253 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineCov">         52 : bool nsCaret::IsVisible()</span>
<span class="lineNum">     256 </span>            : {
<span class="lineNum">     257 </span><span class="lineCov">         52 :   if (!mVisible || mHideCount) {</span>
<span class="lineNum">     258 </span><span class="lineCov">         52 :     return false;</span>
<span class="lineNum">     259 </span>            :   }
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   if (!mShowDuringSelection) {</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :     Selection* selection = GetSelectionInternal();</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     if (!selection) {</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">     265 </span>            :     }
<span class="lineNum">     266 </span>            :     bool isCollapsed;
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     if (NS_FAILED(selection-&gt;GetIsCollapsed(&amp;isCollapsed)) || !isCollapsed) {</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">     269 </span>            :     }
<span class="lineNum">     270 </span>            :   }
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :   if (IsMenuPopupHidingCaret()) {</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     274 </span>            :   }
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   return true;</span>
<a name="277"><span class="lineNum">     277 </span>            : }</a>
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span><span class="lineNoCov">          0 : void nsCaret::AddForceHide()</span>
<span class="lineNum">     280 </span>            : {
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(mHideCount &lt; UINT32_MAX);</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   if (++mHideCount &gt; 1) {</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     284 </span>            :   }
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :   ResetBlinking();</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :   SchedulePaint();</span>
<a name="287"><span class="lineNum">     287 </span>            : }</a>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineNoCov">          0 : void nsCaret::RemoveForceHide()</span>
<span class="lineNum">     290 </span>            : {
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :   if (!mHideCount || --mHideCount) {</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     293 </span>            :   }
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :   ResetBlinking();</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :   SchedulePaint();</span>
<a name="296"><span class="lineNum">     296 </span>            : }</a>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineCov">          2 : void nsCaret::SetCaretReadOnly(bool inMakeReadonly)</span>
<span class="lineNum">     299 </span>            : {
<span class="lineNum">     300 </span><span class="lineCov">          2 :   mReadOnly = inMakeReadonly;</span>
<span class="lineNum">     301 </span><span class="lineCov">          2 :   ResetBlinking();</span>
<span class="lineNum">     302 </span><span class="lineCov">          2 :   SchedulePaint();</span>
<span class="lineNum">     303 </span><span class="lineCov">          2 : }</span>
<a name="304"><span class="lineNum">     304 </span>            : </a>
<span class="lineNum">     305 </span>            : /* static */ nsRect
<span class="lineNum">     306 </span><span class="lineNoCov">          0 : nsCaret::GetGeometryForFrame(nsIFrame* aFrame,</span>
<span class="lineNum">     307 </span>            :                              int32_t   aFrameOffset,
<span class="lineNum">     308 </span>            :                              nscoord*  aBidiIndicatorSize)
<span class="lineNum">     309 </span>            : {
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :   nsPoint framePos(0, 0);</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :   nsRect rect;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :   nsresult rv = aFrame-&gt;GetPointFromOffset(aFrameOffset, &amp;framePos);</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     if (aBidiIndicatorSize) {</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :       *aBidiIndicatorSize = 0;</span>
<span class="lineNum">     316 </span>            :     }
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     return rect;</span>
<span class="lineNum">     318 </span>            :   }
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :   nsIFrame* frame = aFrame-&gt;GetContentInsertionFrame();</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :   if (!frame) {</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     frame = aFrame;</span>
<span class="lineNum">     323 </span>            :   }
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :   NS_ASSERTION(!(frame-&gt;GetStateBits() &amp; NS_FRAME_IN_REFLOW),</span>
<span class="lineNum">     325 </span>            :                &quot;We should not be in the middle of reflow&quot;);
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   nscoord baseline = frame-&gt;GetCaretBaseline();</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :   nscoord ascent = 0, descent = 0;</span>
<span class="lineNum">     328 </span>            :   RefPtr&lt;nsFontMetrics&gt; fm =
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     nsLayoutUtils::GetInflatedFontMetricsForFrame(aFrame);</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :   NS_ASSERTION(fm, &quot;We should be able to get the font metrics&quot;);</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   if (fm) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     ascent = fm-&gt;MaxAscent();</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     descent = fm-&gt;MaxDescent();</span>
<span class="lineNum">     334 </span>            :   }
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :   nscoord height = ascent + descent;</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :   WritingMode wm = aFrame-&gt;GetWritingMode();</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :   bool vertical = wm.IsVertical();</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :   if (vertical) {</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     if (wm.IsLineInverted()) {</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :       framePos.x = baseline - descent;</span>
<span class="lineNum">     341 </span>            :     } else {
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :       framePos.x = baseline - ascent;</span>
<span class="lineNum">     343 </span>            :     }
<span class="lineNum">     344 </span>            :   } else {
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     framePos.y = baseline - ascent;</span>
<span class="lineNum">     346 </span>            :   }
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :   Metrics caretMetrics = ComputeMetrics(aFrame, aFrameOffset, height);</span>
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :   nsTextFrame* textFrame = do_QueryFrame(aFrame);</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :   if (textFrame) {</span>
<span class="lineNum">     351 </span>            :     gfxTextRun* textRun =
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :       textFrame-&gt;GetTextRun(nsTextFrame::TextRunType::eInflated);</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :     if (textRun) {</span>
<span class="lineNum">     354 </span>            :       // For &quot;upstream&quot; text where the textrun direction is reversed from the
<span class="lineNum">     355 </span>            :       // frame's inline-dir we want the caret to be painted before rather than
<span class="lineNum">     356 </span>            :       // after its nominal inline position, so we offset by its width.
<span class="lineNum">     357 </span>            :       bool textRunDirIsReverseOfFrame =
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :         wm.IsInlineReversed() != textRun-&gt;IsInlineReversed();</span>
<span class="lineNum">     359 </span>            :       // However, in sideways-lr mode we invert this behavior because this is
<span class="lineNum">     360 </span>            :       // the one writing mode where bidi-LTR corresponds to inline-reversed
<span class="lineNum">     361 </span>            :       // already, which reverses the desired caret placement behavior.
<span class="lineNum">     362 </span>            :       // Note that the following condition is equivalent to:
<span class="lineNum">     363 </span>            :       //   if ( (!textRun-&gt;IsSidewaysLeft() &amp;&amp; textRunDirIsReverseOfFrame) ||
<span class="lineNum">     364 </span>            :       //        (textRun-&gt;IsSidewaysLeft()  &amp;&amp; !textRunDirIsReverseOfFrame) )
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :       if (textRunDirIsReverseOfFrame != textRun-&gt;IsSidewaysLeft()) {</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         int dir = wm.IsBidiLTR() ? -1 : 1;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :         if (vertical) {</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :           framePos.y += dir * caretMetrics.mCaretWidth;</span>
<span class="lineNum">     369 </span>            :         } else {
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :           framePos.x += dir * caretMetrics.mCaretWidth;</span>
<span class="lineNum">     371 </span>            :         }
<span class="lineNum">     372 </span>            :       }
<span class="lineNum">     373 </span>            :     }
<span class="lineNum">     374 </span>            :   }
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :   rect = nsRect(framePos, vertical ? nsSize(height, caretMetrics.mCaretWidth) :</span>
<span class="lineNum">     377 </span>            :                                      nsSize(caretMetrics.mCaretWidth, height));
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span>            :   // Clamp the inline-position to be within our scroll frame. If we don't, then
<span class="lineNum">     380 </span>            :   // it clips us, and we don't appear at all. See bug 335560.
<span class="lineNum">     381 </span>            :   nsIFrame* scrollFrame =
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     nsLayoutUtils::GetClosestFrameOfType(aFrame, LayoutFrameType::Scroll);</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :   if (scrollFrame) {</span>
<span class="lineNum">     384 </span>            :     // First, use the scrollFrame to get at the scrollable view that we're in.
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     nsIScrollableFrame *sf = do_QueryFrame(scrollFrame);</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     nsIFrame *scrolled = sf-&gt;GetScrolledFrame();</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     nsRect caretInScroll = rect + aFrame-&gt;GetOffsetTo(scrolled);</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            :     // Now see if the caret extends beyond the view's bounds. If it does,
<span class="lineNum">     390 </span>            :     // then snap it back, put it as close to the edge as it can.
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     if (vertical) {</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :       nscoord overflow = caretInScroll.YMost() -</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :         scrolled-&gt;GetVisualOverflowRectRelativeToSelf().height;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :       if (overflow &gt; 0) {</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         rect.y -= overflow;</span>
<span class="lineNum">     396 </span>            :       }
<span class="lineNum">     397 </span>            :     } else {
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :       nscoord overflow = caretInScroll.XMost() -</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         scrolled-&gt;GetVisualOverflowRectRelativeToSelf().width;</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :       if (overflow &gt; 0) {</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :         rect.x -= overflow;</span>
<span class="lineNum">     402 </span>            :       }
<span class="lineNum">     403 </span>            :     }
<span class="lineNum">     404 </span>            :   }
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :   if (aBidiIndicatorSize) {</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     *aBidiIndicatorSize = caretMetrics.mBidiIndicatorSize;</span>
<span class="lineNum">     408 </span>            :   }
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :   return rect;</span>
<span class="lineNum">     410 </span>            : }
<a name="411"><span class="lineNum">     411 </span>            : </a>
<span class="lineNum">     412 </span>            : nsIFrame*
<span class="lineNum">     413 </span><span class="lineCov">          4 : nsCaret::GetFrameAndOffset(Selection* aSelection,</span>
<span class="lineNum">     414 </span>            :                            nsINode* aOverrideNode, int32_t aOverrideOffset,
<span class="lineNum">     415 </span>            :                            int32_t* aFrameOffset)
<span class="lineNum">     416 </span>            : {
<span class="lineNum">     417 </span>            :   nsINode* focusNode;
<span class="lineNum">     418 </span>            :   int32_t focusOffset;
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span><span class="lineCov">          4 :   if (aOverrideNode) {</span>
<span class="lineNum">     421 </span><span class="lineCov">          4 :     focusNode = aOverrideNode;</span>
<span class="lineNum">     422 </span><span class="lineCov">          4 :     focusOffset = aOverrideOffset;</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :   } else if (aSelection) {</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :     focusNode = aSelection-&gt;GetFocusNode();</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :     aSelection-&gt;GetFocusOffset(&amp;focusOffset);</span>
<span class="lineNum">     426 </span>            :   } else {
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     428 </span>            :   }
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span><span class="lineCov">          4 :   if (!focusNode || !focusNode-&gt;IsContent()) {</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     432 </span>            :   }
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span><span class="lineCov">          4 :   nsIContent* contentNode = focusNode-&gt;AsContent();</span>
<span class="lineNum">     435 </span><span class="lineCov">          4 :   nsFrameSelection* frameSelection = aSelection-&gt;GetFrameSelection();</span>
<span class="lineNum">     436 </span><span class="lineCov">          4 :   nsBidiLevel bidiLevel = frameSelection-&gt;GetCaretBidiLevel();</span>
<span class="lineNum">     437 </span>            :   nsIFrame* frame;
<span class="lineNum">     438 </span><span class="lineCov">          4 :   nsresult rv = nsCaret::GetCaretFrameForNodeOffset(</span>
<span class="lineNum">     439 </span>            :       frameSelection, contentNode, focusOffset,
<span class="lineNum">     440 </span><span class="lineCov">          4 :       frameSelection-&gt;GetHint(), bidiLevel, &amp;frame, aFrameOffset);</span>
<span class="lineNum">     441 </span><span class="lineCov">          4 :   if (NS_FAILED(rv) || !frame) {</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     443 </span>            :   }
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineCov">          4 :   return frame;</span>
<span class="lineNum">     446 </span>            : }
<a name="447"><span class="lineNum">     447 </span>            : </a>
<span class="lineNum">     448 </span>            : /* static */ nsIFrame*
<span class="lineNum">     449 </span><span class="lineNoCov">          0 : nsCaret::GetGeometry(nsISelection* aSelection, nsRect* aRect)</span>
<span class="lineNum">     450 </span>            : {
<span class="lineNum">     451 </span>            :   int32_t frameOffset;
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   Selection* selection = aSelection ? aSelection-&gt;AsSelection() : nullptr;</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :   nsIFrame* frame = GetFrameAndOffset(selection, nullptr, 0, &amp;frameOffset);</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   if (frame) {</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     *aRect = GetGeometryForFrame(frame, frameOffset, nullptr);</span>
<span class="lineNum">     456 </span>            :   }
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :   return frame;</span>
<span class="lineNum">     458 </span>            : }
<a name="459"><span class="lineNum">     459 </span>            : </a>
<span class="lineNum">     460 </span>            : Selection*
<span class="lineNum">     461 </span><span class="lineCov">          2 : nsCaret::GetSelectionInternal()</span>
<span class="lineNum">     462 </span>            : {
<span class="lineNum">     463 </span><span class="lineCov">          2 :   nsISelection* domSelection = GetSelection();</span>
<span class="lineNum">     464 </span><span class="lineCov">          2 :   return domSelection ? domSelection-&gt;AsSelection() : nullptr;</span>
<a name="465"><span class="lineNum">     465 </span>            : }</a>
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineCov">          2 : void nsCaret::SchedulePaint()</span>
<span class="lineNum">     468 </span>            : {
<span class="lineNum">     469 </span><span class="lineCov">          2 :   Selection* selection = GetSelectionInternal();</span>
<span class="lineNum">     470 </span>            :   nsINode* focusNode;
<span class="lineNum">     471 </span><span class="lineCov">          2 :   if (mOverrideContent) {</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     focusNode = mOverrideContent;</span>
<span class="lineNum">     473 </span><span class="lineCov">          2 :   } else if (selection) {</span>
<span class="lineNum">     474 </span><span class="lineCov">          2 :     focusNode = selection-&gt;GetFocusNode();</span>
<span class="lineNum">     475 </span>            :   } else {
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     477 </span>            :   }
<span class="lineNum">     478 </span><span class="lineCov">          2 :   if (!focusNode || !focusNode-&gt;IsContent()) {</span>
<span class="lineNum">     479 </span><span class="lineCov">          2 :     return;</span>
<span class="lineNum">     480 </span>            :   }
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :   nsIFrame* f = focusNode-&gt;AsContent()-&gt;GetPrimaryFrame();</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :   if (!f) {</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     484 </span>            :   }
<span class="lineNum">     485 </span>            :   // This may not be the correct continuation frame, but that's OK since we're
<span class="lineNum">     486 </span>            :   // just scheduling a paint of the window (or popup).
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :   f-&gt;SchedulePaint();</span>
<a name="488"><span class="lineNum">     488 </span>            : }</a>
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineNoCov">          0 : void nsCaret::SetVisibilityDuringSelection(bool aVisibility)</span>
<span class="lineNum">     491 </span>            : {
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :   mShowDuringSelection = aVisibility;</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :   SchedulePaint();</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 : }</span>
<a name="495"><span class="lineNum">     495 </span>            : </a>
<span class="lineNum">     496 </span>            : void
<span class="lineNum">     497 </span><span class="lineNoCov">          0 : nsCaret::SetCaretPosition(nsIDOMNode* aNode, int32_t aOffset)</span>
<span class="lineNum">     498 </span>            : {
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :   mOverrideContent = do_QueryInterface(aNode);</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :   mOverrideOffset = aOffset;</span>
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :   ResetBlinking();</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :   SchedulePaint();</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 : }</span>
<a name="505"><span class="lineNum">     505 </span>            : </a>
<span class="lineNum">     506 </span>            : void
<span class="lineNum">     507 </span><span class="lineNoCov">          0 : nsCaret::CheckSelectionLanguageChange()</span>
<span class="lineNum">     508 </span>            : {
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :   if (!IsBidiUI()) {</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     511 </span>            :   }
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :   bool isKeyboardRTL = false;</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :   nsIBidiKeyboard* bidiKeyboard = nsContentUtils::GetBidiKeyboard();</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :   if (bidiKeyboard) {</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :     bidiKeyboard-&gt;IsLangRTL(&amp;isKeyboardRTL);</span>
<span class="lineNum">     517 </span>            :   }
<span class="lineNum">     518 </span>            :   // Call SelectionLanguageChange on every paint. Mostly it will be a noop
<span class="lineNum">     519 </span>            :   // but it should be fast anyway. This guarantees we never paint the caret
<span class="lineNum">     520 </span>            :   // at the wrong place.
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :   Selection* selection = GetSelectionInternal();</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :   if (selection) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     selection-&gt;SelectionLanguageChange(isKeyboardRTL);</span>
<span class="lineNum">     524 </span>            :   }
<span class="lineNum">     525 </span>            : }
<a name="526"><span class="lineNum">     526 </span>            : </a>
<span class="lineNum">     527 </span>            : nsIFrame*
<span class="lineNum">     528 </span><span class="lineCov">         26 : nsCaret::GetPaintGeometry(nsRect* aRect)</span>
<span class="lineNum">     529 </span>            : {
<span class="lineNum">     530 </span>            :   // Return null if we should not be visible.
<span class="lineNum">     531 </span><span class="lineCov">         26 :   if (!IsVisible() || !mIsBlinkOn) {</span>
<span class="lineNum">     532 </span><span class="lineCov">         26 :     return nullptr;</span>
<span class="lineNum">     533 </span>            :   }
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span>            :   // Update selection language direction now so the new direction will be
<span class="lineNum">     536 </span>            :   // taken into account when computing the caret position below.
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :   CheckSelectionLanguageChange();</span>
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span>            :   int32_t frameOffset;
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :   nsIFrame *frame = GetFrameAndOffset(GetSelectionInternal(),</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :       mOverrideContent, mOverrideOffset, &amp;frameOffset);</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :   if (!frame) {</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     544 </span>            :   }
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span>            :   // now we have a frame, check whether it's appropriate to show the caret here
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :   const nsStyleUserInterface* userinterface = frame-&gt;StyleUserInterface();</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :   if ((!mIgnoreUserModify &amp;&amp;</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :        userinterface-&gt;mUserModify == StyleUserModify::ReadOnly) ||</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :       userinterface-&gt;mUserInput == StyleUserInput::None ||</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :       userinterface-&gt;mUserInput == StyleUserInput::Disabled) {</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     553 </span>            :   }
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span>            :   // If the offset falls outside of the frame, then don't paint the caret.
<span class="lineNum">     556 </span>            :   int32_t startOffset, endOffset;
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :   if (frame-&gt;IsTextFrame() &amp;&amp;</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :       (NS_FAILED(frame-&gt;GetOffsets(startOffset, endOffset)) ||</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :        startOffset &gt; frameOffset || endOffset &lt; frameOffset)) {</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     561 </span>            :   }
<span class="lineNum">     562 </span>            : 
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :   nsRect caretRect;</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :   nsRect hookRect;</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :   ComputeCaretRects(frame, frameOffset, &amp;caretRect, &amp;hookRect);</span>
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :   aRect-&gt;UnionRect(caretRect, hookRect);</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :   return frame;</span>
<span class="lineNum">     569 </span>            : }
<a name="570"><span class="lineNum">     570 </span>            : </a>
<span class="lineNum">     571 </span>            : nsIFrame*
<span class="lineNum">     572 </span><span class="lineNoCov">          0 : nsCaret::GetFrame(int32_t* aContentOffset) {</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :   return GetFrameAndOffset(GetSelectionInternal(),</span>
<span class="lineNum">     574 </span>            :                            mOverrideContent,
<span class="lineNum">     575 </span>            :                            mOverrideOffset,
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :                            aContentOffset);</span>
<a name="577"><span class="lineNum">     577 </span>            : }</a>
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineNoCov">          0 : void nsCaret::PaintCaret(DrawTarget&amp; aDrawTarget,</span>
<span class="lineNum">     580 </span>            :                          nsIFrame* aForFrame,
<span class="lineNum">     581 </span>            :                          const nsPoint &amp;aOffset)
<span class="lineNum">     582 </span>            : {
<span class="lineNum">     583 </span>            :   int32_t contentOffset;
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :   nsIFrame* frame = GetFrame(&amp;contentOffset);</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :   if (!frame) {</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     587 </span>            :   }
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :   NS_ASSERTION(frame == aForFrame, &quot;We're referring different frame&quot;);</span>
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :   int32_t appUnitsPerDevPixel = frame-&gt;PresContext()-&gt;AppUnitsPerDevPixel();</span>
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :   nsRect caretRect;</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :   nsRect hookRect;</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :   ComputeCaretRects(frame, contentOffset, &amp;caretRect, &amp;hookRect);</span>
<span class="lineNum">     595 </span>            : 
<span class="lineNum">     596 </span>            :   Rect devPxCaretRect =
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :     NSRectToSnappedRect(caretRect + aOffset, appUnitsPerDevPixel, aDrawTarget);</span>
<span class="lineNum">     598 </span>            :   Rect devPxHookRect =
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :     NSRectToSnappedRect(hookRect + aOffset, appUnitsPerDevPixel, aDrawTarget);</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :   ColorPattern color(ToDeviceColor(frame-&gt;GetCaretColorAt(contentOffset)));</span>
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :   aDrawTarget.FillRect(devPxCaretRect, color);</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :   if (!hookRect.IsEmpty()) {</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :     aDrawTarget.FillRect(devPxHookRect, color);</span>
<span class="lineNum">     605 </span>            :   }
<span class="lineNum">     606 </span>            : }
<a name="607"><span class="lineNum">     607 </span>            : </a>
<span class="lineNum">     608 </span>            : NS_IMETHODIMP
<span class="lineNum">     609 </span><span class="lineCov">         23 : nsCaret::NotifySelectionChanged(nsIDOMDocument *, nsISelection *aDomSel,</span>
<span class="lineNum">     610 </span>            :                                 int16_t aReason)
<span class="lineNum">     611 </span>            : {
<span class="lineNum">     612 </span><span class="lineCov">         23 :   if ((aReason &amp; nsISelectionListener::MOUSEUP_REASON) || !IsVisible())//this wont do</span>
<span class="lineNum">     613 </span><span class="lineCov">         23 :     return NS_OK;</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsISelection&gt; domSel(do_QueryReferent(mDomSelectionWeak));</span>
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            :   // The same caret is shared amongst the document and any text widgets it
<span class="lineNum">     618 </span>            :   // may contain. This means that the caret could get notifications from
<span class="lineNum">     619 </span>            :   // multiple selections.
<span class="lineNum">     620 </span>            :   //
<span class="lineNum">     621 </span>            :   // If this notification is for a selection that is not the one the
<span class="lineNum">     622 </span>            :   // the caret is currently interested in (mDomSelectionWeak), then there
<span class="lineNum">     623 </span>            :   // is nothing to do!
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :   if (domSel != aDomSel)</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     627 </span>            : 
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :   ResetBlinking();</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :   SchedulePaint();</span>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<a name="632"><span class="lineNum">     632 </span>            : }</a>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span><span class="lineCov">          2 : void nsCaret::ResetBlinking()</span>
<span class="lineNum">     635 </span>            : {
<span class="lineNum">     636 </span><span class="lineCov">          2 :   mIsBlinkOn = true;</span>
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span><span class="lineCov">          2 :   if (mReadOnly || !mVisible || mHideCount) {</span>
<span class="lineNum">     639 </span><span class="lineCov">          2 :     StopBlinking();</span>
<span class="lineNum">     640 </span><span class="lineCov">          2 :     return;</span>
<span class="lineNum">     641 </span>            :   }
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span>            :   uint32_t blinkRate = static_cast&lt;uint32_t&gt;(
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :     LookAndFeel::GetInt(LookAndFeel::eIntID_CaretBlinkTime,</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :                         kDefaultCaretBlinkRate));</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :   if (mBlinkRate == blinkRate) {</span>
<span class="lineNum">     647 </span>            :     // If the rate hasn't changed, then there is nothing to do.
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     649 </span>            :   }
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :   mBlinkRate = blinkRate;</span>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :   if (mBlinkTimer) {</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :     mBlinkTimer-&gt;Cancel();</span>
<span class="lineNum">     654 </span>            :   } else {
<span class="lineNum">     655 </span>            :     nsresult  err;
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :     mBlinkTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;, &amp;err);</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :     if (NS_FAILED(err))</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     659 </span>            :   }
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :   if (blinkRate &gt; 0) {</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :     mBlinkCount = Preferences::GetInt(&quot;ui.caretBlinkCount&quot;, -1);</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :     mBlinkTimer-&gt;InitWithNamedFuncCallback(CaretBlinkCallback, this, blinkRate,</span>
<span class="lineNum">     664 </span>            :                                            nsITimer::TYPE_REPEATING_SLACK,
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :                                            &quot;nsCaret::CaretBlinkCallback_timer&quot;);</span>
<span class="lineNum">     666 </span>            :   }
<a name="667"><span class="lineNum">     667 </span>            : }</a>
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span><span class="lineCov">         10 : void nsCaret::StopBlinking()</span>
<span class="lineNum">     670 </span>            : {
<span class="lineNum">     671 </span><span class="lineCov">         10 :   if (mBlinkTimer)</span>
<span class="lineNum">     672 </span>            :   {
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :     mBlinkTimer-&gt;Cancel();</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :     mBlinkRate = 0;</span>
<span class="lineNum">     675 </span>            :   }
<span class="lineNum">     676 </span><span class="lineCov">         10 : }</span>
<a name="677"><span class="lineNum">     677 </span>            : </a>
<span class="lineNum">     678 </span>            : nsresult
<span class="lineNum">     679 </span><span class="lineCov">          4 : nsCaret::GetCaretFrameForNodeOffset(nsFrameSelection*    aFrameSelection,</span>
<span class="lineNum">     680 </span>            :                                     nsIContent*          aContentNode,
<span class="lineNum">     681 </span>            :                                     int32_t              aOffset,
<span class="lineNum">     682 </span>            :                                     CaretAssociationHint aFrameHint,
<span class="lineNum">     683 </span>            :                                     nsBidiLevel          aBidiLevel,
<span class="lineNum">     684 </span>            :                                     nsIFrame**           aReturnFrame,
<span class="lineNum">     685 </span>            :                                     int32_t*             aReturnOffset)
<span class="lineNum">     686 </span>            : {
<span class="lineNum">     687 </span><span class="lineCov">          4 :   if (!aFrameSelection)</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">     689 </span><span class="lineCov">          4 :   nsIPresShell* presShell = aFrameSelection-&gt;GetShell();</span>
<span class="lineNum">     690 </span><span class="lineCov">          4 :   if (!presShell)</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineCov">          8 :   if (!aContentNode || !aContentNode-&gt;IsInComposedDoc() ||</span>
<span class="lineNum">     694 </span><span class="lineCov">          4 :       presShell-&gt;GetDocument() != aContentNode-&gt;GetComposedDoc())</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span><span class="lineCov">          4 :   nsIFrame* theFrame = nullptr;</span>
<span class="lineNum">     698 </span><span class="lineCov">          4 :   int32_t   theFrameOffset = 0;</span>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span><span class="lineCov">          4 :   theFrame = aFrameSelection-&gt;GetFrameForNodeOffset(</span>
<span class="lineNum">     701 </span>            :       aContentNode, aOffset, aFrameHint, &amp;theFrameOffset);
<span class="lineNum">     702 </span><span class="lineCov">          4 :   if (!theFrame)</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span>            :   // if theFrame is after a text frame that's logically at the end of the line
<span class="lineNum">     706 </span>            :   // (e.g. if theFrame is a &lt;br&gt; frame), then put the caret at the end of
<span class="lineNum">     707 </span>            :   // that text frame instead. This way, the caret will be positioned as if
<span class="lineNum">     708 </span>            :   // trailing whitespace was not trimmed.
<span class="lineNum">     709 </span><span class="lineCov">          4 :   AdjustCaretFrameForLineEnd(&amp;theFrame, &amp;theFrameOffset);</span>
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span>            :   // Mamdouh : modification of the caret to work at rtl and ltr with Bidi
<span class="lineNum">     712 </span>            :   //
<span class="lineNum">     713 </span>            :   // Direction Style from visibility-&gt;mDirection
<span class="lineNum">     714 </span>            :   // ------------------
<span class="lineNum">     715 </span>            :   // NS_STYLE_DIRECTION_LTR : LTR or Default
<span class="lineNum">     716 </span>            :   // NS_STYLE_DIRECTION_RTL
<span class="lineNum">     717 </span><span class="lineCov">          4 :   if (theFrame-&gt;PresContext()-&gt;BidiEnabled())</span>
<span class="lineNum">     718 </span>            :   {
<span class="lineNum">     719 </span>            :     // If there has been a reflow, take the caret Bidi level to be the level of the current frame
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :     if (aBidiLevel &amp; BIDI_LEVEL_UNDEFINED) {</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :       aBidiLevel = theFrame-&gt;GetEmbeddingLevel();</span>
<span class="lineNum">     722 </span>            :     }
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span>            :     int32_t start;
<span class="lineNum">     725 </span>            :     int32_t end;
<span class="lineNum">     726 </span>            :     nsIFrame* frameBefore;
<span class="lineNum">     727 </span>            :     nsIFrame* frameAfter;
<span class="lineNum">     728 </span>            :     nsBidiLevel levelBefore; // Bidi level of the character before the caret
<span class="lineNum">     729 </span>            :     nsBidiLevel levelAfter;  // Bidi level of the character after the caret
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :     theFrame-&gt;GetOffsets(start, end);</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     if (start == 0 || end == 0 || start == theFrameOffset || end == theFrameOffset)</span>
<span class="lineNum">     733 </span>            :     {
<span class="lineNum">     734 </span>            :       nsPrevNextBidiLevels levels = aFrameSelection-&gt;
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :         GetPrevNextBidiLevels(aContentNode, aOffset, false);</span>
<span class="lineNum">     736 </span>            : 
<span class="lineNum">     737 </span>            :       /* Boundary condition, we need to know the Bidi levels of the characters before and after the caret */
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :       if (levels.mFrameBefore || levels.mFrameAfter)</span>
<span class="lineNum">     739 </span>            :       {
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :         frameBefore = levels.mFrameBefore;</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :         frameAfter = levels.mFrameAfter;</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :         levelBefore = levels.mLevelBefore;</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :         levelAfter = levels.mLevelAfter;</span>
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :         if ((levelBefore != levelAfter) || (aBidiLevel != levelBefore))</span>
<span class="lineNum">     746 </span>            :         {
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :           aBidiLevel = std::max(aBidiLevel, std::min(levelBefore, levelAfter));                                  // rule c3</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :           aBidiLevel = std::min(aBidiLevel, std::max(levelBefore, levelAfter));                                  // rule c4</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :           if (aBidiLevel == levelBefore                                                                      // rule c1</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :               || (aBidiLevel &gt; levelBefore &amp;&amp; aBidiLevel &lt; levelAfter &amp;&amp;</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                   IS_SAME_DIRECTION(aBidiLevel, levelBefore))   // rule c5</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :               || (aBidiLevel &lt; levelBefore &amp;&amp; aBidiLevel &gt; levelAfter &amp;&amp;</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :                   IS_SAME_DIRECTION(aBidiLevel, levelBefore)))  // rule c9</span>
<span class="lineNum">     754 </span>            :           {
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :             if (theFrame != frameBefore)</span>
<span class="lineNum">     756 </span>            :             {
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :               if (frameBefore) // if there is a frameBefore, move into it</span>
<span class="lineNum">     758 </span>            :               {
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :                 theFrame = frameBefore;</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :                 theFrame-&gt;GetOffsets(start, end);</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :                 theFrameOffset = end;</span>
<span class="lineNum">     762 </span>            :               }
<span class="lineNum">     763 </span>            :               else
<span class="lineNum">     764 </span>            :               {
<span class="lineNum">     765 </span>            :                 // if there is no frameBefore, we must be at the beginning of the line
<span class="lineNum">     766 </span>            :                 // so we stay with the current frame.
<span class="lineNum">     767 </span>            :                 // Exception: when the first frame on the line has a different Bidi level from the paragraph level, there is no
<span class="lineNum">     768 </span>            :                 // real frame for the caret to be in. We have to find the visually first frame on the line.
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :                 nsBidiLevel baseLevel = frameAfter-&gt;GetBaseLevel();</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :                 if (baseLevel != levelAfter)</span>
<span class="lineNum">     771 </span>            :                 {
<span class="lineNum">     772 </span>            :                   nsPeekOffsetStruct pos(eSelectBeginLine, eDirPrevious, 0,
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :                                          nsPoint(0, 0), false, true, false,</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :                                          true, false);</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :                   if (NS_SUCCEEDED(frameAfter-&gt;PeekOffset(&amp;pos))) {</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :                     theFrame = pos.mResultFrame;</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                     theFrameOffset = pos.mContentOffset;</span>
<span class="lineNum">     778 </span>            :                   }
<span class="lineNum">     779 </span>            :                 }
<span class="lineNum">     780 </span>            :               }
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     782 </span>            :           }
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :           else if (aBidiLevel == levelAfter                                                                     // rule c2</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :                    || (aBidiLevel &gt; levelBefore &amp;&amp; aBidiLevel &lt; levelAfter &amp;&amp;</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :                        IS_SAME_DIRECTION(aBidiLevel, levelAfter))   // rule c6</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                    || (aBidiLevel &lt; levelBefore &amp;&amp; aBidiLevel &gt; levelAfter &amp;&amp;</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :                        IS_SAME_DIRECTION(aBidiLevel, levelAfter)))  // rule c10</span>
<span class="lineNum">     788 </span>            :           {
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :             if (theFrame != frameAfter)</span>
<span class="lineNum">     790 </span>            :             {
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :               if (frameAfter)</span>
<span class="lineNum">     792 </span>            :               {
<span class="lineNum">     793 </span>            :                 // if there is a frameAfter, move into it
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :                 theFrame = frameAfter;</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :                 theFrame-&gt;GetOffsets(start, end);</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :                 theFrameOffset = start;</span>
<span class="lineNum">     797 </span>            :               }
<span class="lineNum">     798 </span>            :               else
<span class="lineNum">     799 </span>            :               {
<span class="lineNum">     800 </span>            :                 // if there is no frameAfter, we must be at the end of the line
<span class="lineNum">     801 </span>            :                 // so we stay with the current frame.
<span class="lineNum">     802 </span>            :                 // Exception: when the last frame on the line has a different Bidi level from the paragraph level, there is no
<span class="lineNum">     803 </span>            :                 // real frame for the caret to be in. We have to find the visually last frame on the line.
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                 nsBidiLevel baseLevel = frameBefore-&gt;GetBaseLevel();</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :                 if (baseLevel != levelBefore)</span>
<span class="lineNum">     806 </span>            :                 {
<span class="lineNum">     807 </span>            :                   nsPeekOffsetStruct pos(eSelectEndLine, eDirNext, 0,
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :                                          nsPoint(0, 0), false, true, false,</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :                                          true, false);</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :                   if (NS_SUCCEEDED(frameBefore-&gt;PeekOffset(&amp;pos))) {</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :                     theFrame = pos.mResultFrame;</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :                     theFrameOffset = pos.mContentOffset;</span>
<span class="lineNum">     813 </span>            :                   }
<span class="lineNum">     814 </span>            :                 }
<span class="lineNum">     815 </span>            :               }
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     817 </span>            :           }
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :           else if (aBidiLevel &gt; levelBefore &amp;&amp; aBidiLevel &lt; levelAfter  // rule c7/8</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :                    &amp;&amp; IS_SAME_DIRECTION(levelBefore, levelAfter)        // before and after have the same parity</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                    &amp;&amp; !IS_SAME_DIRECTION(aBidiLevel, levelAfter))       // caret has different parity</span>
<span class="lineNum">     821 </span>            :           {
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :             if (NS_SUCCEEDED(aFrameSelection-&gt;GetFrameFromLevel(frameAfter, eDirNext, aBidiLevel, &amp;theFrame)))</span>
<span class="lineNum">     823 </span>            :             {
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :               theFrame-&gt;GetOffsets(start, end);</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :               levelAfter = theFrame-&gt;GetEmbeddingLevel();</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :               if (IS_LEVEL_RTL(aBidiLevel)) // c8: caret to the right of the rightmost character</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                 theFrameOffset = IS_LEVEL_RTL(levelAfter) ? start : end;</span>
<span class="lineNum">     828 </span>            :               else               // c7: caret to the left of the leftmost character
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                 theFrameOffset = IS_LEVEL_RTL(levelAfter) ? end : start;</span>
<span class="lineNum">     830 </span>            :             }
<span class="lineNum">     831 </span>            :           }
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :           else if (aBidiLevel &lt; levelBefore &amp;&amp; aBidiLevel &gt; levelAfter  // rule c11/12</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :                    &amp;&amp; IS_SAME_DIRECTION(levelBefore, levelAfter)        // before and after have the same parity</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :                    &amp;&amp; !IS_SAME_DIRECTION(aBidiLevel, levelAfter))       // caret has different parity</span>
<span class="lineNum">     835 </span>            :           {
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :             if (NS_SUCCEEDED(aFrameSelection-&gt;GetFrameFromLevel(frameBefore, eDirPrevious, aBidiLevel, &amp;theFrame)))</span>
<span class="lineNum">     837 </span>            :             {
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :               theFrame-&gt;GetOffsets(start, end);</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :               levelBefore = theFrame-&gt;GetEmbeddingLevel();</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :               if (IS_LEVEL_RTL(aBidiLevel)) // c12: caret to the left of the leftmost character</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :                 theFrameOffset = IS_LEVEL_RTL(levelBefore) ? end : start;</span>
<span class="lineNum">     842 </span>            :               else               // c11: caret to the right of the rightmost character
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :                 theFrameOffset = IS_LEVEL_RTL(levelBefore) ? start : end;</span>
<span class="lineNum">     844 </span>            :             }
<span class="lineNum">     845 </span>            :           }
<span class="lineNum">     846 </span>            :         }
<span class="lineNum">     847 </span>            :       }
<span class="lineNum">     848 </span>            :     }
<span class="lineNum">     849 </span>            :   }
<span class="lineNum">     850 </span>            : 
<span class="lineNum">     851 </span><span class="lineCov">          4 :   *aReturnFrame = theFrame;</span>
<span class="lineNum">     852 </span><span class="lineCov">          4 :   *aReturnOffset = theFrameOffset;</span>
<span class="lineNum">     853 </span><span class="lineCov">          4 :   return NS_OK;</span>
<a name="854"><span class="lineNum">     854 </span>            : }</a>
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineCov">         21 : size_t nsCaret::SizeOfIncludingThis(mozilla::MallocSizeOf aMallocSizeOf) const</span>
<span class="lineNum">     857 </span>            : {
<span class="lineNum">     858 </span><span class="lineCov">         21 :   size_t total = aMallocSizeOf(this);</span>
<span class="lineNum">     859 </span><span class="lineCov">         21 :   if (mPresShell) {</span>
<span class="lineNum">     860 </span>            :     // We only want the size of the nsWeakReference object, not the PresShell
<span class="lineNum">     861 </span>            :     // (since we don't own the PresShell).
<span class="lineNum">     862 </span><span class="lineCov">         21 :     total += mPresShell-&gt;SizeOfOnlyThis(aMallocSizeOf);</span>
<span class="lineNum">     863 </span>            :   }
<span class="lineNum">     864 </span><span class="lineCov">         21 :   if (mDomSelectionWeak) {</span>
<span class="lineNum">     865 </span>            :     // We only want size of the nsWeakReference object, not the selection
<span class="lineNum">     866 </span>            :     // (again, we don't own the selection).
<span class="lineNum">     867 </span><span class="lineCov">         21 :     total += mDomSelectionWeak-&gt;SizeOfOnlyThis(aMallocSizeOf);</span>
<span class="lineNum">     868 </span>            :   }
<span class="lineNum">     869 </span><span class="lineCov">         21 :   if (mBlinkTimer) {</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     total += mBlinkTimer-&gt;SizeOfIncludingThis(aMallocSizeOf);</span>
<span class="lineNum">     871 </span>            :   }
<span class="lineNum">     872 </span><span class="lineCov">         21 :   return total;</span>
<a name="873"><span class="lineNum">     873 </span>            : }</a>
<span class="lineNum">     874 </span>            : 
<span class="lineNum">     875 </span><span class="lineNoCov">          0 : bool nsCaret::IsMenuPopupHidingCaret()</span>
<span class="lineNum">     876 </span>            : {
<span class="lineNum">     877 </span>            : #ifdef MOZ_XUL
<span class="lineNum">     878 </span>            :   // Check if there are open popups.
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :   nsXULPopupManager *popMgr = nsXULPopupManager::GetInstance();</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :   nsTArray&lt;nsIFrame*&gt; popups;</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :   popMgr-&gt;GetVisiblePopups(popups);</span>
<span class="lineNum">     882 </span>            : 
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :   if (popups.Length() == 0)</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     return false; // No popups, so caret can't be hidden by them.</span>
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span>            :   // Get the selection focus content, that's where the caret would
<span class="lineNum">     887 </span>            :   // go if it was drawn.
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDOMNode&gt; node;</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsISelection&gt; domSelection = do_QueryReferent(mDomSelectionWeak);</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :   if (!domSelection)</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :     return true; // No selection/caret to draw.</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :   domSelection-&gt;GetFocusNode(getter_AddRefs(node));</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :   if (!node)</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :     return true; // No selection/caret to draw.</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIContent&gt; caretContent = do_QueryInterface(node);</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :   if (!caretContent)</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :     return true; // No selection/caret to draw.</span>
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span>            :   // If there's a menu popup open before the popup with
<span class="lineNum">     900 </span>            :   // the caret, don't show the caret.
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :   for (uint32_t i=0; i&lt;popups.Length(); i++) {</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :     nsMenuPopupFrame* popupFrame = static_cast&lt;nsMenuPopupFrame*&gt;(popups[i]);</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :     nsIContent* popupContent = popupFrame-&gt;GetContent();</span>
<span class="lineNum">     904 </span>            : 
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :     if (nsContentUtils::ContentIsDescendantOf(caretContent, popupContent)) {</span>
<span class="lineNum">     906 </span>            :       // The caret is in this popup. There were no menu popups before this
<span class="lineNum">     907 </span>            :       // popup, so don't hide the caret.
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">     909 </span>            :     }
<span class="lineNum">     910 </span>            : 
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :     if (popupFrame-&gt;PopupType() == ePopupTypeMenu &amp;&amp; !popupFrame-&gt;IsContextMenu()) {</span>
<span class="lineNum">     912 </span>            :       // This is an open menu popup. It does not contain the caret (else we'd
<span class="lineNum">     913 </span>            :       // have returned above). Even if the caret is in a subsequent popup,
<span class="lineNum">     914 </span>            :       // or another document/frame, it should be hidden.
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">     916 </span>            :     }
<span class="lineNum">     917 </span>            :   }
<span class="lineNum">     918 </span>            : #endif
<span class="lineNum">     919 </span>            : 
<span class="lineNum">     920 </span>            :   // There are no open menu popups, no need to hide the caret.
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">     922 </span>            : }
<a name="923"><span class="lineNum">     923 </span>            : </a>
<span class="lineNum">     924 </span>            : void
<span class="lineNum">     925 </span><span class="lineNoCov">          0 : nsCaret::ComputeCaretRects(nsIFrame* aFrame, int32_t aFrameOffset,</span>
<span class="lineNum">     926 </span>            :                            nsRect* aCaretRect, nsRect* aHookRect)
<span class="lineNum">     927 </span>            : {
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :   NS_ASSERTION(aFrame, &quot;Should have a frame here&quot;);</span>
<span class="lineNum">     929 </span>            : 
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :   WritingMode wm = aFrame-&gt;GetWritingMode();</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :   bool isVertical = wm.IsVertical();</span>
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span>            :   nscoord bidiIndicatorSize;
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :   *aCaretRect = GetGeometryForFrame(aFrame, aFrameOffset, &amp;bidiIndicatorSize);</span>
<span class="lineNum">     935 </span>            : 
<span class="lineNum">     936 </span>            :   // on RTL frames the right edge of mCaretRect must be equal to framePos
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :   const nsStyleVisibility* vis = aFrame-&gt;StyleVisibility();</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :   if (NS_STYLE_DIRECTION_RTL == vis-&gt;mDirection) {</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :     if (isVertical) {</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :       aCaretRect-&gt;y -= aCaretRect-&gt;height;</span>
<span class="lineNum">     941 </span>            :     } else {
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :       aCaretRect-&gt;x -= aCaretRect-&gt;width;</span>
<span class="lineNum">     943 </span>            :     }
<span class="lineNum">     944 </span>            :   }
<span class="lineNum">     945 </span>            : 
<span class="lineNum">     946 </span>            :   // Simon -- make a hook to draw to the left or right of the caret to show keyboard language direction
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :   aHookRect-&gt;SetEmpty();</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :   if (!IsBidiUI()) {</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     950 </span>            :   }
<span class="lineNum">     951 </span>            : 
<span class="lineNum">     952 </span>            :   bool isCaretRTL;
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :   nsIBidiKeyboard* bidiKeyboard = nsContentUtils::GetBidiKeyboard();</span>
<span class="lineNum">     954 </span>            :   // if bidiKeyboard-&gt;IsLangRTL() fails, there is no way to tell the
<span class="lineNum">     955 </span>            :   // keyboard direction, or the user has no right-to-left keyboard
<span class="lineNum">     956 </span>            :   // installed, so we never draw the hook.
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   if (bidiKeyboard &amp;&amp; NS_SUCCEEDED(bidiKeyboard-&gt;IsLangRTL(&amp;isCaretRTL))) {</span>
<span class="lineNum">     958 </span>            :     // If keyboard language is RTL, draw the hook on the left; if LTR, to the right
<span class="lineNum">     959 </span>            :     // The height of the hook rectangle is the same as the width of the caret
<span class="lineNum">     960 </span>            :     // rectangle.
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :     if (isVertical) {</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :       bool isSidewaysLR = wm.IsVerticalLR() &amp;&amp; !wm.IsLineInverted();</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :       if (isSidewaysLR) {</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :         aHookRect-&gt;SetRect(aCaretRect-&gt;x + bidiIndicatorSize,</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :                            aCaretRect-&gt;y + (!isCaretRTL ? bidiIndicatorSize * -1 :</span>
<span class="lineNum">     966 </span>            :                                                           aCaretRect-&gt;height),
<span class="lineNum">     967 </span>            :                            aCaretRect-&gt;height,
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :                            bidiIndicatorSize);</span>
<span class="lineNum">     969 </span>            :       } else {
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :         aHookRect-&gt;SetRect(aCaretRect-&gt;XMost() - bidiIndicatorSize,</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :                            aCaretRect-&gt;y + (isCaretRTL ? bidiIndicatorSize * -1 :</span>
<span class="lineNum">     972 </span>            :                                                          aCaretRect-&gt;height),
<span class="lineNum">     973 </span>            :                            aCaretRect-&gt;height,
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :                            bidiIndicatorSize);</span>
<span class="lineNum">     975 </span>            :       }
<span class="lineNum">     976 </span>            :     } else {
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :       aHookRect-&gt;SetRect(aCaretRect-&gt;x + (isCaretRTL ? bidiIndicatorSize * -1 :</span>
<span class="lineNum">     978 </span>            :                                                        aCaretRect-&gt;width),
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :                          aCaretRect-&gt;y + bidiIndicatorSize,</span>
<span class="lineNum">     980 </span>            :                          bidiIndicatorSize,
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :                          aCaretRect-&gt;width);</span>
<span class="lineNum">     982 </span>            :     }
<span class="lineNum">     983 </span>            :   }
<span class="lineNum">     984 </span>            : }
<a name="985"><span class="lineNum">     985 </span>            : </a>
<span class="lineNum">     986 </span>            : /* static */
<span class="lineNum">     987 </span><span class="lineNoCov">          0 : void nsCaret::CaretBlinkCallback(nsITimer* aTimer, void* aClosure)</span>
<span class="lineNum">     988 </span>            : {
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :   nsCaret* theCaret = reinterpret_cast&lt;nsCaret*&gt;(aClosure);</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :   if (!theCaret) {</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     992 </span>            :   }
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :   theCaret-&gt;mIsBlinkOn = !theCaret-&gt;mIsBlinkOn;</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :   theCaret-&gt;SchedulePaint();</span>
<span class="lineNum">     995 </span>            : 
<span class="lineNum">     996 </span>            :   // mBlinkCount of -1 means blink count is not enabled.
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :   if (theCaret-&gt;mBlinkCount == -1) {</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     999 </span>            :   }
<span class="lineNum">    1000 </span>            : 
<span class="lineNum">    1001 </span>            :   // Track the blink count, but only at end of a blink cycle.
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :   if (!theCaret-&gt;mIsBlinkOn) {</span>
<span class="lineNum">    1003 </span>            :     // If we exceeded the blink count, stop the timer.
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :     if (--theCaret-&gt;mBlinkCount &lt;= 0) {</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :       theCaret-&gt;StopBlinking();</span>
<span class="lineNum">    1006 </span>            :     }
<span class="lineNum">    1007 </span>            :   }
<span class="lineNum">    1008 </span>            : }
<a name="1009"><span class="lineNum">    1009 </span>            : </a>
<span class="lineNum">    1010 </span>            : void
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 : nsCaret::SetIgnoreUserModify(bool aIgnoreUserModify)</span>
<span class="lineNum">    1012 </span>            : {
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :   mIgnoreUserModify = aIgnoreUserModify;</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :   SchedulePaint();</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - layout/generic/nsSimplePageSequenceFrame.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">layout/generic</a> - nsSimplePageSequenceFrame.cpp<span style="font-size: 80%;"> (source / <a href="nsSimplePageSequenceFrame.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">401</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">29</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #include &quot;nsSimplePageSequenceFrame.h&quot;
<span class="lineNum">       7 </span>            : 
<span class="lineNum">       8 </span>            : #include &quot;DateTimeFormat.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;nsCOMPtr.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;nsDeviceContext.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsPresContext.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;gfxContext.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsGkAtoms.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsIPresShell.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsIPrintSettings.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsPageFrame.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsSubDocumentFrame.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsRegion.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsCSSFrameConstructor.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsDisplayList.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;nsHTMLCanvasFrame.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;mozilla/dom/HTMLCanvasElement.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;nsICanvasRenderingContextInternal.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsServiceManagerUtils.h&quot;
<span class="lineNum">      26 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #define OFFSET_NOT_SET -1
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : using namespace mozilla;
<span class="lineNum">      31 </span>            : using namespace mozilla::dom;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #include &quot;mozilla/Logging.h&quot;
<span class="lineNum">      34 </span>            : mozilla::LazyLogModule gLayoutPrintingLog(&quot;printing-layout&quot;);
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : #define PR_PL(_p1)  MOZ_LOG(gLayoutPrintingLog, mozilla::LogLevel::Debug, _p1)
<a name="37"><span class="lineNum">      37 </span>            : </a>
<span class="lineNum">      38 </span>            : nsSimplePageSequenceFrame*
<span class="lineNum">      39 </span><span class="lineNoCov">          0 : NS_NewSimplePageSequenceFrame(nsIPresShell* aPresShell, nsStyleContext* aContext)</span>
<span class="lineNum">      40 </span>            : {
<span class="lineNum">      41 </span><span class="lineNoCov">          0 :   return new (aPresShell) nsSimplePageSequenceFrame(aContext);</span>
<a name="42"><span class="lineNum">      42 </span>            : }</a>
<span class="lineNum">      43 </span>            : 
<a name="44"><span class="lineNum">      44 </span><span class="lineNoCov">          0 : NS_IMPL_FRAMEARENA_HELPERS(nsSimplePageSequenceFrame)</span></a>
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::nsSimplePageSequenceFrame(nsStyleContext* aContext)</span>
<span class="lineNum">      47 </span>            :   : nsContainerFrame(aContext, kClassID)
<span class="lineNum">      48 </span>            :   , mTotalPages(-1)
<span class="lineNum">      49 </span>            :   , mSelectionHeight(-1)
<span class="lineNum">      50 </span>            :   , mYSelOffset(0)
<span class="lineNum">      51 </span>            :   , mCalledBeginPage(false)
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   , mCurrentCanvasListSetup(false)</span>
<span class="lineNum">      53 </span>            : {
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :   nscoord halfInch = PresContext()-&gt;CSSTwipsToAppUnits(NS_INCHES_TO_TWIPS(0.5));</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :   mMargin.SizeTo(halfInch, halfInch, halfInch, halfInch);</span>
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            :   // XXX Unsafe to assume successful allocation
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :   mPageData = new nsSharedPageData();</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :   mPageData-&gt;mHeadFootFont =</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :     *PresContext()-&gt;GetDefaultFont(kGenericFont_serif,</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :                                    aContext-&gt;StyleFont()-&gt;mLanguage);</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :   mPageData-&gt;mHeadFootFont.size = nsPresContext::CSSPointsToAppUnits(10);</span>
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            :   // Doing this here so we only have to go get these formats once
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   SetPageNumberFormat(&quot;pagenumber&quot;,  &quot;%1$d&quot;, true);</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :   SetPageNumberFormat(&quot;pageofpages&quot;, &quot;%1$d of %2$d&quot;, false);</span>
<a name="67"><span class="lineNum">      67 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::~nsSimplePageSequenceFrame()</span>
<span class="lineNum">      70 </span>            : {
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :   delete mPageData;</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :   ResetPrintCanvasList();</span>
<a name="73"><span class="lineNum">      73 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span><span class="lineNoCov">          0 : NS_QUERYFRAME_HEAD(nsSimplePageSequenceFrame)</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :   NS_QUERYFRAME_ENTRY(nsIPageSequenceFrame)</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 : NS_QUERYFRAME_TAIL_INHERITING(nsContainerFrame)</span>
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            : //----------------------------------------------------------------------
<a name="80"><span class="lineNum">      80 </span>            : </a>
<span class="lineNum">      81 </span>            : void
<span class="lineNum">      82 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::SetDesiredSize(ReflowOutput&amp; aDesiredSize,</span>
<span class="lineNum">      83 </span>            :                                           const ReflowInput&amp; aReflowInput,
<span class="lineNum">      84 </span>            :                                           nscoord aWidth,
<span class="lineNum">      85 </span>            :                                           nscoord aHeight)
<span class="lineNum">      86 </span>            : {
<span class="lineNum">      87 </span>            :   // Aim to fill the whole size of the document, not only so we
<span class="lineNum">      88 </span>            :   // can act as a background in print preview but also handle overflow
<span class="lineNum">      89 </span>            :   // in child page frames correctly.
<span class="lineNum">      90 </span>            :   // Use availableISize so we don't cause a needless horizontal scrollbar.
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :   WritingMode wm = aReflowInput.GetWritingMode();</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :   nscoord scaledWidth = aWidth * PresContext()-&gt;GetPrintPreviewScale();</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :   nscoord scaledHeight = aHeight * PresContext()-&gt;GetPrintPreviewScale();</span>
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   nscoord scaledISize = (wm.IsVertical() ? scaledHeight : scaledWidth);</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :   nscoord scaledBSize = (wm.IsVertical() ? scaledWidth : scaledHeight);</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   aDesiredSize.ISize(wm) = std::max(scaledISize, aReflowInput.AvailableISize());</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   aDesiredSize.BSize(wm) = std::max(scaledBSize, aReflowInput.ComputedBSize());</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            : // Helper function to compute the offset needed to center a child
<a name="103"><span class="lineNum">     103 </span>            : // page-frame's margin-box inside our content-box.</a>
<span class="lineNum">     104 </span>            : nscoord
<span class="lineNum">     105 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::ComputeCenteringMargin(</span>
<span class="lineNum">     106 </span>            :   nscoord aContainerContentBoxWidth,
<span class="lineNum">     107 </span>            :   nscoord aChildPaddingBoxWidth,
<span class="lineNum">     108 </span>            :   const nsMargin&amp; aChildPhysicalMargin)
<span class="lineNum">     109 </span>            : {
<span class="lineNum">     110 </span>            :   // We'll be centering our child's margin-box, so get the size of that:
<span class="lineNum">     111 </span>            :   nscoord childMarginBoxWidth =
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     aChildPaddingBoxWidth + aChildPhysicalMargin.LeftRight();</span>
<span class="lineNum">     113 </span>            : 
<span class="lineNum">     114 </span>            :   // When rendered, our child's rect will actually be scaled up by the
<span class="lineNum">     115 </span>            :   // print-preview scale factor, via ComputePageSequenceTransform().
<span class="lineNum">     116 </span>            :   // We really want to center *that scaled-up rendering* inside of
<span class="lineNum">     117 </span>            :   // aContainerContentBoxWidth.  So, we scale up its margin-box here...
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :   auto ppScale = PresContext()-&gt;GetPrintPreviewScale();</span>
<span class="lineNum">     119 </span>            :   nscoord scaledChildMarginBoxWidth =
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :     NSToCoordRound(childMarginBoxWidth * ppScale);</span>
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            :   // ...and see we how much space is left over, when we subtract that scaled-up
<span class="lineNum">     123 </span>            :   // size from the container width:
<span class="lineNum">     124 </span>            :   nscoord scaledExtraSpace =
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     aContainerContentBoxWidth - scaledChildMarginBoxWidth;</span>
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   if (scaledExtraSpace &lt;= 0) {</span>
<span class="lineNum">     128 </span>            :     // (Don't bother centering if there's zero/negative space.)
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     130 </span>            :   }
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span>            :   // To center the child, we want to give it an additional left-margin of half
<span class="lineNum">     133 </span>            :   // of the extra space.  And then, we have to scale that space back down, so
<span class="lineNum">     134 </span>            :   // that it'll produce the correct scaled-up amount when we render (because
<span class="lineNum">     135 </span>            :   // rendering will scale it back up):
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :   return NSToCoordRound(scaledExtraSpace * 0.5 / ppScale);</span>
<span class="lineNum">     137 </span>            : }
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span>            : /*
<span class="lineNum">     140 </span>            :  * Note: we largely position/size out our children (page frames) using
<span class="lineNum">     141 </span>            :  * \*physical\* x/y/width/height values, because the print preview UI is always
<span class="lineNum">     142 </span>            :  * arranged in the same orientation, regardless of writing mode.
<a name="143"><span class="lineNum">     143 </span>            :  */</a>
<span class="lineNum">     144 </span>            : void
<span class="lineNum">     145 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::Reflow(nsPresContext*     aPresContext,</span>
<span class="lineNum">     146 </span>            :                                   ReflowOutput&amp;      aDesiredSize,
<span class="lineNum">     147 </span>            :                                   const ReflowInput&amp; aReflowInput,
<span class="lineNum">     148 </span>            :                                   nsReflowStatus&amp;    aStatus)
<span class="lineNum">     149 </span>            : {
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   MarkInReflow();</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   NS_PRECONDITION(aPresContext-&gt;IsRootPaginatedDocument(),</span>
<span class="lineNum">     152 </span>            :                   &quot;A Page Sequence is only for real pages&quot;);
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   DO_GLOBAL_REFLOW_COUNT(&quot;nsSimplePageSequenceFrame&quot;);</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   DISPLAY_REFLOW(aPresContext, this, aReflowInput, aDesiredSize, aStatus);</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   NS_FRAME_TRACE_REFLOW_IN(&quot;nsSimplePageSequenceFrame::Reflow&quot;);</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   aStatus.Reset();  // we're always complete</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            :   // Don't do incremental reflow until we've taught tables how to do
<span class="lineNum">     160 </span>            :   // it right in paginated mode.
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   if (!(GetStateBits() &amp; NS_FRAME_FIRST_REFLOW)) {</span>
<span class="lineNum">     162 </span>            :     // Return our desired size
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :     SetDesiredSize(aDesiredSize, aReflowInput, mSize.width, mSize.height);</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :     aDesiredSize.SetOverflowAreasToDesiredBounds();</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     FinishAndStoreOverflow(&amp;aDesiredSize);</span>
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     if (GetRect().Width() != aDesiredSize.Width()) {</span>
<span class="lineNum">     168 </span>            :       // Our width is changing; we need to re-center our children (our pages).
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :       for (nsFrameList::Enumerator e(mFrames); !e.AtEnd(); e.Next()) {</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         nsIFrame* child = e.get();</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :         nsMargin pageCSSMargin = child-&gt;GetUsedMargin();</span>
<span class="lineNum">     172 </span>            :         nscoord centeringMargin =
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :           ComputeCenteringMargin(aReflowInput.ComputedWidth(),</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :                                  child-&gt;GetRect().Width(),</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :                                  pageCSSMargin);</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :         nscoord newX = pageCSSMargin.left + centeringMargin;</span>
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span>            :         // Adjust the child's x-position:
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :         child-&gt;MovePositionBy(nsPoint(newX - child-&gt;GetNormalPosition().x, 0));</span>
<span class="lineNum">     180 </span>            :       }
<span class="lineNum">     181 </span>            :     }
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     183 </span>            :   }
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span>            :   // See if we can get a Print Settings from the Context
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   if (!mPageData-&gt;mPrintSettings &amp;&amp;</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :       aPresContext-&gt;Medium() == nsGkAtoms::print) {</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :       mPageData-&gt;mPrintSettings = aPresContext-&gt;GetPrintSettings();</span>
<span class="lineNum">     189 </span>            :   }
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span>            :   // now get out margins &amp; edges
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :   if (mPageData-&gt;mPrintSettings) {</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     nsIntMargin unwriteableTwips;</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :     mPageData-&gt;mPrintSettings-&gt;GetUnwriteableMarginInTwips(unwriteableTwips);</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :     NS_ASSERTION(unwriteableTwips.left  &gt;= 0 &amp;&amp; unwriteableTwips.top &gt;= 0 &amp;&amp;</span>
<span class="lineNum">     196 </span>            :                  unwriteableTwips.right &gt;= 0 &amp;&amp; unwriteableTwips.bottom &gt;= 0,
<span class="lineNum">     197 </span>            :                  &quot;Unwriteable twips should be non-negative&quot;);
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     nsIntMargin marginTwips;</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     mPageData-&gt;mPrintSettings-&gt;GetMarginInTwips(marginTwips);</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     mMargin = aPresContext-&gt;CSSTwipsToAppUnits(marginTwips + unwriteableTwips);</span>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            :     int16_t printType;
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :     mPageData-&gt;mPrintSettings-&gt;GetPrintRange(&amp;printType);</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :     mPrintRangeType = printType;</span>
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :     nsIntMargin edgeTwips;</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :     mPageData-&gt;mPrintSettings-&gt;GetEdgeInTwips(edgeTwips);</span>
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            :     // sanity check the values. three inches are sometimes needed
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :     int32_t inchInTwips = NS_INCHES_TO_INT_TWIPS(3.0);</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     edgeTwips.top    = clamped(edgeTwips.top,    0, inchInTwips);</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     edgeTwips.bottom = clamped(edgeTwips.bottom, 0, inchInTwips);</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :     edgeTwips.left   = clamped(edgeTwips.left,   0, inchInTwips);</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :     edgeTwips.right  = clamped(edgeTwips.right,  0, inchInTwips);</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :     mPageData-&gt;mEdgePaperMargin =</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :       aPresContext-&gt;CSSTwipsToAppUnits(edgeTwips + unwriteableTwips);</span>
<span class="lineNum">     219 </span>            :   }
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            :   // *** Special Override ***
<span class="lineNum">     222 </span>            :   // If this is a sub-sdoc (meaning it doesn't take the whole page)
<span class="lineNum">     223 </span>            :   // and if this Document is in the upper left hand corner
<span class="lineNum">     224 </span>            :   // we need to suppress the top margin or it will reflow too small
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   nsSize pageSize = aPresContext-&gt;GetPageSize();</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   mPageData-&gt;mReflowSize = pageSize;</span>
<span class="lineNum">     229 </span>            :   // If we're printing a selection, we need to reflow with
<span class="lineNum">     230 </span>            :   // unconstrained height, to make sure we'll get to the selection
<span class="lineNum">     231 </span>            :   // even if it's beyond the first page of content.
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :   if (nsIPrintSettings::kRangeSelection == mPrintRangeType) {</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :     mPageData-&gt;mReflowSize.height = NS_UNCONSTRAINEDSIZE;</span>
<span class="lineNum">     234 </span>            :   }
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :   mPageData-&gt;mReflowMargin = mMargin;</span>
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span>            :   // We use the CSS &quot;margin&quot; property on the -moz-page pseudoelement
<span class="lineNum">     238 </span>            :   // to determine the space between each page in print preview.
<span class="lineNum">     239 </span>            :   // Keep a running y-offset for each page.
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :   nscoord y = 0;</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :   nscoord maxXMost = 0;</span>
<span class="lineNum">     242 </span>            : 
<span class="lineNum">     243 </span>            :   // Tile the pages vertically
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :   ReflowOutput kidSize(aReflowInput);</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :   for (nsFrameList::Enumerator e(mFrames); !e.AtEnd(); e.Next()) {</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :     nsIFrame* kidFrame = e.get();</span>
<span class="lineNum">     247 </span>            :     // Set the shared data into the page frame before reflow
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :     nsPageFrame * pf = static_cast&lt;nsPageFrame*&gt;(kidFrame);</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :     pf-&gt;SetSharedPageData(mPageData);</span>
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span>            :     // Reflow the page
<span class="lineNum">     252 </span>            :     ReflowInput kidReflowInput(aPresContext, aReflowInput, kidFrame,
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :                                LogicalSize(kidFrame-&gt;GetWritingMode(),</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :                                                  pageSize));</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :     nsReflowStatus  status;</span>
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :     kidReflowInput.SetComputedISize(kidReflowInput.AvailableISize());</span>
<span class="lineNum">     258 </span>            :     //kidReflowInput.SetComputedHeight(kidReflowInput.AvailableHeight());
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :     PR_PL((&quot;AV ISize: %d   BSize: %d\n&quot;,</span>
<span class="lineNum">     260 </span>            :            kidReflowInput.AvailableISize(),
<span class="lineNum">     261 </span>            :            kidReflowInput.AvailableBSize()));
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     nsMargin pageCSSMargin = kidReflowInput.ComputedPhysicalMargin();</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     y += pageCSSMargin.top;</span>
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     nscoord x = pageCSSMargin.left;</span>
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span>            :     // Place and size the page.
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     ReflowChild(kidFrame, aPresContext, kidSize, kidReflowInput, x, y, 0, status);</span>
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span>            :     // If the page is narrower than our width, then center it horizontally:
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     x += ComputeCenteringMargin(aReflowInput.ComputedWidth(),</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :                                 kidSize.Width(), pageCSSMargin);</span>
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     FinishReflowChild(kidFrame, aPresContext, kidSize, nullptr, x, y, 0);</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :     y += kidSize.Height();</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     y += pageCSSMargin.bottom;</span>
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     maxXMost = std::max(maxXMost, x + kidSize.Width() + pageCSSMargin.right);</span>
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            :     // Is the page complete?
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :     nsIFrame* kidNextInFlow = kidFrame-&gt;GetNextInFlow();</span>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     if (status.IsFullyComplete()) {</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :       NS_ASSERTION(!kidNextInFlow, &quot;bad child flow list&quot;);</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     } else if (!kidNextInFlow) {</span>
<span class="lineNum">     287 </span>            :       // The page isn't complete and it doesn't have a next-in-flow, so
<span class="lineNum">     288 </span>            :       // create a continuing page.
<span class="lineNum">     289 </span>            :       nsIFrame* continuingPage = aPresContext-&gt;PresShell()-&gt;FrameConstructor()-&gt;
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :         CreateContinuingFrame(aPresContext, kidFrame, this);</span>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span>            :       // Add it to our child list
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :       mFrames.InsertFrame(nullptr, kidFrame, continuingPage);</span>
<span class="lineNum">     294 </span>            :     }
<span class="lineNum">     295 </span>            :   }
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            :   // Get Total Page Count
<span class="lineNum">     298 </span>            :   // XXXdholbert technically we could calculate this in the loop above,
<span class="lineNum">     299 </span>            :   // instead of needing a separate walk.
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :   int32_t pageTot = mFrames.GetLength();</span>
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            :   // Set Page Number Info
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   int32_t pageNum = 1;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :   for (nsFrameList::Enumerator e(mFrames); !e.AtEnd(); e.Next()) {</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(e.get()-&gt;IsPageFrame(),</span>
<span class="lineNum">     306 </span>            :                &quot;only expecting nsPageFrame children. Other children will make &quot;
<span class="lineNum">     307 </span>            :                &quot;this static_cast bogus &amp; probably violate other assumptions&quot;);
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :     nsPageFrame* pf = static_cast&lt;nsPageFrame*&gt;(e.get());</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :     pf-&gt;SetPageNumInfo(pageNum, pageTot);</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :     pageNum++;</span>
<span class="lineNum">     311 </span>            :   }
<span class="lineNum">     312 </span>            : 
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   nsAutoString formattedDateString;</span>
<span class="lineNum">     314 </span>            :   time_t ltime;
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :   time( &amp;ltime );</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(DateTimeFormat::FormatTime(kDateFormatShort,</span>
<span class="lineNum">     317 </span>            :                                               kTimeFormatNoSeconds,
<span class="lineNum">     318 </span>            :                                               ltime,
<span class="lineNum">     319 </span>            :                                               formattedDateString))) {
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     SetDateTimeStr(formattedDateString);</span>
<span class="lineNum">     321 </span>            :   }
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span>            :   // Return our desired size
<span class="lineNum">     324 </span>            :   // Adjust the reflow size by PrintPreviewScale so the scrollbars end up the
<span class="lineNum">     325 </span>            :   // correct size
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   SetDesiredSize(aDesiredSize, aReflowInput, maxXMost, y);</span>
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :   aDesiredSize.SetOverflowAreasToDesiredBounds();</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :   FinishAndStoreOverflow(&amp;aDesiredSize);</span>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span>            :   // cache the size so we can set the desired size
<span class="lineNum">     332 </span>            :   // for the other reflows that happen
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   mSize.width  = maxXMost;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :   mSize.height = y;</span>
<span class="lineNum">     335 </span>            : 
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :   NS_FRAME_TRACE_REFLOW_OUT(&quot;nsSimplePageSequeceFrame::Reflow&quot;, aStatus);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :   NS_FRAME_SET_TRUNCATION(aStatus, aReflowInput, aDesiredSize);</span>
<span class="lineNum">     338 </span>            : }
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span>            : //----------------------------------------------------------------------
<span class="lineNum">     341 </span>            : 
<a name="342"><span class="lineNum">     342 </span>            : #ifdef DEBUG_FRAME_DUMP</a>
<span class="lineNum">     343 </span>            : nsresult
<span class="lineNum">     344 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::GetFrameName(nsAString&amp; aResult) const</span>
<span class="lineNum">     345 </span>            : {
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :   return MakeFrameName(NS_LITERAL_STRING(&quot;SimplePageSequence&quot;), aResult);</span>
<span class="lineNum">     347 </span>            : }
<span class="lineNum">     348 </span>            : #endif
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span>            : //====================================================================
<span class="lineNum">     351 </span>            : //== Asynch Printing
<a name="352"><span class="lineNum">     352 </span>            : //====================================================================</a>
<span class="lineNum">     353 </span>            : NS_IMETHODIMP
<span class="lineNum">     354 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::GetCurrentPageNum(int32_t* aPageNum)</span>
<span class="lineNum">     355 </span>            : {
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aPageNum);</span>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   *aPageNum = mPageNum;</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     360 </span>            : }
<a name="361"><span class="lineNum">     361 </span>            : </a>
<span class="lineNum">     362 </span>            : NS_IMETHODIMP
<span class="lineNum">     363 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::GetNumPages(int32_t* aNumPages)</span>
<span class="lineNum">     364 </span>            : {
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aNumPages);</span>
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   *aNumPages = mTotalPages;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     369 </span>            : }
<a name="370"><span class="lineNum">     370 </span>            : </a>
<span class="lineNum">     371 </span>            : NS_IMETHODIMP
<span class="lineNum">     372 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::IsDoingPrintRange(bool* aDoing)</span>
<span class="lineNum">     373 </span>            : {
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aDoing);</span>
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :   *aDoing = mDoingPageRange;</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     378 </span>            : }
<a name="379"><span class="lineNum">     379 </span>            : </a>
<span class="lineNum">     380 </span>            : NS_IMETHODIMP
<span class="lineNum">     381 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::GetPrintRange(int32_t* aFromPage, int32_t* aToPage)</span>
<span class="lineNum">     382 </span>            : {
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aFromPage);</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aToPage);</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   *aFromPage = mFromPageNum;</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   *aToPage   = mToPageNum;</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     389 </span>            : }
<span class="lineNum">     390 </span>            : 
<a name="391"><span class="lineNum">     391 </span>            : // Helper Function</a>
<span class="lineNum">     392 </span>            : void
<span class="lineNum">     393 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::SetPageNumberFormat(const char* aPropName, const char* aDefPropVal, bool aPageNumOnly)</span>
<span class="lineNum">     394 </span>            : {
<span class="lineNum">     395 </span>            :   // Doing this here so we only have to go get these formats once
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :   nsXPIDLString pageNumberFormat;</span>
<span class="lineNum">     397 </span>            :   // Now go get the Localized Page Formating String
<span class="lineNum">     398 </span>            :   nsresult rv =
<span class="lineNum">     399 </span>            :     nsContentUtils::GetLocalizedString(nsContentUtils::ePRINTING_PROPERTIES,
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :                                        aPropName, pageNumberFormat);</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) { // back stop formatting</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     pageNumberFormat.AssignASCII(aDefPropVal);</span>
<span class="lineNum">     403 </span>            :   }
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :   SetPageNumberFormat(pageNumberFormat, aPageNumOnly);</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 : }</span>
<a name="407"><span class="lineNum">     407 </span>            : </a>
<span class="lineNum">     408 </span>            : NS_IMETHODIMP
<span class="lineNum">     409 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::StartPrint(nsPresContext*    aPresContext,</span>
<span class="lineNum">     410 </span>            :                                       nsIPrintSettings* aPrintSettings,
<span class="lineNum">     411 </span>            :                                       const nsAString&amp;  aDocTitle,
<span class="lineNum">     412 </span>            :                                       const nsAString&amp;  aDocURL)
<span class="lineNum">     413 </span>            : {
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aPresContext);</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aPrintSettings);</span>
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :   if (!mPageData-&gt;mPrintSettings) {</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     mPageData-&gt;mPrintSettings = aPrintSettings;</span>
<span class="lineNum">     419 </span>            :   }
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :   if (!aDocTitle.IsEmpty()) {</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :     mPageData-&gt;mDocTitle = aDocTitle;</span>
<span class="lineNum">     423 </span>            :   }
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :   if (!aDocURL.IsEmpty()) {</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :     mPageData-&gt;mDocURL = aDocURL;</span>
<span class="lineNum">     426 </span>            :   }
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :   aPrintSettings-&gt;GetStartPageRange(&amp;mFromPageNum);</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :   aPrintSettings-&gt;GetEndPageRange(&amp;mToPageNum);</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :   aPrintSettings-&gt;GetPageRanges(mPageRanges);</span>
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :   mDoingPageRange = nsIPrintSettings::kRangeSpecifiedPageRange == mPrintRangeType ||</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                     nsIPrintSettings::kRangeSelection == mPrintRangeType;</span>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span>            :   // If printing a range of pages make sure at least the starting page
<span class="lineNum">     436 </span>            :   // number is valid
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :   int32_t totalPages = mFrames.GetLength();</span>
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :   if (mDoingPageRange) {</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     if (mFromPageNum &gt; totalPages) {</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :       return NS_ERROR_INVALID_ARG;</span>
<span class="lineNum">     442 </span>            :     }
<span class="lineNum">     443 </span>            :   }
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span>            :   // Begin printing of the document
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :   nsresult rv = NS_OK;</span>
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span>            :   // Determine if we are rendering only the selection
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :   aPresContext-&gt;SetIsRenderingOnlySelection(nsIPrintSettings::kRangeSelection == mPrintRangeType);</span>
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   if (mDoingPageRange) {</span>
<span class="lineNum">     453 </span>            :     // XXX because of the hack for making the selection all print on one page
<span class="lineNum">     454 </span>            :     // we must make sure that the page is sized correctly before printing.
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     nscoord height = aPresContext-&gt;GetPageSize().height;</span>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     int32_t pageNum = 1;</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :     nscoord y = 0;//mMargin.top;</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :     for (nsFrameList::Enumerator e(mFrames); !e.AtEnd(); e.Next()) {</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :       nsIFrame* page = e.get();</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :       if (pageNum &gt;= mFromPageNum &amp;&amp; pageNum &lt;= mToPageNum) {</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :         nsRect rect = page-&gt;GetRect();</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :         rect.y = y;</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :         rect.height = height;</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :         page-&gt;SetRect(rect);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :         y += rect.height + mMargin.top + mMargin.bottom;</span>
<span class="lineNum">     468 </span>            :       }
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :       pageNum++;</span>
<span class="lineNum">     470 </span>            :     }
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            :     // adjust total number of pages
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     if (nsIPrintSettings::kRangeSelection != mPrintRangeType) {</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :       totalPages = pageNum - 1;</span>
<span class="lineNum">     475 </span>            :     }
<span class="lineNum">     476 </span>            :   }
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :   mPageNum = 1;</span>
<span class="lineNum">     479 </span>            : 
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :   if (mTotalPages == -1) {</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     mTotalPages = totalPages;</span>
<span class="lineNum">     482 </span>            :   }
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">     485 </span>            : }
<a name="486"><span class="lineNum">     486 </span>            : </a>
<span class="lineNum">     487 </span>            : void
<span class="lineNum">     488 </span><span class="lineNoCov">          0 : GetPrintCanvasElementsInFrame(nsIFrame* aFrame, nsTArray&lt;RefPtr&lt;HTMLCanvasElement&gt; &gt;* aArr)</span>
<span class="lineNum">     489 </span>            : {
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :   if (!aFrame) {</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     492 </span>            :   }
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :   for (nsIFrame::ChildListIterator childLists(aFrame);</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :     !childLists.IsDone(); childLists.Next()) {</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     nsFrameList children = childLists.CurrentList();</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :     for (nsFrameList::Enumerator e(children); !e.AtEnd(); e.Next()) {</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :       nsIFrame* child = e.get();</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span>            :       // Check if child is a nsHTMLCanvasFrame.
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :       nsHTMLCanvasFrame* canvasFrame = do_QueryFrame(child);</span>
<span class="lineNum">     502 </span>            : 
<span class="lineNum">     503 </span>            :       // If there is a canvasFrame, try to get actual canvas element.
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :       if (canvasFrame) {</span>
<span class="lineNum">     505 </span>            :         HTMLCanvasElement* canvas =
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :           HTMLCanvasElement::FromContentOrNull(canvasFrame-&gt;GetContent());</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :         if (canvas &amp;&amp; canvas-&gt;GetMozPrintCallback()) {</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :           aArr-&gt;AppendElement(canvas);</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     510 </span>            :         }
<span class="lineNum">     511 </span>            :       }
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :       if (!child-&gt;PrincipalChildList().FirstChild()) {</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :         nsSubDocumentFrame* subdocumentFrame = do_QueryFrame(child);</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :         if (subdocumentFrame) {</span>
<span class="lineNum">     516 </span>            :           // Descend into the subdocument
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :           nsIFrame* root = subdocumentFrame-&gt;GetSubdocumentRootFrame();</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :           child = root;</span>
<span class="lineNum">     519 </span>            :         }
<span class="lineNum">     520 </span>            :       }
<span class="lineNum">     521 </span>            :       // The current child is not a nsHTMLCanvasFrame OR it is but there is
<span class="lineNum">     522 </span>            :       // no HTMLCanvasElement on it. Check if children of `child` might
<span class="lineNum">     523 </span>            :       // contain a HTMLCanvasElement.
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :       GetPrintCanvasElementsInFrame(child, aArr);</span>
<span class="lineNum">     525 </span>            :     }
<span class="lineNum">     526 </span>            :   }
<span class="lineNum">     527 </span>            : }
<a name="528"><span class="lineNum">     528 </span>            : </a>
<span class="lineNum">     529 </span>            : void
<span class="lineNum">     530 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::DetermineWhetherToPrintPage()</span>
<span class="lineNum">     531 </span>            : {
<span class="lineNum">     532 </span>            :   // See whether we should print this page
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :   mPrintThisPage = true;</span>
<span class="lineNum">     534 </span>            :   bool printEvenPages, printOddPages;
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :   mPageData-&gt;mPrintSettings-&gt;GetPrintOptions(nsIPrintSettings::kPrintEvenPages, &amp;printEvenPages);</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :   mPageData-&gt;mPrintSettings-&gt;GetPrintOptions(nsIPrintSettings::kPrintOddPages, &amp;printOddPages);</span>
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span>            :   // If printing a range of pages check whether the page number is in the
<span class="lineNum">     539 </span>            :   // range of pages to print
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :   if (mDoingPageRange) {</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :     if (mPageNum &lt; mFromPageNum) {</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :       mPrintThisPage = false;</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     } else if (mPageNum &gt; mToPageNum) {</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :       mPageNum++;</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :       mPrintThisPage = false;</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     547 </span>            :     } else {
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :       int32_t length = mPageRanges.Length();</span>
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span>            :       // Page ranges are pairs (start, end)
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :       if (length &amp;&amp; (length % 2 == 0)) {</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :         mPrintThisPage = false;</span>
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span>            :         int32_t i;
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; length; i += 2) {</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :           if (mPageRanges[i] &lt;= mPageNum &amp;&amp; mPageNum &lt;= mPageRanges[i+1]) {</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :             mPrintThisPage = true;</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     559 </span>            :           }
<span class="lineNum">     560 </span>            :         }
<span class="lineNum">     561 </span>            :       }
<span class="lineNum">     562 </span>            :     }
<span class="lineNum">     563 </span>            :   }
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span>            :   // Check for printing of odd and even pages
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :   if (mPageNum &amp; 0x1) {</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     if (!printOddPages) {</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :       mPrintThisPage = false;  // don't print odd numbered page</span>
<span class="lineNum">     569 </span>            :     }
<span class="lineNum">     570 </span>            :   } else {
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :     if (!printEvenPages) {</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :       mPrintThisPage = false;  // don't print even numbered page</span>
<span class="lineNum">     573 </span>            :     }
<span class="lineNum">     574 </span>            :   }
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :   if (nsIPrintSettings::kRangeSelection == mPrintRangeType) {</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     mPrintThisPage = true;</span>
<span class="lineNum">     578 </span>            :   }
<span class="lineNum">     579 </span>            : }
<a name="580"><span class="lineNum">     580 </span>            : </a>
<span class="lineNum">     581 </span>            : nsIFrame*
<span class="lineNum">     582 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::GetCurrentPageFrame()</span>
<span class="lineNum">     583 </span>            : {
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :   int32_t i = 1;</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :   for (nsFrameList::Enumerator childFrames(mFrames); !childFrames.AtEnd();</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :        childFrames.Next()) {</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :     if (i == mPageNum) {</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :       return childFrames.get();</span>
<span class="lineNum">     589 </span>            :     }
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :     ++i;</span>
<span class="lineNum">     591 </span>            :   }
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :   return nullptr;</span>
<span class="lineNum">     593 </span>            : }
<a name="594"><span class="lineNum">     594 </span>            : </a>
<span class="lineNum">     595 </span>            : NS_IMETHODIMP
<span class="lineNum">     596 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::PrePrintNextPage(nsITimerCallback* aCallback, bool* aDone)</span>
<span class="lineNum">     597 </span>            : {
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :   nsIFrame* currentPage = GetCurrentPageFrame();</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :   if (!currentPage) {</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :     *aDone = true;</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">     602 </span>            :   }
<span class="lineNum">     603 </span>            : 
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :   DetermineWhetherToPrintPage();</span>
<span class="lineNum">     605 </span>            :   // Nothing to do if the current page doesn't get printed OR rendering to
<span class="lineNum">     606 </span>            :   // preview. For preview, the `CallPrintCallback` is called from within the
<span class="lineNum">     607 </span>            :   // HTMLCanvasElement::HandlePrintCallback.
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :   if (!mPrintThisPage || !PresContext()-&gt;IsRootPaginatedDocument()) {</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :     *aDone = true;</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     611 </span>            :   }
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span>            :   // If the canvasList is null, then generate it and start the render
<span class="lineNum">     614 </span>            :   // process for all the canvas.
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :   if (!mCurrentCanvasListSetup) {</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :     mCurrentCanvasListSetup = true;</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :     GetPrintCanvasElementsInFrame(currentPage, &amp;mCurrentCanvasList);</span>
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     if (mCurrentCanvasList.Length() != 0) {</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :       nsresult rv = NS_OK;</span>
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span>            :       // Begin printing of the document
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :       nsDeviceContext *dc = PresContext()-&gt;DeviceContext();</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :       PR_PL((&quot;\n&quot;));</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :       PR_PL((&quot;***************** BeginPage *****************\n&quot;));</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :       rv = dc-&gt;BeginPage();</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :       mCalledBeginPage = true;</span>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :       RefPtr&lt;gfxContext&gt; renderingContext = dc-&gt;CreateRenderingContext();</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :       NS_ENSURE_TRUE(renderingContext, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :       DrawTarget* drawTarget = renderingContext-&gt;GetDrawTarget();</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :       if (NS_WARN_IF(!drawTarget)) {</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :         return NS_ERROR_FAILURE;</span>
<span class="lineNum">     637 </span>            :       }
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :       for (int32_t i = mCurrentCanvasList.Length() - 1; i &gt;= 0 ; i--) {</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :         HTMLCanvasElement* canvas = mCurrentCanvasList[i];</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :         nsIntSize size = canvas-&gt;GetSize();</span>
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span>            :         RefPtr&lt;DrawTarget&gt; canvasTarget =
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :           drawTarget-&gt;CreateSimilarDrawTarget(size, drawTarget-&gt;GetFormat());</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         if (!canvasTarget) {</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     647 </span>            :         }
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :         nsICanvasRenderingContextInternal* ctx = canvas-&gt;GetContextAtIndex(0);</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :         if (!ctx) {</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     652 </span>            :         }
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span>            :         // Initialize the context with the new DrawTarget.
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :         ctx-&gt;InitializeWithDrawTarget(nullptr, WrapNotNull(canvasTarget));</span>
<span class="lineNum">     656 </span>            : 
<span class="lineNum">     657 </span>            :         // Start the rendering process.
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :         AutoWeakFrame weakFrame = this;</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :         canvas-&gt;DispatchPrintCallback(aCallback);</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :         NS_ENSURE_STATE(weakFrame.IsAlive());</span>
<span class="lineNum">     661 </span>            :       }
<span class="lineNum">     662 </span>            :     }
<span class="lineNum">     663 </span>            :   }
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :   uint32_t doneCounter = 0;</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :   for (int32_t i = mCurrentCanvasList.Length() - 1; i &gt;= 0 ; i--) {</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :     HTMLCanvasElement* canvas = mCurrentCanvasList[i];</span>
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :     if (canvas-&gt;IsPrintCallbackDone()) {</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :       doneCounter++;</span>
<span class="lineNum">     670 </span>            :     }
<span class="lineNum">     671 </span>            :   }
<span class="lineNum">     672 </span>            :   // If all canvas have finished rendering, return true, otherwise false.
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :   *aDone = doneCounter == mCurrentCanvasList.Length();</span>
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     676 </span>            : }
<a name="677"><span class="lineNum">     677 </span>            : </a>
<span class="lineNum">     678 </span>            : NS_IMETHODIMP
<span class="lineNum">     679 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::ResetPrintCanvasList()</span>
<span class="lineNum">     680 </span>            : {
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :   for (int32_t i = mCurrentCanvasList.Length() - 1; i &gt;= 0 ; i--) {</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :     HTMLCanvasElement* canvas = mCurrentCanvasList[i];</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :     canvas-&gt;ResetPrintCallback();</span>
<span class="lineNum">     684 </span>            :   }
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :   mCurrentCanvasList.Clear();</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :   mCurrentCanvasListSetup = false;</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     689 </span>            : }
<a name="690"><span class="lineNum">     690 </span>            : </a>
<span class="lineNum">     691 </span>            : NS_IMETHODIMP
<span class="lineNum">     692 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::PrintNextPage()</span>
<span class="lineNum">     693 </span>            : {
<span class="lineNum">     694 </span>            :   // This method would be very straightforward except that the
<span class="lineNum">     695 </span>            :   // &quot;Print Selection Only&quot; functionality (which is a broken mess) is
<span class="lineNum">     696 </span>            :   // integrated here.  The thing to understand is that if we're printing a
<span class="lineNum">     697 </span>            :   // selection (which may contain multiple ranges) then we only enter this
<span class="lineNum">     698 </span>            :   // function once since the content to print is laid out as one arbitrarily
<span class="lineNum">     699 </span>            :   // long nsPageFrame instead of multiple nsPageFrames that are sized to fit
<span class="lineNum">     700 </span>            :   // the printer paper size(!).  Each of the &quot;pages&quot; between the start and end
<span class="lineNum">     701 </span>            :   // of the selection are printed by offsetting the nsPageContentFrame by the
<span class="lineNum">     702 </span>            :   // index of the page being printed and then drawing the nsPageContentFrame.
<span class="lineNum">     703 </span>            :   // This does not work for IFrames.
<span class="lineNum">     704 </span>            :   //
<span class="lineNum">     705 </span>            :   // Note: When print al the pages or a page range the printed page shows the
<span class="lineNum">     706 </span>            :   // actual page number, when printing selection it prints the page number starting
<span class="lineNum">     707 </span>            :   // with the first page of the selection. For example if the user has a
<span class="lineNum">     708 </span>            :   // selection that starts on page 2 and ends on page 3, the page numbers when
<span class="lineNum">     709 </span>            :   // print are 1 and then two (which is different than printing a page range, where
<span class="lineNum">     710 </span>            :   // the page numbers would have been 2 and then 3)
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :   nsIFrame* currentPageFrame = GetCurrentPageFrame();</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :   if (!currentPageFrame) {</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">     715 </span>            :   }
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :   nsresult rv = NS_OK;</span>
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :   DetermineWhetherToPrintPage();</span>
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :   if (mPrintThisPage) {</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :     nsDeviceContext* dc = PresContext()-&gt;DeviceContext();</span>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :     nsPageFrame * pf = static_cast&lt;nsPageFrame*&gt;(currentPageFrame);</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :     pf-&gt;SetPageNumInfo(mPageNum, mTotalPages);</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :     pf-&gt;SetSharedPageData(mPageData);</span>
<span class="lineNum">     727 </span>            : 
<span class="lineNum">     728 </span>            :     // Only used if we're printing a selection:
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :     nsIFrame* selectionContentFrame = nullptr;</span>
<span class="lineNum">     730 </span>            :     nscoord pageContentHeight =
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :       PresContext()-&gt;GetPageSize().height - (mMargin.top + mMargin.bottom);</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     nscoord selectionY = pageContentHeight;</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :     int32_t selectionCurrentPageNum = 1;</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :     bool haveUnfinishedSelectionToPrint = false;</span>
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :     if (mSelectionHeight &gt;= 0) {</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :       selectionContentFrame = currentPageFrame-&gt;PrincipalChildList().FirstChild();</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :       MOZ_ASSERT(selectionContentFrame-&gt;IsPageContentFrame() &amp;&amp;</span>
<span class="lineNum">     739 </span>            :                  !selectionContentFrame-&gt;GetNextSibling(),
<span class="lineNum">     740 </span>            :                  &quot;Unexpected frame tree&quot;);
<span class="lineNum">     741 </span>            :       // To print a selection we reposition the page content frame for each
<span class="lineNum">     742 </span>            :       // page.  We can do this (and not have to bother resetting the position
<span class="lineNum">     743 </span>            :       // after we're done) because we are printing from a static clone document
<span class="lineNum">     744 </span>            :       // that is thrown away after we finish printing.
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :       selectionContentFrame-&gt;SetPosition(selectionContentFrame-&gt;GetPosition() +</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :                                          nsPoint(0, -mYSelOffset));</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :       nsContainerFrame::PositionChildViews(selectionContentFrame);</span>
<span class="lineNum">     748 </span>            :     }
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :     do {</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :       if (PresContext()-&gt;IsRootPaginatedDocument()) {</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :         if (!mCalledBeginPage) {</span>
<span class="lineNum">     753 </span>            :           // We must make sure BeginPage() has been called since some printing
<span class="lineNum">     754 </span>            :           // backends can't give us a valid rendering context for a [physical]
<span class="lineNum">     755 </span>            :           // page otherwise.
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :           PR_PL((&quot;\n&quot;));</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :           PR_PL((&quot;***************** BeginPage *****************\n&quot;));</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :           rv = dc-&gt;BeginPage();</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :           NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     760 </span>            :         }
<span class="lineNum">     761 </span>            : 
<span class="lineNum">     762 </span>            :         // Reset this flag. We reset it early here because if we loop around to
<span class="lineNum">     763 </span>            :         // print another page's worth of selection we need to call BeginPage
<span class="lineNum">     764 </span>            :         // again:
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :         mCalledBeginPage = false;</span>
<span class="lineNum">     766 </span>            :       }
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :       PR_PL((&quot;SeqFr::PrintNextPage -&gt; %p PageNo: %d&quot;, pf, mPageNum));</span>
<span class="lineNum">     769 </span>            : 
<span class="lineNum">     770 </span>            :       // CreateRenderingContext can fail
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :       RefPtr&lt;gfxContext&gt; gCtx = dc-&gt;CreateRenderingContext();</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :       NS_ENSURE_TRUE(gCtx, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">     773 </span>            : 
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :       nsRect drawingRect(nsPoint(0, 0), currentPageFrame-&gt;GetSize());</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :       nsRegion drawingRegion(drawingRect);</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :       nsLayoutUtils::PaintFrame(gCtx, currentPageFrame,</span>
<span class="lineNum">     777 </span>            :                                 drawingRegion, NS_RGBA(0,0,0,0),
<span class="lineNum">     778 </span>            :                                 nsDisplayListBuilderMode::PAINTING,
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :                                 nsLayoutUtils::PaintFrameFlags::PAINT_SYNC_DECODE_IMAGES);</span>
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :       if (mSelectionHeight &gt;= 0) {</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :         haveUnfinishedSelectionToPrint = (selectionY &lt; mSelectionHeight);</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :         if (haveUnfinishedSelectionToPrint) {</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :           selectionY += pageContentHeight;</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :           selectionCurrentPageNum++;</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :           pf-&gt;SetPageNumInfo(selectionCurrentPageNum, mTotalPages);</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :           selectionContentFrame-&gt;SetPosition(selectionContentFrame-&gt;GetPosition() +</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :                                              nsPoint(0, -pageContentHeight));</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :           nsContainerFrame::PositionChildViews(selectionContentFrame);</span>
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span>            :           // We're going to loop and call BeginPage to print another page's worth
<span class="lineNum">     792 </span>            :           // of selection so we need to call EndPage first.  (Otherwise, EndPage
<span class="lineNum">     793 </span>            :           // is called in DoEndPage.)
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :           PR_PL((&quot;***************** End Page (PrintNextPage) *****************\n&quot;));</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :           rv = dc-&gt;EndPage();</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :           NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     797 </span>            :         }
<span class="lineNum">     798 </span>            :       }
<span class="lineNum">     799 </span>            :     } while (haveUnfinishedSelectionToPrint);
<span class="lineNum">     800 </span>            :   }
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">     802 </span>            : }
<a name="803"><span class="lineNum">     803 </span>            : </a>
<span class="lineNum">     804 </span>            : NS_IMETHODIMP
<span class="lineNum">     805 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::DoPageEnd()</span>
<span class="lineNum">     806 </span>            : {
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :   nsresult rv = NS_OK;</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :   if (PresContext()-&gt;IsRootPaginatedDocument() &amp;&amp; mPrintThisPage) {</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :     PR_PL((&quot;***************** End Page (DoPageEnd) *****************\n&quot;));</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :     rv = PresContext()-&gt;DeviceContext()-&gt;EndPage();</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     812 </span>            :   }
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :   ResetPrintCanvasList();</span>
<span class="lineNum">     815 </span>            : 
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   mPageNum++;</span>
<span class="lineNum">     817 </span>            : 
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">     819 </span>            : }
<a name="820"><span class="lineNum">     820 </span>            : </a>
<span class="lineNum">     821 </span>            : inline gfx::Matrix4x4
<span class="lineNum">     822 </span><span class="lineNoCov">          0 : ComputePageSequenceTransform(nsIFrame* aFrame, float aAppUnitsPerPixel)</span>
<span class="lineNum">     823 </span>            : {
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :   float scale = aFrame-&gt;PresContext()-&gt;GetPrintPreviewScale();</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :   return gfx::Matrix4x4::Scaling(scale, scale, 1);</span>
<span class="lineNum">     826 </span>            : }
<a name="827"><span class="lineNum">     827 </span>            : </a>
<span class="lineNum">     828 </span>            : void
<span class="lineNum">     829 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::BuildDisplayList(nsDisplayListBuilder*   aBuilder,</span>
<span class="lineNum">     830 </span>            :                                             const nsRect&amp;           aDirtyRect,
<span class="lineNum">     831 </span>            :                                             const nsDisplayListSet&amp; aLists)
<span class="lineNum">     832 </span>            : {
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :   DisplayBorderBackgroundOutline(aBuilder, aLists);</span>
<span class="lineNum">     834 </span>            : 
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :   nsDisplayList content;</span>
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span>            :   {
<span class="lineNum">     838 </span>            :     // Clear clip state while we construct the children of the
<span class="lineNum">     839 </span>            :     // nsDisplayTransform, since they'll be in a different coordinate system.
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :     DisplayListClipState::AutoSaveRestore clipState(aBuilder);</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :     clipState.Clear();</span>
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :     nsIFrame* child = PrincipalChildList().FirstChild();</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :     nsRect dirty = aDirtyRect;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :     dirty.ScaleInverseRoundOut(PresContext()-&gt;GetPrintPreviewScale());</span>
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :     while (child) {</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :       if (child-&gt;GetVisualOverflowRectRelativeToParent().Intersects(dirty)) {</span>
<span class="lineNum">     849 </span>            :         child-&gt;BuildDisplayListForStackingContext(aBuilder,
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :             dirty - child-&gt;GetPosition(), &amp;content);</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :         aBuilder-&gt;ResetMarkedFramesForDisplayList();</span>
<span class="lineNum">     852 </span>            :       }
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :       child = child-&gt;GetNextSibling();</span>
<span class="lineNum">     854 </span>            :     }
<span class="lineNum">     855 </span>            :   }
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :   content.AppendNewToTop(new (aBuilder)</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :       nsDisplayTransform(aBuilder, this, &amp;content, content.GetVisibleRect(),</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :                          ::ComputePageSequenceTransform));</span>
<span class="lineNum">     860 </span>            : 
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :   aLists.Content()-&gt;AppendToTop(&amp;content);</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     863 </span>            : 
<a name="864"><span class="lineNum">     864 </span>            : //------------------------------------------------------------------------------</a>
<span class="lineNum">     865 </span>            : void
<span class="lineNum">     866 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::SetPageNumberFormat(const nsAString&amp; aFormatStr, bool aForPageNumOnly)</span>
<span class="lineNum">     867 </span>            : {
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :   NS_ASSERTION(mPageData != nullptr, &quot;mPageData string cannot be null!&quot;);</span>
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :   if (aForPageNumOnly) {</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :     mPageData-&gt;mPageNumFormat = aFormatStr;</span>
<span class="lineNum">     872 </span>            :   } else {
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :     mPageData-&gt;mPageNumAndTotalsFormat = aFormatStr;</span>
<span class="lineNum">     874 </span>            :   }
<span class="lineNum">     875 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     876 </span>            : 
<a name="877"><span class="lineNum">     877 </span>            : //------------------------------------------------------------------------------</a>
<span class="lineNum">     878 </span>            : void
<span class="lineNum">     879 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::SetDateTimeStr(const nsAString&amp; aDateTimeStr)</span>
<span class="lineNum">     880 </span>            : {
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :   NS_ASSERTION(mPageData != nullptr, &quot;mPageData string cannot be null!&quot;);</span>
<span class="lineNum">     882 </span>            : 
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :   mPageData-&gt;mDateTimeStr = aDateTimeStr;</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span>            : //------------------------------------------------------------------------------
<span class="lineNum">     887 </span>            : // For Shrink To Fit
<span class="lineNum">     888 </span>            : //
<span class="lineNum">     889 </span>            : // Return the percentage that the page needs to shrink to
<a name="890"><span class="lineNum">     890 </span>            : //</a>
<span class="lineNum">     891 </span>            : NS_IMETHODIMP
<span class="lineNum">     892 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::GetSTFPercent(float&amp; aSTFPercent)</span>
<span class="lineNum">     893 </span>            : {
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(mPageData, NS_ERROR_UNEXPECTED);</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :   aSTFPercent = mPageData-&gt;mShrinkToFitRatio;</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     897 </span>            : }
<a name="898"><span class="lineNum">     898 </span>            : </a>
<span class="lineNum">     899 </span>            : void
<span class="lineNum">     900 </span><span class="lineNoCov">          0 : nsSimplePageSequenceFrame::AppendDirectlyOwnedAnonBoxes(</span>
<span class="lineNum">     901 </span>            :   nsTArray&lt;OwnedAnonBox&gt;&amp; aResult)
<span class="lineNum">     902 </span>            : {
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :   if (mFrames.NotEmpty()) {</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :     aResult.AppendElement(mFrames.FirstChild());</span>
<span class="lineNum">     905 </span>            :   }
<span class="lineNum">     906 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - layout/forms/nsComboboxControlFrame.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">layout/forms</a> - nsComboboxControlFrame.cpp<span style="font-size: 80%;"> (source / <a href="nsComboboxControlFrame.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">721</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">94</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #include &quot;nsComboboxControlFrame.h&quot;
<span class="lineNum">       7 </span>            : 
<span class="lineNum">       8 </span>            : #include &quot;gfxContext.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;gfxUtils.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;mozilla/gfx/2D.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;mozilla/gfx/PathHelpers.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;nsCOMPtr.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsFocusManager.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsFormControlFrame.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsGkAtoms.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsCSSAnonBoxes.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsHTMLParts.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsIFormControl.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsNameSpaceManager.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsIListControlFrame.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsPIDOMWindow.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;nsIPresShell.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;nsPresState.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;nsContentList.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsView.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;nsViewManager.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;nsIDOMEventListener.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;nsIDOMNode.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;nsISelectControlFrame.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;nsIDocument.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;nsIScrollableFrame.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;nsListControlFrame.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;mozilla/StyleSetHandle.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;mozilla/StyleSetHandleInlines.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;nsNodeInfoManager.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;nsContentCreatorFunctions.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;nsLayoutUtils.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;nsDisplayList.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;nsITheme.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;nsThemeConstants.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;mozilla/Likely.h&quot;
<span class="lineNum">      43 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      44 </span>            : #include &quot;nsTextNode.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;mozilla/AsyncEventDispatcher.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;mozilla/EventStates.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;mozilla/LookAndFeel.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;mozilla/MouseEvents.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;mozilla/Unused.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;gfx2DGlue.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;mozilla/widget/nsAutoRollup.h&quot;
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : #ifdef XP_WIN
<span class="lineNum">      54 </span>            : #define COMBOBOX_ROLLUP_CONSUME_EVENT 0
<span class="lineNum">      55 </span>            : #else
<span class="lineNum">      56 </span>            : #define COMBOBOX_ROLLUP_CONSUME_EVENT 1
<span class="lineNum">      57 </span>            : #endif
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : using namespace mozilla;
<span class="lineNum">      60 </span>            : using namespace mozilla::gfx;
<a name="61"><span class="lineNum">      61 </span>            : </a>
<span class="lineNum">      62 </span>            : NS_IMETHODIMP
<span class="lineNum">      63 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::RedisplayTextEvent::Run()</span>
<span class="lineNum">      64 </span>            : {
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   if (mControlFrame)</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :     mControlFrame-&gt;HandleRedisplayTextEvent();</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">      68 </span>            : }
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            : class nsPresState;
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : #define FIX_FOR_BUG_53259
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            : // Drop down list event management.
<span class="lineNum">      75 </span>            : // The combo box uses the following strategy for managing the drop-down list.
<span class="lineNum">      76 </span>            : // If the combo box or its arrow button is clicked on the drop-down list is displayed
<span class="lineNum">      77 </span>            : // If mouse exits the combo box with the drop-down list displayed the drop-down list
<span class="lineNum">      78 </span>            : // is asked to capture events
<span class="lineNum">      79 </span>            : // The drop-down list will capture all events including mouse down and up and will always
<span class="lineNum">      80 </span>            : // return with ListWasSelected method call regardless of whether an item in the list was
<span class="lineNum">      81 </span>            : // actually selected.
<span class="lineNum">      82 </span>            : // The ListWasSelected code will turn off mouse-capture for the drop-down list.
<span class="lineNum">      83 </span>            : // The drop-down list does not explicitly set capture when it is in the drop-down mode.
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span>            : /**
<span class="lineNum">      87 </span>            :  * Helper class that listens to the combo boxes button. If the button is pressed the
<span class="lineNum">      88 </span>            :  * combo box is toggled to open or close. this is used by Accessibility which presses
<span class="lineNum">      89 </span>            :  * that button Programmatically.
<span class="lineNum">      90 </span>            :  */
<span class="lineNum">      91 </span>            : class nsComboButtonListener : public nsIDOMEventListener
<a name="92"><span class="lineNum">      92 </span>            : {</a>
<span class="lineNum">      93 </span>            : private:
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :   virtual ~nsComboButtonListener() {}</span>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            : public:
<a name="97"><span class="lineNum">      97 </span>            :   NS_DECL_ISUPPORTS</a>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   NS_IMETHOD HandleEvent(nsIDOMEvent*) override</span>
<span class="lineNum">     100 </span>            :   {
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     mComboBox-&gt;ShowDropDown(!mComboBox-&gt;IsDroppedDown());</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<a name="103"><span class="lineNum">     103 </span>            :   }</a>
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :   explicit nsComboButtonListener(nsComboboxControlFrame* aCombobox)</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :   {</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     mComboBox = aCombobox;</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            :   nsComboboxControlFrame* mComboBox;
<a name="111"><span class="lineNum">     111 </span>            : };</a>
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span><span class="lineNoCov">          0 : NS_IMPL_ISUPPORTS(nsComboButtonListener,</span>
<span class="lineNum">     114 </span>            :                   nsIDOMEventListener)
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span>            : // static class data member for Bug 32920
<span class="lineNum">     117 </span>            : nsComboboxControlFrame* nsComboboxControlFrame::sFocused = nullptr;
<a name="118"><span class="lineNum">     118 </span>            : </a>
<span class="lineNum">     119 </span>            : nsComboboxControlFrame*
<span class="lineNum">     120 </span><span class="lineNoCov">          0 : NS_NewComboboxControlFrame(nsIPresShell* aPresShell, nsStyleContext* aContext, nsFrameState aStateFlags)</span>
<span class="lineNum">     121 </span>            : {
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :   nsComboboxControlFrame* it = new (aPresShell) nsComboboxControlFrame(aContext);</span>
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   if (it) {</span>
<span class="lineNum">     125 </span>            :     // set the state flags (if any are provided)
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     it-&gt;AddStateBits(aStateFlags);</span>
<span class="lineNum">     127 </span>            :   }
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :   return it;</span>
<a name="130"><span class="lineNum">     130 </span>            : }</a>
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span><span class="lineNoCov">          0 : NS_IMPL_FRAMEARENA_HELPERS(nsComboboxControlFrame)</span>
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span>            : //-----------------------------------------------------------
<span class="lineNum">     135 </span>            : // Reflow Debugging Macros
<span class="lineNum">     136 </span>            : // These let us &quot;see&quot; how many reflow counts are happening
<span class="lineNum">     137 </span>            : //-----------------------------------------------------------
<span class="lineNum">     138 </span>            : #ifdef DO_REFLOW_COUNTER
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span>            : #define MAX_REFLOW_CNT 1024
<span class="lineNum">     141 </span>            : static int32_t gTotalReqs    = 0;;
<span class="lineNum">     142 </span>            : static int32_t gTotalReflows = 0;;
<span class="lineNum">     143 </span>            : static int32_t gReflowControlCntRQ[MAX_REFLOW_CNT];
<span class="lineNum">     144 </span>            : static int32_t gReflowControlCnt[MAX_REFLOW_CNT];
<span class="lineNum">     145 </span>            : static int32_t gReflowInx = -1;
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span>            : #define REFLOW_COUNTER() \
<span class="lineNum">     148 </span>            :   if (mReflowId &gt; -1) \
<span class="lineNum">     149 </span>            :     gReflowControlCnt[mReflowId]++;
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            : #define REFLOW_COUNTER_REQUEST() \
<span class="lineNum">     152 </span>            :   if (mReflowId &gt; -1) \
<span class="lineNum">     153 </span>            :     gReflowControlCntRQ[mReflowId]++;
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span>            : #define REFLOW_COUNTER_DUMP(__desc) \
<span class="lineNum">     156 </span>            :   if (mReflowId &gt; -1) {\
<span class="lineNum">     157 </span>            :     gTotalReqs    += gReflowControlCntRQ[mReflowId];\
<span class="lineNum">     158 </span>            :     gTotalReflows += gReflowControlCnt[mReflowId];\
<span class="lineNum">     159 </span>            :     printf(&quot;** Id:%5d %s RF: %d RQ: %d   %d/%d  %5.2f\n&quot;, \
<span class="lineNum">     160 </span>            :            mReflowId, (__desc), \
<span class="lineNum">     161 </span>            :            gReflowControlCnt[mReflowId], \
<span class="lineNum">     162 </span>            :            gReflowControlCntRQ[mReflowId],\
<span class="lineNum">     163 </span>            :            gTotalReflows, gTotalReqs, float(gTotalReflows)/float(gTotalReqs)*100.0f);\
<span class="lineNum">     164 </span>            :   }
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            : #define REFLOW_COUNTER_INIT() \
<span class="lineNum">     167 </span>            :   if (gReflowInx &lt; MAX_REFLOW_CNT) { \
<span class="lineNum">     168 </span>            :     gReflowInx++; \
<span class="lineNum">     169 </span>            :     mReflowId = gReflowInx; \
<span class="lineNum">     170 </span>            :     gReflowControlCnt[mReflowId] = 0; \
<span class="lineNum">     171 </span>            :     gReflowControlCntRQ[mReflowId] = 0; \
<span class="lineNum">     172 </span>            :   } else { \
<span class="lineNum">     173 </span>            :     mReflowId = -1; \
<span class="lineNum">     174 </span>            :   }
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span>            : // reflow messages
<span class="lineNum">     177 </span>            : #define REFLOW_DEBUG_MSG(_msg1) printf((_msg1))
<span class="lineNum">     178 </span>            : #define REFLOW_DEBUG_MSG2(_msg1, _msg2) printf((_msg1), (_msg2))
<span class="lineNum">     179 </span>            : #define REFLOW_DEBUG_MSG3(_msg1, _msg2, _msg3) printf((_msg1), (_msg2), (_msg3))
<span class="lineNum">     180 </span>            : #define REFLOW_DEBUG_MSG4(_msg1, _msg2, _msg3, _msg4) printf((_msg1), (_msg2), (_msg3), (_msg4))
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            : #else //-------------
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            : #define REFLOW_COUNTER_REQUEST()
<span class="lineNum">     185 </span>            : #define REFLOW_COUNTER()
<span class="lineNum">     186 </span>            : #define REFLOW_COUNTER_DUMP(__desc)
<span class="lineNum">     187 </span>            : #define REFLOW_COUNTER_INIT()
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span>            : #define REFLOW_DEBUG_MSG(_msg)
<span class="lineNum">     190 </span>            : #define REFLOW_DEBUG_MSG2(_msg1, _msg2)
<span class="lineNum">     191 </span>            : #define REFLOW_DEBUG_MSG3(_msg1, _msg2, _msg3)
<span class="lineNum">     192 </span>            : #define REFLOW_DEBUG_MSG4(_msg1, _msg2, _msg3, _msg4)
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            : #endif
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span>            : //------------------------------------------
<span class="lineNum">     198 </span>            : // This is for being VERY noisy
<span class="lineNum">     199 </span>            : //------------------------------------------
<span class="lineNum">     200 </span>            : #ifdef DO_VERY_NOISY
<span class="lineNum">     201 </span>            : #define REFLOW_NOISY_MSG(_msg1) printf((_msg1))
<span class="lineNum">     202 </span>            : #define REFLOW_NOISY_MSG2(_msg1, _msg2) printf((_msg1), (_msg2))
<span class="lineNum">     203 </span>            : #define REFLOW_NOISY_MSG3(_msg1, _msg2, _msg3) printf((_msg1), (_msg2), (_msg3))
<span class="lineNum">     204 </span>            : #define REFLOW_NOISY_MSG4(_msg1, _msg2, _msg3, _msg4) printf((_msg1), (_msg2), (_msg3), (_msg4))
<span class="lineNum">     205 </span>            : #else
<span class="lineNum">     206 </span>            : #define REFLOW_NOISY_MSG(_msg)
<span class="lineNum">     207 </span>            : #define REFLOW_NOISY_MSG2(_msg1, _msg2)
<span class="lineNum">     208 </span>            : #define REFLOW_NOISY_MSG3(_msg1, _msg2, _msg3)
<span class="lineNum">     209 </span>            : #define REFLOW_NOISY_MSG4(_msg1, _msg2, _msg3, _msg4)
<span class="lineNum">     210 </span>            : #endif
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span>            : //------------------------------------------
<span class="lineNum">     213 </span>            : // Displays value in pixels or twips
<span class="lineNum">     214 </span>            : //------------------------------------------
<span class="lineNum">     215 </span>            : #ifdef DO_PIXELS
<span class="lineNum">     216 </span>            : #define PX(__v) __v / 15
<span class="lineNum">     217 </span>            : #else
<span class="lineNum">     218 </span>            : #define PX(__v) __v
<span class="lineNum">     219 </span>            : #endif
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            : //------------------------------------------------------
<span class="lineNum">     222 </span>            : //-- Done with macros
<a name="223"><span class="lineNum">     223 </span>            : //------------------------------------------------------</a>
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::nsComboboxControlFrame(nsStyleContext* aContext)</span>
<span class="lineNum">     226 </span>            :   : nsBlockFrame(aContext, kClassID)
<span class="lineNum">     227 </span>            :   , mDisplayFrame(nullptr)
<span class="lineNum">     228 </span>            :   , mButtonFrame(nullptr)
<span class="lineNum">     229 </span>            :   , mDropdownFrame(nullptr)
<span class="lineNum">     230 </span>            :   , mListControlFrame(nullptr)
<span class="lineNum">     231 </span>            :   , mDisplayISize(0)
<span class="lineNum">     232 </span>            :   , mRecentSelectedIndex(NS_SKIP_NOTIFY_INDEX)
<span class="lineNum">     233 </span>            :   , mDisplayedIndex(-1)
<span class="lineNum">     234 </span>            :   , mLastDropDownBeforeScreenBCoord(nscoord_MIN)
<span class="lineNum">     235 </span>            :   , mLastDropDownAfterScreenBCoord(nscoord_MIN)
<span class="lineNum">     236 </span>            :   , mDroppedDown(false)
<span class="lineNum">     237 </span>            :   , mInRedisplayText(false)
<span class="lineNum">     238 </span>            :   , mDelayedShowDropDown(false)
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :   , mIsOpenInParentProcess(false)</span>
<span class="lineNum">     240 </span>            : {
<span class="lineNum">     241 </span>            :   REFLOW_COUNTER_INIT()
<span class="lineNum">     242 </span><span class="lineNoCov">          0 : }</span>
<a name="243"><span class="lineNum">     243 </span>            : </a>
<span class="lineNum">     244 </span>            : //--------------------------------------------------------------
<span class="lineNum">     245 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::~nsComboboxControlFrame()</span>
<span class="lineNum">     246 </span>            : {
<span class="lineNum">     247 </span>            :   REFLOW_COUNTER_DUMP(&quot;nsCCF&quot;);
<span class="lineNum">     248 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     249 </span>            : 
<a name="250"><span class="lineNum">     250 </span>            : //--------------------------------------------------------------</a>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span><span class="lineNoCov">          0 : NS_QUERYFRAME_HEAD(nsComboboxControlFrame)</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :   NS_QUERYFRAME_ENTRY(nsComboboxControlFrame)</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :   NS_QUERYFRAME_ENTRY(nsIComboboxControlFrame)</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :   NS_QUERYFRAME_ENTRY(nsIFormControlFrame)</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   NS_QUERYFRAME_ENTRY(nsIAnonymousContentCreator)</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :   NS_QUERYFRAME_ENTRY(nsISelectControlFrame)</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :   NS_QUERYFRAME_ENTRY(nsIStatefulFrame)</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 : NS_QUERYFRAME_TAIL_INHERITING(nsBlockFrame)</span>
<span class="lineNum">     260 </span>            : 
<a name="261"><span class="lineNum">     261 </span>            : #ifdef ACCESSIBILITY</a>
<span class="lineNum">     262 </span>            : a11y::AccType
<span class="lineNum">     263 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::AccessibleType()</span>
<span class="lineNum">     264 </span>            : {
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :   return a11y::eHTMLComboboxType;</span>
<span class="lineNum">     266 </span>            : }
<span class="lineNum">     267 </span>            : #endif
<a name="268"><span class="lineNum">     268 </span>            : </a>
<span class="lineNum">     269 </span>            : void
<span class="lineNum">     270 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::SetFocus(bool aOn, bool aRepaint)</span>
<span class="lineNum">     271 </span>            : {
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :   AutoWeakFrame weakFrame(this);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :   if (aOn) {</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :     nsListControlFrame::ComboboxFocusSet();</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     sFocused = this;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :     if (mDelayedShowDropDown) {</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :       ShowDropDown(true); // might destroy us</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :       if (!weakFrame.IsAlive()) {</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     280 </span>            :       }
<span class="lineNum">     281 </span>            :     }
<span class="lineNum">     282 </span>            :   } else {
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     sFocused = nullptr;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     mDelayedShowDropDown = false;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     if (mDroppedDown) {</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :       mListControlFrame-&gt;ComboboxFinish(mDisplayedIndex); // might destroy us</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :       if (!weakFrame.IsAlive()) {</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     289 </span>            :       }
<span class="lineNum">     290 </span>            :     }
<span class="lineNum">     291 </span>            :     // May delete |this|.
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     mListControlFrame-&gt;FireOnInputAndOnChange();</span>
<span class="lineNum">     293 </span>            :   }
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :   if (!weakFrame.IsAlive()) {</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     297 </span>            :   }
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span>            :   // This is needed on a temporary basis. It causes the focus
<span class="lineNum">     300 </span>            :   // rect to be drawn. This is much faster than ReResolvingStyle
<span class="lineNum">     301 </span>            :   // Bug 32920
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :   InvalidateFrame();</span>
<span class="lineNum">     303 </span>            : }
<a name="304"><span class="lineNum">     304 </span>            : </a>
<span class="lineNum">     305 </span>            : void
<span class="lineNum">     306 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::ShowPopup(bool aShowPopup)</span>
<span class="lineNum">     307 </span>            : {
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :   nsView* view = mDropdownFrame-&gt;GetView();</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :   nsViewManager* viewManager = view-&gt;GetViewManager();</span>
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :   if (aShowPopup) {</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :     nsRect rect = mDropdownFrame-&gt;GetRect();</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     rect.x = rect.y = 0;</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     viewManager-&gt;ResizeView(view, rect);</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     viewManager-&gt;SetViewVisibility(view, nsViewVisibility_kShow);</span>
<span class="lineNum">     316 </span>            :   } else {
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     viewManager-&gt;SetViewVisibility(view, nsViewVisibility_kHide);</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     nsRect emptyRect(0, 0, 0, 0);</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     viewManager-&gt;ResizeView(view, emptyRect);</span>
<span class="lineNum">     320 </span>            :   }
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span>            :   // fire a popup dom event if it is safe to do so
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPresShell&gt; shell = PresContext()-&gt;GetPresShell();</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :   if (shell &amp;&amp; nsContentUtils::IsSafeToRunScript()) {</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     nsEventStatus status = nsEventStatus_eIgnore;</span>
<span class="lineNum">     326 </span>            :     WidgetMouseEvent event(true, aShowPopup ? eXULPopupShowing : eXULPopupHiding,
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :                            nullptr, WidgetMouseEvent::eReal);</span>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     shell-&gt;HandleDOMEventWithTarget(mContent, &amp;event, &amp;status);</span>
<span class="lineNum">     330 </span>            :   }
<span class="lineNum">     331 </span><span class="lineNoCov">          0 : }</span>
<a name="332"><span class="lineNum">     332 </span>            : </a>
<span class="lineNum">     333 </span>            : bool
<span class="lineNum">     334 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::ShowList(bool aShowList)</span>
<span class="lineNum">     335 </span>            : {
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :   nsView* view = mDropdownFrame-&gt;GetView();</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :   if (aShowList) {</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :     NS_ASSERTION(!view-&gt;HasWidget(),</span>
<span class="lineNum">     339 </span>            :                  &quot;We shouldn't have a widget before we need to display the popup&quot;);
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            :     // Create the widget for the drop-down list
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     view-&gt;GetViewManager()-&gt;SetViewFloating(view, true);</span>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :     nsWidgetInitData widgetData;</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     widgetData.mWindowType  = eWindowType_popup;</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     widgetData.mBorderStyle = eBorderStyle_default;</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     view-&gt;CreateWidgetForPopup(&amp;widgetData);</span>
<span class="lineNum">     348 </span>            :   } else {
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :     nsIWidget* widget = view-&gt;GetWidget();</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     if (widget) {</span>
<span class="lineNum">     351 </span>            :       // We must do this before ShowPopup in case it destroys us (bug 813442).
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :       widget-&gt;CaptureRollupEvents(this, false);</span>
<span class="lineNum">     353 </span>            :     }
<span class="lineNum">     354 </span>            :   }
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   AutoWeakFrame weakFrame(this);</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :   ShowPopup(aShowList);  // might destroy us</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   if (!weakFrame.IsAlive()) {</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     360 </span>            :   }
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :   mDroppedDown = aShowList;</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :   nsIWidget* widget = view-&gt;GetWidget();</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :   if (mDroppedDown) {</span>
<span class="lineNum">     365 </span>            :     // The listcontrol frame will call back to the nsComboboxControlFrame's
<span class="lineNum">     366 </span>            :     // ListWasSelected which will stop the capture.
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     mListControlFrame-&gt;AboutToDropDown();</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     mListControlFrame-&gt;CaptureMouseEvents(true);</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     if (widget) {</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :       widget-&gt;CaptureRollupEvents(this, true);</span>
<span class="lineNum">     371 </span>            :     }
<span class="lineNum">     372 </span>            :   } else {
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :     if (widget) {</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :       view-&gt;DestroyWidget();</span>
<span class="lineNum">     375 </span>            :     }
<span class="lineNum">     376 </span>            :   }
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   return weakFrame.IsAlive();</span>
<span class="lineNum">     379 </span>            : }
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span>            : class nsResizeDropdownAtFinalPosition final
<span class="lineNum">     382 </span>            :   : public nsIReflowCallback, public Runnable
<a name="383"><span class="lineNum">     383 </span>            : {</a>
<span class="lineNum">     384 </span>            : public:
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :   explicit nsResizeDropdownAtFinalPosition(nsComboboxControlFrame* aFrame)</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     : mozilla::Runnable(&quot;nsResizeDropdownAtFinalPosition&quot;)</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     , mFrame(aFrame)</span>
<span class="lineNum">     388 </span>            :   {
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :   }</span>
<a name="390"><span class="lineNum">     390 </span>            : </a>
<span class="lineNum">     391 </span>            : protected:
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :   ~nsResizeDropdownAtFinalPosition()</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :   {</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :   }</span>
<a name="395"><span class="lineNum">     395 </span>            : </a>
<span class="lineNum">     396 </span>            : public:
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :   virtual bool ReflowFinished() override</span>
<span class="lineNum">     398 </span>            :   {
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :     Run();</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :     NS_RELEASE_THIS();</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :     return false;</span>
<a name="402"><span class="lineNum">     402 </span>            :   }</a>
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :   virtual void ReflowCallbackCanceled() override</span>
<span class="lineNum">     405 </span>            :   {
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :     NS_RELEASE_THIS();</span>
<a name="407"><span class="lineNum">     407 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :   NS_IMETHOD Run() override</span>
<span class="lineNum">     410 </span>            :   {
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :     if (mFrame.IsAlive()) {</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :       static_cast&lt;nsComboboxControlFrame*&gt;(mFrame.GetFrame())-&gt;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :         AbsolutelyPositionDropDown();</span>
<span class="lineNum">     414 </span>            :     }
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     416 </span>            :   }
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span>            :   WeakFrame mFrame;
<span class="lineNum">     419 </span>            : };
<a name="420"><span class="lineNum">     420 </span>            : </a>
<span class="lineNum">     421 </span>            : void
<span class="lineNum">     422 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::ReflowDropdown(nsPresContext*  aPresContext,</span>
<span class="lineNum">     423 </span>            :                                        const ReflowInput&amp; aReflowInput)
<span class="lineNum">     424 </span>            : {
<span class="lineNum">     425 </span>            :   // All we want out of it later on, really, is the block size of a row, so we
<span class="lineNum">     426 </span>            :   // don't even need to cache mDropdownFrame's ascent or anything.  If we don't
<span class="lineNum">     427 </span>            :   // need to reflow it, just bail out here.
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :   if (!aReflowInput.ShouldReflowAllKids() &amp;&amp;</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :       !NS_SUBTREE_DIRTY(mDropdownFrame)) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     431 </span>            :   }
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            :   // XXXbz this will, for small-block-size dropdowns, have extra space
<span class="lineNum">     434 </span>            :   // on the appropriate edge for the scrollbar we don't show... but
<span class="lineNum">     435 </span>            :   // that's the best we can do here for now.
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :   WritingMode wm = mDropdownFrame-&gt;GetWritingMode();</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :   LogicalSize availSize = aReflowInput.AvailableSize(wm);</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :   availSize.BSize(wm) = NS_UNCONSTRAINEDSIZE;</span>
<span class="lineNum">     439 </span>            :   ReflowInput kidReflowInput(aPresContext, aReflowInput, mDropdownFrame,
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :                                    availSize);</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span>            :   // If the dropdown's intrinsic inline size is narrower than our
<span class="lineNum">     443 </span>            :   // specified inline size, then expand it out.  We want our border-box
<span class="lineNum">     444 </span>            :   // inline size to end up the same as the dropdown's so account for
<span class="lineNum">     445 </span>            :   // both sets of mComputedBorderPadding.
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :   nscoord forcedISize = aReflowInput.ComputedISize() +</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :     aReflowInput.ComputedLogicalBorderPadding().IStartEnd(wm) -</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     kidReflowInput.ComputedLogicalBorderPadding().IStartEnd(wm);</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :   kidReflowInput.SetComputedISize(std::max(kidReflowInput.ComputedISize(),</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :                                          forcedISize));</span>
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span>            :   // ensure we start off hidden
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :   if (!mDroppedDown &amp;&amp; GetStateBits() &amp; NS_FRAME_FIRST_REFLOW) {</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     nsView* view = mDropdownFrame-&gt;GetView();</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     nsViewManager* viewManager = view-&gt;GetViewManager();</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :     viewManager-&gt;SetViewVisibility(view, nsViewVisibility_kHide);</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     nsRect emptyRect(0, 0, 0, 0);</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :     viewManager-&gt;ResizeView(view, emptyRect);</span>
<span class="lineNum">     459 </span>            :   }
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span>            :   // Allow the child to move/size/change-visibility its view if it's currently
<span class="lineNum">     462 </span>            :   // dropped down
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :   int32_t flags = mDroppedDown ? 0</span>
<span class="lineNum">     464 </span>            :                                : NS_FRAME_NO_MOVE_FRAME |
<span class="lineNum">     465 </span>            :                                  NS_FRAME_NO_VISIBILITY |
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                                  NS_FRAME_NO_SIZE_VIEW;</span>
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span>            :   //XXX Can this be different from the dropdown's writing mode?
<span class="lineNum">     469 </span>            :   // That would be odd!
<span class="lineNum">     470 </span>            :   // Note that we don't need to pass the true frame position or container size
<span class="lineNum">     471 </span>            :   // to ReflowChild or FinishReflowChild here; it will be positioned as needed
<span class="lineNum">     472 </span>            :   // by AbsolutelyPositionDropDown().
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :   WritingMode outerWM = GetWritingMode();</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :   const nsSize dummyContainerSize;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :   ReflowOutput desiredSize(aReflowInput);</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :   nsReflowStatus ignoredStatus;</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :   ReflowChild(mDropdownFrame, aPresContext, desiredSize,</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :               kidReflowInput, outerWM, LogicalPoint(outerWM),</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :               dummyContainerSize, flags, ignoredStatus);</span>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span>            :    // Set the child's width and height to its desired size
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :   FinishReflowChild(mDropdownFrame, aPresContext, desiredSize, &amp;kidReflowInput,</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :                     outerWM, LogicalPoint(outerWM), dummyContainerSize, flags);</span>
<span class="lineNum">     484 </span>            : }
<a name="485"><span class="lineNum">     485 </span>            : </a>
<span class="lineNum">     486 </span>            : nsPoint
<span class="lineNum">     487 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetCSSTransformTranslation()</span>
<span class="lineNum">     488 </span>            : {
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :   nsIFrame* frame = this;</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :   bool is3DTransform = false;</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :   Matrix transform;</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :   while (frame) {</span>
<span class="lineNum">     493 </span>            :     nsIFrame* parent;
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :     Matrix4x4 ctm = frame-&gt;GetTransformMatrix(nullptr, &amp;parent);</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     Matrix matrix;</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     if (ctm.Is2D(&amp;matrix)) {</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :       transform = transform * matrix;</span>
<span class="lineNum">     498 </span>            :     } else {
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :       is3DTransform = true;</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     501 </span>            :     }
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     frame = parent;</span>
<span class="lineNum">     503 </span>            :   }
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :   nsPoint translation;</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :   if (!is3DTransform &amp;&amp; !transform.HasNonTranslation()) {</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :     nsPresContext* pc = PresContext();</span>
<span class="lineNum">     507 </span>            :     // To get the translation introduced only by transforms we subtract the
<span class="lineNum">     508 </span>            :     // regular non-transform translation.
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :     nsRootPresContext* rootPC = pc-&gt;GetRootPresContext();</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :     if (rootPC) {</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :       int32_t apd = pc-&gt;AppUnitsPerDevPixel();</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :       translation.x = NSFloatPixelsToAppUnits(transform._31, apd);</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :       translation.y = NSFloatPixelsToAppUnits(transform._32, apd);</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :       translation -= GetOffsetToCrossDoc(rootPC-&gt;PresShell()-&gt;GetRootFrame());</span>
<span class="lineNum">     515 </span>            :     }
<span class="lineNum">     516 </span>            :   }
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :   return translation;</span>
<a name="518"><span class="lineNum">     518 </span>            : }</a>
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineNoCov">          0 : class nsAsyncRollup : public Runnable</span>
<a name="521"><span class="lineNum">     521 </span>            : {</a>
<span class="lineNum">     522 </span>            : public:
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :   explicit nsAsyncRollup(nsComboboxControlFrame* aFrame)</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :     : mozilla::Runnable(&quot;nsAsyncRollup&quot;)</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     , mFrame(aFrame)</span>
<a name="526"><span class="lineNum">     526 </span>            :   {</a>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :   NS_IMETHOD Run() override</span>
<span class="lineNum">     529 </span>            :   {
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :     if (mFrame.IsAlive()) {</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :       static_cast&lt;nsComboboxControlFrame*&gt;(mFrame.GetFrame())</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :         -&gt;RollupFromList();</span>
<span class="lineNum">     533 </span>            :     }
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     535 </span>            :   }
<span class="lineNum">     536 </span>            :   WeakFrame mFrame;
<a name="537"><span class="lineNum">     537 </span>            : };</a>
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span><span class="lineNoCov">          0 : class nsAsyncResize : public Runnable</span>
<a name="540"><span class="lineNum">     540 </span>            : {</a>
<span class="lineNum">     541 </span>            : public:
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :   explicit nsAsyncResize(nsComboboxControlFrame* aFrame)</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     : mozilla::Runnable(&quot;nsAsyncResize&quot;)</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :     , mFrame(aFrame)</span>
<a name="545"><span class="lineNum">     545 </span>            :   {</a>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :   NS_IMETHOD Run() override</span>
<span class="lineNum">     548 </span>            :   {
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :     if (mFrame.IsAlive()) {</span>
<span class="lineNum">     550 </span>            :       nsComboboxControlFrame* combo =
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :         static_cast&lt;nsComboboxControlFrame*&gt;(mFrame.GetFrame());</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :       static_cast&lt;nsListControlFrame*&gt;(combo-&gt;mDropdownFrame)-&gt;</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :         SetSuppressScrollbarUpdate(true);</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :       nsCOMPtr&lt;nsIPresShell&gt; shell = mFrame-&gt;PresContext()-&gt;PresShell();</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :       shell-&gt;FrameNeedsReflow(combo-&gt;mDropdownFrame, nsIPresShell::eResize,</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                               NS_FRAME_IS_DIRTY);</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :       shell-&gt;FlushPendingNotifications(FlushType::Layout);</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :       if (mFrame.IsAlive()) {</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :         combo = static_cast&lt;nsComboboxControlFrame*&gt;(mFrame.GetFrame());</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :         static_cast&lt;nsListControlFrame*&gt;(combo-&gt;mDropdownFrame)-&gt;</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :           SetSuppressScrollbarUpdate(false);</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :         if (combo-&gt;mDelayedShowDropDown) {</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :           combo-&gt;ShowDropDown(true);</span>
<span class="lineNum">     564 </span>            :         }
<span class="lineNum">     565 </span>            :       }
<span class="lineNum">     566 </span>            :     }
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     568 </span>            :   }
<span class="lineNum">     569 </span>            :   WeakFrame mFrame;
<span class="lineNum">     570 </span>            : };
<a name="571"><span class="lineNum">     571 </span>            : </a>
<span class="lineNum">     572 </span>            : void
<span class="lineNum">     573 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetAvailableDropdownSpace(WritingMode aWM,</span>
<span class="lineNum">     574 </span>            :                                                   nscoord* aBefore,
<span class="lineNum">     575 </span>            :                                                   nscoord* aAfter,
<span class="lineNum">     576 </span>            :                                                   LogicalPoint* aTranslation)
<span class="lineNum">     577 </span>            : {
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(!XRE_IsContentProcess());</span>
<span class="lineNum">     579 </span>            :   // Note: At first glance, it appears that you could simply get the
<span class="lineNum">     580 </span>            :   // absolute bounding box for the dropdown list by first getting its
<span class="lineNum">     581 </span>            :   // view, then getting the view's nsIWidget, then asking the nsIWidget
<span class="lineNum">     582 </span>            :   // for its AbsoluteBounds.
<span class="lineNum">     583 </span>            :   // The problem with this approach, is that the dropdown list's bcoord
<span class="lineNum">     584 </span>            :   // location can change based on whether the dropdown is placed after
<span class="lineNum">     585 </span>            :   // or before the display frame.  The approach taken here is to get the
<span class="lineNum">     586 </span>            :   // absolute position of the display frame and use its location to
<span class="lineNum">     587 </span>            :   // determine if the dropdown will go offscreen.
<span class="lineNum">     588 </span>            : 
<span class="lineNum">     589 </span>            :   // Normal frame geometry (eg GetOffsetTo, mRect) doesn't include transforms.
<span class="lineNum">     590 </span>            :   // In the special case that our transform is only a 2D translation we
<span class="lineNum">     591 </span>            :   // introduce this hack so that the dropdown will show up in the right place.
<span class="lineNum">     592 </span>            :   // Use null container size when converting a vector from logical to physical.
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :   const nsSize nullContainerSize;</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :   *aTranslation = LogicalPoint(aWM, GetCSSTransformTranslation(),</span>
<span class="lineNum">     595 </span>            :                                nullContainerSize);
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :   *aBefore = 0;</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :   *aAfter = 0;</span>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :   nsRect screen = nsFormControlFrame::GetUsableScreenRect(PresContext());</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :   nsSize containerSize = screen.Size();</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :   LogicalRect logicalScreen(aWM, screen, containerSize);</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :   if (mLastDropDownAfterScreenBCoord == nscoord_MIN) {</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :     LogicalRect thisScreenRect(aWM, GetScreenRectInAppUnits(),</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                                containerSize);</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     mLastDropDownAfterScreenBCoord = thisScreenRect.BEnd(aWM) +</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :                                      aTranslation-&gt;B(aWM);</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     mLastDropDownBeforeScreenBCoord = thisScreenRect.BStart(aWM) +</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                                       aTranslation-&gt;B(aWM);</span>
<span class="lineNum">     609 </span>            :   }
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span>            :   nscoord minBCoord;
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :   nsPresContext* pc = PresContext()-&gt;GetToplevelContentDocumentPresContext();</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :   nsIFrame* root = pc ? pc-&gt;PresShell()-&gt;GetRootFrame() : nullptr;</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :   if (root) {</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :     minBCoord = LogicalRect(aWM,</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :                             root-&gt;GetScreenRectInAppUnits(),</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :                             containerSize).BStart(aWM);</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     if (mLastDropDownAfterScreenBCoord &lt; minBCoord) {</span>
<span class="lineNum">     619 </span>            :       // Don't allow the drop-down to be placed before the content area.
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     621 </span>            :     }
<span class="lineNum">     622 </span>            :   } else {
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :     minBCoord = logicalScreen.BStart(aWM);</span>
<span class="lineNum">     624 </span>            :   }
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :   nscoord after = logicalScreen.BEnd(aWM) - mLastDropDownAfterScreenBCoord;</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :   nscoord before = mLastDropDownBeforeScreenBCoord - minBCoord;</span>
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span>            :   // If the difference between the space before and after is less
<span class="lineNum">     630 </span>            :   // than a row-block-size, then we favor the space after.
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :   if (before &gt;= after) {</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :     nsListControlFrame* lcf = static_cast&lt;nsListControlFrame*&gt;(mDropdownFrame);</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :     nscoord rowBSize = lcf-&gt;GetBSizeOfARow();</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :     if (before &lt; after + rowBSize) {</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :       before -= rowBSize;</span>
<span class="lineNum">     636 </span>            :     }
<span class="lineNum">     637 </span>            :   }
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :   *aAfter = after;</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :   *aBefore = before;</span>
<span class="lineNum">     641 </span>            : }
<a name="642"><span class="lineNum">     642 </span>            : </a>
<span class="lineNum">     643 </span>            : nsComboboxControlFrame::DropDownPositionState
<span class="lineNum">     644 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::AbsolutelyPositionDropDown()</span>
<span class="lineNum">     645 </span>            : {
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :   if (XRE_IsContentProcess()) {</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :     return eDropDownPositionSuppressed;</span>
<span class="lineNum">     648 </span>            :   }
<span class="lineNum">     649 </span>            : 
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :   WritingMode wm = GetWritingMode();</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :   LogicalPoint translation(wm);</span>
<span class="lineNum">     652 </span>            :   nscoord before, after;
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :   mLastDropDownAfterScreenBCoord = nscoord_MIN;</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :   GetAvailableDropdownSpace(wm, &amp;before, &amp;after, &amp;translation);</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :   if (before &lt;= 0 &amp;&amp; after &lt;= 0) {</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :     if (IsDroppedDown()) {</span>
<span class="lineNum">     657 </span>            :       // Hide the view immediately to minimize flicker.
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :       nsView* view = mDropdownFrame-&gt;GetView();</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :       view-&gt;GetViewManager()-&gt;SetViewVisibility(view, nsViewVisibility_kHide);</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :       NS_DispatchToCurrentThread(new nsAsyncRollup(this));</span>
<span class="lineNum">     661 </span>            :     }
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :     return eDropDownPositionSuppressed;</span>
<span class="lineNum">     663 </span>            :   }
<span class="lineNum">     664 </span>            : 
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :   LogicalSize dropdownSize = mDropdownFrame-&gt;GetLogicalSize(wm);</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :   nscoord bSize = std::max(before, after);</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :   nsListControlFrame* lcf = static_cast&lt;nsListControlFrame*&gt;(mDropdownFrame);</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :   if (bSize &lt; dropdownSize.BSize(wm)) {</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :     if (lcf-&gt;GetNumDisplayRows() &gt; 1) {</span>
<span class="lineNum">     670 </span>            :       // The drop-down doesn't fit and currently shows more than 1 row -
<span class="lineNum">     671 </span>            :       // schedule a resize to show fewer rows.
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :       NS_DispatchToCurrentThread(new nsAsyncResize(this));</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :       return eDropDownPositionPendingResize;</span>
<span class="lineNum">     674 </span>            :     }
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :   } else if (bSize &gt; (dropdownSize.BSize(wm) + lcf-&gt;GetBSizeOfARow() * 1.5) &amp;&amp;</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :              lcf-&gt;GetDropdownCanGrow()) {</span>
<span class="lineNum">     677 </span>            :     // The drop-down fits but there is room for at least 1.5 more rows -
<span class="lineNum">     678 </span>            :     // schedule a resize to show more rows if it has more rows to show.
<span class="lineNum">     679 </span>            :     // (1.5 rows for good measure to avoid any rounding issues that would
<span class="lineNum">     680 </span>            :     // lead to a loop of reflow requests)
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :     NS_DispatchToCurrentThread(new nsAsyncResize(this));</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :     return eDropDownPositionPendingResize;</span>
<span class="lineNum">     683 </span>            :   }
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span>            :   // Position the drop-down after if there is room, otherwise place it before
<span class="lineNum">     686 </span>            :   // if there is room.  If there is no room for it on either side then place
<span class="lineNum">     687 </span>            :   // it after (to avoid overlapping UI like the URL bar).
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :   bool b = dropdownSize.BSize(wm)&lt;= after || dropdownSize.BSize(wm) &gt; before;</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :   LogicalPoint dropdownPosition(wm, 0, b ? BSize(wm) : -dropdownSize.BSize(wm));</span>
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span>            :   // Don't position the view unless the position changed since it might cause
<span class="lineNum">     692 </span>            :   // a call to NotifyGeometryChange() and an infinite loop here.
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :   nsSize containerSize = GetSize();</span>
<span class="lineNum">     694 </span>            :   const LogicalPoint currentPos =
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :     mDropdownFrame-&gt;GetLogicalPosition(containerSize);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :   const LogicalPoint newPos = dropdownPosition + translation;</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :   if (currentPos != newPos) {</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :     mDropdownFrame-&gt;SetPosition(wm, newPos, containerSize);</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :     nsContainerFrame::PositionFrameView(mDropdownFrame);</span>
<span class="lineNum">     700 </span>            :   }
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :   return eDropDownPositionFinal;</span>
<span class="lineNum">     702 </span>            : }
<a name="703"><span class="lineNum">     703 </span>            : </a>
<span class="lineNum">     704 </span>            : void
<span class="lineNum">     705 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::NotifyGeometryChange()</span>
<span class="lineNum">     706 </span>            : {
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :   if (XRE_IsContentProcess()) {</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     709 </span>            :   }
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span>            :   // We don't need to resize if we're not dropped down since ShowDropDown
<span class="lineNum">     712 </span>            :   // does that, or if we're dirty then the reflow callback does it,
<span class="lineNum">     713 </span>            :   // or if we have a delayed ShowDropDown pending.
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :   if (IsDroppedDown() &amp;&amp;</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :       !(GetStateBits() &amp; NS_FRAME_IS_DIRTY) &amp;&amp;</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :       !mDelayedShowDropDown) {</span>
<span class="lineNum">     717 </span>            :     // Async because we're likely in a middle of a scroll here so
<span class="lineNum">     718 </span>            :     // frame/view positions are in flux.
<span class="lineNum">     719 </span>            :     RefPtr&lt;nsResizeDropdownAtFinalPosition&gt; resize =
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :       new nsResizeDropdownAtFinalPosition(this);</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :     NS_DispatchToCurrentThread(resize);</span>
<span class="lineNum">     722 </span>            :   }
<span class="lineNum">     723 </span>            : }
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span>            : //----------------------------------------------------------
<span class="lineNum">     726 </span>            : //
<span class="lineNum">     727 </span>            : //----------------------------------------------------------
<span class="lineNum">     728 </span>            : #ifdef DO_REFLOW_DEBUG
<span class="lineNum">     729 </span>            : static int myCounter = 0;
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span>            : static void printSize(char * aDesc, nscoord aSize)
<span class="lineNum">     732 </span>            : {
<span class="lineNum">     733 </span>            :   printf(&quot; %s: &quot;, aDesc);
<span class="lineNum">     734 </span>            :   if (aSize == NS_UNCONSTRAINEDSIZE) {
<span class="lineNum">     735 </span>            :     printf(&quot;UC&quot;);
<span class="lineNum">     736 </span>            :   } else {
<span class="lineNum">     737 </span>            :     printf(&quot;%d&quot;, PX(aSize));
<span class="lineNum">     738 </span>            :   }
<span class="lineNum">     739 </span>            : }
<span class="lineNum">     740 </span>            : #endif
<span class="lineNum">     741 </span>            : 
<span class="lineNum">     742 </span>            : //-------------------------------------------------------------------
<span class="lineNum">     743 </span>            : //-- Main Reflow for the Combobox
<span class="lineNum">     744 </span>            : //-------------------------------------------------------------------
<a name="745"><span class="lineNum">     745 </span>            : </a>
<span class="lineNum">     746 </span>            : nscoord
<span class="lineNum">     747 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetIntrinsicISize(gfxContext* aRenderingContext,</span>
<span class="lineNum">     748 </span>            :                                           nsLayoutUtils::IntrinsicISizeType aType)
<span class="lineNum">     749 </span>            : {
<span class="lineNum">     750 </span>            :   // get the scrollbar width, we'll use this later
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :   nscoord scrollbarWidth = 0;</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :   nsPresContext* presContext = PresContext();</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :   if (mListControlFrame) {</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :     nsIScrollableFrame* scrollable = do_QueryFrame(mListControlFrame);</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     NS_ASSERTION(scrollable, &quot;List must be a scrollable frame&quot;);</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     scrollbarWidth = scrollable-&gt;GetNondisappearingScrollbarWidth(</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :       presContext, aRenderingContext, GetWritingMode());</span>
<span class="lineNum">     758 </span>            :   }
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :   nscoord displayISize = 0;</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :   if (MOZ_LIKELY(mDisplayFrame)) {</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :     displayISize = nsLayoutUtils::IntrinsicForContainer(aRenderingContext,</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :                                                         mDisplayFrame,</span>
<span class="lineNum">     764 </span>            :                                                         aType);
<span class="lineNum">     765 </span>            :   }
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :   if (mDropdownFrame) {</span>
<span class="lineNum">     768 </span>            :     nscoord dropdownContentISize;
<span class="lineNum">     769 </span>            :     bool isUsingOverlayScrollbars =
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :       LookAndFeel::GetInt(LookAndFeel::eIntID_UseOverlayScrollbars) != 0;</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :     if (aType == nsLayoutUtils::MIN_ISIZE) {</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :       dropdownContentISize = mDropdownFrame-&gt;GetMinISize(aRenderingContext);</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :       if (isUsingOverlayScrollbars) {</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :         dropdownContentISize += scrollbarWidth;</span>
<span class="lineNum">     775 </span>            :       }
<span class="lineNum">     776 </span>            :     } else {
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :       NS_ASSERTION(aType == nsLayoutUtils::PREF_ISIZE, &quot;Unexpected type&quot;);</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :       dropdownContentISize = mDropdownFrame-&gt;GetPrefISize(aRenderingContext);</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :       if (isUsingOverlayScrollbars) {</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :         dropdownContentISize += scrollbarWidth;</span>
<span class="lineNum">     781 </span>            :       }
<span class="lineNum">     782 </span>            :     }
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :     dropdownContentISize = NSCoordSaturatingSubtract(dropdownContentISize,</span>
<span class="lineNum">     784 </span>            :                                                      scrollbarWidth,
<span class="lineNum">     785 </span>            :                                                      nscoord_MAX);
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :     displayISize = std::max(dropdownContentISize, displayISize);</span>
<span class="lineNum">     788 </span>            :   }
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span>            :   // add room for the dropmarker button if there is one
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :   const nsStyleDisplay* disp = StyleDisplay();</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :   if ((!IsThemed(disp) ||</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :        presContext-&gt;GetTheme()-&gt;ThemeNeedsComboboxDropmarker()) &amp;&amp;</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :       disp-&gt;mAppearance != NS_THEME_NONE) {</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :     displayISize += scrollbarWidth;</span>
<span class="lineNum">     796 </span>            :   }
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :   return displayISize;</span>
<span class="lineNum">     799 </span>            : 
<span class="lineNum">     800 </span>            : }
<a name="801"><span class="lineNum">     801 </span>            : </a>
<span class="lineNum">     802 </span>            : nscoord
<span class="lineNum">     803 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetMinISize(gfxContext *aRenderingContext)</span>
<span class="lineNum">     804 </span>            : {
<span class="lineNum">     805 </span>            :   nscoord minISize;
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :   DISPLAY_MIN_WIDTH(this, minISize);</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :   minISize = GetIntrinsicISize(aRenderingContext, nsLayoutUtils::MIN_ISIZE);</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :   return minISize;</span>
<span class="lineNum">     809 </span>            : }
<a name="810"><span class="lineNum">     810 </span>            : </a>
<span class="lineNum">     811 </span>            : nscoord
<span class="lineNum">     812 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetPrefISize(gfxContext *aRenderingContext)</span>
<span class="lineNum">     813 </span>            : {
<span class="lineNum">     814 </span>            :   nscoord prefISize;
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :   DISPLAY_PREF_WIDTH(this, prefISize);</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   prefISize = GetIntrinsicISize(aRenderingContext, nsLayoutUtils::PREF_ISIZE);</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :   return prefISize;</span>
<span class="lineNum">     818 </span>            : }
<a name="819"><span class="lineNum">     819 </span>            : </a>
<span class="lineNum">     820 </span>            : void
<span class="lineNum">     821 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::Reflow(nsPresContext*          aPresContext,</span>
<span class="lineNum">     822 </span>            :                                ReflowOutput&amp;     aDesiredSize,
<span class="lineNum">     823 </span>            :                                const ReflowInput&amp; aReflowInput,
<span class="lineNum">     824 </span>            :                                nsReflowStatus&amp;          aStatus)
<span class="lineNum">     825 </span>            : {
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :   MarkInReflow();</span>
<span class="lineNum">     827 </span>            :   // Constraints we try to satisfy:
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span>            :   // 1) Default inline size of button is the vertical scrollbar size
<span class="lineNum">     830 </span>            :   // 2) If the inline size of button is bigger than our inline size, set
<span class="lineNum">     831 </span>            :   //    inline size of button to 0.
<span class="lineNum">     832 </span>            :   // 3) Default block size of button is block size of display area
<span class="lineNum">     833 </span>            :   // 4) Inline size of display area is whatever is left over from our
<span class="lineNum">     834 </span>            :   //    inline size after allocating inline size for the button.
<span class="lineNum">     835 </span>            :   // 5) Block Size of display area is GetBSizeOfARow() on the
<span class="lineNum">     836 </span>            :   //    mListControlFrame.
<span class="lineNum">     837 </span>            : 
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :   if (!mDisplayFrame || !mButtonFrame || !mDropdownFrame) {</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :     NS_ERROR(&quot;Why did the frame constructor allow this to happen?  Fix it!!&quot;);</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     841 </span>            :   }
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span>            :   // Make sure the displayed text is the same as the selected option, bug 297389.
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :   if (!mDroppedDown) {</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :     mDisplayedIndex = mListControlFrame-&gt;GetSelectedIndex();</span>
<span class="lineNum">     846 </span>            :   }
<span class="lineNum">     847 </span>            :   // In dropped down mode the &quot;selected index&quot; is the hovered menu item,
<span class="lineNum">     848 </span>            :   // we want the last selected item which is |mDisplayedIndex| in this case.
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :   RedisplayText();</span>
<span class="lineNum">     850 </span>            : 
<span class="lineNum">     851 </span>            :   // First reflow our dropdown so that we know how tall we should be.
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :   ReflowDropdown(aPresContext, aReflowInput);</span>
<span class="lineNum">     853 </span>            :   RefPtr&lt;nsResizeDropdownAtFinalPosition&gt; resize =
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     new nsResizeDropdownAtFinalPosition(this);</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(aPresContext-&gt;PresShell()-&gt;PostReflowCallback(resize))) {</span>
<span class="lineNum">     856 </span>            :     // The reflow callback queue doesn't AddRef so we keep it alive until
<span class="lineNum">     857 </span>            :     // it's released in its ReflowFinished / ReflowCallbackCanceled.
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :     Unused &lt;&lt; resize.forget();</span>
<span class="lineNum">     859 </span>            :   }
<span class="lineNum">     860 </span>            : 
<span class="lineNum">     861 </span>            :   // Get the width of the vertical scrollbar.  That will be the inline
<span class="lineNum">     862 </span>            :   // size of the dropdown button.
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :   WritingMode wm = aReflowInput.GetWritingMode();</span>
<span class="lineNum">     864 </span>            :   nscoord buttonISize;
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :   const nsStyleDisplay *disp = StyleDisplay();</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :   if ((IsThemed(disp) &amp;&amp; !aPresContext-&gt;GetTheme()-&gt;ThemeNeedsComboboxDropmarker()) ||</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :       StyleDisplay()-&gt;mAppearance == NS_THEME_NONE) {</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :     buttonISize = 0;</span>
<span class="lineNum">     869 </span>            :   }
<span class="lineNum">     870 </span>            :   else {
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :     nsIScrollableFrame* scrollable = do_QueryFrame(mListControlFrame);</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :     NS_ASSERTION(scrollable, &quot;List must be a scrollable frame&quot;);</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :     buttonISize = scrollable-&gt;GetNondisappearingScrollbarWidth(</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :       PresContext(), aReflowInput.mRenderingContext, wm);</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :     if (buttonISize &gt; aReflowInput.ComputedISize()) {</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :       buttonISize = 0;</span>
<span class="lineNum">     877 </span>            :     }
<span class="lineNum">     878 </span>            :   }
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :   mDisplayISize = aReflowInput.ComputedISize() - buttonISize;</span>
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :   nsBlockFrame::Reflow(aPresContext, aDesiredSize, aReflowInput, aStatus);</span>
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span>            :   // The button should occupy the same space as a scrollbar
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :   nsSize containerSize = aDesiredSize.PhysicalSize();</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :   LogicalRect buttonRect = mButtonFrame-&gt;GetLogicalRect(containerSize);</span>
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :   buttonRect.IStart(wm) =</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :     aReflowInput.ComputedLogicalBorderPadding().IStartEnd(wm) +</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :     mDisplayISize -</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :     (aReflowInput.ComputedLogicalBorderPadding().IEnd(wm) -</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :      aReflowInput.ComputedLogicalPadding().IEnd(wm));</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :   buttonRect.ISize(wm) = buttonISize;</span>
<span class="lineNum">     894 </span>            : 
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :   buttonRect.BStart(wm) = this-&gt;GetLogicalUsedBorder(wm).BStart(wm);</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :   buttonRect.BSize(wm) = mDisplayFrame-&gt;BSize(wm) +</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :                          this-&gt;GetLogicalUsedPadding(wm).BStartEnd(wm);</span>
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :   mButtonFrame-&gt;SetRect(buttonRect, containerSize);</span>
<span class="lineNum">     900 </span>            : 
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :   if (!aStatus.IsInlineBreakBefore() &amp;&amp;</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :       !aStatus.IsFullyComplete()) {</span>
<span class="lineNum">     903 </span>            :     // This frame didn't fit inside a fragmentation container.  Splitting
<span class="lineNum">     904 </span>            :     // a nsComboboxControlFrame makes no sense, so we override the status here.
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :     aStatus.Reset();</span>
<span class="lineNum">     906 </span>            :   }
<span class="lineNum">     907 </span>            : }
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span>            : //--------------------------------------------------------------
<span class="lineNum">     910 </span>            : 
<a name="911"><span class="lineNum">     911 </span>            : #ifdef DEBUG_FRAME_DUMP</a>
<span class="lineNum">     912 </span>            : nsresult
<span class="lineNum">     913 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetFrameName(nsAString&amp; aResult) const</span>
<span class="lineNum">     914 </span>            : {
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :   return MakeFrameName(NS_LITERAL_STRING(&quot;ComboboxControl&quot;), aResult);</span>
<span class="lineNum">     916 </span>            : }
<span class="lineNum">     917 </span>            : #endif
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span>            : 
<span class="lineNum">     920 </span>            : //----------------------------------------------------------------------
<span class="lineNum">     921 </span>            : // nsIComboboxControlFrame
<a name="922"><span class="lineNum">     922 </span>            : //----------------------------------------------------------------------</a>
<span class="lineNum">     923 </span>            : void
<span class="lineNum">     924 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::ShowDropDown(bool aDoDropDown)</span>
<span class="lineNum">     925 </span>            : {
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(!XRE_IsContentProcess());</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :   mDelayedShowDropDown = false;</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :   EventStates eventStates = mContent-&gt;AsElement()-&gt;State();</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :   if (aDoDropDown &amp;&amp; eventStates.HasState(NS_EVENT_STATE_DISABLED)) {</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     931 </span>            :   }
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :   if (!mDroppedDown &amp;&amp; aDoDropDown) {</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :     nsFocusManager* fm = nsFocusManager::GetFocusManager();</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :     if (!fm || fm-&gt;GetFocusedContent() == GetContent()) {</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :       DropDownPositionState state = AbsolutelyPositionDropDown();</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :       if (state == eDropDownPositionFinal) {</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :         ShowList(aDoDropDown); // might destroy us</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :       } else if (state == eDropDownPositionPendingResize) {</span>
<span class="lineNum">     940 </span>            :         // Delay until after the resize reflow, see nsAsyncResize.
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :         mDelayedShowDropDown = true;</span>
<span class="lineNum">     942 </span>            :       }
<span class="lineNum">     943 </span>            :     } else {
<span class="lineNum">     944 </span>            :       // Delay until we get focus, see SetFocus().
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :       mDelayedShowDropDown = true;</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :   } else if (mDroppedDown &amp;&amp; !aDoDropDown) {</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :     ShowList(aDoDropDown); // might destroy us</span>
<span class="lineNum">     949 </span>            :   }
<span class="lineNum">     950 </span>            : }
<a name="951"><span class="lineNum">     951 </span>            : </a>
<span class="lineNum">     952 </span>            : void
<span class="lineNum">     953 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::SetDropDown(nsIFrame* aDropDownFrame)</span>
<span class="lineNum">     954 </span>            : {
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :   mDropdownFrame = aDropDownFrame;</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :   mListControlFrame = do_QueryFrame(mDropdownFrame);</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   if (!sFocused &amp;&amp; nsContentUtils::IsFocusedContent(GetContent())) {</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :     sFocused = this;</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :     nsListControlFrame::ComboboxFocusSet();</span>
<span class="lineNum">     960 </span>            :   }
<span class="lineNum">     961 </span><span class="lineNoCov">          0 : }</span>
<a name="962"><span class="lineNum">     962 </span>            : </a>
<span class="lineNum">     963 </span>            : nsIFrame*
<span class="lineNum">     964 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetDropDown()</span>
<span class="lineNum">     965 </span>            : {
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :   return mDropdownFrame;</span>
<span class="lineNum">     967 </span>            : }
<span class="lineNum">     968 </span>            : 
<span class="lineNum">     969 </span>            : ///////////////////////////////////////////////////////////////
<a name="970"><span class="lineNum">     970 </span>            : </a>
<span class="lineNum">     971 </span>            : void
<span class="lineNum">     972 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::SetPreviewText(const nsAString&amp; aValue)</span>
<span class="lineNum">     973 </span>            : {
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :   nsAutoString previewValue(aValue);</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :   nsContentUtils::RemoveNewlines(previewValue);</span>
<span class="lineNum">     976 </span>            : 
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :   mPreviewText = previewValue;</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :   RedisplayText();</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 : }</span>
<a name="980"><span class="lineNum">     980 </span>            : </a>
<span class="lineNum">     981 </span>            : NS_IMETHODIMP
<span class="lineNum">     982 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::RedisplaySelectedText()</span>
<span class="lineNum">     983 </span>            : {
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :   nsAutoScriptBlocker scriptBlocker;</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :   mDisplayedIndex = mListControlFrame-&gt;GetSelectedIndex();</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :   return RedisplayText();</span>
<span class="lineNum">     987 </span>            : }
<span class="lineNum">     988 </span>            : 
<a name="989"><span class="lineNum">     989 </span>            : </a>
<span class="lineNum">     990 </span>            : nsresult
<span class="lineNum">     991 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::RedisplayText()</span>
<span class="lineNum">     992 </span>            : {
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :   nsString previousText(mDisplayedOptionTextOrPreview);</span>
<span class="lineNum">     994 </span>            :   // Get the text to display
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :   if (!mPreviewText.IsEmpty()) {</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :     mDisplayedOptionTextOrPreview = mPreviewText;</span>
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :   } else if (mDisplayedIndex != -1) {</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :     mListControlFrame-&gt;GetOptionText(mDisplayedIndex, mDisplayedOptionTextOrPreview);</span>
<span class="lineNum">     999 </span>            :   } else {
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :     mDisplayedOptionTextOrPreview.Truncate();</span>
<span class="lineNum">    1001 </span>            :   }
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span>            :   REFLOW_DEBUG_MSG2(&quot;RedisplayText \&quot;%s\&quot;\n&quot;,
<span class="lineNum">    1004 </span>            :                     NS_LossyConvertUTF16toASCII(mDisplayedOptionTextOrPreview).get());
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span>            :   // Send reflow command because the new text maybe larger
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :   nsresult rv = NS_OK;</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :   if (mDisplayContent &amp;&amp;</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :       !previousText.Equals(mDisplayedOptionTextOrPreview)) {</span>
<span class="lineNum">    1010 </span>            :     // Don't call ActuallyDisplayText(true) directly here since that
<span class="lineNum">    1011 </span>            :     // could cause recursive frame construction. See bug 283117 and the comment in
<span class="lineNum">    1012 </span>            :     // HandleRedisplayTextEvent() below.
<span class="lineNum">    1013 </span>            : 
<span class="lineNum">    1014 </span>            :     // Revoke outstanding events to avoid out-of-order events which could mean
<span class="lineNum">    1015 </span>            :     // displaying the wrong text.
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :     mRedisplayTextEvent.Revoke();</span>
<span class="lineNum">    1017 </span>            : 
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :     NS_ASSERTION(!nsContentUtils::IsSafeToRunScript(),</span>
<span class="lineNum">    1019 </span>            :                  &quot;If we happen to run our redisplay event now, we might kill &quot;
<span class="lineNum">    1020 </span>            :                  &quot;ourselves!&quot;);
<span class="lineNum">    1021 </span>            : 
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :     RefPtr&lt;RedisplayTextEvent&gt; event = new RedisplayTextEvent(this);</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :     mRedisplayTextEvent = event;</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :     nsContentUtils::AddScriptRunner(event);</span>
<span class="lineNum">    1025 </span>            :   }
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">    1027 </span>            : }
<a name="1028"><span class="lineNum">    1028 </span>            : </a>
<span class="lineNum">    1029 </span>            : void
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::HandleRedisplayTextEvent()</span>
<span class="lineNum">    1031 </span>            : {
<span class="lineNum">    1032 </span>            :   // First, make sure that the content model is up to date and we've
<span class="lineNum">    1033 </span>            :   // constructed the frames for all our content in the right places.
<span class="lineNum">    1034 </span>            :   // Otherwise they'll end up under the wrong insertion frame when we
<span class="lineNum">    1035 </span>            :   // ActuallyDisplayText, since that flushes out the content sink by
<span class="lineNum">    1036 </span>            :   // calling SetText on a DOM node with aNotify set to true.  See bug
<span class="lineNum">    1037 </span>            :   // 289730.
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :   AutoWeakFrame weakThis(this);</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :   PresContext()-&gt;Document()-&gt;</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     FlushPendingNotifications(FlushType::ContentAndNotify);</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :   if (!weakThis.IsAlive())</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1043 </span>            : 
<span class="lineNum">    1044 </span>            :   // Redirect frame insertions during this method (see GetContentInsertionFrame())
<span class="lineNum">    1045 </span>            :   // so that any reframing that the frame constructor forces upon us is inserted
<span class="lineNum">    1046 </span>            :   // into the correct parent (mDisplayFrame). See bug 282607.
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :   NS_PRECONDITION(!mInRedisplayText, &quot;Nested RedisplayText&quot;);</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :   mInRedisplayText = true;</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :   mRedisplayTextEvent.Forget();</span>
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :   ActuallyDisplayText(true);</span>
<span class="lineNum">    1052 </span>            :   // XXXbz This should perhaps be eResize.  Check.
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :   PresContext()-&gt;PresShell()-&gt;FrameNeedsReflow(mDisplayFrame,</span>
<span class="lineNum">    1054 </span>            :                                                nsIPresShell::eStyleChange,
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                                                NS_FRAME_IS_DIRTY);</span>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :   mInRedisplayText = false;</span>
<span class="lineNum">    1058 </span>            : }
<a name="1059"><span class="lineNum">    1059 </span>            : </a>
<span class="lineNum">    1060 </span>            : void
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::ActuallyDisplayText(bool aNotify)</span>
<span class="lineNum">    1062 </span>            : {
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :   if (mDisplayedOptionTextOrPreview.IsEmpty()) {</span>
<span class="lineNum">    1064 </span>            :     // Have to use a non-breaking space for line-block-size calculations
<span class="lineNum">    1065 </span>            :     // to be right
<span class="lineNum">    1066 </span>            :     static const char16_t space = 0xA0;
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :     mDisplayContent-&gt;SetText(&amp;space, 1, aNotify);</span>
<span class="lineNum">    1068 </span>            :   } else {
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :     mDisplayContent-&gt;SetText(mDisplayedOptionTextOrPreview, aNotify);</span>
<span class="lineNum">    1070 </span>            :   }
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 : }</span>
<a name="1072"><span class="lineNum">    1072 </span>            : </a>
<span class="lineNum">    1073 </span>            : int32_t
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetIndexOfDisplayArea()</span>
<span class="lineNum">    1075 </span>            : {
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :   return mDisplayedIndex;</span>
<span class="lineNum">    1077 </span>            : }
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span>            : //----------------------------------------------------------------------
<span class="lineNum">    1080 </span>            : // nsISelectControlFrame
<a name="1081"><span class="lineNum">    1081 </span>            : //----------------------------------------------------------------------</a>
<span class="lineNum">    1082 </span>            : NS_IMETHODIMP
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::DoneAddingChildren(bool aIsDone)</span>
<span class="lineNum">    1084 </span>            : {
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :   nsISelectControlFrame* listFrame = do_QueryFrame(mDropdownFrame);</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :   if (!listFrame)</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">    1088 </span>            : 
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :   return listFrame-&gt;DoneAddingChildren(aIsDone);</span>
<span class="lineNum">    1090 </span>            : }
<a name="1091"><span class="lineNum">    1091 </span>            : </a>
<span class="lineNum">    1092 </span>            : NS_IMETHODIMP
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::AddOption(int32_t aIndex)</span>
<span class="lineNum">    1094 </span>            : {
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :   if (aIndex &lt;= mDisplayedIndex) {</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :     ++mDisplayedIndex;</span>
<span class="lineNum">    1097 </span>            :   }
<span class="lineNum">    1098 </span>            : 
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :   nsListControlFrame* lcf = static_cast&lt;nsListControlFrame*&gt;(mDropdownFrame);</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :   return lcf-&gt;AddOption(aIndex);</span>
<span class="lineNum">    1101 </span>            : }
<span class="lineNum">    1102 </span>            : 
<a name="1103"><span class="lineNum">    1103 </span>            : </a>
<span class="lineNum">    1104 </span>            : NS_IMETHODIMP
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::RemoveOption(int32_t aIndex)</span>
<span class="lineNum">    1106 </span>            : {
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :   AutoWeakFrame weakThis(this);</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :   if (mListControlFrame-&gt;GetNumberOfOptions() &gt; 0) {</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :     if (aIndex &lt; mDisplayedIndex) {</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :       --mDisplayedIndex;</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :     } else if (aIndex == mDisplayedIndex) {</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :       mDisplayedIndex = 0; // IE6 compat</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :       RedisplayText();</span>
<span class="lineNum">    1114 </span>            :     }
<span class="lineNum">    1115 </span>            :   }
<span class="lineNum">    1116 </span>            :   else {
<span class="lineNum">    1117 </span>            :     // If we removed the last option, we need to blank things out
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :     mDisplayedIndex = -1;</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :     RedisplayText();</span>
<span class="lineNum">    1120 </span>            :   }
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :   if (!weakThis.IsAlive())</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">    1124 </span>            : 
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :   nsListControlFrame* lcf = static_cast&lt;nsListControlFrame*&gt;(mDropdownFrame);</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :   return lcf-&gt;RemoveOption(aIndex);</span>
<span class="lineNum">    1127 </span>            : }
<a name="1128"><span class="lineNum">    1128 </span>            : </a>
<span class="lineNum">    1129 </span>            : NS_IMETHODIMP
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::OnSetSelectedIndex(int32_t aOldIndex, int32_t aNewIndex)</span>
<span class="lineNum">    1131 </span>            : {
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :   nsAutoScriptBlocker scriptBlocker;</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :   mDisplayedIndex = aNewIndex;</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :   RedisplayText();</span>
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :   NS_ASSERTION(mDropdownFrame, &quot;No dropdown frame!&quot;);</span>
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :   nsISelectControlFrame* listFrame = do_QueryFrame(mDropdownFrame);</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :   NS_ASSERTION(listFrame, &quot;No list frame!&quot;);</span>
<span class="lineNum">    1139 </span>            : 
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :   return listFrame-&gt;OnSetSelectedIndex(aOldIndex, aNewIndex);</span>
<span class="lineNum">    1141 </span>            : }
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span>            : // End nsISelectControlFrame
<span class="lineNum">    1144 </span>            : //----------------------------------------------------------------------
<a name="1145"><span class="lineNum">    1145 </span>            : </a>
<span class="lineNum">    1146 </span>            : nsresult
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::HandleEvent(nsPresContext* aPresContext,</span>
<span class="lineNum">    1148 </span>            :                                     WidgetGUIEvent* aEvent,
<span class="lineNum">    1149 </span>            :                                     nsEventStatus* aEventStatus)
<span class="lineNum">    1150 </span>            : {
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aEventStatus);</span>
<span class="lineNum">    1152 </span>            : 
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :   if (nsEventStatus_eConsumeNoDefault == *aEventStatus) {</span>
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">    1155 </span>            :   }
<span class="lineNum">    1156 </span>            : 
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :   EventStates eventStates = mContent-&gt;AsElement()-&gt;State();</span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :   if (eventStates.HasState(NS_EVENT_STATE_DISABLED)) {</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">    1160 </span>            :   }
<span class="lineNum">    1161 </span>            : 
<span class="lineNum">    1162 </span>            : #if COMBOBOX_ROLLUP_CONSUME_EVENT == 0
<span class="lineNum">    1163 </span>            :   if (aEvent-&gt;mMessage == eMouseDown) {
<span class="lineNum">    1164 </span>            :     if (GetContent() == mozilla::widget::nsAutoRollup::GetLastRollup()) {
<span class="lineNum">    1165 </span>            :       // This event did a Rollup on this control - prevent it from opening
<span class="lineNum">    1166 </span>            :       // the dropdown again!
<span class="lineNum">    1167 </span>            :       *aEventStatus = nsEventStatus_eConsumeNoDefault;
<span class="lineNum">    1168 </span>            :       return NS_OK;
<span class="lineNum">    1169 </span>            :     }
<span class="lineNum">    1170 </span>            :   }
<span class="lineNum">    1171 </span>            : #endif
<span class="lineNum">    1172 </span>            : 
<span class="lineNum">    1173 </span>            :   // If we have style that affects how we are selected, feed event down to
<span class="lineNum">    1174 </span>            :   // nsFrame::HandleEvent so that selection takes place when appropriate.
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :   const nsStyleUserInterface* uiStyle = StyleUserInterface();</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :   if (uiStyle-&gt;mUserInput == StyleUserInput::None ||</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :       uiStyle-&gt;mUserInput == StyleUserInput::Disabled) {</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :     return nsBlockFrame::HandleEvent(aPresContext, aEvent, aEventStatus);</span>
<span class="lineNum">    1179 </span>            :   }
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1181 </span>            : }
<span class="lineNum">    1182 </span>            : 
<a name="1183"><span class="lineNum">    1183 </span>            : </a>
<span class="lineNum">    1184 </span>            : nsresult
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::SetFormProperty(nsIAtom* aName, const nsAString&amp; aValue)</span>
<span class="lineNum">    1186 </span>            : {
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :   nsIFormControlFrame* fcFrame = do_QueryFrame(mDropdownFrame);</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :   if (!fcFrame) {</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :     return NS_NOINTERFACE;</span>
<span class="lineNum">    1190 </span>            :   }
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :   return fcFrame-&gt;SetFormProperty(aName, aValue);</span>
<span class="lineNum">    1193 </span>            : }
<a name="1194"><span class="lineNum">    1194 </span>            : </a>
<span class="lineNum">    1195 </span>            : nsContainerFrame*
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetContentInsertionFrame() {</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :   return mInRedisplayText ? mDisplayFrame : mDropdownFrame-&gt;GetContentInsertionFrame();</span>
<span class="lineNum">    1198 </span>            : }
<a name="1199"><span class="lineNum">    1199 </span>            : </a>
<span class="lineNum">    1200 </span>            : void
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::AppendDirectlyOwnedAnonBoxes(nsTArray&lt;OwnedAnonBox&gt;&amp; aResult)</span>
<span class="lineNum">    1202 </span>            : {
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :   aResult.AppendElement(OwnedAnonBox(mDropdownFrame));</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :   aResult.AppendElement(OwnedAnonBox(mDisplayFrame));</span>
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 : }</span>
<a name="1206"><span class="lineNum">    1206 </span>            : </a>
<span class="lineNum">    1207 </span>            : nsresult
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::CreateAnonymousContent(nsTArray&lt;ContentInfo&gt;&amp; aElements)</span>
<span class="lineNum">    1209 </span>            : {
<span class="lineNum">    1210 </span>            :   // The frames used to display the combo box and the button used to popup the dropdown list
<span class="lineNum">    1211 </span>            :   // are created through anonymous content. The dropdown list is not created through anonymous
<span class="lineNum">    1212 </span>            :   // content because its frame is initialized specifically for the drop-down case and it is placed
<span class="lineNum">    1213 </span>            :   // a special list referenced through NS_COMBO_FRAME_POPUP_LIST_INDEX to keep separate from the
<span class="lineNum">    1214 </span>            :   // layout of the display and button.
<span class="lineNum">    1215 </span>            :   //
<span class="lineNum">    1216 </span>            :   // Note: The value attribute of the display content is set when an item is selected in the dropdown list.
<span class="lineNum">    1217 </span>            :   // If the content specified below does not honor the value attribute than nothing will be displayed.
<span class="lineNum">    1218 </span>            : 
<span class="lineNum">    1219 </span>            :   // For now the content that is created corresponds to two input buttons. It would be better to create the
<span class="lineNum">    1220 </span>            :   // tag as something other than input, but then there isn't any way to create a button frame since it
<span class="lineNum">    1221 </span>            :   // isn't possible to set the display type in CSS2 to create a button frame.
<span class="lineNum">    1222 </span>            : 
<span class="lineNum">    1223 </span>            :     // create content used for display
<span class="lineNum">    1224 </span>            :   //nsIAtom* tag = NS_Atomize(&quot;mozcombodisplay&quot;);
<span class="lineNum">    1225 </span>            : 
<span class="lineNum">    1226 </span>            :   // Add a child text content node for the label
<span class="lineNum">    1227 </span>            : 
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :   nsNodeInfoManager *nimgr = mContent-&gt;NodeInfo()-&gt;NodeInfoManager();</span>
<span class="lineNum">    1229 </span>            : 
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :   mDisplayContent = new nsTextNode(nimgr);</span>
<span class="lineNum">    1231 </span>            : 
<span class="lineNum">    1232 </span>            :   // set the value of the text node
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :   mDisplayedIndex = mListControlFrame-&gt;GetSelectedIndex();</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :   if (mDisplayedIndex != -1) {</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :     mListControlFrame-&gt;GetOptionText(mDisplayedIndex, mDisplayedOptionTextOrPreview);</span>
<span class="lineNum">    1236 </span>            :   }
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :   ActuallyDisplayText(false);</span>
<span class="lineNum">    1238 </span>            : 
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :   if (!aElements.AppendElement(mDisplayContent))</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :     return NS_ERROR_OUT_OF_MEMORY;</span>
<span class="lineNum">    1241 </span>            : 
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :   mButtonContent = mContent-&gt;OwnerDoc()-&gt;CreateHTMLElement(nsGkAtoms::button);</span>
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :   if (!mButtonContent)</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :     return NS_ERROR_OUT_OF_MEMORY;</span>
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span>            :   // make someone to listen to the button. If its pressed by someone like Accessibility
<span class="lineNum">    1247 </span>            :   // then open or close the combo box.
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 :   mButtonListener = new nsComboButtonListener(this);</span>
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :   mButtonContent-&gt;AddEventListener(NS_LITERAL_STRING(&quot;click&quot;), mButtonListener,</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :                                    false, false);</span>
<span class="lineNum">    1251 </span>            : 
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :   mButtonContent-&gt;SetAttr(kNameSpaceID_None, nsGkAtoms::type,</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :                           NS_LITERAL_STRING(&quot;button&quot;), false);</span>
<span class="lineNum">    1254 </span>            :   // Set tabindex=&quot;-1&quot; so that the button is not tabbable
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :   mButtonContent-&gt;SetAttr(kNameSpaceID_None, nsGkAtoms::tabindex,</span>
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :                           NS_LITERAL_STRING(&quot;-1&quot;), false);</span>
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :   WritingMode wm = GetWritingMode();</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :   if (wm.IsVertical()) {</span>
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :     mButtonContent-&gt;SetAttr(kNameSpaceID_None, nsGkAtoms::orientation,</span>
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :                             wm.IsVerticalRL() ? NS_LITERAL_STRING(&quot;left&quot;)</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :                                               : NS_LITERAL_STRING(&quot;right&quot;),</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :                             false);</span>
<span class="lineNum">    1264 </span>            :   }
<span class="lineNum">    1265 </span>            : 
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :   if (!aElements.AppendElement(mButtonContent))</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :     return NS_ERROR_OUT_OF_MEMORY;</span>
<span class="lineNum">    1268 </span>            : 
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1270 </span>            : }
<a name="1271"><span class="lineNum">    1271 </span>            : </a>
<span class="lineNum">    1272 </span>            : void
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::AppendAnonymousContentTo(nsTArray&lt;nsIContent*&gt;&amp; aElements,</span>
<span class="lineNum">    1274 </span>            :                                                  uint32_t aFilter)
<span class="lineNum">    1275 </span>            : {
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :   if (mDisplayContent) {</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :     aElements.AppendElement(mDisplayContent);</span>
<span class="lineNum">    1278 </span>            :   }
<span class="lineNum">    1279 </span>            : 
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :   if (mButtonContent) {</span>
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :     aElements.AppendElement(mButtonContent);</span>
<span class="lineNum">    1282 </span>            :   }
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1284 </span>            : 
<a name="1285"><span class="lineNum">    1285 </span>            : // XXXbz this is a for-now hack.  Now that display:inline-block works,</a>
<span class="lineNum">    1286 </span>            : // need to revisit this.
<a name="1287"><span class="lineNum">    1287 </span><span class="lineNoCov">          0 : class nsComboboxDisplayFrame : public nsBlockFrame {</span></a>
<span class="lineNum">    1288 </span>            : public:
<a name="1289"><span class="lineNum">    1289 </span><span class="lineNoCov">          0 :   NS_DECL_FRAMEARENA_HELPERS(nsComboboxDisplayFrame)</span></a>
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :   nsComboboxDisplayFrame(nsStyleContext* aContext,</span>
<span class="lineNum">    1292 </span>            :                          nsComboboxControlFrame* aComboBox)
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :     : nsBlockFrame(aContext, kClassID)</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :     , mComboBox(aComboBox)</span>
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :   {}</span>
<a name="1296"><span class="lineNum">    1296 </span>            : </a>
<span class="lineNum">    1297 </span>            : #ifdef DEBUG_FRAME_DUMP
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :   nsresult GetFrameName(nsAString&amp; aResult) const override</span>
<span class="lineNum">    1299 </span>            :   {
<span class="lineNum">    1300 </span><span class="lineNoCov">          0 :     return MakeFrameName(NS_LITERAL_STRING(&quot;ComboboxDisplay&quot;), aResult);</span>
<span class="lineNum">    1301 </span>            :   }
<a name="1302"><span class="lineNum">    1302 </span>            : #endif</a>
<span class="lineNum">    1303 </span>            : 
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :   virtual bool IsFrameOfType(uint32_t aFlags) const override</span>
<span class="lineNum">    1305 </span>            :   {
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :     return nsBlockFrame::IsFrameOfType(aFlags &amp;</span>
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :       ~(nsIFrame::eReplacedContainsBlock));</span>
<span class="lineNum">    1308 </span>            :   }
<span class="lineNum">    1309 </span>            : 
<span class="lineNum">    1310 </span>            :   virtual void Reflow(nsPresContext*           aPresContext,
<span class="lineNum">    1311 </span>            :                           ReflowOutput&amp;     aDesiredSize,
<span class="lineNum">    1312 </span>            :                           const ReflowInput&amp; aReflowInput,
<span class="lineNum">    1313 </span>            :                           nsReflowStatus&amp;          aStatus) override;
<span class="lineNum">    1314 </span>            : 
<span class="lineNum">    1315 </span>            :   virtual void BuildDisplayList(nsDisplayListBuilder*   aBuilder,
<span class="lineNum">    1316 </span>            :                                 const nsRect&amp;           aDirtyRect,
<span class="lineNum">    1317 </span>            :                                 const nsDisplayListSet&amp; aLists) override;
<span class="lineNum">    1318 </span>            : 
<span class="lineNum">    1319 </span>            : protected:
<span class="lineNum">    1320 </span>            :   nsComboboxControlFrame* mComboBox;
<a name="1321"><span class="lineNum">    1321 </span>            : };</a>
<span class="lineNum">    1322 </span>            : 
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 : NS_IMPL_FRAMEARENA_HELPERS(nsComboboxDisplayFrame)</span>
<a name="1324"><span class="lineNum">    1324 </span>            : </a>
<span class="lineNum">    1325 </span>            : void
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 : nsComboboxDisplayFrame::Reflow(nsPresContext*           aPresContext,</span>
<span class="lineNum">    1327 </span>            :                                ReflowOutput&amp;     aDesiredSize,
<span class="lineNum">    1328 </span>            :                                const ReflowInput&amp; aReflowInput,
<span class="lineNum">    1329 </span>            :                                nsReflowStatus&amp;          aStatus)
<span class="lineNum">    1330 </span>            : {
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :   ReflowInput state(aReflowInput);</span>
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :   if (state.ComputedBSize() == NS_INTRINSICSIZE) {</span>
<span class="lineNum">    1333 </span>            :     // Note that the only way we can have a computed block size here is
<span class="lineNum">    1334 </span>            :     // if the combobox had a specified block size.  If it didn't, size
<span class="lineNum">    1335 </span>            :     // based on what our rows look like, for lack of anything better.
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :     state.SetComputedBSize(mComboBox-&gt;mListControlFrame-&gt;GetBSizeOfARow());</span>
<span class="lineNum">    1337 </span>            :   }
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :   WritingMode wm = aReflowInput.GetWritingMode();</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :   nscoord computedISize = mComboBox-&gt;mDisplayISize -</span>
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :     state.ComputedLogicalBorderPadding().IStartEnd(wm);</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :   if (computedISize &lt; 0) {</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :     computedISize = 0;</span>
<span class="lineNum">    1343 </span>            :   }
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :   state.SetComputedISize(computedISize);</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :   nsBlockFrame::Reflow(aPresContext, aDesiredSize, state, aStatus);</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :   aStatus.Reset(); // this type of frame can't be split</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 : }</span>
<a name="1348"><span class="lineNum">    1348 </span>            : </a>
<span class="lineNum">    1349 </span>            : void
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 : nsComboboxDisplayFrame::BuildDisplayList(nsDisplayListBuilder*   aBuilder,</span>
<span class="lineNum">    1351 </span>            :                                          const nsRect&amp;           aDirtyRect,
<span class="lineNum">    1352 </span>            :                                          const nsDisplayListSet&amp; aLists)
<span class="lineNum">    1353 </span>            : {
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :   nsDisplayListCollection set;</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :   nsBlockFrame::BuildDisplayList(aBuilder, aDirtyRect, set);</span>
<span class="lineNum">    1356 </span>            : 
<span class="lineNum">    1357 </span>            :   // remove background items if parent frame is themed
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :   if (mComboBox-&gt;IsThemed()) {</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :     set.BorderBackground()-&gt;DeleteAll();</span>
<span class="lineNum">    1360 </span>            :   }
<span class="lineNum">    1361 </span>            : 
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :   set.MoveTo(aLists);</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 : }</span>
<a name="1364"><span class="lineNum">    1364 </span>            : </a>
<span class="lineNum">    1365 </span>            : nsIFrame*
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::CreateFrameForDisplayNode()</span>
<span class="lineNum">    1367 </span>            : {
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(mDisplayContent);</span>
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span>            :   // Get PresShell
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :   nsIPresShell *shell = PresContext()-&gt;PresShell();</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :   StyleSetHandle styleSet = shell-&gt;StyleSet();</span>
<span class="lineNum">    1373 </span>            : 
<span class="lineNum">    1374 </span>            :   // create the style contexts for the anonymous block frame and text frame
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :   RefPtr&lt;nsStyleContext&gt; styleContext;</span>
<span class="lineNum">    1376 </span>            :   styleContext = styleSet-&gt;
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :     ResolveInheritingAnonymousBoxStyle(nsCSSAnonBoxes::mozDisplayComboboxControlFrame,</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :                                        mStyleContext);</span>
<span class="lineNum">    1379 </span>            : 
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :   RefPtr&lt;nsStyleContext&gt; textStyleContext;</span>
<span class="lineNum">    1381 </span>            :   textStyleContext =
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :     styleSet-&gt;ResolveStyleForText(mDisplayContent, mStyleContext);</span>
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span>            :   // Start by creating our anonymous block frame
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :   mDisplayFrame = new (shell) nsComboboxDisplayFrame(styleContext, this);</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :   mDisplayFrame-&gt;Init(mContent, this, nullptr);</span>
<span class="lineNum">    1387 </span>            : 
<span class="lineNum">    1388 </span>            :   // Create a text frame and put it inside the block frame
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :   nsIFrame* textFrame = NS_NewTextFrame(shell, textStyleContext);</span>
<span class="lineNum">    1390 </span>            : 
<span class="lineNum">    1391 </span>            :   // initialize the text frame
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :   textFrame-&gt;Init(mDisplayContent, mDisplayFrame, nullptr);</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :   mDisplayContent-&gt;SetPrimaryFrame(textFrame);</span>
<span class="lineNum">    1394 </span>            : 
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :   nsFrameList textList(textFrame, textFrame);</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :   mDisplayFrame-&gt;SetInitialChildList(kPrincipalList, textList);</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :   return mDisplayFrame;</span>
<span class="lineNum">    1398 </span>            : }
<a name="1399"><span class="lineNum">    1399 </span>            : </a>
<span class="lineNum">    1400 </span>            : void
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::DestroyFrom(nsIFrame* aDestructRoot)</span>
<span class="lineNum">    1402 </span>            : {
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :   if (sFocused == this) {</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :     sFocused = nullptr;</span>
<span class="lineNum">    1405 </span>            :   }
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span>            :   // Revoke any pending RedisplayTextEvent
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :   mRedisplayTextEvent.Revoke();</span>
<span class="lineNum">    1409 </span>            : 
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :   nsFormControlFrame::RegUnRegAccessKey(static_cast&lt;nsIFrame*&gt;(this), false);</span>
<span class="lineNum">    1411 </span>            : 
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :   if (mDroppedDown) {</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(mDropdownFrame, &quot;mDroppedDown without frame&quot;);</span>
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :     nsView* view = mDropdownFrame-&gt;GetView();</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(view);</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :     nsIWidget* widget = view-&gt;GetWidget();</span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :     if (widget) {</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :       widget-&gt;CaptureRollupEvents(this, false);</span>
<span class="lineNum">    1419 </span>            :     }
<span class="lineNum">    1420 </span>            :   }
<span class="lineNum">    1421 </span>            : 
<span class="lineNum">    1422 </span>            :   // Cleanup frames in popup child list
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :   mPopupFrames.DestroyFramesFrom(aDestructRoot);</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :   nsContentUtils::DestroyAnonymousContent(&amp;mDisplayContent);</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :   nsContentUtils::DestroyAnonymousContent(&amp;mButtonContent);</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :   nsBlockFrame::DestroyFrom(aDestructRoot);</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 : }</span>
<a name="1428"><span class="lineNum">    1428 </span>            : </a>
<span class="lineNum">    1429 </span>            : const nsFrameList&amp;
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetChildList(ChildListID aListID) const</span>
<span class="lineNum">    1431 </span>            : {
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :   if (kSelectPopupList == aListID) {</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :     return mPopupFrames;</span>
<span class="lineNum">    1434 </span>            :   }
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :   return nsBlockFrame::GetChildList(aListID);</span>
<span class="lineNum">    1436 </span>            : }
<a name="1437"><span class="lineNum">    1437 </span>            : </a>
<span class="lineNum">    1438 </span>            : void
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetChildLists(nsTArray&lt;ChildList&gt;* aLists) const</span>
<span class="lineNum">    1440 </span>            : {
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :   nsBlockFrame::GetChildLists(aLists);</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :   mPopupFrames.AppendIfNonempty(aLists, kSelectPopupList);</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 : }</span>
<a name="1444"><span class="lineNum">    1444 </span>            : </a>
<span class="lineNum">    1445 </span>            : void
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::SetInitialChildList(ChildListID     aListID,</span>
<span class="lineNum">    1447 </span>            :                                             nsFrameList&amp;    aChildList)
<span class="lineNum">    1448 </span>            : {
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :   if (kSelectPopupList == aListID) {</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :     mPopupFrames.SetFrames(aChildList);</span>
<span class="lineNum">    1451 </span>            :   } else {
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :     for (nsFrameList::Enumerator e(aChildList); !e.AtEnd(); e.Next()) {</span>
<span class="lineNum">    1453 </span>            :       nsCOMPtr&lt;nsIFormControl&gt; formControl =
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :         do_QueryInterface(e.get()-&gt;GetContent());</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :       if (formControl &amp;&amp; formControl-&gt;ControlType() == NS_FORM_BUTTON_BUTTON) {</span>
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :         mButtonFrame = e.get();</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1458 </span>            :       }
<span class="lineNum">    1459 </span>            :     }
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :     NS_ASSERTION(mButtonFrame, &quot;missing button frame in initial child list&quot;);</span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :     nsBlockFrame::SetInitialChildList(aListID, aChildList);</span>
<span class="lineNum">    1462 </span>            :   }
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1464 </span>            : 
<span class="lineNum">    1465 </span>            : //----------------------------------------------------------------------
<span class="lineNum">    1466 </span>            :   //nsIRollupListener
<a name="1467"><span class="lineNum">    1467 </span>            : //----------------------------------------------------------------------</a>
<span class="lineNum">    1468 </span>            : bool
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::Rollup(uint32_t aCount, bool aFlush,</span>
<span class="lineNum">    1470 </span>            :                                const nsIntPoint* pos, nsIContent** aLastRolledUp)
<span class="lineNum">    1471 </span>            : {
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :   if (aLastRolledUp) {</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :     *aLastRolledUp = nullptr;</span>
<span class="lineNum">    1474 </span>            :   }
<span class="lineNum">    1475 </span>            : 
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :   if (!mDroppedDown) {</span>
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">    1478 </span>            :   }
<span class="lineNum">    1479 </span>            : 
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :   bool consume = !!COMBOBOX_ROLLUP_CONSUME_EVENT;</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :   AutoWeakFrame weakFrame(this);</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :   mListControlFrame-&gt;AboutToRollup(); // might destroy us</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :   if (!weakFrame.IsAlive()) {</span>
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :     return consume;</span>
<span class="lineNum">    1485 </span>            :   }
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :   ShowDropDown(false); // might destroy us</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :   if (weakFrame.IsAlive()) {</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :     mListControlFrame-&gt;CaptureMouseEvents(false);</span>
<span class="lineNum">    1489 </span>            :   }
<span class="lineNum">    1490 </span>            : 
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :   if (aFlush &amp;&amp; weakFrame.IsAlive()) {</span>
<span class="lineNum">    1492 </span>            :     // The popup's visibility doesn't update until the minimize animation has
<span class="lineNum">    1493 </span>            :     // finished, so call UpdateWidgetGeometry to update it right away.
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 :     nsViewManager* viewManager = mDropdownFrame-&gt;GetView()-&gt;GetViewManager();</span>
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :     viewManager-&gt;UpdateWidgetGeometry(); // might destroy us</span>
<span class="lineNum">    1496 </span>            :   }
<span class="lineNum">    1497 </span>            : 
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :   if (!weakFrame.IsAlive()) {</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :     return consume;</span>
<span class="lineNum">    1500 </span>            :   }
<span class="lineNum">    1501 </span>            : 
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :   if (aLastRolledUp) {</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :     *aLastRolledUp = GetContent();</span>
<span class="lineNum">    1504 </span>            :   }
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :   return consume;</span>
<span class="lineNum">    1506 </span>            : }
<a name="1507"><span class="lineNum">    1507 </span>            : </a>
<span class="lineNum">    1508 </span>            : nsIWidget*
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GetRollupWidget()</span>
<span class="lineNum">    1510 </span>            : {
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :   nsView* view = mDropdownFrame-&gt;GetView();</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(view);</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :   return view-&gt;GetWidget();</span>
<span class="lineNum">    1514 </span>            : }
<a name="1515"><span class="lineNum">    1515 </span>            : </a>
<span class="lineNum">    1516 </span>            : void
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::RollupFromList()</span>
<span class="lineNum">    1518 </span>            : {
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :   if (ShowList(false))</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :     mListControlFrame-&gt;CaptureMouseEvents(false);</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 : }</span>
<a name="1522"><span class="lineNum">    1522 </span>            : </a>
<span class="lineNum">    1523 </span>            : int32_t
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::UpdateRecentIndex(int32_t aIndex)</span>
<span class="lineNum">    1525 </span>            : {
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :   int32_t index = mRecentSelectedIndex;</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :   if (mRecentSelectedIndex == NS_SKIP_NOTIFY_INDEX || aIndex == NS_SKIP_NOTIFY_INDEX)</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :     mRecentSelectedIndex = aIndex;</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :   return index;</span>
<span class="lineNum">    1530 </span>            : }
<span class="lineNum">    1531 </span>            : 
<a name="1532"><span class="lineNum">    1532 </span>            : class nsDisplayComboboxFocus : public nsDisplayItem {</a>
<span class="lineNum">    1533 </span>            : public:
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :   nsDisplayComboboxFocus(nsDisplayListBuilder* aBuilder,</span>
<span class="lineNum">    1535 </span>            :                          nsComboboxControlFrame* aFrame)
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :     : nsDisplayItem(aBuilder, aFrame) {</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :     MOZ_COUNT_CTOR(nsDisplayComboboxFocus);</span>
<a name="1538"><span class="lineNum">    1538 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    1539 </span>            : #ifdef NS_BUILD_REFCNT_LOGGING
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :   virtual ~nsDisplayComboboxFocus() {</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :     MOZ_COUNT_DTOR(nsDisplayComboboxFocus);</span>
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1543 </span>            : #endif
<span class="lineNum">    1544 </span>            : 
<a name="1545"><span class="lineNum">    1545 </span>            :   virtual void Paint(nsDisplayListBuilder* aBuilder,</a>
<span class="lineNum">    1546 </span>            :                      gfxContext* aCtx) override;
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 :   NS_DISPLAY_DECL_NAME(&quot;ComboboxFocus&quot;, TYPE_COMBOBOX_FOCUS)</span>
<a name="1548"><span class="lineNum">    1548 </span>            : };</a>
<span class="lineNum">    1549 </span>            : 
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 : void nsDisplayComboboxFocus::Paint(nsDisplayListBuilder* aBuilder,</span>
<span class="lineNum">    1551 </span>            :                                    gfxContext* aCtx)
<span class="lineNum">    1552 </span>            : {
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :   static_cast&lt;nsComboboxControlFrame*&gt;(mFrame)</span>
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :     -&gt;PaintFocus(*aCtx-&gt;GetDrawTarget(), ToReferenceFrame());</span>
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 : }</span>
<a name="1556"><span class="lineNum">    1556 </span>            : </a>
<span class="lineNum">    1557 </span>            : void
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::BuildDisplayList(nsDisplayListBuilder*   aBuilder,</span>
<span class="lineNum">    1559 </span>            :                                          const nsRect&amp;           aDirtyRect,
<span class="lineNum">    1560 </span>            :                                          const nsDisplayListSet&amp; aLists)
<span class="lineNum">    1561 </span>            : {
<span class="lineNum">    1562 </span>            : #ifdef NOISY
<span class="lineNum">    1563 </span>            :   printf(&quot;%p paint at (%d, %d, %d, %d)\n&quot;, this,
<span class="lineNum">    1564 </span>            :     aDirtyRect.x, aDirtyRect.y, aDirtyRect.width, aDirtyRect.height);
<span class="lineNum">    1565 </span>            : #endif
<span class="lineNum">    1566 </span>            : 
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :   if (aBuilder-&gt;IsForEventDelivery()) {</span>
<span class="lineNum">    1568 </span>            :     // Don't allow children to receive events.
<span class="lineNum">    1569 </span>            :     // REVIEW: following old GetFrameForPoint
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :     DisplayBorderBackgroundOutline(aBuilder, aLists);</span>
<span class="lineNum">    1571 </span>            :   } else {
<span class="lineNum">    1572 </span>            :     // REVIEW: Our in-flow child frames are inline-level so they will paint in our
<span class="lineNum">    1573 </span>            :     // content list, so we don't need to mess with layers.
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :     nsBlockFrame::BuildDisplayList(aBuilder, aDirtyRect, aLists);</span>
<span class="lineNum">    1575 </span>            :   }
<span class="lineNum">    1576 </span>            : 
<span class="lineNum">    1577 </span>            :   // draw a focus indicator only when focus rings should be drawn
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :   nsIDocument* doc = mContent-&gt;GetComposedDoc();</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :   if (doc) {</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :     nsPIDOMWindowOuter* window = doc-&gt;GetWindow();</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :     if (window &amp;&amp; window-&gt;ShouldShowFocusRing()) {</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :       nsPresContext *presContext = PresContext();</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :       const nsStyleDisplay *disp = StyleDisplay();</span>
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :       if ((!IsThemed(disp) ||</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :            !presContext-&gt;GetTheme()-&gt;ThemeDrawsFocusForWidget(disp-&gt;mAppearance)) &amp;&amp;</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :           mDisplayFrame &amp;&amp; IsVisibleForPainting(aBuilder)) {</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :         aLists.Content()-&gt;AppendNewToTop(</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :           new (aBuilder) nsDisplayComboboxFocus(aBuilder, this));</span>
<span class="lineNum">    1589 </span>            :       }
<span class="lineNum">    1590 </span>            :     }
<span class="lineNum">    1591 </span>            :   }
<span class="lineNum">    1592 </span>            : 
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :   DisplaySelectionOverlay(aBuilder, aLists.Content());</span>
<a name="1594"><span class="lineNum">    1594 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1595 </span>            : 
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 : void nsComboboxControlFrame::PaintFocus(DrawTarget&amp; aDrawTarget, nsPoint aPt)</span>
<span class="lineNum">    1597 </span>            : {
<span class="lineNum">    1598 </span>            :   /* Do we need to do anything? */
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :   EventStates eventStates = mContent-&gt;AsElement()-&gt;State();</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :   if (eventStates.HasState(NS_EVENT_STATE_DISABLED) || sFocused != this)</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1602 </span>            : 
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :   int32_t appUnitsPerDevPixel = PresContext()-&gt;AppUnitsPerDevPixel();</span>
<span class="lineNum">    1604 </span>            : 
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :   nsRect clipRect = mDisplayFrame-&gt;GetRect() + aPt;</span>
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :   aDrawTarget.PushClipRect(NSRectToSnappedRect(clipRect,</span>
<span class="lineNum">    1607 </span>            :                                                appUnitsPerDevPixel,
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :                                                aDrawTarget));</span>
<span class="lineNum">    1609 </span>            : 
<span class="lineNum">    1610 </span>            :   // REVIEW: Why does the old code paint mDisplayFrame again? We've
<span class="lineNum">    1611 </span>            :   // already painted it in the children above. So clipping it here won't do
<span class="lineNum">    1612 </span>            :   // us much good.
<span class="lineNum">    1613 </span>            : 
<span class="lineNum">    1614 </span>            :   /////////////////////
<span class="lineNum">    1615 </span>            :   // draw focus
<span class="lineNum">    1616 </span>            : 
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :   StrokeOptions strokeOptions;</span>
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :   nsLayoutUtils::InitDashPattern(strokeOptions, NS_STYLE_BORDER_STYLE_DOTTED);</span>
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :   ColorPattern color(ToDeviceColor(StyleColor()-&gt;mColor));</span>
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :   nscoord onePixel = nsPresContext::CSSPixelsToAppUnits(1);</span>
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :   clipRect.width -= onePixel;</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :   clipRect.height -= onePixel;</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :   Rect r = ToRect(nsLayoutUtils::RectToGfxRect(clipRect, appUnitsPerDevPixel));</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :   StrokeSnappedEdgesOfRect(r, aDrawTarget, color, strokeOptions);</span>
<span class="lineNum">    1625 </span>            : 
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :   aDrawTarget.PopClip();</span>
<span class="lineNum">    1627 </span>            : }
<span class="lineNum">    1628 </span>            : 
<span class="lineNum">    1629 </span>            : //---------------------------------------------------------
<span class="lineNum">    1630 </span>            : // gets the content (an option) by index and then set it as
<span class="lineNum">    1631 </span>            : // being selected or not selected
<a name="1632"><span class="lineNum">    1632 </span>            : //---------------------------------------------------------</a>
<span class="lineNum">    1633 </span>            : NS_IMETHODIMP
<span class="lineNum">    1634 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::OnOptionSelected(int32_t aIndex, bool aSelected)</span>
<span class="lineNum">    1635 </span>            : {
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :   if (mDroppedDown) {</span>
<span class="lineNum">    1637 </span><span class="lineNoCov">          0 :     nsISelectControlFrame *selectFrame = do_QueryFrame(mListControlFrame);</span>
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :     if (selectFrame) {</span>
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :       selectFrame-&gt;OnOptionSelected(aIndex, aSelected);</span>
<span class="lineNum">    1640 </span>            :     }
<span class="lineNum">    1641 </span>            :   } else {
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :     if (aSelected) {</span>
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :       nsAutoScriptBlocker blocker;</span>
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :       mDisplayedIndex = aIndex;</span>
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 :       RedisplayText();</span>
<span class="lineNum">    1646 </span>            :     } else {
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :       AutoWeakFrame weakFrame(this);</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :       RedisplaySelectedText();</span>
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :       if (weakFrame.IsAlive()) {</span>
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :         FireValueChangeEvent(); // Fire after old option is unselected</span>
<span class="lineNum">    1651 </span>            :       }
<span class="lineNum">    1652 </span>            :     }
<span class="lineNum">    1653 </span>            :   }
<span class="lineNum">    1654 </span>            : 
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<a name="1656"><span class="lineNum">    1656 </span>            : }</a>
<span class="lineNum">    1657 </span>            : 
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 : void nsComboboxControlFrame::FireValueChangeEvent()</span>
<span class="lineNum">    1659 </span>            : {
<span class="lineNum">    1660 </span>            :   // Fire ValueChange event to indicate data value of combo box has changed
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :   nsContentUtils::AddScriptRunner(</span>
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :     new AsyncEventDispatcher(mContent, NS_LITERAL_STRING(&quot;ValueChange&quot;), true,</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :                              false));</span>
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 : }</span>
<a name="1665"><span class="lineNum">    1665 </span>            : </a>
<span class="lineNum">    1666 </span>            : void
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::OnContentReset()</span>
<span class="lineNum">    1668 </span>            : {
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 :   if (mListControlFrame) {</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :     mListControlFrame-&gt;OnContentReset();</span>
<span class="lineNum">    1671 </span>            :   }
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1673 </span>            : 
<span class="lineNum">    1674 </span>            : 
<span class="lineNum">    1675 </span>            : //--------------------------------------------------------
<span class="lineNum">    1676 </span>            : // nsIStatefulFrame
<a name="1677"><span class="lineNum">    1677 </span>            : //--------------------------------------------------------</a>
<span class="lineNum">    1678 </span>            : NS_IMETHODIMP
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::SaveState(nsPresState** aState)</span>
<span class="lineNum">    1680 </span>            : {
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :   MOZ_ASSERT(!(*aState));</span>
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :   (*aState) = new nsPresState();</span>
<span class="lineNum">    1683 </span><span class="lineNoCov">          0 :   (*aState)-&gt;SetDroppedDown(mDroppedDown);</span>
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1685 </span>            : }
<a name="1686"><span class="lineNum">    1686 </span>            : </a>
<span class="lineNum">    1687 </span>            : NS_IMETHODIMP
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::RestoreState(nsPresState* aState)</span>
<span class="lineNum">    1689 </span>            : {
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :   if (!aState) {</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :     return NS_ERROR_FAILURE;</span>
<span class="lineNum">    1692 </span>            :   }
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :   ShowList(aState-&gt;GetDroppedDown()); // might destroy us</span>
<span class="lineNum">    1694 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1695 </span>            : }
<span class="lineNum">    1696 </span>            : 
<span class="lineNum">    1697 </span>            : // Append a suffix so that the state key for the combobox is different
<span class="lineNum">    1698 </span>            : // from the state key the list control uses to sometimes save the scroll
<a name="1699"><span class="lineNum">    1699 </span>            : // position for the same Element</a>
<span class="lineNum">    1700 </span>            : NS_IMETHODIMP
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::GenerateStateKey(nsIContent* aContent,</span>
<span class="lineNum">    1702 </span>            :                                         nsIDocument* aDocument,
<span class="lineNum">    1703 </span>            :                                         nsACString&amp; aKey)
<span class="lineNum">    1704 </span>            : {
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :   nsresult rv = nsContentUtils::GenerateStateKey(aContent, aDocument, aKey);</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv) || aKey.IsEmpty()) {</span>
<span class="lineNum">    1707 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">    1708 </span>            :   }
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :   aKey.Append(&quot;CCF&quot;);</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1711 </span>            : }
<span class="lineNum">    1712 </span>            : 
<span class="lineNum">    1713 </span>            : // Fennec uses a custom combobox built-in widget.
<span class="lineNum">    1714 </span>            : //
<span class="lineNum">    1715 </span>            : 
<a name="1716"><span class="lineNum">    1716 </span>            : /* static */</a>
<span class="lineNum">    1717 </span>            : bool
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 : nsComboboxControlFrame::ToolkitHasNativePopup()</span>
<span class="lineNum">    1719 </span>            : {
<span class="lineNum">    1720 </span>            : #ifdef MOZ_USE_NATIVE_POPUP_WINDOWS
<span class="lineNum">    1721 </span>            :   return true;
<span class="lineNum">    1722 </span>            : #else
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">    1724 </span>            : #endif /* MOZ_USE_NATIVE_POPUP_WINDOWS */
<span class="lineNum">    1725 </span>            : }
<span class="lineNum">    1726 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

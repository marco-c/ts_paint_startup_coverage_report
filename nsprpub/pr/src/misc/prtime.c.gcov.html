<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - nsprpub/pr/src/misc/prtime.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">nsprpub/pr/src/misc</a> - prtime.c<span style="font-size: 80%;"> (source / <a href="prtime.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">295</td>
            <td class="headerCovTableEntry">816</td>
            <td class="headerCovTableEntryLo">36.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntryLo">57.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : /*
<span class="lineNum">       7 </span>            :  * prtime.c --
<span class="lineNum">       8 </span>            :  *
<span class="lineNum">       9 </span>            :  *     NSPR date and time functions
<span class="lineNum">      10 </span>            :  *
<span class="lineNum">      11 </span>            :  */
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            : #include &quot;prinit.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;prtime.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;prlock.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;prprf.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;prlog.h&quot;
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      20 </span>            : #include &lt;ctype.h&gt;
<span class="lineNum">      21 </span>            : #include &lt;errno.h&gt;  /* for EINVAL */
<span class="lineNum">      22 </span>            : #include &lt;time.h&gt;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : /* 
<span class="lineNum">      25 </span>            :  * The COUNT_LEAPS macro counts the number of leap years passed by
<span class="lineNum">      26 </span>            :  * till the start of the given year Y.  At the start of the year 4
<span class="lineNum">      27 </span>            :  * A.D. the number of leap years passed by is 0, while at the start of
<span class="lineNum">      28 </span>            :  * the year 5 A.D. this count is 1. The number of years divisible by
<span class="lineNum">      29 </span>            :  * 100 but not divisible by 400 (the non-leap years) is deducted from
<span class="lineNum">      30 </span>            :  * the count to get the correct number of leap years.
<span class="lineNum">      31 </span>            :  *
<span class="lineNum">      32 </span>            :  * The COUNT_DAYS macro counts the number of days since 01/01/01 till the
<span class="lineNum">      33 </span>            :  * start of the given year Y. The number of days at the start of the year
<span class="lineNum">      34 </span>            :  * 1 is 0 while the number of days at the start of the year 2 is 365
<span class="lineNum">      35 </span>            :  * (which is ((2)-1) * 365) and so on. The reference point is 01/01/01
<span class="lineNum">      36 </span>            :  * midnight 00:00:00.
<span class="lineNum">      37 </span>            :  */
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : #define COUNT_LEAPS(Y)   ( ((Y)-1)/4 - ((Y)-1)/100 + ((Y)-1)/400 )
<span class="lineNum">      40 </span>            : #define COUNT_DAYS(Y)  ( ((Y)-1)*365 + COUNT_LEAPS(Y) )
<span class="lineNum">      41 </span>            : #define DAYS_BETWEEN_YEARS(A, B)  (COUNT_DAYS(B) - COUNT_DAYS(A))
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : /*
<span class="lineNum">      44 </span>            :  * Static variables used by functions in this file
<span class="lineNum">      45 </span>            :  */
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : /*
<span class="lineNum">      48 </span>            :  * The following array contains the day of year for the last day of
<span class="lineNum">      49 </span>            :  * each month, where index 1 is January, and day 0 is January 1.
<span class="lineNum">      50 </span>            :  */
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : static const int lastDayOfMonth[2][13] = {
<span class="lineNum">      53 </span>            :     {-1, 30, 58, 89, 119, 150, 180, 211, 242, 272, 303, 333, 364},
<span class="lineNum">      54 </span>            :     {-1, 30, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365}
<span class="lineNum">      55 </span>            : };
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : /*
<span class="lineNum">      58 </span>            :  * The number of days in a month
<span class="lineNum">      59 </span>            :  */
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : static const PRInt8 nDays[2][12] = {
<span class="lineNum">      62 </span>            :     {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31},
<span class="lineNum">      63 </span>            :     {31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31}
<span class="lineNum">      64 </span>            : };
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : /*
<span class="lineNum">      67 </span>            :  * Declarations for internal functions defined later in this file.
<span class="lineNum">      68 </span>            :  */
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            : static void        ComputeGMT(PRTime time, PRExplodedTime *gmt);
<span class="lineNum">      71 </span>            : static int         IsLeapYear(PRInt16 year);
<span class="lineNum">      72 </span>            : static void        ApplySecOffset(PRExplodedTime *time, PRInt32 secOffset);
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            : /*
<span class="lineNum">      75 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">      76 </span>            :  *
<span class="lineNum">      77 </span>            :  * ComputeGMT --
<span class="lineNum">      78 </span>            :  *
<span class="lineNum">      79 </span>            :  *     Caveats:
<span class="lineNum">      80 </span>            :  *     - we ignore leap seconds
<span class="lineNum">      81 </span>            :  *
<span class="lineNum">      82 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">      83 </span>            :  */
<a name="84"><span class="lineNum">      84 </span>            : </a>
<span class="lineNum">      85 </span>            : static void
<span class="lineNum">      86 </span><span class="lineCov">         25 : ComputeGMT(PRTime time, PRExplodedTime *gmt)</span>
<span class="lineNum">      87 </span>            : {
<span class="lineNum">      88 </span>            :     PRInt32 tmp, rem;
<span class="lineNum">      89 </span>            :     PRInt32 numDays;
<span class="lineNum">      90 </span>            :     PRInt64 numDays64, rem64;
<span class="lineNum">      91 </span>            :     int isLeap;
<span class="lineNum">      92 </span>            :     PRInt64 sec;
<span class="lineNum">      93 </span>            :     PRInt64 usec;
<span class="lineNum">      94 </span>            :     PRInt64 usecPerSec;
<span class="lineNum">      95 </span>            :     PRInt64 secPerDay;
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span>            :     /*
<span class="lineNum">      98 </span>            :      * We first do the usec, sec, min, hour thing so that we do not
<span class="lineNum">      99 </span>            :      * have to do LL arithmetic.
<span class="lineNum">     100 </span>            :      */
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span><span class="lineCov">         25 :     LL_I2L(usecPerSec, 1000000L);</span>
<span class="lineNum">     103 </span><span class="lineCov">         25 :     LL_DIV(sec, time, usecPerSec);</span>
<span class="lineNum">     104 </span><span class="lineCov">         25 :     LL_MOD(usec, time, usecPerSec);</span>
<span class="lineNum">     105 </span><span class="lineCov">         25 :     LL_L2I(gmt-&gt;tm_usec, usec);</span>
<span class="lineNum">     106 </span>            :     /* Correct for weird mod semantics so the remainder is always positive */
<span class="lineNum">     107 </span><span class="lineCov">         25 :     if (gmt-&gt;tm_usec &lt; 0) {</span>
<span class="lineNum">     108 </span>            :         PRInt64 one;
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :         LL_I2L(one, 1L);</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :         LL_SUB(sec, sec, one);</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :         gmt-&gt;tm_usec += 1000000L;</span>
<span class="lineNum">     113 </span>            :     }
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineCov">         25 :     LL_I2L(secPerDay, 86400L);</span>
<span class="lineNum">     116 </span><span class="lineCov">         25 :     LL_DIV(numDays64, sec, secPerDay);</span>
<span class="lineNum">     117 </span><span class="lineCov">         25 :     LL_MOD(rem64, sec, secPerDay);</span>
<span class="lineNum">     118 </span>            :     /* We are sure both of these numbers can fit into PRInt32 */
<span class="lineNum">     119 </span><span class="lineCov">         25 :     LL_L2I(numDays, numDays64);</span>
<span class="lineNum">     120 </span><span class="lineCov">         25 :     LL_L2I(rem, rem64);</span>
<span class="lineNum">     121 </span><span class="lineCov">         25 :     if (rem &lt; 0) {</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :         numDays--;</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :         rem += 86400L;</span>
<span class="lineNum">     124 </span>            :     }
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span>            :     /* Compute day of week.  Epoch started on a Thursday. */
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineCov">         25 :     gmt-&gt;tm_wday = (numDays + 4) % 7;</span>
<span class="lineNum">     129 </span><span class="lineCov">         25 :     if (gmt-&gt;tm_wday &lt; 0) {</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         gmt-&gt;tm_wday += 7;</span>
<span class="lineNum">     131 </span>            :     }
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            :     /* Compute the time of day. */
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineCov">         25 :     gmt-&gt;tm_hour = rem / 3600;</span>
<span class="lineNum">     136 </span><span class="lineCov">         25 :     rem %= 3600;</span>
<span class="lineNum">     137 </span><span class="lineCov">         25 :     gmt-&gt;tm_min = rem / 60;</span>
<span class="lineNum">     138 </span><span class="lineCov">         25 :     gmt-&gt;tm_sec = rem % 60;</span>
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span>            :     /*
<span class="lineNum">     141 </span>            :      * Compute the year by finding the 400 year period, then working
<span class="lineNum">     142 </span>            :      * down from there.
<span class="lineNum">     143 </span>            :      *
<span class="lineNum">     144 </span>            :      * Since numDays is originally the number of days since January 1, 1970,
<span class="lineNum">     145 </span>            :      * we must change it to be the number of days from January 1, 0001.
<span class="lineNum">     146 </span>            :      */
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineCov">         25 :     numDays += 719162;       /* 719162 = days from year 1 up to 1970 */</span>
<span class="lineNum">     149 </span><span class="lineCov">         25 :     tmp = numDays / 146097;  /* 146097 = days in 400 years */</span>
<span class="lineNum">     150 </span><span class="lineCov">         25 :     rem = numDays % 146097;</span>
<span class="lineNum">     151 </span><span class="lineCov">         25 :     gmt-&gt;tm_year = tmp * 400 + 1;</span>
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span>            :     /* Compute the 100 year period. */
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineCov">         25 :     tmp = rem / 36524;    /* 36524 = days in 100 years */</span>
<span class="lineNum">     156 </span><span class="lineCov">         25 :     rem %= 36524;</span>
<span class="lineNum">     157 </span><span class="lineCov">         25 :     if (tmp == 4) {       /* the 400th year is a leap year */</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :         tmp = 3;</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :         rem = 36524;</span>
<span class="lineNum">     160 </span>            :     }
<span class="lineNum">     161 </span><span class="lineCov">         25 :     gmt-&gt;tm_year += tmp * 100;</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :     /* Compute the 4 year period. */
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span><span class="lineCov">         25 :     tmp = rem / 1461;     /* 1461 = days in 4 years */</span>
<span class="lineNum">     166 </span><span class="lineCov">         25 :     rem %= 1461;</span>
<span class="lineNum">     167 </span><span class="lineCov">         25 :     gmt-&gt;tm_year += tmp * 4;</span>
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span>            :     /* Compute which year in the 4. */
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineCov">         25 :     tmp = rem / 365;</span>
<span class="lineNum">     172 </span><span class="lineCov">         25 :     rem %= 365;</span>
<span class="lineNum">     173 </span><span class="lineCov">         25 :     if (tmp == 4) {       /* the 4th year is a leap year */</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :         tmp = 3;</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :         rem = 365;</span>
<span class="lineNum">     176 </span>            :     }
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span><span class="lineCov">         25 :     gmt-&gt;tm_year += tmp;</span>
<span class="lineNum">     179 </span><span class="lineCov">         25 :     gmt-&gt;tm_yday = rem;</span>
<span class="lineNum">     180 </span><span class="lineCov">         25 :     isLeap = IsLeapYear(gmt-&gt;tm_year);</span>
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            :     /* Compute the month and day of month. */
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span><span class="lineCov">         25 :     for (tmp = 1; lastDayOfMonth[isLeap][tmp] &lt; gmt-&gt;tm_yday; tmp++) {</span>
<span class="lineNum">     185 </span>            :     }
<span class="lineNum">     186 </span><span class="lineCov">         25 :     gmt-&gt;tm_month = --tmp;</span>
<span class="lineNum">     187 </span><span class="lineCov">         25 :     gmt-&gt;tm_mday = gmt-&gt;tm_yday - lastDayOfMonth[isLeap][tmp];</span>
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineCov">         25 :     gmt-&gt;tm_params.tp_gmt_offset = 0;</span>
<span class="lineNum">     190 </span><span class="lineCov">         25 :     gmt-&gt;tm_params.tp_dst_offset = 0;</span>
<span class="lineNum">     191 </span><span class="lineCov">         25 : }</span>
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            : /*
<span class="lineNum">     195 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">     196 </span>            :  *
<span class="lineNum">     197 </span>            :  * PR_ExplodeTime --
<span class="lineNum">     198 </span>            :  *
<span class="lineNum">     199 </span>            :  *     Cf. struct tm *gmtime(const time_t *tp) and
<span class="lineNum">     200 </span>            :  *         struct tm *localtime(const time_t *tp)
<span class="lineNum">     201 </span>            :  *
<span class="lineNum">     202 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">     203 </span>            :  */
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span>            : PR_IMPLEMENT(void)
<span class="lineNum">     206 </span>            : PR_ExplodeTime(
<span class="lineNum">     207 </span>            :         PRTime usecs,
<span class="lineNum">     208 </span>            :         PRTimeParamFn params,
<span class="lineNum">     209 </span>            :         PRExplodedTime *exploded)
<span class="lineNum">     210 </span>            : {
<span class="lineNum">     211 </span><span class="lineCov">         25 :     ComputeGMT(usecs, exploded);</span>
<span class="lineNum">     212 </span><span class="lineCov">         25 :     exploded-&gt;tm_params = params(exploded);</span>
<span class="lineNum">     213 </span><span class="lineCov">         50 :     ApplySecOffset(exploded, exploded-&gt;tm_params.tp_gmt_offset</span>
<span class="lineNum">     214 </span><span class="lineCov">         25 :             + exploded-&gt;tm_params.tp_dst_offset);</span>
<span class="lineNum">     215 </span><span class="lineCov">         25 : }</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span>            : /*
<span class="lineNum">     219 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">     220 </span>            :  *
<span class="lineNum">     221 </span>            :  * PR_ImplodeTime --
<span class="lineNum">     222 </span>            :  *
<span class="lineNum">     223 </span>            :  *     Cf. time_t mktime(struct tm *tp)
<span class="lineNum">     224 </span>            :  *     Note that 1 year has &lt; 2^25 seconds.  So an PRInt32 is large enough.
<span class="lineNum">     225 </span>            :  *
<span class="lineNum">     226 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">     227 </span>            :  */
<span class="lineNum">     228 </span>            : PR_IMPLEMENT(PRTime)
<span class="lineNum">     229 </span>            : PR_ImplodeTime(const PRExplodedTime *exploded)
<span class="lineNum">     230 </span>            : {
<span class="lineNum">     231 </span>            :     PRExplodedTime copy;
<span class="lineNum">     232 </span>            :     PRTime retVal;
<span class="lineNum">     233 </span>            :     PRInt64 secPerDay, usecPerSec;
<span class="lineNum">     234 </span>            :     PRInt64 temp;
<span class="lineNum">     235 </span>            :     PRInt64 numSecs64;
<span class="lineNum">     236 </span>            :     PRInt32 numDays;
<span class="lineNum">     237 </span>            :     PRInt32 numSecs;
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span>            :     /* Normalize first.  Do this on our copy */
<span class="lineNum">     240 </span><span class="lineCov">         35 :     copy = *exploded;</span>
<span class="lineNum">     241 </span><span class="lineCov">         35 :     PR_NormalizeTime(&amp;copy, PR_GMTParameters);</span>
<span class="lineNum">     242 </span>            : 
<span class="lineNum">     243 </span><span class="lineCov">         35 :     numDays = DAYS_BETWEEN_YEARS(1970, copy.tm_year);</span>
<span class="lineNum">     244 </span>            :     
<span class="lineNum">     245 </span><span class="lineCov">         70 :     numSecs = copy.tm_yday * 86400 + copy.tm_hour * 3600</span>
<span class="lineNum">     246 </span><span class="lineCov">         35 :             + copy.tm_min * 60 + copy.tm_sec;</span>
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span><span class="lineCov">         35 :     LL_I2L(temp, numDays);</span>
<span class="lineNum">     249 </span><span class="lineCov">         35 :     LL_I2L(secPerDay, 86400);</span>
<span class="lineNum">     250 </span><span class="lineCov">         35 :     LL_MUL(temp, temp, secPerDay);</span>
<span class="lineNum">     251 </span><span class="lineCov">         35 :     LL_I2L(numSecs64, numSecs);</span>
<span class="lineNum">     252 </span><span class="lineCov">         35 :     LL_ADD(numSecs64, numSecs64, temp);</span>
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span>            :     /* apply the GMT and DST offsets */
<span class="lineNum">     255 </span><span class="lineCov">         35 :     LL_I2L(temp,  copy.tm_params.tp_gmt_offset);</span>
<span class="lineNum">     256 </span><span class="lineCov">         35 :     LL_SUB(numSecs64, numSecs64, temp);</span>
<span class="lineNum">     257 </span><span class="lineCov">         35 :     LL_I2L(temp,  copy.tm_params.tp_dst_offset);</span>
<span class="lineNum">     258 </span><span class="lineCov">         35 :     LL_SUB(numSecs64, numSecs64, temp);</span>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span><span class="lineCov">         35 :     LL_I2L(usecPerSec, 1000000L);</span>
<span class="lineNum">     261 </span><span class="lineCov">         35 :     LL_MUL(temp, numSecs64, usecPerSec);</span>
<span class="lineNum">     262 </span><span class="lineCov">         35 :     LL_I2L(retVal, copy.tm_usec);</span>
<span class="lineNum">     263 </span><span class="lineCov">         35 :     LL_ADD(retVal, retVal, temp);</span>
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span><span class="lineCov">         35 :     return retVal;</span>
<span class="lineNum">     266 </span>            : }
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span>            : /*
<span class="lineNum">     269 </span>            :  *-------------------------------------------------------------------------
<span class="lineNum">     270 </span>            :  *
<span class="lineNum">     271 </span>            :  * IsLeapYear --
<span class="lineNum">     272 </span>            :  *
<span class="lineNum">     273 </span>            :  *     Returns 1 if the year is a leap year, 0 otherwise.
<span class="lineNum">     274 </span>            :  *
<span class="lineNum">     275 </span>            :  *-------------------------------------------------------------------------
<a name="276"><span class="lineNum">     276 </span>            :  */</a>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span><span class="lineCov">        117 : static int IsLeapYear(PRInt16 year)</span>
<span class="lineNum">     279 </span>            : {
<span class="lineNum">     280 </span><span class="lineCov">        117 :     if ((year % 4 == 0 &amp;&amp; year % 100 != 0) || year % 400 == 0)</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     282 </span><span class="lineCov">        117 :     return 0;</span>
<span class="lineNum">     283 </span>            : }
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span>            : /*
<span class="lineNum">     286 </span>            :  * 'secOffset' should be less than 86400 (i.e., a day).
<span class="lineNum">     287 </span>            :  * 'time' should point to a normalized PRExplodedTime.
<span class="lineNum">     288 </span>            :  */
<a name="289"><span class="lineNum">     289 </span>            : </a>
<span class="lineNum">     290 </span>            : static void
<span class="lineNum">     291 </span><span class="lineCov">         70 : ApplySecOffset(PRExplodedTime *time, PRInt32 secOffset)</span>
<span class="lineNum">     292 </span>            : {
<span class="lineNum">     293 </span><span class="lineCov">         70 :     time-&gt;tm_sec += secOffset;</span>
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span>            :     /* Note that in this implementation we do not count leap seconds */
<span class="lineNum">     296 </span><span class="lineCov">         70 :     if (time-&gt;tm_sec &lt; 0 || time-&gt;tm_sec &gt;= 60) {</span>
<span class="lineNum">     297 </span><span class="lineCov">         25 :         time-&gt;tm_min += time-&gt;tm_sec / 60;</span>
<span class="lineNum">     298 </span><span class="lineCov">         25 :         time-&gt;tm_sec %= 60;</span>
<span class="lineNum">     299 </span><span class="lineCov">         25 :         if (time-&gt;tm_sec &lt; 0) {</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :             time-&gt;tm_sec += 60;</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :             time-&gt;tm_min--;</span>
<span class="lineNum">     302 </span>            :         }
<span class="lineNum">     303 </span>            :     }
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span><span class="lineCov">         70 :     if (time-&gt;tm_min &lt; 0 || time-&gt;tm_min &gt;= 60) {</span>
<span class="lineNum">     306 </span><span class="lineCov">         25 :         time-&gt;tm_hour += time-&gt;tm_min / 60;</span>
<span class="lineNum">     307 </span><span class="lineCov">         25 :         time-&gt;tm_min %= 60;</span>
<span class="lineNum">     308 </span><span class="lineCov">         25 :         if (time-&gt;tm_min &lt; 0) {</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :             time-&gt;tm_min += 60;</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :             time-&gt;tm_hour--;</span>
<span class="lineNum">     311 </span>            :         }
<span class="lineNum">     312 </span>            :     }
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineCov">         70 :     if (time-&gt;tm_hour &lt; 0) {</span>
<span class="lineNum">     315 </span>            :         /* Decrement mday, yday, and wday */
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :         time-&gt;tm_hour += 24;</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :         time-&gt;tm_mday--;</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         time-&gt;tm_yday--;</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         if (time-&gt;tm_mday &lt; 1) {</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :             time-&gt;tm_month--;</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :             if (time-&gt;tm_month &lt; 0) {</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :                 time-&gt;tm_month = 11;</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :                 time-&gt;tm_year--;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :                 if (IsLeapYear(time-&gt;tm_year))</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :                     time-&gt;tm_yday = 365;</span>
<span class="lineNum">     326 </span>            :                 else
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :                     time-&gt;tm_yday = 364;</span>
<span class="lineNum">     328 </span>            :             }
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :             time-&gt;tm_mday = nDays[IsLeapYear(time-&gt;tm_year)][time-&gt;tm_month];</span>
<span class="lineNum">     330 </span>            :         }
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :         time-&gt;tm_wday--;</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :         if (time-&gt;tm_wday &lt; 0)</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :             time-&gt;tm_wday = 6;</span>
<span class="lineNum">     334 </span><span class="lineCov">         70 :     } else if (time-&gt;tm_hour &gt; 23) {</span>
<span class="lineNum">     335 </span>            :         /* Increment mday, yday, and wday */
<span class="lineNum">     336 </span><span class="lineCov">          2 :         time-&gt;tm_hour -= 24;</span>
<span class="lineNum">     337 </span><span class="lineCov">          2 :         time-&gt;tm_mday++;</span>
<span class="lineNum">     338 </span><span class="lineCov">          2 :         time-&gt;tm_yday++;</span>
<span class="lineNum">     339 </span><span class="lineCov">          4 :         if (time-&gt;tm_mday &gt;</span>
<span class="lineNum">     340 </span><span class="lineCov">          2 :                 nDays[IsLeapYear(time-&gt;tm_year)][time-&gt;tm_month]) {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :             time-&gt;tm_mday = 1;</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :             time-&gt;tm_month++;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :             if (time-&gt;tm_month &gt; 11) {</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :                 time-&gt;tm_month = 0;</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :                 time-&gt;tm_year++;</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :                 time-&gt;tm_yday = 0;</span>
<span class="lineNum">     347 </span>            :             }
<span class="lineNum">     348 </span>            :         }
<span class="lineNum">     349 </span><span class="lineCov">          2 :         time-&gt;tm_wday++;</span>
<span class="lineNum">     350 </span><span class="lineCov">          2 :         if (time-&gt;tm_wday &gt; 6)</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :             time-&gt;tm_wday = 0;</span>
<span class="lineNum">     352 </span>            :     }
<span class="lineNum">     353 </span><span class="lineCov">         70 : }</span>
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            : PR_IMPLEMENT(void)
<span class="lineNum">     356 </span>            : PR_NormalizeTime(PRExplodedTime *time, PRTimeParamFn params)
<span class="lineNum">     357 </span>            : {
<span class="lineNum">     358 </span>            :     int daysInMonth;
<span class="lineNum">     359 </span>            :     PRInt32 numDays;
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span>            :     /* Get back to GMT */
<span class="lineNum">     362 </span><span class="lineCov">         90 :     time-&gt;tm_sec -= time-&gt;tm_params.tp_gmt_offset</span>
<span class="lineNum">     363 </span><span class="lineCov">         45 :             + time-&gt;tm_params.tp_dst_offset;</span>
<span class="lineNum">     364 </span><span class="lineCov">         45 :     time-&gt;tm_params.tp_gmt_offset = 0;</span>
<span class="lineNum">     365 </span><span class="lineCov">         45 :     time-&gt;tm_params.tp_dst_offset = 0;</span>
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span>            :     /* Now normalize GMT */
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span><span class="lineCov">         45 :     if (time-&gt;tm_usec &lt; 0 || time-&gt;tm_usec &gt;= 1000000) {</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :         time-&gt;tm_sec +=  time-&gt;tm_usec / 1000000;</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :         time-&gt;tm_usec %= 1000000;</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :         if (time-&gt;tm_usec &lt; 0) {</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :             time-&gt;tm_usec += 1000000;</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :             time-&gt;tm_sec--;</span>
<span class="lineNum">     375 </span>            :         }
<span class="lineNum">     376 </span>            :     }
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span>            :     /* Note that we do not count leap seconds in this implementation */
<span class="lineNum">     379 </span><span class="lineCov">         45 :     if (time-&gt;tm_sec &lt; 0 || time-&gt;tm_sec &gt;= 60) {</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :         time-&gt;tm_min += time-&gt;tm_sec / 60;</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :         time-&gt;tm_sec %= 60;</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :         if (time-&gt;tm_sec &lt; 0) {</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :             time-&gt;tm_sec += 60;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :             time-&gt;tm_min--;</span>
<span class="lineNum">     385 </span>            :         }
<span class="lineNum">     386 </span>            :     }
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span><span class="lineCov">         45 :     if (time-&gt;tm_min &lt; 0 || time-&gt;tm_min &gt;= 60) {</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :         time-&gt;tm_hour += time-&gt;tm_min / 60;</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :         time-&gt;tm_min %= 60;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :         if (time-&gt;tm_min &lt; 0) {</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :             time-&gt;tm_min += 60;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :             time-&gt;tm_hour--;</span>
<span class="lineNum">     394 </span>            :         }
<span class="lineNum">     395 </span>            :     }
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span><span class="lineCov">         45 :     if (time-&gt;tm_hour &lt; 0 || time-&gt;tm_hour &gt;= 24) {</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :         time-&gt;tm_mday += time-&gt;tm_hour / 24;</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         time-&gt;tm_hour %= 24;</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         if (time-&gt;tm_hour &lt; 0) {</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :             time-&gt;tm_hour += 24;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :             time-&gt;tm_mday--;</span>
<span class="lineNum">     403 </span>            :         }
<span class="lineNum">     404 </span>            :     }
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span>            :     /* Normalize month and year before mday */
<span class="lineNum">     407 </span><span class="lineCov">         45 :     if (time-&gt;tm_month &lt; 0 || time-&gt;tm_month &gt;= 12) {</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         time-&gt;tm_year += time-&gt;tm_month / 12;</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :         time-&gt;tm_month %= 12;</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :         if (time-&gt;tm_month &lt; 0) {</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :             time-&gt;tm_month += 12;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :             time-&gt;tm_year--;</span>
<span class="lineNum">     413 </span>            :         }
<span class="lineNum">     414 </span>            :     }
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            :     /* Now that month and year are in proper range, normalize mday */
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span><span class="lineCov">         45 :     if (time-&gt;tm_mday &lt; 1) {</span>
<span class="lineNum">     419 </span>            :         /* mday too small */
<span class="lineNum">     420 </span>            :         do {
<span class="lineNum">     421 </span>            :             /* the previous month */
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :             time-&gt;tm_month--;</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :             if (time-&gt;tm_month &lt; 0) {</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :                 time-&gt;tm_month = 11;</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :                 time-&gt;tm_year--;</span>
<span class="lineNum">     426 </span>            :             }
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :             time-&gt;tm_mday += nDays[IsLeapYear(time-&gt;tm_year)][time-&gt;tm_month];</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :         } while (time-&gt;tm_mday &lt; 1);</span>
<span class="lineNum">     429 </span>            :     } else {
<span class="lineNum">     430 </span><span class="lineCov">         45 :         daysInMonth = nDays[IsLeapYear(time-&gt;tm_year)][time-&gt;tm_month];</span>
<span class="lineNum">     431 </span><span class="lineCov">         90 :         while (time-&gt;tm_mday &gt; daysInMonth) {</span>
<span class="lineNum">     432 </span>            :             /* mday too large */
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :             time-&gt;tm_mday -= daysInMonth;</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :             time-&gt;tm_month++;</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :             if (time-&gt;tm_month &gt; 11) {</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :                 time-&gt;tm_month = 0;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 time-&gt;tm_year++;</span>
<span class="lineNum">     438 </span>            :             }
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :             daysInMonth = nDays[IsLeapYear(time-&gt;tm_year)][time-&gt;tm_month];</span>
<span class="lineNum">     440 </span>            :         }
<span class="lineNum">     441 </span>            :     }
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span>            :     /* Recompute yday and wday */
<span class="lineNum">     444 </span><span class="lineCov">         90 :     time-&gt;tm_yday = time-&gt;tm_mday +</span>
<span class="lineNum">     445 </span><span class="lineCov">         45 :             lastDayOfMonth[IsLeapYear(time-&gt;tm_year)][time-&gt;tm_month];</span>
<span class="lineNum">     446 </span>            :             
<span class="lineNum">     447 </span><span class="lineCov">         45 :     numDays = DAYS_BETWEEN_YEARS(1970, time-&gt;tm_year) + time-&gt;tm_yday;</span>
<span class="lineNum">     448 </span><span class="lineCov">         45 :     time-&gt;tm_wday = (numDays + 4) % 7;</span>
<span class="lineNum">     449 </span><span class="lineCov">         45 :     if (time-&gt;tm_wday &lt; 0) {</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :         time-&gt;tm_wday += 7;</span>
<span class="lineNum">     451 </span>            :     }
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            :     /* Recompute time parameters */
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span><span class="lineCov">         45 :     time-&gt;tm_params = params(time);</span>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineCov">         90 :     ApplySecOffset(time, time-&gt;tm_params.tp_gmt_offset</span>
<span class="lineNum">     458 </span><span class="lineCov">         45 :             + time-&gt;tm_params.tp_dst_offset);</span>
<span class="lineNum">     459 </span><span class="lineCov">         45 : }</span>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span>            : /*
<span class="lineNum">     463 </span>            :  *-------------------------------------------------------------------------
<span class="lineNum">     464 </span>            :  *
<span class="lineNum">     465 </span>            :  * PR_LocalTimeParameters --
<span class="lineNum">     466 </span>            :  * 
<span class="lineNum">     467 </span>            :  *     returns the time parameters for the local time zone
<span class="lineNum">     468 </span>            :  *
<span class="lineNum">     469 </span>            :  *     The following uses localtime() from the standard C library.
<span class="lineNum">     470 </span>            :  *     (time.h)  This is our fallback implementation.  Unix, PC, and BeOS
<span class="lineNum">     471 </span>            :  *     use this version.  A platform may have its own machine-dependent
<span class="lineNum">     472 </span>            :  *     implementation of this function.
<span class="lineNum">     473 </span>            :  *
<span class="lineNum">     474 </span>            :  *-------------------------------------------------------------------------
<span class="lineNum">     475 </span>            :  */
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span>            : #if defined(HAVE_INT_LOCALTIME_R)
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            : /*
<span class="lineNum">     480 </span>            :  * In this case we could define the macro as
<span class="lineNum">     481 </span>            :  *     #define MT_safe_localtime(timer, result) \
<span class="lineNum">     482 </span>            :  *             (localtime_r(timer, result) == 0 ? result : NULL)
<span class="lineNum">     483 </span>            :  * I chose to compare the return value of localtime_r with -1 so 
<span class="lineNum">     484 </span>            :  * that I can catch the cases where localtime_r returns a pointer
<span class="lineNum">     485 </span>            :  * to struct tm.  The macro definition above would not be able to
<span class="lineNum">     486 </span>            :  * detect such mistakes because it is legal to compare a pointer
<span class="lineNum">     487 </span>            :  * with 0.
<span class="lineNum">     488 </span>            :  */
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span>            : #define MT_safe_localtime(timer, result) \
<span class="lineNum">     491 </span>            :         (localtime_r(timer, result) == -1 ? NULL: result)
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span>            : #elif defined(HAVE_POINTER_LOCALTIME_R)
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span>            : #define MT_safe_localtime localtime_r
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span>            : #elif defined(_MSC_VER)
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span>            : /* Visual C++ has had localtime_s() since Visual C++ 2005. */
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span>            : static struct tm *MT_safe_localtime(const time_t *clock, struct tm *result)
<span class="lineNum">     502 </span>            : {
<span class="lineNum">     503 </span>            :     errno_t err = localtime_s(result, clock);
<span class="lineNum">     504 </span>            :     if (err != 0) {
<span class="lineNum">     505 </span>            :         errno = err;
<span class="lineNum">     506 </span>            :         return NULL;
<span class="lineNum">     507 </span>            :     }
<span class="lineNum">     508 </span>            :     return result;
<span class="lineNum">     509 </span>            : }
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span>            : #else
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span>            : #define HAVE_LOCALTIME_MONITOR 1  /* We use 'monitor' to serialize our calls
<span class="lineNum">     514 </span>            :                                    * to localtime(). */
<span class="lineNum">     515 </span>            : static PRLock *monitor = NULL;
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span>            : static struct tm *MT_safe_localtime(const time_t *clock, struct tm *result)
<span class="lineNum">     518 </span>            : {
<span class="lineNum">     519 </span>            :     struct tm *tmPtr;
<span class="lineNum">     520 </span>            :     int needLock = PR_Initialized();  /* We need to use a lock to protect
<span class="lineNum">     521 </span>            :                                        * against NSPR threads only when the
<span class="lineNum">     522 </span>            :                                        * NSPR thread system is activated. */
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span>            :     if (needLock) PR_Lock(monitor);
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span>            :     /*
<span class="lineNum">     527 </span>            :      * Microsoft (all flavors) localtime() returns a NULL pointer if 'clock'
<span class="lineNum">     528 </span>            :      * represents a time before midnight January 1, 1970.  In
<span class="lineNum">     529 </span>            :      * that case, we also return a NULL pointer and the struct tm
<span class="lineNum">     530 </span>            :      * object pointed to by 'result' is not modified.
<span class="lineNum">     531 </span>            :      *
<span class="lineNum">     532 </span>            :      * Watcom C/C++ 11.0 localtime() treats time_t as unsigned long
<span class="lineNum">     533 </span>            :      * hence, does not recognize negative values of clock as pre-1/1/70.
<span class="lineNum">     534 </span>            :      * We have to manually check (WIN16 only) for negative value of
<span class="lineNum">     535 </span>            :      * clock and return NULL.
<span class="lineNum">     536 </span>            :      *
<span class="lineNum">     537 </span>            :      * With negative values of clock, OS/2 returns the struct tm for
<span class="lineNum">     538 </span>            :      * clock plus ULONG_MAX. So we also have to check for the invalid
<span class="lineNum">     539 </span>            :      * structs returned for timezones west of Greenwich when clock == 0.
<span class="lineNum">     540 </span>            :      */
<span class="lineNum">     541 </span>            :     
<span class="lineNum">     542 </span>            :     tmPtr = localtime(clock);
<span class="lineNum">     543 </span>            : 
<span class="lineNum">     544 </span>            : #if defined(WIN16) || defined(XP_OS2)
<span class="lineNum">     545 </span>            :     if ( (PRInt32) *clock &lt; 0 ||
<span class="lineNum">     546 </span>            :          ( (PRInt32) *clock == 0 &amp;&amp; tmPtr-&gt;tm_year != 70))
<span class="lineNum">     547 </span>            :         result = NULL;
<span class="lineNum">     548 </span>            :     else
<span class="lineNum">     549 </span>            :         *result = *tmPtr;
<span class="lineNum">     550 </span>            : #else
<span class="lineNum">     551 </span>            :     if (tmPtr) {
<span class="lineNum">     552 </span>            :         *result = *tmPtr;
<span class="lineNum">     553 </span>            :     } else {
<span class="lineNum">     554 </span>            :         result = NULL;
<span class="lineNum">     555 </span>            :     }
<span class="lineNum">     556 </span>            : #endif /* WIN16 */
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span>            :     if (needLock) PR_Unlock(monitor);
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span>            :     return result;
<span class="lineNum">     561 </span>            : }
<span class="lineNum">     562 </span>            : 
<a name="563"><span class="lineNum">     563 </span>            : #endif  /* definition of MT_safe_localtime() */</a>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineCov">          3 : void _PR_InitTime(void)</span>
<span class="lineNum">     566 </span>            : {
<span class="lineNum">     567 </span>            : #ifdef HAVE_LOCALTIME_MONITOR
<span class="lineNum">     568 </span>            :     monitor = PR_NewLock();
<span class="lineNum">     569 </span>            : #endif
<span class="lineNum">     570 </span>            : #ifdef WINCE
<span class="lineNum">     571 </span>            :     _MD_InitTime();
<span class="lineNum">     572 </span>            : #endif
<a name="573"><span class="lineNum">     573 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineNoCov">          0 : void _PR_CleanupTime(void)</span>
<span class="lineNum">     576 </span>            : {
<span class="lineNum">     577 </span>            : #ifdef HAVE_LOCALTIME_MONITOR
<span class="lineNum">     578 </span>            :     if (monitor) {
<span class="lineNum">     579 </span>            :         PR_DestroyLock(monitor);
<span class="lineNum">     580 </span>            :         monitor = NULL;
<span class="lineNum">     581 </span>            :     }
<span class="lineNum">     582 </span>            : #endif
<span class="lineNum">     583 </span>            : #ifdef WINCE
<span class="lineNum">     584 </span>            :     _MD_CleanupTime();
<span class="lineNum">     585 </span>            : #endif
<span class="lineNum">     586 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span>            : #if defined(XP_UNIX) || defined(XP_PC) || defined(XP_BEOS)
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span>            : PR_IMPLEMENT(PRTimeParameters)
<span class="lineNum">     591 </span>            : PR_LocalTimeParameters(const PRExplodedTime *gmt)
<span class="lineNum">     592 </span>            : {
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            :     PRTimeParameters retVal;
<span class="lineNum">     595 </span>            :     struct tm localTime;
<span class="lineNum">     596 </span>            :     struct tm *localTimeResult;
<span class="lineNum">     597 </span>            :     time_t secs;
<span class="lineNum">     598 </span>            :     PRTime secs64;
<span class="lineNum">     599 </span>            :     PRInt64 usecPerSec;
<span class="lineNum">     600 </span>            :     PRInt64 usecPerSec_1;
<span class="lineNum">     601 </span>            :     PRInt64 maxInt32;
<span class="lineNum">     602 </span>            :     PRInt64 minInt32;
<span class="lineNum">     603 </span>            :     PRInt32 dayOffset;
<span class="lineNum">     604 </span>            :     PRInt32 offset2Jan1970;
<span class="lineNum">     605 </span>            :     PRInt32 offsetNew;
<span class="lineNum">     606 </span>            :     int isdst2Jan1970;
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span>            :     /*
<span class="lineNum">     609 </span>            :      * Calculate the GMT offset.  First, figure out what is
<span class="lineNum">     610 </span>            :      * 00:00:00 Jan. 2, 1970 GMT (which is exactly a day, or 86400
<span class="lineNum">     611 </span>            :      * seconds, since the epoch) in local time.  Then we calculate
<span class="lineNum">     612 </span>            :      * the difference between local time and GMT in seconds:
<span class="lineNum">     613 </span>            :      *     gmt_offset = local_time - GMT
<span class="lineNum">     614 </span>            :      *
<span class="lineNum">     615 </span>            :      * Caveat: the validity of this calculation depends on two
<span class="lineNum">     616 </span>            :      * assumptions:
<span class="lineNum">     617 </span>            :      * 1. Daylight saving time was not in effect on Jan. 2, 1970.
<span class="lineNum">     618 </span>            :      * 2. The time zone of the geographic location has not changed
<span class="lineNum">     619 </span>            :      *    since Jan. 2, 1970.
<span class="lineNum">     620 </span>            :      */
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span><span class="lineCov">         25 :     secs = 86400L;</span>
<span class="lineNum">     623 </span><span class="lineCov">         25 :     localTimeResult = MT_safe_localtime(&amp;secs, &amp;localTime);</span>
<span class="lineNum">     624 </span><span class="lineCov">         25 :     PR_ASSERT(localTimeResult != NULL);</span>
<span class="lineNum">     625 </span><span class="lineCov">         25 :     if (localTimeResult == NULL) {</span>
<span class="lineNum">     626 </span>            :         /* Shouldn't happen. Use safe fallback for optimized builds. */
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :         return PR_GMTParameters(gmt);</span>
<span class="lineNum">     628 </span>            :     }
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span>            :     /* GMT is 00:00:00, 2nd of Jan. */
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span><span class="lineCov">         50 :     offset2Jan1970 = (PRInt32)localTime.tm_sec </span>
<span class="lineNum">     633 </span><span class="lineCov">         25 :             + 60L * (PRInt32)localTime.tm_min</span>
<span class="lineNum">     634 </span><span class="lineCov">         50 :             + 3600L * (PRInt32)localTime.tm_hour</span>
<span class="lineNum">     635 </span><span class="lineCov">         25 :             + 86400L * (PRInt32)((PRInt32)localTime.tm_mday - 2L);</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineCov">         25 :     isdst2Jan1970 = localTime.tm_isdst;</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :     /*
<span class="lineNum">     640 </span>            :      * Now compute DST offset.  We calculate the overall offset
<span class="lineNum">     641 </span>            :      * of local time from GMT, similar to above.  The overall
<span class="lineNum">     642 </span>            :      * offset has two components: gmt offset and dst offset.
<span class="lineNum">     643 </span>            :      * We subtract gmt offset from the overall offset to get
<span class="lineNum">     644 </span>            :      * the dst offset.
<span class="lineNum">     645 </span>            :      *     overall_offset = local_time - GMT
<span class="lineNum">     646 </span>            :      *     overall_offset = gmt_offset + dst_offset
<span class="lineNum">     647 </span>            :      * ==&gt; dst_offset = local_time - GMT - gmt_offset
<span class="lineNum">     648 </span>            :      */
<span class="lineNum">     649 </span>            : 
<span class="lineNum">     650 </span><span class="lineCov">         25 :     secs64 = PR_ImplodeTime(gmt);    /* This is still in microseconds */</span>
<span class="lineNum">     651 </span><span class="lineCov">         25 :     LL_I2L(usecPerSec, PR_USEC_PER_SEC);</span>
<span class="lineNum">     652 </span><span class="lineCov">         25 :     LL_I2L(usecPerSec_1, PR_USEC_PER_SEC - 1);</span>
<span class="lineNum">     653 </span>            :     /* Convert to seconds, truncating down (3.1 -&gt; 3 and -3.1 -&gt; -4) */
<span class="lineNum">     654 </span><span class="lineCov">         25 :     if (LL_GE_ZERO(secs64)) {</span>
<span class="lineNum">     655 </span><span class="lineCov">         25 :         LL_DIV(secs64, secs64, usecPerSec);</span>
<span class="lineNum">     656 </span>            :     } else {
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :         LL_NEG(secs64, secs64);</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :         LL_ADD(secs64, secs64, usecPerSec_1);</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :         LL_DIV(secs64, secs64, usecPerSec);</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :         LL_NEG(secs64, secs64);</span>
<span class="lineNum">     661 </span>            :     }
<span class="lineNum">     662 </span><span class="lineCov">         25 :     LL_I2L(maxInt32, PR_INT32_MAX);</span>
<span class="lineNum">     663 </span><span class="lineCov">         25 :     LL_I2L(minInt32, PR_INT32_MIN);</span>
<span class="lineNum">     664 </span><span class="lineCov">         25 :     if (LL_CMP(secs64, &gt;, maxInt32) || LL_CMP(secs64, &lt;, minInt32)) {</span>
<span class="lineNum">     665 </span>            :         /* secs64 is too large or too small for time_t (32-bit integer) */
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :         retVal.tp_gmt_offset = offset2Jan1970;</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :         retVal.tp_dst_offset = 0;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :         return retVal;</span>
<span class="lineNum">     669 </span>            :     }
<span class="lineNum">     670 </span><span class="lineCov">         25 :     LL_L2I(secs, secs64);</span>
<span class="lineNum">     671 </span>            : 
<span class="lineNum">     672 </span>            :     /*
<span class="lineNum">     673 </span>            :      * On Windows, localtime() (and our MT_safe_localtime() too)
<span class="lineNum">     674 </span>            :      * returns a NULL pointer for time before midnight January 1,
<span class="lineNum">     675 </span>            :      * 1970 GMT.  In that case, we just use the GMT offset for
<span class="lineNum">     676 </span>            :      * Jan 2, 1970 and assume that DST was not in effect.
<span class="lineNum">     677 </span>            :      */
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineCov">         25 :     if (MT_safe_localtime(&amp;secs, &amp;localTime) == NULL) {</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :         retVal.tp_gmt_offset = offset2Jan1970;</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :         retVal.tp_dst_offset = 0;</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :         return retVal;</span>
<span class="lineNum">     683 </span>            :     }
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span>            :     /*
<span class="lineNum">     686 </span>            :      * dayOffset is the offset between local time and GMT in 
<span class="lineNum">     687 </span>            :      * the day component, which can only be -1, 0, or 1.  We
<span class="lineNum">     688 </span>            :      * use the day of the week to compute dayOffset.
<span class="lineNum">     689 </span>            :      */
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span><span class="lineCov">         25 :     dayOffset = (PRInt32) localTime.tm_wday - gmt-&gt;tm_wday;</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span>            :     /*
<span class="lineNum">     694 </span>            :      * Need to adjust for wrapping around of day of the week from
<span class="lineNum">     695 </span>            :      * 6 back to 0.
<span class="lineNum">     696 </span>            :      */
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineCov">         25 :     if (dayOffset == -6) {</span>
<span class="lineNum">     699 </span>            :         /* Local time is Sunday (0) and GMT is Saturday (6) */
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :         dayOffset = 1;</span>
<span class="lineNum">     701 </span><span class="lineCov">         25 :     } else if (dayOffset == 6) {</span>
<span class="lineNum">     702 </span>            :         /* Local time is Saturday (6) and GMT is Sunday (0) */
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :         dayOffset = -1;</span>
<span class="lineNum">     704 </span>            :     }
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span><span class="lineCov">         50 :     offsetNew = (PRInt32)localTime.tm_sec - gmt-&gt;tm_sec</span>
<span class="lineNum">     707 </span><span class="lineCov">         25 :             + 60L * ((PRInt32)localTime.tm_min - gmt-&gt;tm_min)</span>
<span class="lineNum">     708 </span><span class="lineCov">         50 :             + 3600L * ((PRInt32)localTime.tm_hour - gmt-&gt;tm_hour)</span>
<span class="lineNum">     709 </span><span class="lineCov">         25 :             + 86400L * (PRInt32)dayOffset;</span>
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span><span class="lineCov">         25 :     if (localTime.tm_isdst &lt;= 0) {</span>
<span class="lineNum">     712 </span>            :         /* DST is not in effect */
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :         retVal.tp_gmt_offset = offsetNew;</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :         retVal.tp_dst_offset = 0;</span>
<span class="lineNum">     715 </span>            :     } else {
<span class="lineNum">     716 </span>            :         /* DST is in effect */
<span class="lineNum">     717 </span><span class="lineCov">         25 :         if (isdst2Jan1970 &lt;=0) {</span>
<span class="lineNum">     718 </span>            :             /*
<span class="lineNum">     719 </span>            :              * DST was not in effect back in 2 Jan. 1970.
<span class="lineNum">     720 </span>            :              * Use the offset back then as the GMT offset,
<span class="lineNum">     721 </span>            :              * assuming the time zone has not changed since then.
<span class="lineNum">     722 </span>            :              */
<span class="lineNum">     723 </span><span class="lineCov">         25 :             retVal.tp_gmt_offset = offset2Jan1970;</span>
<span class="lineNum">     724 </span><span class="lineCov">         25 :             retVal.tp_dst_offset = offsetNew - offset2Jan1970;</span>
<span class="lineNum">     725 </span>            :         } else {
<span class="lineNum">     726 </span>            :             /*
<span class="lineNum">     727 </span>            :              * DST was also in effect back in 2 Jan. 1970.
<span class="lineNum">     728 </span>            :              * Then our clever trick (or rather, ugly hack) fails.
<span class="lineNum">     729 </span>            :              * We will just assume DST offset is an hour.
<span class="lineNum">     730 </span>            :              */
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :             retVal.tp_gmt_offset = offsetNew - 3600;</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :             retVal.tp_dst_offset = 3600;</span>
<span class="lineNum">     733 </span>            :         }
<span class="lineNum">     734 </span>            :     }
<span class="lineNum">     735 </span>            :     
<span class="lineNum">     736 </span><span class="lineCov">         25 :     return retVal;</span>
<span class="lineNum">     737 </span>            : }
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span>            : #endif    /* defined(XP_UNIX) || defined(XP_PC) || defined(XP_BEOS) */
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span>            : /*
<span class="lineNum">     742 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">     743 </span>            :  *
<span class="lineNum">     744 </span>            :  * PR_USPacificTimeParameters --
<span class="lineNum">     745 </span>            :  *
<span class="lineNum">     746 </span>            :  *     The time parameters function for the US Pacific Time Zone.
<span class="lineNum">     747 </span>            :  *
<span class="lineNum">     748 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">     749 </span>            :  */
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span>            : /*
<span class="lineNum">     752 </span>            :  * Returns the mday of the first sunday of the month, where
<span class="lineNum">     753 </span>            :  * mday and wday are for a given day in the month.
<span class="lineNum">     754 </span>            :  * mdays start with 1 (e.g. 1..31).  
<span class="lineNum">     755 </span>            :  * wdays start with 0 and are in the range 0..6.  0 = Sunday.
<span class="lineNum">     756 </span>            :  */
<span class="lineNum">     757 </span>            : #define firstSunday(mday, wday) (((mday - wday + 7 - 1) % 7) + 1)
<span class="lineNum">     758 </span>            : 
<span class="lineNum">     759 </span>            : /*
<span class="lineNum">     760 </span>            :  * Returns the mday for the N'th Sunday of the month, where 
<span class="lineNum">     761 </span>            :  * mday and wday are for a given day in the month.
<span class="lineNum">     762 </span>            :  * mdays start with 1 (e.g. 1..31).  
<span class="lineNum">     763 </span>            :  * wdays start with 0 and are in the range 0..6.  0 = Sunday.
<span class="lineNum">     764 </span>            :  * N has the following values: 0 = first, 1 = second (etc), -1 = last.
<span class="lineNum">     765 </span>            :  * ndays is the number of days in that month, the same value as the 
<span class="lineNum">     766 </span>            :  * mday of the last day of the month.
<a name="767"><span class="lineNum">     767 </span>            :  */</a>
<span class="lineNum">     768 </span>            : static PRInt32 
<span class="lineNum">     769 </span><span class="lineNoCov">          0 : NthSunday(PRInt32 mday, PRInt32 wday, PRInt32 N, PRInt32 ndays) </span>
<span class="lineNum">     770 </span>            : {
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :     PRInt32 firstSun = firstSunday(mday, wday);</span>
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :     if (N &lt; 0) </span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :         N = (ndays - firstSun) / 7;</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :     return firstSun + (7 * N);</span>
<span class="lineNum">     776 </span>            : }
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span>            : typedef struct DSTParams {
<span class="lineNum">     779 </span>            :     PRInt8 dst_start_month;       /* 0 = January */
<span class="lineNum">     780 </span>            :     PRInt8 dst_start_Nth_Sunday;  /* N as defined above */
<span class="lineNum">     781 </span>            :     PRInt8 dst_start_month_ndays; /* ndays as defined above */
<span class="lineNum">     782 </span>            :     PRInt8 dst_end_month;         /* 0 = January */
<span class="lineNum">     783 </span>            :     PRInt8 dst_end_Nth_Sunday;    /* N as defined above */
<span class="lineNum">     784 </span>            :     PRInt8 dst_end_month_ndays;   /* ndays as defined above */
<span class="lineNum">     785 </span>            : } DSTParams;
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span>            : static const DSTParams dstParams[2] = {
<span class="lineNum">     788 </span>            :     /* year &lt; 2007:  First April Sunday - Last October Sunday */
<span class="lineNum">     789 </span>            :     { 3, 0, 30, 9, -1, 31 },
<span class="lineNum">     790 </span>            :     /* year &gt;= 2007: Second March Sunday - First November Sunday */
<span class="lineNum">     791 </span>            :     { 2, 1, 31, 10, 0, 30 }
<span class="lineNum">     792 </span>            : };
<span class="lineNum">     793 </span>            : 
<span class="lineNum">     794 </span>            : PR_IMPLEMENT(PRTimeParameters)
<span class="lineNum">     795 </span>            : PR_USPacificTimeParameters(const PRExplodedTime *gmt)
<span class="lineNum">     796 </span>            : {
<span class="lineNum">     797 </span>            :     const DSTParams *dst;
<span class="lineNum">     798 </span>            :     PRTimeParameters retVal;
<span class="lineNum">     799 </span>            :     PRExplodedTime st;
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span>            :     /*
<span class="lineNum">     802 </span>            :      * Based on geographic location and GMT, figure out offset of
<span class="lineNum">     803 </span>            :      * standard time from GMT.  In this example implementation, we
<span class="lineNum">     804 </span>            :      * assume the local time zone is US Pacific Time.
<span class="lineNum">     805 </span>            :      */
<span class="lineNum">     806 </span>            : 
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :     retVal.tp_gmt_offset = -8L * 3600L;</span>
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span>            :     /*
<span class="lineNum">     810 </span>            :      * Make a copy of GMT.  Note that the tm_params field of this copy
<span class="lineNum">     811 </span>            :      * is ignored.
<span class="lineNum">     812 </span>            :      */
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :     st.tm_usec = gmt-&gt;tm_usec;</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :     st.tm_sec = gmt-&gt;tm_sec;</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :     st.tm_min = gmt-&gt;tm_min;</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :     st.tm_hour = gmt-&gt;tm_hour;</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :     st.tm_mday = gmt-&gt;tm_mday;</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :     st.tm_month = gmt-&gt;tm_month;</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :     st.tm_year = gmt-&gt;tm_year;</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :     st.tm_wday = gmt-&gt;tm_wday;</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :     st.tm_yday = gmt-&gt;tm_yday;</span>
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span>            :     /* Apply the offset to GMT to obtain the local standard time */
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :     ApplySecOffset(&amp;st, retVal.tp_gmt_offset);</span>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :     if (st.tm_year &lt; 2007) { /* first April Sunday - Last October Sunday */</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :         dst = &amp;dstParams[0];</span>
<span class="lineNum">     829 </span>            :     } else {                 /* Second March Sunday - First November Sunday */
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :         dst = &amp;dstParams[1];</span>
<span class="lineNum">     831 </span>            :     }
<span class="lineNum">     832 </span>            : 
<span class="lineNum">     833 </span>            :     /*
<span class="lineNum">     834 </span>            :      * Apply the rules on standard time or GMT to obtain daylight saving
<span class="lineNum">     835 </span>            :      * time offset.  In this implementation, we use the US DST rule.
<span class="lineNum">     836 </span>            :      */
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :     if (st.tm_month &lt; dst-&gt;dst_start_month) {</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :         retVal.tp_dst_offset = 0L;</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :     } else if (st.tm_month == dst-&gt;dst_start_month) {</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :         int NthSun = NthSunday(st.tm_mday, st.tm_wday, </span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :                                dst-&gt;dst_start_Nth_Sunday, </span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :                                dst-&gt;dst_start_month_ndays);</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :         if (st.tm_mday &lt; NthSun) {              /* Before starting Sunday */</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :             retVal.tp_dst_offset = 0L;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :         } else if (st.tm_mday == NthSun) {      /* Starting Sunday */</span>
<span class="lineNum">     846 </span>            :             /* 01:59:59 PST -&gt; 03:00:00 PDT */
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :             if (st.tm_hour &lt; 2) {</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :                 retVal.tp_dst_offset = 0L;</span>
<span class="lineNum">     849 </span>            :             } else {
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :                 retVal.tp_dst_offset = 3600L;</span>
<span class="lineNum">     851 </span>            :             }
<span class="lineNum">     852 </span>            :         } else {                                /* After starting Sunday */
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :             retVal.tp_dst_offset = 3600L;</span>
<span class="lineNum">     854 </span>            :         }
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :     } else if (st.tm_month &lt; dst-&gt;dst_end_month) {</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :         retVal.tp_dst_offset = 3600L;</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :     } else if (st.tm_month == dst-&gt;dst_end_month) {</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :         int NthSun = NthSunday(st.tm_mday, st.tm_wday, </span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :                                dst-&gt;dst_end_Nth_Sunday, </span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :                                dst-&gt;dst_end_month_ndays);</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :         if (st.tm_mday &lt; NthSun) {              /* Before ending Sunday */</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :             retVal.tp_dst_offset = 3600L;</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :         } else if (st.tm_mday == NthSun) {      /* Ending Sunday */</span>
<span class="lineNum">     864 </span>            :             /* 01:59:59 PDT -&gt; 01:00:00 PST */
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :             if (st.tm_hour &lt; 1) {</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :                 retVal.tp_dst_offset = 3600L;</span>
<span class="lineNum">     867 </span>            :             } else {
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :                 retVal.tp_dst_offset = 0L;</span>
<span class="lineNum">     869 </span>            :             }
<span class="lineNum">     870 </span>            :         } else {                                /* After ending Sunday */
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :             retVal.tp_dst_offset = 0L;</span>
<span class="lineNum">     872 </span>            :         }
<span class="lineNum">     873 </span>            :     } else {
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :         retVal.tp_dst_offset = 0L;</span>
<span class="lineNum">     875 </span>            :     }
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :     return retVal;</span>
<span class="lineNum">     877 </span>            : }
<span class="lineNum">     878 </span>            : 
<span class="lineNum">     879 </span>            : /*
<span class="lineNum">     880 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">     881 </span>            :  *
<span class="lineNum">     882 </span>            :  * PR_GMTParameters --
<span class="lineNum">     883 </span>            :  *
<span class="lineNum">     884 </span>            :  *     Returns the PRTimeParameters for Greenwich Mean Time.
<span class="lineNum">     885 </span>            :  *     Trivially, both the tp_gmt_offset and tp_dst_offset fields are 0.
<span class="lineNum">     886 </span>            :  *
<span class="lineNum">     887 </span>            :  *------------------------------------------------------------------------
<span class="lineNum">     888 </span>            :  */
<span class="lineNum">     889 </span>            : 
<span class="lineNum">     890 </span>            : PR_IMPLEMENT(PRTimeParameters)
<span class="lineNum">     891 </span>            : PR_GMTParameters(const PRExplodedTime *gmt)
<span class="lineNum">     892 </span>            : {
<span class="lineNum">     893 </span><span class="lineCov">         45 :     PRTimeParameters retVal = { 0, 0 };</span>
<span class="lineNum">     894 </span><span class="lineCov">         45 :     return retVal;</span>
<span class="lineNum">     895 </span>            : }
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span>            : /*
<span class="lineNum">     898 </span>            :  * The following code implements PR_ParseTimeString().  It is based on
<span class="lineNum">     899 </span>            :  * ns/lib/xp/xp_time.c, revision 1.25, by Jamie Zawinski &lt;jwz@netscape.com&gt;.
<span class="lineNum">     900 </span>            :  */
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span>            : /*
<span class="lineNum">     903 </span>            :  * We only recognize the abbreviations of a small subset of time zones
<span class="lineNum">     904 </span>            :  * in North America, Europe, and Japan.
<span class="lineNum">     905 </span>            :  *
<span class="lineNum">     906 </span>            :  * PST/PDT: Pacific Standard/Daylight Time
<span class="lineNum">     907 </span>            :  * MST/MDT: Mountain Standard/Daylight Time
<span class="lineNum">     908 </span>            :  * CST/CDT: Central Standard/Daylight Time
<span class="lineNum">     909 </span>            :  * EST/EDT: Eastern Standard/Daylight Time
<span class="lineNum">     910 </span>            :  * AST: Atlantic Standard Time
<span class="lineNum">     911 </span>            :  * NST: Newfoundland Standard Time
<span class="lineNum">     912 </span>            :  * GMT: Greenwich Mean Time
<span class="lineNum">     913 </span>            :  * BST: British Summer Time
<span class="lineNum">     914 </span>            :  * MET: Middle Europe Time
<span class="lineNum">     915 </span>            :  * EET: Eastern Europe Time
<span class="lineNum">     916 </span>            :  * JST: Japan Standard Time
<span class="lineNum">     917 </span>            :  */
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span>            : typedef enum
<span class="lineNum">     920 </span>            : {
<span class="lineNum">     921 </span>            :   TT_UNKNOWN,
<span class="lineNum">     922 </span>            : 
<span class="lineNum">     923 </span>            :   TT_SUN, TT_MON, TT_TUE, TT_WED, TT_THU, TT_FRI, TT_SAT,
<span class="lineNum">     924 </span>            : 
<span class="lineNum">     925 </span>            :   TT_JAN, TT_FEB, TT_MAR, TT_APR, TT_MAY, TT_JUN,
<span class="lineNum">     926 </span>            :   TT_JUL, TT_AUG, TT_SEP, TT_OCT, TT_NOV, TT_DEC,
<span class="lineNum">     927 </span>            : 
<span class="lineNum">     928 </span>            :   TT_PST, TT_PDT, TT_MST, TT_MDT, TT_CST, TT_CDT, TT_EST, TT_EDT,
<span class="lineNum">     929 </span>            :   TT_AST, TT_NST, TT_GMT, TT_BST, TT_MET, TT_EET, TT_JST
<span class="lineNum">     930 </span>            : } TIME_TOKEN;
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span>            : /*
<span class="lineNum">     933 </span>            :  * This parses a time/date string into a PRTime
<span class="lineNum">     934 </span>            :  * (microseconds after &quot;1-Jan-1970 00:00:00 GMT&quot;).
<span class="lineNum">     935 </span>            :  * It returns PR_SUCCESS on success, and PR_FAILURE
<span class="lineNum">     936 </span>            :  * if the time/date string can't be parsed.
<span class="lineNum">     937 </span>            :  *
<span class="lineNum">     938 </span>            :  * Many formats are handled, including:
<span class="lineNum">     939 </span>            :  *
<span class="lineNum">     940 </span>            :  *   14 Apr 89 03:20:12
<span class="lineNum">     941 </span>            :  *   14 Apr 89 03:20 GMT
<span class="lineNum">     942 </span>            :  *   Fri, 17 Mar 89 4:01:33
<span class="lineNum">     943 </span>            :  *   Fri, 17 Mar 89 4:01 GMT
<span class="lineNum">     944 </span>            :  *   Mon Jan 16 16:12 PDT 1989
<span class="lineNum">     945 </span>            :  *   Mon Jan 16 16:12 +0130 1989
<span class="lineNum">     946 </span>            :  *   6 May 1992 16:41-JST (Wednesday)
<span class="lineNum">     947 </span>            :  *   22-AUG-1993 10:59:12.82
<span class="lineNum">     948 </span>            :  *   22-AUG-1993 10:59pm
<span class="lineNum">     949 </span>            :  *   22-AUG-1993 12:59am
<span class="lineNum">     950 </span>            :  *   22-AUG-1993 12:59 PM
<span class="lineNum">     951 </span>            :  *   Friday, August 04, 1995 3:54 PM
<span class="lineNum">     952 </span>            :  *   06/21/95 04:24:34 PM
<span class="lineNum">     953 </span>            :  *   20/06/95 21:07
<span class="lineNum">     954 </span>            :  *   95-06-08 19:32:48 EDT
<span class="lineNum">     955 </span>            :  *
<span class="lineNum">     956 </span>            :  * If the input string doesn't contain a description of the timezone,
<span class="lineNum">     957 </span>            :  * we consult the `default_to_gmt' to decide whether the string should
<span class="lineNum">     958 </span>            :  * be interpreted relative to the local time zone (PR_FALSE) or GMT (PR_TRUE).
<span class="lineNum">     959 </span>            :  * The correct value for this argument depends on what standard specified
<span class="lineNum">     960 </span>            :  * the time string which you are parsing.
<span class="lineNum">     961 </span>            :  */
<span class="lineNum">     962 </span>            : 
<span class="lineNum">     963 </span>            : PR_IMPLEMENT(PRStatus)
<span class="lineNum">     964 </span>            : PR_ParseTimeStringToExplodedTime(
<span class="lineNum">     965 </span>            :         const char *string,
<span class="lineNum">     966 </span>            :         PRBool default_to_gmt,
<span class="lineNum">     967 </span>            :         PRExplodedTime *result)
<span class="lineNum">     968 </span>            : {
<span class="lineNum">     969 </span><span class="lineCov">         10 :   TIME_TOKEN dotw = TT_UNKNOWN;</span>
<span class="lineNum">     970 </span><span class="lineCov">         10 :   TIME_TOKEN month = TT_UNKNOWN;</span>
<span class="lineNum">     971 </span><span class="lineCov">         10 :   TIME_TOKEN zone = TT_UNKNOWN;</span>
<span class="lineNum">     972 </span><span class="lineCov">         10 :   int zone_offset = -1;</span>
<span class="lineNum">     973 </span><span class="lineCov">         10 :   int dst_offset = 0;</span>
<span class="lineNum">     974 </span><span class="lineCov">         10 :   int date = -1;</span>
<span class="lineNum">     975 </span><span class="lineCov">         10 :   PRInt32 year = -1;</span>
<span class="lineNum">     976 </span><span class="lineCov">         10 :   int hour = -1;</span>
<span class="lineNum">     977 </span><span class="lineCov">         10 :   int min = -1;</span>
<span class="lineNum">     978 </span><span class="lineCov">         10 :   int sec = -1;</span>
<span class="lineNum">     979 </span>            :   struct tm *localTimeResult;
<span class="lineNum">     980 </span>            : 
<span class="lineNum">     981 </span><span class="lineCov">         10 :   const char *rest = string;</span>
<span class="lineNum">     982 </span>            : 
<span class="lineNum">     983 </span><span class="lineCov">         10 :   int iterations = 0;</span>
<span class="lineNum">     984 </span>            : 
<span class="lineNum">     985 </span><span class="lineCov">         10 :   PR_ASSERT(string &amp;&amp; result);</span>
<span class="lineNum">     986 </span><span class="lineCov">         10 :   if (!string || !result) return PR_FAILURE;</span>
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span><span class="lineCov">         80 :   while (*rest)</span>
<span class="lineNum">     989 </span>            :         {
<span class="lineNum">     990 </span>            : 
<span class="lineNum">     991 </span><span class="lineCov">         60 :           if (iterations++ &gt; 1000)</span>
<span class="lineNum">     992 </span>            :                 {
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :                   return PR_FAILURE;</span>
<span class="lineNum">     994 </span>            :                 }
<span class="lineNum">     995 </span>            : 
<span class="lineNum">     996 </span><span class="lineCov">         60 :           switch (*rest)</span>
<span class="lineNum">     997 </span>            :                 {
<span class="lineNum">     998 </span>            :                 case 'a': case 'A':
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :                   if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :                           (rest[1] == 'p' || rest[1] == 'P') &amp;&amp;</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :                           (rest[2] == 'r' || rest[2] == 'R'))</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :                         month = TT_APR;</span>
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :                                    (rest[1] == 's' || rest[1] == 'S') &amp;&amp;</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :                         zone = TT_AST;</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :                   else if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :                                    (rest[1] == 'u' || rest[1] == 'U') &amp;&amp;</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :                                    (rest[2] == 'g' || rest[2] == 'G'))</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :                         month = TT_AUG;</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1012 </span>            :                 case 'b': case 'B':
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :                   if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :                           (rest[1] == 's' || rest[1] == 'S') &amp;&amp;</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :                           (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :                         zone = TT_BST;</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1018 </span>            :                 case 'c': case 'C':
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :                   if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :                           (rest[1] == 'd' || rest[1] == 'D') &amp;&amp;</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :                           (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :                         zone = TT_CDT;</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :                                    (rest[1] == 's' || rest[1] == 'S') &amp;&amp;</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :                         zone = TT_CST;</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1028 </span>            :                 case 'd': case 'D':
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :                   if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :                           (rest[1] == 'e' || rest[1] == 'E') &amp;&amp;</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :                           (rest[2] == 'c' || rest[2] == 'C'))</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :                         month = TT_DEC;</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1034 </span>            :                 case 'e': case 'E':
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :                   if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :                           (rest[1] == 'd' || rest[1] == 'D') &amp;&amp;</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :                           (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                         zone = TT_EDT;</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :                                    (rest[1] == 'e' || rest[1] == 'E') &amp;&amp;</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :                         zone = TT_EET;</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :                                    (rest[1] == 's' || rest[1] == 'S') &amp;&amp;</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :                         zone = TT_EST;</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1048 </span>            :                 case 'f': case 'F':
<span class="lineNum">    1049 </span><span class="lineCov">         16 :                   if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1050 </span><span class="lineCov">         16 :                           (rest[1] == 'e' || rest[1] == 'E') &amp;&amp;</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :                           (rest[2] == 'b' || rest[2] == 'B'))</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :                         month = TT_FEB;</span>
<span class="lineNum">    1053 </span><span class="lineCov">         16 :                   else if (dotw == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1054 </span><span class="lineCov">         16 :                                    (rest[1] == 'r' || rest[1] == 'R') &amp;&amp;</span>
<span class="lineNum">    1055 </span><span class="lineCov">          8 :                                    (rest[2] == 'i' || rest[2] == 'I'))</span>
<span class="lineNum">    1056 </span><span class="lineCov">          8 :                         dotw = TT_FRI;</span>
<span class="lineNum">    1057 </span><span class="lineCov">          8 :                   break;</span>
<span class="lineNum">    1058 </span>            :                 case 'g': case 'G':
<span class="lineNum">    1059 </span><span class="lineCov">         20 :                   if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1060 </span><span class="lineCov">         30 :                           (rest[1] == 'm' || rest[1] == 'M') &amp;&amp;</span>
<span class="lineNum">    1061 </span><span class="lineCov">         20 :                           (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1062 </span><span class="lineCov">         10 :                         zone = TT_GMT;</span>
<span class="lineNum">    1063 </span><span class="lineCov">         10 :                   break;</span>
<span class="lineNum">    1064 </span>            :                 case 'j': case 'J':
<span class="lineNum">    1065 </span><span class="lineCov">         20 :                   if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1066 </span><span class="lineCov">         20 :                           (rest[1] == 'a' || rest[1] == 'A') &amp;&amp;</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :                           (rest[2] == 'n' || rest[2] == 'N'))</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :                         month = TT_JAN;</span>
<span class="lineNum">    1069 </span><span class="lineCov">         20 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1070 </span><span class="lineCov">         20 :                                    (rest[1] == 's' || rest[1] == 'S') &amp;&amp;</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :                         zone = TT_JST;</span>
<span class="lineNum">    1073 </span><span class="lineCov">         20 :                   else if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1074 </span><span class="lineCov">         20 :                                    (rest[1] == 'u' || rest[1] == 'U') &amp;&amp;</span>
<span class="lineNum">    1075 </span><span class="lineCov">         10 :                                    (rest[2] == 'l' || rest[2] == 'L'))</span>
<span class="lineNum">    1076 </span><span class="lineCov">         10 :                         month = TT_JUL;</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :                   else if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :                                    (rest[1] == 'u' || rest[1] == 'U') &amp;&amp;</span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :                                    (rest[2] == 'n' || rest[2] == 'N'))</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :                         month = TT_JUN;</span>
<span class="lineNum">    1081 </span><span class="lineCov">         10 :                   break;</span>
<span class="lineNum">    1082 </span>            :                 case 'm': case 'M':
<span class="lineNum">    1083 </span><span class="lineCov">          4 :                   if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1084 </span><span class="lineCov">          4 :                           (rest[1] == 'a' || rest[1] == 'A') &amp;&amp;</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :                           (rest[2] == 'r' || rest[2] == 'R'))</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :                         month = TT_MAR;</span>
<span class="lineNum">    1087 </span><span class="lineCov">          4 :                   else if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1088 </span><span class="lineCov">          4 :                                    (rest[1] == 'a' || rest[1] == 'A') &amp;&amp;</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :                                    (rest[2] == 'y' || rest[2] == 'Y'))</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :                         month = TT_MAY;</span>
<span class="lineNum">    1091 </span><span class="lineCov">          4 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1092 </span><span class="lineCov">          4 :                                    (rest[1] == 'd' || rest[1] == 'D') &amp;&amp;</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :                         zone = TT_MDT;</span>
<span class="lineNum">    1095 </span><span class="lineCov">          4 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1096 </span><span class="lineCov">          4 :                                    (rest[1] == 'e' || rest[1] == 'E') &amp;&amp;</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :                         zone = TT_MET;</span>
<span class="lineNum">    1099 </span><span class="lineCov">          4 :                   else if (dotw == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1100 </span><span class="lineCov">          4 :                                    (rest[1] == 'o' || rest[1] == 'O') &amp;&amp;</span>
<span class="lineNum">    1101 </span><span class="lineCov">          2 :                                    (rest[2] == 'n' || rest[2] == 'N'))</span>
<span class="lineNum">    1102 </span><span class="lineCov">          2 :                         dotw = TT_MON;</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :                                    (rest[1] == 's' || rest[1] == 'S') &amp;&amp;</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :                         zone = TT_MST;</span>
<span class="lineNum">    1107 </span><span class="lineCov">          2 :                   break;</span>
<span class="lineNum">    1108 </span>            :                 case 'n': case 'N':
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :                   if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :                           (rest[1] == 'o' || rest[1] == 'O') &amp;&amp;</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :                           (rest[2] == 'v' || rest[2] == 'V'))</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :                         month = TT_NOV;</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :                                    (rest[1] == 's' || rest[1] == 'S') &amp;&amp;</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :                         zone = TT_NST;</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1118 </span>            :                 case 'o': case 'O':
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :                   if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :                           (rest[1] == 'c' || rest[1] == 'C') &amp;&amp;</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :                           (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :                         month = TT_OCT;</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1124 </span>            :                 case 'p': case 'P':
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :                   if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :                           (rest[1] == 'd' || rest[1] == 'D') &amp;&amp;</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :                           (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :                         zone = TT_PDT;</span>
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :                   else if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :                                    (rest[1] == 's' || rest[1] == 'S') &amp;&amp;</span>
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :                                    (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :                         zone = TT_PST;</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1134 </span>            :                 case 's': case 'S':
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :                   if (dotw == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :                           (rest[1] == 'a' || rest[1] == 'A') &amp;&amp;</span>
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :                           (rest[2] == 't' || rest[2] == 'T'))</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :                         dotw = TT_SAT;</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :                   else if (month == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :                                    (rest[1] == 'e' || rest[1] == 'E') &amp;&amp;</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :                                    (rest[2] == 'p' || rest[2] == 'P'))</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :                         month = TT_SEP;</span>
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :                   else if (dotw == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :                                    (rest[1] == 'u' || rest[1] == 'U') &amp;&amp;</span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :                                    (rest[2] == 'n' || rest[2] == 'N'))</span>
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :                         dotw = TT_SUN;</span>
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1148 </span>            :                 case 't': case 'T':
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :                   if (dotw == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :                           (rest[1] == 'h' || rest[1] == 'H') &amp;&amp;</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :                           (rest[2] == 'u' || rest[2] == 'U'))</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :                         dotw = TT_THU;</span>
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :                   else if (dotw == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :                                    (rest[1] == 'u' || rest[1] == 'U') &amp;&amp;</span>
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :                                    (rest[2] == 'e' || rest[2] == 'E'))</span>
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :                         dotw = TT_TUE;</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1158 </span>            :                 case 'u': case 'U':
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :                   if (zone == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :                           (rest[1] == 't' || rest[1] == 'T') &amp;&amp;</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :                           !(rest[2] &gt;= 'A' &amp;&amp; rest[2] &lt;= 'Z') &amp;&amp;</span>
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :                           !(rest[2] &gt;= 'a' &amp;&amp; rest[2] &lt;= 'z'))</span>
<span class="lineNum">    1163 </span>            :                         /* UT is the same as GMT but UTx is not. */
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :                         zone = TT_GMT;</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1166 </span>            :                 case 'w': case 'W':
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :                   if (dotw == TT_UNKNOWN &amp;&amp;</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :                           (rest[1] == 'e' || rest[1] == 'E') &amp;&amp;</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :                           (rest[2] == 'd' || rest[2] == 'D'))</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :                         dotw = TT_WED;</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1172 </span>            : 
<span class="lineNum">    1173 </span>            :                 case '+': case '-':
<span class="lineNum">    1174 </span>            :                   {
<span class="lineNum">    1175 </span>            :                         const char *end;
<span class="lineNum">    1176 </span>            :                         int sign;
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :                         if (zone_offset != -1)</span>
<span class="lineNum">    1178 </span>            :                           {
<span class="lineNum">    1179 </span>            :                                 /* already got one... */
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :                                 rest++;</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    1182 </span>            :                           }
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :                         if (zone != TT_UNKNOWN &amp;&amp; zone != TT_GMT)</span>
<span class="lineNum">    1184 </span>            :                           {
<span class="lineNum">    1185 </span>            :                                 /* GMT+0300 is legal, but PST+0300 is not. */
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :                                 rest++;</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    1188 </span>            :                           }
<span class="lineNum">    1189 </span>            : 
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :                         sign = ((*rest == '+') ? 1 : -1);</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :                         rest++; /* move over sign */</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :                         end = rest;</span>
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :                         while (*end &gt;= '0' &amp;&amp; *end &lt;= '9')</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :                           end++;</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :                         if (rest == end) /* no digits here */</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :                           break;</span>
<span class="lineNum">    1197 </span>            : 
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                         if ((end - rest) == 4)</span>
<span class="lineNum">    1199 </span>            :                           /* offset in HHMM */
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :                           zone_offset = (((((rest[0]-'0')*10) + (rest[1]-'0')) * 60) +</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :                                                          (((rest[2]-'0')*10) + (rest[3]-'0')));</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :                         else if ((end - rest) == 2)</span>
<span class="lineNum">    1203 </span>            :                           /* offset in hours */
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :                           zone_offset = (((rest[0]-'0')*10) + (rest[1]-'0')) * 60;</span>
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :                         else if ((end - rest) == 1)</span>
<span class="lineNum">    1206 </span>            :                           /* offset in hours */
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :                           zone_offset = (rest[0]-'0') * 60;</span>
<span class="lineNum">    1208 </span>            :                         else
<span class="lineNum">    1209 </span>            :                           /* 3 or &gt;4 */
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :                           break;</span>
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :                         zone_offset *= sign;</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :                         zone = TT_GMT;</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1215 </span>            :                   }
<span class="lineNum">    1216 </span>            : 
<span class="lineNum">    1217 </span>            :                 case '0': case '1': case '2': case '3': case '4':
<span class="lineNum">    1218 </span>            :                 case '5': case '6': case '7': case '8': case '9':
<span class="lineNum">    1219 </span>            :                   {
<span class="lineNum">    1220 </span><span class="lineCov">         30 :                         int tmp_hour = -1;</span>
<span class="lineNum">    1221 </span><span class="lineCov">         30 :                         int tmp_min = -1;</span>
<span class="lineNum">    1222 </span><span class="lineCov">         30 :                         int tmp_sec = -1;</span>
<span class="lineNum">    1223 </span><span class="lineCov">         30 :                         const char *end = rest + 1;</span>
<span class="lineNum">    1224 </span><span class="lineCov">        110 :                         while (*end &gt;= '0' &amp;&amp; *end &lt;= '9')</span>
<span class="lineNum">    1225 </span><span class="lineCov">         50 :                           end++;</span>
<span class="lineNum">    1226 </span>            : 
<span class="lineNum">    1227 </span>            :                         /* end is now the first character after a range of digits. */
<span class="lineNum">    1228 </span>            : 
<span class="lineNum">    1229 </span><span class="lineCov">         30 :                         if (*end == ':')</span>
<span class="lineNum">    1230 </span>            :                           {
<span class="lineNum">    1231 </span><span class="lineCov">         10 :                                 if (hour &gt;= 0 &amp;&amp; min &gt;= 0) /* already got it */</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :                                   break;</span>
<span class="lineNum">    1233 </span>            : 
<span class="lineNum">    1234 </span>            :                                 /* We have seen &quot;[0-9]+:&quot;, so this is probably HH:MM[:SS] */
<span class="lineNum">    1235 </span><span class="lineCov">         10 :                                 if ((end - rest) &gt; 2)</span>
<span class="lineNum">    1236 </span>            :                                   /* it is [0-9][0-9][0-9]+: */
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :                                   break;</span>
<span class="lineNum">    1238 </span><span class="lineCov">         10 :                                 if ((end - rest) == 2)</span>
<span class="lineNum">    1239 </span><span class="lineCov">         20 :                                   tmp_hour = ((rest[0]-'0')*10 +</span>
<span class="lineNum">    1240 </span><span class="lineCov">         10 :                                                           (rest[1]-'0'));</span>
<span class="lineNum">    1241 </span>            :                                 else
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :                                   tmp_hour = (rest[0]-'0');</span>
<span class="lineNum">    1243 </span>            : 
<span class="lineNum">    1244 </span>            :                                 /* move over the colon, and parse minutes */
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span><span class="lineCov">         10 :                                 rest = ++end;</span>
<span class="lineNum">    1247 </span><span class="lineCov">         40 :                                 while (*end &gt;= '0' &amp;&amp; *end &lt;= '9')</span>
<span class="lineNum">    1248 </span><span class="lineCov">         20 :                                   end++;</span>
<span class="lineNum">    1249 </span>            : 
<span class="lineNum">    1250 </span><span class="lineCov">         10 :                                 if (end == rest)</span>
<span class="lineNum">    1251 </span>            :                                   /* no digits after first colon? */
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :                                   break;</span>
<span class="lineNum">    1253 </span><span class="lineCov">         10 :                                 if ((end - rest) &gt; 2)</span>
<span class="lineNum">    1254 </span>            :                                   /* it is [0-9][0-9][0-9]+: */
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :                                   break;</span>
<span class="lineNum">    1256 </span><span class="lineCov">         10 :                                 if ((end - rest) == 2)</span>
<span class="lineNum">    1257 </span><span class="lineCov">         20 :                                   tmp_min = ((rest[0]-'0')*10 +</span>
<span class="lineNum">    1258 </span><span class="lineCov">         10 :                                              (rest[1]-'0'));</span>
<span class="lineNum">    1259 </span>            :                                 else
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :                                   tmp_min = (rest[0]-'0');</span>
<span class="lineNum">    1261 </span>            : 
<span class="lineNum">    1262 </span>            :                                 /* now go for seconds */
<span class="lineNum">    1263 </span><span class="lineCov">         10 :                                 rest = end;</span>
<span class="lineNum">    1264 </span><span class="lineCov">         10 :                                 if (*rest == ':')</span>
<span class="lineNum">    1265 </span><span class="lineCov">         10 :                                   rest++;</span>
<span class="lineNum">    1266 </span><span class="lineCov">         10 :                                 end = rest;</span>
<span class="lineNum">    1267 </span><span class="lineCov">         40 :                                 while (*end &gt;= '0' &amp;&amp; *end &lt;= '9')</span>
<span class="lineNum">    1268 </span><span class="lineCov">         20 :                                   end++;</span>
<span class="lineNum">    1269 </span>            : 
<span class="lineNum">    1270 </span><span class="lineCov">         10 :                                 if (end == rest)</span>
<span class="lineNum">    1271 </span>            :                                   /* no digits after second colon - that's ok. */
<span class="lineNum">    1272 </span>            :                                   ;
<span class="lineNum">    1273 </span><span class="lineCov">         10 :                                 else if ((end - rest) &gt; 2)</span>
<span class="lineNum">    1274 </span>            :                                   /* it is [0-9][0-9][0-9]+: */
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :                                   break;</span>
<span class="lineNum">    1276 </span><span class="lineCov">         10 :                                 if ((end - rest) == 2)</span>
<span class="lineNum">    1277 </span><span class="lineCov">         20 :                                   tmp_sec = ((rest[0]-'0')*10 +</span>
<span class="lineNum">    1278 </span><span class="lineCov">         10 :                                                          (rest[1]-'0'));</span>
<span class="lineNum">    1279 </span>            :                                 else
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :                                   tmp_sec = (rest[0]-'0');</span>
<span class="lineNum">    1281 </span>            : 
<span class="lineNum">    1282 </span>            :                                 /* If we made it here, we've parsed hour and min,
<span class="lineNum">    1283 </span>            :                                    and possibly sec, so it worked as a unit. */
<span class="lineNum">    1284 </span>            : 
<span class="lineNum">    1285 </span>            :                                 /* skip over whitespace and see if there's an AM or PM
<span class="lineNum">    1286 </span>            :                                    directly following the time.
<span class="lineNum">    1287 </span>            :                                  */
<span class="lineNum">    1288 </span><span class="lineCov">         10 :                                 if (tmp_hour &lt;= 12)</span>
<span class="lineNum">    1289 </span>            :                                   {
<span class="lineNum">    1290 </span><span class="lineCov">          2 :                                         const char *s = end;</span>
<span class="lineNum">    1291 </span><span class="lineCov">          6 :                                         while (*s &amp;&amp; (*s == ' ' || *s == '\t'))</span>
<span class="lineNum">    1292 </span><span class="lineCov">          2 :                                           s++;</span>
<span class="lineNum">    1293 </span><span class="lineCov">          2 :                                         if ((s[0] == 'p' || s[0] == 'P') &amp;&amp;</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :                                                 (s[1] == 'm' || s[1] == 'M'))</span>
<span class="lineNum">    1295 </span>            :                                           /* 10:05pm == 22:05, and 12:05pm == 12:05 */
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :                                           tmp_hour = (tmp_hour == 12 ? 12 : tmp_hour + 12);</span>
<span class="lineNum">    1297 </span><span class="lineCov">          2 :                                         else if (tmp_hour == 12 &amp;&amp;</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :                                                          (s[0] == 'a' || s[0] == 'A') &amp;&amp;</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :                                                          (s[1] == 'm' || s[1] == 'M'))</span>
<span class="lineNum">    1300 </span>            :                                           /* 12:05am == 00:05 */
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :                                           tmp_hour = 0;</span>
<span class="lineNum">    1302 </span>            :                                   }
<span class="lineNum">    1303 </span>            : 
<span class="lineNum">    1304 </span><span class="lineCov">         10 :                                 hour = tmp_hour;</span>
<span class="lineNum">    1305 </span><span class="lineCov">         10 :                                 min = tmp_min;</span>
<span class="lineNum">    1306 </span><span class="lineCov">         10 :                                 sec = tmp_sec;</span>
<span class="lineNum">    1307 </span><span class="lineCov">         10 :                                 rest = end;</span>
<span class="lineNum">    1308 </span><span class="lineCov">         10 :                                 break;</span>
<span class="lineNum">    1309 </span>            :                           }
<span class="lineNum">    1310 </span><span class="lineCov">         20 :                         if ((*end == '/' || *end == '-') &amp;&amp;</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :                                          end[1] &gt;= '0' &amp;&amp; end[1] &lt;= '9')</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :                           {</span>
<span class="lineNum">    1313 </span>            :                                 /* Perhaps this is 6/16/95, 16/6/95, 6-16-95, or 16-6-95
<span class="lineNum">    1314 </span>            :                                    or even 95-06-05...
<span class="lineNum">    1315 </span>            :                                    #### But it doesn't handle 1995-06-22.
<span class="lineNum">    1316 </span>            :                                  */
<span class="lineNum">    1317 </span>            :                                 int n1, n2, n3;
<span class="lineNum">    1318 </span>            :                                 const char *s;
<span class="lineNum">    1319 </span>            : 
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :                                 if (month != TT_UNKNOWN)</span>
<span class="lineNum">    1321 </span>            :                                   /* if we saw a month name, this can't be. */
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :                                   break;</span>
<span class="lineNum">    1323 </span>            : 
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :                                 s = rest;</span>
<span class="lineNum">    1325 </span>            : 
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :                                 n1 = (*s++ - '0');                                /* first 1 or 2 digits */</span>
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :                                 if (*s &gt;= '0' &amp;&amp; *s &lt;= '9')</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :                                   n1 = n1*10 + (*s++ - '0');</span>
<span class="lineNum">    1329 </span>            : 
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :                                 if (*s != '/' &amp;&amp; *s != '-')                /* slash */</span>
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :                                   break;</span>
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :                                 s++;</span>
<span class="lineNum">    1333 </span>            : 
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :                                 if (*s &lt; '0' || *s &gt; '9')                /* second 1 or 2 digits */</span>
<span class="lineNum">    1335 </span>            :                                   break;
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :                                 n2 = (*s++ - '0');</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :                                 if (*s &gt;= '0' &amp;&amp; *s &lt;= '9')</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :                                   n2 = n2*10 + (*s++ - '0');</span>
<span class="lineNum">    1339 </span>            : 
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :                                 if (*s != '/' &amp;&amp; *s != '-')                /* slash */</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :                                   break;</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :                                 s++;</span>
<span class="lineNum">    1343 </span>            : 
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :                                 if (*s &lt; '0' || *s &gt; '9')                /* third 1, 2, 4, or 5 digits */</span>
<span class="lineNum">    1345 </span>            :                                   break;
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :                                 n3 = (*s++ - '0');</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :                                 if (*s &gt;= '0' &amp;&amp; *s &lt;= '9')</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :                                   n3 = n3*10 + (*s++ - '0');</span>
<span class="lineNum">    1349 </span>            : 
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :                                 if (*s &gt;= '0' &amp;&amp; *s &lt;= '9')            /* optional digits 3, 4, and 5 */</span>
<span class="lineNum">    1351 </span>            :                                   {
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :                                         n3 = n3*10 + (*s++ - '0');</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :                                         if (*s &lt; '0' || *s &gt; '9')</span>
<span class="lineNum">    1354 </span>            :                                           break;
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                                         n3 = n3*10 + (*s++ - '0');</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :                                         if (*s &gt;= '0' &amp;&amp; *s &lt;= '9')</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :                                           n3 = n3*10 + (*s++ - '0');</span>
<span class="lineNum">    1358 </span>            :                                   }
<span class="lineNum">    1359 </span>            : 
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :                                 if ((*s &gt;= '0' &amp;&amp; *s &lt;= '9') ||        /* followed by non-alphanum */</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :                                         (*s &gt;= 'A' &amp;&amp; *s &lt;= 'Z') ||</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :                                         (*s &gt;= 'a' &amp;&amp; *s &lt;= 'z'))</span>
<span class="lineNum">    1363 </span>            :                                   break;
<span class="lineNum">    1364 </span>            : 
<span class="lineNum">    1365 </span>            :                                 /* Ok, we parsed three 1-2 digit numbers, with / or -
<span class="lineNum">    1366 </span>            :                                    between them.  Now decide what the hell they are
<span class="lineNum">    1367 </span>            :                                    (DD/MM/YY or MM/DD/YY or YY/MM/DD.)
<span class="lineNum">    1368 </span>            :                                  */
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :                                 if (n1 &gt; 31 || n1 == 0)  /* must be YY/MM/DD */</span>
<span class="lineNum">    1371 </span>            :                                   {
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :                                         if (n2 &gt; 12) break;</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :                                         if (n3 &gt; 31) break;</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :                                         year = n1;</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :                                         if (year &lt; 70)</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :                                             year += 2000;</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :                                         else if (year &lt; 100)</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :                                             year += 1900;</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :                                         month = (TIME_TOKEN)(n2 + ((int)TT_JAN) - 1);</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :                                         date = n3;</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :                                         rest = s;</span>
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1383 </span>            :                                   }
<span class="lineNum">    1384 </span>            : 
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :                                 if (n1 &gt; 12 &amp;&amp; n2 &gt; 12)  /* illegal */</span>
<span class="lineNum">    1386 </span>            :                                   {
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :                                         rest = s;</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    1389 </span>            :                                   }
<span class="lineNum">    1390 </span>            : 
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :                                 if (n3 &lt; 70)</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                                     n3 += 2000;</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :                                 else if (n3 &lt; 100)</span>
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :                                     n3 += 1900;</span>
<span class="lineNum">    1395 </span>            : 
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :                                 if (n1 &gt; 12)  /* must be DD/MM/YY */</span>
<span class="lineNum">    1397 </span>            :                                   {
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :                                         date = n1;</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :                                         month = (TIME_TOKEN)(n2 + ((int)TT_JAN) - 1);</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :                                         year = n3;</span>
<span class="lineNum">    1401 </span>            :                                   }
<span class="lineNum">    1402 </span>            :                                 else                  /* assume MM/DD/YY */
<span class="lineNum">    1403 </span>            :                                   {
<span class="lineNum">    1404 </span>            :                                         /* #### In the ambiguous case, should we consult the
<span class="lineNum">    1405 </span>            :                                            locale to find out the local default? */
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :                                         month = (TIME_TOKEN)(n1 + ((int)TT_JAN) - 1);</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :                                         date = n2;</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :                                         year = n3;</span>
<span class="lineNum">    1409 </span>            :                                   }
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :                                 rest = s;</span>
<span class="lineNum">    1411 </span>            :                           }
<span class="lineNum">    1412 </span><span class="lineCov">         40 :                         else if ((*end &gt;= 'A' &amp;&amp; *end &lt;= 'Z') ||</span>
<span class="lineNum">    1413 </span><span class="lineCov">         20 :                                          (*end &gt;= 'a' &amp;&amp; *end &lt;= 'z'))</span>
<span class="lineNum">    1414 </span>            :                           /* Digits followed by non-punctuation - what's that? */
<span class="lineNum">    1415 </span>            :                           ;
<span class="lineNum">    1416 </span><span class="lineCov">         20 :                         else if ((end - rest) == 5)                /* five digits is a year */</span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :                           year = (year &lt; 0</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :                                           ? ((rest[0]-'0')*10000L +</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :                                                  (rest[1]-'0')*1000L +</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :                                                  (rest[2]-'0')*100L +</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :                                                  (rest[3]-'0')*10L +</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :                                                  (rest[4]-'0'))</span>
<span class="lineNum">    1423 </span>            :                                           : year);
<span class="lineNum">    1424 </span><span class="lineCov">         20 :                         else if ((end - rest) == 4)                /* four digits is a year */</span>
<span class="lineNum">    1425 </span><span class="lineCov">         20 :                           year = (year &lt; 0</span>
<span class="lineNum">    1426 </span><span class="lineCov">         20 :                                           ? ((rest[0]-'0')*1000L +</span>
<span class="lineNum">    1427 </span><span class="lineCov">         20 :                                                  (rest[1]-'0')*100L +</span>
<span class="lineNum">    1428 </span><span class="lineCov">         20 :                                                  (rest[2]-'0')*10L +</span>
<span class="lineNum">    1429 </span><span class="lineCov">         10 :                                                  (rest[3]-'0'))</span>
<span class="lineNum">    1430 </span>            :                                           : year);
<span class="lineNum">    1431 </span><span class="lineCov">         10 :                         else if ((end - rest) == 2)                /* two digits - date or year */</span>
<span class="lineNum">    1432 </span>            :                           {
<span class="lineNum">    1433 </span><span class="lineCov">         20 :                                 int n = ((rest[0]-'0')*10 +</span>
<span class="lineNum">    1434 </span><span class="lineCov">         10 :                                                  (rest[1]-'0'));</span>
<span class="lineNum">    1435 </span>            :                                 /* If we don't have a date (day of the month) and we see a number
<span class="lineNum">    1436 </span>            :                                      less than 32, then assume that is the date.
<span class="lineNum">    1437 </span>            : 
<span class="lineNum">    1438 </span>            :                                          Otherwise, if we have a date and not a year, assume this is the
<span class="lineNum">    1439 </span>            :                                          year.  If it is less than 70, then assume it refers to the 21st
<span class="lineNum">    1440 </span>            :                                          century.  If it is two digits (&gt;= 70), assume it refers to this
<span class="lineNum">    1441 </span>            :                                          century.  Otherwise, assume it refers to an unambiguous year.
<span class="lineNum">    1442 </span>            : 
<span class="lineNum">    1443 </span>            :                                          The world will surely end soon.
<span class="lineNum">    1444 </span>            :                                    */
<span class="lineNum">    1445 </span><span class="lineCov">         10 :                                 if (date &lt; 0 &amp;&amp; n &lt; 32)</span>
<span class="lineNum">    1446 </span><span class="lineCov">         10 :                                   date = n;</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :                                 else if (year &lt; 0)</span>
<span class="lineNum">    1448 </span>            :                                   {
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :                                         if (n &lt; 70)</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                                           year = 2000 + n;</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                                         else if (n &lt; 100)</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                                           year = 1900 + n;</span>
<span class="lineNum">    1453 </span>            :                                         else
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :                                           year = n;</span>
<span class="lineNum">    1455 </span>            :                                   }
<span class="lineNum">    1456 </span>            :                                 /* else what the hell is this. */
<span class="lineNum">    1457 </span>            :                           }
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :                         else if ((end - rest) == 1)                /* one digit - date */</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :                           date = (date &lt; 0 ? (rest[0]-'0') : date);</span>
<span class="lineNum">    1460 </span>            :                         /* else, three or more than five digits - what's that? */
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span><span class="lineCov">         20 :                         break;</span>
<span class="lineNum">    1463 </span>            :                   }
<span class="lineNum">    1464 </span>            :                 }
<span class="lineNum">    1465 </span>            : 
<span class="lineNum">    1466 </span>            :           /* Skip to the end of this token, whether we parsed it or not.
<span class="lineNum">    1467 </span>            :                  Tokens are delimited by whitespace, or ,;-/
<span class="lineNum">    1468 </span>            :                  But explicitly not :+-.
<span class="lineNum">    1469 </span>            :            */
<span class="lineNum">    1470 </span><span class="lineCov">        470 :           while (*rest &amp;&amp;</span>
<span class="lineNum">    1471 </span><span class="lineCov">        520 :                          *rest != ' ' &amp;&amp; *rest != '\t' &amp;&amp;</span>
<span class="lineNum">    1472 </span><span class="lineCov">        460 :                          *rest != ',' &amp;&amp; *rest != ';' &amp;&amp;</span>
<span class="lineNum">    1473 </span><span class="lineCov">        450 :                          *rest != '-' &amp;&amp; *rest != '+' &amp;&amp;</span>
<span class="lineNum">    1474 </span><span class="lineCov">        300 :                          *rest != '/' &amp;&amp;</span>
<span class="lineNum">    1475 </span><span class="lineCov">        300 :                          *rest != '(' &amp;&amp; *rest != ')' &amp;&amp; *rest != '[' &amp;&amp; *rest != ']')</span>
<span class="lineNum">    1476 </span><span class="lineCov">        150 :                 rest++;</span>
<span class="lineNum">    1477 </span>            :           /* skip over uninteresting chars. */
<span class="lineNum">    1478 </span>            :         SKIP_MORE:
<span class="lineNum">    1479 </span><span class="lineCov">        290 :           while (*rest &amp;&amp;</span>
<span class="lineNum">    1480 </span><span class="lineCov">        230 :                          (*rest == ' ' || *rest == '\t' ||</span>
<span class="lineNum">    1481 </span><span class="lineCov">        160 :                           *rest == ',' || *rest == ';' || *rest == '/' ||</span>
<span class="lineNum">    1482 </span><span class="lineCov">        100 :                           *rest == '(' || *rest == ')' || *rest == '[' || *rest == ']'))</span>
<span class="lineNum">    1483 </span><span class="lineCov">         60 :                 rest++;</span>
<span class="lineNum">    1484 </span>            : 
<span class="lineNum">    1485 </span>            :           /* &quot;-&quot; is ignored at the beginning of a token if we have not yet
<span class="lineNum">    1486 </span>            :                  parsed a year (e.g., the second &quot;-&quot; in &quot;30-AUG-1966&quot;), or if
<span class="lineNum">    1487 </span>            :                  the character after the dash is not a digit. */         
<span class="lineNum">    1488 </span><span class="lineCov">         60 :           if (*rest == '-' &amp;&amp; ((rest &gt; string &amp;&amp;</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :               isalpha((unsigned char)rest[-1]) &amp;&amp; year &lt; 0) ||</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :               rest[1] &lt; '0' || rest[1] &gt; '9'))</span>
<span class="lineNum">    1491 </span>            :                 {
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :                   rest++;</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :                   goto SKIP_MORE;</span>
<span class="lineNum">    1494 </span>            :                 }
<span class="lineNum">    1495 </span>            : 
<span class="lineNum">    1496 </span>            :         }
<span class="lineNum">    1497 </span>            : 
<span class="lineNum">    1498 </span><span class="lineCov">         10 :   if (zone != TT_UNKNOWN &amp;&amp; zone_offset == -1)</span>
<span class="lineNum">    1499 </span>            :         {
<span class="lineNum">    1500 </span><span class="lineCov">         10 :           switch (zone)</span>
<span class="lineNum">    1501 </span>            :                 {
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :                 case TT_PST: zone_offset = -8 * 60; break;</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :                 case TT_PDT: zone_offset = -8 * 60; dst_offset = 1 * 60; break;</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :                 case TT_MST: zone_offset = -7 * 60; break;</span>
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :                 case TT_MDT: zone_offset = -7 * 60; dst_offset = 1 * 60; break;</span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :                 case TT_CST: zone_offset = -6 * 60; break;</span>
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :                 case TT_CDT: zone_offset = -6 * 60; dst_offset = 1 * 60; break;</span>
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :                 case TT_EST: zone_offset = -5 * 60; break;</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :                 case TT_EDT: zone_offset = -5 * 60; dst_offset = 1 * 60; break;</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :                 case TT_AST: zone_offset = -4 * 60; break;</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :                 case TT_NST: zone_offset = -3 * 60 - 30; break;</span>
<span class="lineNum">    1512 </span><span class="lineCov">         10 :                 case TT_GMT: zone_offset =  0 * 60; break;</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :                 case TT_BST: zone_offset =  0 * 60; dst_offset = 1 * 60; break;</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :                 case TT_MET: zone_offset =  1 * 60; break;</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :                 case TT_EET: zone_offset =  2 * 60; break;</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :                 case TT_JST: zone_offset =  9 * 60; break;</span>
<span class="lineNum">    1517 </span>            :                 default:
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :                   PR_ASSERT (0);</span>
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    1520 </span>            :                 }
<span class="lineNum">    1521 </span>            :         }
<span class="lineNum">    1522 </span>            : 
<span class="lineNum">    1523 </span>            :   /* If we didn't find a year, month, or day-of-the-month, we can't
<span class="lineNum">    1524 </span>            :          possibly parse this, and in fact, mktime() will do something random
<span class="lineNum">    1525 </span>            :          (I'm seeing it return &quot;Tue Feb  5 06:28:16 2036&quot;, which is no doubt
<span class="lineNum">    1526 </span>            :          a numerologically significant date... */
<span class="lineNum">    1527 </span><span class="lineCov">         10 :   if (month == TT_UNKNOWN || date == -1 || year == -1 || year &gt; PR_INT16_MAX)</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :       return PR_FAILURE;</span>
<span class="lineNum">    1529 </span>            : 
<span class="lineNum">    1530 </span><span class="lineCov">         10 :   memset(result, 0, sizeof(*result));</span>
<span class="lineNum">    1531 </span><span class="lineCov">         10 :   if (sec != -1)</span>
<span class="lineNum">    1532 </span><span class="lineCov">         10 :         result-&gt;tm_sec = sec;</span>
<span class="lineNum">    1533 </span><span class="lineCov">         10 :   if (min != -1)</span>
<span class="lineNum">    1534 </span><span class="lineCov">         10 :         result-&gt;tm_min = min;</span>
<span class="lineNum">    1535 </span><span class="lineCov">         10 :   if (hour != -1)</span>
<span class="lineNum">    1536 </span><span class="lineCov">         10 :         result-&gt;tm_hour = hour;</span>
<span class="lineNum">    1537 </span><span class="lineCov">         10 :   if (date != -1)</span>
<span class="lineNum">    1538 </span><span class="lineCov">         10 :         result-&gt;tm_mday = date;</span>
<span class="lineNum">    1539 </span><span class="lineCov">         10 :   if (month != TT_UNKNOWN)</span>
<span class="lineNum">    1540 </span><span class="lineCov">         10 :         result-&gt;tm_month = (((int)month) - ((int)TT_JAN));</span>
<span class="lineNum">    1541 </span><span class="lineCov">         10 :   if (year != -1)</span>
<span class="lineNum">    1542 </span><span class="lineCov">         10 :         result-&gt;tm_year = year;</span>
<span class="lineNum">    1543 </span><span class="lineCov">         10 :   if (dotw != TT_UNKNOWN)</span>
<span class="lineNum">    1544 </span><span class="lineCov">         10 :         result-&gt;tm_wday = (((int)dotw) - ((int)TT_SUN));</span>
<span class="lineNum">    1545 </span>            :   /*
<span class="lineNum">    1546 </span>            :    * Mainly to compute wday and yday, but normalized time is also required
<span class="lineNum">    1547 </span>            :    * by the check below that works around a Visual C++ 2005 mktime problem.
<span class="lineNum">    1548 </span>            :    */
<span class="lineNum">    1549 </span><span class="lineCov">         10 :   PR_NormalizeTime(result, PR_GMTParameters);</span>
<span class="lineNum">    1550 </span>            :   /* The remaining work is to set the gmt and dst offsets in tm_params. */
<span class="lineNum">    1551 </span>            : 
<span class="lineNum">    1552 </span><span class="lineCov">         10 :   if (zone == TT_UNKNOWN &amp;&amp; default_to_gmt)</span>
<span class="lineNum">    1553 </span>            :         {
<span class="lineNum">    1554 </span>            :           /* No zone was specified, so pretend the zone was GMT. */
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :           zone = TT_GMT;</span>
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :           zone_offset = 0;</span>
<span class="lineNum">    1557 </span>            :         }
<span class="lineNum">    1558 </span>            : 
<span class="lineNum">    1559 </span><span class="lineCov">         10 :   if (zone_offset == -1)</span>
<span class="lineNum">    1560 </span>            :          {
<span class="lineNum">    1561 </span>            :            /* no zone was specified, and we're to assume that everything
<span class="lineNum">    1562 </span>            :              is local. */
<span class="lineNum">    1563 </span>            :           struct tm localTime;
<span class="lineNum">    1564 </span>            :           time_t secs;
<span class="lineNum">    1565 </span>            : 
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :           PR_ASSERT(result-&gt;tm_month &gt; -1 &amp;&amp;</span>
<span class="lineNum">    1567 </span>            :                     result-&gt;tm_mday &gt; 0 &amp;&amp;
<span class="lineNum">    1568 </span>            :                     result-&gt;tm_hour &gt; -1 &amp;&amp;
<span class="lineNum">    1569 </span>            :                     result-&gt;tm_min &gt; -1 &amp;&amp;
<span class="lineNum">    1570 </span>            :                     result-&gt;tm_sec &gt; -1);
<span class="lineNum">    1571 </span>            : 
<span class="lineNum">    1572 </span>            :             /*
<span class="lineNum">    1573 </span>            :              * To obtain time_t from a tm structure representing the local
<span class="lineNum">    1574 </span>            :              * time, we call mktime().  However, we need to see if we are
<span class="lineNum">    1575 </span>            :              * on 1-Jan-1970 or before.  If we are, we can't call mktime()
<span class="lineNum">    1576 </span>            :              * because mktime() will crash on win16. In that case, we
<span class="lineNum">    1577 </span>            :              * calculate zone_offset based on the zone offset at 
<span class="lineNum">    1578 </span>            :              * 00:00:00, 2 Jan 1970 GMT, and subtract zone_offset from the
<span class="lineNum">    1579 </span>            :              * date we are parsing to transform the date to GMT.  We also
<span class="lineNum">    1580 </span>            :              * do so if mktime() returns (time_t) -1 (time out of range).
<span class="lineNum">    1581 </span>            :            */
<span class="lineNum">    1582 </span>            : 
<span class="lineNum">    1583 </span>            :           /* month, day, hours, mins and secs are always non-negative
<span class="lineNum">    1584 </span>            :              so we dont need to worry about them. */  
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :           if(result-&gt;tm_year &gt;= 1970)</span>
<span class="lineNum">    1586 </span>            :                 {
<span class="lineNum">    1587 </span>            :                   PRInt64 usec_per_sec;
<span class="lineNum">    1588 </span>            : 
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :                   localTime.tm_sec = result-&gt;tm_sec;</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :                   localTime.tm_min = result-&gt;tm_min;</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :                   localTime.tm_hour = result-&gt;tm_hour;</span>
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :                   localTime.tm_mday = result-&gt;tm_mday;</span>
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :                   localTime.tm_mon = result-&gt;tm_month;</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :                   localTime.tm_year = result-&gt;tm_year - 1900;</span>
<span class="lineNum">    1595 </span>            :                   /* Set this to -1 to tell mktime &quot;I don't care&quot;.  If you set
<span class="lineNum">    1596 </span>            :                      it to 0 or 1, you are making assertions about whether the
<span class="lineNum">    1597 </span>            :                      date you are handing it is in daylight savings mode or not;
<span class="lineNum">    1598 </span>            :                      and if you're wrong, it will &quot;fix&quot; it for you. */
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :                   localTime.tm_isdst = -1;</span>
<span class="lineNum">    1600 </span>            : 
<span class="lineNum">    1601 </span>            : #if _MSC_VER == 1400  /* 1400 = Visual C++ 2005 (8.0) */
<span class="lineNum">    1602 </span>            :                   /*
<span class="lineNum">    1603 </span>            :                    * mktime will return (time_t) -1 if the input is a date
<span class="lineNum">    1604 </span>            :                    * after 23:59:59, December 31, 3000, US Pacific Time (not
<span class="lineNum">    1605 </span>            :                    * UTC as documented): 
<span class="lineNum">    1606 </span>            :                    * http://msdn.microsoft.com/en-us/library/d1y53h2a(VS.80).aspx
<span class="lineNum">    1607 </span>            :                    * But if the year is 3001, mktime also invokes the invalid
<span class="lineNum">    1608 </span>            :                    * parameter handler, causing the application to crash.  This
<span class="lineNum">    1609 </span>            :                    * problem has been reported in
<span class="lineNum">    1610 </span>            :                    * http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=266036.
<span class="lineNum">    1611 </span>            :                    * We avoid this crash by not calling mktime if the date is
<span class="lineNum">    1612 </span>            :                    * out of range.  To use a simple test that works in any time
<span class="lineNum">    1613 </span>            :                    * zone, we consider year 3000 out of range as well.  (See
<span class="lineNum">    1614 </span>            :                    * bug 480740.)
<span class="lineNum">    1615 </span>            :                    */
<span class="lineNum">    1616 </span>            :                   if (result-&gt;tm_year &gt;= 3000) {
<span class="lineNum">    1617 </span>            :                       /* Emulate what mktime would have done. */
<span class="lineNum">    1618 </span>            :                       errno = EINVAL;
<span class="lineNum">    1619 </span>            :                       secs = (time_t) -1;
<span class="lineNum">    1620 </span>            :                   } else {
<span class="lineNum">    1621 </span>            :                       secs = mktime(&amp;localTime);
<span class="lineNum">    1622 </span>            :                   }
<span class="lineNum">    1623 </span>            : #else
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :                   secs = mktime(&amp;localTime);</span>
<span class="lineNum">    1625 </span>            : #endif
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :                   if (secs != (time_t) -1)</span>
<span class="lineNum">    1627 </span>            :                     {
<span class="lineNum">    1628 </span>            :                       PRTime usecs64;
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :                       LL_I2L(usecs64, secs);</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :                       LL_I2L(usec_per_sec, PR_USEC_PER_SEC);</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :                       LL_MUL(usecs64, usecs64, usec_per_sec);</span>
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :                       PR_ExplodeTime(usecs64, PR_LocalTimeParameters, result);</span>
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :                       return PR_SUCCESS;</span>
<span class="lineNum">    1634 </span>            :                     }
<span class="lineNum">    1635 </span>            :                 }
<span class="lineNum">    1636 </span>            :                 
<span class="lineNum">    1637 </span>            :                 /* So mktime() can't handle this case.  We assume the
<span class="lineNum">    1638 </span>            :                    zone_offset for the date we are parsing is the same as
<span class="lineNum">    1639 </span>            :                    the zone offset on 00:00:00 2 Jan 1970 GMT. */
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :                 secs = 86400;</span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :                 localTimeResult = MT_safe_localtime(&amp;secs, &amp;localTime);</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :                 PR_ASSERT(localTimeResult != NULL);</span>
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :                 if (localTimeResult == NULL) {</span>
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :                     return PR_FAILURE;</span>
<span class="lineNum">    1645 </span>            :                 }
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :                 zone_offset = localTime.tm_min</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :                               + 60 * localTime.tm_hour</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :                               + 1440 * (localTime.tm_mday - 2);</span>
<span class="lineNum">    1649 </span>            :         }
<span class="lineNum">    1650 </span>            : 
<span class="lineNum">    1651 </span><span class="lineCov">         10 :   result-&gt;tm_params.tp_gmt_offset = zone_offset * 60;</span>
<span class="lineNum">    1652 </span><span class="lineCov">         10 :   result-&gt;tm_params.tp_dst_offset = dst_offset * 60;</span>
<span class="lineNum">    1653 </span>            : 
<span class="lineNum">    1654 </span><span class="lineCov">         10 :   return PR_SUCCESS;</span>
<span class="lineNum">    1655 </span>            : }
<span class="lineNum">    1656 </span>            : 
<span class="lineNum">    1657 </span>            : PR_IMPLEMENT(PRStatus)
<span class="lineNum">    1658 </span>            : PR_ParseTimeString(
<span class="lineNum">    1659 </span>            :         const char *string,
<span class="lineNum">    1660 </span>            :         PRBool default_to_gmt,
<span class="lineNum">    1661 </span>            :         PRTime *result)
<span class="lineNum">    1662 </span>            : {
<span class="lineNum">    1663 </span>            :   PRExplodedTime tm;
<span class="lineNum">    1664 </span>            :   PRStatus rv;
<span class="lineNum">    1665 </span>            : 
<span class="lineNum">    1666 </span><span class="lineCov">         10 :   rv = PR_ParseTimeStringToExplodedTime(string,</span>
<span class="lineNum">    1667 </span>            :                                         default_to_gmt,
<span class="lineNum">    1668 </span>            :                                         &amp;tm);
<span class="lineNum">    1669 </span><span class="lineCov">         10 :   if (rv != PR_SUCCESS)</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :         return rv;</span>
<span class="lineNum">    1671 </span>            : 
<span class="lineNum">    1672 </span><span class="lineCov">         10 :   *result = PR_ImplodeTime(&amp;tm);</span>
<span class="lineNum">    1673 </span>            : 
<span class="lineNum">    1674 </span><span class="lineCov">         10 :   return PR_SUCCESS;</span>
<span class="lineNum">    1675 </span>            : }
<span class="lineNum">    1676 </span>            : 
<span class="lineNum">    1677 </span>            : /*
<span class="lineNum">    1678 </span>            :  *******************************************************************
<span class="lineNum">    1679 </span>            :  *******************************************************************
<span class="lineNum">    1680 </span>            :  **
<span class="lineNum">    1681 </span>            :  **    OLD COMPATIBILITY FUNCTIONS
<span class="lineNum">    1682 </span>            :  **
<span class="lineNum">    1683 </span>            :  *******************************************************************
<span class="lineNum">    1684 </span>            :  *******************************************************************
<span class="lineNum">    1685 </span>            :  */
<span class="lineNum">    1686 </span>            : 
<span class="lineNum">    1687 </span>            : 
<span class="lineNum">    1688 </span>            : /*
<span class="lineNum">    1689 </span>            :  *-----------------------------------------------------------------------
<span class="lineNum">    1690 </span>            :  *
<span class="lineNum">    1691 </span>            :  * PR_FormatTime --
<span class="lineNum">    1692 </span>            :  *
<span class="lineNum">    1693 </span>            :  *     Format a time value into a buffer. Same semantics as strftime().
<span class="lineNum">    1694 </span>            :  *
<span class="lineNum">    1695 </span>            :  *-----------------------------------------------------------------------
<span class="lineNum">    1696 </span>            :  */
<span class="lineNum">    1697 </span>            : 
<span class="lineNum">    1698 </span>            : PR_IMPLEMENT(PRUint32)
<span class="lineNum">    1699 </span>            : PR_FormatTime(char *buf, int buflen, const char *fmt,
<span class="lineNum">    1700 </span>            :               const PRExplodedTime *time)
<span class="lineNum">    1701 </span>            : {
<span class="lineNum">    1702 </span>            :     size_t rv;
<span class="lineNum">    1703 </span>            :     struct tm a;
<span class="lineNum">    1704 </span>            :     struct tm *ap;
<span class="lineNum">    1705 </span>            : 
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :     if (time) {</span>
<span class="lineNum">    1707 </span><span class="lineNoCov">          0 :         ap = &amp;a;</span>
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :         a.tm_sec = time-&gt;tm_sec;</span>
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :         a.tm_min = time-&gt;tm_min;</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :         a.tm_hour = time-&gt;tm_hour;</span>
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :         a.tm_mday = time-&gt;tm_mday;</span>
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :         a.tm_mon = time-&gt;tm_month;</span>
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :         a.tm_wday = time-&gt;tm_wday;</span>
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :         a.tm_year = time-&gt;tm_year - 1900;</span>
<span class="lineNum">    1715 </span><span class="lineNoCov">          0 :         a.tm_yday = time-&gt;tm_yday;</span>
<span class="lineNum">    1716 </span><span class="lineNoCov">          0 :         a.tm_isdst = time-&gt;tm_params.tp_dst_offset ? 1 : 0;</span>
<span class="lineNum">    1717 </span>            : 
<span class="lineNum">    1718 </span>            :         /*
<span class="lineNum">    1719 </span>            :          * On some platforms, for example SunOS 4, struct tm has two
<span class="lineNum">    1720 </span>            :          * additional fields: tm_zone and tm_gmtoff.
<span class="lineNum">    1721 </span>            :          */
<span class="lineNum">    1722 </span>            : 
<span class="lineNum">    1723 </span>            : #if (__GLIBC__ &gt;= 2) || defined(XP_BEOS) \
<span class="lineNum">    1724 </span>            :         || defined(NETBSD) || defined(OPENBSD) || defined(FREEBSD) \
<span class="lineNum">    1725 </span>            :         || defined(DARWIN) || defined(SYMBIAN) || defined(ANDROID)
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :         a.tm_zone = NULL;</span>
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 :         a.tm_gmtoff = time-&gt;tm_params.tp_gmt_offset +</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :                       time-&gt;tm_params.tp_dst_offset;</span>
<span class="lineNum">    1729 </span>            : #endif
<span class="lineNum">    1730 </span>            :     } else {
<span class="lineNum">    1731 </span><span class="lineNoCov">          0 :         ap = NULL;</span>
<span class="lineNum">    1732 </span>            :     }
<span class="lineNum">    1733 </span>            : 
<span class="lineNum">    1734 </span><span class="lineNoCov">          0 :     rv = strftime(buf, buflen, fmt, ap);</span>
<span class="lineNum">    1735 </span><span class="lineNoCov">          0 :     if (!rv &amp;&amp; buf &amp;&amp; buflen &gt; 0) {</span>
<span class="lineNum">    1736 </span>            :         /*
<span class="lineNum">    1737 </span>            :          * When strftime fails, the contents of buf are indeterminate.
<span class="lineNum">    1738 </span>            :          * Some callers don't check the return value from this function,
<span class="lineNum">    1739 </span>            :          * so store an empty string in buf in case they try to print it.
<span class="lineNum">    1740 </span>            :          */
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :         buf[0] = '\0';</span>
<span class="lineNum">    1742 </span>            :     }
<span class="lineNum">    1743 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">    1744 </span>            : }
<span class="lineNum">    1745 </span>            : 
<span class="lineNum">    1746 </span>            : 
<span class="lineNum">    1747 </span>            : /*
<span class="lineNum">    1748 </span>            :  * The following string arrays and macros are used by PR_FormatTimeUSEnglish().
<span class="lineNum">    1749 </span>            :  */
<span class="lineNum">    1750 </span>            : 
<span class="lineNum">    1751 </span>            : static const char* abbrevDays[] =
<span class="lineNum">    1752 </span>            : {
<span class="lineNum">    1753 </span>            :    &quot;Sun&quot;,&quot;Mon&quot;,&quot;Tue&quot;,&quot;Wed&quot;,&quot;Thu&quot;,&quot;Fri&quot;,&quot;Sat&quot;
<span class="lineNum">    1754 </span>            : };
<span class="lineNum">    1755 </span>            : 
<span class="lineNum">    1756 </span>            : static const char* days[] =
<span class="lineNum">    1757 </span>            : {
<span class="lineNum">    1758 </span>            :    &quot;Sunday&quot;,&quot;Monday&quot;,&quot;Tuesday&quot;,&quot;Wednesday&quot;,&quot;Thursday&quot;,&quot;Friday&quot;,&quot;Saturday&quot;
<span class="lineNum">    1759 </span>            : };
<span class="lineNum">    1760 </span>            : 
<span class="lineNum">    1761 </span>            : static const char* abbrevMonths[] =
<span class="lineNum">    1762 </span>            : {
<span class="lineNum">    1763 </span>            :    &quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;,
<span class="lineNum">    1764 </span>            :    &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;
<span class="lineNum">    1765 </span>            : };
<span class="lineNum">    1766 </span>            : 
<span class="lineNum">    1767 </span>            : static const char* months[] =
<span class="lineNum">    1768 </span>            : { 
<span class="lineNum">    1769 </span>            :     &quot;January&quot;, &quot;February&quot;, &quot;March&quot;, &quot;April&quot;, &quot;May&quot;, &quot;June&quot;,
<span class="lineNum">    1770 </span>            :     &quot;July&quot;, &quot;August&quot;, &quot;September&quot;, &quot;October&quot;, &quot;November&quot;, &quot;December&quot;
<span class="lineNum">    1771 </span>            : };
<span class="lineNum">    1772 </span>            : 
<span class="lineNum">    1773 </span>            : 
<span class="lineNum">    1774 </span>            : /*
<span class="lineNum">    1775 </span>            :  * Add a single character to the given buffer, incrementing the buffer pointer
<span class="lineNum">    1776 </span>            :  * and decrementing the buffer size. Return 0 on error.
<span class="lineNum">    1777 </span>            :  */
<span class="lineNum">    1778 </span>            : #define ADDCHAR( buf, bufSize, ch )             \
<span class="lineNum">    1779 </span>            : do                                              \
<span class="lineNum">    1780 </span>            : {                                               \
<span class="lineNum">    1781 </span>            :    if( bufSize &lt; 1 )                            \
<span class="lineNum">    1782 </span>            :    {                                            \
<span class="lineNum">    1783 </span>            :       *(--buf) = '\0';                          \
<span class="lineNum">    1784 </span>            :       return 0;                                 \
<span class="lineNum">    1785 </span>            :    }                                            \
<span class="lineNum">    1786 </span>            :    *buf++ = ch;                                 \
<span class="lineNum">    1787 </span>            :    bufSize--;                                   \
<span class="lineNum">    1788 </span>            : }                                               \
<span class="lineNum">    1789 </span>            : while(0)
<span class="lineNum">    1790 </span>            : 
<span class="lineNum">    1791 </span>            : 
<span class="lineNum">    1792 </span>            : /*
<span class="lineNum">    1793 </span>            :  * Add a string to the given buffer, incrementing the buffer pointer
<span class="lineNum">    1794 </span>            :  * and decrementing the buffer size appropriately.  Return 0 on error.
<span class="lineNum">    1795 </span>            :  */
<span class="lineNum">    1796 </span>            : #define ADDSTR( buf, bufSize, str )             \
<span class="lineNum">    1797 </span>            : do                                              \
<span class="lineNum">    1798 </span>            : {                                               \
<span class="lineNum">    1799 </span>            :    PRUint32 strSize = strlen( str );              \
<span class="lineNum">    1800 </span>            :    if( strSize &gt; bufSize )                      \
<span class="lineNum">    1801 </span>            :    {                                            \
<span class="lineNum">    1802 </span>            :       if( bufSize==0 )                          \
<span class="lineNum">    1803 </span>            :          *(--buf) = '\0';                       \
<span class="lineNum">    1804 </span>            :       else                                      \
<span class="lineNum">    1805 </span>            :          *buf = '\0';                           \
<span class="lineNum">    1806 </span>            :       return 0;                                 \
<span class="lineNum">    1807 </span>            :    }                                            \
<span class="lineNum">    1808 </span>            :    memcpy(buf, str, strSize);                   \
<span class="lineNum">    1809 </span>            :    buf += strSize;                              \
<span class="lineNum">    1810 </span>            :    bufSize -= strSize;                          \
<span class="lineNum">    1811 </span>            : }                                               \
<span class="lineNum">    1812 </span>            : while(0)
<span class="lineNum">    1813 </span>            : 
<span class="lineNum">    1814 </span>            : /* Needed by PR_FormatTimeUSEnglish() */
<span class="lineNum">    1815 </span>            : static unsigned int  pr_WeekOfYear(const PRExplodedTime* time,
<span class="lineNum">    1816 </span>            :         unsigned int firstDayOfWeek);
<span class="lineNum">    1817 </span>            : 
<span class="lineNum">    1818 </span>            : 
<span class="lineNum">    1819 </span>            : /***********************************************************************************
<span class="lineNum">    1820 </span>            :  *
<span class="lineNum">    1821 </span>            :  * Description:
<span class="lineNum">    1822 </span>            :  *  This is a dumbed down version of strftime that will format the date in US
<span class="lineNum">    1823 </span>            :  *  English regardless of the setting of the global locale.  This functionality is
<span class="lineNum">    1824 </span>            :  *  needed to write things like MIME headers which must always be in US English.
<span class="lineNum">    1825 </span>            :  *
<span class="lineNum">    1826 </span>            :  **********************************************************************************/
<span class="lineNum">    1827 </span>            :              
<span class="lineNum">    1828 </span>            : PR_IMPLEMENT(PRUint32)
<span class="lineNum">    1829 </span>            : PR_FormatTimeUSEnglish( char* buf, PRUint32 bufSize,
<span class="lineNum">    1830 </span>            :                         const char* format, const PRExplodedTime* time )
<span class="lineNum">    1831 </span>            : {
<span class="lineNum">    1832 </span><span class="lineNoCov">          0 :    char*         bufPtr = buf;</span>
<span class="lineNum">    1833 </span>            :    const char*   fmtPtr;
<span class="lineNum">    1834 </span>            :    char          tmpBuf[ 40 ];        
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :    const int     tmpBufSize = sizeof( tmpBuf );</span>
<span class="lineNum">    1836 </span>            : 
<span class="lineNum">    1837 </span>            :    
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :    for( fmtPtr=format; *fmtPtr != '\0'; fmtPtr++ )</span>
<span class="lineNum">    1839 </span>            :    {
<span class="lineNum">    1840 </span><span class="lineNoCov">          0 :       if( *fmtPtr != '%' )</span>
<span class="lineNum">    1841 </span>            :       {
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :          ADDCHAR( bufPtr, bufSize, *fmtPtr );</span>
<span class="lineNum">    1843 </span>            :       }
<span class="lineNum">    1844 </span>            :       else
<span class="lineNum">    1845 </span>            :       {
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :          switch( *(++fmtPtr) )</span>
<span class="lineNum">    1847 </span>            :          {
<span class="lineNum">    1848 </span>            :          case '%':
<span class="lineNum">    1849 </span>            :             /* escaped '%' character */
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :             ADDCHAR( bufPtr, bufSize, '%' );</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1852 </span>            :             
<span class="lineNum">    1853 </span>            :          case 'a':
<span class="lineNum">    1854 </span>            :             /* abbreviated weekday name */
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, abbrevDays[ time-&gt;tm_wday ] );</span>
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1857 </span>            :                
<span class="lineNum">    1858 </span>            :          case 'A':
<span class="lineNum">    1859 </span>            :             /* full weekday name */
<span class="lineNum">    1860 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, days[ time-&gt;tm_wday ] );</span>
<span class="lineNum">    1861 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1862 </span>            :         
<span class="lineNum">    1863 </span>            :          case 'b':
<span class="lineNum">    1864 </span>            :             /* abbreviated month name */
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, abbrevMonths[ time-&gt;tm_month ] );</span>
<span class="lineNum">    1866 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1867 </span>            :         
<span class="lineNum">    1868 </span>            :          case 'B':
<span class="lineNum">    1869 </span>            :             /* full month name */
<span class="lineNum">    1870 </span><span class="lineNoCov">          0 :             ADDSTR(bufPtr, bufSize,  months[ time-&gt;tm_month ] );</span>
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1872 </span>            :         
<span class="lineNum">    1873 </span>            :          case 'c':
<span class="lineNum">    1874 </span>            :             /* Date and time. */
<span class="lineNum">    1875 </span><span class="lineNoCov">          0 :             PR_FormatTimeUSEnglish( tmpBuf, tmpBufSize, &quot;%a %b %d %H:%M:%S %Y&quot;, time );</span>
<span class="lineNum">    1876 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf );</span>
<span class="lineNum">    1877 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1878 </span>            :         
<span class="lineNum">    1879 </span>            :          case 'd':
<span class="lineNum">    1880 </span>            :             /* day of month ( 01 - 31 ) */
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2ld&quot;,time-&gt;tm_mday );</span>
<span class="lineNum">    1882 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1883 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1884 </span>            : 
<span class="lineNum">    1885 </span>            :          case 'H':
<span class="lineNum">    1886 </span>            :             /* hour ( 00 - 23 ) */
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2ld&quot;,time-&gt;tm_hour );</span>
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1889 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1890 </span>            :         
<span class="lineNum">    1891 </span>            :          case 'I':
<span class="lineNum">    1892 </span>            :             /* hour ( 01 - 12 ) */
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2ld&quot;,</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :                         (time-&gt;tm_hour%12) ? time-&gt;tm_hour%12 : (PRInt32) 12 );</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1897 </span>            :         
<span class="lineNum">    1898 </span>            :          case 'j':
<span class="lineNum">    1899 </span>            :             /* day number of year ( 001 - 366 ) */
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.3d&quot;,time-&gt;tm_yday + 1);</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1903 </span>            :         
<span class="lineNum">    1904 </span>            :          case 'm':
<span class="lineNum">    1905 </span>            :             /* month number ( 01 - 12 ) */
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2ld&quot;,time-&gt;tm_month+1);</span>
<span class="lineNum">    1907 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1909 </span>            :         
<span class="lineNum">    1910 </span>            :          case 'M':
<span class="lineNum">    1911 </span>            :             /* minute ( 00 - 59 ) */
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2ld&quot;,time-&gt;tm_min );</span>
<span class="lineNum">    1913 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1915 </span>            :        
<span class="lineNum">    1916 </span>            :          case 'p':
<span class="lineNum">    1917 </span>            :             /* locale's equivalent of either AM or PM */
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, (time-&gt;tm_hour&lt;12)?&quot;AM&quot;:&quot;PM&quot; ); </span>
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1920 </span>            :         
<span class="lineNum">    1921 </span>            :          case 'S':
<span class="lineNum">    1922 </span>            :             /* seconds ( 00 - 61 ), allows for leap seconds */
<span class="lineNum">    1923 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2ld&quot;,time-&gt;tm_sec );</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1925 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1926 </span>            :      
<span class="lineNum">    1927 </span>            :          case 'U':
<span class="lineNum">    1928 </span>            :             /* week number of year ( 00 - 53  ),  Sunday  is  the first day of week 1 */
<span class="lineNum">    1929 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2d&quot;, pr_WeekOfYear( time, 0 ) );</span>
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf );</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1932 </span>            :         
<span class="lineNum">    1933 </span>            :          case 'w':
<span class="lineNum">    1934 </span>            :             /* weekday number ( 0 - 6 ), Sunday = 0 */
<span class="lineNum">    1935 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%d&quot;,time-&gt;tm_wday );</span>
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1937 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1938 </span>            :         
<span class="lineNum">    1939 </span>            :          case 'W':
<span class="lineNum">    1940 </span>            :             /* Week number of year ( 00 - 53  ),  Monday  is  the first day of week 1 */
<span class="lineNum">    1941 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2d&quot;, pr_WeekOfYear( time, 1 ) );</span>
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf );</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1944 </span>            :         
<span class="lineNum">    1945 </span>            :          case 'x':
<span class="lineNum">    1946 </span>            :             /* Date representation */
<span class="lineNum">    1947 </span><span class="lineNoCov">          0 :             PR_FormatTimeUSEnglish( tmpBuf, tmpBufSize, &quot;%m/%d/%y&quot;, time );</span>
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf );</span>
<span class="lineNum">    1949 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1950 </span>            :         
<span class="lineNum">    1951 </span>            :          case 'X':
<span class="lineNum">    1952 </span>            :             /* Time representation. */
<span class="lineNum">    1953 </span><span class="lineNoCov">          0 :             PR_FormatTimeUSEnglish( tmpBuf, tmpBufSize, &quot;%H:%M:%S&quot;, time );</span>
<span class="lineNum">    1954 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf );</span>
<span class="lineNum">    1955 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1956 </span>            :         
<span class="lineNum">    1957 </span>            :          case 'y':
<span class="lineNum">    1958 </span>            :             /* year within century ( 00 - 99 ) */
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.2d&quot;,time-&gt;tm_year % 100 );</span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1962 </span>            :         
<span class="lineNum">    1963 </span>            :          case 'Y':
<span class="lineNum">    1964 </span>            :             /* year as ccyy ( for example 1986 ) */
<span class="lineNum">    1965 </span><span class="lineNoCov">          0 :             PR_snprintf(tmpBuf,tmpBufSize,&quot;%.4d&quot;,time-&gt;tm_year );</span>
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1968 </span>            :         
<span class="lineNum">    1969 </span>            :          case 'Z':
<span class="lineNum">    1970 </span>            :             /* Time zone name or no characters if  no  time  zone exists.
<span class="lineNum">    1971 </span>            :              * Since time zone name is supposed to be independant of locale, we
<span class="lineNum">    1972 </span>            :              * defer to PR_FormatTime() for this option.
<span class="lineNum">    1973 </span>            :              */
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :             PR_FormatTime( tmpBuf, tmpBufSize, &quot;%Z&quot;, time );</span>
<span class="lineNum">    1975 </span><span class="lineNoCov">          0 :             ADDSTR( bufPtr, bufSize, tmpBuf ); </span>
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1977 </span>            : 
<span class="lineNum">    1978 </span>            :          default:
<span class="lineNum">    1979 </span>            :             /* Unknown format.  Simply copy format into output buffer. */
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :             ADDCHAR( bufPtr, bufSize, '%' );</span>
<span class="lineNum">    1981 </span><span class="lineNoCov">          0 :             ADDCHAR( bufPtr, bufSize, *fmtPtr );</span>
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1983 </span>            :             
<span class="lineNum">    1984 </span>            :          }
<span class="lineNum">    1985 </span>            :       }
<span class="lineNum">    1986 </span>            :    }
<span class="lineNum">    1987 </span>            : 
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :    ADDCHAR( bufPtr, bufSize, '\0' );</span>
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :    return (PRUint32)(bufPtr - buf - 1);</span>
<span class="lineNum">    1990 </span>            : }
<span class="lineNum">    1991 </span>            : 
<span class="lineNum">    1992 </span>            : 
<span class="lineNum">    1993 </span>            : 
<span class="lineNum">    1994 </span>            : /***********************************************************************************
<span class="lineNum">    1995 </span>            :  *
<span class="lineNum">    1996 </span>            :  * Description:
<span class="lineNum">    1997 </span>            :  *  Returns the week number of the year (0-53) for the given time.  firstDayOfWeek
<span class="lineNum">    1998 </span>            :  *  is the day on which the week is considered to start (0=Sun, 1=Mon, ...).
<span class="lineNum">    1999 </span>            :  *  Week 1 starts the first time firstDayOfWeek occurs in the year.  In other words,
<span class="lineNum">    2000 </span>            :  *  a partial week at the start of the year is considered week 0.  
<span class="lineNum">    2001 </span>            :  *
<span class="lineNum">    2002 </span>            :  **********************************************************************************/
<a name="2003"><span class="lineNum">    2003 </span>            : </a>
<span class="lineNum">    2004 </span>            : static unsigned int
<span class="lineNum">    2005 </span><span class="lineNoCov">          0 : pr_WeekOfYear(const PRExplodedTime* time, unsigned int firstDayOfWeek)</span>
<span class="lineNum">    2006 </span>            : {
<span class="lineNum">    2007 </span>            :    int dayOfWeek;
<span class="lineNum">    2008 </span>            :    int dayOfYear;
<span class="lineNum">    2009 </span>            : 
<span class="lineNum">    2010 </span>            :   /* Get the day of the year for the given time then adjust it to represent the
<span class="lineNum">    2011 </span>            :    * first day of the week containing the given time.
<span class="lineNum">    2012 </span>            :    */
<span class="lineNum">    2013 </span><span class="lineNoCov">          0 :   dayOfWeek = time-&gt;tm_wday - firstDayOfWeek;</span>
<span class="lineNum">    2014 </span><span class="lineNoCov">          0 :   if (dayOfWeek &lt; 0)</span>
<span class="lineNum">    2015 </span><span class="lineNoCov">          0 :     dayOfWeek += 7;</span>
<span class="lineNum">    2016 </span>            : 
<span class="lineNum">    2017 </span><span class="lineNoCov">          0 :   dayOfYear = time-&gt;tm_yday - dayOfWeek;</span>
<span class="lineNum">    2018 </span>            : 
<span class="lineNum">    2019 </span><span class="lineNoCov">          0 :   if( dayOfYear &lt;= 0 )</span>
<span class="lineNum">    2020 </span>            :   {
<span class="lineNum">    2021 </span>            :      /* If dayOfYear is &lt;= 0, it is in the first partial week of the year. */
<span class="lineNum">    2022 </span><span class="lineNoCov">          0 :      return 0;</span>
<span class="lineNum">    2023 </span>            :   }
<span class="lineNum">    2024 </span>            : 
<span class="lineNum">    2025 </span>            :   /* Count the number of full weeks ( dayOfYear / 7 ) then add a week if there
<span class="lineNum">    2026 </span>            :    * are any days left over ( dayOfYear % 7 ).  Because we are only counting to
<span class="lineNum">    2027 </span>            :    * the first day of the week containing the given time, rather than to the
<span class="lineNum">    2028 </span>            :    * actual day representing the given time, any days in week 0 will be &quot;absorbed&quot;
<span class="lineNum">    2029 </span>            :    * as extra days in the given week.
<span class="lineNum">    2030 </span>            :    */
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :   return (dayOfYear / 7) + ( (dayOfYear % 7) == 0 ? 0 : 1 );</span>
<span class="lineNum">    2032 </span>            : 
<span class="lineNum">    2033 </span>            : }
<span class="lineNum">    2034 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - third_party/aom/av1/encoder/tokenize.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">third_party/aom/av1/encoder</a> - tokenize.c<span style="font-size: 80%;"> (source / <a href="tokenize.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">246</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">10</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Copyright (c) 2016, Alliance for Open Media. All rights reserved
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * This source code is subject to the terms of the BSD 2 Clause License and
<span class="lineNum">       5 </span>            :  * the Alliance for Open Media Patent License 1.0. If the BSD 2 Clause License
<span class="lineNum">       6 </span>            :  * was not distributed with this source code in the LICENSE file, you can
<span class="lineNum">       7 </span>            :  * obtain it at www.aomedia.org/license/software. If the Alliance for Open
<span class="lineNum">       8 </span>            :  * Media Patent License 1.0 was not distributed with this source code in the
<span class="lineNum">       9 </span>            :  * PATENTS file, you can obtain it at www.aomedia.org/license/patent.
<span class="lineNum">      10 </span>            :  */
<span class="lineNum">      11 </span>            : 
<span class="lineNum">      12 </span>            : #include &lt;assert.h&gt;
<span class="lineNum">      13 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      14 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      15 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : #include &quot;aom_mem/aom_mem.h&quot;
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #include &quot;av1/common/entropy.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;av1/common/pred_common.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;av1/common/scan.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;av1/common/seg_common.h&quot;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &quot;av1/encoder/cost.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;av1/encoder/encoder.h&quot;
<span class="lineNum">      26 </span>            : #if CONFIG_LV_MAP
<span class="lineNum">      27 </span>            : #include &quot;av1/encoder/encodetxb.c&quot;
<span class="lineNum">      28 </span>            : #endif
<span class="lineNum">      29 </span>            : #include &quot;av1/encoder/rdopt.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;av1/encoder/tokenize.h&quot;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : static const TOKENVALUE dct_cat_lt_10_value_tokens[] = {
<span class="lineNum">      33 </span>            :   { 9, 63 }, { 9, 61 }, { 9, 59 }, { 9, 57 }, { 9, 55 }, { 9, 53 }, { 9, 51 },
<span class="lineNum">      34 </span>            :   { 9, 49 }, { 9, 47 }, { 9, 45 }, { 9, 43 }, { 9, 41 }, { 9, 39 }, { 9, 37 },
<span class="lineNum">      35 </span>            :   { 9, 35 }, { 9, 33 }, { 9, 31 }, { 9, 29 }, { 9, 27 }, { 9, 25 }, { 9, 23 },
<span class="lineNum">      36 </span>            :   { 9, 21 }, { 9, 19 }, { 9, 17 }, { 9, 15 }, { 9, 13 }, { 9, 11 }, { 9, 9 },
<span class="lineNum">      37 </span>            :   { 9, 7 },  { 9, 5 },  { 9, 3 },  { 9, 1 },  { 8, 31 }, { 8, 29 }, { 8, 27 },
<span class="lineNum">      38 </span>            :   { 8, 25 }, { 8, 23 }, { 8, 21 }, { 8, 19 }, { 8, 17 }, { 8, 15 }, { 8, 13 },
<span class="lineNum">      39 </span>            :   { 8, 11 }, { 8, 9 },  { 8, 7 },  { 8, 5 },  { 8, 3 },  { 8, 1 },  { 7, 15 },
<span class="lineNum">      40 </span>            :   { 7, 13 }, { 7, 11 }, { 7, 9 },  { 7, 7 },  { 7, 5 },  { 7, 3 },  { 7, 1 },
<span class="lineNum">      41 </span>            :   { 6, 7 },  { 6, 5 },  { 6, 3 },  { 6, 1 },  { 5, 3 },  { 5, 1 },  { 4, 1 },
<span class="lineNum">      42 </span>            :   { 3, 1 },  { 2, 1 },  { 1, 1 },  { 0, 0 },  { 1, 0 },  { 2, 0 },  { 3, 0 },
<span class="lineNum">      43 </span>            :   { 4, 0 },  { 5, 0 },  { 5, 2 },  { 6, 0 },  { 6, 2 },  { 6, 4 },  { 6, 6 },
<span class="lineNum">      44 </span>            :   { 7, 0 },  { 7, 2 },  { 7, 4 },  { 7, 6 },  { 7, 8 },  { 7, 10 }, { 7, 12 },
<span class="lineNum">      45 </span>            :   { 7, 14 }, { 8, 0 },  { 8, 2 },  { 8, 4 },  { 8, 6 },  { 8, 8 },  { 8, 10 },
<span class="lineNum">      46 </span>            :   { 8, 12 }, { 8, 14 }, { 8, 16 }, { 8, 18 }, { 8, 20 }, { 8, 22 }, { 8, 24 },
<span class="lineNum">      47 </span>            :   { 8, 26 }, { 8, 28 }, { 8, 30 }, { 9, 0 },  { 9, 2 },  { 9, 4 },  { 9, 6 },
<span class="lineNum">      48 </span>            :   { 9, 8 },  { 9, 10 }, { 9, 12 }, { 9, 14 }, { 9, 16 }, { 9, 18 }, { 9, 20 },
<span class="lineNum">      49 </span>            :   { 9, 22 }, { 9, 24 }, { 9, 26 }, { 9, 28 }, { 9, 30 }, { 9, 32 }, { 9, 34 },
<span class="lineNum">      50 </span>            :   { 9, 36 }, { 9, 38 }, { 9, 40 }, { 9, 42 }, { 9, 44 }, { 9, 46 }, { 9, 48 },
<span class="lineNum">      51 </span>            :   { 9, 50 }, { 9, 52 }, { 9, 54 }, { 9, 56 }, { 9, 58 }, { 9, 60 }, { 9, 62 }
<span class="lineNum">      52 </span>            : };
<span class="lineNum">      53 </span>            : const TOKENVALUE *av1_dct_cat_lt_10_value_tokens =
<span class="lineNum">      54 </span>            :     dct_cat_lt_10_value_tokens +
<span class="lineNum">      55 </span>            :     (sizeof(dct_cat_lt_10_value_tokens) / sizeof(*dct_cat_lt_10_value_tokens)) /
<span class="lineNum">      56 </span>            :         2;
<span class="lineNum">      57 </span>            : // The corresponding costs of the extrabits for the tokens in the above table
<span class="lineNum">      58 </span>            : // are stored in the table below. The values are obtained from looking up the
<span class="lineNum">      59 </span>            : // entry for the specified extrabits in the table corresponding to the token
<span class="lineNum">      60 </span>            : // (as defined in cost element av1_extra_bits)
<span class="lineNum">      61 </span>            : // e.g. {9, 63} maps to cat5_cost[63 &gt;&gt; 1], {1, 1} maps to sign_cost[1 &gt;&gt; 1]
<span class="lineNum">      62 </span>            : static const int dct_cat_lt_10_value_cost[] = {
<span class="lineNum">      63 </span>            :   3773, 3750, 3704, 3681, 3623, 3600, 3554, 3531, 3432, 3409, 3363, 3340, 3282,
<span class="lineNum">      64 </span>            :   3259, 3213, 3190, 3136, 3113, 3067, 3044, 2986, 2963, 2917, 2894, 2795, 2772,
<span class="lineNum">      65 </span>            :   2726, 2703, 2645, 2622, 2576, 2553, 3197, 3116, 3058, 2977, 2881, 2800, 2742,
<span class="lineNum">      66 </span>            :   2661, 2615, 2534, 2476, 2395, 2299, 2218, 2160, 2079, 2566, 2427, 2334, 2195,
<span class="lineNum">      67 </span>            :   2023, 1884, 1791, 1652, 1893, 1696, 1453, 1256, 1229, 864,  512,  512,  512,
<span class="lineNum">      68 </span>            :   512,  0,    512,  512,  512,  512,  864,  1229, 1256, 1453, 1696, 1893, 1652,
<span class="lineNum">      69 </span>            :   1791, 1884, 2023, 2195, 2334, 2427, 2566, 2079, 2160, 2218, 2299, 2395, 2476,
<span class="lineNum">      70 </span>            :   2534, 2615, 2661, 2742, 2800, 2881, 2977, 3058, 3116, 3197, 2553, 2576, 2622,
<span class="lineNum">      71 </span>            :   2645, 2703, 2726, 2772, 2795, 2894, 2917, 2963, 2986, 3044, 3067, 3113, 3136,
<span class="lineNum">      72 </span>            :   3190, 3213, 3259, 3282, 3340, 3363, 3409, 3432, 3531, 3554, 3600, 3623, 3681,
<span class="lineNum">      73 </span>            :   3704, 3750, 3773,
<span class="lineNum">      74 </span>            : };
<span class="lineNum">      75 </span>            : const int *av1_dct_cat_lt_10_value_cost =
<span class="lineNum">      76 </span>            :     dct_cat_lt_10_value_cost +
<span class="lineNum">      77 </span>            :     (sizeof(dct_cat_lt_10_value_cost) / sizeof(*dct_cat_lt_10_value_cost)) / 2;
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            : // Array indices are identical to previously-existing CONTEXT_NODE indices
<span class="lineNum">      80 </span>            : /* clang-format off */
<span class="lineNum">      81 </span>            : const aom_tree_index av1_coef_tree[TREE_SIZE(ENTROPY_TOKENS)] = {
<span class="lineNum">      82 </span>            :   -EOB_TOKEN, 2,                       // 0  = EOB
<span class="lineNum">      83 </span>            :   -ZERO_TOKEN, 4,                      // 1  = ZERO
<span class="lineNum">      84 </span>            :   -ONE_TOKEN, 6,                       // 2  = ONE
<span class="lineNum">      85 </span>            :   8, 12,                               // 3  = LOW_VAL
<span class="lineNum">      86 </span>            :   -TWO_TOKEN, 10,                      // 4  = TWO
<span class="lineNum">      87 </span>            :   -THREE_TOKEN, -FOUR_TOKEN,           // 5  = THREE
<span class="lineNum">      88 </span>            :   14, 16,                              // 6  = HIGH_LOW
<span class="lineNum">      89 </span>            :   -CATEGORY1_TOKEN, -CATEGORY2_TOKEN,  // 7  = CAT_ONE
<span class="lineNum">      90 </span>            :   18, 20,                              // 8  = CAT_THREEFOUR
<span class="lineNum">      91 </span>            :   -CATEGORY3_TOKEN, -CATEGORY4_TOKEN,  // 9  = CAT_THREE
<span class="lineNum">      92 </span>            :   -CATEGORY5_TOKEN, -CATEGORY6_TOKEN   // 10 = CAT_FIVE
<span class="lineNum">      93 </span>            : };
<span class="lineNum">      94 </span>            : /* clang-format on */
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            : static const int16_t zero_cost[] = { 0 };
<span class="lineNum">      97 </span>            : static const int16_t sign_cost[1] = { 512 };
<span class="lineNum">      98 </span>            : static const int16_t cat1_cost[1 &lt;&lt; 1] = { 864, 1229 };
<span class="lineNum">      99 </span>            : static const int16_t cat2_cost[1 &lt;&lt; 2] = { 1256, 1453, 1696, 1893 };
<span class="lineNum">     100 </span>            : static const int16_t cat3_cost[1 &lt;&lt; 3] = { 1652, 1791, 1884, 2023,
<span class="lineNum">     101 </span>            :                                            2195, 2334, 2427, 2566 };
<span class="lineNum">     102 </span>            : static const int16_t cat4_cost[1 &lt;&lt; 4] = { 2079, 2160, 2218, 2299, 2395, 2476,
<span class="lineNum">     103 </span>            :                                            2534, 2615, 2661, 2742, 2800, 2881,
<span class="lineNum">     104 </span>            :                                            2977, 3058, 3116, 3197 };
<span class="lineNum">     105 </span>            : static const int16_t cat5_cost[1 &lt;&lt; 5] = {
<span class="lineNum">     106 </span>            :   2553, 2576, 2622, 2645, 2703, 2726, 2772, 2795, 2894, 2917, 2963,
<span class="lineNum">     107 </span>            :   2986, 3044, 3067, 3113, 3136, 3190, 3213, 3259, 3282, 3340, 3363,
<span class="lineNum">     108 </span>            :   3409, 3432, 3531, 3554, 3600, 3623, 3681, 3704, 3750, 3773
<span class="lineNum">     109 </span>            : };
<span class="lineNum">     110 </span>            : const int16_t av1_cat6_low_cost[256] = {
<span class="lineNum">     111 </span>            :   3378, 3390, 3401, 3413, 3435, 3447, 3458, 3470, 3517, 3529, 3540, 3552, 3574,
<span class="lineNum">     112 </span>            :   3586, 3597, 3609, 3671, 3683, 3694, 3706, 3728, 3740, 3751, 3763, 3810, 3822,
<span class="lineNum">     113 </span>            :   3833, 3845, 3867, 3879, 3890, 3902, 3973, 3985, 3996, 4008, 4030, 4042, 4053,
<span class="lineNum">     114 </span>            :   4065, 4112, 4124, 4135, 4147, 4169, 4181, 4192, 4204, 4266, 4278, 4289, 4301,
<span class="lineNum">     115 </span>            :   4323, 4335, 4346, 4358, 4405, 4417, 4428, 4440, 4462, 4474, 4485, 4497, 4253,
<span class="lineNum">     116 </span>            :   4265, 4276, 4288, 4310, 4322, 4333, 4345, 4392, 4404, 4415, 4427, 4449, 4461,
<span class="lineNum">     117 </span>            :   4472, 4484, 4546, 4558, 4569, 4581, 4603, 4615, 4626, 4638, 4685, 4697, 4708,
<span class="lineNum">     118 </span>            :   4720, 4742, 4754, 4765, 4777, 4848, 4860, 4871, 4883, 4905, 4917, 4928, 4940,
<span class="lineNum">     119 </span>            :   4987, 4999, 5010, 5022, 5044, 5056, 5067, 5079, 5141, 5153, 5164, 5176, 5198,
<span class="lineNum">     120 </span>            :   5210, 5221, 5233, 5280, 5292, 5303, 5315, 5337, 5349, 5360, 5372, 4988, 5000,
<span class="lineNum">     121 </span>            :   5011, 5023, 5045, 5057, 5068, 5080, 5127, 5139, 5150, 5162, 5184, 5196, 5207,
<span class="lineNum">     122 </span>            :   5219, 5281, 5293, 5304, 5316, 5338, 5350, 5361, 5373, 5420, 5432, 5443, 5455,
<span class="lineNum">     123 </span>            :   5477, 5489, 5500, 5512, 5583, 5595, 5606, 5618, 5640, 5652, 5663, 5675, 5722,
<span class="lineNum">     124 </span>            :   5734, 5745, 5757, 5779, 5791, 5802, 5814, 5876, 5888, 5899, 5911, 5933, 5945,
<span class="lineNum">     125 </span>            :   5956, 5968, 6015, 6027, 6038, 6050, 6072, 6084, 6095, 6107, 5863, 5875, 5886,
<span class="lineNum">     126 </span>            :   5898, 5920, 5932, 5943, 5955, 6002, 6014, 6025, 6037, 6059, 6071, 6082, 6094,
<span class="lineNum">     127 </span>            :   6156, 6168, 6179, 6191, 6213, 6225, 6236, 6248, 6295, 6307, 6318, 6330, 6352,
<span class="lineNum">     128 </span>            :   6364, 6375, 6387, 6458, 6470, 6481, 6493, 6515, 6527, 6538, 6550, 6597, 6609,
<span class="lineNum">     129 </span>            :   6620, 6632, 6654, 6666, 6677, 6689, 6751, 6763, 6774, 6786, 6808, 6820, 6831,
<span class="lineNum">     130 </span>            :   6843, 6890, 6902, 6913, 6925, 6947, 6959, 6970, 6982
<span class="lineNum">     131 </span>            : };
<span class="lineNum">     132 </span>            : const int av1_cat6_high_cost[CAT6_HIGH_COST_ENTRIES] = {
<span class="lineNum">     133 </span>            :   100,   2263,  2739,  4902,  3160,  5323,  5799,  7962,  3678,  5841,  6317,
<span class="lineNum">     134 </span>            :   8480,  6738,  8901,  9377,  11540, 3678,  5841,  6317,  8480,  6738,  8901,
<span class="lineNum">     135 </span>            :   9377,  11540, 7256,  9419,  9895,  12058, 10316, 12479, 12955, 15118, 3678,
<span class="lineNum">     136 </span>            :   5841,  6317,  8480,  6738,  8901,  9377,  11540, 7256,  9419,  9895,  12058,
<span class="lineNum">     137 </span>            :   10316, 12479, 12955, 15118, 7256,  9419,  9895,  12058, 10316, 12479, 12955,
<span class="lineNum">     138 </span>            :   15118, 10834, 12997, 13473, 15636, 13894, 16057, 16533, 18696,
<span class="lineNum">     139 </span>            : #if CONFIG_HIGHBITDEPTH
<span class="lineNum">     140 </span>            :   4193,  6356,  6832,  8995,  7253,  9416,  9892,  12055, 7771,  9934,  10410,
<span class="lineNum">     141 </span>            :   12573, 10831, 12994, 13470, 15633, 7771,  9934,  10410, 12573, 10831, 12994,
<span class="lineNum">     142 </span>            :   13470, 15633, 11349, 13512, 13988, 16151, 14409, 16572, 17048, 19211, 7771,
<span class="lineNum">     143 </span>            :   9934,  10410, 12573, 10831, 12994, 13470, 15633, 11349, 13512, 13988, 16151,
<span class="lineNum">     144 </span>            :   14409, 16572, 17048, 19211, 11349, 13512, 13988, 16151, 14409, 16572, 17048,
<span class="lineNum">     145 </span>            :   19211, 14927, 17090, 17566, 19729, 17987, 20150, 20626, 22789, 4193,  6356,
<span class="lineNum">     146 </span>            :   6832,  8995,  7253,  9416,  9892,  12055, 7771,  9934,  10410, 12573, 10831,
<span class="lineNum">     147 </span>            :   12994, 13470, 15633, 7771,  9934,  10410, 12573, 10831, 12994, 13470, 15633,
<span class="lineNum">     148 </span>            :   11349, 13512, 13988, 16151, 14409, 16572, 17048, 19211, 7771,  9934,  10410,
<span class="lineNum">     149 </span>            :   12573, 10831, 12994, 13470, 15633, 11349, 13512, 13988, 16151, 14409, 16572,
<span class="lineNum">     150 </span>            :   17048, 19211, 11349, 13512, 13988, 16151, 14409, 16572, 17048, 19211, 14927,
<span class="lineNum">     151 </span>            :   17090, 17566, 19729, 17987, 20150, 20626, 22789, 8286,  10449, 10925, 13088,
<span class="lineNum">     152 </span>            :   11346, 13509, 13985, 16148, 11864, 14027, 14503, 16666, 14924, 17087, 17563,
<span class="lineNum">     153 </span>            :   19726, 11864, 14027, 14503, 16666, 14924, 17087, 17563, 19726, 15442, 17605,
<span class="lineNum">     154 </span>            :   18081, 20244, 18502, 20665, 21141, 23304, 11864, 14027, 14503, 16666, 14924,
<span class="lineNum">     155 </span>            :   17087, 17563, 19726, 15442, 17605, 18081, 20244, 18502, 20665, 21141, 23304,
<span class="lineNum">     156 </span>            :   15442, 17605, 18081, 20244, 18502, 20665, 21141, 23304, 19020, 21183, 21659,
<span class="lineNum">     157 </span>            :   23822, 22080, 24243, 24719, 26882, 4193,  6356,  6832,  8995,  7253,  9416,
<span class="lineNum">     158 </span>            :   9892,  12055, 7771,  9934,  10410, 12573, 10831, 12994, 13470, 15633, 7771,
<span class="lineNum">     159 </span>            :   9934,  10410, 12573, 10831, 12994, 13470, 15633, 11349, 13512, 13988, 16151,
<span class="lineNum">     160 </span>            :   14409, 16572, 17048, 19211, 7771,  9934,  10410, 12573, 10831, 12994, 13470,
<span class="lineNum">     161 </span>            :   15633, 11349, 13512, 13988, 16151, 14409, 16572, 17048, 19211, 11349, 13512,
<span class="lineNum">     162 </span>            :   13988, 16151, 14409, 16572, 17048, 19211, 14927, 17090, 17566, 19729, 17987,
<span class="lineNum">     163 </span>            :   20150, 20626, 22789, 8286,  10449, 10925, 13088, 11346, 13509, 13985, 16148,
<span class="lineNum">     164 </span>            :   11864, 14027, 14503, 16666, 14924, 17087, 17563, 19726, 11864, 14027, 14503,
<span class="lineNum">     165 </span>            :   16666, 14924, 17087, 17563, 19726, 15442, 17605, 18081, 20244, 18502, 20665,
<span class="lineNum">     166 </span>            :   21141, 23304, 11864, 14027, 14503, 16666, 14924, 17087, 17563, 19726, 15442,
<span class="lineNum">     167 </span>            :   17605, 18081, 20244, 18502, 20665, 21141, 23304, 15442, 17605, 18081, 20244,
<span class="lineNum">     168 </span>            :   18502, 20665, 21141, 23304, 19020, 21183, 21659, 23822, 22080, 24243, 24719,
<span class="lineNum">     169 </span>            :   26882, 8286,  10449, 10925, 13088, 11346, 13509, 13985, 16148, 11864, 14027,
<span class="lineNum">     170 </span>            :   14503, 16666, 14924, 17087, 17563, 19726, 11864, 14027, 14503, 16666, 14924,
<span class="lineNum">     171 </span>            :   17087, 17563, 19726, 15442, 17605, 18081, 20244, 18502, 20665, 21141, 23304,
<span class="lineNum">     172 </span>            :   11864, 14027, 14503, 16666, 14924, 17087, 17563, 19726, 15442, 17605, 18081,
<span class="lineNum">     173 </span>            :   20244, 18502, 20665, 21141, 23304, 15442, 17605, 18081, 20244, 18502, 20665,
<span class="lineNum">     174 </span>            :   21141, 23304, 19020, 21183, 21659, 23822, 22080, 24243, 24719, 26882, 12379,
<span class="lineNum">     175 </span>            :   14542, 15018, 17181, 15439, 17602, 18078, 20241, 15957, 18120, 18596, 20759,
<span class="lineNum">     176 </span>            :   19017, 21180, 21656, 23819, 15957, 18120, 18596, 20759, 19017, 21180, 21656,
<span class="lineNum">     177 </span>            :   23819, 19535, 21698, 22174, 24337, 22595, 24758, 25234, 27397, 15957, 18120,
<span class="lineNum">     178 </span>            :   18596, 20759, 19017, 21180, 21656, 23819, 19535, 21698, 22174, 24337, 22595,
<span class="lineNum">     179 </span>            :   24758, 25234, 27397, 19535, 21698, 22174, 24337, 22595, 24758, 25234, 27397,
<span class="lineNum">     180 </span>            :   23113, 25276, 25752, 27915, 26173, 28336, 28812, 30975, 4193,  6356,  6832,
<span class="lineNum">     181 </span>            :   8995,  7253,  9416,  9892,  12055, 7771,  9934,  10410, 12573, 10831, 12994,
<span class="lineNum">     182 </span>            :   13470, 15633, 7771,  9934,  10410, 12573, 10831, 12994, 13470, 15633, 11349,
<span class="lineNum">     183 </span>            :   13512, 13988, 16151, 14409, 16572, 17048, 19211, 7771,  9934,  10410, 12573,
<span class="lineNum">     184 </span>            :   10831, 12994, 13470, 15633, 11349, 13512, 13988, 16151, 14409, 16572, 17048,
<span class="lineNum">     185 </span>            :   19211, 11349, 13512, 13988, 16151, 14409, 16572, 17048, 19211, 14927, 17090,
<span class="lineNum">     186 </span>            :   17566, 19729, 17987, 20150, 20626, 22789, 8286,  10449, 10925, 13088, 11346,
<span class="lineNum">     187 </span>            :   13509, 13985, 16148, 11864, 14027, 14503, 16666, 14924, 17087, 17563, 19726,
<span class="lineNum">     188 </span>            :   11864, 14027, 14503, 16666, 14924, 17087, 17563, 19726, 15442, 17605, 18081,
<span class="lineNum">     189 </span>            :   20244, 18502, 20665, 21141, 23304, 11864, 14027, 14503, 16666, 14924, 17087,
<span class="lineNum">     190 </span>            :   17563, 19726, 15442, 17605, 18081, 20244, 18502, 20665, 21141, 23304, 15442,
<span class="lineNum">     191 </span>            :   17605, 18081, 20244, 18502, 20665, 21141, 23304, 19020, 21183, 21659, 23822,
<span class="lineNum">     192 </span>            :   22080, 24243, 24719, 26882, 8286,  10449, 10925, 13088, 11346, 13509, 13985,
<span class="lineNum">     193 </span>            :   16148, 11864, 14027, 14503, 16666, 14924, 17087, 17563, 19726, 11864, 14027,
<span class="lineNum">     194 </span>            :   14503, 16666, 14924, 17087, 17563, 19726, 15442, 17605, 18081, 20244, 18502,
<span class="lineNum">     195 </span>            :   20665, 21141, 23304, 11864, 14027, 14503, 16666, 14924, 17087, 17563, 19726,
<span class="lineNum">     196 </span>            :   15442, 17605, 18081, 20244, 18502, 20665, 21141, 23304, 15442, 17605, 18081,
<span class="lineNum">     197 </span>            :   20244, 18502, 20665, 21141, 23304, 19020, 21183, 21659, 23822, 22080, 24243,
<span class="lineNum">     198 </span>            :   24719, 26882, 12379, 14542, 15018, 17181, 15439, 17602, 18078, 20241, 15957,
<span class="lineNum">     199 </span>            :   18120, 18596, 20759, 19017, 21180, 21656, 23819, 15957, 18120, 18596, 20759,
<span class="lineNum">     200 </span>            :   19017, 21180, 21656, 23819, 19535, 21698, 22174, 24337, 22595, 24758, 25234,
<span class="lineNum">     201 </span>            :   27397, 15957, 18120, 18596, 20759, 19017, 21180, 21656, 23819, 19535, 21698,
<span class="lineNum">     202 </span>            :   22174, 24337, 22595, 24758, 25234, 27397, 19535, 21698, 22174, 24337, 22595,
<span class="lineNum">     203 </span>            :   24758, 25234, 27397, 23113, 25276, 25752, 27915, 26173, 28336, 28812, 30975,
<span class="lineNum">     204 </span>            :   8286,  10449, 10925, 13088, 11346, 13509, 13985, 16148, 11864, 14027, 14503,
<span class="lineNum">     205 </span>            :   16666, 14924, 17087, 17563, 19726, 11864, 14027, 14503, 16666, 14924, 17087,
<span class="lineNum">     206 </span>            :   17563, 19726, 15442, 17605, 18081, 20244, 18502, 20665, 21141, 23304, 11864,
<span class="lineNum">     207 </span>            :   14027, 14503, 16666, 14924, 17087, 17563, 19726, 15442, 17605, 18081, 20244,
<span class="lineNum">     208 </span>            :   18502, 20665, 21141, 23304, 15442, 17605, 18081, 20244, 18502, 20665, 21141,
<span class="lineNum">     209 </span>            :   23304, 19020, 21183, 21659, 23822, 22080, 24243, 24719, 26882, 12379, 14542,
<span class="lineNum">     210 </span>            :   15018, 17181, 15439, 17602, 18078, 20241, 15957, 18120, 18596, 20759, 19017,
<span class="lineNum">     211 </span>            :   21180, 21656, 23819, 15957, 18120, 18596, 20759, 19017, 21180, 21656, 23819,
<span class="lineNum">     212 </span>            :   19535, 21698, 22174, 24337, 22595, 24758, 25234, 27397, 15957, 18120, 18596,
<span class="lineNum">     213 </span>            :   20759, 19017, 21180, 21656, 23819, 19535, 21698, 22174, 24337, 22595, 24758,
<span class="lineNum">     214 </span>            :   25234, 27397, 19535, 21698, 22174, 24337, 22595, 24758, 25234, 27397, 23113,
<span class="lineNum">     215 </span>            :   25276, 25752, 27915, 26173, 28336, 28812, 30975, 12379, 14542, 15018, 17181,
<span class="lineNum">     216 </span>            :   15439, 17602, 18078, 20241, 15957, 18120, 18596, 20759, 19017, 21180, 21656,
<span class="lineNum">     217 </span>            :   23819, 15957, 18120, 18596, 20759, 19017, 21180, 21656, 23819, 19535, 21698,
<span class="lineNum">     218 </span>            :   22174, 24337, 22595, 24758, 25234, 27397, 15957, 18120, 18596, 20759, 19017,
<span class="lineNum">     219 </span>            :   21180, 21656, 23819, 19535, 21698, 22174, 24337, 22595, 24758, 25234, 27397,
<span class="lineNum">     220 </span>            :   19535, 21698, 22174, 24337, 22595, 24758, 25234, 27397, 23113, 25276, 25752,
<span class="lineNum">     221 </span>            :   27915, 26173, 28336, 28812, 30975, 16472, 18635, 19111, 21274, 19532, 21695,
<span class="lineNum">     222 </span>            :   22171, 24334, 20050, 22213, 22689, 24852, 23110, 25273, 25749, 27912, 20050,
<span class="lineNum">     223 </span>            :   22213, 22689, 24852, 23110, 25273, 25749, 27912, 23628, 25791, 26267, 28430,
<span class="lineNum">     224 </span>            :   26688, 28851, 29327, 31490, 20050, 22213, 22689, 24852, 23110, 25273, 25749,
<span class="lineNum">     225 </span>            :   27912, 23628, 25791, 26267, 28430, 26688, 28851, 29327, 31490, 23628, 25791,
<span class="lineNum">     226 </span>            :   26267, 28430, 26688, 28851, 29327, 31490, 27206, 29369, 29845, 32008, 30266,
<span class="lineNum">     227 </span>            :   32429, 32905, 35068
<span class="lineNum">     228 </span>            : #endif
<span class="lineNum">     229 </span>            : };
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span>            : const uint8_t av1_cat6_skipped_bits_discount[8] = {
<span class="lineNum">     232 </span>            :   0, 3, 6, 9, 12, 18, 24, 30
<span class="lineNum">     233 </span>            : };
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            : #if CONFIG_NEW_MULTISYMBOL
<span class="lineNum">     236 </span>            : const av1_extra_bit av1_extra_bits[ENTROPY_TOKENS] = {
<span class="lineNum">     237 </span>            :   { 0, 0, 0, zero_cost },                        // ZERO_TOKEN
<span class="lineNum">     238 </span>            :   { 0, 0, 1, sign_cost },                        // ONE_TOKEN
<span class="lineNum">     239 </span>            :   { 0, 0, 2, sign_cost },                        // TWO_TOKEN
<span class="lineNum">     240 </span>            :   { 0, 0, 3, sign_cost },                        // THREE_TOKEN
<span class="lineNum">     241 </span>            :   { 0, 0, 4, sign_cost },                        // FOUR_TOKEN
<span class="lineNum">     242 </span>            :   { av1_cat1_cdf, 1, CAT1_MIN_VAL, cat1_cost },  // CATEGORY1_TOKEN
<span class="lineNum">     243 </span>            :   { av1_cat2_cdf, 2, CAT2_MIN_VAL, cat2_cost },  // CATEGORY2_TOKEN
<span class="lineNum">     244 </span>            :   { av1_cat3_cdf, 3, CAT3_MIN_VAL, cat3_cost },  // CATEGORY3_TOKEN
<span class="lineNum">     245 </span>            :   { av1_cat4_cdf, 4, CAT4_MIN_VAL, cat4_cost },  // CATEGORY4_TOKEN
<span class="lineNum">     246 </span>            :   { av1_cat5_cdf, 5, CAT5_MIN_VAL, cat5_cost },  // CATEGORY5_TOKEN
<span class="lineNum">     247 </span>            :   { av1_cat6_cdf, 18, CAT6_MIN_VAL, 0 },         // CATEGORY6_TOKEN
<span class="lineNum">     248 </span>            :   { 0, 0, 0, zero_cost }                         // EOB_TOKEN
<span class="lineNum">     249 </span>            : };
<span class="lineNum">     250 </span>            : #else
<span class="lineNum">     251 </span>            : const av1_extra_bit av1_extra_bits[ENTROPY_TOKENS] = {
<span class="lineNum">     252 </span>            :   { 0, 0, 0, zero_cost },                         // ZERO_TOKEN
<span class="lineNum">     253 </span>            :   { 0, 0, 1, sign_cost },                         // ONE_TOKEN
<span class="lineNum">     254 </span>            :   { 0, 0, 2, sign_cost },                         // TWO_TOKEN
<span class="lineNum">     255 </span>            :   { 0, 0, 3, sign_cost },                         // THREE_TOKEN
<span class="lineNum">     256 </span>            :   { 0, 0, 4, sign_cost },                         // FOUR_TOKEN
<span class="lineNum">     257 </span>            :   { av1_cat1_prob, 1, CAT1_MIN_VAL, cat1_cost },  // CATEGORY1_TOKEN
<span class="lineNum">     258 </span>            :   { av1_cat2_prob, 2, CAT2_MIN_VAL, cat2_cost },  // CATEGORY2_TOKEN
<span class="lineNum">     259 </span>            :   { av1_cat3_prob, 3, CAT3_MIN_VAL, cat3_cost },  // CATEGORY3_TOKEN
<span class="lineNum">     260 </span>            :   { av1_cat4_prob, 4, CAT4_MIN_VAL, cat4_cost },  // CATEGORY4_TOKEN
<span class="lineNum">     261 </span>            :   { av1_cat5_prob, 5, CAT5_MIN_VAL, cat5_cost },  // CATEGORY5_TOKEN
<span class="lineNum">     262 </span>            :   { av1_cat6_prob, 18, CAT6_MIN_VAL, 0 },         // CATEGORY6_TOKEN
<span class="lineNum">     263 </span>            :   { 0, 0, 0, zero_cost }                          // EOB_TOKEN
<span class="lineNum">     264 </span>            : };
<span class="lineNum">     265 </span>            : #endif
<a name="266"><span class="lineNum">     266 </span>            : </a>
<span class="lineNum">     267 </span>            : #if !CONFIG_PVQ || CONFIG_VAR_TX
<span class="lineNum">     268 </span><span class="lineNoCov">          0 : static void cost_coeffs_b(int plane, int block, int blk_row, int blk_col,</span>
<span class="lineNum">     269 </span>            :                           BLOCK_SIZE plane_bsize, TX_SIZE tx_size, void *arg) {
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :   struct tokenize_b_args *const args = arg;</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :   const AV1_COMP *const cpi = args-&gt;cpi;</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :   const AV1_COMMON *cm = &amp;cpi-&gt;common;</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :   ThreadData *const td = args-&gt;td;</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   MACROBLOCK *const x = &amp;td-&gt;mb;</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   MACROBLOCKD *const xd = &amp;x-&gt;e_mbd;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   MB_MODE_INFO *mbmi = &amp;xd-&gt;mi[0]-&gt;mbmi;</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   struct macroblock_plane *p = &amp;x-&gt;plane[plane];</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   struct macroblockd_plane *pd = &amp;xd-&gt;plane[plane];</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   const PLANE_TYPE type = pd-&gt;plane_type;</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :   const int ref = is_inter_block(mbmi);</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :   const TX_TYPE tx_type = get_tx_type(type, xd, block, tx_size);</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   const SCAN_ORDER *const scan_order = get_scan(cm, tx_size, tx_type, ref);</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :   const int rate = av1_cost_coeffs(cpi, x, plane, block, tx_size, scan_order,</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :                                    pd-&gt;above_context + blk_col,</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :                                    pd-&gt;left_context + blk_row, 0);</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :   args-&gt;this_rate += rate;</span>
<span class="lineNum">     287 </span>            :   (void)plane_bsize;
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   av1_set_contexts(xd, pd, plane, tx_size, p-&gt;eobs[block] &gt; 0, blk_col,</span>
<span class="lineNum">     289 </span>            :                    blk_row);
<a name="290"><span class="lineNum">     290 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span><span class="lineNoCov">          0 : static void set_entropy_context_b(int plane, int block, int blk_row,</span>
<span class="lineNum">     293 </span>            :                                   int blk_col, BLOCK_SIZE plane_bsize,
<span class="lineNum">     294 </span>            :                                   TX_SIZE tx_size, void *arg) {
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :   struct tokenize_b_args *const args = arg;</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :   ThreadData *const td = args-&gt;td;</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :   MACROBLOCK *const x = &amp;td-&gt;mb;</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :   MACROBLOCKD *const xd = &amp;x-&gt;e_mbd;</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :   struct macroblock_plane *p = &amp;x-&gt;plane[plane];</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :   struct macroblockd_plane *pd = &amp;xd-&gt;plane[plane];</span>
<span class="lineNum">     301 </span>            :   (void)plane_bsize;
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :   av1_set_contexts(xd, pd, plane, tx_size, p-&gt;eobs[block] &gt; 0, blk_col,</span>
<span class="lineNum">     303 </span>            :                    blk_row);
<a name="304"><span class="lineNum">     304 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineNoCov">          0 : static INLINE void add_token(TOKENEXTRA **t,</span>
<span class="lineNum">     307 </span>            :                              aom_cdf_prob (*tail_cdf)[CDF_SIZE(ENTROPY_TOKENS)],
<span class="lineNum">     308 </span>            :                              aom_cdf_prob (*head_cdf)[CDF_SIZE(ENTROPY_TOKENS)],
<span class="lineNum">     309 </span>            :                              int eob_val, int first_val, int32_t extra,
<span class="lineNum">     310 </span>            :                              uint8_t token) {
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :   (*t)-&gt;token = token;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :   (*t)-&gt;extra = extra;</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   (*t)-&gt;tail_cdf = tail_cdf;</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :   (*t)-&gt;head_cdf = head_cdf;</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :   (*t)-&gt;eob_val = eob_val;</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :   (*t)-&gt;first_val = first_val;</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :   (*t)++;</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     319 </span>            : #endif  // !CONFIG_PVQ || CONFIG_VAR_TX
<a name="320"><span class="lineNum">     320 </span>            : </a>
<span class="lineNum">     321 </span>            : #if CONFIG_PALETTE
<span class="lineNum">     322 </span><span class="lineNoCov">          0 : void av1_tokenize_palette_sb(const AV1_COMP *cpi,</span>
<span class="lineNum">     323 </span>            :                              const struct ThreadData *const td, int plane,
<span class="lineNum">     324 </span>            :                              TOKENEXTRA **t, RUN_TYPE dry_run, BLOCK_SIZE bsize,
<span class="lineNum">     325 </span>            :                              int *rate) {
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   const MACROBLOCK *const x = &amp;td-&gt;mb;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :   const MACROBLOCKD *const xd = &amp;x-&gt;e_mbd;</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :   const MB_MODE_INFO *const mbmi = &amp;xd-&gt;mi[0]-&gt;mbmi;</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :   const uint8_t *const color_map = xd-&gt;plane[plane].color_index_map;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :   const PALETTE_MODE_INFO *const pmi = &amp;mbmi-&gt;palette_mode_info;</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   const int n = pmi-&gt;palette_size[plane];</span>
<span class="lineNum">     332 </span>            :   int i, j;
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   int this_rate = 0;</span>
<span class="lineNum">     334 </span>            :   uint8_t color_order[PALETTE_MAX_SIZE];
<span class="lineNum">     335 </span>            :   const aom_prob(
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :       *const probs)[PALETTE_COLOR_INDEX_CONTEXTS][PALETTE_COLORS - 1] =</span>
<span class="lineNum">     337 </span>            :       plane == 0 ? av1_default_palette_y_color_index_prob
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                  : av1_default_palette_uv_color_index_prob;</span>
<span class="lineNum">     339 </span>            :   int plane_block_width, rows, cols;
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :   av1_get_block_dimensions(bsize, plane, xd, &amp;plane_block_width, NULL, &amp;rows,</span>
<span class="lineNum">     341 </span>            :                            &amp;cols);
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :   assert(plane == 0 || plane == 1);</span>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span>            : #if CONFIG_PALETTE_THROUGHPUT
<span class="lineNum">     345 </span>            :   int k;
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :   for (k = 1; k &lt; rows + cols - 1; ++k) {</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     for (j = AOMMIN(k, cols - 1); j &gt;= AOMMAX(0, k - rows + 1); --j) {</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :       i = k - j;</span>
<span class="lineNum">     349 </span>            : #else
<span class="lineNum">     350 </span>            :   for (i = 0; i &lt; rows; ++i) {
<span class="lineNum">     351 </span>            :     for (j = (i == 0 ? 1 : 0); j &lt; cols; ++j) {
<span class="lineNum">     352 </span>            : #endif  // CONFIG_PALETTE_THROUGHPUT
<span class="lineNum">     353 </span>            :       int color_new_idx;
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :       const int color_ctx = av1_get_palette_color_index_context(</span>
<span class="lineNum">     355 </span>            :           color_map, plane_block_width, i, j, n, color_order, &amp;color_new_idx);
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :       assert(color_new_idx &gt;= 0 &amp;&amp; color_new_idx &lt; n);</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :       if (dry_run == DRY_RUN_COSTCOEFFS)</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :         this_rate += cpi-&gt;palette_y_color_cost[n - PALETTE_MIN_SIZE][color_ctx]</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :                                               [color_new_idx];</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :       (*t)-&gt;token = color_new_idx;</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :       (*t)-&gt;context_tree = probs[n - PALETTE_MIN_SIZE][color_ctx];</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :       (*t)-&gt;skip_eob_node = 0;</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :       ++(*t);</span>
<span class="lineNum">     364 </span>            :     }
<span class="lineNum">     365 </span>            :   }
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   if (rate) *rate += this_rate;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     368 </span>            : #endif  // CONFIG_PALETTE
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span>            : #if CONFIG_PVQ
<span class="lineNum">     371 </span>            : static void add_pvq_block(AV1_COMMON *const cm, MACROBLOCK *const x,
<span class="lineNum">     372 </span>            :                           PVQ_INFO *pvq) {
<span class="lineNum">     373 </span>            :   PVQ_QUEUE *q = x-&gt;pvq_q;
<span class="lineNum">     374 </span>            :   if (q-&gt;curr_pos &gt;= q-&gt;buf_len) {
<span class="lineNum">     375 </span>            :     int new_buf_len = 2 * q-&gt;buf_len + 1;
<span class="lineNum">     376 </span>            :     PVQ_INFO *new_buf;
<span class="lineNum">     377 </span>            :     CHECK_MEM_ERROR(cm, new_buf, aom_malloc(new_buf_len * sizeof(PVQ_INFO)));
<span class="lineNum">     378 </span>            :     memcpy(new_buf, q-&gt;buf, q-&gt;buf_len * sizeof(PVQ_INFO));
<span class="lineNum">     379 </span>            :     aom_free(q-&gt;buf);
<span class="lineNum">     380 </span>            :     q-&gt;buf = new_buf;
<span class="lineNum">     381 </span>            :     q-&gt;buf_len = new_buf_len;
<span class="lineNum">     382 </span>            :   }
<span class="lineNum">     383 </span>            :   OD_COPY(q-&gt;buf + q-&gt;curr_pos, pvq, 1);
<span class="lineNum">     384 </span>            :   ++q-&gt;curr_pos;
<span class="lineNum">     385 </span>            : }
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span>            : // NOTE: This does not actually generate tokens, instead we store the encoding
<span class="lineNum">     388 </span>            : // decisions made for PVQ in a queue that we will read from when
<span class="lineNum">     389 </span>            : // actually writing the bitstream in write_modes_b
<span class="lineNum">     390 </span>            : static void tokenize_pvq(int plane, int block, int blk_row, int blk_col,
<span class="lineNum">     391 </span>            :                          BLOCK_SIZE plane_bsize, TX_SIZE tx_size, void *arg) {
<span class="lineNum">     392 </span>            :   struct tokenize_b_args *const args = arg;
<span class="lineNum">     393 </span>            :   const AV1_COMP *cpi = args-&gt;cpi;
<span class="lineNum">     394 </span>            :   const AV1_COMMON *const cm = &amp;cpi-&gt;common;
<span class="lineNum">     395 </span>            :   ThreadData *const td = args-&gt;td;
<span class="lineNum">     396 </span>            :   MACROBLOCK *const x = &amp;td-&gt;mb;
<span class="lineNum">     397 </span>            :   PVQ_INFO *pvq_info;
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span>            :   (void)block;
<span class="lineNum">     400 </span>            :   (void)blk_row;
<span class="lineNum">     401 </span>            :   (void)blk_col;
<span class="lineNum">     402 </span>            :   (void)plane_bsize;
<span class="lineNum">     403 </span>            :   (void)tx_size;
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span>            :   assert(block &lt; MAX_PVQ_BLOCKS_IN_SB);
<span class="lineNum">     406 </span>            :   pvq_info = &amp;x-&gt;pvq[block][plane];
<span class="lineNum">     407 </span>            :   add_pvq_block((AV1_COMMON * const)cm, x, pvq_info);
<span class="lineNum">     408 </span>            : }
<a name="409"><span class="lineNum">     409 </span>            : #endif  // CONFIG_PVQ</a>
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineNoCov">          0 : static void tokenize_b(int plane, int block, int blk_row, int blk_col,</span>
<span class="lineNum">     412 </span>            :                        BLOCK_SIZE plane_bsize, TX_SIZE tx_size, void *arg) {
<span class="lineNum">     413 </span>            : #if !CONFIG_PVQ
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :   struct tokenize_b_args *const args = arg;</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :   const AV1_COMP *cpi = args-&gt;cpi;</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :   const AV1_COMMON *const cm = &amp;cpi-&gt;common;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :   ThreadData *const td = args-&gt;td;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :   MACROBLOCK *const x = &amp;td-&gt;mb;</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :   MACROBLOCKD *const xd = &amp;x-&gt;e_mbd;</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :   TOKENEXTRA **tp = args-&gt;tp;</span>
<span class="lineNum">     421 </span>            :   uint8_t token_cache[MAX_TX_SQUARE];
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :   struct macroblock_plane *p = &amp;x-&gt;plane[plane];</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :   struct macroblockd_plane *pd = &amp;xd-&gt;plane[plane];</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :   MB_MODE_INFO *mbmi = &amp;xd-&gt;mi[0]-&gt;mbmi;</span>
<span class="lineNum">     425 </span>            :   int pt; /* near block/prev token context index */
<span class="lineNum">     426 </span>            :   int c;
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :   TOKENEXTRA *t = *tp; /* store tokens starting here */</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :   const int eob = p-&gt;eobs[block];</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :   const PLANE_TYPE type = pd-&gt;plane_type;</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :   const tran_low_t *qcoeff = BLOCK_OFFSET(p-&gt;qcoeff, block);</span>
<span class="lineNum">     431 </span>            : #if CONFIG_SUPERTX
<span class="lineNum">     432 </span>            :   const int segment_id = AOMMIN(mbmi-&gt;segment_id, mbmi-&gt;segment_id_supertx);
<span class="lineNum">     433 </span>            : #else
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :   const int segment_id = mbmi-&gt;segment_id;</span>
<span class="lineNum">     435 </span>            : #endif  // CONFIG_SUEPRTX
<span class="lineNum">     436 </span>            :   const int16_t *scan, *nb;
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :   const TX_TYPE tx_type = get_tx_type(type, xd, block, tx_size);</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :   const SCAN_ORDER *const scan_order =</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :       get_scan(cm, tx_size, tx_type, is_inter_block(mbmi));</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :   const int ref = is_inter_block(mbmi);</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :   unsigned int(*const counts)[COEFF_CONTEXTS][ENTROPY_TOKENS] =</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :       td-&gt;rd_counts.coef_counts[txsize_sqr_map[tx_size]][type][ref];</span>
<span class="lineNum">     443 </span>            : #if CONFIG_EC_ADAPT
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :   FRAME_CONTEXT *ec_ctx = xd-&gt;tile_ctx;</span>
<span class="lineNum">     445 </span>            : #else
<span class="lineNum">     446 </span>            :   FRAME_CONTEXT *ec_ctx = cpi-&gt;common.fc;
<span class="lineNum">     447 </span>            : #endif
<span class="lineNum">     448 </span>            :   aom_cdf_prob(
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :       *const coef_head_cdfs)[COEFF_CONTEXTS][CDF_SIZE(ENTROPY_TOKENS)] =</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :       ec_ctx-&gt;coef_head_cdfs[txsize_sqr_map[tx_size]][type][ref];</span>
<span class="lineNum">     451 </span>            :   aom_cdf_prob(
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :       *const coef_tail_cdfs)[COEFF_CONTEXTS][CDF_SIZE(ENTROPY_TOKENS)] =</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :       ec_ctx-&gt;coef_tail_cdfs[txsize_sqr_map[tx_size]][type][ref];</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   unsigned int(*const blockz_count)[2] =</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :       td-&gt;counts-&gt;blockz_count[txsize_sqr_map[tx_size]][type][ref];</span>
<span class="lineNum">     456 </span>            :   int eob_val;
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :   int first_val = 1;</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   const int seg_eob = get_tx_eob(&amp;cpi-&gt;common.seg, segment_id, tx_size);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :   unsigned int(*const eob_branch)[COEFF_CONTEXTS] =</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :       td-&gt;counts-&gt;eob_branch[txsize_sqr_map[tx_size]][type][ref];</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :   const uint8_t *const band = get_band_translate(tx_size);</span>
<span class="lineNum">     462 </span>            :   int16_t token;
<span class="lineNum">     463 </span>            :   EXTRABIT extra;
<span class="lineNum">     464 </span>            :   (void)plane_bsize;
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :   pt = get_entropy_context(tx_size, pd-&gt;above_context + blk_col,</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                            pd-&gt;left_context + blk_row);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :   scan = scan_order-&gt;scan;</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :   nb = scan_order-&gt;neighbors;</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :   c = 0;</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :   if (eob == 0)</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     add_token(&amp;t, &amp;coef_tail_cdfs[band[c]][pt], &amp;coef_head_cdfs[band[c]][pt], 1,</span>
<span class="lineNum">     473 </span>            :               1, 0, BLOCK_Z_TOKEN);
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :   ++blockz_count[pt][eob != 0];</span>
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :   while (c &lt; eob) {</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     int v = qcoeff[scan[c]];</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     first_val = (c == 0);</span>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     if (!v) {</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :       add_token(&amp;t, &amp;coef_tail_cdfs[band[c]][pt], &amp;coef_head_cdfs[band[c]][pt],</span>
<span class="lineNum">     483 </span>            :                 0, first_val, 0, ZERO_TOKEN);
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :       ++counts[band[c]][pt][ZERO_TOKEN];</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :       token_cache[scan[c]] = 0;</span>
<span class="lineNum">     486 </span>            :     } else {
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :       eob_val =</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :           (c + 1 == eob) ? (c + 1 == seg_eob ? LAST_EOB : EARLY_EOB) : NO_EOB;</span>
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :       av1_get_token_extra(v, &amp;token, &amp;extra);</span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :       add_token(&amp;t, &amp;coef_tail_cdfs[band[c]][pt], &amp;coef_head_cdfs[band[c]][pt],</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :                 eob_val, first_val, extra, (uint8_t)token);</span>
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :       if (eob_val != LAST_EOB) {</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :         ++counts[band[c]][pt][token];</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :         ++eob_branch[band[c]][pt];</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :         counts[band[c]][pt][EOB_TOKEN] += eob_val != NO_EOB;</span>
<span class="lineNum">     499 </span>            :       }
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :       token_cache[scan[c]] = av1_pt_energy_class[token];</span>
<span class="lineNum">     502 </span>            :     }
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :     ++c;</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :     pt = get_coef_context(nb, token_cache, AOMMIN(c, eob - 1));</span>
<span class="lineNum">     505 </span>            :   }
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span>            : #if CONFIG_COEF_INTERLEAVE
<span class="lineNum">     508 </span>            :   t-&gt;token = EOSB_TOKEN;
<span class="lineNum">     509 </span>            :   t++;
<span class="lineNum">     510 </span>            : #endif
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :   *tp = t;</span>
<span class="lineNum">     513 </span>            : 
<span class="lineNum">     514 </span>            : #if CONFIG_ADAPT_SCAN
<span class="lineNum">     515 </span>            :   // Since dqcoeff is not available here, we pass qcoeff into
<span class="lineNum">     516 </span>            :   // av1_update_scan_count_facade(). The update behavior should be the same
<span class="lineNum">     517 </span>            :   // because av1_update_scan_count_facade() only cares if coefficients are zero
<span class="lineNum">     518 </span>            :   // or not.
<span class="lineNum">     519 </span>            :   av1_update_scan_count_facade((AV1_COMMON *)cm, td-&gt;counts, tx_size, tx_type,
<span class="lineNum">     520 </span>            :                                qcoeff, c);
<span class="lineNum">     521 </span>            : #endif
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :   av1_set_contexts(xd, pd, plane, tx_size, c &gt; 0, blk_col, blk_row);</span>
<span class="lineNum">     524 </span>            : #else   // !CONFIG_PVQ
<span class="lineNum">     525 </span>            :   tokenize_pvq(plane, block, blk_row, blk_col, plane_bsize, tx_size, arg);
<span class="lineNum">     526 </span>            : #endif  // !CONFIG_PVQ
<span class="lineNum">     527 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span>            : struct is_skippable_args {
<span class="lineNum">     530 </span>            :   uint16_t *eobs;
<a name="531"><span class="lineNum">     531 </span>            :   int *skippable;</a>
<span class="lineNum">     532 </span>            : };
<span class="lineNum">     533 </span><span class="lineNoCov">          0 : static void is_skippable(int plane, int block, int blk_row, int blk_col,</span>
<span class="lineNum">     534 </span>            :                          BLOCK_SIZE plane_bsize, TX_SIZE tx_size, void *argv) {
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :   struct is_skippable_args *args = argv;</span>
<span class="lineNum">     536 </span>            :   (void)plane;
<span class="lineNum">     537 </span>            :   (void)plane_bsize;
<span class="lineNum">     538 </span>            :   (void)tx_size;
<span class="lineNum">     539 </span>            :   (void)blk_row;
<span class="lineNum">     540 </span>            :   (void)blk_col;
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :   args-&gt;skippable[0] &amp;= (!args-&gt;eobs[block]);</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     543 </span>            : 
<a name="544"><span class="lineNum">     544 </span>            : // TODO(yaowu): rewrite and optimize this function to remove the usage of</a>
<span class="lineNum">     545 </span>            : //              av1_foreach_transform_block() and simplify is_skippable().
<span class="lineNum">     546 </span><span class="lineNoCov">          0 : int av1_is_skippable_in_plane(MACROBLOCK *x, BLOCK_SIZE bsize, int plane) {</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :   int result = 1;</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :   struct is_skippable_args args = { x-&gt;plane[plane].eobs, &amp;result };</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :   av1_foreach_transformed_block_in_plane(&amp;x-&gt;e_mbd, bsize, plane, is_skippable,</span>
<span class="lineNum">     550 </span>            :                                          &amp;args);
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">     552 </span>            : }
<a name="553"><span class="lineNum">     553 </span>            : </a>
<span class="lineNum">     554 </span>            : #if CONFIG_VAR_TX
<span class="lineNum">     555 </span><span class="lineNoCov">          0 : void tokenize_vartx(ThreadData *td, TOKENEXTRA **t, RUN_TYPE dry_run,</span>
<span class="lineNum">     556 </span>            :                     TX_SIZE tx_size, BLOCK_SIZE plane_bsize, int blk_row,
<span class="lineNum">     557 </span>            :                     int blk_col, int block, int plane, void *arg) {
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :   MACROBLOCK *const x = &amp;td-&gt;mb;</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :   MACROBLOCKD *const xd = &amp;x-&gt;e_mbd;</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :   MB_MODE_INFO *const mbmi = &amp;xd-&gt;mi[0]-&gt;mbmi;</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :   const struct macroblockd_plane *const pd = &amp;xd-&gt;plane[plane];</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :   const BLOCK_SIZE bsize = txsize_to_bsize[tx_size];</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :   const int tx_row = blk_row &gt;&gt; (1 - pd-&gt;subsampling_y);</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :   const int tx_col = blk_col &gt;&gt; (1 - pd-&gt;subsampling_x);</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :   const int max_blocks_high = max_block_high(xd, plane_bsize, plane);</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :   const int max_blocks_wide = max_block_wide(xd, plane_bsize, plane);</span>
<span class="lineNum">     567 </span>            :   TX_SIZE plane_tx_size;
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :   if (blk_row &gt;= max_blocks_high || blk_col &gt;= max_blocks_wide) return;</span>
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :   plane_tx_size =</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :       plane ? uv_txsize_lookup[bsize][mbmi-&gt;inter_tx_size[tx_row][tx_col]][0][0]</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :             : mbmi-&gt;inter_tx_size[tx_row][tx_col];</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :   if (tx_size == plane_tx_size) {</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :     plane_bsize = get_plane_block_size(mbmi-&gt;sb_type, pd);</span>
<span class="lineNum">     577 </span>            : #if CONFIG_LV_MAP
<span class="lineNum">     578 </span>            :     if (!dry_run) {
<span class="lineNum">     579 </span>            :       av1_update_and_record_txb_context(plane, block, blk_row, blk_col,
<span class="lineNum">     580 </span>            :                                         plane_bsize, tx_size, arg);
<span class="lineNum">     581 </span>            :     } else if (dry_run == DRY_RUN_NORMAL) {
<span class="lineNum">     582 </span>            :       av1_update_txb_context_b(plane, block, blk_row, blk_col, plane_bsize,
<span class="lineNum">     583 </span>            :                                tx_size, arg);
<span class="lineNum">     584 </span>            :     } else {
<span class="lineNum">     585 </span>            :       printf(&quot;DRY_RUN_COSTCOEFFS is not supported yet\n&quot;);
<span class="lineNum">     586 </span>            :       assert(0);
<span class="lineNum">     587 </span>            :     }
<span class="lineNum">     588 </span>            : #else
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :     if (!dry_run)</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :       tokenize_b(plane, block, blk_row, blk_col, plane_bsize, tx_size, arg);</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :     else if (dry_run == DRY_RUN_NORMAL)</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :       set_entropy_context_b(plane, block, blk_row, blk_col, plane_bsize,</span>
<span class="lineNum">     593 </span>            :                             tx_size, arg);
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :     else if (dry_run == DRY_RUN_COSTCOEFFS)</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :       cost_coeffs_b(plane, block, blk_row, blk_col, plane_bsize, tx_size, arg);</span>
<span class="lineNum">     596 </span>            : #endif
<span class="lineNum">     597 </span>            :   } else {
<span class="lineNum">     598 </span>            :     // Half the block size in transform block unit.
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :     const TX_SIZE sub_txs = sub_tx_size_map[tx_size];</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :     const int bsl = tx_size_wide_unit[sub_txs];</span>
<span class="lineNum">     601 </span>            :     int i;
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :     assert(bsl &gt; 0);</span>
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; 4; ++i) {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :       const int offsetr = blk_row + ((i &gt;&gt; 1) * bsl);</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :       const int offsetc = blk_col + ((i &amp; 0x01) * bsl);</span>
<span class="lineNum">     608 </span>            : 
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :       int step = tx_size_wide_unit[sub_txs] * tx_size_high_unit[sub_txs];</span>
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :       if (offsetr &gt;= max_blocks_high || offsetc &gt;= max_blocks_wide) continue;</span>
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :       tokenize_vartx(td, t, dry_run, sub_txs, plane_bsize, offsetr, offsetc,</span>
<span class="lineNum">     614 </span>            :                      block, plane, arg);
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :       block += step;</span>
<span class="lineNum">     616 </span>            :     }
<span class="lineNum">     617 </span>            :   }
<a name="618"><span class="lineNum">     618 </span>            : }</a>
<span class="lineNum">     619 </span>            : 
<span class="lineNum">     620 </span><span class="lineNoCov">          0 : void av1_tokenize_sb_vartx(const AV1_COMP *cpi, ThreadData *td, TOKENEXTRA **t,</span>
<span class="lineNum">     621 </span>            :                            RUN_TYPE dry_run, int mi_row, int mi_col,
<span class="lineNum">     622 </span>            :                            BLOCK_SIZE bsize, int *rate) {
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :   const AV1_COMMON *const cm = &amp;cpi-&gt;common;</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :   MACROBLOCK *const x = &amp;td-&gt;mb;</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :   MACROBLOCKD *const xd = &amp;x-&gt;e_mbd;</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :   MB_MODE_INFO *const mbmi = &amp;xd-&gt;mi[0]-&gt;mbmi;</span>
<span class="lineNum">     627 </span>            : #if CONFIG_LV_MAP
<span class="lineNum">     628 </span>            :   (void)t;
<span class="lineNum">     629 </span>            : #else
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :   TOKENEXTRA *t_backup = *t;</span>
<span class="lineNum">     631 </span>            : #endif
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :   const int ctx = av1_get_skip_context(xd);</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :   const int skip_inc =</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :       !segfeature_active(&amp;cm-&gt;seg, mbmi-&gt;segment_id, SEG_LVL_SKIP);</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :   struct tokenize_b_args arg = { cpi, td, t, 0 };</span>
<span class="lineNum">     636 </span>            :   int plane;
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :   if (mi_row &gt;= cm-&gt;mi_rows || mi_col &gt;= cm-&gt;mi_cols) return;</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :   if (mbmi-&gt;skip) {</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :     if (!dry_run) td-&gt;counts-&gt;skip[ctx][1] += skip_inc;</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :     av1_reset_skip_context(xd, mi_row, mi_col, bsize);</span>
<span class="lineNum">     642 </span>            : #if !CONFIG_LV_MAP
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :     if (dry_run) *t = t_backup;</span>
<span class="lineNum">     644 </span>            : #endif
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     646 </span>            :   }
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :   if (!dry_run) td-&gt;counts-&gt;skip[ctx][0] += skip_inc;</span>
<span class="lineNum">     649 </span>            : #if !CONFIG_LV_MAP
<span class="lineNum">     650 </span>            :   else
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :     *t = t_backup;</span>
<span class="lineNum">     652 </span>            : #endif
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :   for (plane = 0; plane &lt; MAX_MB_PLANE; ++plane) {</span>
<span class="lineNum">     655 </span>            : #if CONFIG_CB4X4
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :     if (!is_chroma_reference(mi_row, mi_col, bsize,</span>
<span class="lineNum">     657 </span>            :                              xd-&gt;plane[plane].subsampling_x,
<span class="lineNum">     658 </span>            :                              xd-&gt;plane[plane].subsampling_y)) {
<span class="lineNum">     659 </span>            : #if !CONFIG_PVQ || !CONFIG_LV_MAP
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :       if (!dry_run) {</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :         (*t)-&gt;token = EOSB_TOKEN;</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :         (*t)++;</span>
<span class="lineNum">     663 </span>            :       }
<span class="lineNum">     664 </span>            : #endif
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     666 </span>            :     }
<span class="lineNum">     667 </span>            : #endif
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :     const struct macroblockd_plane *const pd = &amp;xd-&gt;plane[plane];</span>
<span class="lineNum">     669 </span>            : #if CONFIG_CB4X4 &amp;&amp; !CONFIG_CHROMA_2X2
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :     const BLOCK_SIZE plane_bsize =</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :         AOMMAX(BLOCK_4X4, get_plane_block_size(bsize, pd));</span>
<span class="lineNum">     672 </span>            : #else
<span class="lineNum">     673 </span>            :     const BLOCK_SIZE plane_bsize = get_plane_block_size(bsize, pd);
<span class="lineNum">     674 </span>            : #endif
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :     const int mi_width = block_size_wide[plane_bsize] &gt;&gt; tx_size_wide_log2[0];</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :     const int mi_height = block_size_high[plane_bsize] &gt;&gt; tx_size_wide_log2[0];</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :     const TX_SIZE max_tx_size = get_vartx_max_txsize(mbmi, plane_bsize);</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :     const BLOCK_SIZE txb_size = txsize_to_bsize[max_tx_size];</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :     int bw = block_size_wide[txb_size] &gt;&gt; tx_size_wide_log2[0];</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :     int bh = block_size_high[txb_size] &gt;&gt; tx_size_wide_log2[0];</span>
<span class="lineNum">     681 </span>            :     int idx, idy;
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :     int block = 0;</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :     int step = tx_size_wide_unit[max_tx_size] * tx_size_high_unit[max_tx_size];</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :     for (idy = 0; idy &lt; mi_height; idy += bh) {</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :       for (idx = 0; idx &lt; mi_width; idx += bw) {</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :         tokenize_vartx(td, t, dry_run, max_tx_size, plane_bsize, idy, idx,</span>
<span class="lineNum">     687 </span>            :                        block, plane, &amp;arg);
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :         block += step;</span>
<span class="lineNum">     689 </span>            :       }
<span class="lineNum">     690 </span>            :     }
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span>            : #if !CONFIG_LV_MAP
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :     if (!dry_run) {</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :       (*t)-&gt;token = EOSB_TOKEN;</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :       (*t)++;</span>
<span class="lineNum">     696 </span>            :     }
<span class="lineNum">     697 </span>            : #endif
<span class="lineNum">     698 </span>            :   }
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :   if (rate) *rate += arg.this_rate;</span>
<span class="lineNum">     700 </span>            : }
<a name="701"><span class="lineNum">     701 </span>            : #endif  // CONFIG_VAR_TX</a>
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span><span class="lineNoCov">          0 : void av1_tokenize_sb(const AV1_COMP *cpi, ThreadData *td, TOKENEXTRA **t,</span>
<span class="lineNum">     704 </span>            :                      RUN_TYPE dry_run, BLOCK_SIZE bsize, int *rate,
<span class="lineNum">     705 </span>            :                      const int mi_row, const int mi_col) {
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :   const AV1_COMMON *const cm = &amp;cpi-&gt;common;</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :   MACROBLOCK *const x = &amp;td-&gt;mb;</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :   MACROBLOCKD *const xd = &amp;x-&gt;e_mbd;</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :   MB_MODE_INFO *const mbmi = &amp;xd-&gt;mi[0]-&gt;mbmi;</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :   const int ctx = av1_get_skip_context(xd);</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :   const int skip_inc =</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :       !segfeature_active(&amp;cm-&gt;seg, mbmi-&gt;segment_id, SEG_LVL_SKIP);</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :   struct tokenize_b_args arg = { cpi, td, t, 0 };</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :   if (mbmi-&gt;skip) {</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :     if (!dry_run) td-&gt;counts-&gt;skip[ctx][1] += skip_inc;</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :     av1_reset_skip_context(xd, mi_row, mi_col, bsize);</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     718 </span>            :   }
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :   if (!dry_run) {</span>
<span class="lineNum">     721 </span>            : #if CONFIG_COEF_INTERLEAVE
<span class="lineNum">     722 </span>            :     td-&gt;counts-&gt;skip[ctx][0] += skip_inc;
<span class="lineNum">     723 </span>            :     av1_foreach_transformed_block_interleave(xd, bsize, tokenize_b, &amp;arg);
<span class="lineNum">     724 </span>            : #else
<span class="lineNum">     725 </span>            :     int plane;
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :     td-&gt;counts-&gt;skip[ctx][0] += skip_inc;</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :     for (plane = 0; plane &lt; MAX_MB_PLANE; ++plane) {</span>
<span class="lineNum">     729 </span>            : #if CONFIG_CB4X4
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :       if (!is_chroma_reference(mi_row, mi_col, bsize,</span>
<span class="lineNum">     731 </span>            :                                xd-&gt;plane[plane].subsampling_x,
<span class="lineNum">     732 </span>            :                                xd-&gt;plane[plane].subsampling_y)) {
<span class="lineNum">     733 </span>            : #if !CONFIG_PVQ
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :         (*t)-&gt;token = EOSB_TOKEN;</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :         (*t)++;</span>
<span class="lineNum">     736 </span>            : #endif
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     738 </span>            :       }
<span class="lineNum">     739 </span>            : #else
<span class="lineNum">     740 </span>            :       (void)mi_row;
<span class="lineNum">     741 </span>            :       (void)mi_col;
<span class="lineNum">     742 </span>            : #endif
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :       av1_foreach_transformed_block_in_plane(xd, bsize, plane, tokenize_b,</span>
<span class="lineNum">     744 </span>            :                                              &amp;arg);
<span class="lineNum">     745 </span>            : #if !CONFIG_PVQ
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :       (*t)-&gt;token = EOSB_TOKEN;</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :       (*t)++;</span>
<span class="lineNum">     748 </span>            : #endif  // !CONFIG_PVQ
<span class="lineNum">     749 </span>            :     }
<span class="lineNum">     750 </span>            : #endif
<span class="lineNum">     751 </span>            :   }
<span class="lineNum">     752 </span>            : #if !CONFIG_PVQ
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :   else if (dry_run == DRY_RUN_NORMAL) {</span>
<span class="lineNum">     754 </span>            :     int plane;
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     for (plane = 0; plane &lt; MAX_MB_PLANE; ++plane) {</span>
<span class="lineNum">     756 </span>            : #if CONFIG_CB4X4
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :       if (!is_chroma_reference(mi_row, mi_col, bsize,</span>
<span class="lineNum">     758 </span>            :                                xd-&gt;plane[plane].subsampling_x,
<span class="lineNum">     759 </span>            :                                xd-&gt;plane[plane].subsampling_y))
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     761 </span>            : #else
<span class="lineNum">     762 </span>            :       (void)mi_row;
<span class="lineNum">     763 </span>            :       (void)mi_col;
<span class="lineNum">     764 </span>            : #endif
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :       av1_foreach_transformed_block_in_plane(xd, bsize, plane,</span>
<span class="lineNum">     766 </span>            :                                              set_entropy_context_b, &amp;arg);
<span class="lineNum">     767 </span>            :     }
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :   } else if (dry_run == DRY_RUN_COSTCOEFFS) {</span>
<span class="lineNum">     769 </span>            :     int plane;
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :     for (plane = 0; plane &lt; MAX_MB_PLANE; ++plane) {</span>
<span class="lineNum">     771 </span>            : #if CONFIG_CB4X4
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :       if (!is_chroma_reference(mi_row, mi_col, bsize,</span>
<span class="lineNum">     773 </span>            :                                xd-&gt;plane[plane].subsampling_x,
<span class="lineNum">     774 </span>            :                                xd-&gt;plane[plane].subsampling_y))
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     776 </span>            : #else
<span class="lineNum">     777 </span>            :       (void)mi_row;
<span class="lineNum">     778 </span>            :       (void)mi_col;
<span class="lineNum">     779 </span>            : #endif
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :       av1_foreach_transformed_block_in_plane(xd, bsize, plane, cost_coeffs_b,</span>
<span class="lineNum">     781 </span>            :                                              &amp;arg);
<span class="lineNum">     782 </span>            :     }
<span class="lineNum">     783 </span>            :   }
<span class="lineNum">     784 </span>            : #endif  // !CONFIG_PVQ
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :   if (rate) *rate += arg.this_rate;</span>
<span class="lineNum">     787 </span>            : }
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span>            : #if CONFIG_SUPERTX
<span class="lineNum">     790 </span>            : void av1_tokenize_sb_supertx(const AV1_COMP *cpi, ThreadData *td,
<span class="lineNum">     791 </span>            :                              TOKENEXTRA **t, RUN_TYPE dry_run, int mi_row,
<span class="lineNum">     792 </span>            :                              int mi_col, BLOCK_SIZE bsize, int *rate) {
<span class="lineNum">     793 </span>            :   const AV1_COMMON *const cm = &amp;cpi-&gt;common;
<span class="lineNum">     794 </span>            :   MACROBLOCKD *const xd = &amp;td-&gt;mb.e_mbd;
<span class="lineNum">     795 </span>            :   MB_MODE_INFO *const mbmi = &amp;xd-&gt;mi[0]-&gt;mbmi;
<span class="lineNum">     796 </span>            :   TOKENEXTRA *t_backup = *t;
<span class="lineNum">     797 </span>            :   const int ctx = av1_get_skip_context(xd);
<span class="lineNum">     798 </span>            :   const int skip_inc =
<span class="lineNum">     799 </span>            :       !segfeature_active(&amp;cm-&gt;seg, mbmi-&gt;segment_id_supertx, SEG_LVL_SKIP);
<span class="lineNum">     800 </span>            :   struct tokenize_b_args arg = { cpi, td, t, 0 };
<span class="lineNum">     801 </span>            :   if (mbmi-&gt;skip) {
<span class="lineNum">     802 </span>            :     if (!dry_run) td-&gt;counts-&gt;skip[ctx][1] += skip_inc;
<span class="lineNum">     803 </span>            :     av1_reset_skip_context(xd, mi_row, mi_col, bsize);
<span class="lineNum">     804 </span>            :     if (dry_run) *t = t_backup;
<span class="lineNum">     805 </span>            :     return;
<span class="lineNum">     806 </span>            :   }
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span>            :   if (!dry_run) {
<span class="lineNum">     809 </span>            :     int plane;
<span class="lineNum">     810 </span>            :     td-&gt;counts-&gt;skip[ctx][0] += skip_inc;
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span>            :     for (plane = 0; plane &lt; MAX_MB_PLANE; ++plane) {
<span class="lineNum">     813 </span>            :       av1_foreach_transformed_block_in_plane(xd, bsize, plane, tokenize_b,
<span class="lineNum">     814 </span>            :                                              &amp;arg);
<span class="lineNum">     815 </span>            :       (*t)-&gt;token = EOSB_TOKEN;
<span class="lineNum">     816 </span>            :       (*t)++;
<span class="lineNum">     817 </span>            :     }
<span class="lineNum">     818 </span>            :   } else if (dry_run == DRY_RUN_NORMAL) {
<span class="lineNum">     819 </span>            :     int plane;
<span class="lineNum">     820 </span>            :     for (plane = 0; plane &lt; MAX_MB_PLANE; ++plane)
<span class="lineNum">     821 </span>            :       av1_foreach_transformed_block_in_plane(xd, bsize, plane,
<span class="lineNum">     822 </span>            :                                              set_entropy_context_b, &amp;arg);
<span class="lineNum">     823 </span>            :     *t = t_backup;
<span class="lineNum">     824 </span>            :   } else if (dry_run == DRY_RUN_COSTCOEFFS) {
<span class="lineNum">     825 </span>            :     int plane;
<span class="lineNum">     826 </span>            :     for (plane = 0; plane &lt; MAX_MB_PLANE; ++plane)
<span class="lineNum">     827 </span>            :       av1_foreach_transformed_block_in_plane(xd, bsize, plane, cost_coeffs_b,
<span class="lineNum">     828 </span>            :                                              &amp;arg);
<span class="lineNum">     829 </span>            :   }
<span class="lineNum">     830 </span>            :   if (rate) *rate += arg.this_rate;
<span class="lineNum">     831 </span>            : }
<span class="lineNum">     832 </span>            : #endif  // CONFIG_SUPERTX
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

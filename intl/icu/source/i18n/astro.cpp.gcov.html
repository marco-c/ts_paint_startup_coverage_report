<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - intl/icu/source/i18n/astro.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">intl/icu/source/i18n</a> - astro.cpp<span style="font-size: 80%;"> (source / <a href="astro.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">292</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">67</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // Â© 2016 and later: Unicode, Inc. and others.</a>
<span class="lineNum">       2 </span>            : // License &amp; terms of use: http://www.unicode.org/copyright.html
<span class="lineNum">       3 </span>            : /************************************************************************
<span class="lineNum">       4 </span>            :  * Copyright (C) 1996-2012, International Business Machines Corporation
<span class="lineNum">       5 </span>            :  * and others. All Rights Reserved.
<span class="lineNum">       6 </span>            :  ************************************************************************
<span class="lineNum">       7 </span>            :  *  2003-nov-07   srl       Port from Java
<span class="lineNum">       8 </span>            :  */
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : #include &quot;astro.h&quot;
<span class="lineNum">      11 </span>            : 
<span class="lineNum">      12 </span>            : #if !UCONFIG_NO_FORMATTING
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            : #include &quot;unicode/calendar.h&quot;
<span class="lineNum">      15 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      16 </span>            : #include &lt;float.h&gt;
<span class="lineNum">      17 </span>            : #include &quot;unicode/putil.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;uhash.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;umutex.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;ucln_in.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;putilimp.h&quot;
<span class="lineNum">      22 </span>            : #include &lt;stdio.h&gt;  // for toString()
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #if defined (PI) 
<span class="lineNum">      25 </span>            : #undef PI
<span class="lineNum">      26 </span>            : #endif
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #ifdef U_DEBUG_ASTRO
<span class="lineNum">      29 </span>            : # include &quot;uresimp.h&quot; // for debugging
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : static void debug_astro_loc(const char *f, int32_t l)
<span class="lineNum">      32 </span>            : {
<span class="lineNum">      33 </span>            :   fprintf(stderr, &quot;%s:%d: &quot;, f, l);
<span class="lineNum">      34 </span>            : }
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : static void debug_astro_msg(const char *pat, ...)
<span class="lineNum">      37 </span>            : {
<span class="lineNum">      38 </span>            :   va_list ap;
<span class="lineNum">      39 </span>            :   va_start(ap, pat);
<span class="lineNum">      40 </span>            :   vfprintf(stderr, pat, ap);
<span class="lineNum">      41 </span>            :   fflush(stderr);
<span class="lineNum">      42 </span>            : }
<span class="lineNum">      43 </span>            : #include &quot;unicode/datefmt.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;unicode/ustring.h&quot;
<span class="lineNum">      45 </span>            : static const char * debug_astro_date(UDate d) {
<span class="lineNum">      46 </span>            :   static char gStrBuf[1024];
<span class="lineNum">      47 </span>            :   static DateFormat *df = NULL;
<span class="lineNum">      48 </span>            :   if(df == NULL) {
<span class="lineNum">      49 </span>            :     df = DateFormat::createDateTimeInstance(DateFormat::MEDIUM, DateFormat::MEDIUM, Locale::getUS());
<span class="lineNum">      50 </span>            :     df-&gt;adoptTimeZone(TimeZone::getGMT()-&gt;clone());
<span class="lineNum">      51 </span>            :   }
<span class="lineNum">      52 </span>            :   UnicodeString str;
<span class="lineNum">      53 </span>            :   df-&gt;format(d,str);
<span class="lineNum">      54 </span>            :   u_austrncpy(gStrBuf,str.getTerminatedBuffer(),sizeof(gStrBuf)-1);
<span class="lineNum">      55 </span>            :   return gStrBuf;
<span class="lineNum">      56 </span>            : }
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            : // must use double parens, i.e.:  U_DEBUG_ASTRO_MSG((&quot;four is: %d&quot;,4));
<span class="lineNum">      59 </span>            : #define U_DEBUG_ASTRO_MSG(x) {debug_astro_loc(__FILE__,__LINE__);debug_astro_msg x;}
<span class="lineNum">      60 </span>            : #else
<span class="lineNum">      61 </span>            : #define U_DEBUG_ASTRO_MSG(x)
<a name="62"><span class="lineNum">      62 </span>            : #endif</a>
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span><span class="lineNoCov">          0 : static inline UBool isINVALID(double d) {</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   return(uprv_isNaN(d));</span>
<span class="lineNum">      66 </span>            : }
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : static UMutex ccLock = U_MUTEX_INITIALIZER;
<a name="69"><span class="lineNum">      69 </span>            : </a>
<span class="lineNum">      70 </span>            : U_CDECL_BEGIN
<span class="lineNum">      71 </span><span class="lineNoCov">          0 : static UBool calendar_astro_cleanup(void) {</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :   return TRUE;</span>
<span class="lineNum">      73 </span>            : }
<span class="lineNum">      74 </span>            : U_CDECL_END
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span>            : U_NAMESPACE_BEGIN
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : /**
<span class="lineNum">      79 </span>            :  * The number of standard hours in one sidereal day.
<span class="lineNum">      80 </span>            :  * Approximately 24.93.
<span class="lineNum">      81 </span>            :  * @internal
<span class="lineNum">      82 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">      83 </span>            :  */
<span class="lineNum">      84 </span>            : #define SIDEREAL_DAY (23.93446960027)
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span>            : /**
<span class="lineNum">      87 </span>            :  * The number of sidereal hours in one mean solar day.
<span class="lineNum">      88 </span>            :  * Approximately 24.07.
<span class="lineNum">      89 </span>            :  * @internal
<span class="lineNum">      90 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">      91 </span>            :  */
<span class="lineNum">      92 </span>            : #define SOLAR_DAY  (24.065709816)
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            : /**
<span class="lineNum">      95 </span>            :  * The average number of solar days from one new moon to the next.  This is the time
<span class="lineNum">      96 </span>            :  * it takes for the moon to return the same ecliptic longitude as the sun.
<span class="lineNum">      97 </span>            :  * It is longer than the sidereal month because the sun's longitude increases
<span class="lineNum">      98 </span>            :  * during the year due to the revolution of the earth around the sun.
<span class="lineNum">      99 </span>            :  * Approximately 29.53.
<span class="lineNum">     100 </span>            :  *
<span class="lineNum">     101 </span>            :  * @see #SIDEREAL_MONTH
<span class="lineNum">     102 </span>            :  * @internal
<span class="lineNum">     103 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     104 </span>            :  */
<span class="lineNum">     105 </span>            : const double CalendarAstronomer::SYNODIC_MONTH  = 29.530588853;
<span class="lineNum">     106 </span>            : 
<span class="lineNum">     107 </span>            : /**
<span class="lineNum">     108 </span>            :  * The average number of days it takes
<span class="lineNum">     109 </span>            :  * for the moon to return to the same ecliptic longitude relative to the
<span class="lineNum">     110 </span>            :  * stellar background.  This is referred to as the sidereal month.
<span class="lineNum">     111 </span>            :  * It is shorter than the synodic month due to
<span class="lineNum">     112 </span>            :  * the revolution of the earth around the sun.
<span class="lineNum">     113 </span>            :  * Approximately 27.32.
<span class="lineNum">     114 </span>            :  *
<span class="lineNum">     115 </span>            :  * @see #SYNODIC_MONTH
<span class="lineNum">     116 </span>            :  * @internal
<span class="lineNum">     117 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     118 </span>            :  */
<span class="lineNum">     119 </span>            : #define SIDEREAL_MONTH  27.32166
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span>            : /**
<span class="lineNum">     122 </span>            :  * The average number number of days between successive vernal equinoxes.
<span class="lineNum">     123 </span>            :  * Due to the precession of the earth's
<span class="lineNum">     124 </span>            :  * axis, this is not precisely the same as the sidereal year.
<span class="lineNum">     125 </span>            :  * Approximately 365.24
<span class="lineNum">     126 </span>            :  *
<span class="lineNum">     127 </span>            :  * @see #SIDEREAL_YEAR
<span class="lineNum">     128 </span>            :  * @internal
<span class="lineNum">     129 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     130 </span>            :  */
<span class="lineNum">     131 </span>            : #define TROPICAL_YEAR  365.242191
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            : /**
<span class="lineNum">     134 </span>            :  * The average number of days it takes
<span class="lineNum">     135 </span>            :  * for the sun to return to the same position against the fixed stellar
<span class="lineNum">     136 </span>            :  * background.  This is the duration of one orbit of the earth about the sun
<span class="lineNum">     137 </span>            :  * as it would appear to an outside observer.
<span class="lineNum">     138 </span>            :  * Due to the precession of the earth's
<span class="lineNum">     139 </span>            :  * axis, this is not precisely the same as the tropical year.
<span class="lineNum">     140 </span>            :  * Approximately 365.25.
<span class="lineNum">     141 </span>            :  *
<span class="lineNum">     142 </span>            :  * @see #TROPICAL_YEAR
<span class="lineNum">     143 </span>            :  * @internal
<span class="lineNum">     144 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     145 </span>            :  */
<span class="lineNum">     146 </span>            : #define SIDEREAL_YEAR  365.25636
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     149 </span>            : // Time-related constants
<span class="lineNum">     150 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            : /**
<span class="lineNum">     153 </span>            :  * The number of milliseconds in one second.
<span class="lineNum">     154 </span>            :  * @internal
<span class="lineNum">     155 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     156 </span>            :  */
<span class="lineNum">     157 </span>            : #define SECOND_MS  U_MILLIS_PER_SECOND
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            : /**
<span class="lineNum">     160 </span>            :  * The number of milliseconds in one minute.
<span class="lineNum">     161 </span>            :  * @internal
<span class="lineNum">     162 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     163 </span>            :  */
<span class="lineNum">     164 </span>            : #define MINUTE_MS  U_MILLIS_PER_MINUTE
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            : /**
<span class="lineNum">     167 </span>            :  * The number of milliseconds in one hour.
<span class="lineNum">     168 </span>            :  * @internal
<span class="lineNum">     169 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     170 </span>            :  */
<span class="lineNum">     171 </span>            : #define HOUR_MS   U_MILLIS_PER_HOUR
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            : /**
<span class="lineNum">     174 </span>            :  * The number of milliseconds in one day.
<span class="lineNum">     175 </span>            :  * @internal
<span class="lineNum">     176 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     177 </span>            :  */
<span class="lineNum">     178 </span>            : #define DAY_MS U_MILLIS_PER_DAY
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span>            : /**
<span class="lineNum">     181 </span>            :  * The start of the julian day numbering scheme used by astronomers, which
<span class="lineNum">     182 </span>            :  * is 1/1/4713 BC (Julian), 12:00 GMT.  This is given as the number of milliseconds
<span class="lineNum">     183 </span>            :  * since 1/1/1970 AD (Gregorian), a negative number.
<span class="lineNum">     184 </span>            :  * Note that julian day numbers and
<span class="lineNum">     185 </span>            :  * the Julian calendar are &lt;em&gt;not&lt;/em&gt; the same thing.  Also note that
<span class="lineNum">     186 </span>            :  * julian days start at &lt;em&gt;noon&lt;/em&gt;, not midnight.
<span class="lineNum">     187 </span>            :  * @internal
<span class="lineNum">     188 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     189 </span>            :  */
<span class="lineNum">     190 </span>            : #define JULIAN_EPOCH_MS  -210866760000000.0
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span>            : /**
<span class="lineNum">     194 </span>            :  * Milliseconds value for 0.0 January 2000 AD.
<span class="lineNum">     195 </span>            :  */
<span class="lineNum">     196 </span>            : #define EPOCH_2000_MS  946598400000.0
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     199 </span>            : // Assorted private data used for conversions
<span class="lineNum">     200 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            : // My own copies of these so compilers are more likely to optimize them away
<span class="lineNum">     203 </span>            : const double CalendarAstronomer::PI = 3.14159265358979323846;
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span>            : #define CalendarAstronomer_PI2  (CalendarAstronomer::PI*2.0)
<span class="lineNum">     206 </span>            : #define RAD_HOUR  ( 12 / CalendarAstronomer::PI )     // radians -&gt; hours
<span class="lineNum">     207 </span>            : #define DEG_RAD ( CalendarAstronomer::PI / 180 )      // degrees -&gt; radians
<span class="lineNum">     208 </span>            : #define RAD_DEG  ( 180 / CalendarAstronomer::PI )     // radians -&gt; degrees
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            : /***
<span class="lineNum">     211 </span>            :  * Given 'value', add or subtract 'range' until 0 &lt;= 'value' &lt; range.
<a name="212"><span class="lineNum">     212 </span>            :  * The modulus operator.</a>
<span class="lineNum">     213 </span>            :  */
<span class="lineNum">     214 </span><span class="lineNoCov">          0 : inline static double normalize(double value, double range)  {</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :     return value - range * ClockMath::floorDivide(value, range);</span>
<span class="lineNum">     216 </span>            : }
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span>            : /**
<span class="lineNum">     219 </span>            :  * Normalize an angle so that it's in the range 0 - 2pi.
<span class="lineNum">     220 </span>            :  * For positive angles this is just (angle % 2pi), but the Java
<a name="221"><span class="lineNum">     221 </span>            :  * mod operator doesn't work that way for negative numbers....</a>
<span class="lineNum">     222 </span>            :  */
<span class="lineNum">     223 </span><span class="lineNoCov">          0 : inline static double norm2PI(double angle)  {</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :     return normalize(angle, CalendarAstronomer::PI * 2.0);</span>
<span class="lineNum">     225 </span>            : }
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span>            : /**
<a name="228"><span class="lineNum">     228 </span>            :  * Normalize an angle into the range -PI - PI</a>
<span class="lineNum">     229 </span>            :  */
<span class="lineNum">     230 </span><span class="lineNoCov">          0 : inline static  double normPI(double angle)  {</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :     return normalize(angle + CalendarAstronomer::PI, CalendarAstronomer::PI * 2.0) - CalendarAstronomer::PI;</span>
<span class="lineNum">     232 </span>            : }
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     235 </span>            : // Constructors
<span class="lineNum">     236 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span>            : /**
<span class="lineNum">     239 </span>            :  * Construct a new &lt;code&gt;CalendarAstronomer&lt;/code&gt; object that is initialized to
<span class="lineNum">     240 </span>            :  * the current date and time.
<span class="lineNum">     241 </span>            :  * @internal
<a name="242"><span class="lineNum">     242 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     243 </span>            :  */
<span class="lineNum">     244 </span><span class="lineNoCov">          0 : CalendarAstronomer::CalendarAstronomer():</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :   fTime(Calendar::getNow()), fLongitude(0.0), fLatitude(0.0), fGmtOffset(0.0), moonPosition(0,0), moonPositionSet(FALSE) {</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :   clearCache();</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span>            : /**
<span class="lineNum">     250 </span>            :  * Construct a new &lt;code&gt;CalendarAstronomer&lt;/code&gt; object that is initialized to
<span class="lineNum">     251 </span>            :  * the specified date and time.
<span class="lineNum">     252 </span>            :  * @internal
<a name="253"><span class="lineNum">     253 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     254 </span>            :  */
<span class="lineNum">     255 </span><span class="lineNoCov">          0 : CalendarAstronomer::CalendarAstronomer(UDate d): fTime(d), fLongitude(0.0), fLatitude(0.0), fGmtOffset(0.0), moonPosition(0,0), moonPositionSet(FALSE) {</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   clearCache();</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span>            : /**
<span class="lineNum">     260 </span>            :  * Construct a new &lt;code&gt;CalendarAstronomer&lt;/code&gt; object with the given
<span class="lineNum">     261 </span>            :  * latitude and longitude.  The object's time is set to the current
<span class="lineNum">     262 </span>            :  * date and time.
<span class="lineNum">     263 </span>            :  * &lt;p&gt;
<span class="lineNum">     264 </span>            :  * @param longitude The desired longitude, in &lt;em&gt;degrees&lt;/em&gt; east of
<span class="lineNum">     265 </span>            :  *                  the Greenwich meridian.
<span class="lineNum">     266 </span>            :  *
<span class="lineNum">     267 </span>            :  * @param latitude  The desired latitude, in &lt;em&gt;degrees&lt;/em&gt;.  Positive
<span class="lineNum">     268 </span>            :  *                  values signify North, negative South.
<span class="lineNum">     269 </span>            :  *
<span class="lineNum">     270 </span>            :  * @see java.util.Date#getTime()
<span class="lineNum">     271 </span>            :  * @internal
<a name="272"><span class="lineNum">     272 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     273 </span>            :  */
<span class="lineNum">     274 </span><span class="lineNoCov">          0 : CalendarAstronomer::CalendarAstronomer(double longitude, double latitude) :</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   fTime(Calendar::getNow()), moonPosition(0,0), moonPositionSet(FALSE) {</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   fLongitude = normPI(longitude * (double)DEG_RAD);</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   fLatitude  = normPI(latitude  * (double)DEG_RAD);</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   fGmtOffset = (double)(fLongitude * 24. * (double)HOUR_MS / (double)CalendarAstronomer_PI2);</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   clearCache();</span>
<a name="280"><span class="lineNum">     280 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span><span class="lineNoCov">          0 : CalendarAstronomer::~CalendarAstronomer()</span>
<span class="lineNum">     283 </span>            : {
<span class="lineNum">     284 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     287 </span>            : // Time and date getters and setters
<span class="lineNum">     288 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span>            : /**
<span class="lineNum">     291 </span>            :  * Set the current date and time of this &lt;code&gt;CalendarAstronomer&lt;/code&gt; object.  All
<span class="lineNum">     292 </span>            :  * astronomical calculations are performed based on this time setting.
<span class="lineNum">     293 </span>            :  *
<span class="lineNum">     294 </span>            :  * @param aTime the date and time, expressed as the number of milliseconds since
<span class="lineNum">     295 </span>            :  *              1/1/1970 0:00 GMT (Gregorian).
<span class="lineNum">     296 </span>            :  *
<span class="lineNum">     297 </span>            :  * @see #setDate
<span class="lineNum">     298 </span>            :  * @see #getTime
<span class="lineNum">     299 </span>            :  * @internal
<a name="300"><span class="lineNum">     300 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     301 </span>            :  */
<span class="lineNum">     302 </span><span class="lineNoCov">          0 : void CalendarAstronomer::setTime(UDate aTime) {</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     fTime = aTime;</span>
<span class="lineNum">     304 </span>            :     U_DEBUG_ASTRO_MSG((&quot;setTime(%.1lf, %sL)\n&quot;, aTime, debug_astro_date(aTime+fGmtOffset)));
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     clearCache();</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            : /**
<span class="lineNum">     309 </span>            :  * Set the current date and time of this &lt;code&gt;CalendarAstronomer&lt;/code&gt; object.  All
<span class="lineNum">     310 </span>            :  * astronomical calculations are performed based on this time setting.
<span class="lineNum">     311 </span>            :  *
<span class="lineNum">     312 </span>            :  * @param jdn   the desired time, expressed as a &quot;julian day number&quot;,
<span class="lineNum">     313 </span>            :  *              which is the number of elapsed days since
<span class="lineNum">     314 </span>            :  *              1/1/4713 BC (Julian), 12:00 GMT.  Note that julian day
<span class="lineNum">     315 </span>            :  *              numbers start at &lt;em&gt;noon&lt;/em&gt;.  To get the jdn for
<span class="lineNum">     316 </span>            :  *              the corresponding midnight, subtract 0.5.
<span class="lineNum">     317 </span>            :  *
<span class="lineNum">     318 </span>            :  * @see #getJulianDay
<span class="lineNum">     319 </span>            :  * @see #JULIAN_EPOCH_MS
<span class="lineNum">     320 </span>            :  * @internal
<a name="321"><span class="lineNum">     321 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     322 </span>            :  */
<span class="lineNum">     323 </span><span class="lineNoCov">          0 : void CalendarAstronomer::setJulianDay(double jdn) {</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     fTime = (double)(jdn * DAY_MS) + JULIAN_EPOCH_MS;</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     clearCache();</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     julianDay = jdn;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            : /**
<span class="lineNum">     330 </span>            :  * Get the current time of this &lt;code&gt;CalendarAstronomer&lt;/code&gt; object,
<span class="lineNum">     331 </span>            :  * represented as the number of milliseconds since
<span class="lineNum">     332 </span>            :  * 1/1/1970 AD 0:00 GMT (Gregorian).
<span class="lineNum">     333 </span>            :  *
<span class="lineNum">     334 </span>            :  * @see #setTime
<span class="lineNum">     335 </span>            :  * @see #getDate
<span class="lineNum">     336 </span>            :  * @internal
<a name="337"><span class="lineNum">     337 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     338 </span>            :  */
<span class="lineNum">     339 </span><span class="lineNoCov">          0 : UDate CalendarAstronomer::getTime() {</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     return fTime;</span>
<span class="lineNum">     341 </span>            : }
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span>            : /**
<span class="lineNum">     344 </span>            :  * Get the current time of this &lt;code&gt;CalendarAstronomer&lt;/code&gt; object,
<span class="lineNum">     345 </span>            :  * expressed as a &quot;julian day number&quot;, which is the number of elapsed
<span class="lineNum">     346 </span>            :  * days since 1/1/4713 BC (Julian), 12:00 GMT.
<span class="lineNum">     347 </span>            :  *
<span class="lineNum">     348 </span>            :  * @see #setJulianDay
<span class="lineNum">     349 </span>            :  * @see #JULIAN_EPOCH_MS
<span class="lineNum">     350 </span>            :  * @internal
<a name="351"><span class="lineNum">     351 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     352 </span>            :  */
<span class="lineNum">     353 </span><span class="lineNoCov">          0 : double CalendarAstronomer::getJulianDay() {</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     if (isINVALID(julianDay)) {</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :         julianDay = (fTime - (double)JULIAN_EPOCH_MS) / (double)DAY_MS;</span>
<span class="lineNum">     356 </span>            :     }
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :     return julianDay;</span>
<span class="lineNum">     358 </span>            : }
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span>            : /**
<span class="lineNum">     361 </span>            :  * Return this object's time expressed in julian centuries:
<span class="lineNum">     362 </span>            :  * the number of centuries after 1/1/1900 AD, 12:00 GMT
<span class="lineNum">     363 </span>            :  *
<span class="lineNum">     364 </span>            :  * @see #getJulianDay
<span class="lineNum">     365 </span>            :  * @internal
<a name="366"><span class="lineNum">     366 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     367 </span>            :  */
<span class="lineNum">     368 </span><span class="lineNoCov">          0 : double CalendarAstronomer::getJulianCentury() {</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     if (isINVALID(julianCentury)) {</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :         julianCentury = (getJulianDay() - 2415020.0) / 36525.0;</span>
<span class="lineNum">     371 </span>            :     }
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :     return julianCentury;</span>
<span class="lineNum">     373 </span>            : }
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span>            : /**
<span class="lineNum">     376 </span>            :  * Returns the current Greenwich sidereal time, measured in hours
<span class="lineNum">     377 </span>            :  * @internal
<a name="378"><span class="lineNum">     378 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     379 </span>            :  */
<span class="lineNum">     380 </span><span class="lineNoCov">          0 : double CalendarAstronomer::getGreenwichSidereal() {</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :     if (isINVALID(siderealTime)) {</span>
<span class="lineNum">     382 </span>            :         // See page 86 of &quot;Practial Astronomy with your Calculator&quot;,
<span class="lineNum">     383 </span>            :         // by Peter Duffet-Smith, for details on the algorithm.
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :         double UT = normalize(fTime/(double)HOUR_MS, 24.);</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :         siderealTime = normalize(getSiderealOffset() + UT*1.002737909, 24.);</span>
<span class="lineNum">     388 </span>            :     }
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     return siderealTime;</span>
<a name="390"><span class="lineNum">     390 </span>            : }</a>
<span class="lineNum">     391 </span>            : 
<span class="lineNum">     392 </span><span class="lineNoCov">          0 : double CalendarAstronomer::getSiderealOffset() {</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     if (isINVALID(siderealT0)) {</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         double JD  = uprv_floor(getJulianDay() - 0.5) + 0.5;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         double S   = JD - 2451545.0;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         double T   = S / 36525.0;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         siderealT0 = normalize(6.697374558 + 2400.051336*T + 0.000025862*T*T, 24);</span>
<span class="lineNum">     398 </span>            :     }
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :     return siderealT0;</span>
<span class="lineNum">     400 </span>            : }
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span>            : /**
<span class="lineNum">     403 </span>            :  * Returns the current local sidereal time, measured in hours
<span class="lineNum">     404 </span>            :  * @internal
<a name="405"><span class="lineNum">     405 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     406 </span>            :  */
<span class="lineNum">     407 </span><span class="lineNoCov">          0 : double CalendarAstronomer::getLocalSidereal() {</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :     return normalize(getGreenwichSidereal() + (fGmtOffset/(double)HOUR_MS), 24.);</span>
<span class="lineNum">     409 </span>            : }
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span>            : /**
<span class="lineNum">     412 </span>            :  * Converts local sidereal time to Universal Time.
<span class="lineNum">     413 </span>            :  *
<span class="lineNum">     414 </span>            :  * @param lst   The Local Sidereal Time, in hours since sidereal midnight
<span class="lineNum">     415 </span>            :  *              on this object's current date.
<span class="lineNum">     416 </span>            :  *
<span class="lineNum">     417 </span>            :  * @return      The corresponding Universal Time, in milliseconds since
<a name="418"><span class="lineNum">     418 </span>            :  *              1 Jan 1970, GMT.</a>
<span class="lineNum">     419 </span>            :  */
<span class="lineNum">     420 </span><span class="lineNoCov">          0 : double CalendarAstronomer::lstToUT(double lst) {</span>
<span class="lineNum">     421 </span>            :     // Convert to local mean time
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :     double lt = normalize((lst - getSiderealOffset()) * 0.9972695663, 24);</span>
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span>            :     // Then find local midnight on this day
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :     double base = (DAY_MS * ClockMath::floorDivide(fTime + fGmtOffset,(double)DAY_MS)) - fGmtOffset;</span>
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span>            :     //out(&quot;    lt  =&quot; + lt + &quot; hours&quot;);
<span class="lineNum">     428 </span>            :     //out(&quot;    base=&quot; + new Date(base));
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :     return base + (long)(lt * HOUR_MS);</span>
<span class="lineNum">     431 </span>            : }
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     435 </span>            : // Coordinate transformations, all based on the current time of this object
<span class="lineNum">     436 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span>            : /**
<span class="lineNum">     439 </span>            :  * Convert from ecliptic to equatorial coordinates.
<span class="lineNum">     440 </span>            :  *
<span class="lineNum">     441 </span>            :  * @param ecliptic  A point in the sky in ecliptic coordinates.
<span class="lineNum">     442 </span>            :  * @return          The corresponding point in equatorial coordinates.
<span class="lineNum">     443 </span>            :  * @internal
<a name="444"><span class="lineNum">     444 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     445 </span>            :  */
<span class="lineNum">     446 </span><span class="lineNoCov">          0 : CalendarAstronomer::Equatorial&amp; CalendarAstronomer::eclipticToEquatorial(CalendarAstronomer::Equatorial&amp; result, const CalendarAstronomer::Ecliptic&amp; ecliptic)</span>
<span class="lineNum">     447 </span>            : {
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     return eclipticToEquatorial(result, ecliptic.longitude, ecliptic.latitude);</span>
<span class="lineNum">     449 </span>            : }
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span>            : /**
<span class="lineNum">     452 </span>            :  * Convert from ecliptic to equatorial coordinates.
<span class="lineNum">     453 </span>            :  *
<span class="lineNum">     454 </span>            :  * @param eclipLong     The ecliptic longitude
<span class="lineNum">     455 </span>            :  * @param eclipLat      The ecliptic latitude
<span class="lineNum">     456 </span>            :  *
<span class="lineNum">     457 </span>            :  * @return              The corresponding point in equatorial coordinates.
<span class="lineNum">     458 </span>            :  * @internal
<a name="459"><span class="lineNum">     459 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     460 </span>            :  */
<span class="lineNum">     461 </span><span class="lineNoCov">          0 : CalendarAstronomer::Equatorial&amp; CalendarAstronomer::eclipticToEquatorial(CalendarAstronomer::Equatorial&amp; result, double eclipLong, double eclipLat)</span>
<span class="lineNum">     462 </span>            : {
<span class="lineNum">     463 </span>            :     // See page 42 of &quot;Practial Astronomy with your Calculator&quot;,
<span class="lineNum">     464 </span>            :     // by Peter Duffet-Smith, for details on the algorithm.
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     double obliq = eclipticObliquity();</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     double sinE = ::sin(obliq);</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     double cosE = cos(obliq);</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     double sinL = ::sin(eclipLong);</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :     double cosL = cos(eclipLong);</span>
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     double sinB = ::sin(eclipLat);</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     double cosB = cos(eclipLat);</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :     double tanB = tan(eclipLat);</span>
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     result.set(atan2(sinL*cosE - tanB*sinE, cosL),</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         asin(sinB*cosE + cosB*sinE*sinL) );</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     return result;</span>
<span class="lineNum">     480 </span>            : }
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span>            : /**
<span class="lineNum">     483 </span>            :  * Convert from ecliptic longitude to equatorial coordinates.
<span class="lineNum">     484 </span>            :  *
<span class="lineNum">     485 </span>            :  * @param eclipLong     The ecliptic longitude
<span class="lineNum">     486 </span>            :  *
<span class="lineNum">     487 </span>            :  * @return              The corresponding point in equatorial coordinates.
<span class="lineNum">     488 </span>            :  * @internal
<a name="489"><span class="lineNum">     489 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     490 </span>            :  */
<span class="lineNum">     491 </span><span class="lineNoCov">          0 : CalendarAstronomer::Equatorial&amp; CalendarAstronomer::eclipticToEquatorial(CalendarAstronomer::Equatorial&amp; result, double eclipLong)</span>
<span class="lineNum">     492 </span>            : {
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :     return eclipticToEquatorial(result, eclipLong, 0);  // TODO: optimize</span>
<span class="lineNum">     494 </span>            : }
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span>            : /**
<span class="lineNum">     497 </span>            :  * @internal
<a name="498"><span class="lineNum">     498 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     499 </span>            :  */
<span class="lineNum">     500 </span><span class="lineNoCov">          0 : CalendarAstronomer::Horizon&amp; CalendarAstronomer::eclipticToHorizon(CalendarAstronomer::Horizon&amp; result, double eclipLong)</span>
<span class="lineNum">     501 </span>            : {
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     Equatorial equatorial;</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :     eclipticToEquatorial(equatorial, eclipLong);</span>
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :     double H = getLocalSidereal()*CalendarAstronomer::PI/12 - equatorial.ascension;     // Hour-angle</span>
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :     double sinH = ::sin(H);</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :     double cosH = cos(H);</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :     double sinD = ::sin(equatorial.declination);</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :     double cosD = cos(equatorial.declination);</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     double sinL = ::sin(fLatitude);</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :     double cosL = cos(fLatitude);</span>
<span class="lineNum">     513 </span>            : 
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     double altitude = asin(sinD*sinL + cosD*cosL*cosH);</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     double azimuth  = atan2(-cosD*cosL*sinH, sinD - sinL * ::sin(altitude));</span>
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     result.set(azimuth, altitude);</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     return result;</span>
<span class="lineNum">     519 </span>            : }
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     523 </span>            : // The Sun
<span class="lineNum">     524 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span>            : //
<span class="lineNum">     527 </span>            : // Parameters of the Sun's orbit as of the epoch Jan 0.0 1990
<span class="lineNum">     528 </span>            : // Angles are in radians (after multiplying by CalendarAstronomer::PI/180)
<span class="lineNum">     529 </span>            : //
<span class="lineNum">     530 </span>            : #define JD_EPOCH  2447891.5 // Julian day of epoch
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span>            : #define SUN_ETA_G    (279.403303 * CalendarAstronomer::PI/180) // Ecliptic longitude at epoch
<span class="lineNum">     533 </span>            : #define SUN_OMEGA_G  (282.768422 * CalendarAstronomer::PI/180) // Ecliptic longitude of perigee
<span class="lineNum">     534 </span>            : #define SUN_E         0.016713          // Eccentricity of orbit
<span class="lineNum">     535 </span>            : //double sunR0        1.495585e8        // Semi-major axis in KM
<span class="lineNum">     536 </span>            : //double sunTheta0    (0.533128 * CalendarAstronomer::PI/180) // Angular diameter at R0
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span>            : // The following three methods, which compute the sun parameters
<span class="lineNum">     539 </span>            : // given above for an arbitrary epoch (whatever time the object is
<span class="lineNum">     540 </span>            : // set to), make only a small difference as compared to using the
<span class="lineNum">     541 </span>            : // above constants.  E.g., Sunset times might differ by ~12
<span class="lineNum">     542 </span>            : // seconds.  Furthermore, the eta-g computation is befuddled by
<span class="lineNum">     543 </span>            : // Duffet-Smith's incorrect coefficients (p.86).  I've corrected
<span class="lineNum">     544 </span>            : // the first-order coefficient but the others may be off too - no
<span class="lineNum">     545 </span>            : // way of knowing without consulting another source.
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span>            : //  /**
<span class="lineNum">     548 </span>            : //   * Return the sun's ecliptic longitude at perigee for the current time.
<span class="lineNum">     549 </span>            : //   * See Duffett-Smith, p. 86.
<span class="lineNum">     550 </span>            : //   * @return radians
<span class="lineNum">     551 </span>            : //   */
<span class="lineNum">     552 </span>            : //  private double getSunOmegaG() {
<span class="lineNum">     553 </span>            : //      double T = getJulianCentury();
<span class="lineNum">     554 </span>            : //      return (281.2208444 + (1.719175 + 0.000452778*T)*T) * DEG_RAD;
<span class="lineNum">     555 </span>            : //  }
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span>            : //  /**
<span class="lineNum">     558 </span>            : //   * Return the sun's ecliptic longitude for the current time.
<span class="lineNum">     559 </span>            : //   * See Duffett-Smith, p. 86.
<span class="lineNum">     560 </span>            : //   * @return radians
<span class="lineNum">     561 </span>            : //   */
<span class="lineNum">     562 </span>            : //  private double getSunEtaG() {
<span class="lineNum">     563 </span>            : //      double T = getJulianCentury();
<span class="lineNum">     564 </span>            : //      //return (279.6966778 + (36000.76892 + 0.0003025*T)*T) * DEG_RAD;
<span class="lineNum">     565 </span>            : //      //
<span class="lineNum">     566 </span>            : //      // The above line is from Duffett-Smith, and yields manifestly wrong
<span class="lineNum">     567 </span>            : //      // results.  The below constant is derived empirically to match the
<span class="lineNum">     568 </span>            : //      // constant he gives for the 1990 EPOCH.
<span class="lineNum">     569 </span>            : //      //
<span class="lineNum">     570 </span>            : //      return (279.6966778 + (-0.3262541582718024 + 0.0003025*T)*T) * DEG_RAD;
<span class="lineNum">     571 </span>            : //  }
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span>            : //  /**
<span class="lineNum">     574 </span>            : //   * Return the sun's eccentricity of orbit for the current time.
<span class="lineNum">     575 </span>            : //   * See Duffett-Smith, p. 86.
<span class="lineNum">     576 </span>            : //   * @return double
<span class="lineNum">     577 </span>            : //   */
<span class="lineNum">     578 </span>            : //  private double getSunE() {
<span class="lineNum">     579 </span>            : //      double T = getJulianCentury();
<span class="lineNum">     580 </span>            : //      return 0.01675104 - (0.0000418 + 0.000000126*T)*T;
<span class="lineNum">     581 </span>            : //  }
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span>            : /**
<span class="lineNum">     584 </span>            :  * Find the &quot;true anomaly&quot; (longitude) of an object from
<span class="lineNum">     585 </span>            :  * its mean anomaly and the eccentricity of its orbit.  This uses
<span class="lineNum">     586 </span>            :  * an iterative solution to Kepler's equation.
<span class="lineNum">     587 </span>            :  *
<span class="lineNum">     588 </span>            :  * @param meanAnomaly   The object's longitude calculated as if it were in
<span class="lineNum">     589 </span>            :  *                      a regular, circular orbit, measured in radians
<span class="lineNum">     590 </span>            :  *                      from the point of perigee.
<span class="lineNum">     591 </span>            :  *
<span class="lineNum">     592 </span>            :  * @param eccentricity  The eccentricity of the orbit
<span class="lineNum">     593 </span>            :  *
<a name="594"><span class="lineNum">     594 </span>            :  * @return The true anomaly (longitude) measured in radians</a>
<span class="lineNum">     595 </span>            :  */
<span class="lineNum">     596 </span><span class="lineNoCov">          0 : static double trueAnomaly(double meanAnomaly, double eccentricity)</span>
<span class="lineNum">     597 </span>            : {
<span class="lineNum">     598 </span>            :     // First, solve Kepler's equation iteratively
<span class="lineNum">     599 </span>            :     // Duffett-Smith, p.90
<span class="lineNum">     600 </span>            :     double delta;
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     double E = meanAnomaly;</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :     do {</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :         delta = E - eccentricity * ::sin(E) - meanAnomaly;</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :         E = E - delta / (1 - eccentricity * ::cos(E));</span>
<span class="lineNum">     605 </span>            :     }
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :     while (uprv_fabs(delta) &gt; 1e-5); // epsilon = 1e-5 rad</span>
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     return 2.0 * ::atan( ::tan(E/2) * ::sqrt( (1+eccentricity)</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                                              /(1-eccentricity) ) );</span>
<span class="lineNum">     610 </span>            : }
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span>            : /**
<span class="lineNum">     613 </span>            :  * The longitude of the sun at the time specified by this object.
<span class="lineNum">     614 </span>            :  * The longitude is measured in radians along the ecliptic
<span class="lineNum">     615 </span>            :  * from the &quot;first point of Aries,&quot; the point at which the ecliptic
<span class="lineNum">     616 </span>            :  * crosses the earth's equatorial plane at the vernal equinox.
<span class="lineNum">     617 </span>            :  * &lt;p&gt;
<span class="lineNum">     618 </span>            :  * Currently, this method uses an approximation of the two-body Kepler's
<span class="lineNum">     619 </span>            :  * equation for the earth and the sun.  It does not take into account the
<span class="lineNum">     620 </span>            :  * perturbations caused by the other planets, the moon, etc.
<span class="lineNum">     621 </span>            :  * @internal
<a name="622"><span class="lineNum">     622 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     623 </span>            :  */
<span class="lineNum">     624 </span><span class="lineNoCov">          0 : double CalendarAstronomer::getSunLongitude()</span>
<span class="lineNum">     625 </span>            : {
<span class="lineNum">     626 </span>            :     // See page 86 of &quot;Practial Astronomy with your Calculator&quot;,
<span class="lineNum">     627 </span>            :     // by Peter Duffet-Smith, for details on the algorithm.
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :     if (isINVALID(sunLongitude)) {</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :         getSunLongitude(getJulianDay(), sunLongitude, meanAnomalySun);</span>
<span class="lineNum">     631 </span>            :     }
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :     return sunLongitude;</span>
<span class="lineNum">     633 </span>            : }
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span>            : /**
<a name="636"><span class="lineNum">     636 </span>            :  * TODO Make this public when the entire class is package-private.</a>
<span class="lineNum">     637 </span>            :  */
<span class="lineNum">     638 </span><span class="lineNoCov">          0 : /*public*/ void CalendarAstronomer::getSunLongitude(double jDay, double &amp;longitude, double &amp;meanAnomaly)</span>
<span class="lineNum">     639 </span>            : {
<span class="lineNum">     640 </span>            :     // See page 86 of &quot;Practial Astronomy with your Calculator&quot;,
<span class="lineNum">     641 </span>            :     // by Peter Duffet-Smith, for details on the algorithm.
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :     double day = jDay - JD_EPOCH;       // Days since epoch</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span>            :     // Find the angular distance the sun in a fictitious
<span class="lineNum">     646 </span>            :     // circular orbit has travelled since the epoch.
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :     double epochAngle = norm2PI(CalendarAstronomer_PI2/TROPICAL_YEAR*day);</span>
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span>            :     // The epoch wasn't at the sun's perigee; find the angular distance
<span class="lineNum">     650 </span>            :     // since perigee, which is called the &quot;mean anomaly&quot;
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :     meanAnomaly = norm2PI(epochAngle + SUN_ETA_G - SUN_OMEGA_G);</span>
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span>            :     // Now find the &quot;true anomaly&quot;, e.g. the real solar longitude
<span class="lineNum">     654 </span>            :     // by solving Kepler's equation for an elliptical orbit
<span class="lineNum">     655 </span>            :     // NOTE: The 3rd ed. of the book lists omega_g and eta_g in different
<span class="lineNum">     656 </span>            :     // equations; omega_g is to be correct.
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :     longitude =  norm2PI(trueAnomaly(meanAnomaly, SUN_E) + SUN_OMEGA_G);</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span>            : /**
<span class="lineNum">     661 </span>            :  * The position of the sun at this object's current date and time,
<span class="lineNum">     662 </span>            :  * in equatorial coordinates.
<span class="lineNum">     663 </span>            :  * @internal
<a name="664"><span class="lineNum">     664 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     665 </span>            :  */
<span class="lineNum">     666 </span><span class="lineNoCov">          0 : CalendarAstronomer::Equatorial&amp; CalendarAstronomer::getSunPosition(CalendarAstronomer::Equatorial&amp; result) {</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :     return eclipticToEquatorial(result, getSunLongitude(), 0);</span>
<span class="lineNum">     668 </span>            : }
<span class="lineNum">     669 </span>            : 
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span>            : /**
<span class="lineNum">     672 </span>            :  * Constant representing the vernal equinox.
<span class="lineNum">     673 </span>            :  * For use with {@link #getSunTime getSunTime}.
<span class="lineNum">     674 </span>            :  * Note: In this case, &quot;vernal&quot; refers to the northern hemisphere's seasons.
<span class="lineNum">     675 </span>            :  * @internal
<span class="lineNum">     676 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     677 </span>            :  */
<span class="lineNum">     678 </span>            : /*double CalendarAstronomer::VERNAL_EQUINOX() {
<span class="lineNum">     679 </span>            :   return 0;
<span class="lineNum">     680 </span>            : }*/
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            : /**
<span class="lineNum">     683 </span>            :  * Constant representing the summer solstice.
<span class="lineNum">     684 </span>            :  * For use with {@link #getSunTime getSunTime}.
<span class="lineNum">     685 </span>            :  * Note: In this case, &quot;summer&quot; refers to the northern hemisphere's seasons.
<span class="lineNum">     686 </span>            :  * @internal
<a name="687"><span class="lineNum">     687 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     688 </span>            :  */
<span class="lineNum">     689 </span><span class="lineNoCov">          0 : double CalendarAstronomer::SUMMER_SOLSTICE() {</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :     return  (CalendarAstronomer::PI/2);</span>
<span class="lineNum">     691 </span>            : }
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span>            : /**
<span class="lineNum">     694 </span>            :  * Constant representing the autumnal equinox.
<span class="lineNum">     695 </span>            :  * For use with {@link #getSunTime getSunTime}.
<span class="lineNum">     696 </span>            :  * Note: In this case, &quot;autumn&quot; refers to the northern hemisphere's seasons.
<span class="lineNum">     697 </span>            :  * @internal
<span class="lineNum">     698 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     699 </span>            :  */
<span class="lineNum">     700 </span>            : /*double CalendarAstronomer::AUTUMN_EQUINOX() {
<span class="lineNum">     701 </span>            :   return  (CalendarAstronomer::PI);
<span class="lineNum">     702 </span>            : }*/
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span>            : /**
<span class="lineNum">     705 </span>            :  * Constant representing the winter solstice.
<span class="lineNum">     706 </span>            :  * For use with {@link #getSunTime getSunTime}.
<span class="lineNum">     707 </span>            :  * Note: In this case, &quot;winter&quot; refers to the northern hemisphere's seasons.
<span class="lineNum">     708 </span>            :  * @internal
<a name="709"><span class="lineNum">     709 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">     710 </span>            :  */
<span class="lineNum">     711 </span><span class="lineNoCov">          0 : double CalendarAstronomer::WINTER_SOLSTICE() {</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :     return  ((CalendarAstronomer::PI*3)/2);</span>
<a name="713"><span class="lineNum">     713 </span>            : }</a>
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span><span class="lineNoCov">          0 : CalendarAstronomer::AngleFunc::~AngleFunc() {}</span>
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span>            : /**
<span class="lineNum">     718 </span>            :  * Find the next time at which the sun's ecliptic longitude will have
<span class="lineNum">     719 </span>            :  * the desired value.
<span class="lineNum">     720 </span>            :  * @internal
<span class="lineNum">     721 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">     722 </span>            :  */
<span class="lineNum">     723 </span>            : class SunTimeAngleFunc : public CalendarAstronomer::AngleFunc {
<a name="724"><span class="lineNum">     724 </span>            : public:</a>
<span class="lineNum">     725 </span>            :     virtual ~SunTimeAngleFunc();
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :     virtual double eval(CalendarAstronomer&amp; a) { return a.getSunLongitude(); }</span>
<a name="727"><span class="lineNum">     727 </span>            : };</a>
<span class="lineNum">     728 </span>            : 
<a name="729"><span class="lineNum">     729 </span><span class="lineNoCov">          0 : SunTimeAngleFunc::~SunTimeAngleFunc() {}</span></a>
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span><span class="lineNoCov">          0 : UDate CalendarAstronomer::getSunTime(double desired, UBool next)</span>
<span class="lineNum">     732 </span>            : {
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :     SunTimeAngleFunc func;</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :     return timeOfAngle( func,</span>
<span class="lineNum">     735 </span>            :                         desired,
<span class="lineNum">     736 </span>            :                         TROPICAL_YEAR,
<span class="lineNum">     737 </span>            :                         MINUTE_MS,
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :                         next);</span>
<a name="739"><span class="lineNum">     739 </span>            : }</a>
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineNoCov">          0 : CalendarAstronomer::CoordFunc::~CoordFunc() {}</span>
<span class="lineNum">     742 </span>            : 
<span class="lineNum">     743 </span>            : class RiseSetCoordFunc : public CalendarAstronomer::CoordFunc {
<a name="744"><span class="lineNum">     744 </span>            : public:</a>
<span class="lineNum">     745 </span>            :     virtual ~RiseSetCoordFunc();
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     virtual void eval(CalendarAstronomer::Equatorial&amp; result, CalendarAstronomer&amp;a) {  a.getSunPosition(result); }</span>
<a name="747"><span class="lineNum">     747 </span>            : };</a>
<span class="lineNum">     748 </span>            : 
<a name="749"><span class="lineNum">     749 </span><span class="lineNoCov">          0 : RiseSetCoordFunc::~RiseSetCoordFunc() {}</span></a>
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span><span class="lineNoCov">          0 : UDate CalendarAstronomer::getSunRiseSet(UBool rise)</span>
<span class="lineNum">     752 </span>            : {
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :     UDate t0 = fTime;</span>
<span class="lineNum">     754 </span>            : 
<span class="lineNum">     755 </span>            :     // Make a rough guess: 6am or 6pm local time on the current day
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     double noon = ClockMath::floorDivide(fTime + fGmtOffset, (double)DAY_MS)*DAY_MS - fGmtOffset + (12*HOUR_MS);</span>
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span>            :     U_DEBUG_ASTRO_MSG((&quot;Noon=%.2lf, %sL, gmtoff %.2lf\n&quot;, noon, debug_astro_date(noon+fGmtOffset), fGmtOffset));
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :     setTime(noon +  ((rise ? -6 : 6) * HOUR_MS));</span>
<span class="lineNum">     760 </span>            :     U_DEBUG_ASTRO_MSG((&quot;added %.2lf ms as a guess,\n&quot;, ((rise ? -6. : 6.) * HOUR_MS)));
<span class="lineNum">     761 </span>            : 
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :     RiseSetCoordFunc func;</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :     double t = riseOrSet(func,</span>
<span class="lineNum">     764 </span>            :                          rise,
<span class="lineNum">     765 </span>            :                          .533 * DEG_RAD,        // Angular Diameter
<span class="lineNum">     766 </span>            :                          34. /60.0 * DEG_RAD,    // Refraction correction
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :                          MINUTE_MS / 12.);       // Desired accuracy</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :     setTime(t0);</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :     return t;</span>
<span class="lineNum">     771 </span>            : }
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span>            : // Commented out - currently unused. ICU 2.6, Alan
<span class="lineNum">     774 </span>            : //    //-------------------------------------------------------------------------
<span class="lineNum">     775 </span>            : //    // Alternate Sun Rise/Set
<span class="lineNum">     776 </span>            : //    // See Duffett-Smith p.93
<span class="lineNum">     777 </span>            : //    //-------------------------------------------------------------------------
<span class="lineNum">     778 </span>            : //
<span class="lineNum">     779 </span>            : //    // This yields worse results (as compared to USNO data) than getSunRiseSet().
<span class="lineNum">     780 </span>            : //    /**
<span class="lineNum">     781 </span>            : //     * TODO Make this when the entire class is package-private.
<span class="lineNum">     782 </span>            : //     */
<span class="lineNum">     783 </span>            : //    /*public*/ long getSunRiseSet2(boolean rise) {
<span class="lineNum">     784 </span>            : //        // 1. Calculate coordinates of the sun's center for midnight
<span class="lineNum">     785 </span>            : //        double jd = uprv_floor(getJulianDay() - 0.5) + 0.5;
<span class="lineNum">     786 </span>            : //        double[] sl = getSunLongitude(jd);//        double lambda1 = sl[0];
<span class="lineNum">     787 </span>            : //        Equatorial pos1 = eclipticToEquatorial(lambda1, 0);
<span class="lineNum">     788 </span>            : //
<span class="lineNum">     789 </span>            : //        // 2. Add ... to lambda to get position 24 hours later
<span class="lineNum">     790 </span>            : //        double lambda2 = lambda1 + 0.985647*DEG_RAD;
<span class="lineNum">     791 </span>            : //        Equatorial pos2 = eclipticToEquatorial(lambda2, 0);
<span class="lineNum">     792 </span>            : //
<span class="lineNum">     793 </span>            : //        // 3. Calculate LSTs of rising and setting for these two positions
<span class="lineNum">     794 </span>            : //        double tanL = ::tan(fLatitude);
<span class="lineNum">     795 </span>            : //        double H = ::acos(-tanL * ::tan(pos1.declination));
<span class="lineNum">     796 </span>            : //        double lst1r = (CalendarAstronomer_PI2 + pos1.ascension - H) * 24 / CalendarAstronomer_PI2;
<span class="lineNum">     797 </span>            : //        double lst1s = (pos1.ascension + H) * 24 / CalendarAstronomer_PI2;
<span class="lineNum">     798 </span>            : //               H = ::acos(-tanL * ::tan(pos2.declination));
<span class="lineNum">     799 </span>            : //        double lst2r = (CalendarAstronomer_PI2-H + pos2.ascension ) * 24 / CalendarAstronomer_PI2;
<span class="lineNum">     800 </span>            : //        double lst2s = (H + pos2.ascension ) * 24 / CalendarAstronomer_PI2;
<span class="lineNum">     801 </span>            : //        if (lst1r &gt; 24) lst1r -= 24;
<span class="lineNum">     802 </span>            : //        if (lst1s &gt; 24) lst1s -= 24;
<span class="lineNum">     803 </span>            : //        if (lst2r &gt; 24) lst2r -= 24;
<span class="lineNum">     804 </span>            : //        if (lst2s &gt; 24) lst2s -= 24;
<span class="lineNum">     805 </span>            : //
<span class="lineNum">     806 </span>            : //        // 4. Convert LSTs to GSTs.  If GST1 &gt; GST2, add 24 to GST2.
<span class="lineNum">     807 </span>            : //        double gst1r = lstToGst(lst1r);
<span class="lineNum">     808 </span>            : //        double gst1s = lstToGst(lst1s);
<span class="lineNum">     809 </span>            : //        double gst2r = lstToGst(lst2r);
<span class="lineNum">     810 </span>            : //        double gst2s = lstToGst(lst2s);
<span class="lineNum">     811 </span>            : //        if (gst1r &gt; gst2r) gst2r += 24;
<span class="lineNum">     812 </span>            : //        if (gst1s &gt; gst2s) gst2s += 24;
<span class="lineNum">     813 </span>            : //
<span class="lineNum">     814 </span>            : //        // 5. Calculate GST at 0h UT of this date
<span class="lineNum">     815 </span>            : //        double t00 = utToGst(0);
<span class="lineNum">     816 </span>            : //
<span class="lineNum">     817 </span>            : //        // 6. Calculate GST at 0h on the observer's longitude
<span class="lineNum">     818 </span>            : //        double offset = ::round(fLongitude*12/PI); // p.95 step 6; he _rounds_ to nearest 15 deg.
<span class="lineNum">     819 </span>            : //        double t00p = t00 - offset*1.002737909;
<span class="lineNum">     820 </span>            : //        if (t00p &lt; 0) t00p += 24; // do NOT normalize
<span class="lineNum">     821 </span>            : //
<span class="lineNum">     822 </span>            : //        // 7. Adjust
<span class="lineNum">     823 </span>            : //        if (gst1r &lt; t00p) {
<span class="lineNum">     824 </span>            : //            gst1r += 24;
<span class="lineNum">     825 </span>            : //            gst2r += 24;
<span class="lineNum">     826 </span>            : //        }
<span class="lineNum">     827 </span>            : //        if (gst1s &lt; t00p) {
<span class="lineNum">     828 </span>            : //            gst1s += 24;
<span class="lineNum">     829 </span>            : //            gst2s += 24;
<span class="lineNum">     830 </span>            : //        }
<span class="lineNum">     831 </span>            : //
<span class="lineNum">     832 </span>            : //        // 8.
<span class="lineNum">     833 </span>            : //        double gstr = (24.07*gst1r-t00*(gst2r-gst1r))/(24.07+gst1r-gst2r);
<span class="lineNum">     834 </span>            : //        double gsts = (24.07*gst1s-t00*(gst2s-gst1s))/(24.07+gst1s-gst2s);
<span class="lineNum">     835 </span>            : //
<span class="lineNum">     836 </span>            : //        // 9. Correct for parallax, refraction, and sun's diameter
<span class="lineNum">     837 </span>            : //        double dec = (pos1.declination + pos2.declination) / 2;
<span class="lineNum">     838 </span>            : //        double psi = ::acos(sin(fLatitude) / cos(dec));
<span class="lineNum">     839 </span>            : //        double x = 0.830725 * DEG_RAD; // parallax+refraction+diameter
<span class="lineNum">     840 </span>            : //        double y = ::asin(sin(x) / ::sin(psi)) * RAD_DEG;
<span class="lineNum">     841 </span>            : //        double delta_t = 240 * y / cos(dec) / 3600; // hours
<span class="lineNum">     842 </span>            : //
<span class="lineNum">     843 </span>            : //        // 10. Add correction to GSTs, subtract from GSTr
<span class="lineNum">     844 </span>            : //        gstr -= delta_t;
<span class="lineNum">     845 </span>            : //        gsts += delta_t;
<span class="lineNum">     846 </span>            : //
<span class="lineNum">     847 </span>            : //        // 11. Convert GST to UT and then to local civil time
<span class="lineNum">     848 </span>            : //        double ut = gstToUt(rise ? gstr : gsts);
<span class="lineNum">     849 </span>            : //        //System.out.println((rise?&quot;rise=&quot;:&quot;set=&quot;) + ut + &quot;, delta_t=&quot; + delta_t);
<span class="lineNum">     850 </span>            : //        long midnight = DAY_MS * (time / DAY_MS); // Find UT midnight on this day
<span class="lineNum">     851 </span>            : //        return midnight + (long) (ut * 3600000);
<span class="lineNum">     852 </span>            : //    }
<span class="lineNum">     853 </span>            : 
<span class="lineNum">     854 </span>            : // Commented out - currently unused. ICU 2.6, Alan
<span class="lineNum">     855 </span>            : //    /**
<span class="lineNum">     856 </span>            : //     * Convert local sidereal time to Greenwich sidereal time.
<span class="lineNum">     857 </span>            : //     * Section 15.  Duffett-Smith p.21
<span class="lineNum">     858 </span>            : //     * @param lst in hours (0..24)
<span class="lineNum">     859 </span>            : //     * @return GST in hours (0..24)
<span class="lineNum">     860 </span>            : //     */
<span class="lineNum">     861 </span>            : //    double lstToGst(double lst) {
<span class="lineNum">     862 </span>            : //        double delta = fLongitude * 24 / CalendarAstronomer_PI2;
<span class="lineNum">     863 </span>            : //        return normalize(lst - delta, 24);
<span class="lineNum">     864 </span>            : //    }
<span class="lineNum">     865 </span>            : 
<span class="lineNum">     866 </span>            : // Commented out - currently unused. ICU 2.6, Alan
<span class="lineNum">     867 </span>            : //    /**
<span class="lineNum">     868 </span>            : //     * Convert UT to GST on this date.
<span class="lineNum">     869 </span>            : //     * Section 12.  Duffett-Smith p.17
<span class="lineNum">     870 </span>            : //     * @param ut in hours
<span class="lineNum">     871 </span>            : //     * @return GST in hours
<span class="lineNum">     872 </span>            : //     */
<span class="lineNum">     873 </span>            : //    double utToGst(double ut) {
<span class="lineNum">     874 </span>            : //        return normalize(getT0() + ut*1.002737909, 24);
<span class="lineNum">     875 </span>            : //    }
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span>            : // Commented out - currently unused. ICU 2.6, Alan
<span class="lineNum">     878 </span>            : //    /**
<span class="lineNum">     879 </span>            : //     * Convert GST to UT on this date.
<span class="lineNum">     880 </span>            : //     * Section 13.  Duffett-Smith p.18
<span class="lineNum">     881 </span>            : //     * @param gst in hours
<span class="lineNum">     882 </span>            : //     * @return UT in hours
<span class="lineNum">     883 </span>            : //     */
<span class="lineNum">     884 </span>            : //    double gstToUt(double gst) {
<span class="lineNum">     885 </span>            : //        return normalize(gst - getT0(), 24) * 0.9972695663;
<span class="lineNum">     886 </span>            : //    }
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span>            : // Commented out - currently unused. ICU 2.6, Alan
<span class="lineNum">     889 </span>            : //    double getT0() {
<span class="lineNum">     890 </span>            : //        // Common computation for UT &lt;=&gt; GST
<span class="lineNum">     891 </span>            : //
<span class="lineNum">     892 </span>            : //        // Find JD for 0h UT
<span class="lineNum">     893 </span>            : //        double jd = uprv_floor(getJulianDay() - 0.5) + 0.5;
<span class="lineNum">     894 </span>            : //
<span class="lineNum">     895 </span>            : //        double s = jd - 2451545.0;
<span class="lineNum">     896 </span>            : //        double t = s / 36525.0;
<span class="lineNum">     897 </span>            : //        double t0 = 6.697374558 + (2400.051336 + 0.000025862*t)*t;
<span class="lineNum">     898 </span>            : //        return t0;
<span class="lineNum">     899 </span>            : //    }
<span class="lineNum">     900 </span>            : 
<span class="lineNum">     901 </span>            : // Commented out - currently unused. ICU 2.6, Alan
<span class="lineNum">     902 </span>            : //    //-------------------------------------------------------------------------
<span class="lineNum">     903 </span>            : //    // Alternate Sun Rise/Set
<span class="lineNum">     904 </span>            : //    // See sci.astro FAQ
<span class="lineNum">     905 </span>            : //    // http://www.faqs.org/faqs/astronomy/faq/part3/section-5.html
<span class="lineNum">     906 </span>            : //    //-------------------------------------------------------------------------
<span class="lineNum">     907 </span>            : //
<span class="lineNum">     908 </span>            : //    // Note: This method appears to produce inferior accuracy as
<span class="lineNum">     909 </span>            : //    // compared to getSunRiseSet().
<span class="lineNum">     910 </span>            : //
<span class="lineNum">     911 </span>            : //    /**
<span class="lineNum">     912 </span>            : //     * TODO Make this when the entire class is package-private.
<span class="lineNum">     913 </span>            : //     */
<span class="lineNum">     914 </span>            : //    /*public*/ long getSunRiseSet3(boolean rise) {
<span class="lineNum">     915 </span>            : //
<span class="lineNum">     916 </span>            : //        // Compute day number for 0.0 Jan 2000 epoch
<span class="lineNum">     917 </span>            : //        double d = (double)(time - EPOCH_2000_MS) / DAY_MS;
<span class="lineNum">     918 </span>            : //
<span class="lineNum">     919 </span>            : //        // Now compute the Local Sidereal Time, LST:
<span class="lineNum">     920 </span>            : //        //
<span class="lineNum">     921 </span>            : //        double LST  =  98.9818  +  0.985647352 * d  +  /*UT*15  +  long*/
<span class="lineNum">     922 </span>            : //            fLongitude*RAD_DEG;
<span class="lineNum">     923 </span>            : //        //
<span class="lineNum">     924 </span>            : //        // (east long. positive).  Note that LST is here expressed in degrees,
<span class="lineNum">     925 </span>            : //        // where 15 degrees corresponds to one hour.  Since LST really is an angle,
<span class="lineNum">     926 </span>            : //        // it's convenient to use one unit---degrees---throughout.
<span class="lineNum">     927 </span>            : //
<span class="lineNum">     928 </span>            : //        //    COMPUTING THE SUN'S POSITION
<span class="lineNum">     929 </span>            : //        //    ----------------------------
<span class="lineNum">     930 </span>            : //        //
<span class="lineNum">     931 </span>            : //        // To be able to compute the Sun's rise/set times, you need to be able to
<span class="lineNum">     932 </span>            : //        // compute the Sun's position at any time.  First compute the &quot;day
<span class="lineNum">     933 </span>            : //        // number&quot; d as outlined above, for the desired moment.  Next compute:
<span class="lineNum">     934 </span>            : //        //
<span class="lineNum">     935 </span>            : //        double oblecl = 23.4393 - 3.563E-7 * d;
<span class="lineNum">     936 </span>            : //        //
<span class="lineNum">     937 </span>            : //        double w  =  282.9404  +  4.70935E-5   * d;
<span class="lineNum">     938 </span>            : //        double M  =  356.0470  +  0.9856002585 * d;
<span class="lineNum">     939 </span>            : //        double e  =  0.016709  -  1.151E-9     * d;
<span class="lineNum">     940 </span>            : //        //
<span class="lineNum">     941 </span>            : //        // This is the obliquity of the ecliptic, plus some of the elements of
<span class="lineNum">     942 </span>            : //        // the Sun's apparent orbit (i.e., really the Earth's orbit): w =
<span class="lineNum">     943 </span>            : //        // argument of perihelion, M = mean anomaly, e = eccentricity.
<span class="lineNum">     944 </span>            : //        // Semi-major axis is here assumed to be exactly 1.0 (while not strictly
<span class="lineNum">     945 </span>            : //        // true, this is still an accurate approximation).  Next compute E, the
<span class="lineNum">     946 </span>            : //        // eccentric anomaly:
<span class="lineNum">     947 </span>            : //        //
<span class="lineNum">     948 </span>            : //        double E = M + e*(180/PI) * ::sin(M*DEG_RAD) * ( 1.0 + e*cos(M*DEG_RAD) );
<span class="lineNum">     949 </span>            : //        //
<span class="lineNum">     950 </span>            : //        // where E and M are in degrees.  This is it---no further iterations are
<span class="lineNum">     951 </span>            : //        // needed because we know e has a sufficiently small value.  Next compute
<span class="lineNum">     952 </span>            : //        // the true anomaly, v, and the distance, r:
<span class="lineNum">     953 </span>            : //        //
<span class="lineNum">     954 </span>            : //        /*      r * cos(v)  =  */ double A  =  cos(E*DEG_RAD) - e;
<span class="lineNum">     955 </span>            : //        /*      r * ::sin(v)  =  */ double B  =  ::sqrt(1 - e*e) * ::sin(E*DEG_RAD);
<span class="lineNum">     956 </span>            : //        //
<span class="lineNum">     957 </span>            : //        // and
<span class="lineNum">     958 </span>            : //        //
<span class="lineNum">     959 </span>            : //        //      r  =  sqrt( A*A + B*B )
<span class="lineNum">     960 </span>            : //        double v  =  ::atan2( B, A )*RAD_DEG;
<span class="lineNum">     961 </span>            : //        //
<span class="lineNum">     962 </span>            : //        // The Sun's true longitude, slon, can now be computed:
<span class="lineNum">     963 </span>            : //        //
<span class="lineNum">     964 </span>            : //        double slon  =  v + w;
<span class="lineNum">     965 </span>            : //        //
<span class="lineNum">     966 </span>            : //        // Since the Sun is always at the ecliptic (or at least very very close to
<span class="lineNum">     967 </span>            : //        // it), we can use simplified formulae to convert slon (the Sun's ecliptic
<span class="lineNum">     968 </span>            : //        // longitude) to sRA and sDec (the Sun's RA and Dec):
<span class="lineNum">     969 </span>            : //        //
<span class="lineNum">     970 </span>            : //        //                   ::sin(slon) * cos(oblecl)
<span class="lineNum">     971 </span>            : //        //     tan(sRA)  =  -------------------------
<span class="lineNum">     972 </span>            : //        //            cos(slon)
<span class="lineNum">     973 </span>            : //        //
<span class="lineNum">     974 </span>            : //        //     ::sin(sDec) =  ::sin(oblecl) * ::sin(slon)
<span class="lineNum">     975 </span>            : //        //
<span class="lineNum">     976 </span>            : //        // As was the case when computing az, the Azimuth, if possible use an
<span class="lineNum">     977 </span>            : //        // atan2() function to compute sRA.
<span class="lineNum">     978 </span>            : //
<span class="lineNum">     979 </span>            : //        double sRA = ::atan2(sin(slon*DEG_RAD) * cos(oblecl*DEG_RAD), cos(slon*DEG_RAD))*RAD_DEG;
<span class="lineNum">     980 </span>            : //
<span class="lineNum">     981 </span>            : //        double sin_sDec = ::sin(oblecl*DEG_RAD) * ::sin(slon*DEG_RAD);
<span class="lineNum">     982 </span>            : //        double sDec = ::asin(sin_sDec)*RAD_DEG;
<span class="lineNum">     983 </span>            : //
<span class="lineNum">     984 </span>            : //        //    COMPUTING RISE AND SET TIMES
<span class="lineNum">     985 </span>            : //        //    ----------------------------
<span class="lineNum">     986 </span>            : //        //
<span class="lineNum">     987 </span>            : //        // To compute when an object rises or sets, you must compute when it
<span class="lineNum">     988 </span>            : //        // passes the meridian and the HA of rise/set.  Then the rise time is
<span class="lineNum">     989 </span>            : //        // the meridian time minus HA for rise/set, and the set time is the
<span class="lineNum">     990 </span>            : //        // meridian time plus the HA for rise/set.
<span class="lineNum">     991 </span>            : //        //
<span class="lineNum">     992 </span>            : //        // To find the meridian time, compute the Local Sidereal Time at 0h local
<span class="lineNum">     993 </span>            : //        // time (or 0h UT if you prefer to work in UT) as outlined above---name
<span class="lineNum">     994 </span>            : //        // that quantity LST0.  The Meridian Time, MT, will now be:
<span class="lineNum">     995 </span>            : //        //
<span class="lineNum">     996 </span>            : //        //     MT  =  RA - LST0
<span class="lineNum">     997 </span>            : //        double MT = normalize(sRA - LST, 360);
<span class="lineNum">     998 </span>            : //        //
<span class="lineNum">     999 </span>            : //        // where &quot;RA&quot; is the object's Right Ascension (in degrees!).  If negative,
<span class="lineNum">    1000 </span>            : //        // add 360 deg to MT.  If the object is the Sun, leave the time as it is,
<span class="lineNum">    1001 </span>            : //        // but if it's stellar, multiply MT by 365.2422/366.2422, to convert from
<span class="lineNum">    1002 </span>            : //        // sidereal to solar time.  Now, compute HA for rise/set, name that
<span class="lineNum">    1003 </span>            : //        // quantity HA0:
<span class="lineNum">    1004 </span>            : //        //
<span class="lineNum">    1005 </span>            : //        //                 ::sin(h0)  -  ::sin(lat) * ::sin(Dec)
<span class="lineNum">    1006 </span>            : //        // cos(HA0)  =  ---------------------------------
<span class="lineNum">    1007 </span>            : //        //                      cos(lat) * cos(Dec)
<span class="lineNum">    1008 </span>            : //        //
<span class="lineNum">    1009 </span>            : //        // where h0 is the altitude selected to represent rise/set.  For a purely
<span class="lineNum">    1010 </span>            : //        // mathematical horizon, set h0 = 0 and simplify to:
<span class="lineNum">    1011 </span>            : //        //
<span class="lineNum">    1012 </span>            : //        //    cos(HA0)  =  - tan(lat) * tan(Dec)
<span class="lineNum">    1013 </span>            : //        //
<span class="lineNum">    1014 </span>            : //        // If you want to account for refraction on the atmosphere, set h0 = -35/60
<span class="lineNum">    1015 </span>            : //        // degrees (-35 arc minutes), and if you want to compute the rise/set times
<span class="lineNum">    1016 </span>            : //        // for the Sun's upper limb, set h0 = -50/60 (-50 arc minutes).
<span class="lineNum">    1017 </span>            : //        //
<span class="lineNum">    1018 </span>            : //        double h0 = -50/60 * DEG_RAD;
<span class="lineNum">    1019 </span>            : //
<span class="lineNum">    1020 </span>            : //        double HA0 = ::acos(
<span class="lineNum">    1021 </span>            : //          (sin(h0) - ::sin(fLatitude) * sin_sDec) /
<span class="lineNum">    1022 </span>            : //          (cos(fLatitude) * cos(sDec*DEG_RAD)))*RAD_DEG;
<span class="lineNum">    1023 </span>            : //
<span class="lineNum">    1024 </span>            : //        // When HA0 has been computed, leave it as it is for the Sun but multiply
<span class="lineNum">    1025 </span>            : //        // by 365.2422/366.2422 for stellar objects, to convert from sidereal to
<span class="lineNum">    1026 </span>            : //        // solar time.  Finally compute:
<span class="lineNum">    1027 </span>            : //        //
<span class="lineNum">    1028 </span>            : //        //    Rise time  =  MT - HA0
<span class="lineNum">    1029 </span>            : //        //    Set  time  =  MT + HA0
<span class="lineNum">    1030 </span>            : //        //
<span class="lineNum">    1031 </span>            : //        // convert the times from degrees to hours by dividing by 15.
<span class="lineNum">    1032 </span>            : //        //
<span class="lineNum">    1033 </span>            : //        // If you'd like to check that your calculations are accurate or just
<span class="lineNum">    1034 </span>            : //        // need a quick result, check the USNO's Sun or Moon Rise/Set Table,
<span class="lineNum">    1035 </span>            : //        // &lt;URL:http://aa.usno.navy.mil/AA/data/docs/RS_OneYear.html&gt;.
<span class="lineNum">    1036 </span>            : //
<span class="lineNum">    1037 </span>            : //        double result = MT + (rise ? -HA0 : HA0); // in degrees
<span class="lineNum">    1038 </span>            : //
<span class="lineNum">    1039 </span>            : //        // Find UT midnight on this day
<span class="lineNum">    1040 </span>            : //        long midnight = DAY_MS * (time / DAY_MS);
<span class="lineNum">    1041 </span>            : //
<span class="lineNum">    1042 </span>            : //        return midnight + (long) (result * 3600000 / 15);
<span class="lineNum">    1043 </span>            : //    }
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">    1046 </span>            : // The Moon
<span class="lineNum">    1047 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">    1048 </span>            : 
<span class="lineNum">    1049 </span>            : #define moonL0  (318.351648 * CalendarAstronomer::PI/180 )   // Mean long. at epoch
<span class="lineNum">    1050 </span>            : #define moonP0 ( 36.340410 * CalendarAstronomer::PI/180 )   // Mean long. of perigee
<span class="lineNum">    1051 </span>            : #define moonN0 ( 318.510107 * CalendarAstronomer::PI/180 )   // Mean long. of node
<span class="lineNum">    1052 </span>            : #define moonI  (   5.145366 * CalendarAstronomer::PI/180 )   // Inclination of orbit
<span class="lineNum">    1053 </span>            : #define moonE  (   0.054900 )            // Eccentricity of orbit
<span class="lineNum">    1054 </span>            : 
<span class="lineNum">    1055 </span>            : // These aren't used right now
<span class="lineNum">    1056 </span>            : #define moonA  (   3.84401e5 )           // semi-major axis (km)
<span class="lineNum">    1057 </span>            : #define moonT0 (   0.5181 * CalendarAstronomer::PI/180 )     // Angular size at distance A
<span class="lineNum">    1058 </span>            : #define moonPi (   0.9507 * CalendarAstronomer::PI/180 )     // Parallax at distance A
<span class="lineNum">    1059 </span>            : 
<span class="lineNum">    1060 </span>            : /**
<span class="lineNum">    1061 </span>            :  * The position of the moon at the time set on this
<span class="lineNum">    1062 </span>            :  * object, in equatorial coordinates.
<span class="lineNum">    1063 </span>            :  * @internal
<a name="1064"><span class="lineNum">    1064 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">    1065 </span>            :  */
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 : const CalendarAstronomer::Equatorial&amp; CalendarAstronomer::getMoonPosition()</span>
<span class="lineNum">    1067 </span>            : {
<span class="lineNum">    1068 </span>            :     //
<span class="lineNum">    1069 </span>            :     // See page 142 of &quot;Practial Astronomy with your Calculator&quot;,
<span class="lineNum">    1070 </span>            :     // by Peter Duffet-Smith, for details on the algorithm.
<span class="lineNum">    1071 </span>            :     //
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :     if (moonPositionSet == FALSE) {</span>
<span class="lineNum">    1073 </span>            :         // Calculate the solar longitude.  Has the side effect of
<span class="lineNum">    1074 </span>            :         // filling in &quot;meanAnomalySun&quot; as well.
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :         getSunLongitude();</span>
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span>            :         //
<span class="lineNum">    1078 </span>            :         // Find the # of days since the epoch of our orbital parameters.
<span class="lineNum">    1079 </span>            :         // TODO: Convert the time of day portion into ephemeris time
<span class="lineNum">    1080 </span>            :         //
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :         double day = getJulianDay() - JD_EPOCH;       // Days since epoch</span>
<span class="lineNum">    1082 </span>            : 
<span class="lineNum">    1083 </span>            :         // Calculate the mean longitude and anomaly of the moon, based on
<span class="lineNum">    1084 </span>            :         // a circular orbit.  Similar to the corresponding solar calculation.
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :         double meanLongitude = norm2PI(13.1763966*PI/180*day + moonL0);</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :         meanAnomalyMoon = norm2PI(meanLongitude - 0.1114041*PI/180 * day - moonP0);</span>
<span class="lineNum">    1087 </span>            : 
<span class="lineNum">    1088 </span>            :         //
<span class="lineNum">    1089 </span>            :         // Calculate the following corrections:
<span class="lineNum">    1090 </span>            :         //  Evection:   the sun's gravity affects the moon's eccentricity
<span class="lineNum">    1091 </span>            :         //  Annual Eqn: variation in the effect due to earth-sun distance
<span class="lineNum">    1092 </span>            :         //  A3:         correction factor (for ???)
<span class="lineNum">    1093 </span>            :         //
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :         double evection = 1.2739*PI/180 * ::sin(2 * (meanLongitude - sunLongitude)</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :             - meanAnomalyMoon);</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :         double annual   = 0.1858*PI/180 * ::sin(meanAnomalySun);</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :         double a3       = 0.3700*PI/180 * ::sin(meanAnomalySun);</span>
<span class="lineNum">    1098 </span>            : 
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :         meanAnomalyMoon += evection - annual - a3;</span>
<span class="lineNum">    1100 </span>            : 
<span class="lineNum">    1101 </span>            :         //
<span class="lineNum">    1102 </span>            :         // More correction factors:
<span class="lineNum">    1103 </span>            :         //  center  equation of the center correction
<span class="lineNum">    1104 </span>            :         //  a4      yet another error correction (???)
<span class="lineNum">    1105 </span>            :         //
<span class="lineNum">    1106 </span>            :         // TODO: Skip the equation of the center correction and solve Kepler's eqn?
<span class="lineNum">    1107 </span>            :         //
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :         double center = 6.2886*PI/180 * ::sin(meanAnomalyMoon);</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :         double a4 =     0.2140*PI/180 * ::sin(2 * meanAnomalyMoon);</span>
<span class="lineNum">    1110 </span>            : 
<span class="lineNum">    1111 </span>            :         // Now find the moon's corrected longitude
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :         moonLongitude = meanLongitude + evection + center - annual + a4;</span>
<span class="lineNum">    1113 </span>            : 
<span class="lineNum">    1114 </span>            :         //
<span class="lineNum">    1115 </span>            :         // And finally, find the variation, caused by the fact that the sun's
<span class="lineNum">    1116 </span>            :         // gravitational pull on the moon varies depending on which side of
<span class="lineNum">    1117 </span>            :         // the earth the moon is on
<span class="lineNum">    1118 </span>            :         //
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :         double variation = 0.6583*CalendarAstronomer::PI/180 * ::sin(2*(moonLongitude - sunLongitude));</span>
<span class="lineNum">    1120 </span>            : 
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :         moonLongitude += variation;</span>
<span class="lineNum">    1122 </span>            : 
<span class="lineNum">    1123 </span>            :         //
<span class="lineNum">    1124 </span>            :         // What we've calculated so far is the moon's longitude in the plane
<span class="lineNum">    1125 </span>            :         // of its own orbit.  Now map to the ecliptic to get the latitude
<span class="lineNum">    1126 </span>            :         // and longitude.  First we need to find the longitude of the ascending
<span class="lineNum">    1127 </span>            :         // node, the position on the ecliptic where it is crossed by the moon's
<span class="lineNum">    1128 </span>            :         // orbit as it crosses from the southern to the northern hemisphere.
<span class="lineNum">    1129 </span>            :         //
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :         double nodeLongitude = norm2PI(moonN0 - 0.0529539*PI/180 * day);</span>
<span class="lineNum">    1131 </span>            : 
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :         nodeLongitude -= 0.16*PI/180 * ::sin(meanAnomalySun);</span>
<span class="lineNum">    1133 </span>            : 
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :         double y = ::sin(moonLongitude - nodeLongitude);</span>
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :         double x = cos(moonLongitude - nodeLongitude);</span>
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :         moonEclipLong = ::atan2(y*cos(moonI), x) + nodeLongitude;</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :         double moonEclipLat = ::asin(y * ::sin(moonI));</span>
<span class="lineNum">    1139 </span>            : 
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :         eclipticToEquatorial(moonPosition, moonEclipLong, moonEclipLat);</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :         moonPositionSet = TRUE;</span>
<span class="lineNum">    1142 </span>            :     }
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :     return moonPosition;</span>
<span class="lineNum">    1144 </span>            : }
<span class="lineNum">    1145 </span>            : 
<span class="lineNum">    1146 </span>            : /**
<span class="lineNum">    1147 </span>            :  * The &quot;age&quot; of the moon at the time specified in this object.
<span class="lineNum">    1148 </span>            :  * This is really the angle between the
<span class="lineNum">    1149 </span>            :  * current ecliptic longitudes of the sun and the moon,
<span class="lineNum">    1150 </span>            :  * measured in radians.
<span class="lineNum">    1151 </span>            :  *
<span class="lineNum">    1152 </span>            :  * @see #getMoonPhase
<span class="lineNum">    1153 </span>            :  * @internal
<a name="1154"><span class="lineNum">    1154 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">    1155 </span>            :  */
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 : double CalendarAstronomer::getMoonAge() {</span>
<span class="lineNum">    1157 </span>            :     // See page 147 of &quot;Practial Astronomy with your Calculator&quot;,
<span class="lineNum">    1158 </span>            :     // by Peter Duffet-Smith, for details on the algorithm.
<span class="lineNum">    1159 </span>            :     //
<span class="lineNum">    1160 </span>            :     // Force the moon's position to be calculated.  We're going to use
<span class="lineNum">    1161 </span>            :     // some the intermediate results cached during that calculation.
<span class="lineNum">    1162 </span>            :     //
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :     getMoonPosition();</span>
<span class="lineNum">    1164 </span>            : 
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :     return norm2PI(moonEclipLong - sunLongitude);</span>
<span class="lineNum">    1166 </span>            : }
<span class="lineNum">    1167 </span>            : 
<span class="lineNum">    1168 </span>            : /**
<span class="lineNum">    1169 </span>            :  * Calculate the phase of the moon at the time set in this object.
<span class="lineNum">    1170 </span>            :  * The returned phase is a &lt;code&gt;double&lt;/code&gt; in the range
<span class="lineNum">    1171 </span>            :  * &lt;code&gt;0 &lt;= phase &lt; 1&lt;/code&gt;, interpreted as follows:
<span class="lineNum">    1172 </span>            :  * &lt;ul&gt;
<span class="lineNum">    1173 </span>            :  * &lt;li&gt;0.00: New moon
<span class="lineNum">    1174 </span>            :  * &lt;li&gt;0.25: First quarter
<span class="lineNum">    1175 </span>            :  * &lt;li&gt;0.50: Full moon
<span class="lineNum">    1176 </span>            :  * &lt;li&gt;0.75: Last quarter
<span class="lineNum">    1177 </span>            :  * &lt;/ul&gt;
<span class="lineNum">    1178 </span>            :  *
<span class="lineNum">    1179 </span>            :  * @see #getMoonAge
<span class="lineNum">    1180 </span>            :  * @internal
<a name="1181"><span class="lineNum">    1181 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">    1182 </span>            :  */
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 : double CalendarAstronomer::getMoonPhase() {</span>
<span class="lineNum">    1184 </span>            :     // See page 147 of &quot;Practial Astronomy with your Calculator&quot;,
<span class="lineNum">    1185 </span>            :     // by Peter Duffet-Smith, for details on the algorithm.
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :     return 0.5 * (1 - cos(getMoonAge()));</span>
<span class="lineNum">    1187 </span>            : }
<span class="lineNum">    1188 </span>            : 
<span class="lineNum">    1189 </span>            : /**
<span class="lineNum">    1190 </span>            :  * Constant representing a new moon.
<span class="lineNum">    1191 </span>            :  * For use with {@link #getMoonTime getMoonTime}
<span class="lineNum">    1192 </span>            :  * @internal
<a name="1193"><span class="lineNum">    1193 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">    1194 </span>            :  */
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 : const CalendarAstronomer::MoonAge CalendarAstronomer::NEW_MOON() {</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :     return  CalendarAstronomer::MoonAge(0);</span>
<span class="lineNum">    1197 </span>            : }
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span>            : /**
<span class="lineNum">    1200 </span>            :  * Constant representing the moon's first quarter.
<span class="lineNum">    1201 </span>            :  * For use with {@link #getMoonTime getMoonTime}
<span class="lineNum">    1202 </span>            :  * @internal
<span class="lineNum">    1203 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">    1204 </span>            :  */
<span class="lineNum">    1205 </span>            : /*const CalendarAstronomer::MoonAge CalendarAstronomer::FIRST_QUARTER() {
<span class="lineNum">    1206 </span>            :   return   CalendarAstronomer::MoonAge(CalendarAstronomer::PI/2);
<span class="lineNum">    1207 </span>            : }*/
<span class="lineNum">    1208 </span>            : 
<span class="lineNum">    1209 </span>            : /**
<span class="lineNum">    1210 </span>            :  * Constant representing a full moon.
<span class="lineNum">    1211 </span>            :  * For use with {@link #getMoonTime getMoonTime}
<span class="lineNum">    1212 </span>            :  * @internal
<a name="1213"><span class="lineNum">    1213 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">    1214 </span>            :  */
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 : const CalendarAstronomer::MoonAge CalendarAstronomer::FULL_MOON() {</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :     return   CalendarAstronomer::MoonAge(CalendarAstronomer::PI);</span>
<span class="lineNum">    1217 </span>            : }
<span class="lineNum">    1218 </span>            : /**
<span class="lineNum">    1219 </span>            :  * Constant representing the moon's last quarter.
<span class="lineNum">    1220 </span>            :  * For use with {@link #getMoonTime getMoonTime}
<span class="lineNum">    1221 </span>            :  * @internal
<span class="lineNum">    1222 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">    1223 </span>            :  */
<span class="lineNum">    1224 </span>            : 
<span class="lineNum">    1225 </span>            : class MoonTimeAngleFunc : public CalendarAstronomer::AngleFunc {
<a name="1226"><span class="lineNum">    1226 </span>            : public:</a>
<span class="lineNum">    1227 </span>            :     virtual ~MoonTimeAngleFunc();
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :     virtual double eval(CalendarAstronomer&amp;a) { return a.getMoonAge(); }</span>
<a name="1229"><span class="lineNum">    1229 </span>            : };</a>
<span class="lineNum">    1230 </span>            : 
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 : MoonTimeAngleFunc::~MoonTimeAngleFunc() {}</span>
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span>            : /*const CalendarAstronomer::MoonAge CalendarAstronomer::LAST_QUARTER() {
<span class="lineNum">    1234 </span>            :   return  CalendarAstronomer::MoonAge((CalendarAstronomer::PI*3)/2);
<span class="lineNum">    1235 </span>            : }*/
<span class="lineNum">    1236 </span>            : 
<span class="lineNum">    1237 </span>            : /**
<span class="lineNum">    1238 </span>            :  * Find the next or previous time at which the Moon's ecliptic
<span class="lineNum">    1239 </span>            :  * longitude will have the desired value.
<span class="lineNum">    1240 </span>            :  * &lt;p&gt;
<span class="lineNum">    1241 </span>            :  * @param desired   The desired longitude.
<span class="lineNum">    1242 </span>            :  * @param next      &lt;tt&gt;true&lt;/tt&gt; if the next occurrance of the phase
<span class="lineNum">    1243 </span>            :  *                  is desired, &lt;tt&gt;false&lt;/tt&gt; for the previous occurrance.
<span class="lineNum">    1244 </span>            :  * @internal
<a name="1245"><span class="lineNum">    1245 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">    1246 </span>            :  */
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 : UDate CalendarAstronomer::getMoonTime(double desired, UBool next)</span>
<span class="lineNum">    1248 </span>            : {
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :     MoonTimeAngleFunc func;</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :     return timeOfAngle( func,</span>
<span class="lineNum">    1251 </span>            :                         desired,
<span class="lineNum">    1252 </span>            :                         SYNODIC_MONTH,
<span class="lineNum">    1253 </span>            :                         MINUTE_MS,
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :                         next);</span>
<span class="lineNum">    1255 </span>            : }
<span class="lineNum">    1256 </span>            : 
<span class="lineNum">    1257 </span>            : /**
<span class="lineNum">    1258 </span>            :  * Find the next or previous time at which the moon will be in the
<span class="lineNum">    1259 </span>            :  * desired phase.
<span class="lineNum">    1260 </span>            :  * &lt;p&gt;
<span class="lineNum">    1261 </span>            :  * @param desired   The desired phase of the moon.
<span class="lineNum">    1262 </span>            :  * @param next      &lt;tt&gt;true&lt;/tt&gt; if the next occurrance of the phase
<span class="lineNum">    1263 </span>            :  *                  is desired, &lt;tt&gt;false&lt;/tt&gt; for the previous occurrance.
<span class="lineNum">    1264 </span>            :  * @internal
<a name="1265"><span class="lineNum">    1265 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">    1266 </span>            :  */
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 : UDate CalendarAstronomer::getMoonTime(const CalendarAstronomer::MoonAge&amp; desired, UBool next) {</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :     return getMoonTime(desired.value, next);</span>
<span class="lineNum">    1269 </span>            : }
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span>            : class MoonRiseSetCoordFunc : public CalendarAstronomer::CoordFunc {
<a name="1272"><span class="lineNum">    1272 </span>            : public:</a>
<span class="lineNum">    1273 </span>            :     virtual ~MoonRiseSetCoordFunc();
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :     virtual void eval(CalendarAstronomer::Equatorial&amp; result, CalendarAstronomer&amp;a) { result = a.getMoonPosition(); }</span>
<a name="1275"><span class="lineNum">    1275 </span>            : };</a>
<span class="lineNum">    1276 </span>            : 
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 : MoonRiseSetCoordFunc::~MoonRiseSetCoordFunc() {}</span>
<span class="lineNum">    1278 </span>            : 
<span class="lineNum">    1279 </span>            : /**
<span class="lineNum">    1280 </span>            :  * Returns the time (GMT) of sunrise or sunset on the local date to which
<span class="lineNum">    1281 </span>            :  * this calendar is currently set.
<span class="lineNum">    1282 </span>            :  * @internal
<a name="1283"><span class="lineNum">    1283 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.</a>
<span class="lineNum">    1284 </span>            :  */
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 : UDate CalendarAstronomer::getMoonRiseSet(UBool rise)</span>
<span class="lineNum">    1286 </span>            : {
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :     MoonRiseSetCoordFunc func;</span>
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :     return riseOrSet(func,</span>
<span class="lineNum">    1289 </span>            :                      rise,
<span class="lineNum">    1290 </span>            :                      .533 * DEG_RAD,        // Angular Diameter
<span class="lineNum">    1291 </span>            :                      34 /60.0 * DEG_RAD,    // Refraction correction
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :                      MINUTE_MS);            // Desired accuracy</span>
<span class="lineNum">    1293 </span>            : }
<span class="lineNum">    1294 </span>            : 
<span class="lineNum">    1295 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">    1296 </span>            : // Interpolation methods for finding the time at which a given event occurs
<a name="1297"><span class="lineNum">    1297 </span>            : //-------------------------------------------------------------------------</a>
<span class="lineNum">    1298 </span>            : 
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 : UDate CalendarAstronomer::timeOfAngle(AngleFunc&amp; func, double desired,</span>
<span class="lineNum">    1300 </span>            :                                       double periodDays, double epsilon, UBool next)
<span class="lineNum">    1301 </span>            : {
<span class="lineNum">    1302 </span>            :     // Find the value of the function at the current time
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :     double lastAngle = func.eval(*this);</span>
<span class="lineNum">    1304 </span>            : 
<span class="lineNum">    1305 </span>            :     // Find out how far we are from the desired angle
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :     double deltaAngle = norm2PI(desired - lastAngle) ;</span>
<span class="lineNum">    1307 </span>            : 
<span class="lineNum">    1308 </span>            :     // Using the average period, estimate the next (or previous) time at
<span class="lineNum">    1309 </span>            :     // which the desired angle occurs.
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :     double deltaT =  (deltaAngle + (next ? 0.0 : - CalendarAstronomer_PI2 )) * (periodDays*DAY_MS) / CalendarAstronomer_PI2;</span>
<span class="lineNum">    1311 </span>            : 
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :     double lastDeltaT = deltaT; // Liu</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :     UDate startTime = fTime; // Liu</span>
<span class="lineNum">    1314 </span>            : 
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :     setTime(fTime + uprv_ceil(deltaT));</span>
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span>            :     // Now iterate until we get the error below epsilon.  Throughout
<span class="lineNum">    1318 </span>            :     // this loop we use normPI to get values in the range -Pi to Pi,
<span class="lineNum">    1319 </span>            :     // since we're using them as correction factors rather than absolute angles.
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :     do {</span>
<span class="lineNum">    1321 </span>            :         // Evaluate the function at the time we've estimated
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :         double angle = func.eval(*this);</span>
<span class="lineNum">    1323 </span>            : 
<span class="lineNum">    1324 </span>            :         // Find the # of milliseconds per radian at this point on the curve
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :         double factor = uprv_fabs(deltaT / normPI(angle-lastAngle));</span>
<span class="lineNum">    1326 </span>            : 
<span class="lineNum">    1327 </span>            :         // Correct the time estimate based on how far off the angle is
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :         deltaT = normPI(desired - angle) * factor;</span>
<span class="lineNum">    1329 </span>            : 
<span class="lineNum">    1330 </span>            :         // HACK:
<span class="lineNum">    1331 </span>            :         //
<span class="lineNum">    1332 </span>            :         // If abs(deltaT) begins to diverge we need to quit this loop.
<span class="lineNum">    1333 </span>            :         // This only appears to happen when attempting to locate, for
<span class="lineNum">    1334 </span>            :         // example, a new moon on the day of the new moon.  E.g.:
<span class="lineNum">    1335 </span>            :         //
<span class="lineNum">    1336 </span>            :         // This result is correct:
<span class="lineNum">    1337 </span>            :         // newMoon(7508(Mon Jul 23 00:00:00 CST 1990,false))=
<span class="lineNum">    1338 </span>            :         //   Sun Jul 22 10:57:41 CST 1990
<span class="lineNum">    1339 </span>            :         //
<span class="lineNum">    1340 </span>            :         // But attempting to make the same call a day earlier causes deltaT
<span class="lineNum">    1341 </span>            :         // to diverge:
<span class="lineNum">    1342 </span>            :         // CalendarAstronomer.timeOfAngle() diverging: 1.348508727575625E9 -&gt;
<span class="lineNum">    1343 </span>            :         //   1.3649828540224032E9
<span class="lineNum">    1344 </span>            :         // newMoon(7507(Sun Jul 22 00:00:00 CST 1990,false))=
<span class="lineNum">    1345 </span>            :         //   Sun Jul 08 13:56:15 CST 1990
<span class="lineNum">    1346 </span>            :         //
<span class="lineNum">    1347 </span>            :         // As a temporary solution, we catch this specific condition and
<span class="lineNum">    1348 </span>            :         // adjust our start time by one eighth period days (either forward
<span class="lineNum">    1349 </span>            :         // or backward) and try again.
<span class="lineNum">    1350 </span>            :         // Liu 11/9/00
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :         if (uprv_fabs(deltaT) &gt; uprv_fabs(lastDeltaT)) {</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :             double delta = uprv_ceil (periodDays * DAY_MS / 8.0);</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :             setTime(startTime + (next ? delta : -delta));</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :             return timeOfAngle(func, desired, periodDays, epsilon, next);</span>
<span class="lineNum">    1355 </span>            :         }
<span class="lineNum">    1356 </span>            : 
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :         lastDeltaT = deltaT;</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :         lastAngle = angle;</span>
<span class="lineNum">    1359 </span>            : 
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :         setTime(fTime + uprv_ceil(deltaT));</span>
<span class="lineNum">    1361 </span>            :     }
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :     while (uprv_fabs(deltaT) &gt; epsilon);</span>
<span class="lineNum">    1363 </span>            : 
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :     return fTime;</span>
<a name="1365"><span class="lineNum">    1365 </span>            : }</a>
<span class="lineNum">    1366 </span>            : 
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 : UDate CalendarAstronomer::riseOrSet(CoordFunc&amp; func, UBool rise,</span>
<span class="lineNum">    1368 </span>            :                                     double diameter, double refraction,
<span class="lineNum">    1369 </span>            :                                     double epsilon)
<span class="lineNum">    1370 </span>            : {
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :     Equatorial pos;</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :     double      tanL   = ::tan(fLatitude);</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :     double     deltaT = 0;</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :     int32_t         count = 0;</span>
<span class="lineNum">    1375 </span>            : 
<span class="lineNum">    1376 </span>            :     //
<span class="lineNum">    1377 </span>            :     // Calculate the object's position at the current time, then use that
<span class="lineNum">    1378 </span>            :     // position to calculate the time of rising or setting.  The position
<span class="lineNum">    1379 </span>            :     // will be different at that time, so iterate until the error is allowable.
<span class="lineNum">    1380 </span>            :     //
<span class="lineNum">    1381 </span>            :     U_DEBUG_ASTRO_MSG((&quot;setup rise=%s, dia=%.3lf, ref=%.3lf, eps=%.3lf\n&quot;,
<span class="lineNum">    1382 </span>            :         rise?&quot;T&quot;:&quot;F&quot;, diameter, refraction, epsilon));
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :     do {</span>
<span class="lineNum">    1384 </span>            :         // See &quot;Practical Astronomy With Your Calculator, section 33.
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :         func.eval(pos, *this);</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :         double angle = ::acos(-tanL * ::tan(pos.declination));</span>
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :         double lst = ((rise ? CalendarAstronomer_PI2-angle : angle) + pos.ascension ) * 24 / CalendarAstronomer_PI2;</span>
<span class="lineNum">    1388 </span>            : 
<span class="lineNum">    1389 </span>            :         // Convert from LST to Universal Time.
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :         UDate newTime = lstToUT( lst );</span>
<span class="lineNum">    1391 </span>            : 
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :         deltaT = newTime - fTime;</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :         setTime(newTime);</span>
<span class="lineNum">    1394 </span>            :         U_DEBUG_ASTRO_MSG((&quot;%d] dT=%.3lf, angle=%.3lf, lst=%.3lf,   A=%.3lf/D=%.3lf\n&quot;,
<span class="lineNum">    1395 </span>            :             count, deltaT, angle, lst, pos.ascension, pos.declination));
<span class="lineNum">    1396 </span>            :     }
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :     while (++ count &lt; 5 &amp;&amp; uprv_fabs(deltaT) &gt; epsilon);</span>
<span class="lineNum">    1398 </span>            : 
<span class="lineNum">    1399 </span>            :     // Calculate the correction due to refraction and the object's angular diameter
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :     double cosD  = ::cos(pos.declination);</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :     double psi   = ::acos(sin(fLatitude) / cosD);</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :     double x     = diameter / 2 + refraction;</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :     double y     = ::asin(sin(x) / ::sin(psi));</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :     long  delta  = (long)((240 * y * RAD_DEG / cosD)*SECOND_MS);</span>
<span class="lineNum">    1405 </span>            : 
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :     return fTime + (rise ? -delta : delta);</span>
<span class="lineNum">    1407 </span>            : }
<span class="lineNum">    1408 </span>            :                                                                                            /**
<span class="lineNum">    1409 </span>            :  * Return the obliquity of the ecliptic (the angle between the ecliptic
<span class="lineNum">    1410 </span>            :  * and the earth's equator) at the current time.  This varies due to
<span class="lineNum">    1411 </span>            :  * the precession of the earth's axis.
<span class="lineNum">    1412 </span>            :  *
<span class="lineNum">    1413 </span>            :  * @return  the obliquity of the ecliptic relative to the equator,
<a name="1414"><span class="lineNum">    1414 </span>            :  *          measured in radians.</a>
<span class="lineNum">    1415 </span>            :  */
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 : double CalendarAstronomer::eclipticObliquity() {</span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :     if (isINVALID(eclipObliquity)) {</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :         const double epoch = 2451545.0;     // 2000 AD, January 1.5</span>
<span class="lineNum">    1419 </span>            : 
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :         double T = (getJulianDay() - epoch) / 36525;</span>
<span class="lineNum">    1421 </span>            : 
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :         eclipObliquity = 23.439292</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :             - 46.815/3600 * T</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :             - 0.0006/3600 * T*T</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :             + 0.00181/3600 * T*T*T;</span>
<span class="lineNum">    1426 </span>            : 
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :         eclipObliquity *= DEG_RAD;</span>
<span class="lineNum">    1428 </span>            :     }
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :     return eclipObliquity;</span>
<span class="lineNum">    1430 </span>            : }
<span class="lineNum">    1431 </span>            : 
<span class="lineNum">    1432 </span>            : 
<span class="lineNum">    1433 </span>            : //-------------------------------------------------------------------------
<a name="1434"><span class="lineNum">    1434 </span>            : // Private data</a>
<span class="lineNum">    1435 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 : void CalendarAstronomer::clearCache() {</span>
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :     const double INVALID = uprv_getNaN();</span>
<span class="lineNum">    1438 </span>            : 
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :     julianDay       = INVALID;</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :     julianCentury   = INVALID;</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :     sunLongitude    = INVALID;</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :     meanAnomalySun  = INVALID;</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :     moonLongitude   = INVALID;</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :     moonEclipLong   = INVALID;</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :     meanAnomalyMoon = INVALID;</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :     eclipObliquity  = INVALID;</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :     siderealTime    = INVALID;</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :     siderealT0      = INVALID;</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :     moonPositionSet = FALSE;</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1451 </span>            : 
<span class="lineNum">    1452 </span>            : //private static void out(String s) {
<span class="lineNum">    1453 </span>            : //    System.out.println(s);
<span class="lineNum">    1454 </span>            : //}
<span class="lineNum">    1455 </span>            : 
<span class="lineNum">    1456 </span>            : //private static String deg(double rad) {
<span class="lineNum">    1457 </span>            : //    return Double.toString(rad * RAD_DEG);
<span class="lineNum">    1458 </span>            : //}
<span class="lineNum">    1459 </span>            : 
<span class="lineNum">    1460 </span>            : //private static String hours(long ms) {
<span class="lineNum">    1461 </span>            : //    return Double.toString((double)ms / HOUR_MS) + &quot; hours&quot;;
<span class="lineNum">    1462 </span>            : //}
<span class="lineNum">    1463 </span>            : 
<span class="lineNum">    1464 </span>            : /**
<span class="lineNum">    1465 </span>            :  * @internal
<span class="lineNum">    1466 </span>            :  * @deprecated ICU 2.4. This class may be removed or modified.
<span class="lineNum">    1467 </span>            :  */
<span class="lineNum">    1468 </span>            : /*UDate CalendarAstronomer::local(UDate localMillis) {
<span class="lineNum">    1469 </span>            :   // TODO - srl ?
<span class="lineNum">    1470 </span>            :   TimeZone *tz = TimeZone::createDefault();
<span class="lineNum">    1471 </span>            :   int32_t rawOffset;
<span class="lineNum">    1472 </span>            :   int32_t dstOffset;
<span class="lineNum">    1473 </span>            :   UErrorCode status = U_ZERO_ERROR;
<span class="lineNum">    1474 </span>            :   tz-&gt;getOffset(localMillis, TRUE, rawOffset, dstOffset, status);
<span class="lineNum">    1475 </span>            :   delete tz;
<span class="lineNum">    1476 </span>            :   return localMillis - rawOffset;
<span class="lineNum">    1477 </span>            : }*/
<a name="1478"><span class="lineNum">    1478 </span>            : </a>
<span class="lineNum">    1479 </span>            : // Debugging functions
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 : UnicodeString CalendarAstronomer::Ecliptic::toString() const</span>
<span class="lineNum">    1481 </span>            : {
<span class="lineNum">    1482 </span>            : #ifdef U_DEBUG_ASTRO
<span class="lineNum">    1483 </span>            :     char tmp[800];
<span class="lineNum">    1484 </span>            :     sprintf(tmp, &quot;[%.5f,%.5f]&quot;, longitude*RAD_DEG, latitude*RAD_DEG);
<span class="lineNum">    1485 </span>            :     return UnicodeString(tmp, &quot;&quot;);
<span class="lineNum">    1486 </span>            : #else
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :     return UnicodeString();</span>
<span class="lineNum">    1488 </span>            : #endif
<a name="1489"><span class="lineNum">    1489 </span>            : }</a>
<span class="lineNum">    1490 </span>            : 
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 : UnicodeString CalendarAstronomer::Equatorial::toString() const</span>
<span class="lineNum">    1492 </span>            : {
<span class="lineNum">    1493 </span>            : #ifdef U_DEBUG_ASTRO
<span class="lineNum">    1494 </span>            :     char tmp[400];
<span class="lineNum">    1495 </span>            :     sprintf(tmp, &quot;%f,%f&quot;,
<span class="lineNum">    1496 </span>            :         (ascension*RAD_DEG), (declination*RAD_DEG));
<span class="lineNum">    1497 </span>            :     return UnicodeString(tmp, &quot;&quot;);
<span class="lineNum">    1498 </span>            : #else
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :     return UnicodeString();</span>
<span class="lineNum">    1500 </span>            : #endif
<a name="1501"><span class="lineNum">    1501 </span>            : }</a>
<span class="lineNum">    1502 </span>            : 
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 : UnicodeString CalendarAstronomer::Horizon::toString() const</span>
<span class="lineNum">    1504 </span>            : {
<span class="lineNum">    1505 </span>            : #ifdef U_DEBUG_ASTRO
<span class="lineNum">    1506 </span>            :     char tmp[800];
<span class="lineNum">    1507 </span>            :     sprintf(tmp, &quot;[%.5f,%.5f]&quot;, altitude*RAD_DEG, azimuth*RAD_DEG);
<span class="lineNum">    1508 </span>            :     return UnicodeString(tmp, &quot;&quot;);
<span class="lineNum">    1509 </span>            : #else
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :     return UnicodeString();</span>
<span class="lineNum">    1511 </span>            : #endif
<span class="lineNum">    1512 </span>            : }
<span class="lineNum">    1513 </span>            : 
<span class="lineNum">    1514 </span>            : 
<span class="lineNum">    1515 </span>            : //  static private String radToHms(double angle) {
<span class="lineNum">    1516 </span>            : //    int hrs = (int) (angle*RAD_HOUR);
<span class="lineNum">    1517 </span>            : //    int min = (int)((angle*RAD_HOUR - hrs) * 60);
<span class="lineNum">    1518 </span>            : //    int sec = (int)((angle*RAD_HOUR - hrs - min/60.0) * 3600);
<span class="lineNum">    1519 </span>            : 
<span class="lineNum">    1520 </span>            : //    return Integer.toString(hrs) + &quot;h&quot; + min + &quot;m&quot; + sec + &quot;s&quot;;
<span class="lineNum">    1521 </span>            : //  }
<span class="lineNum">    1522 </span>            : 
<span class="lineNum">    1523 </span>            : //  static private String radToDms(double angle) {
<span class="lineNum">    1524 </span>            : //    int deg = (int) (angle*RAD_DEG);
<span class="lineNum">    1525 </span>            : //    int min = (int)((angle*RAD_DEG - deg) * 60);
<span class="lineNum">    1526 </span>            : //    int sec = (int)((angle*RAD_DEG - deg - min/60.0) * 3600);
<span class="lineNum">    1527 </span>            : 
<span class="lineNum">    1528 </span>            : //    return Integer.toString(deg) + &quot;\u00b0&quot; + min + &quot;'&quot; + sec + &quot;\&quot;&quot;;
<span class="lineNum">    1529 </span>            : //  }
<span class="lineNum">    1530 </span>            : 
<a name="1531"><span class="lineNum">    1531 </span>            : // =============== Calendar Cache ================</a>
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 : void CalendarCache::createCache(CalendarCache** cache, UErrorCode&amp; status) {</span>
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :     ucln_i18n_registerCleanup(UCLN_I18N_ASTRO_CALENDAR, calendar_astro_cleanup);</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :     if(cache == NULL) {</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :         status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="lineNum">    1537 </span>            :     } else {
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :         *cache = new CalendarCache(32, status);</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :         if(U_FAILURE(status)) {</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :             delete *cache;</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :             *cache = NULL;</span>
<span class="lineNum">    1542 </span>            :         }
<span class="lineNum">    1543 </span>            :     }
<a name="1544"><span class="lineNum">    1544 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1545 </span>            : 
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 : int32_t CalendarCache::get(CalendarCache** cache, int32_t key, UErrorCode &amp;status) {</span>
<span class="lineNum">    1547 </span>            :     int32_t res;
<span class="lineNum">    1548 </span>            : 
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :     if(U_FAILURE(status)) {</span>
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    1551 </span>            :     }
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :     umtx_lock(&amp;ccLock);</span>
<span class="lineNum">    1553 </span>            : 
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :     if(*cache == NULL) {</span>
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :         createCache(cache, status);</span>
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :         if(U_FAILURE(status)) {</span>
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :             umtx_unlock(&amp;ccLock);</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :             return 0;</span>
<span class="lineNum">    1559 </span>            :         }
<span class="lineNum">    1560 </span>            :     }
<span class="lineNum">    1561 </span>            : 
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :     res = uhash_igeti((*cache)-&gt;fTable, key);</span>
<span class="lineNum">    1563 </span>            :     U_DEBUG_ASTRO_MSG((&quot;%p: GET: [%d] == %d\n&quot;, (*cache)-&gt;fTable, key, res));
<span class="lineNum">    1564 </span>            : 
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :     umtx_unlock(&amp;ccLock);</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :     return res;</span>
<a name="1567"><span class="lineNum">    1567 </span>            : }</a>
<span class="lineNum">    1568 </span>            : 
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 : void CalendarCache::put(CalendarCache** cache, int32_t key, int32_t value, UErrorCode &amp;status) {</span>
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :     if(U_FAILURE(status)) {</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1572 </span>            :     }
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :     umtx_lock(&amp;ccLock);</span>
<span class="lineNum">    1574 </span>            : 
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :     if(*cache == NULL) {</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :         createCache(cache, status);</span>
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :         if(U_FAILURE(status)) {</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :             umtx_unlock(&amp;ccLock);</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1580 </span>            :         }
<span class="lineNum">    1581 </span>            :     }
<span class="lineNum">    1582 </span>            : 
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :     uhash_iputi((*cache)-&gt;fTable, key, value, &amp;status);</span>
<span class="lineNum">    1584 </span>            :     U_DEBUG_ASTRO_MSG((&quot;%p: PUT: [%d] := %d\n&quot;, (*cache)-&gt;fTable, key, value));
<span class="lineNum">    1585 </span>            : 
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :     umtx_unlock(&amp;ccLock);</span>
<a name="1587"><span class="lineNum">    1587 </span>            : }</a>
<span class="lineNum">    1588 </span>            : 
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 : CalendarCache::CalendarCache(int32_t size, UErrorCode &amp;status) {</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :     fTable = uhash_openSize(uhash_hashLong, uhash_compareLong, NULL, size, &amp;status);</span>
<span class="lineNum">    1591 </span>            :     U_DEBUG_ASTRO_MSG((&quot;%p: Opening.\n&quot;, fTable));
<a name="1592"><span class="lineNum">    1592 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1593 </span>            : 
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 : CalendarCache::~CalendarCache() {</span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :     if(fTable != NULL) {</span>
<span class="lineNum">    1596 </span>            :         U_DEBUG_ASTRO_MSG((&quot;%p: Closing.\n&quot;, fTable));
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :         uhash_close(fTable);</span>
<span class="lineNum">    1598 </span>            :     }
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1600 </span>            : 
<span class="lineNum">    1601 </span>            : U_NAMESPACE_END
<span class="lineNum">    1602 </span>            : 
<span class="lineNum">    1603 </span>            : #endif //  !UCONFIG_NO_FORMATTING
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

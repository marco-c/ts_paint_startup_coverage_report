<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - intl/icu/source/i18n/islamcal.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">intl/icu/source/i18n</a> - islamcal.cpp<span style="font-size: 80%;"> (source / <a href="islamcal.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">226</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-07-14 16:53:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">28</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // Â© 2016 and later: Unicode, Inc. and others.</a>
<span class="lineNum">       2 </span>            : // License &amp; terms of use: http://www.unicode.org/copyright.html
<span class="lineNum">       3 </span>            : /*
<span class="lineNum">       4 </span>            : ******************************************************************************
<span class="lineNum">       5 </span>            : * Copyright (C) 2003-2015, International Business Machines Corporation
<span class="lineNum">       6 </span>            : * and others. All Rights Reserved.
<span class="lineNum">       7 </span>            : ******************************************************************************
<span class="lineNum">       8 </span>            : *
<span class="lineNum">       9 </span>            : * File ISLAMCAL.H
<span class="lineNum">      10 </span>            : *
<span class="lineNum">      11 </span>            : * Modification History:
<span class="lineNum">      12 </span>            : *
<span class="lineNum">      13 </span>            : *   Date        Name        Description
<span class="lineNum">      14 </span>            : *   10/14/2003  srl         ported from java IslamicCalendar
<span class="lineNum">      15 </span>            : *****************************************************************************
<span class="lineNum">      16 </span>            : */
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &quot;islamcal.h&quot;
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #if !UCONFIG_NO_FORMATTING
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #include &quot;umutex.h&quot;
<span class="lineNum">      23 </span>            : #include &lt;float.h&gt;
<span class="lineNum">      24 </span>            : #include &quot;gregoimp.h&quot; // Math
<span class="lineNum">      25 </span>            : #include &quot;astro.h&quot; // CalendarAstronomer
<span class="lineNum">      26 </span>            : #include &quot;uhash.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;ucln_in.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;uassert.h&quot;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : static const UDate HIJRA_MILLIS = -42521587200000.0;    // 7/16/622 AD 00:00
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : // Debugging
<span class="lineNum">      33 </span>            : #ifdef U_DEBUG_ISLAMCAL
<span class="lineNum">      34 </span>            : # include &lt;stdio.h&gt;
<span class="lineNum">      35 </span>            : # include &lt;stdarg.h&gt;
<span class="lineNum">      36 </span>            : static void debug_islamcal_loc(const char *f, int32_t l)
<span class="lineNum">      37 </span>            : {
<span class="lineNum">      38 </span>            :     fprintf(stderr, &quot;%s:%d: &quot;, f, l);
<span class="lineNum">      39 </span>            : }
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : static void debug_islamcal_msg(const char *pat, ...)
<span class="lineNum">      42 </span>            : {
<span class="lineNum">      43 </span>            :     va_list ap;
<span class="lineNum">      44 </span>            :     va_start(ap, pat);
<span class="lineNum">      45 </span>            :     vfprintf(stderr, pat, ap);
<span class="lineNum">      46 </span>            :     fflush(stderr);
<span class="lineNum">      47 </span>            : }
<span class="lineNum">      48 </span>            : // must use double parens, i.e.:  U_DEBUG_ISLAMCAL_MSG((&quot;four is: %d&quot;,4));
<span class="lineNum">      49 </span>            : #define U_DEBUG_ISLAMCAL_MSG(x) {debug_islamcal_loc(__FILE__,__LINE__);debug_islamcal_msg x;}
<span class="lineNum">      50 </span>            : #else
<span class="lineNum">      51 </span>            : #define U_DEBUG_ISLAMCAL_MSG(x)
<span class="lineNum">      52 </span>            : #endif
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            : // --- The cache --
<span class="lineNum">      56 </span>            : // cache of months
<span class="lineNum">      57 </span>            : static UMutex astroLock = U_MUTEX_INITIALIZER;  // pod bay door lock
<span class="lineNum">      58 </span>            : static icu::CalendarCache *gMonthCache = NULL;
<span class="lineNum">      59 </span>            : static icu::CalendarAstronomer *gIslamicCalendarAstro = NULL;
<a name="60"><span class="lineNum">      60 </span>            : </a>
<span class="lineNum">      61 </span>            : U_CDECL_BEGIN
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : static UBool calendar_islamic_cleanup(void) {</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :     if (gMonthCache) {</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :         delete gMonthCache;</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :         gMonthCache = NULL;</span>
<span class="lineNum">      66 </span>            :     }
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :     if (gIslamicCalendarAstro) {</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :         delete gIslamicCalendarAstro;</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :         gIslamicCalendarAstro = NULL;</span>
<span class="lineNum">      70 </span>            :     }
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :     return TRUE;</span>
<span class="lineNum">      72 </span>            : }
<span class="lineNum">      73 </span>            : U_CDECL_END
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            : U_NAMESPACE_BEGIN
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : // Implementation of the IslamicCalendar class
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            : /**
<span class="lineNum">      80 </span>            :  * Friday EPOC
<span class="lineNum">      81 </span>            :  */
<span class="lineNum">      82 </span>            : static const int32_t CIVIL_EPOC = 1948440; // CE 622 July 16 Friday (Julian calendar) / CE 622 July 19 (Gregorian calendar)
<span class="lineNum">      83 </span>            : 
<span class="lineNum">      84 </span>            : /**
<span class="lineNum">      85 </span>            :   * Thursday EPOC
<span class="lineNum">      86 </span>            :   */
<span class="lineNum">      87 </span>            : static const int32_t ASTRONOMICAL_EPOC = 1948439; // CE 622 July 15 Thursday (Julian calendar)
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            : static const int32_t UMALQURA_YEAR_START = 1300;
<span class="lineNum">      91 </span>            : static const int32_t UMALQURA_YEAR_END = 1600;
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span>            : static const int UMALQURA_MONTHLENGTH[] = {
<span class="lineNum">      94 </span>            :     //* 1300 -1302 */ &quot;1010 1010 1010&quot;, &quot;1101 0101 0100&quot;, &quot;1110 1100 1001&quot;,
<span class="lineNum">      95 </span>            :                             0x0AAA,           0x0D54,           0x0EC9,
<span class="lineNum">      96 </span>            :     //* 1303 -1307 */ &quot;0110 1101 0100&quot;, &quot;0110 1110 1010&quot;, &quot;0011 0110 1100&quot;, &quot;1010 1010 1101&quot;, &quot;0101 0101 0101&quot;,
<span class="lineNum">      97 </span>            :                             0x06D4,           0x06EA,           0x036C,           0x0AAD,           0x0555,
<span class="lineNum">      98 </span>            :     //* 1308 -1312 */ &quot;0110 1010 1001&quot;, &quot;0111 1001 0010&quot;, &quot;1011 1010 1001&quot;, &quot;0101 1101 0100&quot;, &quot;1010 1101 1010&quot;,
<span class="lineNum">      99 </span>            :                             0x06A9,           0x0792,           0x0BA9,           0x05D4,           0x0ADA,
<span class="lineNum">     100 </span>            :     //* 1313 -1317 */ &quot;0101 0101 1100&quot;, &quot;1101 0010 1101&quot;, &quot;0110 1001 0101&quot;, &quot;0111 0100 1010&quot;, &quot;1011 0101 0100&quot;,
<span class="lineNum">     101 </span>            :                             0x055C,           0x0D2D,           0x0695,           0x074A,           0x0B54,
<span class="lineNum">     102 </span>            :     //* 1318 -1322 */ &quot;1011 0110 1010&quot;, &quot;0101 1010 1101&quot;, &quot;0100 1010 1110&quot;, &quot;1010 0100 1111&quot;, &quot;0101 0001 0111&quot;,
<span class="lineNum">     103 </span>            :                             0x0B6A,           0x05AD,           0x04AE,           0x0A4F,           0x0517,
<span class="lineNum">     104 </span>            :     //* 1323 -1327 */ &quot;0110 1000 1011&quot;, &quot;0110 1010 0101&quot;, &quot;1010 1101 0101&quot;, &quot;0010 1101 0110&quot;, &quot;1001 0101 1011&quot;,
<span class="lineNum">     105 </span>            :                             0x068B,           0x06A5,           0x0AD5,           0x02D6,           0x095B,
<span class="lineNum">     106 </span>            :     //* 1328 -1332 */ &quot;0100 1001 1101&quot;, &quot;1010 0100 1101&quot;, &quot;1101 0010 0110&quot;, &quot;1101 1001 0101&quot;, &quot;0101 1010 1100&quot;,
<span class="lineNum">     107 </span>            :                             0x049D,           0x0A4D,           0x0D26,           0x0D95,           0x05AC,
<span class="lineNum">     108 </span>            :     //* 1333 -1337 */ &quot;1001 1011 0110&quot;, &quot;0010 1011 1010&quot;, &quot;1010 0101 1011&quot;, &quot;0101 0010 1011&quot;, &quot;1010 1001 0101&quot;,
<span class="lineNum">     109 </span>            :                             0x09B6,           0x02BA,           0x0A5B,           0x052B,           0x0A95,
<span class="lineNum">     110 </span>            :     //* 1338 -1342 */ &quot;0110 1100 1010&quot;, &quot;1010 1110 1001&quot;, &quot;0010 1111 0100&quot;, &quot;1001 0111 0110&quot;, &quot;0010 1011 0110&quot;,
<span class="lineNum">     111 </span>            :                             0x06CA,           0x0AE9,           0x02F4,           0x0976,           0x02B6,
<span class="lineNum">     112 </span>            :     //* 1343 -1347 */ &quot;1001 0101 0110&quot;, &quot;1010 1100 1010&quot;, &quot;1011 1010 0100&quot;, &quot;1011 1101 0010&quot;, &quot;0101 1101 1001&quot;,
<span class="lineNum">     113 </span>            :                             0x0956,           0x0ACA,           0x0BA4,           0x0BD2,           0x05D9,
<span class="lineNum">     114 </span>            :     //* 1348 -1352 */ &quot;0010 1101 1100&quot;, &quot;1001 0110 1101&quot;, &quot;0101 0100 1101&quot;, &quot;1010 1010 0101&quot;, &quot;1011 0101 0010&quot;,
<span class="lineNum">     115 </span>            :                             0x02DC,           0x096D,           0x054D,           0x0AA5,           0x0B52,
<span class="lineNum">     116 </span>            :     //* 1353 -1357 */ &quot;1011 1010 0101&quot;, &quot;0101 1011 0100&quot;, &quot;1001 1011 0110&quot;, &quot;0101 0101 0111&quot;, &quot;0010 1001 0111&quot;,
<span class="lineNum">     117 </span>            :                             0x0BA5,           0x05B4,           0x09B6,           0x0557,           0x0297,
<span class="lineNum">     118 </span>            :     //* 1358 -1362 */ &quot;0101 0100 1011&quot;, &quot;0110 1010 0011&quot;, &quot;0111 0101 0010&quot;, &quot;1011 0110 0101&quot;, &quot;0101 0110 1010&quot;,
<span class="lineNum">     119 </span>            :                             0x054B,           0x06A3,           0x0752,           0x0B65,           0x056A,
<span class="lineNum">     120 </span>            :     //* 1363 -1367 */ &quot;1010 1010 1011&quot;, &quot;0101 0010 1011&quot;, &quot;1100 1001 0101&quot;, &quot;1101 0100 1010&quot;, &quot;1101 1010 0101&quot;,
<span class="lineNum">     121 </span>            :                             0x0AAB,           0x052B,           0x0C95,           0x0D4A,           0x0DA5,
<span class="lineNum">     122 </span>            :     //* 1368 -1372 */ &quot;0101 1100 1010&quot;, &quot;1010 1101 0110&quot;, &quot;1001 0101 0111&quot;, &quot;0100 1010 1011&quot;, &quot;1001 0100 1011&quot;,
<span class="lineNum">     123 </span>            :                             0x05CA,           0x0AD6,           0x0957,           0x04AB,           0x094B,
<span class="lineNum">     124 </span>            :     //* 1373 -1377 */ &quot;1010 1010 0101&quot;, &quot;1011 0101 0010&quot;, &quot;1011 0110 1010&quot;, &quot;0101 0111 0101&quot;, &quot;0010 0111 0110&quot;,
<span class="lineNum">     125 </span>            :                             0x0AA5,           0x0B52,           0x0B6A,           0x0575,           0x0276,
<span class="lineNum">     126 </span>            :     //* 1378 -1382 */ &quot;1000 1011 0111&quot;, &quot;0100 0101 1011&quot;, &quot;0101 0101 0101&quot;, &quot;0101 1010 1001&quot;, &quot;0101 1011 0100&quot;,
<span class="lineNum">     127 </span>            :                             0x08B7,           0x045B,           0x0555,           0x05A9,           0x05B4,
<span class="lineNum">     128 </span>            :     //* 1383 -1387 */ &quot;1001 1101 1010&quot;, &quot;0100 1101 1101&quot;, &quot;0010 0110 1110&quot;, &quot;1001 0011 0110&quot;, &quot;1010 1010 1010&quot;,
<span class="lineNum">     129 </span>            :                             0x09DA,           0x04DD,           0x026E,           0x0936,           0x0AAA,
<span class="lineNum">     130 </span>            :     //* 1388 -1392 */ &quot;1101 0101 0100&quot;, &quot;1101 1011 0010&quot;, &quot;0101 1101 0101&quot;, &quot;0010 1101 1010&quot;, &quot;1001 0101 1011&quot;,
<span class="lineNum">     131 </span>            :                             0x0D54,           0x0DB2,           0x05D5,           0x02DA,           0x095B,
<span class="lineNum">     132 </span>            :     //* 1393 -1397 */ &quot;0100 1010 1011&quot;, &quot;1010 0101 0101&quot;, &quot;1011 0100 1001&quot;, &quot;1011 0110 0100&quot;, &quot;1011 0111 0001&quot;,
<span class="lineNum">     133 </span>            :                             0x04AB,           0x0A55,           0x0B49,           0x0B64,           0x0B71,
<span class="lineNum">     134 </span>            :     //* 1398 -1402 */ &quot;0101 1011 0100&quot;, &quot;1010 1011 0101&quot;, &quot;1010 0101 0101&quot;, &quot;1101 0010 0101&quot;, &quot;1110 1001 0010&quot;,
<span class="lineNum">     135 </span>            :                             0x05B4,           0x0AB5,           0x0A55,           0x0D25,           0x0E92,
<span class="lineNum">     136 </span>            :     //* 1403 -1407 */ &quot;1110 1100 1001&quot;, &quot;0110 1101 0100&quot;, &quot;1010 1110 1001&quot;, &quot;1001 0110 1011&quot;, &quot;0100 1010 1011&quot;,
<span class="lineNum">     137 </span>            :                             0x0EC9,           0x06D4,           0x0AE9,           0x096B,           0x04AB,
<span class="lineNum">     138 </span>            :     //* 1408 -1412 */ &quot;1010 1001 0011&quot;, &quot;1101 0100 1001&quot;, &quot;1101 1010 0100&quot;, &quot;1101 1011 0010&quot;, &quot;1010 1011 1001&quot;,
<span class="lineNum">     139 </span>            :                             0x0A93,           0x0D49,         0x0DA4,           0x0DB2,           0x0AB9,
<span class="lineNum">     140 </span>            :     //* 1413 -1417 */ &quot;0100 1011 1010&quot;, &quot;1010 0101 1011&quot;, &quot;0101 0010 1011&quot;, &quot;1010 1001 0101&quot;, &quot;1011 0010 1010&quot;,
<span class="lineNum">     141 </span>            :                             0x04BA,           0x0A5B,           0x052B,           0x0A95,           0x0B2A,
<span class="lineNum">     142 </span>            :     //* 1418 -1422 */ &quot;1011 0101 0101&quot;, &quot;0101 0101 1100&quot;, &quot;0100 1011 1101&quot;, &quot;0010 0011 1101&quot;, &quot;1001 0001 1101&quot;,
<span class="lineNum">     143 </span>            :                             0x0B55,           0x055C,           0x04BD,           0x023D,           0x091D,
<span class="lineNum">     144 </span>            :     //* 1423 -1427 */ &quot;1010 1001 0101&quot;, &quot;1011 0100 1010&quot;, &quot;1011 0101 1010&quot;, &quot;0101 0110 1101&quot;, &quot;0010 1011 0110&quot;,
<span class="lineNum">     145 </span>            :                             0x0A95,           0x0B4A,           0x0B5A,           0x056D,           0x02B6,
<span class="lineNum">     146 </span>            :     //* 1428 -1432 */ &quot;1001 0011 1011&quot;, &quot;0100 1001 1011&quot;, &quot;0110 0101 0101&quot;, &quot;0110 1010 1001&quot;, &quot;0111 0101 0100&quot;,
<span class="lineNum">     147 </span>            :                             0x093B,           0x049B,           0x0655,           0x06A9,           0x0754,
<span class="lineNum">     148 </span>            :     //* 1433 -1437 */ &quot;1011 0110 1010&quot;, &quot;0101 0110 1100&quot;, &quot;1010 1010 1101&quot;, &quot;0101 0101 0101&quot;, &quot;1011 0010 1001&quot;,
<span class="lineNum">     149 </span>            :                             0x0B6A,           0x056C,           0x0AAD,           0x0555,           0x0B29,
<span class="lineNum">     150 </span>            :     //* 1438 -1442 */ &quot;1011 1001 0010&quot;, &quot;1011 1010 1001&quot;, &quot;0101 1101 0100&quot;, &quot;1010 1101 1010&quot;, &quot;0101 0101 1010&quot;,
<span class="lineNum">     151 </span>            :                             0x0B92,           0x0BA9,           0x05D4,           0x0ADA,           0x055A,
<span class="lineNum">     152 </span>            :     //* 1443 -1447 */ &quot;1010 1010 1011&quot;, &quot;0101 1001 0101&quot;, &quot;0111 0100 1001&quot;, &quot;0111 0110 0100&quot;, &quot;1011 1010 1010&quot;,
<span class="lineNum">     153 </span>            :                             0x0AAB,           0x0595,           0x0749,           0x0764,           0x0BAA,
<span class="lineNum">     154 </span>            :     //* 1448 -1452 */ &quot;0101 1011 0101&quot;, &quot;0010 1011 0110&quot;, &quot;1010 0101 0110&quot;, &quot;1110 0100 1101&quot;, &quot;1011 0010 0101&quot;,
<span class="lineNum">     155 </span>            :                             0x05B5,           0x02B6,           0x0A56,           0x0E4D,           0x0B25,
<span class="lineNum">     156 </span>            :     //* 1453 -1457 */ &quot;1011 0101 0010&quot;, &quot;1011 0110 1010&quot;, &quot;0101 1010 1101&quot;, &quot;0010 1010 1110&quot;, &quot;1001 0010 1111&quot;,
<span class="lineNum">     157 </span>            :                             0x0B52,           0x0B6A,           0x05AD,           0x02AE,           0x092F,
<span class="lineNum">     158 </span>            :     //* 1458 -1462 */ &quot;0100 1001 0111&quot;, &quot;0110 0100 1011&quot;, &quot;0110 1010 0101&quot;, &quot;0110 1010 1100&quot;, &quot;1010 1101 0110&quot;,
<span class="lineNum">     159 </span>            :                             0x0497,           0x064B,           0x06A5,           0x06AC,           0x0AD6,
<span class="lineNum">     160 </span>            :     //* 1463 -1467 */ &quot;0101 0101 1101&quot;, &quot;0100 1001 1101&quot;, &quot;1010 0100 1101&quot;, &quot;1101 0001 0110&quot;, &quot;1101 1001 0101&quot;,
<span class="lineNum">     161 </span>            :                             0x055D,           0x049D,           0x0A4D,           0x0D16,           0x0D95,
<span class="lineNum">     162 </span>            :     //* 1468 -1472 */ &quot;0101 1010 1010&quot;, &quot;0101 1011 0101&quot;, &quot;0010 1101 1010&quot;, &quot;1001 0101 1011&quot;, &quot;0100 1010 1101&quot;,
<span class="lineNum">     163 </span>            :                             0x05AA,           0x05B5,           0x02DA,           0x095B,           0x04AD,
<span class="lineNum">     164 </span>            :     //* 1473 -1477 */ &quot;0101 1001 0101&quot;, &quot;0110 1100 1010&quot;, &quot;0110 1110 0100&quot;, &quot;1010 1110 1010&quot;, &quot;0100 1111 0101&quot;,
<span class="lineNum">     165 </span>            :                             0x0595,           0x06CA,           0x06E4,           0x0AEA,           0x04F5,
<span class="lineNum">     166 </span>            :     //* 1478 -1482 */ &quot;0010 1011 0110&quot;, &quot;1001 0101 0110&quot;, &quot;1010 1010 1010&quot;, &quot;1011 0101 0100&quot;, &quot;1011 1101 0010&quot;,
<span class="lineNum">     167 </span>            :                             0x02B6,           0x0956,           0x0AAA,           0x0B54,           0x0BD2,
<span class="lineNum">     168 </span>            :     //* 1483 -1487 */ &quot;0101 1101 1001&quot;, &quot;0010 1110 1010&quot;, &quot;1001 0110 1101&quot;, &quot;0100 1010 1101&quot;, &quot;1010 1001 0101&quot;,
<span class="lineNum">     169 </span>            :                             0x05D9,           0x02EA,           0x096D,           0x04AD,           0x0A95,
<span class="lineNum">     170 </span>            :     //* 1488 -1492 */ &quot;1011 0100 1010&quot;, &quot;1011 1010 0101&quot;, &quot;0101 1011 0010&quot;, &quot;1001 1011 0101&quot;, &quot;0100 1101 0110&quot;,
<span class="lineNum">     171 </span>            :                             0x0B4A,           0x0BA5,           0x05B2,           0x09B5,           0x04D6,
<span class="lineNum">     172 </span>            :     //* 1493 -1497 */ &quot;1010 1001 0111&quot;, &quot;0101 0100 0111&quot;, &quot;0110 1001 0011&quot;, &quot;0111 0100 1001&quot;, &quot;1011 0101 0101&quot;,
<span class="lineNum">     173 </span>            :                             0x0A97,           0x0547,           0x0693,           0x0749,           0x0B55,
<span class="lineNum">     174 </span>            :     //* 1498 -1508 */ &quot;0101 0110 1010&quot;, &quot;1010 0110 1011&quot;, &quot;0101 0010 1011&quot;, &quot;1010 1000 1011&quot;, &quot;1101 0100 0110&quot;, &quot;1101 1010 0011&quot;, &quot;0101 1100 1010&quot;, &quot;1010 1101 0110&quot;, &quot;0100 1101 1011&quot;, &quot;0010 0110 1011&quot;, &quot;1001 0100 1011&quot;,
<span class="lineNum">     175 </span>            :                             0x056A,           0x0A6B,           0x052B,           0x0A8B,           0x0D46,           0x0DA3,           0x05CA,           0x0AD6,           0x04DB,           0x026B,           0x094B,
<span class="lineNum">     176 </span>            :     //* 1509 -1519 */ &quot;1010 1010 0101&quot;, &quot;1011 0101 0010&quot;, &quot;1011 0110 1001&quot;, &quot;0101 0111 0101&quot;, &quot;0001 0111 0110&quot;, &quot;1000 1011 0111&quot;, &quot;0010 0101 1011&quot;, &quot;0101 0010 1011&quot;, &quot;0101 0110 0101&quot;, &quot;0101 1011 0100&quot;, &quot;1001 1101 1010&quot;,
<span class="lineNum">     177 </span>            :                             0x0AA5,           0x0B52,           0x0B69,           0x0575,           0x0176,           0x08B7,           0x025B,           0x052B,           0x0565,           0x05B4,           0x09DA,
<span class="lineNum">     178 </span>            :     //* 1520 -1530 */ &quot;0100 1110 1101&quot;, &quot;0001 0110 1101&quot;, &quot;1000 1011 0110&quot;, &quot;1010 1010 0110&quot;, &quot;1101 0101 0010&quot;, &quot;1101 1010 1001&quot;, &quot;0101 1101 0100&quot;, &quot;1010 1101 1010&quot;, &quot;1001 0101 1011&quot;, &quot;0100 1010 1011&quot;, &quot;0110 0101 0011&quot;,
<span class="lineNum">     179 </span>            :                             0x04ED,           0x016D,           0x08B6,           0x0AA6,           0x0D52,           0x0DA9,           0x05D4,           0x0ADA,           0x095B,           0x04AB,           0x0653,
<span class="lineNum">     180 </span>            :     //* 1531 -1541 */ &quot;0111 0010 1001&quot;, &quot;0111 0110 0010&quot;, &quot;1011 1010 1001&quot;, &quot;0101 1011 0010&quot;, &quot;1010 1011 0101&quot;, &quot;0101 0101 0101&quot;, &quot;1011 0010 0101&quot;, &quot;1101 1001 0010&quot;, &quot;1110 1100 1001&quot;, &quot;0110 1101 0010&quot;, &quot;1010 1110 1001&quot;,
<span class="lineNum">     181 </span>            :                             0x0729,           0x0762,           0x0BA9,           0x05B2,           0x0AB5,           0x0555,           0x0B25,           0x0D92,           0x0EC9,           0x06D2,           0x0AE9,
<span class="lineNum">     182 </span>            :     //* 1542 -1552 */ &quot;0101 0110 1011&quot;, &quot;0100 1010 1011&quot;, &quot;1010 0101 0101&quot;, &quot;1101 0010 1001&quot;, &quot;1101 0101 0100&quot;, &quot;1101 1010 1010&quot;, &quot;1001 1011 0101&quot;, &quot;0100 1011 1010&quot;, &quot;1010 0011 1011&quot;, &quot;0100 1001 1011&quot;, &quot;1010 0100 1101&quot;,
<span class="lineNum">     183 </span>            :                             0x056B,           0x04AB,           0x0A55,           0x0D29,           0x0D54,           0x0DAA,           0x09B5,           0x04BA,           0x0A3B,           0x049B,           0x0A4D,
<span class="lineNum">     184 </span>            :     //* 1553 -1563 */ &quot;1010 1010 1010&quot;, &quot;1010 1101 0101&quot;, &quot;0010 1101 1010&quot;, &quot;1001 0101 1101&quot;, &quot;0100 0101 1110&quot;, &quot;1010 0010 1110&quot;, &quot;1100 1001 1010&quot;, &quot;1101 0101 0101&quot;, &quot;0110 1011 0010&quot;, &quot;0110 1011 1001&quot;, &quot;0100 1011 1010&quot;,
<span class="lineNum">     185 </span>            :                             0x0AAA,           0x0AD5,           0x02DA,           0x095D,           0x045E,           0x0A2E,           0x0C9A,           0x0D55,           0x06B2,           0x06B9,           0x04BA,
<span class="lineNum">     186 </span>            :     //* 1564 -1574 */ &quot;1010 0101 1101&quot;, &quot;0101 0010 1101&quot;, &quot;1010 1001 0101&quot;, &quot;1011 0101 0010&quot;, &quot;1011 1010 1000&quot;, &quot;1011 1011 0100&quot;, &quot;0101 1011 1001&quot;, &quot;0010 1101 1010&quot;, &quot;1001 0101 1010&quot;, &quot;1011 0100 1010&quot;, &quot;1101 1010 0100&quot;,
<span class="lineNum">     187 </span>            :                             0x0A5D,           0x052D,           0x0A95,           0x0B52,           0x0BA8,           0x0BB4,           0x05B9,           0x02DA,           0x095A,           0x0B4A,           0x0DA4,
<span class="lineNum">     188 </span>            :     //* 1575 -1585 */ &quot;1110 1101 0001&quot;, &quot;0110 1110 1000&quot;, &quot;1011 0110 1010&quot;, &quot;0101 0110 1101&quot;, &quot;0101 0011 0101&quot;, &quot;0110 1001 0101&quot;, &quot;1101 0100 1010&quot;, &quot;1101 1010 1000&quot;, &quot;1101 1101 0100&quot;, &quot;0110 1101 1010&quot;, &quot;0101 0101 1011&quot;,
<span class="lineNum">     189 </span>            :                             0x0ED1,           0x06E8,           0x0B6A,           0x056D,           0x0535,           0x0695,           0x0D4A,           0x0DA8,           0x0DD4,           0x06DA,           0x055B,
<span class="lineNum">     190 </span>            :     //* 1586 -1596 */ &quot;0010 1001 1101&quot;, &quot;0110 0010 1011&quot;, &quot;1011 0001 0101&quot;, &quot;1011 0100 1010&quot;, &quot;1011 1001 0101&quot;, &quot;0101 1010 1010&quot;, &quot;1010 1010 1110&quot;, &quot;1001 0010 1110&quot;, &quot;1100 1000 1111&quot;, &quot;0101 0010 0111&quot;, &quot;0110 1001 0101&quot;,
<span class="lineNum">     191 </span>            :                             0x029D,           0x062B,           0x0B15,           0x0B4A,           0x0B95,           0x05AA,           0x0AAE,           0x092E,           0x0C8F,           0x0527,           0x0695,
<span class="lineNum">     192 </span>            :     //* 1597 -1600 */ &quot;0110 1010 1010&quot;, &quot;1010 1101 0110&quot;, &quot;0101 0101 1101&quot;, &quot;0010 1001 1101&quot;, };
<span class="lineNum">     193 </span>            :                             0x06AA,           0x0AD6,           0x055D,           0x029D
<a name="194"><span class="lineNum">     194 </span>            : };</a>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineNoCov">          0 : int32_t getUmalqura_MonthLength(int32_t y, int32_t m) {</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     int32_t mask = (int32_t) (0x01 &lt;&lt; (11 - m));    // set mask for bit corresponding to month</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     if((UMALQURA_MONTHLENGTH[y] &amp; mask) == 0 )</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :         return 29;</span>
<span class="lineNum">     200 </span>            :     else
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :         return 30;</span>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            : }
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     206 </span>            : // Constructors...
<a name="207"><span class="lineNum">     207 </span>            : //-------------------------------------------------------------------------</a>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineNoCov">          0 : const char *IslamicCalendar::getType() const {</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     const char *sType = NULL;</span>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     switch (cType) {</span>
<span class="lineNum">     213 </span>            :     case CIVIL:
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :         sType = &quot;islamic-civil&quot;;</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     216 </span>            :     case ASTRONOMICAL:
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :         sType = &quot;islamic&quot;;</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     219 </span>            :     case TBLA:
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :         sType = &quot;islamic-tbla&quot;;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     222 </span>            :     case UMALQURA:
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :         sType = &quot;islamic-umalqura&quot;;</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     225 </span>            :     default:
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :         U_ASSERT(false); // out of range</span>
<span class="lineNum">     227 </span>            :         sType = &quot;islamic&quot;;  // &quot;islamic&quot; is used as the generic type
<span class="lineNum">     228 </span>            :         break;
<span class="lineNum">     229 </span>            :     }
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :     return sType;</span>
<a name="231"><span class="lineNum">     231 </span>            : }</a>
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineNoCov">          0 : Calendar* IslamicCalendar::clone() const {</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :     return new IslamicCalendar(*this);</span>
<a name="235"><span class="lineNum">     235 </span>            : }</a>
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span><span class="lineNoCov">          0 : IslamicCalendar::IslamicCalendar(const Locale&amp; aLocale, UErrorCode&amp; success, ECalculationType type)</span>
<span class="lineNum">     238 </span>            : :   Calendar(TimeZone::createDefault(), aLocale, success),
<span class="lineNum">     239 </span><span class="lineNoCov">          0 : cType(type)</span>
<span class="lineNum">     240 </span>            : {
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     setTimeInMillis(getNow(), success); // Call this again now that the vtable is set up properly.</span>
<a name="242"><span class="lineNum">     242 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span><span class="lineNoCov">          0 : IslamicCalendar::IslamicCalendar(const IslamicCalendar&amp; other) : Calendar(other), cType(other.cType) {</span>
<a name="245"><span class="lineNum">     245 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineNoCov">          0 : IslamicCalendar::~IslamicCalendar()</span>
<span class="lineNum">     248 </span>            : {
<a name="249"><span class="lineNum">     249 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span><span class="lineNoCov">          0 : void IslamicCalendar::setCalculationType(ECalculationType type, UErrorCode &amp;status)</span>
<span class="lineNum">     252 </span>            : {
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :     if (cType != type) {</span>
<span class="lineNum">     254 </span>            :         // The fields of the calendar will become invalid, because the calendar
<span class="lineNum">     255 </span>            :         // rules are different
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :         UDate m = getTimeInMillis(status);</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :         cType = type;</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :         clear();</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :         setTimeInMillis(m, status);</span>
<span class="lineNum">     260 </span>            :     }
<span class="lineNum">     261 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span>            : /**
<span class="lineNum">     264 </span>            : * Returns &lt;code&gt;true&lt;/code&gt; if this object is using the fixed-cycle civil
<span class="lineNum">     265 </span>            : * calendar, or &lt;code&gt;false&lt;/code&gt; if using the religious, astronomical
<span class="lineNum">     266 </span>            : * calendar.
<a name="267"><span class="lineNum">     267 </span>            : * @draft ICU 2.4</a>
<span class="lineNum">     268 </span>            : */
<span class="lineNum">     269 </span><span class="lineNoCov">          0 : UBool IslamicCalendar::isCivil() {</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     return (cType == CIVIL);</span>
<span class="lineNum">     271 </span>            : }
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     274 </span>            : // Minimum / Maximum access functions
<span class="lineNum">     275 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span>            : // Note: Current IslamicCalendar implementation does not work
<span class="lineNum">     278 </span>            : // well with negative years.
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span>            : // TODO: In some cases the current ICU Islamic calendar implementation shows
<span class="lineNum">     281 </span>            : // a month as having 31 days. Since date parsing now uses range checks based
<span class="lineNum">     282 </span>            : // on the table below, we need to change the range for last day of month to
<span class="lineNum">     283 </span>            : // include 31 as a workaround until the implementation is fixed.
<span class="lineNum">     284 </span>            : static const int32_t LIMITS[UCAL_FIELD_COUNT][4] = {
<span class="lineNum">     285 </span>            :     // Minimum  Greatest    Least  Maximum
<span class="lineNum">     286 </span>            :     //           Minimum  Maximum
<span class="lineNum">     287 </span>            :     {        0,        0,        0,        0}, // ERA
<span class="lineNum">     288 </span>            :     {        1,        1,  5000000,  5000000}, // YEAR
<span class="lineNum">     289 </span>            :     {        0,        0,       11,       11}, // MONTH
<span class="lineNum">     290 </span>            :     {        1,        1,       50,       51}, // WEEK_OF_YEAR
<span class="lineNum">     291 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // WEEK_OF_MONTH
<span class="lineNum">     292 </span>            :     {        1,        1,       29,       31}, // DAY_OF_MONTH - 31 to workaround for cal implementation bug, should be 30
<span class="lineNum">     293 </span>            :     {        1,        1,      354,      355}, // DAY_OF_YEAR
<span class="lineNum">     294 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // DAY_OF_WEEK
<span class="lineNum">     295 </span>            :     {       -1,       -1,        5,        5}, // DAY_OF_WEEK_IN_MONTH
<span class="lineNum">     296 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // AM_PM
<span class="lineNum">     297 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // HOUR
<span class="lineNum">     298 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // HOUR_OF_DAY
<span class="lineNum">     299 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // MINUTE
<span class="lineNum">     300 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // SECOND
<span class="lineNum">     301 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // MILLISECOND
<span class="lineNum">     302 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // ZONE_OFFSET
<span class="lineNum">     303 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // DST_OFFSET
<span class="lineNum">     304 </span>            :     {        1,        1,  5000000,  5000000}, // YEAR_WOY
<span class="lineNum">     305 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // DOW_LOCAL
<span class="lineNum">     306 </span>            :     {        1,        1,  5000000,  5000000}, // EXTENDED_YEAR
<span class="lineNum">     307 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // JULIAN_DAY
<span class="lineNum">     308 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // MILLISECONDS_IN_DAY
<span class="lineNum">     309 </span>            :     {/*N/A*/-1,/*N/A*/-1,/*N/A*/-1,/*N/A*/-1}, // IS_LEAP_MONTH
<span class="lineNum">     310 </span>            : };
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            : /**
<a name="313"><span class="lineNum">     313 </span>            : * @draft ICU 2.4</a>
<span class="lineNum">     314 </span>            : */
<span class="lineNum">     315 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::handleGetLimit(UCalendarDateFields field, ELimitType limitType) const {</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :     return LIMITS[field][limitType];</span>
<span class="lineNum">     317 </span>            : }
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     320 </span>            : // Assorted calculation utilities
<span class="lineNum">     321 </span>            : //
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span>            : // we could compress this down more if we need to
<span class="lineNum">     324 </span>            : static const int8_t umAlQuraYrStartEstimateFix[] = {
<span class="lineNum">     325 </span>            :      0,  0, -1,  0, -1,  0,  0,  0,  0,  0, // 1300..
<span class="lineNum">     326 </span>            :     -1,  0,  0,  0,  0,  0,  0,  0, -1,  0, // 1310..
<span class="lineNum">     327 </span>            :      1,  0,  1,  1,  0,  0,  0,  0,  1,  0, // 1320..
<span class="lineNum">     328 </span>            :      0,  0,  0,  0,  0,  0,  1,  0,  0,  0, // 1330..
<span class="lineNum">     329 </span>            :      0,  0,  1,  0,  0, -1, -1,  0,  0,  0, // 1340..
<span class="lineNum">     330 </span>            :      1,  0,  0, -1,  0,  0,  0,  1,  1,  0, // 1350..
<span class="lineNum">     331 </span>            :      0,  0,  0,  0,  0,  0,  0, -1,  0,  0, // 1360..
<span class="lineNum">     332 </span>            :      0,  1,  1,  0,  0, -1,  0,  1,  0,  1, // 1370..
<span class="lineNum">     333 </span>            :      1,  0,  0, -1,  0,  1,  0,  0,  0, -1, // 1380..
<span class="lineNum">     334 </span>            :      0,  1,  0,  1,  0,  0,  0, -1,  0,  0, // 1390..
<span class="lineNum">     335 </span>            :      0,  0, -1, -1,  0, -1,  0,  1,  0,  0, // 1400..
<span class="lineNum">     336 </span>            :      0, -1,  0,  0,  0,  1,  0,  0,  0,  0, // 1410..
<span class="lineNum">     337 </span>            :      0,  1,  0,  0, -1, -1,  0,  0,  0,  1, // 1420..
<span class="lineNum">     338 </span>            :      0,  0, -1, -1,  0, -1,  0,  0, -1, -1, // 1430..
<span class="lineNum">     339 </span>            :      0, -1,  0, -1,  0,  0, -1, -1,  0,  0, // 1440..
<span class="lineNum">     340 </span>            :      0,  0,  0,  0, -1,  0,  1,  0,  1,  1, // 1450..
<span class="lineNum">     341 </span>            :      0,  0, -1,  0,  1,  0,  0,  0,  0,  0, // 1460..
<span class="lineNum">     342 </span>            :      1,  0,  1,  0,  0,  0, -1,  0,  1,  0, // 1470..
<span class="lineNum">     343 </span>            :      0, -1, -1,  0,  0,  0,  1,  0,  0,  0, // 1480..
<span class="lineNum">     344 </span>            :      0,  0,  0,  0,  1,  0,  0,  0,  0,  0, // 1490..
<span class="lineNum">     345 </span>            :      1,  0,  0, -1,  0,  0,  0,  1,  1,  0, // 1500..
<span class="lineNum">     346 </span>            :      0, -1,  0,  1,  0,  1,  1,  0,  0,  0, // 1510..
<span class="lineNum">     347 </span>            :      0,  1,  0,  0,  0, -1,  0,  0,  0,  1, // 1520..
<span class="lineNum">     348 </span>            :      0,  0,  0, -1,  0,  0,  0,  0,  0, -1, // 1530..
<span class="lineNum">     349 </span>            :      0, -1,  0,  1,  0,  0,  0, -1,  0,  1, // 1540..
<span class="lineNum">     350 </span>            :      0,  1,  0,  0,  0,  0,  0,  1,  0,  0, // 1550..
<span class="lineNum">     351 </span>            :     -1,  0,  0,  0,  0,  1,  0,  0,  0, -1, // 1560..
<span class="lineNum">     352 </span>            :      0,  0,  0,  0, -1, -1,  0, -1,  0,  1, // 1570..
<span class="lineNum">     353 </span>            :      0,  0, -1, -1,  0,  0,  1,  1,  0,  0, // 1580..
<span class="lineNum">     354 </span>            :     -1,  0,  0,  0,  0,  1,  0,  0,  0,  0, // 1590..
<span class="lineNum">     355 </span>            :      1 // 1600
<span class="lineNum">     356 </span>            : };
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            : /**
<a name="359"><span class="lineNum">     359 </span>            : * Determine whether a year is a leap year in the Islamic civil calendar</a>
<span class="lineNum">     360 </span>            : */
<span class="lineNum">     361 </span><span class="lineNoCov">          0 : UBool IslamicCalendar::civilLeapYear(int32_t year)</span>
<span class="lineNum">     362 </span>            : {
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :     return (14 + 11 * year) % 30 &lt; 11;</span>
<span class="lineNum">     364 </span>            : }
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span>            : /**
<span class="lineNum">     367 </span>            : * Return the day # on which the given year starts.  Days are counted
<a name="368"><span class="lineNum">     368 </span>            : * from the Hijri epoch, origin 0.</a>
<span class="lineNum">     369 </span>            : */
<span class="lineNum">     370 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::yearStart(int32_t year) const{</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     if (cType == CIVIL || cType == TBLA ||</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :         (cType == UMALQURA &amp;&amp; (year &lt; UMALQURA_YEAR_START || year &gt; UMALQURA_YEAR_END))) </span>
<span class="lineNum">     373 </span>            :     {
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :         return (year-1)*354 + ClockMath::floorDivide((3+11*year),30);</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     } else if(cType==ASTRONOMICAL){</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :         return trueMonthStart(12*(year-1));</span>
<span class="lineNum">     377 </span>            :     } else {
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :         year -= UMALQURA_YEAR_START;</span>
<span class="lineNum">     379 </span>            :         // rounded least-squares fit of the dates previously calculated from UMALQURA_MONTHLENGTH iteration
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :         int32_t yrStartLinearEstimate = (int32_t)((354.36720 * (double)year) + 460322.05 + 0.5);</span>
<span class="lineNum">     381 </span>            :         // need a slight correction to some
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :         return yrStartLinearEstimate + umAlQuraYrStartEstimateFix[year];</span>
<span class="lineNum">     383 </span>            :     }
<span class="lineNum">     384 </span>            : }
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span>            : /**
<span class="lineNum">     387 </span>            : * Return the day # on which the given month starts.  Days are counted
<span class="lineNum">     388 </span>            : * from the Hijri epoch, origin 0.
<span class="lineNum">     389 </span>            : *
<span class="lineNum">     390 </span>            : * @param year  The hijri year
<a name="391"><span class="lineNum">     391 </span>            : * @param month The hijri month, 0-based (assumed to be in range 0..11)</a>
<span class="lineNum">     392 </span>            : */
<span class="lineNum">     393 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::monthStart(int32_t year, int32_t month) const {</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     if (cType == CIVIL || cType == TBLA) {</span>
<span class="lineNum">     395 </span>            :         // This does not handle months out of the range 0..11
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         return (int32_t)uprv_ceil(29.5*month)</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :             + (year-1)*354 + (int32_t)ClockMath::floorDivide((3+11*year),30);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     } else if(cType==ASTRONOMICAL){</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         return trueMonthStart(12*(year-1) + month);</span>
<span class="lineNum">     400 </span>            :     } else {
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :         int32_t ms = yearStart(year);</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :         for(int i=0; i&lt; month; i++){</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :             ms+= handleGetMonthLength(year, i);</span>
<span class="lineNum">     404 </span>            :         }
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         return ms;</span>
<span class="lineNum">     406 </span>            :     }
<span class="lineNum">     407 </span>            : }
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span>            : /**
<span class="lineNum">     410 </span>            : * Find the day number on which a particular month of the true/lunar
<span class="lineNum">     411 </span>            : * Islamic calendar starts.
<span class="lineNum">     412 </span>            : *
<span class="lineNum">     413 </span>            : * @param month The month in question, origin 0 from the Hijri epoch
<span class="lineNum">     414 </span>            : *
<a name="415"><span class="lineNum">     415 </span>            : * @return The day number on which the given month starts.</a>
<span class="lineNum">     416 </span>            : */
<span class="lineNum">     417 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::trueMonthStart(int32_t month) const</span>
<span class="lineNum">     418 </span>            : {
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     UErrorCode status = U_ZERO_ERROR;</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     int32_t start = CalendarCache::get(&amp;gMonthCache, month, status);</span>
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :     if (start==0) {</span>
<span class="lineNum">     423 </span>            :         // Make a guess at when the month started, using the average length
<span class="lineNum">     424 </span>            :         UDate origin = HIJRA_MILLIS 
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :             + uprv_floor(month * CalendarAstronomer::SYNODIC_MONTH) * kOneDay;</span>
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span>            :         // moonAge will fail due to memory allocation error
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :         double age = moonAge(origin, status);</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         if (U_FAILURE(status)) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :             goto trueMonthStartEnd;</span>
<span class="lineNum">     431 </span>            :         }
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :         if (age &gt;= 0) {</span>
<span class="lineNum">     434 </span>            :             // The month has already started
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :             do {</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :                 origin -= kOneDay;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 age = moonAge(origin, status);</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                 if (U_FAILURE(status)) {</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :                     goto trueMonthStartEnd;</span>
<span class="lineNum">     440 </span>            :                 }
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :             } while (age &gt;= 0);</span>
<span class="lineNum">     442 </span>            :         }
<span class="lineNum">     443 </span>            :         else {
<span class="lineNum">     444 </span>            :             // Preceding month has not ended yet.
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :             do {</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :                 origin += kOneDay;</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :                 age = moonAge(origin, status);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :                 if (U_FAILURE(status)) {</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :                     goto trueMonthStartEnd;</span>
<span class="lineNum">     450 </span>            :                 }
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :             } while (age &lt; 0);</span>
<span class="lineNum">     452 </span>            :         }
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :         start = (int32_t)ClockMath::floorDivide((origin - HIJRA_MILLIS), (double)kOneDay) + 1;</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :         CalendarCache::put(&amp;gMonthCache, month, start, status);</span>
<span class="lineNum">     455 </span>            :     }
<span class="lineNum">     456 </span>            : trueMonthStartEnd :
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     if(U_FAILURE(status)) {</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :         start = 0;</span>
<span class="lineNum">     459 </span>            :     }
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :     return start;</span>
<span class="lineNum">     461 </span>            : }
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span>            : /**
<span class="lineNum">     464 </span>            : * Return the &quot;age&quot; of the moon at the given time; this is the difference
<span class="lineNum">     465 </span>            : * in ecliptic latitude between the moon and the sun.  This method simply
<span class="lineNum">     466 </span>            : * calls CalendarAstronomer.moonAge, converts to degrees, 
<span class="lineNum">     467 </span>            : * and adjusts the result to be in the range [-180, 180].
<span class="lineNum">     468 </span>            : *
<span class="lineNum">     469 </span>            : * @param time  The time at which the moon's age is desired,
<a name="470"><span class="lineNum">     470 </span>            : *              in millis since 1/1/1970.</a>
<span class="lineNum">     471 </span>            : */
<span class="lineNum">     472 </span><span class="lineNoCov">          0 : double IslamicCalendar::moonAge(UDate time, UErrorCode &amp;status)</span>
<span class="lineNum">     473 </span>            : {
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     double age = 0;</span>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     umtx_lock(&amp;astroLock);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     if(gIslamicCalendarAstro == NULL) {</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         gIslamicCalendarAstro = new CalendarAstronomer();</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :         if (gIslamicCalendarAstro == NULL) {</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :             status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :             return age;</span>
<span class="lineNum">     482 </span>            :         }
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :         ucln_i18n_registerCleanup(UCLN_I18N_ISLAMIC_CALENDAR, calendar_islamic_cleanup);</span>
<span class="lineNum">     484 </span>            :     }
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     gIslamicCalendarAstro-&gt;setTime(time);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :     age = gIslamicCalendarAstro-&gt;getMoonAge();</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     umtx_unlock(&amp;astroLock);</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span>            :     // Convert to degrees and normalize...
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :     age = age * 180 / CalendarAstronomer::PI;</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :     if (age &gt; 180) {</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :         age = age - 360;</span>
<span class="lineNum">     493 </span>            :     }
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     return age;</span>
<span class="lineNum">     496 </span>            : }
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span>            : //----------------------------------------------------------------------
<span class="lineNum">     499 </span>            : // Calendar framework
<span class="lineNum">     500 </span>            : //----------------------------------------------------------------------
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            : /**
<span class="lineNum">     503 </span>            : * Return the length (in days) of the given month.
<span class="lineNum">     504 </span>            : *
<span class="lineNum">     505 </span>            : * @param year  The hijri year
<span class="lineNum">     506 </span>            : * @param year  The hijri month, 0-based
<a name="507"><span class="lineNum">     507 </span>            : * @draft ICU 2.4</a>
<span class="lineNum">     508 </span>            : */
<span class="lineNum">     509 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::handleGetMonthLength(int32_t extendedYear, int32_t month) const {</span>
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     int32_t length = 0;</span>
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :     if (cType == CIVIL || cType == TBLA ||</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :         (cType == UMALQURA &amp;&amp; (extendedYear&lt;UMALQURA_YEAR_START || extendedYear&gt;UMALQURA_YEAR_END)) ) {</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :         length = 29 + (month+1) % 2;</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :         if (month == DHU_AL_HIJJAH &amp;&amp; civilLeapYear(extendedYear)) {</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :             length++;</span>
<span class="lineNum">     518 </span>            :         }
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     } else if(cType == ASTRONOMICAL){</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :         month = 12*(extendedYear-1) + month;</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :         length =  trueMonthStart(month+1) - trueMonthStart(month) ;</span>
<span class="lineNum">     522 </span>            :     } else {
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :         length = getUmalqura_MonthLength(extendedYear - UMALQURA_YEAR_START, month);</span>
<span class="lineNum">     524 </span>            :     }
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     return length;</span>
<span class="lineNum">     526 </span>            : }
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span>            : /**
<span class="lineNum">     529 </span>            : * Return the number of days in the given Islamic year
<a name="530"><span class="lineNum">     530 </span>            : * @draft ICU 2.4</a>
<span class="lineNum">     531 </span>            : */
<span class="lineNum">     532 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::handleGetYearLength(int32_t extendedYear) const {</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :     if (cType == CIVIL || cType == TBLA ||</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :         (cType == UMALQURA &amp;&amp; (extendedYear&lt;UMALQURA_YEAR_START || extendedYear&gt;UMALQURA_YEAR_END)) ) {</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :         return 354 + (civilLeapYear(extendedYear) ? 1 : 0);</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :     } else if(cType == ASTRONOMICAL){</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :         int32_t month = 12*(extendedYear-1);</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :         return (trueMonthStart(month + 12) - trueMonthStart(month));</span>
<span class="lineNum">     539 </span>            :     } else {
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :         int len = 0;</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :         for(int i=0; i&lt;12; i++) {</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :             len += handleGetMonthLength(extendedYear, i);</span>
<span class="lineNum">     543 </span>            :         }
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         return len;</span>
<span class="lineNum">     545 </span>            :     }
<span class="lineNum">     546 </span>            : }
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     549 </span>            : // Functions for converting from field values to milliseconds....
<span class="lineNum">     550 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span>            : // Return JD of start of given month/year
<span class="lineNum">     553 </span>            : // Calendar says:
<span class="lineNum">     554 </span>            : // Get the Julian day of the day BEFORE the start of this year.
<span class="lineNum">     555 </span>            : // If useMonth is true, get the day before the start of the month.
<span class="lineNum">     556 </span>            : // Hence the -1
<span class="lineNum">     557 </span>            : /**
<a name="558"><span class="lineNum">     558 </span>            : * @draft ICU 2.4</a>
<span class="lineNum">     559 </span>            : */
<span class="lineNum">     560 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::handleComputeMonthStart(int32_t eyear, int32_t month, UBool /* useMonth */) const {</span>
<span class="lineNum">     561 </span>            :     // This may be called by Calendar::handleComputeJulianDay with months out of the range
<span class="lineNum">     562 </span>            :     // 0..11. Need to handle that here since monthStart requires months in the range 0.11.
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :     if (month &gt; 11) {</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :         eyear += (month / 12);</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :         month %= 12;</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :     } else if (month &lt; 0) {</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :         month++;</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :         eyear += (month / 12) - 1;</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :         month = (month % 12) + 11;</span>
<span class="lineNum">     570 </span>            :     }
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :     return monthStart(eyear, month) + ((cType == TBLA)? ASTRONOMICAL_EPOC: CIVIL_EPOC) - 1;</span>
<span class="lineNum">     572 </span>            : }    
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     575 </span>            : // Functions for converting from milliseconds to field values
<span class="lineNum">     576 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            : /**
<a name="579"><span class="lineNum">     579 </span>            : * @draft ICU 2.4</a>
<span class="lineNum">     580 </span>            : */
<span class="lineNum">     581 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::handleGetExtendedYear() {</span>
<span class="lineNum">     582 </span>            :     int32_t year;
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :     if (newerField(UCAL_EXTENDED_YEAR, UCAL_YEAR) == UCAL_EXTENDED_YEAR) {</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :         year = internalGet(UCAL_EXTENDED_YEAR, 1); // Default to year 1</span>
<span class="lineNum">     585 </span>            :     } else {
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :         year = internalGet(UCAL_YEAR, 1); // Default to year 1</span>
<span class="lineNum">     587 </span>            :     }
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :     return year;</span>
<span class="lineNum">     589 </span>            : }
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span>            : /**
<span class="lineNum">     592 </span>            : * Override Calendar to compute several fields specific to the Islamic
<span class="lineNum">     593 </span>            : * calendar system.  These are:
<span class="lineNum">     594 </span>            : *
<span class="lineNum">     595 </span>            : * &lt;ul&gt;&lt;li&gt;ERA
<span class="lineNum">     596 </span>            : * &lt;li&gt;YEAR
<span class="lineNum">     597 </span>            : * &lt;li&gt;MONTH
<span class="lineNum">     598 </span>            : * &lt;li&gt;DAY_OF_MONTH
<span class="lineNum">     599 </span>            : * &lt;li&gt;DAY_OF_YEAR
<span class="lineNum">     600 </span>            : * &lt;li&gt;EXTENDED_YEAR&lt;/ul&gt;
<span class="lineNum">     601 </span>            : * 
<span class="lineNum">     602 </span>            : * The DAY_OF_WEEK and DOW_LOCAL fields are already set when this
<span class="lineNum">     603 </span>            : * method is called. The getGregorianXxx() methods return Gregorian
<span class="lineNum">     604 </span>            : * calendar equivalents for the given Julian day.
<a name="605"><span class="lineNum">     605 </span>            : * @draft ICU 2.4</a>
<span class="lineNum">     606 </span>            : */
<span class="lineNum">     607 </span><span class="lineNoCov">          0 : void IslamicCalendar::handleComputeFields(int32_t julianDay, UErrorCode &amp;status) {</span>
<span class="lineNum">     608 </span>            :     int32_t year, month, dayOfMonth, dayOfYear;
<span class="lineNum">     609 </span>            :     int32_t startDate;
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     int32_t days = julianDay - CIVIL_EPOC;</span>
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     if (cType == CIVIL || cType == TBLA) {</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :         if(cType == TBLA) {</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :             days = julianDay - ASTRONOMICAL_EPOC;</span>
<span class="lineNum">     615 </span>            :         }
<span class="lineNum">     616 </span>            :         // Use the civil calendar approximation, which is just arithmetic
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :         year  = (int)ClockMath::floorDivide( (double)(30 * days + 10646) , 10631.0 );</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :         month = (int32_t)uprv_ceil((days - 29 - yearStart(year)) / 29.5 );</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :         month = month&lt;11?month:11;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         startDate = monthStart(year, month);</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :     } else if(cType == ASTRONOMICAL){</span>
<span class="lineNum">     622 </span>            :         // Guess at the number of elapsed full months since the epoch
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :         int32_t months = (int32_t)uprv_floor((double)days / CalendarAstronomer::SYNODIC_MONTH);</span>
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :         startDate = (int32_t)uprv_floor(months * CalendarAstronomer::SYNODIC_MONTH);</span>
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :         double age = moonAge(internalGetTime(), status);</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :         if (U_FAILURE(status)) {</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :             status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">     631 </span>            :         }
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :         if ( days - startDate &gt;= 25 &amp;&amp; age &gt; 0) {</span>
<span class="lineNum">     633 </span>            :             // If we're near the end of the month, assume next month and search backwards
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :             months++;</span>
<span class="lineNum">     635 </span>            :         }
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span>            :         // Find out the last time that the new moon was actually visible at this longitude
<span class="lineNum">     638 </span>            :         // This returns midnight the night that the moon was visible at sunset.
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :         while ((startDate = trueMonthStart(months)) &gt; days) {</span>
<span class="lineNum">     640 </span>            :             // If it was after the date in question, back up a month and try again
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :             months--;</span>
<span class="lineNum">     642 </span>            :         }
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :         year = months / 12 + 1;</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         month = months % 12;</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :     } else if(cType == UMALQURA) {</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :         int32_t umalquraStartdays = yearStart(UMALQURA_YEAR_START) ;</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :         if( days &lt; umalquraStartdays){</span>
<span class="lineNum">     649 </span>            :                 //Use Civil calculation
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :                 year  = (int)ClockMath::floorDivide( (double)(30 * days + 10646) , 10631.0 );</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :                 month = (int32_t)uprv_ceil((days - 29 - yearStart(year)) / 29.5 );</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :                 month = month&lt;11?month:11;</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :                 startDate = monthStart(year, month);</span>
<span class="lineNum">     654 </span>            :             }else{
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :                 int y =UMALQURA_YEAR_START-1, m =0;</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :                 long d = 1;</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :                 while(d &gt; 0){ </span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :                     y++; </span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :                     d = days - yearStart(y) +1;</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :                     if(d == handleGetYearLength(y)){</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :                         m=11;</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :                     }else if(d &lt; handleGetYearLength(y) ){</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :                         int monthLen = handleGetMonthLength(y, m); </span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :                         m=0;</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :                         while(d &gt; monthLen){</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :                             d -= monthLen;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :                             m++;</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :                             monthLen = handleGetMonthLength(y, m);</span>
<span class="lineNum">     670 </span>            :                         }
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     672 </span>            :                     }
<span class="lineNum">     673 </span>            :                 }
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                 year = y;</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :                 month = m;</span>
<span class="lineNum">     676 </span>            :             }
<span class="lineNum">     677 </span>            :     } else { // invalid 'civil'
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :       U_ASSERT(false); // should not get here, out of range</span>
<span class="lineNum">     679 </span>            :       year=month=0;
<span class="lineNum">     680 </span>            :     }
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :     dayOfMonth = (days - monthStart(year, month)) + 1;</span>
<span class="lineNum">     683 </span>            : 
<span class="lineNum">     684 </span>            :     // Now figure out the day of the year.
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :     dayOfYear = (days - monthStart(year, 0)) + 1;</span>
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :     internalSet(UCAL_ERA, 0);</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :     internalSet(UCAL_YEAR, year);</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :     internalSet(UCAL_EXTENDED_YEAR, year);</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :     internalSet(UCAL_MONTH, month);</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :     internalSet(UCAL_DAY_OF_MONTH, dayOfMonth);</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :     internalSet(UCAL_DAY_OF_YEAR, dayOfYear);       </span>
<span class="lineNum">     694 </span>            : }    
<a name="695"><span class="lineNum">     695 </span>            : </a>
<span class="lineNum">     696 </span>            : UBool
<span class="lineNum">     697 </span><span class="lineNoCov">          0 : IslamicCalendar::inDaylightTime(UErrorCode&amp; status) const</span>
<span class="lineNum">     698 </span>            : {
<span class="lineNum">     699 </span>            :     // copied from GregorianCalendar
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :     if (U_FAILURE(status) || !getTimeZone().useDaylightTime()) </span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span>            :     // Force an update of the state of the Calendar.
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     ((IslamicCalendar*)this)-&gt;complete(status); // cast away const</span>
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :     return (UBool)(U_SUCCESS(status) ? (internalGet(UCAL_DST_OFFSET) != 0) : FALSE);</span>
<span class="lineNum">     707 </span>            : }
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span>            : /**
<span class="lineNum">     710 </span>            :  * The system maintains a static default century start date and Year.  They are
<span class="lineNum">     711 </span>            :  * initialized the first time they are used.  Once the system default century date 
<span class="lineNum">     712 </span>            :  * and year are set, they do not change.
<span class="lineNum">     713 </span>            :  */
<span class="lineNum">     714 </span>            : static UDate           gSystemDefaultCenturyStart       = DBL_MIN;
<span class="lineNum">     715 </span>            : static int32_t         gSystemDefaultCenturyStartYear   = -1;
<span class="lineNum">     716 </span>            : static icu::UInitOnce  gSystemDefaultCenturyInit        = U_INITONCE_INITIALIZER;
<a name="717"><span class="lineNum">     717 </span>            : </a>
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span><span class="lineNoCov">          0 : UBool IslamicCalendar::haveDefaultCentury() const</span>
<span class="lineNum">     720 </span>            : {
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :     return TRUE;</span>
<a name="722"><span class="lineNum">     722 </span>            : }</a>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineNoCov">          0 : UDate IslamicCalendar::defaultCenturyStart() const</span>
<span class="lineNum">     725 </span>            : {
<span class="lineNum">     726 </span>            :     // lazy-evaluate systemDefaultCenturyStart
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :     umtx_initOnce(gSystemDefaultCenturyInit, &amp;initializeSystemDefaultCentury);</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :     return gSystemDefaultCenturyStart;</span>
<a name="729"><span class="lineNum">     729 </span>            : }</a>
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span><span class="lineNoCov">          0 : int32_t IslamicCalendar::defaultCenturyStartYear() const</span>
<span class="lineNum">     732 </span>            : {
<span class="lineNum">     733 </span>            :     // lazy-evaluate systemDefaultCenturyStartYear
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :     umtx_initOnce(gSystemDefaultCenturyInit, &amp;initializeSystemDefaultCentury);</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :     return gSystemDefaultCenturyStartYear;</span>
<span class="lineNum">     736 </span>            : }
<span class="lineNum">     737 </span>            : 
<a name="738"><span class="lineNum">     738 </span>            : </a>
<span class="lineNum">     739 </span>            : U_CFUNC void U_CALLCONV
<span class="lineNum">     740 </span><span class="lineNoCov">          0 : IslamicCalendar::initializeSystemDefaultCentury()</span>
<span class="lineNum">     741 </span>            : {
<span class="lineNum">     742 </span>            :     // initialize systemDefaultCentury and systemDefaultCenturyYear based
<span class="lineNum">     743 </span>            :     // on the current time.  They'll be set to 80 years before
<span class="lineNum">     744 </span>            :     // the current time.
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :     UErrorCode status = U_ZERO_ERROR;</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     IslamicCalendar calendar(Locale(&quot;@calendar=islamic-civil&quot;),status);</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :     if (U_SUCCESS(status)) {</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :         calendar.setTime(Calendar::getNow(), status);</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :         calendar.add(UCAL_YEAR, -80, status);</span>
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :         gSystemDefaultCenturyStart = calendar.getTime(status);</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :         gSystemDefaultCenturyStartYear = calendar.get(UCAL_YEAR, status);</span>
<span class="lineNum">     753 </span>            :     }
<span class="lineNum">     754 </span>            :     // We have no recourse upon failure unless we want to propagate the failure
<span class="lineNum">     755 </span>            :     // out.
<span class="lineNum">     756 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     757 </span>            : 
<a name="758"><span class="lineNum">     758 </span>            : </a>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span><span class="lineNoCov">          0 : UOBJECT_DEFINE_RTTI_IMPLEMENTATION(IslamicCalendar)</span>
<span class="lineNum">     761 </span>            : 
<span class="lineNum">     762 </span>            : U_NAMESPACE_END
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span>            : #endif
<span class="lineNum">     765 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
